"use strict";var t;window.process&&(/.asar$/.test(__dirname)&&(__dirname+=".unpacked"),t=require("path").resolve(__dirname,"config.json"),window.config=require("fs").promises.readFile(t,"utf8").then(e=>JSON.parse(e)).catch(e=>R.get({local:"default.json",type:"json"}).then(a=>(a.theme="dark",a.language="",a.project="",a.recent=[],a.scriptEditor={mode:"by-file-extension",path:""},require("electron").ipcRenderer.invoke("get-documents-path").catch(e=>"C:").then(e=>{var t=e+"/Games";for(const i of Object.keys(a.dialogs))a.dialogs[i]=E.slash(t);return a}))))),Object.empty={},Object.clone=function(){const r=Array["isArray"],o=t=>{let i;if(r(t)){var a=t.length;i=new Array(a);for(let e=0;e<a;e++){var n=t[e];i[e]=n instanceof Object?o(n):n}}else{i=new Object;for(const s in t){var e=t[s];i[s]=e instanceof Object?o(e):e}}return i};return function(e){return o(e)}}(),Array.empty=[],Array.subtract=function(t,i){var a=[],n=t.length;for(let e=0;e<n;e++)-1===i.indexOf(t[e])&&a.push(t[e]);return a},Object.defineProperty(Array.prototype,"append",{enumerable:!1,value:function(e){return-1===this.indexOf(e)&&(this.push(e),!0)}}),Object.defineProperty(Array.prototype,"remove",{enumerable:!1,value:function(e){e=this.indexOf(e);return-1!==e&&(this.splice(e,1),!0)}}),String.compress=function(){const t=/\s+/g;return e=>e.replace(t,"")}(),Number.computeIndexDigits=function(e){return Math.floor(Math.log10(Math.max(e-1,1)))+1},Number.padZero=function(e,t,i="0"){t=Number.computeIndexDigits(t);return e.toString().padStart(t,i)},Function.empty=()=>{},RegExp.number=/^-?\d+(?:\.\d+)?$/,CSS.encodeURL=function(){const t=/([()])/g;return function(e){return`url(${encodeURI(e).replace(t,"\\$1")})`}}(),CSS.rasterize=function(e){var t=window.devicePixelRatio;return Math.round(e*t)/t},CSS.getDevicePixelContentBoxSize=function(e){var e=e.getBoundingClientRect(),t=window.devicePixelRatio,i=Math.round(e.left*t+1e-5),a=Math.round(e.right*t+1e-5),n=Math.round(e.top*t+1e-5);return{width:a-i,height:Math.round(e.bottom*t+1e-5)-n}},CanvasRenderingContext2D.prototype.drawAndFitImage=function(e,t=0,i=0,a=e.width,n=e.height){var s=this.canvas.width,r=this.canvas.height;let o,l;l=a<=s&&n<=r?(o=a,n):(c=s/a)<(h=r/n)?(o=s,Math.round(n*c)):(o=Math.round(a*h),r);var c=s-o>>1,h=r-l>>1;this.drawImage(e,t,i,a,n,c,h,o,l)};{let t=null;const ci=function(e){e.cmdOrCtrlKey||e.altKey||e.shiftKey||e.doubleclickProcessed||(e.doubleclickProcessed=!0,t=0===e.button?null!==t&&e.target===t.target&&e.timeStamp-t.timeStamp<500&&Math.abs(e.clientX-t.clientX)<4&&Math.abs(e.clientY-t.clientY)<4&&this.isInContent(e)?(e.target.dispatchEvent(new PointerEvent("doubleclick",e))||e.preventDefault(),null):e:null)};EventTarget.prototype.on=function(e,t,i){"doubleclick"===e?(this.addEventListener("pointerdown",ci),this.addEventListener("doubleclick",t,i)):this.addEventListener(e,t,i)},EventTarget.prototype.off=function(e,t,i){"doubleclick"===e?(this.removeEventListener("pointerdown",ci,i),this.removeEventListener("doubleclick",t,i)):this.removeEventListener(e,t,i)}}Object.defineProperties(Event.prototype,{dragKey:{get:function(){return this.spaceKey||this.altKey}},cmdOrCtrlKey:{get:"macOS"===navigator.userAgentData.platform?function(){return this.metaKey}:function(){return this.ctrlKey}}});const p="macOS"===navigator.userAgentData.platform?function(e){return"⌘+"+e}:function(e){return"Ctrl+"+e};MouseEvent.prototype.getRelativeCoords=function(){const i={x:0,y:0};return function(e){var t=e.getBoundingClientRect();return i.x=this.clientX-t.left-e.clientLeft+e.scrollLeft,i.y=this.clientY-t.top-e.clientTop+e.scrollTop,i}}(),PointerEvent.prototype.relate=function(e){return this.pointerId===e.pointerId},DataTransfer.prototype.hideDragImage=function(){const e=document.createElement("no-drag-image");return function(){this.setDragImage(e,0,0)}}(),NodeList.prototype.on=function(e,t,i){for(const a of this)a.on(e,t,i);return this},NodeList.prototype.enable=function(){for(const e of this)e.enable()},NodeList.prototype.disable=function(){for(const e of this)e.disable()};class a{hex;red;green;blue;alpha;onchange;constructor(e,t){this.input(e),this.onchange=t}read(){return this.hex}input(e){this.hex!==e&&(this.hex=e,this.red=parseInt(e.slice(0,2),16)/255,this.green=parseInt(e.slice(2,4),16)/255,this.blue=parseInt(e.slice(4,6),16)/255,this.alpha=parseInt(e.slice(6,8),16)/255,this.onchange?.())}getINTRGBA(){return o(this.hex)}getGLRGBA(){var e=this.alpha,t=1-e,i=a.rgba;return i[0]=We.BACKGROUND_RED*t+this.red*e,i[1]=We.BACKGROUND_GREEN*t+this.green*e,i[2]=We.BACKGROUND_BLUE*t+this.blue*e,i}static rgba=new Float64Array(4)}class f{playbackRate;elapsed;duration;update;callback;constructor({duration:e,update:t,callback:i}){this.playbackRate=1,this.elapsed=0,this.duration=e,this.update=t??Function.empty,this.callback=i??Function.empty}tick(e){this.elapsed=Math.max(0,Math.min(this.duration,this.elapsed+e*this.playbackRate)),!1===this.update(this)?this.remove():this.elapsed===(0<this.playbackRate?this.duration:0)&&this.finish()}finish(){!0!==this.callback(this)&&this.remove()}add(){return f.timers.append(this)&&f.play(),this}remove(){return f.timers.remove(this),this}}f.timers=[],f.updaters={stageAnimation:null,stageRendering:null,sharedAnimation:null,sharedRendering:null,sharedRendering2:null},f.timestamp=0,f.deltaTime=0,f.frameCount=0,f.frameTime=0,f.tpf=1/0,f.animationIndex=-1,f.animationWaiting=0,f.initialize=null,f.start=null,f.update=null,f.play=null,f.appendUpdater=null,f.removeUpdater=null,f.initialize=function(){this.timestamp=0,this.deltaTime=0,this.frameCount=0,this.frameTime=0,this.tpf=1/0;var e=_("#event, #selector, #imageClip");e.on("open",e=>{e.target.hasClass("maximized")&&this.animationWaiting++}),e.on("closed",e=>{e.target.hasClass("maximized")&&this.animationWaiting--}),e.on("maximize",e=>{this.animationWaiting++}),e.on("unmaximize",e=>{this.animationWaiting--})},f.start=function(e){f.timestamp=e-f.deltaTime,f.update(e)},f.update=function(e){var t=e-f.timestamp,i=(f.frameCount++,f.frameTime+=t,995<f.frameTime&&(f.tpf=f.frameTime/f.frameCount,f.frameCount=0,f.frameTime=0),t=Math.min(t,f.tpf+1,35),f.timestamp=e,f.deltaTime=t,f)["timers"];let a=i.length;for(;0<=--a;)i[a].tick(t);var e=f.updaters,n=e["stageAnimation"],s=(null!==n&&0===f.animationWaiting&&document.hasFocus()&&n(t),e)["stageRendering"],s=(null!==s&&(s(t),e.stageRendering=null),e)["sharedAnimation"],r=(null!==s&&0===f.animationWaiting&&document.hasFocus()&&s(t),e)["sharedRendering"],r=(null!==r&&(r(t),e.sharedRendering=null),e)["sharedRendering2"];null!==r&&(r(t),e.sharedRendering2=null),0<f.timers.length||null!==n||null!==s?f.animationIndex=requestAnimationFrame(f.update):f.animationIndex=-1},f.play=function(){-1===this.animationIndex&&(this.animationIndex=requestAnimationFrame(this.start))},f.appendUpdater=function(e,t){var i=this.updaters;null===i[e]&&(i[e]=t,this.play())},f.removeUpdater=function(e,t){var i=this.updaters;i[e]===t&&(i[e]=null)},Math.clamp=function(){const{max:a,min:n}=Math;return(e,t,i)=>a(n(e,i),t)}(),Math.roundTo=function(){const i=Math["round"];return(e,t)=>{t=10**t;return i(e*t)/t}}(),Math.dist=function(){const n=Math["sqrt"];return(e,t,i,a)=>n((e-i)**2+(t-a)**2)}(),Math.randomBetween=function(){const i=Math["random"];return(e,t)=>e+(t-e)*i()}(),Math.radians=function(){const t=Math.PI/180;return e=>e*t}(),Math.degrees=function(){const t=180/Math.PI;return e=>e*t}(),Math.modDegrees=(e,t=360)=>0<=e?e%t:(e%t+t)%t,Math.modRadians=function(){const i=2*Math.PI;return(e,t=i)=>0<=e?e%t:(e%t+t)%t}();const L=function(){const i={width:0,lines:0},a=document.createElement("text");let n=!1,s="",r=0;return a.style.whiteSpace="pre",function(e,t=""){return!1===n&&(n=!0,document.body.appendChild(a),a.textContent="a",r=a.offsetHeight,Promise.resolve().then(()=>{n=!1,a.textContent="",a.remove()})),s!==t&&(s=t,a.style.fontFamily=t??""),a.textContent=e,i.width=a.offsetWidth,i.lines=a.offsetHeight/r,i}}();{let t=!1,i=!1;const hi=function(e){t&&(t=!1,window.off("pointerup",hi))};const di=function(e){i&&!e.relatedTarget&&(i=!1,window.dispatchEvent(new DragEvent("os-dragend")),window.off("dragleave",di),window.off("dragover",ui),window.off("drop",pi))},ui=function(e){e.preventDefault()},pi=function(e){i&&(i=!1,window.dispatchEvent(new DragEvent("os-dragend")),window.off("dragleave",di),window.off("dragover",ui),window.off("drop",pi))};window.on("dragstart",function(e){t=!0,e.preventDefault(),window.on("pointerup",hi)}),window.on("dragend",function(e){t&&(t=!1,window.off("pointerup",hi))}),window.on("dragenter",function(e){t||i||e.relatedTarget||(i=!0,window.dispatchEvent(new DragEvent("os-dragstart")),window.on("dragleave",di),window.on("dragover",ui),window.on("drop",pi))})}function g(t){return function(e){return _(`#${t}-`+e).read()}}function D(n,s){return function(e,t){if(void 0===t){var i="string"==typeof e?e.split("-"):[e];t=s;for(const a of i)t=t[a]}_(`#${n}-`+e).write(t)}}const _=function(){const t=/^#(\w|-)+$/;return function(e){return t.test(e)?document.querySelector(e):document.querySelectorAll(e)}}(),o=function(e){return parseInt(e.slice(0,2),16)+256*(parseInt(e.slice(2,4),16)+256*(parseInt(e.slice(4,6),16)+256*parseInt(e.slice(6,8),16)))},R=(Clipboard.has=function(e){var t=require("electron")["clipboard"];return 0!==t.readBuffer(e).length},Clipboard.read=function(e){var t=require("electron")["clipboard"],t=t.readBuffer(e).toString();return t?JSON.parse(t):null},Clipboard.write=function(e,t){var i=require("electron")["clipboard"],t=JSON.stringify(t),t=Buffer.from(t);i.writeBuffer(e,t)},window.on("keydown",function(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyZ":case"KeyY":e.preventDefault();break;case"KeyA":document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||e.preventDefault()}"Space"===e.code&&(Event.prototype.spaceKey=!0)},{capture:!0}),window.on("keyup",function(e){"Space"===e.code&&(Event.prototype.spaceKey=!1)},{capture:!0}),window.on("resize",function(){let t=window.devicePixelRatio;return e=>{t!==window.devicePixelRatio&&(t=window.devicePixelRatio,window.dispatchEvent(new Event("dprchange")))}}()),{root:"",promises:{},get:null,getPath:null,save:null,saveFile:null,planToSave:null,cancelSave:null,parseFileSize:null,getFileName:null,getImageResolution:null,openPath:null,openURL:null,showInExplorer:null,showOpenDialog:null,showSaveDialog:null,parseFileName:null,filterGUID:null,updateRoot:null,route:null}),F=(R.get=function(i){let a;i.path?a=R.route(i.path):i.guid?a=R.route(this.getPath(i.guid)):i.local?a=i.local:oi.throw(new Error("Invalid parameter"));const n=i.type;if("image"!==n)return new Promise((e,t)=>{const i=new XMLHttpRequest;i.onload=()=>{e(i.response)},i.onerror=()=>{t(new URIError(a))},i.open("GET",a),i.responseType=n,i.send()});{var e;i.guid&&(e=He.manifest.guidMap[i.guid])&&(a+="?ver="+e.mtimeMs);const s=this.promises;return s[a]||(s[a]=new Promise(e=>{const t=new Image;t.guid=i.guid??"",t.onload=()=>{delete s[a],t.onload=null,t.onerror=null,e(t)},t.onerror=()=>{delete s[a],t.onload=null,t.onerror=null,t.src="",e(t)},t.src=a}))}},R.getPath=function(e){return He.manifest.guidMap[e]?.path??""},R.save=function(e=!0){He.saveManifest();var{guidMap:t,changes:i}=He.manifest;for(const a of i)t[a.guid]===a&&R.saveFile(a);return 0!==i.length&&(i.length=0),e&&(pt.open("cursor-wait"),setTimeout(()=>{pt.close("cursor-wait")},100)),Promise.all(P.promises)},R.saveFile=function(e){switch(e){case A.meta:A.save();break;case Y.meta:Y.save();break;case Ke.meta:Ke.save();break;case S.meta:S.save()}let t;var i=e.dataMap?.[e.guid];switch(typeof i){case"object":t=JSON.stringify(i,null,2);break;case"string":t=i;break;default:return Promise.resolve()}const a=e.path,n=R.route(a);return P.protectPromise(z.stat(n).then(e=>z.writeFile(n,t)).then(()=>{console.log("写入文件:"+a)}).catch(e=>{console.warn(e)}))},R.planToSave=function(e){if(e instanceof Object)return He.manifest.changes.append(e);throw new Error("Invalid file meta")},R.cancelSave=function(e){return He.manifest.changes.remove(e)},R.parseFileSize=function(e){let t,i;switch(i=e<1e3?1===e?"byte":"bytes":(e/=1024)<1e3?"KB":(e/=1024)<1e3?"MB":(e/=1024,"GB")){case"byte":case"bytes":t=e.toString();break;default:t=e<10?e.toFixed(2):e<100?e.toFixed(1):e.toFixed(0)}return""+t+i},R.getFileName=function(){const e={path:"",route:""};return function(t,i,a=""){let n=t+"/"+i+a,s=R.route(n);if(F.existsSync(s))for(let e=1;;e++){1;if(n=t+`/${i} `+e+a,s=R.route(n),!F.existsSync(s))break}return e.path=n,e.route=s,e}}(),R.getImageResolution=function(){const s={},r={width:0,height:0};return function(n){let e=s[n];return e=void 0===e?s[n]=new Promise((e,t)=>{const i=new Image,a=(i.src=R.route(n),setInterval(()=>{0!==i.naturalWidth?(r.width=i.naturalWidth,r.height=i.naturalHeight,delete s[n],clearInterval(a),e(r),i.src=""):i.complete&&(delete s[n],clearInterval(a),t(new URIError("Image load failed.")))}))}):e}}(),R.openPath=function(e){require("electron").ipcRenderer.send("open-path",e)},R.openURL=function(e){require("electron").shell.openExternal(e)},R.showInExplorer=function(e){require("electron").ipcRenderer.send("show-item-in-folder",e)},R.showOpenDialog=function(e){var t=require("electron")["ipcRenderer"];return t.invoke("show-open-dialog",e)},R.showSaveDialog=function(e){var t=require("electron")["ipcRenderer"];return t.invoke("show-save-dialog",e)},R.parseMetaName=function(e){var e=R.filterGUID(e.path),t=E.extname(e);return E.basename(e,t)},R.filterGUID=function(){const t=/\.[0-9a-f]{16}(?=\.\S+$)/;return function(e){return e.replace(t,"")}}(),R.updateRoot=function(e){var t=e.lastIndexOf("/");this.root=e.slice(0,t+1)},R.route=function(e){return this.root+e},require("fs")),z=F.promises,E=require("path"),h=(E.slash=function(){const t=/\\/g;return function(e){return e=-1!==e.indexOf("\\")?e.replace(t,"/"):e}}(),{inoMap:{},assets:null,symbol:null,updating:null,initialize:null,read:null,close:null,update:null,getFolder:null,getFile:null,readdir:null,searchFiles:null,existFiles:null,filterFiles:null,deleteFiles:null,moveFiles:null,saveFiles:null,copyFiles:null,sortFiles:null,createInoMap:null,windowFocus:null});h.initialize=function(){window.on("focus",this.windowFocus)},h.read=function(){const t=this.symbol=Symbol();return B.create("Assets").then(e=>{if(this.symbol===t)return this.symbol=null,this.assets=e,at.versionId++,e.update().then(async({promises:e})=>{this.createInoMap(),e.length&&await Promise.all(e)},e=>{oi.throw(e),O.confirm({message:"Failed to read directory",close:()=>{P.close(!1)}},[{label:"Confirm"}])})})},h.close=function(){this.inoMap={},this.assets=null,this.symbol=null},h.update=function(){const i=this["assets"];return null!==i&&null===this.updating&&(at.versionId++,this.updating=i.update().then(async({changed:e,promises:t})=>{if(this.assets!==i)throw new Error("Directory update timeout");return e&&(this.createInoMap(),He.manifest.update()),t.length&&await Promise.all(t),e&&window.dispatchEvent(new Event("dirchange")),e},e=>{throw e}).finally(()=>{this.updating=null})),this.updating},h.getFolder=function(t){var i=t.split("/"),a=i.length;let n=this.assets;e:for(let e=1;e<a;e++){if(n instanceof B){const t=n.path+"/"+i[e];for(const s of n.subfolders)if(s.path===t){n=s;continue e}}break}return n},h.getFile=function(e){var t=E.dirname(e),i=this.getFolder(t);if(i.path===t)for(const a of i.children)if(a.path===e&&a instanceof q)return a},h.readdir=function(){const e={withFileTypes:!0},h=(r,o)=>z.readdir(r,e).then(async e=>{var t=[];for(const s of e){var i,a=s.name,n=r+"/"+a;s.isDirectory()?(o.push({name:a,path:n,children:i=[]}),t.push(h(n,i))):o.push({name:a,path:n})}return 0!==t.length&&await Promise.all(t),o});return async function(t){var i=[],a=[],n=[],s=t.length;for(let e=0;e<s;e++)a.push(z.stat(t[e]));for(let e=0;e<s;e++)try{var r,o=await a[e],l=t[e],c=E.basename(l);o.isDirectory()?(i.push({name:c,path:l,children:r=[]}),n.push(h(l,r))):i.push({name:c,path:l})}catch(e){console.log(e)}return await Promise.all(n),i}}(),h.searchFiles=function(){const o=(t,i,a,n)=>{var s=a.length;for(let e=0;e<s;e++){var r=a[e];null!==t&&r instanceof q&&!t.includes(r.type)||(i.test(r.alias??r.name)&&n.push(r),r instanceof B&&o(t,i,r.children,n))}};return function(e,t,i,a){return o(e,t,i,a)}}(),h.existFiles=function(){const s=async(e,t)=>{var i=[];for(const n of t){var a=e+"/"+n.name;i.push(z.stat(a)),n.children?.length&&i.push(s(a,n.children))}if(0!==i.length)return Promise.any(i)};return function(e,t){return s(R.route(e),t).then(e=>!0,e=>!1)}}(),h.filterFiles=function(){const r=(e,t)=>e instanceof q?t instanceof q?-e.path.localeCompare(t.path):-1:t instanceof q?1:-e.path.localeCompare(t.path);return function(e){e.sort(r);var t=[];let i=e.length;for(;0<=--i;){var a=e[i],n=a.path;for(const s of t)0===n.indexOf(s)&&"/"===n[s.length]&&e.splice(i,1);a instanceof B&&t.push(n)}return e.reverse()}}(),h.deleteFiles=function(){const n=require("electron").ipcRenderer["invoke"];return function(e){return(async e=>{var t=[];for(const a of e){var i=R.route(a.path);t.push(n("trash-item",i))}if(0!==t.length)return Promise.all(t)})(h.filterFiles(e))}}(),h.moveFiles=function(e,t){return(async(e,t,i)=>{var a=[];for(const s of t){var n=e+"/"+s.name;i[n]||(i[n]=!0,a.push(z.rename(s.path,n)))}if(0!==a.length)return Promise.all(a)})(e,h.filterFiles(t),{})},h.saveFiles=function(){const r=async(e,t,i)=>{var a,n=[];for(const s of e)s instanceof B?n.push(r(s.children,t)):q.isDataFile(s)&&(a=s.meta,t.includes(a))&&(n.push(R.saveFile(a)),i.push(a));if(0!==n.length)return Promise.all(n)};return function(e){const i=[],a=He.manifest.changes;return r(e,a,i).then(e=>{for(const t of i)a.remove(t);return e})}}(),h.copyFiles=function(){const h=async(i,e,a,n)=>{var s=[];for(const o of e){var r=R.filterGUID(o.name);const l=E.extname(r),c=E.basename(r,l);let t=i+"/"+c+a+l;r=n[t];n[t]=!0,s.push((r?Promise.resolve():z.stat(t)).then(e=>{for(let e=2;t=`${i}/${c}${a} (${e})`+l,n[t]||(n[t]=!0,F.existsSync(t));e++);},Function.empty).finally(()=>{var e=o["children"];return e?(F.mkdirSync(t),0!==e.length?h(t,e,a,n):void 0):z.copyFile(o.path,t)}))}if(0!==s.length)return Promise.all(s)};return function(e,t,i=" - Copy"){return h(e,t,i,{})}}(),h.sortFiles=function(){const t=(e,t)=>{var i,a;return e instanceof q?t instanceof q?0!==(i=e.basename.localeCompare(t.basename))?i:0!==(i=e.extname.localeCompare(t.extname))?i:(i=e.meta,a=t.meta,null!==i&&null!==a?i.guid.localeCompare(a.guid):0):1:t instanceof q?-1:e.name.localeCompare(t.name)};return function(e){return e.sort(t)}}(),h.createInoMap=function(){const n=(t,e)=>{if((t[e.stats.ino]=e)instanceof B){var i=e.children,a=i.length;for(let e=0;e<a;e++)n(t,i[e])}};return function(){var e=h["assets"];e instanceof B&&n(h.inoMap={},e)}}(),h.windowFocus=function(e){setTimeout(()=>h.update(),100)};class B{name;path;stats;parent;children;subfolders;contexts;constructor(e,t,i){this.name=e,this.path=t,this.stats=null,this.parent=i,this.children=Array.empty,this.subfolders=Array.empty,this.contexts=null}getContext(e){let t=this.contexts,i=(t=null===t?this.contexts=new Map:t).get(e);return void 0===i&&t.set(e,i={expanded:!1}),i}async update(e={changed:!1,promises:[]}){var t=B.bigint,i=R.route(this.path),i=z.stat(i,t),t=this.readdir(e),i=await i;return this.stats?.mtimeMs!==i.mtimeMs&&(e.changed=!0),this.stats=i,await t,e}async readdir(i){var a={},t=this.children;if(t instanceof Array){const o=t.length;for(let e=0;e<o;e++){var n=t[e];a[n.path]=n}}var e=this.path;const s=R.route(e);var r=await z.readdir(s,{withFileTypes:!0});const o=r.length;var l=new Array(o),c=new Array(o),h=[],d=B.bigint;for(let t=0;t<o;t++){var u=r[t],p=u.name;const s=e+"/"+p;if(u.isDirectory()){let e=a[s];e instanceof B||(e=new B(p,s,this),i.changed=!0),l[t]=e.update(i),c[t]=e,h.push(e)}else l[t]=z.stat(R.route(s),d),c[t]=s}var m=B["extnameToTypeMap"];for(let t=0;t<o;t++){var g=await l[t];if(!(c[t]instanceof B)){const s=c[t];var f,v;let e=a[s];void 0!==e&&e.stats.mtimeMs===g.mtimeMs||(b=r[t].name,v=m[(f=E.extname(b)).toLowerCase()]??"other",(e=new q(b,f,s,v,g)).promise instanceof Promise&&i.promises.push(e.promise.finally(()=>{delete e.promise})),i.changed=!0);var b=e.meta;null!==b&&(b.versionId=at.versionId),c[t]=e}}this.children=c,this.subfolders=h}static extnameToTypeMap={".actor":"actor",".skill":"skill",".trigger":"trigger",".item":"item",".equip":"equipment",".state":"state",".event":"event",".scene":"scene",".tile":"tileset",".ui":"ui",".anim":"animation",".particle":"particle",".png":"image",".jpg":"image",".jpeg":"image",".cur":"image",".webp":"image",".mp3":"audio",".m4a":"audio",".ogg":"audio",".wav":"audio",".flac":"audio",".mp4":"video",".mkv":"video",".webm":"video",".js":"script",".ts":"script",".ttf":"font",".otf":"font",".woff":"font",".woff2":"font"};static bigint={bigint:!0};static async create(e){var t=E.basename(e);return new B(t,e,null)}}class q{meta;name;alias;basename;extname;path;type;stats;contexts;constructor(e,t,i,a,n){let s=E.basename(e,t);var r=s.match(q.guidRegExp);switch(r&&(s=s.slice(0,r.index-1)),this.meta=null,this.name=e,this.alias=s+t,this.basename=s,this.extname=t,this.path=i,this.type=a,this.stats=n,this.contexts=null,this.createMeta(r?.[0]),a){case"image":We.textureManager.updateImage(this.meta.guid);break;case"script":He.loadScript(this)}}get data(){var e=this["meta"],t=e["guid"],i=He.manifest["guidMap"];if(i[t]===e)return e.dataMap?.[t]}createMeta(e){var t=this.stats,i=h.inoMap[t.ino];if(i instanceof q){i=i.meta;if((void 0===e||i.guid===e)&&i.redirect(this))return this.meta=i,this.meta.mtimeMs=t.mtimeMs,void this.updateFileName(i.guid)}if(void 0===e){for(;e=X.generate64bit(),He.manifest.guidMap[e];);this.updateFileName(e)}else if(oi.devmode&&He.manifest.guidMap[e])throw new Error("GUID already exists: "+e);this.meta=new at(this,e),this.meta.mtimeMs=t.mtimeMs}updateFileName(e){var t=this.basename,i=this.extname;if("string"!=typeof e||"string"!=typeof t||"string"!=typeof i)throw new Error("Failed to update File Name");const a=t+"."+e+i;if(this.name!==a){const n=E.dirname(this.path)+"/"+a,s=R.route(this.path),r=R.route(n);t=this.promise??Promise.resolve();this.promise=t.then(()=>z.rename(s,r).then(()=>{this.name=a,this.path=n,this.meta?.redirect(this)}))}}getContext(e){let t=this.contexts,i=(t=null===t?this.contexts=new Map:t).get(e);return void 0===i&&t.set(e,i={}),i}static dataMapNames={actor:"actors",skill:"skills",trigger:"triggers",item:"items",equipment:"equipments",state:"states",event:"events",scene:"scenes",tileset:"tilesets",ui:"ui",animation:"animations",particle:"particles",script:"scripts"};static guidRegExp=/(?<=\.)[0-9a-f]{16}$/;static isDataFile(e){return void 0!==q.dataMapNames[e.type]}}class X{static regExpForChecking=/[a-f]/;static generate32bit(){var e=4294967296*Math.random(),e=Math.floor(e).toString(16);return 8===e.length?e:e.padStart(8,"0")}static generate64bit(){let e;for(;e=this.generate32bit()+this.generate32bit(),!this.regExpForChecking.test(e););return e}}Object.defineProperty(HTMLElement.prototype,"name",{get:function(){return this.getAttribute("name")},set:function(e){this.setAttribute("name",e)}}),Object.defineProperty(HTMLElement.prototype,"innerHeight",{get:function(){let e=this._padding;void 0===e&&(i=this.css(),t=parseInt(i.paddingTop),i=parseInt(i.paddingBottom),e=this._padding=t+i);var t=this.clientHeight,i=t-e;return Math.max(i,0)}}),HTMLElement.prototype.read=function(){return this.dataValue},HTMLElement.prototype.write=function(e){this.dataValue=e},HTMLElement.prototype.clear=function(){return this.textContent="",this},HTMLElement.prototype.enable=function(){this.removeClass("disabled")},HTMLElement.prototype.disable=function(){this.addClass("disabled")},HTMLElement.prototype.hasClass=function(e){return this.classList.contains(e)},HTMLElement.prototype.addClass=function(e){return!this.classList.contains(e)&&(this.classList.add(e),!0)},HTMLElement.prototype.removeClass=function(e){return!!this.classList.contains(e)&&(this.classList.remove(e),!0)},HTMLElement.prototype.seek=function(e,t=1){let i=this;for(;0<t--&&i.tagName!==e.toUpperCase()&&i.parentNode instanceof HTMLElement;)i=i.parentNode;return i},HTMLElement.prototype.css=function(){return getComputedStyle(this)},HTMLElement.prototype.rect=function(){return this.getBoundingClientRect()},HTMLElement.prototype.hide=function(){return this.addClass("hidden"),this},HTMLElement.prototype.show=function(){return this.removeClass("hidden"),this},HTMLElement.prototype.hideChildNodes=function(){for(const e of this.childNodes)e.hide()},HTMLElement.prototype.showChildNodes=function(){for(const e of this.childNodes)e.show()},HTMLElement.prototype.getFocus=function(t=null){setTimeout(()=>{switch(this.focus(),t){case"all":this.select&&(this.select(),this.scrollLeft=0);break;case"end":var e;"number"==typeof this.selectionStart&&(e=this.value.length,this.selectionStart=e,this.selectionEnd=e)}})},HTMLElement.prototype.setTooltip=function(){const i=_("#tooltip"),o={capture:!0},l=new f({duration:0,callback:()=>{var e,t;"waiting"===c&&(e=h["tip"],e?(c="open",i.addClass("open"),i.textContent=h.tip,{width:e,height:t}=i.rect(),e=window.innerWidth-e,t=window.innerHeight-t,e=Math.min(p+10,e),t=Math.min(m+15,t),i.style.left=e+"px",i.style.top=t+"px",d=i.rect()):(c="closed",window.off("keydown",g,o),window.off("pointerdown",g,o)))}});let c="closed",h=null,d=null,u=0,p=0,m=0;function t(e){if(u!==e.timeStamp)switch(u=e.timeStamp,c){case"closed":h!==this&&(c="waiting",h=this,l.elapsed=0,l.duration=500,l.add(),p=e.clientX,m=e.clientY,window.on("keydown",g,o),window.on("pointerdown",g,o));break;case"waiting":h===this?(l.elapsed=0,p=e.clientX,m=e.clientY):g();break;case"open":var t,i,a,n,s,r;(h!==this||(t=e.clientX,i=e.clientY,a=d.left,n=d.right,s=d.top,r=d.bottom,a<=t&&t<n&&s<=i&&i<r))&&g()}}function a(e){h=null,g()}const g=function(){switch(c){case"waiting":case"open":c="closed",d=null,l.remove(),i.removeClass("open"),window.off("keydown",g,o),window.off("pointerdown",g,o)}};return function(e){switch("tip"in this==!1&&(this.on("pointermove",t),this.on("pointerleave",a)),typeof e){case"string":this.tip=e;break;case"function":Object.defineProperty(this,"tip",{configurable:!0,get:e})}}}(),HTMLElement.prototype.addScrollbars=function(){const e=document.createElement("scroll-bar"),t=document.createElement("scroll-bar"),i=document.createElement("scroll-corner");var a=this.parentNode,n=this.nextSibling,n=(n?(a.insertBefore(e,n),a.insertBefore(t,n),a.insertBefore(i,n)):(a.appendChild(e),a.appendChild(t),a.appendChild(i)),e.bind(this,"horizontal"),t.bind(this,"vertical"),e=>{this.dispatchEvent(new WheelEvent("wheel",e))});e.on("wheel",n),t.on("wheel",n),i.on("wheel",n);const s=new Event("userscroll");this.beginScrolling=function(){e.addClass("dragging"),t.addClass("dragging")},this.endScrolling=function(){e.removeClass("dragging"),t.removeClass("dragging")},this.setScroll=function(e,t){var i=this.scrollLeft,a=this.scrollTop;this.scroll(e,t),this.scrollLeft===i&&this.scrollTop===a||this.dispatchEvent(s)},this.setScrollLeft=function(e){var t=this.scrollLeft;this.scrollLeft=e,this.scrollLeft!==t&&this.dispatchEvent(s)};let r=!(this.setScrollTop=function(e){var t=this.scrollTop;this.scrollTop=e,this.scrollTop!==t&&this.dispatchEvent(s)});this.updateScrollbars=function(){this.clientWidth<this.scrollWidth&&this.clientHeight<this.scrollHeight?r||(r=!0,e.addClass("with-corner"),t.addClass("with-corner"),i.addClass("visible")):r&&(r=!1,e.removeClass("with-corner"),t.removeClass("with-corner"),i.removeClass("visible")),e.updateHorizontalBar(),t.updateVerticalBar()}},HTMLElement.prototype.addSetScrollMethod=function(){const n=new Event("userscroll");this.setScroll=function(e,t){var i=this.scrollLeft,a=this.scrollTop;this.scroll(e,t),this.scrollLeft===i&&this.scrollTop===a||this.dispatchEvent(n)}},HTMLElement.prototype.hasScrollBar=function(){return this.clientWidth<this.scrollWidth||this.clientHeight<this.scrollHeight},HTMLElement.prototype.isInContent=function(e){var e=e.getRelativeCoords(this),t=e.x-this.scrollLeft,e=e.y-this.scrollTop;return 0<=t&&t<this.clientWidth&&0<=e&&e<this.clientHeight},HTMLElement.prototype.dispatchChangeEvent=function(){const t=[new Event("change",{bubbles:!0}),new Event("change",{bubbles:!0})];return function(e=0){this.dispatchEvent(t[e])}}(),HTMLElement.prototype.dispatchResizeEvent=function(){const e=new Event("resize");return function(){this.dispatchEvent(e)}}(),HTMLElement.prototype.dispatchUpdateEvent=function(){const e=new Event("update");return function(){this.dispatchEvent(e)}}(),HTMLElement.prototype.listenDraggingScrollbarEvent=function(e=function(e){this.dragging||0===e.button&&e.altKey&&(e.preventDefault(),e.stopImmediatePropagation(),(this.dragging=e).mode="scroll",e.scrollLeft=this.scrollLeft,e.scrollTop=this.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.scrollPointerup),window.on("pointermove",this.scrollPointermove))},t){this.scrollPointerup=function(e){var t=this["dragging"];t.relate(e)&&("scroll"===t.mode&&pt.close("cursor-grab"),this.dragging=null,window.off("pointerup",this.scrollPointerup),window.off("pointermove",this.scrollPointermove))}.bind(this),this.scrollPointermove=function(e){var t=this["dragging"];t.relate(e)&&"scroll"===t.mode&&(this.scrollLeft=t.scrollLeft+t.clientX-e.clientX,this.scrollTop=t.scrollTop+t.clientY-e.clientY)}.bind(this),this.on("pointerdown",e,t)};{let l=null,c=0,h=0,d=!1,u=!1,n=null;const mi=e=>{var e=e*f.deltaTime,t=window.devicePixelRatio;return 0<e?Math.max(Math.floor(e),1)/t+1e-4:e<0?Math.min(Math.ceil(e),-1)/t+1e-4:0},gi=new f({duration:1/0,update:e=>{var{speedX:e,speedY:t}=e,{scrollLeft:i,scrollTop:a}=l;0!==e&&(l.scrollLeft+=mi(e)),0!==t&&(l.scrollTop+=mi(t)),l.scrollLeft===i&&l.scrollTop===a||n()}}),fi=e=>{var t=window.devicePixelRatio,i=l.rect(),a=e.clientX,e=e.clientY,n=i.left,s=i.top,r=l.clientWidth+n,o=l.clientHeight+s,r=Math.min(i.right,r)-t,i=Math.min(i.bottom,o)-t,o=d?a<=n?n-a<100/t?-h:-c:r<=a?a-r<100/t?+h:+c:0:0,n=u?e<=s?s-e<100/t?-h:-c:i<=e?e-i<100/t?+h:+c:0:0;0!=o||0!=n?gi.speedX===o&&gi.speedY===n||(gi.speedX=o,gi.speedY=n,gi.add()):gi&&(gi.speedX=0,gi.speedY=0,gi.remove())};HTMLElement.prototype.addScrollListener=function(e,t,i,a){switch(l?.removeScrollListener(),l=this,e){case"horizontal":d=!0,u=!1;break;case"vertical":d=!1,u=!0;break;case"both":d=!0,u=!0}c=t,h=i?t/4:t,n=a??Function.empty,window.on("pointermove",fi)},HTMLElement.prototype.removeScrollListener=function(){l===this&&((gi.speedX||gi.speedY)&&(gi.speedX=0,gi.speedY=0,gi.remove()),l=null,n=null,window.off("pointermove",fi))}}HTMLButtonElement.prototype.enable=function(){this.disabled&&(this.disabled=!1)},HTMLButtonElement.prototype.disable=function(){this.disabled||(this.disabled=!0)};class s extends HTMLElement{enableAmbient;activeElement;focusableElements;windowResize;openEventEnabled;closeEventEnabled;closedEventEnabled;resizeEventEnabled;maximizeEventEnabled;unmaximizeEventEnabled;constructor(){super(),this.enableAmbient=!0,this.activeElement=null,this.focusableElements=null,this.windowResize=null,this.openEventEnabled=!1,this.closeEventEnabled=!1,this.closedEventEnabled=!1,this.resizeEventEnabled=!1,this.maximizeEventEnabled=!1,this.unmaximizeEventEnabled=!1}open(){O.frames.append(this)&&(O.ambient.update(),this.addClass("open"),this.computePosition(),this.style.zIndex=O.frames.length,this.openEventEnabled&&this.dispatchEvent(new Event("open")),this.resizeEventEnabled)&&this.hasClass("maximized")&&(this.dispatchEvent(new Event("resize")),window.on("resize",this.windowResize))}close(){return!(this.closeEventEnabled&&!this.dispatchEvent(new Event("close",{cancelable:!0}))||!O.frames.remove(this)||(O.ambient.update(),this.removeClass("open"),this.closedEventEnabled&&this.dispatchEvent(new Event("closed")),this.resizeEventEnabled&&this.hasClass("maximized")&&window.off("resize",this.windowResize),document.activeElement!==document.body&&document.activeElement.blur(),0))}maximize(){this.addClass("maximized")&&(this.style.left="0",this.style.top="0",this.maximizeEventEnabled&&this.dispatchEvent(new Event("maximize")),this.resizeEventEnabled)&&(this.dispatchEvent(new Event("resize")),window.on("resize",this.windowResize))}unmaximize(){this.removeClass("maximized")&&(this.computePosition(),this.unmaximizeEventEnabled&&this.dispatchEvent(new Event("unmaximize")),this.resizeEventEnabled)&&(this.dispatchEvent(new Event("resize")),window.off("resize",this.windowResize))}focus(){if(this.removeClass("blur")){this.removeClass("translucent");for(const e of this.focusableElements)e.tabIndex+=1;this.focusableElements=null,this.activeElement&&(this.activeElement.focus(),this.activeElement=null)}}blur(){if(this.addClass("blur")){this.hasClass("opaque")||this.hasClass("maximized")||this.addClass("translucent");var e=x.focusableSelector,e=this.querySelectorAll(e);for(const t of e)--t.tabIndex;this.focusableElements=e,document.activeElement!==document.body&&(this.activeElement=document.activeElement,this.activeElement.blur())}}computePosition(){switch(this.getAttribute("mode")??O.positionMode){case"center":this.center();break;case"absolute":var e=O.absolutePos;this.absolute(e.x,e.y);break;case"overlap":e=O.frames,e=e[e.length-2];this.overlap(e)}}center(){var e=this.rect(),t=CSS.rasterize((window.innerWidth-e.width)/2),i=CSS.rasterize((window.innerHeight-e.height)/2);this.setPosition(t,i,e)}absolute(e,t){var i=this.rect(),e=CSS.rasterize(e),t=CSS.rasterize(t);this.setPosition(e,t,i)}overlap(e){var t=this.rect(),{left:e,top:i}=e.style,e=CSS.rasterize(parseFloat(e)+24),i=CSS.rasterize(parseFloat(i)+24);this.setPosition(e,i,t)}setPosition(e,t,i){document.body.hasClass("border")&&(e-=a=1/window.devicePixelRatio,t-=a);var a=window.innerWidth-i.width,i=window.innerHeight-i.height;this.style.left=Math.clamp(e,0,a)+"px",this.style.top=Math.clamp(t,0,i)+"px"}setTitle(e){var t=this.firstElementChild;if(t instanceof G)for(const i of t.childNodes)if(i instanceof Text)return void(i.nodeValue=e)}on(e,t,i){switch(super.on(e,t,i),e){case"open":this.openEventEnabled=!0;break;case"close":this.closeEventEnabled=!0;break;case"closed":this.closedEventEnabled=!0;break;case"resize":this.resizeEventEnabled=!0,this.windowResize=e=>{this.dispatchEvent(new Event("resize"))};break;case"maximize":this.maximizeEventEnabled=!0;break;case"unmaximize":this.unmaximizeEventEnabled=!0}}}customElements.define("window-frame",s);class G extends HTMLElement{dragging;constructor(){super(),this.dragging=null,this.on("pointerdown",this.pointerdown),this.on("click",this.mouseclick),this.on("doubleclick",this.doubleclick)}pointerdown(e){if(!this.dragging&&0===e.button)if(e.target instanceof G){const n=this.parentNode;var t=n.rect();const s=e.clientX,r=e.clientY,{left:o,top:l,width:c,height:h}=t,i=i=>{if(this.dragging.relate(i)){let e=window.innerWidth-c,t=window.innerHeight-h;document.body.hasClass("border")&&(a=1/window.devicePixelRatio,e-=2*a,t-=2*a);var a=CSS.rasterize(o-s+i.clientX),i=CSS.rasterize(l-r+i.clientY);n.style.left=Math.clamp(a,0,e)+"px",n.style.top=Math.clamp(i,0,t)+"px"}},a=e=>{this.dragging.relate(e)&&d()},d=e=>{this.dragging=null,window.off("pointermove",i),window.off("pointerup",a),window.off("blur",d)};(this.dragging=e).cancel=d,window.on("pointermove",i),window.on("pointerup",a),window.on("blur",d)}}mouseclick(e){switch(e.target.tagName){case"MAXIMIZE":var t=this.parentNode;t.hasClass("maximized")?t.unmaximize():t.maximize();break;case"CLOSE":t=this.parentNode;O.close(t.id)}}doubleclick(e){e.target instanceof G&&e.target.querySelector("maximize")&&(this.dragging?.cancel(),(e=this.parentNode).hasClass("maximized")?e.unmaximize():e.maximize())}}customElements.define("title-bar",G);class i extends HTMLElement{index;active;switchEventEnabled;constructor(){super();var t=this.childNodes;if(0<t.length){let e=t.length;for(;0<=--e;){var i=t[e];"PAGE-FRAME"===i.tagName?i.dataValue=i.getAttribute("value"):this.removeChild(i)}}this.index=null,this.active=null,this.switchEventEnabled=!1}switch(t){var i=this.index;if(i!==t){let e=null;if(null!==t)for(const s of this.childNodes)if(s.dataValue===t){e=s;break}var a,n=this.active;n!==e&&(this.index=t,this.active=e,n?.removeClass("visible"),e?.addClass("visible"),this.switchEventEnabled&&((a=new Event("switch")).last=i,a.value=t,this.dispatchEvent(a)),n?.dispatchResizeEvent(),e?.dispatchResizeEvent())}}on(e,t,i){super.on(e,t,i),"switch"===e&&(this.switchEventEnabled=!0)}}customElements.define("page-manager",i);class r extends HTMLElement{selection;x;y;width;height;scaleX;scaleY;visible;saveData;constructor(){super();var e=document.createElement("selection");this.appendChild(e.hide()),this.selection=e,this.x=0,this.y=0,this.width=0,this.height=0,this.scaleX=1,this.scaleY=1,this.visible=!1,this.saveData={}}save(e="default"){this.saveData[e]={x:this.x,y:this.y,width:this.width,height:this.height,scaleX:this.scaleX,scaleY:this.scaleY}}restore(e="default"){var t=this.saveData[e];if(t){for(const e of Object.keys(t))this[e]=t[e];this.saveData[e]=null}}resize({width:e,height:t}){this.style.width=e+"px",this.style.height=t+"px"}clear(){this.visible&&(this.visible=!1,this.selection.hide())}select(e=this.x,t=this.y,i=this.width,a=this.height){this.x=e,this.y=t,this.width=i,this.height=a,this.visible=!0;var n=this.selection,s=this.scaleX,r=this.scaleY,e=e*s,t=t*r,i=i*s,s=a*r;n.show(),n.style.left=e+"px",n.style.top=t+"px",n.style.width=i+"px",n.style.height=s+"px"}}customElements.define("marquee-area",r);class V extends HTMLElement{toggleEventEnabled;constructor(){super(),this.toggleEventEnabled=!1}toggle(){this.hasAttribute("open")?this.close():this.open()}open(){if(!this.hasAttribute("open")){this.setAttribute("open","");for(const t of this.children)t instanceof W||t.show();var e;this.toggleEventEnabled&&((e=new Event("toggle")).value="open",this.dispatchEvent(e))}}close(){if(this.hasAttribute("open")){this.removeAttribute("open");for(const t of this.children)t instanceof W||t.hide();var e;this.toggleEventEnabled&&((e=new Event("toggle")).value="closed",this.dispatchEvent(e))}}on(e,t,i){super.on(e,t,i),"toggle"===e&&(this.toggleEventEnabled=!0)}}customElements.define("detail-box",V);class W extends HTMLElement{constructor(){super(),this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown)}toggle(){var e=this.parentNode;e instanceof V&&e.toggle()}keydown(e){switch(e.code){case"Enter":case"NumpadEnter":e.cmdOrCtrlKey||e.altKey||this.toggle()}}pointerdown(e){0===e.button&&e.target===this&&this.toggle()}}customElements.define("detail-summary",W);class H{input;stack;index;inputType;deleted;inserted;lastInsert;lastStart;lastEnd;editingStart;selectionStart;selectionEnd;constructor(e){this.input=e,this.stack=[],this.index=-1,this.inputType="",this.deleted="",this.inserted="",this.lastInsert="",this.lastStart=0,this.lastEnd=0,this.editingStart=0,this.selectionStart=0,this.selectionEnd=0,e.replace=H.inputReplace,e.on("keydown",this.inputKeydown),e.on("beforeinput",this.inputBeforeinput),e.on("input",this.inputInput),e.on("blur",this.inputBlur),e.on("compositionstart",this.inputCompositionstart),e.on("compositionend",this.inputCompositionEnd)}reset(){0!==this.stack.length&&(this.stack=[],this.index=-1),this.inputType="",this.lastInsert=""}save(){var e,t,i;this.inputType&&(this.inputType="",this.deleted||this.inserted)&&(e={deleted:this.deleted,inserted:this.inserted,lastStart:this.lastStart,lastEnd:this.lastEnd,editingStart:this.editingStart},t=this.stack,(i=this.index+1)<t.length&&(t.length=i),t.length<20?this.index++:t.shift(),t.push(e))}restore(t){"undo"===t&&this.save();let i=this.index;if("redo"===t&&i++,0<=i&&i<this.stack.length){var a=this.input,{deleted:n,inserted:s,lastStart:r,lastEnd:o,editingStart:l}=this.stack[i];let e;switch(H.restoring=!0,t){case"undo":e="historyUndo",0<s.length&&(a.selectionStart=l,a.selectionEnd=l+s.length,document.execCommand("delete")),0<n.length&&(a.selectionStart=l,a.selectionEnd=l,document.execCommand("insertText",!1,n),a.selectionStart=r,a.selectionEnd=o),this.index--;break;case"redo":e="historyRedo",0<n.length&&(a.selectionStart=l,a.selectionEnd=l+n.length,document.execCommand("delete")),0<s.length&&(a.selectionStart=l,a.selectionEnd=l,document.execCommand("insertText",!1,s)),this.index++}H.restoring=!1,U.finish(),a.dispatchEvent(new InputEvent("input",{inputType:e,bubbles:!0}))}}canUndo(){return 0<=this.index||!!this.inputType}canRedo(){return this.index+1<this.stack.length}updateStates(e){var t,i=this["input"],a=e.inputType;switch(this.inputType!==a&&(this.inputType=a??"unknown",this.inserted="",this.deleted="",this.lastStart=i.selectionStart,this.lastEnd=i.selectionEnd,this.editingStart=i.selectionStart,i.selectionStart!==i.selectionEnd)&&(this.deleted=i.value.slice(i.selectionStart,i.selectionEnd)),a){case"insertLineBreak":this.inserted+="\n";break;case"insertText":e.data&&(this.inserted+=e.data);break;case"deleteContentForward":i.selectionStart<i.value.length&&i.selectionStart===i.selectionEnd&&(t=i.value[i.selectionStart],this.deleted=this.deleted+t);break;case"deleteContentBackward":0<i.selectionStart&&i.selectionStart===i.selectionEnd&&(t=i.value[i.selectionStart-1],this.deleted=t+this.deleted,this.editingStart--);break;case"replaceText":this.inserted=e.data;break;default:e.data&&(this.inserted=-1!==e.data.indexOf("\r")?e.data.replace(/\r/g,""):e.data)}}updateSelection(e){var t=this["input"];this.lastInsert=e.data,this.selectionStart=t.selectionStart,this.selectionEnd=t.selectionEnd}inputKeydown(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyZ":this.history.canUndo()&&this.history.restore("undo");break;case"KeyY":this.history.canRedo()&&this.history.restore("redo")}}inputBeforeinput(e){var t=this["history"];switch(e.inputType){case"insertCompositionText":return;case"insertLineBreak":if(this instanceof HTMLInputElement)return;case"insertText":switch(e.data){case" ":case"<":t.lastInsert!==e.data&&U.finish()}case"deleteContentForward":case"deleteContentBackward":switch(""===t.inputType||!U.complete&&U.type===e.inputType&&t.selectionStart===this.selectionStart&&t.selectionEnd===this.selectionEnd||t.save(),U.start(e.inputType),e.data){case":":case">":t.lastInsert!==e.data&&U.finish()}break;case"replaceText":null===t.inputType||!U.complete&&U.type===e.inputType||t.save(),U.start(e.inputType);break;default:t.save(),U.finish()}t.updateStates(e)}inputInput(e){"insertCompositionText"!==e.inputType&&(H.restoring?e.stopImmediatePropagation():this.history.updateSelection(e))}inputBlur(e){U.finish()}inputCompositionstart(e){var t=this["history"],i=H.eventStruct;i.data=null,t.save(),t.inputBeforeinput.call(this,i),t.updateSelection(e)}inputCompositionEnd(e){var t,i=this["history"];e.data||i.deleted?((t=H.eventStruct).data=e.data,i.updateStates(t),i.updateSelection(e)):i.inputType=""}}H.restoring=!1,H.eventStruct={inputType:"inputCompositionText",data:null},H.inputReplace=function(){const t={inputType:"replaceText",data:null};return function(e){"number"==typeof e&&(e=e.toString()),t.data=e,this.select(),this.history.inputBeforeinput.call(this,t),this.value=e}}();class K{input;stack;index;lastValue;constructor(e){this.input=e,this.stack=[],this.index=-1,this.lastValue="",e.on("keydown",this.inputKeydown),e.on("input",this.inputInput),e.on("blur",this.inputBlur)}reset(){0!==this.stack.length&&(this.stack=[],this.index=-1),this.lastValue=this.input.value}save(){var e={value:this.lastValue},t=this.stack,i=this.index+1;i<t.length&&(t.length=i),t.length<20?this.index++:t.shift(),t.push(e)}restore(e){let t=this.index;if("redo"===e&&t++,0<=t&&t<this.stack.length){var i=this.input,a=this.stack[t],n=a["value"];switch(a.value=this.lastValue,K.restoring=!0,i.select(),document.execCommand("insertText",!1,n),"undo"===e&&i.select(),K.restoring=!1,U.finish(),e){case"undo":this.index--;break;case"redo":this.index++}}}canUndo(){return 0<=this.index}canRedo(){return this.index+1<this.stack.length}inputKeydown(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyZ":this.history.canUndo()&&this.history.restore("undo");break;case"KeyY":this.history.canRedo()&&this.history.restore("redo")}}inputInput(e){if(!K.restoring)switch(e.inputType){case"insertCompositionText":break;case"insertText":case"deleteContentForward":case"deleteContentBackward":!U.complete&&U.type===e.inputType||this.history.save(),U.start(e.inputType);break;case void 0:!U.complete&&"quickInput"===U.type||this.history.save(),U.start("quickInput");break;default:this.history.save(),U.finish()}"insertCompositionText"!==e.inputType&&(this.history.lastValue=this.value)}inputBlur(e){U.finish()}}K.restoring=!1;const U=new f({duration:2e3,callback:e=>{e.complete=!0}});U.complete=!0,U.start=function(e){this.complete&&(this.complete=!1,this.add()),this.type=e,this.elapsed=0},U.finish=function(){this.complete||(this.complete=!0,this.remove())};class $ extends HTMLElement{input;focusEventEnabled;blurEventEnabled;constructor(){super();var e=document.createElement("input");e.addClass("text-box-input"),e.type="text",e.history=new H(e),this.appendChild(e),this.input=e,this.focusEventEnabled=!1,this.blurEventEnabled=!1}read(){return this.input.value}write(e){this.input.value=e,this.input.history.reset()}insert(e){this.input.dispatchEvent(new InputEvent("beforeinput",{inputType:"insertFromPaste",data:e,bubbles:!0})),document.execCommand("insertText",!1,e)}enable(){this.removeClass("disabled")&&this.showChildNodes()}disable(){this.addClass("disabled")&&this.hideChildNodes()}getFocus(e){return this.input.getFocus(e)}setPlaceholder(e){this.input.placeholder=e}setMaxLength(e){this.input.maxLength=e}fitContent(){var e=this.parentNode;this.style.width="0",this.style.width=Math.clamp(this.input.scrollWidth+2,0,e.rect().right-this.rect().left)+"px"}deleteInputContent(){""!==this.read()&&(this.input.select(),this.input.dispatchEvent(new InputEvent("beforeinput",{inputType:"deleteContentForward",bubbles:!0})),document.execCommand("delete"))}addCloseButton(){return $.addCloseButton(this)}addKeydownFilter(){return $.addKeydownFilter(this)}on(e,t,i){switch(super.on(e,t,i),e){case"focus":this.focusEventEnabled||(this.focusEventEnabled=!0,this.input.on("focus",e=>{this.dispatchEvent(new FocusEvent("focus"))}));break;case"blur":this.blurEventEnabled||(this.blurEventEnabled=!0,this.input.on("blur",e=>{this.dispatchEvent(new FocusEvent("blur"))}))}}static addCloseButton=e=>{e.write=J,e.on("keydown",ee),e.on("input",te),e.closeButton=document.createElement("box"),e.closeButton.addClass("close-button"),e.closeButton.textContent="✖",e.closeButton.on("pointerdown",ie),e.closeButton.on("click",ae),e.appendChild(e.closeButton.hide())};static addKeydownFilter=e=>{e.on("keydown",Z)}}function Z(e){if(!e.altKey){if(!e.cmdOrCtrlKey&&!e.shiftKey)switch(e.code){case"Escape":case"F1":case"F3":case"F4":case"F9":return}e.stopImmediatePropagation()}}function J(e){$.prototype.write.call(this,e),Q(this)}function Q(e){""!==e.read()?e.closeButton.show():e.closeButton.hide()}function ee(e){"Escape"===e.code&&""!==this.read()&&(e.stopPropagation(),this.deleteInputContent())}function te(e){Q(this)}function ie(e){e.preventDefault(),e.stopPropagation()}function ae(e){this.parentNode.deleteInputContent()}customElements.define("text-box",$);class ne extends HTMLElement{input;focusEventEnabled;blurEventEnabled;constructor(){super();var e=document.createElement("textarea");e.history=new H(e),e.on("keydown",this.inputKeydown),e.on("input",this.inputInput),e.listenDraggingScrollbarEvent(),this.appendChild(e),this.input=e,this.focusEventEnabled=!1,this.blurEventEnabled=!1}read(){return this.input.value}write(e){this.input.value=e,this.input.history.reset()}insert(e){this.input.dispatchEvent(new InputEvent("beforeinput",{inputType:"insertFromPaste",data:e,bubbles:!0})),document.execCommand("insertText",!1,e)}enable(){this.removeClass("disabled")&&this.showChildNodes()}disable(){this.addClass("disabled")&&this.hideChildNodes()}getFocus(e){return this.input.getFocus(e)}inputKeydown(e){switch(e.code){case"Enter":case"NumpadEnter":e.cmdOrCtrlKey||e.stopPropagation()}ne.target||(ne.target=this,ne.timer.add(),this.addClass("inputting"))}inputInput(e){ne.target||(ne.target=this,ne.timer.add(),this.addClass("inputting"))}on(e,t,i){switch(super.on(e,t,i),e){case"focus":this.focusEventEnabled||(this.focusEventEnabled=!0,this.input.on("focus",e=>{this.dispatchEvent(new FocusEvent("focus"))}));break;case"blur":this.blurEventEnabled||(this.blurEventEnabled=!0,this.input.on("blur",e=>{this.dispatchEvent(new FocusEvent("blur"))}))}}static target=null;static timer=new f({duration:0,callback:e=>{ne.target.removeClass("inputting"),ne.target=null}})}customElements.define("text-area",ne);class se extends HTMLElement{input;dataValue;inputEventEnabled;focusEventEnabled;blurEventEnabled;constructor(){super();var e=document.createElement("input");e.addClass("keyboard-box-input"),e.type="text",e.on("keydown",this.inputKeydown),this.appendChild(e),this.input=e,this.dataValue=0,this.inputEventEnabled=!1,this.focusEventEnabled=!1,this.blurEventEnabled=!1}read(){return this.dataValue}write(e){this.dataValue=e,this.input.value=e}inputCode(e){this.dataValue!==e&&(this.write(e),this.inputEventEnabled&&((e=new InputEvent("input")).value=this.dataValue,this.dispatchEvent(e)),this.dispatchChangeEvent())}enable(){this.removeClass("disabled")&&this.showChildNodes()}disable(){this.addClass("disabled")&&this.hideChildNodes()}getFocus(e){return this.input.getFocus(e)}on(e,t,i){switch(super.on(e,t,i),e){case"input":this.inputEventEnabled=!0;break;case"focus":this.focusEventEnabled||(this.focusEventEnabled=!0,this.input.on("focus",e=>{this.dispatchEvent(new FocusEvent("focus"))}));break;case"blur":this.blurEventEnabled||(this.blurEventEnabled=!0,this.input.on("blur",e=>{this.dispatchEvent(new FocusEvent("blur"))}))}}inputKeydown(e){switch(e.stopPropagation(),e.preventDefault(),e.code){case"Backspace":this.parentNode.inputCode("");break;case"Enter":case"NumpadEnter":e.stopImmediatePropagation();default:this.parentNode.inputCode(e.code)}}}customElements.define("keyboard-box",se);class re extends HTMLElement{dataValue;foreground;inputEventEnabled;constructor(){super();var e=document.createElement("box"),e=(e.addClass("color-box-background"),this.appendChild(e),document.createElement("box"));e.addClass("color-box-foreground"),this.appendChild(e),this.tabIndex=0,this.dataValue="",this.foreground=e,this.inputEventEnabled=!1,this.on("keydown",this.keydown),this.on("click",this.mouseclick)}read(){return this.dataValue}write(e){this.dataValue=e;var t=parseInt(e.slice(0,2),16),i=parseInt(e.slice(2,4),16),a=parseInt(e.slice(4,6),16),e=parseInt(e.slice(6,8),16)/255;this.foreground.style.backgroundColor=`rgba(${t}, ${i}, ${a}, ${e})`}input(e){this.dataValue!==e&&(this.write(e),this.inputEventEnabled&&((e=new Event("input")).value=this.dataValue,this.dispatchEvent(e)),this.dispatchChangeEvent())}enable(){this.removeClass("disabled")&&this.showChildNodes()}disable(){this.addClass("disabled")&&this.hideChildNodes()}on(e,t,i){super.on(e,t,i),"input"===e&&(this.inputEventEnabled=!0)}keydown(e){switch(e.code){case"Enter":case"NumpadEnter":e.cmdOrCtrlKey||(e.stopPropagation(),this.mouseclick(e))}}mouseclick(e){m.open(this)}}customElements.define("color-box",re);class oe extends HTMLElement{dataValue;relations;writeEventEnabled;inputEventEnabled;constructor(e){switch(super(),this.dataValue=!1,this.relations=[],this.writeEventEnabled=!1,this.inputEventEnabled=!1,this.on("keydown",this.keydown),e??this.hasClass("standard")){case!0:var t=document.createElement("check-mark");this.tabIndex=0,this.insertBefore(t,this.childNodes[0]),this.on("click",this.mouseclick);break;case!1:this.on("pointerdown",this.pointerdown)}}read(){return this.dataValue}write(e){this.dataValue=!!e,this.dataValue?this.addClass("selected"):this.removeClass("selected"),this.hasClass("disabled")||this.toggleRelatedElements(),this.writeEventEnabled&&((e=new Event("write")).value=this.dataValue,this.dispatchEvent(e))}input(e){this.dataValue!==e&&(this.write(e),this.inputEventEnabled&&((e=new Event("input",{bubbles:!0})).value=this.dataValue,this.dispatchEvent(e)),this.dispatchChangeEvent())}enable(){this.removeClass("disabled")&&this.toggleRelatedElements()}disable(){this.addClass("disabled")&&this.toggleRelatedElements()}relate(e){this.relations=e}toggleRelatedElements(){if(!this.hasClass("disabled")&&this.dataValue)for(const e of this.relations)e.enable();else for(const t of this.relations)t.disable()}on(e,t,i){switch(super.on(e,t,i),e){case"write":this.writeEventEnabled=!0;break;case"input":this.inputEventEnabled=!0}}keydown(e){switch(e.code){case"Enter":case"NumpadEnter":e.cmdOrCtrlKey||this.hasClass("disabled")||(e.stopPropagation(),this.mouseclick(e))}}pointerdown(e){0===e.button&&(document.activeElement!==document.body&&document.activeElement.blur(),this.input(!this.read()))}mouseclick(e){this.input(!this.read())}}customElements.define("check-box",oe);class le extends HTMLElement{dataValue;relations;cancelable;writeEventEnabled;inputEventEnabled;constructor(){super(),this.dataValue=null,this.relations=[],this.cancelable=!1,this.writeEventEnabled=!1,this.inputEventEnabled=!1}read(){return this.dataValue}write(e){var t;for(const i of document.getElementsByName(this.id))i.dataValue===e?(i.addClass("selected"),this.dataValue=e):i.removeClass("selected");this.hasClass("disabled")||this.toggleRelatedElements(),this.writeEventEnabled&&((t=new Event("write")).value=this.dataValue,this.dispatchEvent(t))}input(e){var t=this.dataValue;t!==e&&(this.write(e),this.inputEventEnabled&&((e=new Event("input")).value=this.dataValue,e.lastValue=t,this.dispatchEvent(e)),this.dispatchChangeEvent())}reset(){if(null!==this.dataValue){for(const e of document.getElementsByName(this.id))if(e.dataValue===this.dataValue){e.removeClass("selected");break}this.dataValue=null}}enable(){if(this.removeClass("disabled")){for(const e of document.getElementsByName(this.id))e.removeClass("disabled");this.toggleRelatedElements()}}disable(){if(this.addClass("disabled")){for(const e of document.getElementsByName(this.id))e.addClass("disabled");this.toggleRelatedElements()}}relate(e){this.relations=e}toggleRelatedElements(){if(0!==this.relations.length)if(this.hasClass("disabled"))for(const i of this.relations)for(const a of i.targets)a.disable();else{var e=this.relations,t=e.find(e=>e.case===this.dataValue);for(const n of e)if(n.case===this.dataValue)for(const s of n.targets)s.enable();else for(const r of t?Array.subtract(n.targets,t.targets):n.targets)r.disable()}}on(e,t,i){switch(super.on(e,t,i),e){case"write":this.writeEventEnabled=!0;break;case"input":this.inputEventEnabled=!0}}static map={}}customElements.define("radio-proxy",le);class ce extends HTMLElement{proxy;dataValue;constructor(){super();let e=le.map[this.name];void 0===e&&((e=document.createElement("radio-proxy")).id=this.name,e.style.display="none",this.appendChild(e),le.map[e.id]=e);var t=this.getAttribute("value"),t=RegExp.number.test(t)?parseFloat(t):"false"!==t&&("true"===t||t);switch(this.proxy=e,this.dataValue=t,this.on("keydown",this.keydown),this.hasClass("standard")){case!0:var i=document.createElement("radio-mark");this.tabIndex=0,this.insertBefore(i,this.childNodes[0]),this.on("click",this.mouseclick);break;case!1:this.on("pointerdown",this.pointerdown)}}keydown(e){switch(e.code){case"Enter":case"NumpadEnter":e.cmdOrCtrlKey||this.hasClass("disabled")||(e.stopPropagation(),this.mouseclick(e))}}pointerdown(e){0===e.button&&(this.hasClass("selected")?this.proxy.cancelable&&(document.activeElement!==document.body&&document.activeElement.blur(),this.proxy.reset()):(document.activeElement!==document.body&&document.activeElement.blur(),this.proxy.input(this.dataValue)))}mouseclick(e){this.hasClass("selected")?this.proxy.cancelable&&this.proxy.reset():this.proxy.input(this.dataValue)}}customElements.define("radio-box",ce);class he extends HTMLElement{dataValue;class;length;inputEventEnabled;constructor(){super();var e=Math.clamp(parseInt(this.getAttribute("length")),1,4);this.dataValue=0,this.class="",this.length=e,this.inputEventEnabled=!1,this.on("pointerdown",this.pointerdown)}read(){return this.dataValue}write(e){this.dataValue=e,this.update()}update(){this.removeClass(this.class),this.addClass(this.class=he.classes[this.dataValue])}on(e,t,i){super.on(e,t,i),"input"===e&&(this.inputEventEnabled=!0)}pointerdown(e){0===e.button&&(this.write((this.dataValue+1)%this.length),this.inputEventEnabled)&&((e=new Event("input")).value=this.dataValue,this.dispatchEvent(e))}static classes=["zero","one","two","three"]}customElements.define("switch-item",he);class de extends HTMLElement{filler;input;synchronizer;activeWheel;focusEventEnabled;blurEventEnabled;constructor(){super();var e=this.getAttribute("min")??"0",t=this.getAttribute("max")??"0",i=this.getAttribute("step")??"1",a=document.createElement("slider-bar"),n=(this.appendChild(a),document.createElement("slider-filler")),a=(a.appendChild(n),document.createElement("input"));a.addClass("slider-input"),a.type="range",a.min=e,a.max=t,a.step=i,a.tabIndex=-1,a.on("wheel",this.inputWheel),this.appendChild(a),this.filler=n,this.input=a,this.synchronizer=null,this.activeWheel=this.hasAttribute("active-wheel"),this.focusEventEnabled=!1,this.blurEventEnabled=!1,this.on("input",this.sliderInput)}read(){return parseFloat(this.input.value)}write(e){this.input.value=e,this.updateFiller()}enable(){this.removeClass("disabled")&&this.showChildNodes()}disable(){this.addClass("disabled")&&this.hideChildNodes()}updateFiller(){var e,t,i=this.filler,a=this.read();i.value!==a&&(i.value=a,t=this.input,(e=parseFloat(t.min))!==(t=parseFloat(t.max)))&&(a=Math.roundTo(100*(a-e)/(t-e),6),i.style.width=a+"%")}synchronize(e){const t=this,i=e;if(!t.synchronizer&&i instanceof ue){const a=t.write,n=i.write;const s=e=>{n.call(i,t.read()),e&&i.dispatchEvent(new Event("input"))},r=e=>{a.call(t,i.read()),e&&t.dispatchEvent(new Event("input"))};t.synchronizer=e,t.input.on("pointerdown",()=>{t.input.focus()}),t.input.on("input",s),i.input.on("input",r),t.write=e=>{a.call(t,e),s()},i.write=e=>{n.call(i,e),r()}}}on(e,t,i){switch(super.on(e,t,i),e){case"focus":this.focusEventEnabled||(this.focusEventEnabled=!0,this.input.on("focus",e=>{this.dispatchEvent(new FocusEvent("focus"))}));break;case"blur":this.blurEventEnabled||(this.blurEventEnabled=!0,this.input.on("blur",e=>{this.dispatchEvent(new FocusEvent("blur"))}))}}sliderInput(e){this.updateFiller()}inputWheel(e){var t,i;0!==e.deltaY&&this.parentNode.activeWheel&&(e.preventDefault(),i=(t=this).value,t.value=Math.roundTo(parseFloat(t.value)+parseFloat(t.step)*(0<e.deltaY?-1:1),2),t.value!==i)&&t.dispatchEvent(new Event("input",{bubbles:!0}))}}customElements.define("slider-box",de);class ue extends HTMLElement{input;decimals;focusEventEnabled;blurEventEnabled;constructor(e){super();var t=(e=e??this).getAttribute("min")??"0",i=e.getAttribute("max")??"0",a=e.getAttribute("step")??"1",n=e.getAttribute("unit"),e=parseInt(e.getAttribute("decimals"))||0,s=document.createElement("input");s.addClass("number-box-input"),s.type="number",s.min=t,s.max=i,s.step=a,s.title="",s.history=new K(s),s.on("keydown",this.inputKeydown),s.on("change",this.inputChange),this.appendChild(s),1<this.childNodes.length&&(t=this.childNodes[0].textContent,i=L(t,"var(--font-family-mono)").width+8,s.style.paddingLeft=i+"px"),null!==n&&(a=document.createElement("text"),t=L(n,"var(--font-family-mono)").width+8,a.addClass("unit"),a.textContent=n,this.insertBefore(a,s),s.style.paddingRight=t+"px"),this.input=s,this.decimals=e,this.focusEventEnabled=!1,this.blurEventEnabled=!1}read(){var e=parseFloat(this.input.min),t=parseFloat(this.input.max),i=parseFloat(this.input.value)||0,i=Math.clamp(i,e,t);return Math.roundTo(i,this.decimals)}write(e){var t=this["input"];t.value=e,t.value=this.read(),t.history.reset()}enable(){this.removeClass("disabled")&&this.showChildNodes()}disable(){this.addClass("disabled")&&this.hideChildNodes()}getFocus(e){return this.input.getFocus(e)}on(e,t,i){switch(super.on(e,t,i),e){case"focus":this.focusEventEnabled||(this.focusEventEnabled=!0,this.input.on("focus",e=>{this.dispatchEvent(new FocusEvent("focus"))}));break;case"blur":this.blurEventEnabled||(this.blurEventEnabled=!0,this.input.on("blur",e=>{this.dispatchEvent(new FocusEvent("blur"))}))}}inputKeydown(e){ue.whiteList.includes(e.code)||e.cmdOrCtrlKey||e.preventDefault()}inputChange(e){this.value=this.parentNode.read()}static whiteList=["Digit0","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Minus","Period","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadSubtract","NumpadDecimal","Backspace","Delete","Tab","Enter","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Home","End","NumpadEnter"]}customElements.define("number-box",ue);class pe extends HTMLElement{info;dataItems;dataValue;relations;invalid;hideUnrelated;writeEventEnabled;inputEventEnabled;constructor(){super();var e=document.createElement("text");e.addClass("select-box-text"),this.appendChild(e),this.tabIndex=0,this.info=e,this.dataItems=null,this.dataValue=null,this.relations=[],this.invalid=!1,this.hideUnrelated=!1,this.writeEventEnabled=!1,this.inputEventEnabled=!1,this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown)}read(){return this.dataValue}write(e){this.dataValue=e,this.update(),this.hasClass("disabled")||this.toggleRelatedElements(),this.writeEventEnabled&&((e=new Event("write")).value=this.dataValue,this.dispatchEvent(e))}write2(e){for(const t of this.dataItems)if(t.value===e)return void this.write(e);this.writeDefault()}writeDefault(){this.write(this.dataItems[0].value)}input(e){var t=this.dataValue;t!==e&&(this.write(e),this.inputEventEnabled&&((e=new Event("input",{bubbles:!0})).last=t,e.value=this.dataValue,this.dispatchEvent(e)),this.dispatchChangeEvent())}update(){var e=this.info,t=this.dataValue,i=this.dataItems,a=i.length;let n;for(let e=0;e<a;e++){var s=i[e];if(s.value===t){n=s.name;break}}void 0!==n?(this.invalid=!1,e.removeClass("invalid"),e.textContent=n):(this.invalid=!0,e.addClass("invalid"),e.textContent=t)}reselect(t){var i=this.dataValue,a=this.dataItems,n=a.length;for(let e=0;e<n;e++)if(a[e].value===i){const s=e+t;return void(0<=s&&s<n&&this.input(a[s].value))}const s=0<t?0:n-1;this.input(a[s].value)}save(){this.savedValue=this.read()}restore(){void 0!==this.savedValue&&(this.input(this.savedValue),delete this.savedValue)}enable(){this.removeClass("disabled")&&(this.tabIndex+=1,this.showChildNodes(),this.toggleRelatedElements())}disable(){this.addClass("disabled")&&(--this.tabIndex,this.hideChildNodes(),this.toggleRelatedElements())}loadItems(e){this.dataItems=e}setItemNames(e){for(const i of this.dataItems){var t=e[i.value];void 0!==t&&(i.name=t)}null!==this.dataValue&&this.update()}clear(){return this.dataItems=null,this.dataValue=null,this.info.textContent="",this}enableHiddenMode(){return this.hideUnrelated=!0,this}relate(e){this.relations=e}toggleRelatedElements(){if(0!==this.relations.length)if(this.hasClass("disabled"))for(const a of this.relations)for(const n of a.targets)this.disableElement(n);else{var e=this.relations;const s=this.dataValue;var t=e.find(e=>e.case instanceof Array?e.case.includes(s):e.case===s),i=[];for(const r of e)if(r.case instanceof Array?r.case.includes(s):r.case===s)i.push(r);else for(const o of t?Array.subtract(r.targets,t.targets):r.targets)this.disableElement(o);for(const l of i)for(const c of l.targets)this.enableElement(c)}}enableElement(t){if(t.enable(),this.hideUnrelated){let e=t.previousSibling;for(;e instanceof Text;)e=e.previousSibling;"TEXT"===e.tagName&&e.show(),t.show()}}disableElement(t){if(t.disable(),this.hideUnrelated){let e=t.previousSibling;for(;e instanceof Text;)e=e.previousSibling;"TEXT"===e.tagName&&e.hide(),t.hide()}}on(e,t,i){switch(super.on(e,t,i),e){case"write":this.writeEventEnabled=!0;break;case"input":this.inputEventEnabled=!0}}keydown(e){switch(e.code){case"Enter":case"NumpadEnter":e.cmdOrCtrlKey||(e.stopPropagation(),ge.open(this));break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),this.reselect(-1);break;case"ArrowDown":e.preventDefault(),e.stopPropagation(),this.reselect(1)}}pointerdown(e){0===e.button&&ge.open(this)}}customElements.define("select-box",pe);class me extends HTMLElement{state;target;elements;selection;windowKeydown;windowPointerdown;windowResize;windowBlur;constructor(){super(),this.state="closed",this.target=null,this.elements=[],this.elements.versionId=0,this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.elements.head=null,this.elements.foot=null,this.selection=null,this.windowKeydown=me.windowKeydown.bind(this),this.windowPointerdown=me.windowPointerdown.bind(this),this.windowResize=me.windowResize.bind(this),this.windowBlur=me.windowBlur.bind(this),this.listenDraggingScrollbarEvent(),this.on("scroll",this.resize)}read(){return this.selection?.dataValue}write(i){var a=this.elements,n=a.count;if(0!==n){let t=a[0];for(let e=0;e<n;e++)if(a[e].dataValue===i){t=a[e];break}this.select(t)}}select(e){e instanceof HTMLElement&&this.selection!==e&&(this.unselect(),(this.selection=e).addClass("selected"))}unselect(){this.selection&&(this.selection.removeClass("selected"),this.selection=null)}reselect(e){var t=this.elements,i=this.selection,i=t.indexOf(i)+e;0<=i&&i<t.count&&this.select(t[i])}open(e){this.close(),this.state="open",this.target=e,this.createItems(e.dataItems),this.windowResize(),document.body.appendChild(this),this.resize(),this.write(e.dataValue),this.scrollToSelection(),this.on("pointermove",this.pointermove),window.on("keydown",this.windowKeydown,{capture:!0}),window.on("pointerdown",this.windowPointerdown,{capture:!0}),window.on("resize",this.windowResize),window.on("blur",this.windowBlur)}close(){"closed"!==this.state&&(this.state="closed",this.target=null,this.clear(),document.body.removeChild(this),this.off("pointermove",this.pointermove),window.off("keydown",this.windowKeydown,{capture:!0}),window.off("pointerdown",this.windowPointerdown,{capture:!0}),window.off("resize",this.windowResize),window.off("blur",this.windowBlur))}resize(){return Se.resize(this)}updateHeadAndFoot(){return Se.updateHeadAndFoot(this)}updateOnResize(){}createItems(e){var t=this["elements"];t.start=-1,t.count=0;for(const a of e){var i=document.createElement("select-item");i.dataValue=a.value,i.textContent=a.name,t[t.count++]=i}this.clearElements(t.count)}pageUp(e){var t,i=Math.floor(this.clientHeight/20)-1;e&&(e=this.scrollTop+this.clientHeight,e=Math.floor(e/20)-1,t=this.getElementIndexOfSelection(1/0),t=Math.min(t,e)-i,t=Math.max(t,0),this.select(this.elements[t])),this.scrollBy(0,20*-i)}pageDown(e){var t,i,a=Math.floor(this.clientHeight/20)-1;e&&(e=this.elements.count,t=Math.floor(this.scrollTop/20),i=this.getElementIndexOfSelection(0),i=Math.max(i,t)+a,i=Math.min(i,e-1),this.select(this.elements[i])),this.scrollBy(0,20*a)}getElementIndexOfSelection(e){var t=this.selection;return t instanceof HTMLElement?this.elements.indexOf(t):e}scrollToSelection(){var e,t;this.hasScrollBar()&&(e=this.elements,t=this.selection,-1!==(e=e.indexOf(t)))&&(t=Math.clamp(this.scrollTop,20*e+20-this.innerHeight,20*e),this.scrollTop!==t)&&(this.scrollTop=t)}clearElements(e){return Se.clearElements(this,e)}clear(){return this.unselect(),this.textContent="",this.clearElements(0),this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.updateHeadAndFoot(),this}pointermove(e){e=e.target.seek("select-item");"SELECT-ITEM"!==e.tagName||e.hasClass("selected")||this.write(e.dataValue)}static windowKeydown(e){switch(e.preventDefault(),e.stopPropagation(),e.code){case"Escape":this.close();break;case"Enter":case"NumpadEnter":var t=this.read();void 0!==t&&this.target.input(t),this.close();break;case"ArrowUp":this.reselect(-1),this.scrollToSelection();break;case"ArrowDown":this.reselect(1),this.scrollToSelection();break;case"Home":t=this.elements;this.scroll(0,0),this.select(t[0]);break;case"End":var t=this.elements,i=t.count-1;this.scroll(0,this.scrollHeight),this.select(t[i]);break;case"PageUp":this.pageUp(!0);break;case"PageDown":this.pageDown(!0)}}static windowPointerdown(t){switch(t.button){case 0:{var i=this.target;let e=t.target;if(e instanceof me)return void t.preventDefault();if(e.seek("select-box")===i)t.stopImmediatePropagation();else if("SELECT-ITEM"===(e=e.seek("select-item")).tagName&&e.parentNode===this){if(t.preventDefault(),t.altKey)return;i.input(e.dataValue)}return this.close()}case 2:return this.close()}}static windowResize(e){var t=this.target.rect(),i=t.left,a=t.top,n=t.bottom,t=t.width,s=this.elements.count,r=window.innerHeight-n,o=r>=20*Math.min(s,10),r=o?Math.floor(r/20):Math.floor(a/20),s=Math.min(s,r,30),r=o?n:a-20*s;this.style.left=i+"px",this.style.top=r+"px",this.style.width=`calc(${t}px - var(--2dpx))`,this.style.height=20*s+"px",this.style.zIndex=O.frames.length+1}static windowBlur(e){this.close()}}customElements.define("select-list",me);const ge=new me;class fe extends HTMLElement{state;callback;dataItems;selection;popupTimer;closeTimer;parent;submenu;buttonPressed;minWidth;parentMenuItem;windowBlur;windowKeydown;windowPointerdown;windowPointerup;windowPointerover;windowPointerout;constructor(){super(),this.state="closed",this.callback=null,this.dataItems=null,this.selection=null,this.popupTimer=null,this.closeTimer=null,this.parent=null,this.submenu=null,this.buttonPressed=!1,this.minWidth=0,this.windowBlur=fe.windowBlur.bind(this),this.windowKeydown=fe.windowKeydown.bind(this),this.windowPointerdown=fe.windowPointerdown.bind(this),this.windowPointerup=fe.windowPointerup.bind(this),this.windowPointerover=fe.windowPointerover.bind(this),this.windowPointerout=fe.windowPointerout.bind(this)}popup(e,t){this.close(),this.state="open",this.dataItems=t,this.callback=e.close??null,this.parent=e.parent??null,this.minWidth=e.minWidth??180;for(let e=0;e<t.length;e++)this.appendChild(this.createItem(t[e]));document.body.appendChild(this),this.computeMenuWidth();var{width:i,height:a}=this.rect(),n=1/window.devicePixelRatio,i=window.innerWidth-i-n,a=window.innerHeight-a-n,s=e.x??0,e=e.y??0;this.style.left=Math.min(s+n,i)+"px",this.style.top=Math.min(e+n,a)+"px",this.style.zIndex=O.frames.length+1,window.event?.stopPropagation(),window.on("blur",this.windowBlur),window.on("pointerdown",this.windowPointerdown),window.on("pointerup",this.windowPointerup),window.on("pointerover",this.windowPointerover),window.on("pointerout",this.windowPointerout),window.on("keydown",this.windowKeydown,{capture:!0}),this.on("pointerenter",this.pointerenter)}computeMenuWidth(){let e=0,t=0;for(const r of this.childNodes){var{label:i,accelerator:a}=r;void 0!==i&&(e=Math.max(e,i.offsetWidth)),void 0!==a&&(t=Math.max(t,a.offsetWidth))}let n=48;0<e&&0<t&&(n+=10);var s=e+t+n;this.style.width=Math.max(s,this.minWidth)+"px"}close(){"open"===this.state&&(this.state="closed",this.unselect(),this.callback?.(),this.callback=null,this.submenu?.close(),this.dataItems=null,this.parent=null,this.buttonPressed=!1,document.body.removeChild(this.clear()),window.off("blur",this.windowBlur),window.off("pointerdown",this.windowPointerdown),window.off("pointerup",this.windowPointerup),window.off("pointerover",this.windowPointerover),window.off("pointerout",this.windowPointerout),window.off("keydown",this.windowKeydown,{capture:!0}),this.off("pointerenter",this.pointerenter))}createItem(e){var t,i;return"separator"===e.type?document.createElement("menu-separator"):(!1===((t=document.createElement("menu-item")).dataValue=e).enabled&&t.addClass("disabled"),!0===e.checked&&((i=document.createElement("menu-checked")).textContent="✓",t.appendChild(i)),void 0!==e.icon&&t.appendChild(e.icon),void 0!==e.label&&((i=document.createElement("menu-label")).textContent=e.label,t.label=i,t.appendChild(i)),void 0!==e.accelerator&&((i=document.createElement("menu-accelerator")).textContent=e.accelerator,t.accelerator=i,t.appendChild(i)),void 0!==e.style&&t.addClass(e.style),void 0!==e.submenu&&((i=document.createElement("menu-sub-mark")).textContent=">",t.appendChild(i)),t)}select(e){this.selection!==e&&(this.unselect(),this.selection=e,this.selection.addClass("selected"))}unselect(){this.selection&&(this.selection.removeClass("selected"),this.selection=null,this.popupTimer)&&(this.popupTimer.remove(),this.popupTimer=null)}reselect(e){var t=[];for(const n of this.childNodes)"MENU-ITEM"!==n.tagName||n.hasClass("disabled")||t.push(n);var i=t.length;if(0!==i)if(this.selection){var a=t.indexOf(this.selection);this.select(t[(a+e+i)%i])}else switch(e){case 1:this.select(t[0]);break;case-1:this.select(t[i-1])}}popupSubmenu(e){const n=this.selection;if(n instanceof HTMLElement&&n!==this.submenu?.parentMenuItem){const s=n.dataValue;s.submenu&&(this.popupTimer||(this.popupTimer=new f({duration:e,callback:()=>{if(this.popupTimer=null,n===this.selection){var t=n.rect();let e=t.right;var i=t.top-5,a=t.width+2;e+a>window.innerWidth&&(e=t.left-a),this.submenu?.close(),this.submenu=new fe,this.submenu.parentMenuItem=n,this.submenu.popup({x:e,y:i,parent:this,close:()=>{this.submenu=null}},s.submenu)}}}).add()),0===e)&&this.popupTimer.finish()}}closeSubmenu(e){const{submenu:t,selection:i}=this;t?.parentMenuItem!==i||this.closeTimer||(this.closeTimer=new f({duration:e,callback:()=>{this.closeTimer=null,t===this.submenu&&i!==this.selection&&t.close()}}).add())}pointerenter(e){this.parent?.select(this.parentMenuItem)}static windowBlur(e){this.close()}static windowKeydown(e){if(!this.submenu)switch(e.preventDefault(),e.stopPropagation(),e.code){case"Escape":this.close();break;case"Enter":case"NumpadEnter":if(this.selection){var t=this.selection.dataValue;if(t.submenu)this.popupSubmenu(0),this.submenu&&this.submenu.reselect(1);else{t.click&&t.click();let e=this;for(;e.parent;)e=e.parent;e.close()}}break;case"ArrowUp":this.reselect(-1);break;case"ArrowDown":this.reselect(1);break;case"ArrowLeft":this.parent&&this.close();break;case"ArrowRight":this.popupSubmenu(0),this.submenu&&this.submenu.reselect(1)}}static windowPointerdown(e){var t=e.target.seek("menu-list");switch((t instanceof fe||(document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement)&&document.activeElement!==e.target&&!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement))&&e.preventDefault(),e.button){case 0:"MENU-LIST"!==t.tagName?this.close():t===this&&(this.buttonPressed=!0);break;case 2:"MENU-LIST"!==t.tagName&&this.close()}}static windowPointerup(e){if(0===e.button){var t=e.target;switch(t.tagName){case"MENU-ITEM":if(this.buttonPressed&&(this.buttonPressed=!1,!t.hasClass("disabled"))){var i=t.dataValue;if(i.submenu)this.popupSubmenu(0);else if(i.click){let e=this;for(;e.parent;)e=e.parent;i.click(),e.close()}}break;case"MENU-LIST":break;default:this.close()}}}static windowPointerover(e){e=e.target;e===this.selection||e.parentNode!==this||"MENU-ITEM"!==e.tagName||e.hasClass("disabled")||(this.closeTimer&&this.submenu?.parentMenuItem===e&&(this.closeTimer.remove(),this.closeTimer=null),this.closeSubmenu(400),this.select(e),this.popupSubmenu(400))}static windowPointerout(e){e=e.target;this.selection===e&&(null!==this.submenu&&this.closeSubmenu(400),this.unselect())}}customElements.define("menu-list",fe);const ve=new fe;class be extends HTMLElement{info;dataValue;writeEventEnabled;inputEventEnabled;constructor(){super();var e=document.createElement("text");e.addClass("custom-box-text"),this.appendChild(e),this.tabIndex=0,this.info=e,this.dataValue=null,this.writeEventEnabled=!1,this.inputEventEnabled=!1,this.on("keydown",this.keydown),this.on("click",this.click)}get type(){return this.getAttribute("type")}set type(e){this.setAttribute("type",e)}get filter(){return this.getAttribute("filter")}set filter(e){this.setAttribute("filter",e)}read(){return this.dataValue}write(e){this.dataValue=e,this.update(),this.writeEventEnabled&&((e=new Event("write")).value=this.dataValue,this.dispatchEvent(e))}input(e){this.dataValue!==e?(this.write(e),this.inputEventEnabled&&((e=new Event("input")).value=this.dataValue,this.dispatchEvent(e)),this.dispatchChangeEvent()):"file"===this.type&&this.update()}update(){this.info.removeClass("invalid");var e=this.dataValue;switch(this.type){case"file":return this.updateFile(e);case"clip":return this.updateClip(e);case"variable":return this.updateVariable(e);case"global-variable":return this.updateGlobalVariable(e);case"actor":return this.updateActor(e);case"skill":return this.updateSkill(e);case"state":return this.updateState(e);case"equipment":return this.updateEquipment(e);case"item":return this.updateItem(e);case"position":return this.updatePosition(e);case"angle":return this.updateAngle(e);case"trigger":return this.updateTrigger(e);case"light":return this.updateLight(e);case"element":case"ancestor-element":return this.updateElement(e);case"preset-object":return this.updatePresetObject(e);case"preset-element":return this.updatePresetElement(e);case"array":return this.updateArray(e);case"attribute":return this.updateAttribute(e);case"attribute-group":return this.updateAttributeGroup(e);case"enum-group":return this.updateEnumGroup(e);case"enum-string":return this.updateEnumString(e)}}updateFile(e){I.invalid=!1,this.info.textContent=I.parseFileName(e),I.invalid&&this.info.addClass("invalid")}updateClip(e){this.info.textContent=e.join(", ")}updateVariable(e){this.info.textContent=e.key?I.parseVariable(e):N.get("common.none")}updateGlobalVariable(e){this.info.textContent=I.parseGlobalVariable(e)}updateActor(e){this.info.textContent=I.parseActor(e)}updateSkill(e){this.info.textContent=I.parseSkill(e)}updateState(e){this.info.textContent=I.parseState(e)}updateEquipment(e){this.info.textContent=I.parseEquipment(e)}updateItem(e){this.info.textContent=I.parseItem(e)}updatePosition(e){this.info.textContent=I.parsePosition(e)}updateAngle(e){this.info.textContent=I.parseAngle(e)}updateTrigger(e){this.info.textContent=I.parseTrigger(e)}updateLight(e){this.info.textContent=I.parseLight(e)}updateElement(e){this.info.textContent=I.parseElement(e)}updatePresetObject(e){this.info.textContent=I.parsePresetObject(e)}updatePresetElement(e){this.info.textContent=I.parsePresetElement(e)}updateArray(e){this.info.textContent=0!==e.length?I.parseMultiLineString(e.join(", ")):N.get("common.empty")}updateAttributeGroup(e){var t;""===e?this.info.textContent=N.get("common.none"):(t=v.getGroup(e))?this.info.textContent=t.groupName:(this.info.textContent=I.parseUnlinkedId(e),this.info.addClass("invalid"))}updateAttribute(e){var t;""===e?this.info.textContent=N.get("common.none"):(t=v.getAttribute(e))?this.info.textContent=t.name:(this.info.textContent=I.parseUnlinkedId(e),this.info.addClass("invalid"))}updateEnumGroup(e){var t;""===e?this.info.textContent=N.get("common.none"):(t=M.getEnumGroup(e))?this.info.textContent=t.groupName:(this.info.textContent=I.parseUnlinkedId(e),this.info.addClass("invalid"))}updateEnumString(e){var t;""===e?this.info.textContent=N.get("common.none"):(t=M.getString(e))?this.info.textContent=t.name:(this.info.textContent=I.parseUnlinkedId(e),this.info.addClass("invalid"))}enable(){this.removeClass("disabled")&&(this.tabIndex+=1,this.showChildNodes())}disable(){this.addClass("disabled")&&(--this.tabIndex,this.hideChildNodes())}on(e,t,i){switch(super.on(e,t,i),e){case"write":this.writeEventEnabled=!0;break;case"input":this.inputEventEnabled=!0}}keydown(e){switch(e.code){case"Enter":case"NumpadEnter":e.cmdOrCtrlKey||(e.stopPropagation(),this.click(e))}}click(e){switch(this.type){case"file":return zt.open(this);case"clip":return ot.open(this);case"variable":return C.open(this);case"global-variable":return d.open(this);case"actor":return $t.open(this);case"skill":return Zt.open(this);case"state":return Jt.open(this);case"equipment":return Qt.open(this);case"item":return ei.open(this);case"position":return ti.open(this);case"angle":return ii.open(this);case"trigger":return ai.open(this);case"light":return ni.open(this);case"element":return si.open(this);case"ancestor-element":return ri.open(this);case"preset-object":return bt.open(this);case"preset-element":return yt.open(this);case"array":return wt.open(this);case"attribute":return v.open(this,"attribute");case"attribute-group":return v.open(this,"group");case"enum-group":return M.open(this,"group");case"enum-string":return M.open(this,"string")}}}customElements.define("custom-box",be);class ye extends HTMLElement{mode;numBox;varBox;constructor(){super(),this.mode=null,this.numBox=new ue(this),this.varBox=new be,this.varBox.type="variable",this.varBox.filter="number",this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown)}read(){switch(this.mode){case"constant":return this.numBox.read();case"variable":return this.varBox.read()}}write(e){switch(typeof e){case"number":this.switch("constant"),this.numBox.write(e),this.varBox.write(ye.defVar);break;case"object":this.switch("variable"),this.numBox.write(0),this.varBox.write(e)}}switch(e){var t=!e&&!this.hasClass("disabled");if(void 0===e)switch(this.mode){case"constant":e="variable";break;case"variable":e="constant"}if(this.mode!==e)switch(this.removeClass(this.mode),this.addClass(e),this.mode=e){case"constant":this.varBox.remove(),this.appendChild(this.numBox),t&&(this.numBox.input.focus(),this.numBox.input.select());break;case"variable":this.numBox.remove(),this.appendChild(this.varBox),t&&this.varBox.focus()}}enable(){this.removeClass("disabled")&&(this.numBox.enable(),this.varBox.enable())}disable(){this.addClass("disabled")&&(this.numBox.disable(),this.varBox.disable())}getFocus(e){switch(this.mode){case"constant":return this.numBox.getFocus(e);case"variable":return this.varBox.getFocus(e)}}keydown(e){"Slash"===e.code&&(e.preventDefault(),this.switch())}pointerdown(e){switch(e.button){case 0:this.hasClass("disabled")||e.target!==this||(e.preventDefault(),this.switch());break;case 2:this.hasClass("disabled")||(e.preventDefault(),this.switch())}}static defVar={type:"local",key:"key"}}customElements.define("number-var",ye);class we extends HTMLElement{mode;strBox;varBox;constructor(){super(),this.mode=null,this.strBox=new $,this.varBox=new be,this.varBox.type="variable",this.varBox.filter="string",this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown)}read(){switch(this.mode){case"constant":return this.strBox.read();case"variable":return this.varBox.read()}}write(e){switch(typeof e){case"string":this.switch("constant"),this.strBox.write(e),this.varBox.write(we.defVar);break;case"object":this.switch("variable"),this.strBox.write(""),this.varBox.write(e)}}switch(e){var t=!e&&!this.hasClass("disabled");if(void 0===e)switch(this.mode){case"constant":e="variable";break;case"variable":e="constant"}if(this.mode!==e)switch(this.removeClass(this.mode),this.addClass(e),this.mode=e){case"constant":this.varBox.remove(),this.appendChild(this.strBox),t&&(this.strBox.input.focus(),this.strBox.input.select());break;case"variable":this.strBox.remove(),this.appendChild(this.varBox),t&&this.varBox.focus()}}enable(){this.removeClass("disabled")&&(this.strBox.enable(),this.varBox.enable())}disable(){this.addClass("disabled")&&(this.strBox.disable(),this.varBox.disable())}getFocus(e){switch(this.mode){case"constant":return this.strBox.getFocus(e);case"variable":return this.varBox.getFocus(e)}}keydown(e){"Slash"===e.code&&(e.preventDefault(),this.switch())}pointerdown(e){switch(e.button){case 0:this.hasClass("disabled")||e.target!==this||(e.preventDefault(),this.switch());break;case 2:this.hasClass("disabled")||(e.preventDefault(),this.switch())}}static defVar={type:"local",key:"key"}}customElements.define("string-var",we);class xe extends HTMLElement{mode;selectBox;varBox;constructor(){super(),this.mode=null,this.selectBox=new pe,this.varBox=new be,this.varBox.type="variable",this.varBox.filter="all",this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown)}read(){switch(this.mode){case"constant":return this.selectBox.read();case"variable":return this.varBox.read()}}write(e){switch(typeof e){case"string":this.switch("constant"),this.selectBox.write(e),this.varBox.write(xe.defVar);break;case"object":this.switch("variable"),this.selectBox.writeDefault(),this.varBox.write(e)}}switch(e){var t=!e&&!this.hasClass("disabled");if(void 0===e)switch(this.mode){case"constant":e="variable";break;case"variable":e="constant"}if(this.mode!==e)switch(this.removeClass(this.mode),this.addClass(e),this.mode=e){case"constant":this.varBox.remove(),this.appendChild(this.selectBox),t&&this.selectBox.focus();break;case"variable":this.selectBox.remove(),this.appendChild(this.varBox),t&&this.varBox.focus()}}enable(){this.removeClass("disabled")&&(this.selectBox.enable(),this.varBox.enable())}disable(){this.addClass("disabled")&&(this.selectBox.disable(),this.varBox.disable())}loadItems(e){this.selectBox.loadItems(e)}getFocus(e){switch(this.mode){case"constant":return this.selectBox.getFocus(e);case"variable":return this.varBox.getFocus(e)}}keydown(e){"Slash"===e.code&&(e.preventDefault(),this.switch())}pointerdown(e){switch(e.button){case 0:this.hasClass("disabled")||e.target!==this||(e.preventDefault(),this.switch());break;case 2:this.hasClass("disabled")||(e.preventDefault(),this.switch())}}static defVar={type:"local",key:"key"}}customElements.define("select-var",xe);class ke extends HTMLElement{mode;strBox;varBox;constructor(){super(),this.mode=null,this.fileBox=new be,this.varBox=new be,this.fileBox.type="file",this.fileBox.filter=this.getAttribute("filter"),this.varBox.type="variable",this.varBox.filter="string",this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown)}read(){switch(this.mode){case"constant":return this.fileBox.read();case"variable":return this.varBox.read()}}write(e){switch(typeof e){case"string":this.switch("constant"),this.fileBox.write(e),this.varBox.write(ke.defVar);break;case"object":this.switch("variable"),this.fileBox.write(""),this.varBox.write(e)}}switch(e){var t=!e&&!this.hasClass("disabled");if(void 0===e)switch(this.mode){case"constant":e="variable";break;case"variable":e="constant"}if(this.mode!==e)switch(this.removeClass(this.mode),this.addClass(e),this.mode=e){case"constant":this.varBox.remove(),this.appendChild(this.fileBox),t&&this.fileBox.focus();break;case"variable":this.fileBox.remove(),this.appendChild(this.varBox),t&&this.varBox.focus()}}enable(){this.removeClass("disabled")&&(this.fileBox.enable(),this.varBox.enable())}disable(){this.addClass("disabled")&&(this.fileBox.disable(),this.varBox.disable())}getFocus(e){switch(this.mode){case"constant":return this.fileBox.getFocus(e);case"variable":return this.varBox.getFocus(e)}}keydown(e){"Slash"===e.code&&(e.preventDefault(),this.switch())}pointerdown(e){switch(e.button){case 0:this.hasClass("disabled")||e.target!==this||(e.preventDefault(),this.switch());break;case 2:this.hasClass("disabled")||(e.preventDefault(),this.switch())}}static defVar={type:"local",key:"key"}}customElements.define("file-var",ke);class Te extends HTMLElement{canvas;dataValue;constructor(){super(),this.canvas=null,this.dataValue=null}read(){return this.dataValue}write(e){this.dataValue=e,this.update()}update(){let e=this["canvas"];e||((e=document.createElement("canvas")).width=this.getAttribute("width"),e.height=this.getAttribute("height"),e.context=e.getContext("2d"),this.appendChild(this.canvas=e));var{context:t,width:i,height:a}=e,[n,s,r,o]=this.dataValue,l=(t.gradient||((l=t.createLinearGradient(0,0,0,a)).addColorStop(0,"#ff0000"),l.addColorStop(1/6,"#ffff00"),l.addColorStop(2/6,"#00ff00"),l.addColorStop(.5,"#00ffff"),l.addColorStop(4/6,"#0000ff"),l.addColorStop(5/6,"#ff00ff"),l.addColorStop(1,"#ff0000"),t.gradient=l),t.globalCompositeOperation="source-over",t.fillStyle=t.gradient,t.fillRect(0,0,i,a),t.createLinearGradient(0,0,i>>1,0)),l=(l.addColorStop(0,"rgba(0, 0, 0, 1)"),l.addColorStop(1,"rgba(0, 0, 0, 0)"),t.fillStyle=l,t.fillRect(0,0,i>>1,a),t.createLinearGradient(i>>1,0,i,0)),l=(l.addColorStop(0,"rgba(255, 255, 255, 0)"),l.addColorStop(1,"rgba(255, 255, 255, 1)"),t.fillStyle=l,t.fillRect(i>>1,0,i-(i>>1),a),o&&(t.globalCompositeOperation="saturation",t.globalAlpha=o/255,t.fillStyle="#ffffff",t.fillRect(0,0,i,a),t.globalAlpha=1),Math.max(n,0)),o=Math.max(s,0),c=Math.max(r,0),l=((l||o||c)&&(t.globalCompositeOperation="lighter",t.fillStyle=`rgba(${l}, ${o}, ${c}, 1)`,t.fillRect(0,0,i,a)),Math.max(-n,0)),o=Math.max(-s,0),c=Math.max(-r,0);(l||o||c)&&(t.globalCompositeOperation="difference",t.fillStyle="#ffffff",t.fillRect(0,0,i,a),t.globalCompositeOperation="lighter",t.fillStyle=`rgba(${l}, ${o}, ${c}, 1)`,t.fillRect(0,0,i,a),t.globalCompositeOperation="difference",t.fillStyle="#ffffff",t.fillRect(0,0,i,a))}clear(){this.canvas&&(this.removeChild(this.canvas),this.canvas=null)}}customElements.define("filter-box",Te);class Ie extends HTMLElement{data;dragging;selectionIndex;writeEventEnabled;selectEventEnabled;closedEventEnabled;popupEventEnabled;windowPointerup;constructor(){super(),this.data=null,this.dragging=null,this.selectionIndex=0,this.writeEventEnabled=!1,this.selectEventEnabled=!1,this.closedEventEnabled=!1,this.popupEventEnabled=!1,this.windowPointerup=Ie.windowPointerup.bind(this),this.on("pointerdown",this.pointerdown),this.on("dragstart",this.dragstart),this.on("dragend",this.dragend)}read(){var e=this.querySelector(".selected");return e?e.item:void 0}write(i){var e,a=this.childNodes,n=a.length;if(0!==n){this.unselect();let t;for(let e=0;e<n;e++)if(a[e].item===i){this.selectionIndex=e,t=a[e];break}void 0!==t&&t.addClass("selected"),this.writeEventEnabled&&((e=new Event("write")).value=t?i:void 0,this.dispatchEvent(e))}}update(){super.clear();for(const i of this.data){let e=i.tab;var t;void 0===e&&(e=i.tab=document.createElement("tab-item"),(t=document.createElement("tab-text")).textContent=this.parseTabName(i),e.draggable=!0,e.item=i,e.text=t,e.appendChild(t),"directory"!==i.type)&&((t=document.createElement("tab-close")).textContent="✖",e.appendChild(t)),this.appendChild(e)}}parseTabName(e){return e.icon+" "+e.name}select(e){var t;this.read()!==e&&(this.write(e),this.selectEventEnabled)&&((t=new Event("select")).value=e,this.dispatchEvent(t))}unselect(){var e=this.querySelector(".selected");e&&e.removeClass("selected")}insert(e){this.data.includes(e)||(this.data.splice(this.selectionIndex+1,0,e),this.update())}close(e){var t,i;e!==this.dirItem&&(t=this.read(),this.data.remove(e))&&(this.update(),this.closedEventEnabled)&&((i=new Event("closed")).closedItems=[e],i.lastValue=t,this.dispatchEvent(i))}closeByProperty(e,t){for(const i of this.data)if(i[e]===t)return void this.close(i)}closeOtherTabs(e){var t=this.read(),i=this.data;let a=i.length;if(!(a<=1)){for(var n,s=[];0<=--a;){var r=i[a];r!==e&&r!==this.dirItem&&(i.splice(a,1),s.push(r))}0!==s.length&&(this.update(),this.closedEventEnabled)&&((n=new Event("closed")).closedItems=s,n.lastValue=t,this.dispatchEvent(n))}}closeTabsToTheRight(t){var i=this.read(),a=this.data,n=a.indexOf(t);if(-1!==n){var s=[];let e=a.length;for(;--e>n;){var r=a[e];r!==this.dirItem&&(a.splice(e,1),s.push(r))}0!==s.length&&(this.update(),this.closedEventEnabled)&&((t=new Event("closed")).closedItems=s,t.lastValue=i,this.dispatchEvent(t))}}find(e){for(var{item:t}of this.childNodes)if(t.meta===e)return t}on(e,t,i){switch(super.on(e,t,i),e){case"write":this.writeEventEnabled=!0;break;case"select":this.selectEventEnabled=!0;break;case"closed":this.closedEventEnabled=!0;break;case"popup":this.popupEventEnabled=!0}}pointerdown(e){switch(this.dragend(),e.button){case 0:var t=e.target;if("TAB-CLOSE"===t.tagName)return e.preventDefault(),(this.dragging=e).mode="close",void window.on("pointerup",this.windowPointerup);"TAB-ITEM"!==t.tagName||t.hasClass("selected")||this.select(t.item);break;case 2:if(this.popupEventEnabled)switch(e.target.tagName){case"TAB-ITEM":case"TAB-BAR":(this.dragging=e).mode="popup",window.on("pointerup",this.windowPointerup)}}}dragstart(e){this.dragging||(this.dragging=e,Object.defineProperty(e,"offsetX",{writable:!0}),e.preventDefault=Function.empty,e.dataTransfer.hideDragImage(),e.hint=document.createElement("drag-and-drop-hint"),e.hint.addClass("for-tab"),this.parentNode.insertBefore(e.hint.hide(),this),this.addClass("dragging"),b.updateAppRegion(),this.on("dragenter",this.dragenter),this.on("dragleave",this.dragleave),this.on("dragover",this.dragover),this.on("drop",this.drop))}dragend(e){this.dragging&&(this.removeClass("dragging"),this.parentNode.removeChild(this.dragging.hint),this.dragging=null,this.off("dragenter",this.dragenter),this.off("dragleave",this.dragleave),this.off("dragover",this.dragover),this.off("drop",this.drop))}dragenter(e){this.dragging&&(e.preventDefault(),e.dataTransfer.dropEffect="move")}dragleave(e){this.dragging&&!this.contains(e.relatedTarget)&&(this.dragging.offsetX=-1,this.dragging.hint.hide())}dragover(e){var t=this["dragging"];if(t&&(e.preventDefault(),e.dataTransfer.dropEffect="move",t.offsetX!==e.offsetX)){t.offsetX=e.offsetX;var i=e.target.seek("tab-item"),a=t.hint.show();if("TAB-ITEM"===i.tagName){if(t.target.item===i.item)return a.hide();var n=i.rect(),s=n.width/2,r=e.clientX-n.left<s?"before":"after";switch(r){case"before":if(a.target!==i||a.position!==r){if(i.previousSibling===t.target)return a.hide();var o=a.measure(i);--o.left,o.width=2,a.target=i,a.position=r,a.set(o)}break;case"after":if(a.target!==i||a.position!==r){if(i.nextSibling===t.target)return a.hide();o=a.measure(i);o.left+=o.width-1,o.width=2,a.target=i,a.position=r,a.set(o)}}}else{e=this.childNodes,n=e[e.length-1];if(n===t.target)return a.hide();void 0===n||a.target===n&&"after"===a.position||((s=a.measure(n)).left+=s.width-1,s.width=2,a.target=n,a.position="after",a.set(s))}}}drop(t){var i=this["dragging"];if(i){t.stopPropagation();t=i.hint;if(!t.hasClass("hidden")){var a=this.data,i=i.target.item,n=t.target.item;if(a.remove(i)){let e=a.indexOf(n);"after"===t.position&&e++,a.splice(e,0,i),this.selectionIndex=e,this.update()}}this.dragend()}}static windowPointerup(e){var t,i,a=this["dragging"];if(a.relate(e)){switch(a.mode){case"close":a.target===e.target&&this.close(e.target.parentNode.item);break;case"popup":a.target===e.target&&(t=new Event("popup"),i=e.target.item,t.value=i??null,t.clientX=e.clientX,t.clientY=e.clientY,this.dispatchEvent(t))}this.dragging=null,window.off("pointerup",this.windowPointerup)}}}customElements.define("tab-bar",Ie);class Ce extends HTMLElement{writeEventEnabled;selectEventEnabled;constructor(){super();var t=this.childNodes;if(0<t.length){let e=t.length;for(;0<=--e;){var i,a,n=t[e];"NAV-ITEM"===n.tagName?(i=n.getAttribute("value"),a=RegExp.number.test(i),n.dataValue=a?parseFloat(i):i):this.removeChild(n)}}this.writeEventEnabled=!1,this.selectEventEnabled=!1,this.on("pointerdown",this.pointerdown)}read(){var e=this.querySelector(".selected");return e?e.dataValue:void 0}write(i){var e,a=this.childNodes,n=a.length;if(0!==n){this.unselect();let t;for(let e=0;e<n;e++)if(a[e].dataValue===i){t=a[e];break}void 0!==t&&t.addClass("selected"),this.writeEventEnabled&&((e=new Event("write")).value=t?i:void 0,this.dispatchEvent(e))}}unselect(){var e=this.querySelector(".selected");e&&e.removeClass("selected")}on(e,t,i){switch(super.on(e,t,i),e){case"write":this.writeEventEnabled=!0;break;case"select":this.selectEventEnabled=!0}}pointerdown(e){var t;0!==e.button||"NAV-ITEM"!==(e=e.target).tagName||e.hasClass("selected")||(this.write(e.dataValue),this.selectEventEnabled&&((t=new Event("select")).value=e.dataValue,this.dispatchEvent(t)))}}customElements.define("nav-bar",Ce);class Ee extends HTMLElement{display;keyword;searchResults;creators;updaters;elements;root;timer;selections;dragging;padded;removable;renamable;lockDirectory;multipleSelect;selectEventEnabled;unselectEventEnabled;recordEventEnabled;popupEventEnabled;openEventEnabled;updateEventEnabled;constructor(){super();var e=new f({duration:500,callback:e=>{var t,i=this.read();i instanceof Object&&(t=e.target,i.element.contains(t))&&this.rename(i),e.target=null,e.running=!1}}),t=Object.defineProperty({},"children",{get:()=>this.data});this.tabIndex=0,this.display="normal",this.keyword=null,this.searchResults=[],this.creators=[],this.updaters=[],this.elements=[],this.elements.versionId=0,this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.elements.head=null,this.elements.foot=null,this.root=t,this.timer=e,this.selections=[],this.dragging=null,this.padded=this.hasAttribute("padded"),this.removable=!1,this.renamable=!1,this.lockDirectory=!1,this.multipleSelect=!1,this.selectEventEnabled=!1,this.recordEventEnabled=!1,this.popupEventEnabled=!1,this.openEventEnabled=!1,this.updateEventEnabled=!1,this.listenDraggingScrollbarEvent(),this.on("scroll",this.resize),this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown),this.on("pointerup",this.pointerup),this.on("doubleclick",this.doubleclick),this.on("dragstart",this.dragstart),this.on("dragend",this.dragend),this.on("change",this.dataChange)}bind(e){return Object.defineProperty(this,"data",{get:e})}read(){var e=this["selections"];return 1===e.length?e[0]:null}initialize(){var e=this["data"];e.initialized||(Ee.createParents(this.data,this.root),Object.defineProperty(e,"initialized",{configurable:!0,value:!0}))}update(){var e=this["elements"];switch(e.start=-1,e.count=0,this.initialize(),this.display){case"normal":this.data&&this.createIndentedItems(this.data,this.root,0);break;case"search":0!==this.searchResults.length&&this.createFlatItems(this.searchResults)}this.clearElements(e.count),this.updateEventEnabled&&this.dispatchUpdateEvent(),this.resize()}refresh(){this.deleteNodeElements(this.data),this.update()}resize(){return Se.resize(this)}updateHeadAndFoot(){return Se.updateHeadAndFoot(this)}updateOnResize(e){e.changed&&(e.changed=!1,this.updateNodeElement(e))}createFlatItems(t){var i=this.elements,a=t.length;for(let e=0;e<a;e++){var n=t[e];i[i.count++]=this.createNodeElement(n,0)}}createIndentedItems(t,i,a){var n=this.elements,s=t.length;for(let e=0;e<s;e++){var r=t[e];if(n[n.count++]=this.createNodeElement(r,a),void 0===r.parent)throw new Error("No parent!");r.parent=i,r.expanded&&0!==r.children.length&&this.createIndentedItems(r.children,r,a+1)}}searchNodes(e){var t=this["data"];t&&(e instanceof RegExp||0!==e.length?("normal"===this.display&&(this.display="search"),"string"==typeof e&&(e=e.replace(/[(){}\\^$*+?.|[\]]/g,"\\$&"),e=new RegExp(e,"i")),this.searchNodesAlgorithm(t,this.keyword=e,this.searchResults=[])):"search"===this.display&&(this.display="normal",this.keyword=null,this.searchResults=[]),this.update())}searchNodesAlgorithm(t,i,a){var n=t.length;for(let e=0;e<n;e++){var s=t[e],s=(i.test(s.name)&&a.push(s),s.children);s instanceof Array&&this.searchNodesAlgorithm(s,i,a)}}createNodeElement(e,t){let i=e.element;return void 0===i&&((i=document.createElement("node-item")).item=e,Object.defineProperty(e,"element",{configurable:!0,value:i}),this.selections.includes(e))&&i.addClass("selected"),i.indent=t,i.changed=!0,i}updateNodeElement(a){var n=a["item"];if(!a.textNode){let e=null,t=!1,i=16;n.children instanceof Array&&(e=document.createElement("folder-mark"),t=!0,i=0,a.appendChild(e));var s=this.createIcon(n),r=(a.appendChild(s),this.createText(n));a.appendChild(r),a.draggable=!0,a.expanded=!1,a.markVisible=t,a.markIndent=i,a.textIndent=0,a.folderMark=e,a.nodeIcon=s,a.textNode=r;for(const o of this.creators)o(n)}if(void 0!==n.expanded){s=0!==n.children.length,r=(a.markVisible!==s&&(a.markVisible=s,a.folderMark.style.visibility=s?"inherit":"hidden"),s&&n.expanded);if("folder"===n.class){if(a.expanded!==r)switch(a.expanded=r){case!0:a.folderMark.addClass("expanded"),a.nodeIcon.addClass("expanded");break;case!1:a.folderMark.removeClass("expanded"),a.nodeIcon.removeClass("expanded")}}else if(a.expanded!==r)switch(a.expanded=r){case!0:a.folderMark.addClass("expanded");break;case!1:a.folderMark.removeClass("expanded")}}s=a.markIndent+12*a.indent;a.textIndent!==s&&(a.textIndent=s,a.style.textIndent=s+"px");for(const e of this.updaters)e(n)}deleteNodeElements(t){var i=t.length;for(let e=0;e<i;e++){var a=t[e],a=(void 0!==a.element&&delete a.element,a)["children"];0<a?.length&&this.deleteNodeElements(a)}}createIcon(e){var t=document.createElement("node-icon");return"folder"===e.class?t.addClass("icon-folder"):t.addClass("icon-file"),t}createText(e){return document.createTextNode(e.name)}updateItemName(e){var t,i;e?.element?.textNode&&(t=(i=e.element.textNode).nodeValue,i.nodeValue=e.name,"search"===this.display)&&((i=this.keyword).test(t)||i.test(e.name))&&this.searchNodes(this.keyword)}getItemByProperties(e){const o=Object.entries(e),l=i=>{var e=i.length;for(let t=0;t<e;t++){var a,n,s=i[t];let e=!0;for([a,n]of o)if(s[a]!==n){e=!1;break}if(e)return s;if(s.children){var r=l(s.children);if(void 0!==r)return r}}};return l(this.data)}contain(e,t){for(;t instanceof Object;){if(t===e)return!0;t=t.parent}return!1}addNodeTo(a,n){if(a){let t,i;var s=this["data"];if((n=n||s)===s?(t=s,i=t.length):n.children?(t=n.children,i=t.length):(t=n.parent.children)instanceof Array&&(i=t.indexOf(n)),t){t.splice(i,0,a),this.unselect(),void 0===a.parent&&Ee.createParents([a],null);let e=n;for(;void 0!==e.parent;)!1===e.expanded&&(e.expanded=!0),e=e.parent;this.recordEventEnabled&&((s=new Event("record")).value={type:"create",sItem:a,dItem:n},this.dispatchEvent(s)),a.parent||this.onCreate?.(a),this.update(),this.select(a),this.scrollToSelection(),this.dispatchChangeEvent()}}}deleteNode(e){var t,i,a=e.parent.children;a instanceof Array&&(t=a.indexOf(e),a.splice(t,1),this.recordEventEnabled&&((i=new Event("record")).value={type:"delete",items:a,index:t,item:e},this.dispatchEvent(i)),this.unselectIn(e),this.onDelete?.(e),this.update(),this.dispatchChangeEvent())}removeItemTo(e,t){var i,a,n,s,r;e===t||this.lockDirectory&&t===this.root||(i=e.parent)&&t&&(r=i.children,a=t.children,n=r.indexOf(e),r.splice(n,1),s=a.length,a.splice(s,0,e),r===a&&n===s||(!1===t.expanded&&(t.expanded=!0),this.recordEventEnabled&&((r=new Event("record")).value={type:"remove",item:e,source:{parent:i,index:n},destination:{parent:t,index:s}},this.dispatchEvent(r)),this.insertPaddingAndClear(),this.update(),this.onRemove?.(e),this.scrollToSelection(),this.dispatchChangeEvent()))}removeItemToInsert(e,t){var i,a,n,s,r;e===t||this.lockDirectory&&t.parent===this.root||(i=e.parent,a=t.parent,i&&a&&(r=i.children,n=a.children,s=r.indexOf(e),r.splice(s,1),t=n.indexOf(t),n.splice(t,0,e),r===n&&s===t||(this.recordEventEnabled&&((r=new Event("record")).value={type:"remove",item:e,source:{parent:i,index:s},destination:{parent:a,index:t}},this.dispatchEvent(r)),this.insertPaddingAndClear(),this.update(),this.onRemove?.(e),this.scrollToSelection(),this.dispatchChangeEvent())))}restore(e,t){switch("search"===this.display&&(this.searchResults=Array.empty),t.type){case"rename":var{item:i,oldValue:a,newValue:n}=t;i.name="undo"===e?a:n,this.updateItemName(i),this.expandToItem(i),this.textContent||this.update(),this.select(i),this.scrollToSelection(),this.dispatchChangeEvent();break;case"create":var{sItem:a,dItem:n}=t;"undo"===e?(i=this.recordEventEnabled,this.recordEventEnabled=!1,this.deleteNode(a),this.recordEventEnabled=i):(i=this.recordEventEnabled,this.recordEventEnabled=!1,this.addNodeTo(a,n),this.recordEventEnabled=i,this.onResume?.(a));break;case"delete":var{items:n,index:i,item:a}=t;"undo"===e?i<=n.length&&(n.splice(i,0,a),this.unselect(),this.expandToItem(a,!1),this.onResume?.(a)):i<n.length&&(n.splice(i,1),this.unselectIn(a),this.onDelete?.(a)),this.update(),"undo"===e&&this.select(a),this.scrollToSelection(),this.dispatchChangeEvent();break;case"remove":var{item:n,source:i,destination:a}=t,{parent:i,index:s}=i,{parent:a,index:r}=a,o=i.children,l=a.children;"undo"===e?(void 0!==n.parent&&(n.parent=i),s<=o.length&&r<l.length&&(l.splice(r,1),o.splice(s,0,n),this.expandToItem(n,!1))):(void 0!==n.parent&&(n.parent=a),r<=l.length&&s<o.length&&(o.splice(s,1),l.splice(r,0,n),this.expandToItem(n,!1))),this.insertPaddingAndClear(),this.update(),this.select(n),this.onRemove?.(n),this.scrollToSelection(),this.dispatchChangeEvent()}}open(e){var t;e&&this.openEventEnabled&&((t=new Event("open")).value=e,this.dispatchEvent(t))}select(e){e instanceof Object&&this.read()!==e&&(this.unselect(),this.selections.push(e),void 0!==e.element&&e.element.addClass("selected"),this.selectEventEnabled)&&((e=new Event("select")).value=this.read(),this.dispatchEvent(e))}selectWithNoEvent(e){var t=this.selectEventEnabled;this.selectEventEnabled=!1,this.select(e),this.selectEventEnabled=t}unselect(e){let t=Array.empty;if(void 0===e&&(t=this.selections),0!==(t=this.selections.includes(e)?[e]:t).length){Ee.textBox.input.blur();for(const e of t){var i=e["element"];void 0!==i&&i.removeClass("selected")}this.unselectEventEnabled&&((e=new Event("unselect")).value=t,this.dispatchEvent(e)),this.selections=[]}}unselectIn(t){var i,a=[];for(i of this.selections){let e=i;for(;e;){if(e===t){a.push(i);break}e=e.parent}}for(const e of a)this.unselect(e)}selectRelative(t){var i=this.elements,a=i.count;if(0<a){let e=-1;var n=a-1,a=this.read();switch(a&&(e=i.indexOf(a.element)),t){case"up":e=-1!==e?Math.max(e-1,0):n;break;case"down":e=-1!==e?Math.min(e+1,n):0}this.select(i[e]?.item),this.scrollToSelection()}}expandSelection(){var e=this.read();null!==e&&void 0!==e.expanded&&void 0!==e.element&&(e.expanded=!e.expanded,this.update(),this.dispatchChangeEvent())}expandToSelection(e=!0){var t=this.read();null!==t&&this.expandToItem(t,e)}expandToItem(t,i=!0){if(t=t.parent){let e=!1;for(;void 0!==t.expanded;)t.expanded||(t.expanded=!0,e=!0),t=t.parent;e&&i&&(this.update(),this.dispatchChangeEvent())}}scrollToSelection(i="active"){var e=this.read();if(e&&this.hasScrollBar()){var a=this.elements,n=a.count;for(let t=0;t<n;t++){var s=a[t]["item"];if(s===e){let e;switch(i){case"active":e=Math.clamp(this.scrollTop,20*t+20-this.innerHeight,20*t);break;case"middle":e=20*Math.round((20*t+10-this.innerHeight/2)/20);break;default:return}this.scrollTop!==e&&(this.scrollTop=e);break}}}}scrollToHome(){var e=this.elements[0];e instanceof HTMLElement&&this.select(e.item),this.scroll(0,0)}scrollToEnd(){var e=this.elements,e=e[e.count-1];e instanceof HTMLElement&&this.select(e.item),this.scroll(0,this.scrollHeight)}pageUp(e){var t,i=Math.floor(this.clientHeight/20)-1;e&&(e=this.scrollTop+this.clientHeight,e=Math.floor(e/20)-1,t=this.getElementIndexOfSelection(1/0),t=Math.min(t,e)-i,t=Math.max(t,0),this.select(this.elements[t]?.item)),this.scrollBy(0,20*-i)}pageDown(e){var t,i,a=Math.floor(this.clientHeight/20)-1;e&&(e=this.elements.count,t=Math.floor(this.scrollTop/20),i=this.getElementIndexOfSelection(0),i=Math.max(i,t)+a,i=Math.min(i,e-1),this.select(this.elements[i]?.item)),this.scrollBy(0,20*a)}getElementIndexOfSelection(e){var t=this.read();return t?this.elements.indexOf(t.element):e}rename(e){if(this.renamable){var t=e["element"],i=Ee["textBox"];if(document.activeElement===this&&!i.parentNode&&t.parentNode){var a=[],{folderMark:n,nodeIcon:s}=t;for(const r of t.childNodes)r instanceof HTMLElement&&r!==n&&r!==s&&r.addClass("hidden")&&a.push(r);i.lastText=t.textNode.nodeValue,t.textNode.nodeValue="",t.appendChild(i),i.hiddenNodes=a,i.write(e.name),i.getFocus("all"),i.fitContent()}}}cancelRenaming(){var e=this["timer"];e.target&&(e.target=null),e.running&&(e.running=!1,e.remove())}insertPaddingAndClear(){var t=Ee.padding;let e=this.elements.count;this.padded&&e++,t.count!==e&&(t.count=e,t.style.height=20*e+"px");var i=this.childNodes[0],a=(this.insertBefore(t,i),this)["childNodes"],t=a["length"];for(let e=t-1;0<e;e--)a[e].remove()}clearElements(e){return Se.clearElements(this,e)}clear(){return"search"===this.display&&(this.display="normal",this.keyword=null,this.searchResults=[]),this.unselect(),this.textContent="",this.clearElements(0),this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.updateHeadAndFoot(),this}on(e,t,i){switch(super.on(e,t,i),e){case"select":this.selectEventEnabled=!0;break;case"unselect":this.unselectEventEnabled=!0;break;case"record":this.recordEventEnabled=!0;break;case"popup":this.popupEventEnabled=!0;break;case"open":this.openEventEnabled=!0;break;case"update":this.updateEventEnabled=!0}}keydown(e){if(this.data)if(e.cmdOrCtrlKey){switch(e.code){case"ArrowUp":this.scrollTop-=20;break;case"ArrowDown":this.scrollTop+=20;break;default:return}e.stopImmediatePropagation()}else if(!e.altKey){switch(e.code){case"Enter":case"NumpadEnter":var t=this.read();t&&(e.preventDefault(),e.stopPropagation(),this.open(t));break;case"Space":return void e.preventDefault();case"ArrowRight":e.preventDefault(),this.expandSelection();break;case"ArrowUp":e.preventDefault(),this.selectRelative("up");break;case"ArrowDown":e.preventDefault(),this.selectRelative("down");break;case"F2":t=this.read();t&&(this.cancelRenaming(),this.rename(t));break;default:return}e.stopImmediatePropagation()}}pointerdown(e){switch(this.dragend(),this.cancelRenaming(),e.button){case 0:var t=e.target;"FOLDER-MARK"===t.tagName?(e.preventDefault(),i=t.parentNode["item"],i.expanded=!i.expanded,this.update(),this.dispatchChangeEvent()):"NODE-ITEM"===t.tagName&&(t.hasClass("selected")?this.renamable&&"closed"===ve.state&&document.activeElement===this&&e.clientX>(t.nodeIcon?.rect().right??0)&&(this.timer.target=e.target):this.select(t.item));break;case 2:var i=e.target.seek("node-item");"NODE-ITEM"!==i.tagName||i.hasClass("selected")||this.select(i.item)}}pointerup(e){if(!this.dragging&&this.data)switch(e.button){case 0:document.activeElement===this&&this.timer.target===e.target&&(this.timer.running=!0,this.timer.elapsed=0,this.timer.add());break;case 2:var t,i;this.popupEventEnabled&&document.activeElement===this&&("NODE-ITEM"===(i=e.target.seek("node-item")).tagName&&i.hasClass("selected")?((t=new Event("popup")).value=i.item,t.clientX=e.clientX,t.clientY=e.clientY,this.dispatchEvent(t)):((i=new Event("popup")).value=null,i.clientX=e.clientX,i.clientY=e.clientY,this.dispatchEvent(i)))}}doubleclick(e){var e=e.target;"NODE-ITEM"===e.tagName&&(this.cancelRenaming(),"folder"===(e=e.item).class?(e.expanded=!e.expanded,this.update(),this.dispatchChangeEvent()):this.open(e))}dragstart(e){!this.removable||this.dragging||"normal"!==this.display||null===this.read()||Ee.textBox.parentNode||!1!==this.lockDirectory&&"folder"===this.read().class||(this.dragging=e,Object.defineProperty(e,"offsetY",{writable:!0}),e.preventDefault=Function.empty,e.dataTransfer.hideDragImage(),e.hint=document.createElement("drag-and-drop-hint"),e.hint.addClass("for-list"),this.parentNode.insertBefore(e.hint.hide(),this),this.addClass("dragging"),this.on("dragenter",this.dragenter),this.on("dragleave",this.dragleave),this.on("dragover",this.dragover),this.on("drop",this.drop))}dragend(e){this.dragging&&(this.removeClass("dragging"),this.dragging.hint.target?.removeClass("hint"),this.parentNode.removeChild(this.dragging.hint),this.dragging=null,this.off("dragenter",this.dragenter),this.off("dragleave",this.dragleave),this.off("dragover",this.dragover),this.off("drop",this.drop))}dragenter(e){this.dragging&&(e.preventDefault(),e.dataTransfer.dropEffect="move")}dragleave(e){this.dragging&&!this.contains(e.relatedTarget)&&(this.dragging.offsetY=-1,this.dragging.hint.hide())}dragover(e){var t=this["dragging"];if(t&&(e.preventDefault(),e.dataTransfer.dropEffect="move",t.offsetY!==e.offsetY)){t.offsetY=e.offsetY;var i=e.target.seek("node-item"),a=t.hint.show();if("NODE-ITEM"===i.tagName){var t=t.target.item,n=i.item;if(this.contain(t,n))return a.hide();var s,t=e.offsetY,r=n.children?t<4?"before":t<16?"into":"after":t<10?"before":"after";switch(r){case"into":a.target===i&&a.position===r||(s=a.measure(i),a.target?.removeClass("hint"),a.target=i,a.position=r,a.moveDown().set(s),i.addClass("hint"));break;case"before":a.target===i&&a.position===r||(--(s=a.measure(i)).top,s.height=2,a.target?.removeClass("hint"),a.target=i,a.position=r,a.moveUp().set(s));break;case"after":a.target===i&&a.position===r||((s=a.measure(i)).top+=s.height-1,s.height=2,a.target?.removeClass("hint"),a.target=i,a.position=r,a.moveUp().set(s))}}else{e=this.elements,n=e[e.count-1];void 0===n||a.target===n&&"append"===a.position||((t=a.measure(n)).top+=t.height-1,t.height=2,a.target?.removeClass("hint"),a.target=n,a.position="append",a.moveUp().set(t))}}}drop(e){var t=this["dragging"];if(t){e.stopPropagation();var i=t.hint;if(!i.hasClass("hidden")){var a=t.target.item,n=i.target.item;if("append"!==i.position&&this.contain(a,n))return;switch(i.position){case"into":this.removeItemTo(a,n);break;case"before":this.removeItemToInsert(a,n);break;case"after":case"append":var s=this.elements,r=s.indexOf(i.target),s=s[r+1]?.item;s?this.removeItemToInsert(a,s):this.removeItemTo(a,this.root)}}this.dragend()}}dataChange(e){"search"===this.display&&this.searchNodes(this.keyword)}static padding=(t=document.createElement("box"),t.style.display="block",t.style.width="1px",t);static createParents=function(){const r={configurable:!0,writable:!0,value:null},o=(t,i)=>{var a=t.length;for(let e=0;e<a;e++){var n=t[e],s=(void 0===n.parent&&Object.defineProperty(n,"parent",r),n.parent=i,n)["children"];0<s?.length&&o(s,n)}};return function(e,t){o(e,t)}}();static deleteCaches=function(){const i=e=>{for(const t of e)delete t.element,delete t.parent,void 0!==t.children&&i(t.children)};return function(e){i(e),delete e.initialized}}();static textBox=(e=new $,e.addClass("node-list-text-box"),e.input.addClass("node-list-text-box-input"),e.on("keydown",function(e){switch(e.stopPropagation(),e.code){case"Enter":case"NumpadEnter":case"Escape":var t=this.parentNode.parentNode;this.input.blur(),t.focus()}}),e.on("input",function(e){this.fitContent()}),e.on("select",function(e){e.stopPropagation()}),e.on("change",function(e){e.stopPropagation()}),e.on("blur",function(e){var t=this.parentNode,i=t.parentNode,a=t.item,n=this.read().trim();for(const o of this.hiddenNodes)o.removeClass("hidden");this.hiddenNodes=null,this.remove();var s,r=a.name;r!==n?(a.name=n,i.updateItemName(a),i.recordEventEnabled&&((s=new Event("record")).value={type:"rename",item:a,oldValue:r,newValue:n},i.dispatchEvent(s)),i.dispatchChangeEvent()):t.textNode.nodeValue=this.lastText}),e)}customElements.define("node-list",Ee);class Me extends HTMLElement{left;top;width;height;upper;constructor(){super(),this.left=0,this.top=0,this.width=0,this.height=0}measure(e){var t=this.parentNode;let i=t.borderLeft,a=t.borderTop;void 0===i&&(n=t.css(),i=parseInt(n.borderLeftWidth),a=parseInt(n.borderTopWidth),t.borderLeft=i,t.borderTop=a);var n=t.rect(),t=e.rect();return{left:t.left-n.left-i,top:t.top-n.top-a,width:t.width,height:t.height}}moveUp(){return this.upper||(this.upper=!0,this.style.zIndex="1"),this}moveDown(){return this.upper&&(this.upper=!1,this.style.zIndex=""),this}set({left:e,top:t,width:i,height:a}){this.left===e&&this.top===t&&this.width===i&&this.height===a||(this.left=e,this.top=t,this.width=i,this.height=a,this.style.left=e+"px",this.style.top=t+"px",this.style.width=i+"px",this.style.height=a+"px")}}customElements.define("drag-and-drop-hint",Me);class Se extends HTMLElement{elements;selection;writeEventEnabled;selectEventEnabled;popupEventEnabled;constructor(){super(),this.tabIndex=0,this.elements=[],this.elements.versionId=0,this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.elements.head=null,this.elements.foot=null,this.selection=null,this.writeEventEnabled=!1,this.selectEventEnabled=!1,this.popupEventEnabled=!1,this.listenDraggingScrollbarEvent(),this.on("scroll",this.scroll),this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown),this.on("pointerup",this.pointerup)}read(){return this.selection?.dataValue}write(a){var e,n=this.elements,s=n.count;if(0!==s){this.unselect();let t=0,i=n[t];for(let e=0;e<s;e++)if(n[e].dataValue===a){i=n[t=e];break}i.addClass("selected"),this.selection=i,this.scrollToItem(t),this.writeEventEnabled&&((e=new Event("write")).value=i.dataValue,this.dispatchEvent(e))}}reload(){var e=this["elements"];return e.start=-1,e.count=0,this}appendElement(e){var t=this["elements"];t[t.count++]=e}update(){this.clearElements(this.elements.count),this.resize()}resize(){return Se.resize(this)}updateHeadAndFoot(){return Se.updateHeadAndFoot(this)}updateOnResize(){}select(e){var t;e instanceof HTMLElement&&this.selection!==e&&(this.write(e.dataValue),this.selectEventEnabled)&&((t=new Event("select")).value=e.dataValue,this.dispatchEvent(t))}unselect(){this.selection&&(this.selection.removeClass("selected"),this.selection=null)}scrollToItem(e){e=Math.clamp(this.scrollTop,20*e+20-this.innerHeight,20*e);this.scrollTop!==e&&(this.scrollTop=e)}selectRelative(t){var i=this.elements,a=i.count;if(0<a){let e=-1;var n=a-1,a=this["selection"];switch(a&&(e=i.indexOf(a)),t){case"up":e=-1!==e?Math.max(e-1,0):n;break;case"down":e=-1!==e?Math.min(e+1,n):0}this.select(i[e])}}clearElements(e){return Se.clearElements(this,e)}clear(){return this.unselect(),this.textContent="",this.clearElements(0),this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.updateHeadAndFoot(),this}on(e,t,i){switch(super.on(e,t,i),e){case"write":this.writeEventEnabled=!0;break;case"select":this.selectEventEnabled=!0;break;case"popup":this.popupEventEnabled=!0}}scroll(e){return this.resize()}keydown(e){if(e.cmdOrCtrlKey)switch(e.code){case"ArrowUp":this.scrollTop-=20;break;case"ArrowDown":this.scrollTop+=20}else if(!e.altKey)switch(e.code){case"Space":return void e.preventDefault();case"ArrowUp":e.preventDefault(),this.selectRelative("up");break;case"ArrowDown":e.preventDefault(),this.selectRelative("down")}}pointerdown(e){switch(e.button){case 0:case 2:var t=e.target;"COMMON-ITEM"!==t.tagName||t.hasClass("selected")||this.select(t)}}pointerup(e){var t,i;2===e.button&&this.popupEventEnabled&&document.activeElement===this&&("COMMON-ITEM"===(i=e.target.seek("common-item")).tagName&&i.hasClass("selected")?((t=new Event("popup")).value=i.dataValue,t.clientX=e.clientX,t.clientY=e.clientY,this.dispatchEvent(t)):((i=new Event("popup")).value=null,i.clientX=e.clientX,i.clientY=e.clientY,this.dispatchEvent(i)))}static resize=t=>{var e=t.scrollTop,i=t.innerHeight,a=t.elements,n=a.count;if(0!==i)if(0===n)t.textContent="";else{var s=Math.min(Math.floor(e/20),n-1),e=Math.ceil(i/20)+1,r=Math.min(s+e,n);if(a.start!==s||a.end!==r){a.start=s,a.end=r,t.updateHeadAndFoot();var o=a.versionId++;for(let e=s;e<r;e++){var l=a[e];l.versionId=o,t.updateOnResize(l)}var c=t.childNodes;for(let e=c.length-1;0<=e;e--){var h=c[e];h.versionId!==o&&h.remove()}a.foot.parentNode||t.appendChild(a.foot);for(let e=r-2;e>=s;e--){var d,u=a[e];null===u.parentNode&&(d=a[e+1],t.insertBefore(u,d))}}}};static updateHeadAndFoot=e=>{var t,i=e["elements"],{count:a,start:n,end:s}=(i.head&&(i.head.style.marginTop="",i.head=null),i.foot&&(i.foot.style.marginBottom="",i.foot=null),i);0!==a&&(t=20*n,a=20*(a-s+(e.padded?1:0)),i.head=i[n],i.head.style.marginTop=t+"px",i.foot=i[s-1],i.foot.style.marginBottom=a+"px")};static clearElements(e,t){let i=t;for(var a=e["elements"];void 0!==a[i];)a[i++]=void 0}}customElements.define("common-list",Se);class Ae{list;stack;index;constructor(e){this.list=e,this.stack=[],this.index=-1}reset(){0!==this.stack.length&&(this.stack=[],this.index=-1)}save(e){var t=this.stack,i=this.index+1;i<t.length&&(t.length=i),t.length<100?this.index++:t.shift(),t.push(e)}restore(e){var t="undo"===e?this.index:"redo"===e?this.index+1:null;if(0<=t&&t<this.stack.length){var i=this.list,t=this.stack[t],a=t.type;switch(Ae.restore(i,t,a,e),e){case"undo":this.index--;break;case"redo":this.index++}}}canUndo(){return 0<=this.index}canRedo(){return this.index+1<this.stack.length}static restore(e,t,i,a){var n=e.data===t.array;switch(i){case"insert":var{array:s,index:r,items:o}=t,l=o.length;"undo"===a?r+l<=s.length&&(s.splice(r,l),n)&&(e.update(),e.select(r)):r<=s.length&&(s.splice(r,0,...o),n)&&(e.update(),e.select(r,r+l-1));break;case"replace":var{array:s,index:o,oldItem:r,newItem:l}=t;"undo"===a?o<s.length&&(s[o]=r,n)&&(e.update(),e.select(o)):o<s.length&&(s[o]=l,n)&&(e.update(),e.select(o));break;case"delete":var{array:r,index:s,items:l}=t,o=l.length;"undo"===a?s<=r.length&&(r.splice(s,0,...l),n)&&(e.update(),e.select(s,s+o-1)):s+o<=r.length&&(r.splice(s,o),n)&&(e.update(),e.select(s));break;case"toggle":var{array:l,method:r,items:o}=t,s=("undo"===a&&"disable"===r||"redo"===a&&"enable"===r?e.enableItems(o):e.disableItems(o),o.length),r=o[0],o=o[s-1];e.update(),e.select(l.indexOf(r),l.indexOf(o))}n&&(e.scrollToSelection(),e.dispatchChangeEvent())}}class Pe extends HTMLElement{object;type;data;elements;selections;start;end;origin;active;flexible;inserting;focusing;dragging;history;toggleable;windowPointerup;windowPointermove;constructor(){super(),this.tabIndex=0,this.object=null,this.type=null,this.data=null,this.elements=[],this.elements.versionId=0,this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.elements.head=null,this.elements.foot=null,this.selections=[],this.start=null,this.end=null,this.origin=null,this.active=null,this.flexible=this.hasAttribute("flexible"),this.inserting=!1,this.focusing=!1,this.dragging=null,this.history=null,this.toggleable=!1,this.windowPointerup=Pe.windowPointerup.bind(this),this.windowPointermove=Pe.windowPointermove.bind(this),this.listenDraggingScrollbarEvent(),this.on("scroll",this.resize),this.on("focus",this.listFocus),this.on("blur",this.listBlur),this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown),this.on("pointerup",this.pointerup),this.on("doubleclick",this.doubleclick)}get innerHeight(){return this.flexible?this.height:super.innerHeight}get paddingTop(){let e=this._paddingTop;return e=void 0===e?this._paddingTop=parseInt(this.css().paddingTop):e}bind(e){return e.initialize(this),e.initialize=Function.empty,this.object=e,this.type="yami."+(e.type??this.id),this.history=e.history??new Ae(this),this}read(){return this.data}write(e){this.flexible&&(this.autoSwitch=!0),this.data=e,this.update(),this.history.reset()}update(){var t=this["data"];if(t){var i=this["elements"],a=(i.start=-1,i.count=0,this.object),n=t.length;for(let e=0;e<n;e++){var s,r,o,l=t[e],c=a.parse(l,t,e);switch(typeof c){case"string":{const h=document.createElement("param-item");h.addClass("one-column"),h.dataValue=e,h.dataItem=l,h.textContent=c,i[i.count++]=h;continue}case"object":{const h=document.createElement("param-item");h.dataValue=e,h.dataItem=l,i[i.count++]=h,Array.isArray(c)?([o,s]=c,o instanceof HTMLElement?h.appendChild(o):o instanceof Object?((r=document.createElement("text")).addClass("text-0-of-2"),r.textContent=o.content,o.class&&r.addClass(o.class),h.appendChild(r)):((r=document.createElement("text")).addClass("text-0-of-2"),r.textContent=o,h.appendChild(r)),s instanceof HTMLElement?h.appendChild(s):s instanceof Object?((o=document.createElement("text")).addClass("text-1-of-2"),o.textContent=s.content,s.class&&o.addClass(s.class),h.appendChild(o)):((o=document.createElement("text")).addClass("text-1-of-2"),o.textContent=s,h.appendChild(o))):(h.addClass("one-column"),h.textContent=c.content,c.class&&h.addClass(c.class))}}}const h=document.createElement("param-item");var e=1===n?"item":"items";h.addClass("weak"),h.dataValue=n,h.dataItem=null,h.textContent=n+" "+e,i[i.count++]=h,this.clearElements(i.count),this.updateFlexibleHeight(),a.update?.(this),this.resize()}}resize(){return Se.resize(this)}updateFlexibleHeight(){var e,t;this.flexible&&(e=this.elements.count,t=Math.min(20*e,500)+2,this.height!==t&&(this.height=t,this.style.height=t+"px"),this.autoSwitch)&&(this.autoSwitch=!1,(t=this.parentNode)instanceof V)&&(1!==e?t.open():t.close())}updateHeadAndFoot(){return Se.updateHeadAndFoot(this)}updateOnResize(){}select(e,t=e){t<e&&([e,t]=[t,e]);var i=this.elements,a=i.count;(e=Math.clamp(e,0,a-1))===(t=Math.clamp(t,0,a-1))||i[t].dataItem||t--,this.unselect(),this.start=e,this.end=t,this.origin=e,this.active=e,this.reselect()}selectMultiple(e){var t=this.origin;this.select(t,e),this.origin=t,this.active=Math.clamp(e,this.start,this.end)}selectAll(){this.select(0,1/0),this.active=this.end}unselect(){if(null!==this.start){var t=this["selections"],i=t["count"];for(let e=0;e<i;e++)t[e].removeClass("selected"),t[e]=void 0;t.count=0,256<i&&(t.length=0)}}reselect(){if(this.focusing&&null!==this.start){var i=this["selections"],a=this.elements,n=this.start,s=this.end;let t=0;for(let e=n;e<=s;e++){var r=a[e];(i[t++]=r).addClass("selected")}i.count=t}}selectUp(){if(null!==this.start){let e=this.start;e===this.end&&e--,this.select(e),this.scrollToSelection()}}selectDown(){if(null!==this.end){let e=this.end;e===this.start&&e++,this.select(e),this.scrollToSelection()}}selectMultipleUp(){var e;null!==this.start&&(0<=(e=this.active-1)&&this.selectMultiple(e),this.scrollToSelection())}selectMultipleDown(){var e,t,i;null!==this.end&&(e=this.elements.count,t=this.origin,((i=this.active+1)<e-1||i===t)&&this.selectMultiple(i),this.scrollToSelection())}scrollToSelection(){var e;null!==this.start&&(e=Math.clamp(this.scrollTop,20*this.active+20-this.innerHeight,20*this.active),this.scrollTop!==e)&&(this.scrollTop=e)}insert(){null!==this.start&&(this.inserting=!0,(this.object.target=this).object.open())}edit(){if(null!==this.start){var e=this.elements[this.start];switch(this.inserting=null===e.dataItem,this.inserting){case!0:(this.object.target=this).object.open();break;case!1:(this.object.target=this).object.open(this.data[this.start])}}}toggle(){if(this.toggleable&&null!==this.start){let t="disable";var i=[],{data:a,start:n,end:s}=this;for(let e=n;e<=s;e++){var r=a[e];if(r)switch(t){case"disable":r.enabled||(t="enable",i.length=0),i.push(r);continue;case"enable":r.enabled||i.push(r);continue}}if(0!==i.length){switch(this.history.save({type:"toggle",array:a,method:t,items:i}),t){case"enable":this.enableItems(i);break;case"disable":this.disableItems(i)}this.update(),this.reselect(),this.dispatchChangeEvent()}}}enableItems(e){for(const t of e)t.enabled=!0}disableItems(e){for(const t of e)t.enabled=!1}copy(){var e,t,i;null!==this.start&&(i=this.data,e=this.start,t=this.end+1,0<(i=i.slice(e,t)).length)&&Clipboard.write(this.type,i)}paste(){var e,t,i;null!==this.start&&(e=Clipboard.read(this.type))&&(t=this.data,i=this.start,this.history.save({type:"insert",array:t,index:i,items:e}),this.object.onPaste?.(this,e),t.splice(i,0,...e),this.update(),this.select(i+e.length),this.scrollToSelection(),this.dispatchChangeEvent())}delete(){var e,t,i,a;null!==this.start&&(e=this.data,t=this.start,i=this.end+1,0<(a=e.slice(t,i)).length)&&(this.history.save({type:"delete",array:e,index:t,items:a}),e.splice(t,i-t),this.update(),this.select(t),this.scrollToSelection(),this.dispatchChangeEvent())}undo(){!this.dragging&&this.history.canUndo()&&this.history.restore("undo")}redo(){!this.dragging&&this.history.canRedo()&&this.history.restore("redo")}save(){var e=this.object.save();if(void 0!==e){var t=this.start;if(null!==t){var i=this.data,a=i.length;switch(this.inserting){case!0:this.history.save({type:"insert",array:i,index:t,items:[e]}),i.splice(t,0,e),this.update(),this.select(t+i.length-a);break;case!1:this.history.save({type:"replace",array:i,index:t,oldItem:i[t],newItem:e}),i[t]=e,this.update(),this.select(t)}this.scrollToSelection(),this.dispatchChangeEvent()}}}clearElements(e){return Se.clearElements(this,e)}clear(){return this.unselect(),this.textContent="",this.data=null,this.start=null,this.end=null,this.history.reset(),this.clearElements(0),this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.updateHeadAndFoot(),this}listFocus(e){this.focusing||(this.focusing=!0,null!==this.start?this.reselect():this.select(0))}listBlur(e){if(this.dragging&&this.windowPointerup(this.dragging),this.focusing){let e=this;for(;e=e.parentNode;)if(e instanceof s){if(e.hasClass("blur"))return;break}this.focusing=!1,this.unselect()}}keydown(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":this.copy(),this.delete();break;case"KeyC":this.copy();break;case"KeyV":this.paste();break;case"KeyA":this.selectAll();break;case"KeyZ":this.undo();break;case"KeyY":this.redo();break;case"ArrowUp":this.scrollTop-=20;break;case"ArrowDown":this.scrollTop+=20;break;default:return}else switch(e.code){case"Space":return void e.preventDefault();case"Enter":case"NumpadEnter":null!==this.start&&(e.stopPropagation(),this.start===this.end)&&this.edit();break;case"Insert":this.insert();break;case"Slash":this.toggle();break;case"Delete":this.delete();break;case"ArrowUp":e.preventDefault(),e.shiftKey?this.selectMultipleUp():this.selectUp();break;case"ArrowDown":e.preventDefault(),e.shiftKey?this.selectMultipleDown():this.selectDown();break;default:return}e.stopImmediatePropagation()}pointerdown(i){if(!this.dragging)switch(i.button){case 0:{let e,t=i.target;t===this?t.isInContent(i)&&(e=this.elements.count-1):"PARAM-ITEM"===(t=t.seek("param-item")).tagName&&(e=t.read()),0<=e&&(t=this.elements[e],i.shiftKey&&null!==this.start?this.selectMultiple(e):this.select(e),(this.dragging=i).mode="select",i.itemIndex=e,i.itemHeight=t.clientHeight,window.on("pointerup",this.windowPointerup),window.on("pointermove",this.windowPointermove),this.addScrollListener("vertical",2,!0,()=>{this.windowPointermove(i.latest)}));break}case 2:{let e,t=i.target;t===this?t.isInContent(i)&&(e=this.elements.count-1):"PARAM-ITEM"===(t=t.seek("param-item")).tagName&&(e=t.read()),0<=e&&(this.elements[e].hasClass("selected")||this.select(e));break}}}pointerup(e){var t,i,a,n,s,r,o;this.dragging||2===e.button&&null!==this.start&&document.activeElement===this&&(t=!!this.elements[this.start].dataItem,o=this.start===this.end,i=Clipboard.has(this.type),a=0<this.data.length,n=this.history.canUndo(),s=this.history.canRedo(),o=[{label:(r=N.createGetter("menuParamList"))("edit"),accelerator:"Enter",enabled:o,click:()=>{this.edit()}},{label:r("insert"),accelerator:"Insert",click:()=>{this.insert()}},{type:"separator"},{label:r("cut"),accelerator:p("X"),enabled:t,click:()=>{this.copy(),this.delete()}},{label:r("copy"),accelerator:p("C"),enabled:t,click:()=>{this.copy()}},{label:r("paste"),accelerator:p("V"),enabled:i,click:()=>{this.paste()}},{label:r("delete"),accelerator:"Delete",enabled:t,click:()=>{this.delete()}},{label:r("selectAll"),accelerator:p("A"),enabled:a,click:()=>{this.select(0,1/0)}},{label:r("undo"),accelerator:p("Z"),enabled:n,click:()=>{this.undo()}},{label:r("redo"),accelerator:p("Y"),enabled:s,click:()=>{this.redo()}}],this.toggleable&&o.splice(2,0,{label:r("toggle"),accelerator:"/",click:()=>{this.toggle()}}),ve.popup({x:e.clientX,y:e.clientY},o))}doubleclick(e){this.start===this.end&&this.edit()}static windowPointerup(e){var t=this["dragging"];t.relate(e)&&("select"===t.mode&&this.removeScrollListener(),this.dragging=null,window.off("pointerup",this.windowPointerup),window.off("pointermove",this.windowPointermove))}static windowPointermove(e){var t,i,a,n=this["dragging"];n.relate(e)&&"select"===n.mode&&(n.latest=e,0<(t=this.elements.count))&&(a=this.paddingTop,i=n["itemHeight"],e=e.getRelativeCoords(this)["y"],e=Math.floor((e-a)/i),a=Math.clamp(e,0,t-1),n.itemIndex!==a)&&(n.itemIndex=a,this.selectMultiple(a))}}customElements.define("param-list",Pe);class Le{list;stack;index;capacity;versionId;lastState;constructor(e){this.list=e,this.stack=[],this.index=-1,this.capacity=100,this.versionId=0,this.lastState=0}reset(){0!==this.stack.length&&(this.stack=[],this.index=-1)}save(e){var t=this.stack,i=this.index+1;i<t.length&&(t.length=i),t.length<this.capacity?this.index++:t.shift(),t.push(e),this.versionId++}restore(i){const e="undo"===i?this.index:"redo"===i?this.index+1:null;if(0<=e&&e<this.stack.length){var a=this.list,n=this.stack[e];switch(n.type){case"insert":{const{array:t,index:e,commands:c}=n;var s=c.length,r=c[0],o=c[s-1];"undo"===i?e+s<=t.length&&(l=a.getRangeByData(r)[0],t.splice(e,s),a.update(),a.select(l)):e<=t.length&&(t.splice(e,0,...c),a.update(),a.select(a.getRangeByData(r)[0],a.getRangeByData(o)[1]));break}case"replace":{const{array:h,index:e,commands:d}=n;var[s,l]=d;"undo"===i?e<h.length&&(h[e]=s,a.update(),a.select(...a.getRangeByData(s))):e<h.length&&(h[e]=l,a.update(),a.select(...a.getRangeByData(l)));break}case"delete":{const{array:u,index:e,commands:p}=n;r=p.length,o=p[0],s=p[r-1];"undo"===i?e<=u.length&&(u.splice(e,0,...p),a.update(),a.select(a.getRangeByData(o)[0],a.getRangeByData(s)[1])):e+r<=u.length&&(l=a.getRangeByData(o)[0],u.splice(e,r),a.update(),a.select(l));break}case"toggle":{var{method:s,commands:o}=n,r=("undo"===i&&"disable"===s||"redo"===i&&"enable"===s?a.enableItems(o):a.disableItems(o),o.length),l=o[0],s=o[r-1];let[e,t]=a.getRangeByData(l);1<r&&(t=a.getRangeByData(s)[1]),a.update(),a.select(e,t);break}}switch(a.scrollToSelection("restore"),a.dispatchChangeEvent(),i){case"undo":this.index--,this.versionId--;break;case"redo":this.index++,this.versionId++}}}saveState(){this.lastState=this.versionId}restoreState(){let e=this.lastState-this.versionId;if(Math.abs(e)<=this.capacity){var t=this.list;for(t.update=Function.empty,t.select=Function.empty,t.scrollToSelection=Function.empty;e<0;)this.restore("undo"),e++;for(;0<e;)this.restore("redo"),e--;return delete t.update,delete t.select,delete t.scrollToSelection,!0}return!1}canUndo(){return 0<=this.index}canRedo(){return this.index+1<this.stack.length}}class Re extends HTMLElement{data;elements;selections;start;end;origin;active;anchor;inserting;focusing;dragging;windowPointerup;windowPointermove;constructor(){super(),this.tabIndex=0,this.data=null,this.elements=[],this.elements.versionId=0,this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.elements.head=null,this.elements.foot=null,this.selections=[],this.selections.count=0,this.start=null,this.end=null,this.origin=null,this.active=null,this.anchor=null,this.inserting=!1,this.focusing=!1,this.dragging=null,this.windowPointerup=Re.windowPointerup.bind(this),this.windowPointermove=Re.windowPointermove.bind(this),this.windowVariableChange=Re.windowVariableChange.bind(this),this.listenDraggingScrollbarEvent(),this.on("scroll",this.resize),this.on("focus",this.listFocus),this.on("blur",this.listBlur),this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown),this.on("pointerup",this.pointerup),this.on("doubleclick",this.doubleclick),window.on("variablechange",this.windowVariableChange)}get history(){return this.data.history}get paddingTop(){let e=this._paddingTop;return e=void 0===e?this._paddingTop=parseInt(this.css().paddingTop):e}read(){return this.data}write(e){this.data=e,this.textContent="",this.update(),e.history||Object.defineProperty(e,"history",{configurable:!0,value:new Le(this)}),Promise.resolve().then(()=>{this.scrollTop=0})}update(){var t=this["elements"],i=(t.start=-1,t.count=0,I.format=!0,this.createItems(this.data,0),I.format=!1,t)["count"];for(let e=0;e<i;e++)t[e].dataValue=e;this.clearElements(t.count),this.dispatchUpdateEvent(),this.resize()}resize(){return Se.resize(this)}updateHeadAndFoot(){return Se.updateHeadAndFoot(this)}updateOnResize(e){if(null!==e.contents&&this.updateCommandElement(e),void 0!==e.updaters&&null===e.parentNode)for(const t of e.updaters)t.update()}createItems(t,i){var a=this.elements,n=t.length;for(let e=0;e<n;e++)for(const s of this.createCommandBuffer(t,e,i))s instanceof HTMLElement?a[a.count++]=s:s instanceof Array&&this.createItems(s,i+1);a[a.count++]=this.createBlankElement(t,n,i)}createCommandBuffer(a,n,s){var r=a[n];let o=r.buffer;if(void 0===o){(o=[]).enabled=!0,Object.defineProperty(r,"buffer",{configurable:!0,value:o});let t,i;(t=document.createElement("command-item")).contents=[],t.dataKey=!0,t.dataList=a,t.dataItem=r,t.dataIndex=n,t.dataIndent=s,o.push(t);var l=I.parse(r),c=l.length;for(let e=0;e<c;e++){var h=l[e];void 0!==h.text&&(h.color=i,t.contents.push(h)),void 0!==h.color?i=I.invalid?"invalid":h.color:(void 0!==h.break||void 0!==h.children&&(h=h["children"],h.parent?h.parent=r:Object.defineProperty(h,"parent",{writable:!0,value:r}),o.push(h),e<c))&&((t=document.createElement("command-item")).contents=[],t.dataKey=!1,t.dataList=a,t.dataItem=r,t.dataIndex=n,t.dataIndent=s,o.push(t))}}if(o[0].dataIndex!==n)for(const t of o)t instanceof HTMLElement&&(t.dataIndex=n);var e="!"!==r.id[0];if(o.enabled!==e)if(o.enabled=e)for(const i of o)i instanceof HTMLElement&&i.removeClass("disabled");else for(const d of o)d instanceof HTMLElement&&d.addClass("disabled");return o}updateCommandElement(t){var e;t.style.textIndent=this.computeTextIndent(t.dataIndent),t.dataKey?((e=document.createElement("command-mark-major")).textContent=">",t.appendChild(e)):((e=document.createElement("command-mark-minor")).textContent=":",t.appendChild(e));for(const n of t.contents)if(void 0!==n.text){var i=document.createElement("command-text"),a=I.FormatUpdater.create(n.text,i);if(a){let e=t.updaters;(e=void 0===e?t.updaters=[]:e).push(a),a.update()}else i.textContent=n.text;i.addClass(n.color),t.appendChild(i)}t.contents=null}deleteCommandBuffers(e){for(const i of e){var t=i["buffer"];if(t){for(const a of t)a instanceof Array&&this.deleteCommandBuffers(a);delete i.buffer}}}createBlankElement(e,t,i){let a=e.blank;void 0===a&&((a=document.createElement("command-item")).contents=Array.empty,a.enabled=!0,a.dataKey=!0,a.dataList=e,a.dataItem=null,a.dataIndex=t,a.dataIndent=i,Object.defineProperty(e,"blank",{value:a})),a.dataIndex!==t&&(a.dataIndex=t);i=e.parent;return void 0!==i&&(t=i.buffer["enabled"],a.enabled!==t)&&((a.enabled=t)?a.removeClass("disabled"):a.addClass("disabled")),a}computeTextIndent(e){return"en-US"!==N.language?e+"em":2*e+"ch"}select(t,i=t){i<t&&([t,i]=[i,t]);var a=this.elements,n=a.count;t=Math.clamp(t,0,n-1),i=Math.clamp(i,0,n-1);let s=1/0;for(let e=t;e<=i;e++){var r=a[e]["dataIndent"];r<s&&(s=r)}for(let e=t;0<=e;e--){var o=a[e];if(o.dataIndent===s&&!0===o.dataKey){t=e;break}}for(let e=i+1;e<n;e++){var l=a[e];if(l.dataIndent<s||l.dataIndent===s&&!0===l.dataKey){i=e-1;break}}t===i||a[i].dataItem||i--,this.unselect(),this.start=t,this.end=i,this.origin=t,this.active=t,this.anchor=null,this.reselect()}selectMultiple(e){var t=this.origin;this.select(t,e),this.origin=t,this.active=Math.clamp(e,this.start,this.end)}selectAll(){this.select(0,1/0),this.active=this.getRangeByIndex(this.end)[0]}unselect(){if(null!==this.start){var t=this["selections"],i=t["count"];for(let e=0;e<i;e++)t[e].removeClass("selected"),t[e]=void 0;t.count=0,256<i&&(t.length=0)}}reselect(){if(this.focusing&&null!==this.start){var i=this["selections"],a=this.elements,n=this.start,s=this.end;let t=0;for(let e=n;e<=s;e++){var r=a[e];(i[t++]=r).addClass("selected")}i.count=t}}selectUp(){if(null!==this.start){var t=this.elements,i=t[this.start].dataItem,a=t[this.end].dataItem;let e=this.start;if(i===a)for(;0<=--e&&!t[e].dataKey;);this.select(e),this.scrollToSelection()}}selectDown(){if(null!==this.end){var t=this.elements,i=t[this.start].dataItem,a=t[this.end].dataItem;let e=this.end;if(i===a){i=t[e];if(!i.dataKey)for(var n=i.dataItem;0<=--e;){var s=t[e];if(s.dataItem===n&&!0===s.dataKey)break}for(var r=t["count"];++e<r&&!t[e].dataKey;);}this.select(e),this.scrollToSelection()}}pageUp(e){let t=this.anchor;var i,a;null!==(t=null===t?this.active:t)&&(i=Math.floor(this.innerHeight/20)-1,a=Math.max(this.scrollTop-20*i,0),e&&(e=this.scrollTop+this.innerHeight,e=Math.floor(e/20)-1,e=Math.min(t,e)-i,this.select(e),this.anchor=Math.max(e,this.start)),this.scroll(0,a))}pageDown(t){let i=this.anchor;if(null!==(i=null===i?this.active:i)){var a=this.scrollTop,n=Math.floor(this.innerHeight/20)-1;let e=a+20*n;t&&(t=Math.floor(a/20),t=Math.max(i,t)+n,n=20*this.elements.count-this.innerHeight,this.select(t),this.anchor=Math.min(t,this.end),e=Math.min(e,n)),this.scroll(0,Math.max(a,e))}}selectMultipleTo(e){if(null!==this.start){this.selectMultiple(e);var i=this.elements,e=i[this.start],a=i[this.active],n=e.dataIndent,e=a.dataIndent;let t=this.active;if(n<e)for(let e=t-1;0<=e;e--){var s=i[e];if(s.dataIndent===n&&!0===s.dataKey){t=e;break}}a=this.getRangeByIndex(t);this.origin<this.active&&this.origin>a[0]&&this.origin<a[1]?this.active=a[1]:this.active=a[0]}}selectMultipleUp(){if(null!==this.start){var a=this.elements;if(this.active<=this.origin){var t=a[this.start].dataIndent;let e=this.start;for(;0<=--e;){var i=a[e];if(i.dataIndent<=t&&!0===i.dataKey){this.selectMultiple(e);break}}}else{var n=a[this.end].dataItem,s=this.end;let t=1/0,i=this.origin;for(let e=i;e<s;e++){var r=a[e];r.dataIndent<t&&(t=r.dataIndent),r.dataIndent===t&&r.dataItem!==n&&null!==r.dataItem&&(i=e)}var e=this.getRangeByIndex(i);i=this.origin<i&&this.origin>e[0]&&this.origin<e[1]?e[1]:e[0],this.selectMultiple(i)}this.scrollToSelection()}}selectMultipleDown(){if(null!==this.end){var a=this.elements;if(this.active>=this.origin){var t=a[this.end].dataIndent,i=a.count;let e=this.end;for(;++e<i;){var n=a[e];if(n.dataIndent<t){e=this.getRangeByIndex(e)[1];break}if(n.dataIndent===t&&!0===n.dataKey&&null!==n.dataItem)break}this.selectMultiple(e)}else{var s=this.start;let t=1/0,i=this.origin;for(let e=i;e>s;e--){var r=a[e];r.dataIndent<t&&(t=r.dataIndent),r.dataIndent===t&&!0===r.dataKey&&(i=e)}this.selectMultiple(i)}this.scrollToSelection()}}scrollToSelection(t="active"){if(null!==this.start){let e;switch(t){case"active":var i=this.getRangeByIndex(this.active),a=this.scrollTop,n=20*i[0],i=20*i[1]+20-this.innerHeight;e=this.active<=this.origin?Math.min(Math.max(a,i),n):Math.max(Math.min(a,n),i);break;case"alter":a=this.scrollTop,n=20*this.active,i=20*this.active+20-this.innerHeight;e=Math.max(Math.min(a,n),i);break;case"restore":a=this.scrollTop,n=20*this.start,i=20*this.end+20-this.innerHeight;e=Math.min(Math.max(a,i),n);break;default:return}this.scrollTop!==e&&(this.scrollTop=e)}}scrollAndResize(){var e=this.scrollTop;this.scrollToSelection("active"),this.scrollTop!==e&&this.resize()}getRangeByIndex(t){var i=this.elements,a=i.count;const n=i[t];var s=n.dataItem,r=n.dataIndent;let o=t,l=t;for(let e=t;0<=e;e--){const n=i[e];if(n.dataItem===s&&!0===n.dataKey){o=e;break}}for(let e=t+1;e<a;e++){const n=i[e];if(n.dataIndent<r||n.dataIndent===r&&!0===n.dataKey){l=e-1;break}}return[o,l]}getRangeByData(t){var i=this.elements,a=i.count;let n,s=0,r=0;for(let e=0;e<a;e++){var o=i[e];if(o.dataItem===t){n=o.dataIndent,s=e;break}}for(let e=s+1;e<a;e++){var l=i[e];if(l.dataIndent<n||l.dataIndent===n&&!0===l.dataKey){r=e-1;break}}return[s,r]}isParentEnabled(e){return e.dataList.parent?.buffer.enabled??!0}insert(e=""){var t;null!==this.start&&(t=this.elements[this.start],this.isParentEnabled(t))&&(this.inserting=!0,I.insert(this,e))}edit(){if(null!==this.start){var e=this.elements[this.start];if(this.isParentEnabled(e))switch(this.inserting=null===e.dataItem,this.inserting){case!0:I.insert(this,"");break;case!1:var t=e.dataItem;t.buffer.enabled&&I.edit(this,t)}}}toggle(){if(null!==this.start){var{elements:i,start:a,end:n}=this,e=i[a];if(this.isParentEnabled(e)){let t="disable";var s=[];for(let e=a;e<=n;e++){var r=i[e];if(r.dataKey){var o=r.dataItem;if(null!==o)switch(t){case"disable":o.buffer.enabled||(t="enable",s.length=0),s.push(o);continue;case"enable":o.buffer.enabled||s.push(o);continue}}}if(0!==s.length){switch(this.history.save({type:"toggle",method:t,commands:s}),t){case"enable":this.enableItems(s);break;case"disable":this.disableItems(s)}this.update(),this.dispatchChangeEvent()}}}}enableItems(e){for(const t of e)"!"===t.id[0]&&(t.id=t.id.slice(1))}disableItems(e){for(const t of e)"!"!==t.id[0]&&(t.id="!"+t.id)}copy(){var e,t,i;null!==this.start&&(e=(t=this.elements)[this.start],t=t[this.end],i=e.dataList,e=e.dataIndex,t=t.dataIndex+1,0<(i=i.slice(e,t)).length)&&Clipboard.write("yami.commands",i)}paste(){var e,t,i,a,n;null!==this.start&&(a=(e=this.elements)[this.start],this.isParentEnabled(a))&&(t=Clipboard.read("yami.commands"))&&(i=a.dataList,a=a.dataIndex,n=e.count,this.history.save({type:"insert",array:i,index:a,commands:t}),i.splice(a,0,...t),this.update(),this.select(this.start+e.count-n),this.scrollToSelection("alter"),this.dispatchChangeEvent())}delete(){var e,t,i,a;null!==this.start&&(t=(i=this.elements)[this.start],i=i[this.end],e=t.dataList,t=t.dataIndex,i=i.dataIndex+1,0<(a=e.slice(t,i)).length)&&(this.history.save({type:"delete",array:e,index:t,commands:a}),e.splice(t,i-t),this.update(),this.select(this.start),this.scrollToSelection("alter"),this.dispatchChangeEvent())}undo(){!this.dragging&&this.history.canUndo()&&this.history.restore("undo")}redo(){!this.dragging&&this.history.canRedo()&&this.history.restore("redo")}save(e){if(null!==this.start){var t=this.elements[this.start],i=t.dataList,a=t.dataIndex;switch(this.inserting){case!0:this.history.save({type:"insert",array:i,index:a,commands:[e]}),this.end=this.start,i.splice(a,0,e),this.update(),this.selectDown();break;case!1:this.history.save({type:"replace",array:i,index:a,commands:[i[a],e]}),i[a]=e,this.update(),this.select(this.start)}this.scrollToSelection("alter"),this.dispatchChangeEvent()}}getSelectionPosition(){if(null===this.start)return null;var e=this.elements[this.start];if(!e.parentNode)return null;let t=e.childNodes[0].rect().left,i=e.rect().top;return document.body.hasClass("border")&&(e=1/window.devicePixelRatio,t-=e,i-=e),{x:t,y:i}}clearElements(e){return Se.clearElements(this,e)}clear(){return this.unselect(),this.textContent="",this.data=null,this.start=null,this.end=null,this.origin=null,this.active=null,this.anchor=null,this.clearElements(0),this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.updateHeadAndFoot(),this}listFocus(e){this.focusing||(this.focusing=!0,null!==this.start?this.reselect():this.select(0))}listBlur(e){if(this.dragging&&this.windowPointerup(this.dragging),this.focusing){let e=this;for(;e=e.parentNode;)if(e instanceof s){if(e.hasClass("blur"))return;break}this.focusing=!1,this.unselect()}}keydown(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":this.copy(),this.delete();break;case"KeyC":this.copy();break;case"KeyV":this.paste();break;case"KeyA":this.selectAll();break;case"KeyZ":this.undo();break;case"KeyY":this.redo();break;case"ArrowUp":this.scrollTop-=20;break;case"ArrowDown":this.scrollTop+=20;break;case"Home":e.preventDefault(),this.scroll(0,0);break;case"End":e.preventDefault(),this.scroll(0,this.scrollHeight);break;case"PageUp":this.pageUp(!1);break;case"PageDown":this.pageDown(!1)}else if(!e.altKey)if(e.shiftKey)switch(e.code){case"ArrowUp":this.selectMultipleUp();break;case"ArrowDown":this.selectMultipleDown();break;case"Home":this.selectMultipleTo(0),this.scrollToSelection();break;case"End":this.selectMultipleTo(1/0),this.scrollToSelection()}else switch(e.code){case"Space":return e.preventDefault(),void this.insert();case"Enter":case"NumpadEnter":null!==this.start&&(e.stopPropagation(),(t=this.elements)[this.start].dataItem===t[this.end].dataItem)&&this.edit();break;case"Insert":this.insert();break;case"Slash":this.toggle();break;case"Backslash":this.insert("script");break;case"Delete":this.delete();break;case"ArrowUp":e.preventDefault(),this.selectUp();break;case"ArrowDown":e.preventDefault(),this.selectDown();break;case"Home":e.preventDefault(),this.scroll(0,0),this.select(0);break;case"End":e.preventDefault();var t=20*this.elements.count-this.innerHeight;this.scroll(0,Math.max(this.scrollTop,t)),this.select(1/0);break;case"PageUp":e.preventDefault(),this.pageUp(!0);break;case"PageDown":e.preventDefault(),this.pageDown(!0);break;default:Re.alphabetCode.test(e.code)&&(this.insert(),Bt.searcher.input.focus())}}pointerdown(i){if(!this.dragging)switch(i.button){case 0:{let e=i.target,t;e===this?e.isInContent(i)&&(t=this.elements.count-1):"COMMAND-ITEM"===(e=e.seek("command-item",2)).tagName&&(t=e.read()),0<=t&&(e=this.elements[t],i.shiftKey&&null!==this.start?this.selectMultipleTo(t):this.select(t),(this.dragging=i).mode="select",i.itemIndex=t,i.itemHeight=e.clientHeight,window.on("pointerup",this.windowPointerup),window.on("pointermove",this.windowPointermove),this.addScrollListener("vertical",2,!0,()=>{this.windowPointermove(i.latest)}));break}case 2:{let e=i.target,t;e===this?e.isInContent(i)&&(t=this.elements.count-1):"COMMAND-ITEM"===(e=e.seek("command-item")).tagName&&(t=e.read()),0<=t&&(this.elements[t].hasClass("selected")||this.select(t));break}}}pointerup(e){var t,i,a,n,s,r,o,l;this.dragging||2===e.button&&null!==this.start&&document.activeElement===this&&(i=(n=this.elements)[this.start],n=n[this.end],a=i.dataItem,n=n.dataItem,t=!!a,i=this.isParentEnabled(i),a=(t?a.buffer.enabled:i)&&a===n,n=i&&Clipboard.has("yami.commands"),s=0<this.data.length,r=this.history.canUndo(),o=this.history.canRedo(),l=N.createGetter("menuCommandList"),ve.popup({x:e.clientX,y:e.clientY},[{label:l("edit"),accelerator:"Enter",enabled:a,click:()=>{this.edit()}},{label:l("insert"),accelerator:"Insert",enabled:i,click:()=>{this.insert()}},{label:l("toggle"),accelerator:"/",enabled:i&&t,click:()=>{this.toggle()}},{label:l("script"),accelerator:"\\",enabled:i,click:()=>{this.insert("script")}},{type:"separator"},{label:l("cut"),accelerator:p("X"),enabled:t,click:()=>{this.copy(),this.delete()}},{label:l("copy"),accelerator:p("C"),enabled:t,click:()=>{this.copy()}},{label:l("paste"),accelerator:p("V"),enabled:n,click:()=>{this.paste()}},{label:l("delete"),accelerator:"Delete",enabled:t,click:()=>{this.delete()}},{label:l("selectAll"),accelerator:p("A"),enabled:s,click:()=>{this.select(0,1/0)}},{label:l("undo"),accelerator:p("Z"),enabled:r,click:()=>{this.undo()}},{label:l("redo"),accelerator:p("Y"),enabled:o,click:()=>{this.redo()}}]))}doubleclick(e){var t,i;null!==this.start&&(i=(t=this.elements)[this.start].dataItem)===t[this.end].dataItem&&this.edit(i)}static alphabetCode=/^Key[A-Z]$/;static windowPointerup(e){var t=this["dragging"];t.relate(e)&&("select"===t.mode&&this.removeScrollListener(),this.dragging=null,window.off("pointerup",this.windowPointerup),window.off("pointermove",this.windowPointermove))}static windowPointermove(e){var t,i,a,n=this["dragging"];n.relate(e)&&"select"===n.mode&&(n.latest=e,0<(t=this.elements.count))&&(a=this.paddingTop,i=n["itemHeight"],e=e.getRelativeCoords(this)["y"],e=Math.floor((e-a)/i),a=Math.clamp(e,0,t-1),n.itemIndex!==a)&&(n.itemIndex=a,this.selectMultipleTo(a))}static windowVariableChange(e){for(const i of this.childNodes){var t=i["updaters"];if(void 0!==t)for(const a of t)a.update()}}}customElements.define("command-list",Re);class Fe extends HTMLElement{scriptList;headPad;metas;wraps;detailBoxes;checkBoxes;numberBoxes;textBoxes;selectBoxes;keyboardBoxes;colorBoxes;customBoxes;updateEventEnabled;windowLocalize;scriptChange;constructor(){super(),this.scriptList=null,this.headPad=null,this.metas=[],this.wraps=[],this.detailBoxes=[],this.checkBoxes=[],this.numberBoxes=[],this.textBoxes=[],this.selectBoxes=[],this.keyboardBoxes=[],this.colorBoxes=[],this.customBoxes=[],this.updateEventEnabled=!1,this.windowLocalize=Fe.windowLocalize.bind(this),this.scriptChange=Fe.scriptChange.bind(this),window.on("localize",this.windowLocalize),this.on("change",this.componentChange)}bind(t){if((this.scriptList=t)instanceof Pe){const i=t["object"],a=i["update"];this.getData=()=>t.data,i.update=(...e)=>{a.apply(i,e),this.update()}}t instanceof Ee&&(this.getData=()=>{var e=t.read();return e?[e]:[]})}rewrite(e,t){for(const s of this.wraps){var i=s.box.data,a=i.parameters;if(a===e)for(var{input:n}of s.children)if(n.key===t)return n.write(e[t]),this.scriptList?.dispatchChangeEvent(),void(n.branched&&(w.reconstruct(i),this.updateParamDisplay(s.box),this.onResize?.()))}}update(){this.clear(),this.appendHeadPad();let e=!1;var t=this.getData(),i=He.manifest.guidMap;for(const b of t){var a=i[b.id];if(a){this.metas.push(a),w.reconstruct(b)&&(e=!0);var n=a.parameters;if(n.length){var s=a.langMap.update(),r=b.parameters,o=this.createDetailBox(),{box:l,summary:c,grid:h,children:d}=o;l.meta=a,l.data=b,this.wraps.push(o),c instanceof W&&(c.textContent=s.get(a.overview.plugin)||R.parseMetaName(a));for(const y of n){var u=this.createParamInput(y),{label:p,input:m}=u,g=y.key,f=s.get(y.alias)??g,v=s.get(y.desc),v=v?f+`
`+v:"";this.updateParamInput(u,r[g]),p.textContent=f,m.setTooltip(v),m.parameters=r,m.key=g,h.appendChild(p),h.appendChild(m),d.push(u)}this.updateParamDisplay(l),this.appendChild(l)}}}e&&this.scriptList?.dispatchChangeEvent(),this.updateEventEnabled&&this.dispatchUpdateEvent(),this.onResize?.(),window.on("script-change",this.scriptChange)}appendHeadPad(){let e=this["headPad"];null===e&&((e=document.createElement("empty")).style.display="none",this.headPad=e),this.appendChild(e)}createDetailBox(){var e,t,i,a=this["detailBoxes"];return 0!==a.length?a.pop():(i={tag:"detail-box",box:a=document.createElement("detail-box"),summary:e=document.createElement("detail-summary"),grid:t=document.createElement("detail-grid"),children:[]},a.setAttribute("open",""),a.appendChild(e),a.appendChild(t),a.wrap=i)}createParamInput(e){var t=e["type"];switch(t){case"boolean":return this.createCheckBox();case"number":var i=this.createNumberBox();return i.input.input.min=e.min.toString(),i.input.input.max=e.max.toString(),i.input.decimals=e.decimals,i;case"string":return this.createTextBox();case"option":var i=this.createSelectBox();return i.input.loadItems(e.dataItems),i.input.branched=!!e.wrap,i;case"easing":var i=this.createSelectBox();return i.input.loadItems(He.createEasingItems()),i;case"team":var i=this.createSelectBox();return i.input.loadItems(He.createTeamItems()),i;case"variable":var i=this.createCustomBox();return i.input.type="global-variable",i.input.filter="",i;case"attribute":case"attribute-key":return"any"===e.filter?((i=this.createCustomBox()).input.type="attribute",i):((i=this.createSelectBox()).input.loadItems(v.getAttributeItems(e.filter,"",!0)),i);case"attribute-group":i=this.createCustomBox();return i.input.type="attribute-group",i;case"enum":case"enum-value":return"any"===e.filter?((i=this.createCustomBox()).input.type="enum-string",i):((i=this.createSelectBox()).input.loadItems(M.getStringItems(e.filter,!0)),i);case"enum-group":i=this.createCustomBox();return i.input.type="enum-group",i;case"actor":case"region":case"light":case"animation":case"particle":case"parallax":case"tilemap":i=this.createCustomBox();return i.input.type="preset-object",i.input.filter=t,i;case"element":case"element-id":i=this.createCustomBox();return i.input.type="preset-element",i.input.filter="",i;case"file":i=this.createCustomBox();return i.input.type="file",i.input.filter=e.filter,i;case"number[]":case"string[]":i=this.createCustomBox();return i.input.type="array",i.input.filter=t.slice(0,-2),i;case"keycode":return this.createKeyboardBox();case"color":return this.createColorBox()}}updateParamInput(e,t){switch(e.tag){case"check-box":case"text-box":e.input.read()!==t&&e.input.write(t);break;case"number-box":e.input.read()!==t?e.input.write(t):e.input.input.value=t.toString();break;case"keyboard-box":case"color-box":e.input.read()!==t&&e.input.write(t);break;case"select-box":case"custom-box":e.input.read()!==t?e.input.write(t):e.input.update()}}updateParamDisplay(e){var t=e.meta.manager["states"];for(const i of e.wrap.children)!1!==t[i.input.key]?(i.label.show(),i.input.show()):(i.label.hide(),i.input.hide())}createCheckBox(){var e,t=this["checkBoxes"];return 0!==t.length?t.pop():(t=document.createElement("text"),(e=new oe(!0)).inputEventEnabled=!0,e.addClass("standard"),e.addClass("large"),{tag:"check-box",label:t,input:e})}createNumberBox(){var e,t=this["numberBoxes"];return 0!==t.length?t.pop():(t=document.createElement("text"),(e=new ue).decimals=10,{tag:"number-box",label:t,input:e})}createTextBox(){var e=this["textBoxes"];return 0!==e.length?e.pop():{tag:"text-box",label:document.createElement("text"),input:new $}}createSelectBox(){var e=this["selectBoxes"];return 0!==e.length?e.pop():{tag:"select-box",label:document.createElement("text"),input:new pe}}createKeyboardBox(){var e=this["keyboardBoxes"];return 0!==e.length?e.pop():{tag:"keyboard-box",label:document.createElement("text"),input:new se}}createColorBox(){var e=this["colorBoxes"];return 0!==e.length?e.pop():{tag:"color-box",label:document.createElement("text"),input:new re}}createCustomBox(){var e=this["customBoxes"];return 0!==e.length?e.pop():{tag:"custom-box",label:document.createElement("text"),input:new be}}recycle(t){switch(t.tag){case"detail-box":{var i=t["children"];let e=i.length;for(;0<=--e;)this.recycle(i[e]);i.length=0,t.box.meta=null,t.box.data=null,this.detailBoxes.push(t);break}case"check-box":t.label.remove(),t.input.remove(),t.input.parameters=null,t.input.key=null,this.checkBoxes.push(t);break;case"number-box":t.label.remove(),t.input.remove(),t.input.parameters=null,t.input.key=null,this.numberBoxes.push(t);break;case"text-box":t.label.remove(),t.input.remove(),t.input.parameters=null,t.input.key=null,this.textBoxes.push(t);break;case"select-box":t.label.remove(),t.input.remove(),t.input.parameters=null,t.input.key=null,t.input.clear(),this.selectBoxes.push(t);break;case"keyboard-box":t.label.remove(),t.input.remove(),t.input.parameters=null,t.input.key=null,this.keyboardBoxes.push(t);break;case"color-box":t.label.remove(),t.input.remove(),t.input.parameters=null,t.input.key=null,0===t.input.tabIndex&&this.colorBoxes.push(t);break;case"custom-box":t.label.remove(),t.input.remove(),t.input.parameters=null,t.input.key=null,0===t.input.tabIndex&&this.customBoxes.push(t)}}clear(){this.metas=[];var e=this["wraps"];let t=e.length;if(0!==t){for(;0<=--t;)this.recycle(e[t]);e.length=0,super.clear()}this.scriptList?.data||window.off("script-change",this.scriptChange)}on(e,t,i){super.on(e,t,i),"update"===e&&(this.updateEventEnabled=!0)}componentChange(e){let t=e.target;var i,a,{parameters:e,key:n}=t="INPUT"===t.tagName?t.parentNode:t,s=this["scriptList"];s instanceof Pe&&(a=s["history"],i=a["editor"],i)&&a.save({type:"script-parameter-change",editor:i,target:i.target,meta:i.meta,list:this,parameters:e,key:n,value:e[n]}),e[n]=t.read(),s?.dispatchChangeEvent(1),t.branched&&(a=t.parentNode.parentNode,w.reconstruct(a.data),this.updateParamDisplay(a),this.onResize?.())}static windowLocalize(e){for(var{langMap:t}of this.metas)if(t.active!==t.update().active)return this.update()}static scriptChange(e){for(const t of this.metas)if(t===e.changedMeta)return this.contains(ge.target)&&ge.close(),void this.update()}}customElements.define("parameter-pane",Fe);class ze extends HTMLElement{target;type;thumb;timer;dragging;windowPointerup;windowPointermove;constructor(){super(),this.target=null,this.type=null,this.thumb=null,this.timer=null,this.dragging=null,this.windowPointerup=ze.windowPointerup.bind(this),this.windowPointermove=ze.windowPointermove.bind(this),this.on("pointerdown",this.pointerdown)}bind(e,t){switch(this.appendChild(this.thumb=document.createElement("scroll-thumb")),this.thumb.appendChild(document.createElement("scroll-thumb-inner")),this.target=e,this.type=t,this.addClass(t),t){case"horizontal":this.thumb.style.height="100%";break;case"vertical":this.thumb.style.width="100%"}}updateHorizontalBar(){var e=this.target,t=e.clientWidth,i=e.scrollWidth;t<i?(e=e.scrollLeft,e=Math.roundTo(e/i*100,6),t=Math.roundTo(t/i*100,6),this.updateHorizontalThumb(e,t),this.updateDisplay(!0)):this.updateDisplay(!1)}updateVerticalBar(){var e=this.target,t=e.clientHeight,i=e.scrollHeight;t<i?(e=e.scrollTop,e=Math.roundTo(e/i*100,6),t=Math.roundTo(t/i*100,6),this.updateVerticalThumb(e,t),this.updateDisplay(!0)):this.updateDisplay(!1)}updateHorizontalThumb(e,t){var i=this.thumb;i.left!==e&&(i.left=e,i.style.left=e+"%"),i.width!==t&&(i.width=t,i.style.width=t+"%")}updateVerticalThumb(e,t){var i=this.thumb;i.top!==e&&(i.top=e,i.style.top=e+"%"),i.height!==t&&(i.height=t,i.style.height=t+"%")}updateDisplay(e){if(this.visible!==e)switch(this.visible=e){case!0:this.addClass("visible");break;case!1:this.removeClass("visible")}}scrollRelative(e){const c=this["target"];let t=this["timer"];t=t||(this.timer=new f({duration:0,update:t=>{switch(t.state){case"wait":var i=this["dragging"];if(!i)return!1;if(i.target!==this)break;var a=this.type,n=this.thumb.rect(),e=t.offset;if("horizontal"===a){var s=i["clientX"],{left:r,right:o}=n;if(!(e<0&&s<r||0<e&&o<s))break}if("vertical"===a){var r=i["clientY"],{top:o,bottom:s}=n;if(!(e<0&&r<o||0<e&&s<r))break}t.state="repeat",t.elapsed=f.deltaTime,t.duration=Math.abs(e)/5,t.start=t.end,t.end+=e;case"first":case"repeat":{var{elapsed:a,duration:i}=t,{start:n,end:o,offset:s}=t,r=a/i,l=n*(1-r)+o*r;let e;switch(this.type){case"horizontal":e=c.scrollWidth-c.clientWidth,c.setScrollLeft(l);break;case"vertical":e=c.scrollHeight-c.clientHeight,c.setScrollTop(l)}if(s<0&&l<=0||0<s&&l>=e)return!1;break}}},callback:e=>{if(this.dragging)switch(e.state){case"first":return e.state="delay",e.elapsed=0,e.duration=100,!0;case"delay":case"repeat":return e.state="wait",e.duration=1/0,!0}}}));let i,a;switch(this.type){case"horizontal":i=c.scrollLeft,a=c.clientWidth*e;break;case"vertical":i=c.scrollTop,a=c.clientHeight*e}t.state="first",t.elapsed=0,t.duration=Math.abs(a)/10,t.start=i,t.end=i+a,t.offset=a,t.add()}pointerdown(e){if(!this.dragging&&0===e.button){if(this.target.focus(),e.preventDefault(),e.stopImmediatePropagation(),e.target===this.thumb)(this.dragging=e).mode="scroll",e.scrollLeft=this.target.scrollLeft,e.scrollTop=this.target.scrollTop;else{var t=this.thumb.rect();switch(this.type){case"horizontal":this.scrollRelative(e.clientX<t.left?-1:1);break;case"vertical":this.scrollRelative(e.clientY<t.top?-1:1)}(this.dragging=e).mode="repeat"}window.on("pointerup",this.windowPointerup),window.on("pointermove",this.windowPointermove)}}static windowPointerup(e){var t=this["dragging"];t.relate(e)&&(t.mode,this.dragging=null,window.off("pointerup",this.windowPointerup),window.off("pointermove",this.windowPointermove))}static windowPointermove(e){var t=this["dragging"];if(t.relate(e))switch(t.mode){case"scroll":var i=this.target;switch(this.type){case"horizontal":0!==this.clientWidth&&i.setScrollLeft(t.scrollLeft+(e.clientX-t.clientX)*i.scrollWidth/this.clientWidth);break;case"vertical":0!==this.clientHeight&&i.setScrollTop(t.scrollTop+(e.clientY-t.clientY)*i.scrollHeight/this.clientHeight)}break;case"repeat":(this.dragging=e).mode="repeat"}}}customElements.define("scroll-bar",ze);class Be extends HTMLElement{display;directory;dragging;filters;backupFolders;searchResults;nav;head;body;links;constructor(){super(),this.display="normal",this.directory=null,this.dragging=null,this.filters=null,this.keyword=null,this.backupFolders=[],this.searchResults=[],this.nav=document.createElement("file-nav-pane"),this.head=document.createElement("file-head-pane"),this.body=document.createElement("file-body-pane"),this.appendChild(this.nav),this.appendChild(this.head),this.appendChild(this.body),Promise.resolve().then(()=>{var e=this.nav,t=this.head,i=this.body,a={browser:this,nav:e,head:t,body:i};this.links=a,e.links=a,t.links=a,i.links=a}),this.on("pointerdown",this.pointerdown),this.on("dragstart",this.dragstart),this.on("dragend",this.dragend),window.on("os-dragstart",this.osDragstart.bind(this)),window.on("os-dragend",this.osDragend.bind(this)),window.on("dirchange",this.dirchange.bind(this))}update(){this.body.updateFiles(),this.head.updateAddress()}searchFiles(e){var t=this["nav"];e instanceof RegExp||0!==e.length?("normal"===this.display&&(this.display="search",this.backupFolders=t.selections,t.unselect()),"string"==typeof e&&(e=e.replace(/[(){}\\^$*+?.|[\]]/g,"\\$&"),e=new RegExp(e,"i")),h.searchFiles(this.filters,this.keyword=e,this.directory,this.searchResults=[]),this.update()):"search"===this.display&&(this.display="normal",t.load(...this.backupFolders),this.keyword=null,this.backupFolders=[],this.searchResults=[])}restoreDisplay(){switch(this.display){case"normal":break;case"search":this.display="normal",this.backupFolders=[],this.searchResults=[],this.head.searcher.write("")}}backToParentFolder(){switch(this.display){case"normal":var e,t=this["nav"],i=t.selections;1===i.length&&-1!==(e=(i=i[0].path).lastIndexOf("/"))&&t.load(h.getFolder(i.slice(0,e)));break;case"search":t=document.activeElement;this.head.searcher.deleteInputContent(),t.focus()}}dirchange(e){switch(this.display){case"normal":break;case"search":this.searchFiles(this.keyword)}var i=this.body,a=Array.from(i.selections);if(0!==a.length){var n=h["inoMap"];let e=!1,t=a.length;for(;0<=--t;){var s=a[t],r=n[s.stats.ino];s!==r&&(e=!0,r?a[t]=r:a.splice(t,1))}e&&i.select(...a)}}close(){this.directory&&(this.directory=null,this.restoreDisplay(),this.nav.clear(),this.head.address.clear(),this.body.clear())}getActivePage(e){var{nav:t,body:i}=this;return t.contains(e.target)?t:i.contains(e.target)?i:null}pointerdown(e){switch(this.dragging?.mode){case"drag":return this.dragend();case"os-drag":return this.osDragend()}}dragstart(e){var t,i,a=this.getActivePage(e);a&&!this.dragging&&(a.pressing&&(a.pressing=null),(t=a.selections).includes(h.assets)||a.textBox.parentNode||(i=(a=t.map(e=>e.path)).map(e=>R.route(e)),(this.dragging=e).mode="drag",e.preventDefault=Function.empty,e.allowMove=!1,e.allowCopy=!1,e.dropTarget=null,e.dropPath=null,e.dropMode=null,e.files=t,e.filePaths=a,e.promise=h.readdir(i),e.promise.then(e=>{0===e.length&&this.dragend()}),e.dataTransfer.effectAllowed="copyMove",e.dataTransfer.hideDragImage(),this.on("dragenter",this.dragover),this.on("dragleave",this.dragleave),this.on("dragover",this.dragover),this.on("drop",this.drop),1===t.length&&t[0]instanceof q&&e.dataTransfer.setData("DownloadURL",`application/octet-stream:${t[0].name}:`+i[0])))}dragend(e){var t;this.dragging&&(t=this.dragging["dropTarget"],t instanceof HTMLElement&&t.removeClass("drop-target"),this.dragging=null,this.off("dragenter",this.dragover),this.off("dragleave",this.dragleave),this.off("dragover",this.dragover),this.off("drop",this.drop))}dragleave(e){var t=this["dragging"];t?.dropTarget&&!this.contains(e.relatedTarget)&&(t.dropTarget.removeClass("drop-target"),t.dropTarget=null)}dragover(e){const s=this["dragging"];if(s){var t=s["dropTarget"];let n=e.target;for(s.allowCopy||s.target.contains(n)||(s.allowCopy=!0);!(n instanceof Be||n instanceof Ne||n instanceof De||n.file instanceof B);)n=n.parentNode;t!==n&&(t instanceof HTMLElement&&t.removeClass("drop-target"),s.allowMove=!1,(s.dropTarget=n).file instanceof B?(n.addClass("drop-target"),s.dropPath=n.file.path,s.promise.then(e=>{var t=n.file["path"],i=s["filePaths"];for(const a of i)if(t===a||0===t.indexOf(a)&&"/"===t[a.length])return!0;return h.existFiles(t,e)}).then(e=>{e||s.dropTarget!==n||(s.allowMove=!0)})):n instanceof De?(t=this.nav["selections"],s.dropPath=1===t.length?t[0].path:null):s.dropPath=null),s.dropPath&&(e.cmdOrCtrlKey?s.allowCopy&&(s.dropMode="copy",e.dataTransfer.dropEffect="copy",e.preventDefault()):s.allowMove&&(s.dropMode="move",e.dataTransfer.dropEffect="move",e.preventDefault()))}}drop(e){const t=this["dragging"];if(t&&(e.stopPropagation(),t.dropPath)){const s=R.route(t.dropPath);var i=E.basename(s),a=N.createGetter("menuFileOnDrop"),n=[];switch(t.dropMode){case"move":n.push({label:a("moveTo").replace("<dirName>",i),click:()=>{t.promise.then(e=>h.moveFiles(s,e)).finally(()=>{h.update()})}});break;case"copy":n.push({label:a("copyTo").replace("<dirName>",i),click:()=>{t.promise.then(e=>h.saveFiles(t.files).then(()=>h.copyFiles(s,e))).finally(()=>{h.update()})}})}ve.popup({x:e.clientX,y:e.clientY},n),this.dragend()}}osDragstart(e){this.dragging||((this.dragging=e).mode="os-drag",e.dropTarget=null,e.dropPath=null,this.on("dragenter",this.osDragover),this.on("dragleave",this.osDragleave),this.on("dragover",this.osDragover),this.on("drop",this.osDrop))}osDragend(e){var t;this.dragging&&(t=this.dragging["dropTarget"],t instanceof HTMLElement&&t.removeClass("drop-target"),this.dragging=null,this.off("dragenter",this.osDragover),this.off("dragleave",this.osDragleave),this.off("dragover",this.osDragover),this.off("drop",this.osDrop))}osDragleave(e){return this.dragleave(e)}osDragover(t){var i=this["dragging"];if(i){var a=i["dropTarget"];let e=t.target;for(;!(e instanceof Be||e instanceof Ne||e instanceof De||e.file instanceof B);)e=e.parentNode;a!==e&&(a instanceof HTMLElement&&a.removeClass("drop-target"),(i.dropTarget=e).file instanceof B?(e.addClass("drop-target"),i.dropPath=e.file.path):e instanceof De?(a=this.nav["selections"],i.dropPath=1===a.length?a[0].path:null):i.dropPath=null),i.dropPath&&(t.preventDefault(),t.dataTransfer.dropEffect="copy")}}osDrop(e){e=e.dataTransfer.files;if(0!==e.length){var i=this["dragging"];if(i){let t=i["dropPath"];t&&(t=R.route(t),i=Array.prototype.map.call(e,e=>e.path),h.readdir(i).then(e=>h.copyFiles(t,e,"")).finally(()=>{h.update()}))}}}}customElements.define("file-browser",Be);class Ne extends HTMLElement{timer;elements;selections;pressing;selectEventEnabled;textBox;constructor(){super();var e=new f({duration:500,callback:e=>{var t,i=this.selections;1===i.length&&(i=i[0],t=e.target,i.getContext(this).element.contains(t))&&this.rename(i),e.target=null,e.running=!1}});this.tabIndex=-1,this.timer=e,this.elements=[],this.elements.versionId=0,this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.elements.head=null,this.elements.foot=null,this.selections=[],this.pressing=null,this.selectEventEnabled=!1,this.textBox=Ne.textBox,this.listenDraggingScrollbarEvent(),this.on("scroll",this.resize),this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown),this.on("pointerup",this.pointerup),this.on("doubleclick",this.doubleclick),this.on("select",this.listSelect),window.on("dirchange",this.dirchange.bind(this))}load(...e){this.select(...e);for(var t of e)for(;t=t.parent;)t.getContext(this).expanded=!0;this.update()}update(){var e=this["elements"],t=(e.start=-1,e.count=0,this.parentNode)["directory"];t&&this.createItems(t,0),this.clearElements(e.count),this.resize()}resize(){return Se.resize(this)}updateHeadAndFoot(){return Se.updateHeadAndFoot(this)}updateOnResize(e){e.changed&&(e.changed=!1,this.updateFolderElement(e))}createItems(t,i){void 0===t.sorted&&(t.sorted=!0,h.sortFiles(t));var a=this.elements,n=t.length;for(let e=0;e<n;e++){var s=t[e],r=(a[a.count++]=this.createFolderElement(s,i),s.getContext(this));r.expanded&&s.subfolders&&this.createItems(s.subfolders,i+1)}}createFolderElement(e,t){var i=e.getContext(this);let a=i.element;return void 0===a&&((a=document.createElement("file-nav-item")).file=e,(a.context=i).element=a,i=this["selections"],0!==i.length)&&i.includes(e)&&a.addClass("selected"),a.indent=t,a.changed=!0,a}updateFolderElement(e){var{file:t,context:i}=e,a=(e.textNode||(a=document.createElement("folder-mark"),e.appendChild(a),(n=document.createElement("file-nav-icon")).addClass("icon-folder"),e.appendChild(n),s=document.createTextNode(t.name),e.appendChild(s),e.draggable=!0,e.expanded=!1,e.markVisible=!0,e.textIndent=0,e.folderMark=a,e.fileIcon=n,e.textNode=s),0!==t.subfolders.length),n=(e.markVisible!==a&&(e.markVisible=a,e.folderMark.style.visibility=a?"inherit":"hidden"),a&&i.expanded);if(e.expanded!==n)switch(e.expanded=n){case!0:e.folderMark.addClass("expanded"),e.fileIcon.addClass("expanded");break;case!1:e.folderMark.removeClass("expanded"),e.fileIcon.removeClass("expanded")}var s=12*e.indent;e.textIndent!==s&&(e.textIndent=s,e.style.textIndent=s+"px")}select(...e){this.unselect();for(const a of this.selections=e){var t=a.getContext(this).element;void 0!==t&&t.addClass("selected")}var i;this.selectEventEnabled&&((i=new Event("select")).value=e,this.dispatchEvent(i))}unselect(){var e=this.selections;if(0!==e.length){Ne.textBox.input.blur();for(const i of e){var t=i.getContext(this).element;void 0!==t&&t.removeClass("selected")}this.selections=[]}}selectRelative(a){var n=this.elements,s=n.count;if(0<s){let e,t=1/0,i=-1/0;var r=s-1,s=this["selections"];for(const l of s){var o=l.getContext(this)["element"],o=n.indexOf(o);-1!==o&&(t=Math.min(t,o),i=Math.max(i,o))}switch(a){case"up":e=Math.clamp(t-1,0,r);break;case"down":e=Math.clamp(i+1,0,r)}a=n[e]?.file;1===s.length&&s[0]===a||this.select(a),this.scrollToSelection()}}scrollToSelection(i="active"){var e=this["selections"];if(1===e.length&&this.hasScrollBar()){var a=e[0],n=this.elements,s=n.count;for(let t=0;t<s;t++)if(n[t].file===a){let e;switch(i){case"active":e=Math.clamp(this.scrollTop,20*t+20-this.innerHeight,20*t);break;case"middle":e=20*Math.round((20*t+10-this.innerHeight/2)/20);break;default:return}this.scrollTop!==e&&(this.scrollTop=e);break}}}getSelections(){var e=this.links["browser"];switch(e.display){case"normal":return this.selections;case"search":return e.backupFolders}}rename(e){var t,i=Ne["textBox"];document.activeElement!==this||e===h.assets||i.parentNode||(t=e.getContext(this).element)&&t.parentNode&&(t.textNode.nodeValue="",t.appendChild(i),i.write(e.name),i.getFocus("all"),i.fitContent())}cancelRenaming(){var e=this["timer"];e.target&&(e.target=null),e.running&&(e.running=!1,e.remove())}clearElements(e){var t=this["elements"];256<t.length&&t.length!==e&&(t.length=e);let i=e;for(;void 0!==t[i];)t[i++]=void 0}clear(){return this.unselect(),this.textContent="",this.clearElements(0),this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.updateHeadAndFoot(),this}on(e,t,i){super.on(e,t,i),"select"===e&&(this.selectEventEnabled=!0)}keydown(e){if(e.cmdOrCtrlKey){switch(e.code){case"ArrowUp":this.scrollTop-=20;break;case"ArrowDown":this.scrollTop+=20;break;default:return}e.stopImmediatePropagation()}else if(!e.altKey){switch(e.code){case"Space":e.preventDefault(),this.links.body.content.focus();break;case"ArrowRight":e.preventDefault();var t=this.selections;1===t.length&&0!==(t=t[0]).subfolders.length&&((t=t.getContext(this)).expanded=!t.expanded,this.update());break;case"ArrowUp":e.preventDefault(),this.selectRelative("up");break;case"ArrowDown":e.preventDefault(),this.selectRelative("down");break;case"F2":t=this.selections;1===t.length&&(this.cancelRenaming(),this.rename(t[0]));break;default:return}e.stopImmediatePropagation()}}pointerdown(e){switch(this.cancelRenaming(),e.button){case 0:case 2:{let i=e.target;if("FOLDER-MARK"===i.tagName)e.preventDefault(),0===e.button&&((a=i.parentNode.file.getContext(this)).expanded=!a.expanded,this.update());else if("FILE-NAV-ITEM"===(i="FILE-NAV-ICON"===i.tagName?i.parentNode:i).tagName){var a=this.selections,t=a.length;if(e.cmdOrCtrlKey&&0!==t){const r=Array.from(a);if(a.includes(i.file)){if(1<t){r.remove(i.file);const o=e=>{this.pressing===o&&(this.pressing=null,i.contains(e.target))&&this.select(...r)};this.pressing=o,window.on("pointerup",o,{once:!0})}}else r.append(i.file),this.select(...r);return}if(e.shiftKey&&0!==t){var n=this.elements;let e=n.indexOf(i),t=e;for(const l of a){var s=l.getContext(this)["element"],s=n.indexOf(s);-1!==s&&(e=Math.min(e,s),t=Math.max(t,s))}if(-1!==e)return a=n.slice(e,t+1),void this.select(...a.map(e=>e.file))}if(i.hasClass("selected")){if(0===e.button)if(1<t){const c=e=>{this.pressing===c&&(this.pressing=null,i.contains(e.target))&&this.select(i.file)};this.pressing=c,window.on("pointerup",c,{once:!0})}else"closed"===ve.state&&document.activeElement===this&&e.clientX>i.fileIcon.rect().right&&(this.timer.target=e.target)}else this.select(i.file)}break}}}pointerup(e){0===e.button&&document.activeElement===this&&this.timer.target===e.target&&(this.timer.running=!0,this.timer.elapsed=0,this.timer.add())}doubleclick(e){let t=e.target;"FILE-NAV-ITEM"===(t="FILE-NAV-ICON"===t.tagName?t.parentNode:t).tagName&&(this.cancelRenaming(),0!==(e=t.file).subfolders.length)&&((e=e.getContext(this)).expanded=!e.expanded,this.update())}listSelect(e){var t=this.links["browser"];t.restoreDisplay(),t.update()}dirchange(e){var t=[],i=h["inoMap"];for(const s of this.getSelections()){var a=s.stats["ino"],a=(i[a]||s)["path"];t.append(h.getFolder(a))}var n=this.links["browser"];switch(n.display){case"normal":this.unselect(),this.load(...t);break;case"search":this.update()}}static textBox=(e=new $,e.setMaxLength(64),e.addClass("file-nav-text-box"),e.input.addClass("file-nav-text-box-input"),e.on("keydown",function(e){switch(e.stopPropagation(),e.code){case"Enter":case"NumpadEnter":case"Escape":var t=this.parentNode.parentNode;this.input.blur(),t.focus()}}),e.on("beforeinput",function(e){"insertText"===e.inputType&&"string"==typeof e.data&&/[\\/:*?"<>|"]/.test(e.data)&&(e.preventDefault(),e.stopPropagation())}),e.on("input",function(e){this.fitContent()}),e.on("select",function(e){e.stopPropagation()}),e.on("blur",function(e){const t=this.parentNode,i=t.file;var a=this.read().trim();if(this.remove(),a&&a!==i.name){var n=E.dirname(i.path),n=R.route(n+"/"+a);if(!F.existsSync(n))return z.rename(R.route(i.path),n).then(()=>h.update()).then(e=>{if(!e)throw new Error}).catch(e=>{t.textNode.nodeValue=i.name})}t.textNode.nodeValue=i.name}),e)}customElements.define("file-nav-pane",Ne);class qe extends HTMLElement{address;searcher;view;constructor(){super(),this.address=document.createElement("file-head-address"),this.back=document.createElement("item"),this.back.addClass("upper-level-directory"),this.back.name="back",this.back.textContent="",this.searcher=new $,this.searcher.addCloseButton(),this.searcher.addClass("file-head-searcher"),this.searcher.name="search",this.view=new de,this.view.addClass("file-head-view"),this.view.name="view",this.view.input.max="4",this.view.activeWheel=!0,this.appendChild(this.address),this.appendChild(this.back),this.appendChild(this.searcher),this.appendChild(this.view),this.on("pointerdown",this.pointerdown),this.address.on("pointerdown",this.addressPointerdown),this.back.on("click",this.backButtonClick),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),this.view.on("focus",this.viewFocus),this.view.on("input",this.viewInput)}updateAddress(){var{browser:e,nav:t,body:i}=this.links,a=t.selections,n=this.address.clear();switch(e.display){case"normal":if(1===a.length){let e=a[0];for(var s=[];;){var r=document.createElement("file-head-address-folder"),r=(r.file=e,r.textContent=e.name,s.push(r),e)["parent"];if(!(r instanceof B))break;var o=document.createElement("file-head-address-arrow");o.folders=r.subfolders,o.target=e,s.push(o),e=r}s[0].disabled=!0;for(const u of s.reverse())n.appendChild(u)}else if(1<a.length){var l=a.length;for(let e=0;e<l;e++){var c=a[e],h=document.createElement("file-head-address-folder");h.file=c,h.textContent=c.name,n.appendChild(h),a[e+1]&&((c=document.createElement("file-head-address-link")).textContent="&",n.appendChild(c))}}break;case"search":var d=document.createElement("file-head-address-text");d.textContent=i.elements.count+" 个文件",n.appendChild(d)}}pointerdown(e){e.target instanceof HTMLInputElement||(e.preventDefault(),e=this.links.body["content"],document.activeElement!==e&&e.focus())}addressPointerdown(e){switch(e.button){case 0:{const c=e.target;if(c.parentNode===this){if(c.hasClass("active"))return;window.on("pointerup",e=>{if(0===e.button&&c===e.target){const l=this.parentNode.links.nav;switch(c.tagName){case"FILE-HEAD-ADDRESS-FOLDER":c.disabled||(l.load(c.file),l.scrollToSelection("middle"));break;case"FILE-HEAD-ADDRESS-ARROW":var{folders:t,target:i}=c,a=c.rect(),n=Math.min(t.length,32),s=new Array(n),r=function(){l.load(this.folder),l.scrollToSelection("middle")};for(let e=0;e<n;e++){var o=t[e];s[e]={label:o.name,checked:o===i,folder:o,click:r}}32<t.length&&s.push({label:"...",enabled:!1}),c.addClass("active"),ve.popup({x:a.left,y:a.bottom,close:()=>{c.removeClass("active")}},s)}}},{once:!0})}break}}}backButtonClick(e){var t=this.parentNode.links["browser"];t.backToParentFolder()}searcherInput(e){var t;"insertCompositionText"!==e.inputType&&(e=this.parentNode,t=this.input.value,e.links.browser.searchFiles(t))}viewFocus(e){this.parentNode.links.body.content.focus()}viewInput(e){this.parentNode.links.body.setViewIndex(this.read())}}customElements.define("file-head-pane",qe);class De extends HTMLElement{viewIndex;viewMode;timer;elements;selections;content;pressing;openEventEnabled;selectEventEnabled;unselectEventEnabled;popupEventEnabled;textBox;constructor(){super();var e=new f({duration:500,callback:e=>{var t,i=this.selections;1===i.length&&(i=i[0],t=e.target,i.getContext(this).element.contains(t))&&this.rename(i),e.target=null,e.running=!1}});this.viewIndex=null,this.viewMode=null,this.timer=e,this.elements=[],this.elements.versionId=0,this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.selections=[],this.content=document.createElement("file-body-content"),this.content.tabIndex=0,this.content.range=new Uint32Array(2),this.pressing=null,this.openEventEnabled=!1,this.selectEventEnabled=!1,this.unselectEventEnabled=!1,this.popupEventEnabled=!1,this.textBox=De.textBox,this.listenDraggingScrollbarEvent(),this.appendChild(this.content);const t=this["elements"];Object.defineProperty(this.content,"countPerLine",{get:function(){return t.count<this.scrollCount?this.normalCountPerLine:this.scrollCountPerLine}}),this.on("scroll",this.resize),this.on("keydown",this.keydown),this.on("pointerdown",this.pointerdown),this.on("pointerup",this.pointerup),this.on("doubleclick",this.doubleclick),this.on("wheel",this.wheel)}setViewIndex(e){var t;e=Math.clamp(e,0,4),this.viewIndex!==e&&(t=this.links["head"],this.viewIndex=e,t.view.write(e),this.updateViewMode())}updateViewMode(){let e=null;switch(this.viewIndex){case 0:e="list";break;case 1:e="small";break;case 2:e="medium";break;case 3:e="large";break;case 4:e="huge"}this.viewMode!==e&&("list"===e?this.addClass("horizontal"):this.removeClass("horizontal"),this.content.removeClass(this.viewMode),this.content.addClass(e),this.resetContentStyle(),this.viewMode=e,this.computeGridProperties(),this.resize(),this.updateContentOffset())}getFiles(){var{browser:e,nav:i}=this.links,i=i.selections,t=e.filters;if(!t){let e=0;for(const n of i)e+=n.children.length;let t=0;const a=new Array(e);for(const s of i)for(const r of s.children)a[t++]=r;return a}const a=[];for(const o of i)for(const l of o.children)(l instanceof B||t.includes(l.type))&&a.push(l);return a}updateFiles(){var e=this["elements"],t=(e.start=-1,e.count=0,this.links)["browser"];switch(t.display){case"normal":this.createFlatItems(this.getFiles());break;case"search":this.createFlatItems(t.searchResults)}this.clearElements(e.count),this.resize()}resize(){var e=this.clientHeight,t=this.elements;if(0!==e){var[i,a]=this.computeStartAndEnd();if(this.updateContentSize(),t.start!==i||t.end!==a){t.start=i,t.end=a,this.updateContentOffset();var n=t.versionId++;for(let e=i;e<a;e++){var s=t[e];s.versionId=n,this.updateOnResize(s)}var r=this.content,o=r.childNodes;for(let e=o.length-1;0<=e;e--){var l=o[e];l.versionId!==n&&l.remove()}e=t[a-1];e&&!e.parentNode&&r.appendChild(e);for(let e=a-2;e>=i;e--){var c,h=t[e];null===h.parentNode&&(c=t[e+1],r.insertBefore(h,c))}}}}computeGridProperties(){switch(this.content.count=-1,this.viewMode){case"list":return this.computeListGridProperties();case"small":return this.computeTileGridProperties(40,72);case"medium":return this.computeTileGridProperties(72,104);case"large":return this.computeTileGridProperties(136,168);case"huge":return this.computeTileGridProperties(264,296)}}computeListGridProperties(){var e=this["content"],t=this.rect(),i=t.width,t=t.height,a=Math.max(i-8+2,0),t=Math.max(t-8,0),i=Math.ceil((i+2)/242)+1,n=Math.max(Math.floor(t/20),1),t=Math.max(Math.floor((t-12)/20),1),a=Math.floor(a/242)*n+1;e.itemSize=242,e.visibleLines=i,e.normalCountPerLine=n,e.scrollCountPerLine=t,e.scrollCount=a}computeTileGridProperties(e,t){var i=this["content"],a=this.rect(),n=a.width,a=a.height,n=Math.max(n-8+2,0),s=Math.max(a-8+2,0),e=e+2,t=t+2,a=Math.ceil((a+2)/t)+1,r=Math.max(Math.floor(n/e),1),n=Math.max(Math.floor((n-12)/e),1),e=Math.floor(s/t)*r+1;i.itemSize=t,i.visibleLines=a,i.normalCountPerLine=r,i.scrollCountPerLine=n,i.scrollCount=e}computeStartAndEnd(){var e=this.content["range"],t=this.elements["count"],i="list"===this.viewMode?Math.max(this.scrollLeft-4,0):Math.max(this.scrollTop-4,0),{countPerLine:a,itemSize:n,visibleLines:s}=this.content,r=Math.ceil(t/a),i=a*Math.clamp(Math.floor(i/n),0,r-1),n=Math.min(i+a*s,t);return e[0]=i,e[1]=n,e}updateContentSize(){var e,t,i=this["content"],a=this.elements["count"];0!==this.clientHeight&&i.count!==a&&(i.count=a,{style:i,countPerLine:t,itemSize:e}=i,a=Math.ceil(a/t),t=Math.max(a*e-2,0)+8,"list"===this.viewMode?i.width=t+"px":i.height=t+"px")}updateContentOffset(){var e=this.elements["start"],{style:t,countPerLine:i,itemSize:a}=this.content,e=e/i*a+4;"list"===this.viewMode?t.paddingLeft=e+"px":t.paddingTop=e+"px"}resetContentStyle(){this.content.count=-1;var e=this.content["style"];"list"===this.viewMode?(e.width="",e.paddingLeft=""):(e.height="",e.paddingTop="")}updateOnResize(e){var t;e.changed&&(e.changed=!1,t=e["file"],t instanceof q?this.updateFileElement(e):t instanceof B&&this.updateFolderElement(e))}createFlatItems(t){h.sortFiles(t);var i=this.elements,a=t.length;for(let e=0;e<a;e++){var n=t[e];n instanceof q?i[i.count++]=this.createFileElement(n):n instanceof B&&(i[i.count++]=this.createFolderElement(n))}}createFolderElement(e){var t=e.getContext(this);let i=t.element;return void 0===i&&((i=document.createElement("file-body-item")).file=e,(i.context=t).element=i,t=this["selections"],0!==t.length)&&t.includes(e)&&i.addClass("selected"),i.changed=!0,i}updateFolderElement(e){var t,i;e.nameBox||((t=document.createElement("file-body-icon")).addClass("icon-folder"),e.appendChild(t),(i=document.createElement("file-body-name")).textContent=e.file.name,e.appendChild(i),e.draggable=!0,e.fileIcon=t,e.nameBox=i)}createFileElement(e){var t=e.getContext(this);let i=t.element;return void 0===i&&((i=document.createElement("file-body-item")).file=e,(i.context=t).element=i),i.changed=!0,i}updateFileElement(e){var t,i,a=e["file"];e.nameBox||(i=this.createIcon(a),e.appendChild(i),i=((t=document.createElement("file-body-name")).textContent=a.basename,e.appendChild(t),e.draggable=!0,e.fileIcon=i,e.nameBox=t,this)["selections"],0!==i.length&&i.includes(a)&&e.addClass("selected")),e.fileIcon.isImageChanged?.()&&this.updateIcon(a)}createIcon(e){const i=document.createElement("file-body-icon");switch(e.type){case"actor":{var t=e.data;if(!t?.portrait){i.addClass("icon-file-actor");break}const o=He.manifest.guidMap[t.portrait];var[a,n,s,r]=t.clip;if(!o||s*r==0)break;const l=o.mtimeMs;t=R.getPath(t.portrait)+"?ver="+l;i.isImageChanged=()=>l!==o.mtimeMs,this.setIconClip(i,t,a,n,s,r);break}case"skill":case"item":case"equipment":case"state":{t=e.data;if(!t?.icon){i.addClass("icon-file-cube");break}const c=He.manifest.guidMap[t.icon];var[a,n,s,r]=t.clip;if(!c||s*r==0)break;const h=c.mtimeMs;t=R.getPath(t.icon)+"?ver="+h;i.isImageChanged=()=>h!==c.mtimeMs,this.setIconClip(i,t,a,n,s,r);break}case"trigger":i.addClass("icon-file-trigger");break;case"event":i.addClass("icon-file-event"),i.textContent="EV",e.data?.enabled||i.addClass("disabled");break;case"scene":i.addClass("icon-file-scene");break;case"tileset":i.addClass("icon-file-tileset");break;case"ui":i.addClass("icon-file-ui");break;case"animation":i.addClass("icon-file-animation");break;case"particle":i.addClass("icon-file-particle");break;case"image":t=e.stats.mtimeMs,a=e.path+"?ver="+t;i.style.backgroundImage=CSS.encodeURL(R.route(a)),R.getImageResolution(a).then(({width:e,height:t})=>{e<=128&&t<=128&&(i.style.imageRendering="pixelated")});break;case"audio":i.addClass("icon-file-event"),i.addClass("icon-file-audio"),i.textContent="";break;case"video":i.addClass("icon-file-event"),i.addClass("icon-file-video"),i.textContent="";break;case"font":i.addClass("icon-file-font");break;case"script":switch(i.addClass("icon-file-event"),i.addClass("icon-file-script"),e.extname){case".js":i.textContent="JS";break;case".ts":i.textContent="TS"}break;default:i.addClass("icon-file-other"),i.textContent=e.extname.slice(1)}return i}updateIcon(e){var t=e.getContext(this)["element"];t?.fileIcon&&(e=this.createIcon(e),t.replaceChild(e,t.fileIcon),t.fileIcon=e)}setIconClip(s,r,o,l,c,h){R.getImageResolution(r).then(({width:e,height:t})=>{var i,a,n;c<0&&(c=Math.floor(e/-c),h=Math.floor(t/-h),c*h==0)||(c!==h&&(h<c?(i=100*(a=(c-h)/2)/c,l-=a,s.style.clipPath=`polygon(0 ${i}%, 100% ${i}%, 100% ${a=100-i}%, 0 ${a}%)`):(a=100*(i=(h-c)/2)/h,o-=i,s.style.clipPath=`polygon(${a}% 0, ${i=100-a}% 0, ${i}% 100%, ${a}% 100%)`)),e=1!=(a=e/(i=Math.max(c,h)))?o/i/(a-1):0,n=1!=(t=t/i)?l/i/(t-1):0,s.style.backgroundImage=CSS.encodeURL(R.route(r)),s.style.backgroundPosition=100*e+`% ${100*n}%`,s.style.backgroundSize=100*a+`% ${100*t}%`,i<=128&&(s.style.imageRendering="pixelated"))})}select(...e){this.unselect();for(const a of this.selections=e){var t=a.getContext(this).element;void 0!==t&&t.addClass("selected")}var i;this.selectEventEnabled&&((i=new Event("select")).value=e,this.dispatchEvent(i))}selectAll(){var t=this["elements"],i=t["count"],a=new Array(i);for(let e=0;e<i;e++)a[e]=t[e].file;this.select(...a)}unselect(){var e,t=this.selections;if(0!==t.length){De.textBox.input.blur();for(const a of t){var i=a.getContext(this).element;void 0!==i&&i.removeClass("selected")}this.selections=[],this.unselectEventEnabled&&((e=new Event("unselect")).value=t,this.dispatchEvent(e))}}selectByPath(t){var i=this["elements"],a=i["count"];for(let e=0;e<a;e++){var n=i[e]["file"];if(n.path===t)return this.select(n)}this.unselect()}selectDefault(){var t=this["elements"],i=t["count"];for(let e=0;e<i;e++)if(t[e].hasClass("selected"))return;0!==i&&this.select(t[0].file)}selectRelativeInGridMode(a){var n=this["elements"],s=n["count"];if(0<s){let e,t=1/0,i=-1/0;var r=this["selections"];for(const c of r){var o=c.getContext(this)["element"],o=n.indexOf(o);-1!==o&&(t=Math.min(t,o),i=Math.max(i,o))}if(t===1/0)switch(a){case"prev":case"prev-line":e=s-1;break;case"next":case"next-line":e=0}else{var l=this.content["countPerLine"];switch(a){case"prev":e=t-1;break;case"next":e=i+1;break;case"prev-line":e=t-l;break;case"next-line":(e=i+l)>=s&&Math.floor(e/l)*l<s&&(e=s-1)}}a=n[e]?.file;void 0!==a&&(1===r.length&&r[0]===a||this.select(a),this.scrollToSelectionInGridMode())}}scrollToSelectionInGridMode(n="active"){var e=this["selections"];if(1===e.length&&this.hasScrollBar()){var t=e[0],i=this.elements,s=i.count;for(let a=0;a<s;a++)if(i[a].file===t){var r=this.content.itemSize,o=this.content.countPerLine,o=Math.floor(a/o)*r;let e,t,i=(t="list"===this.viewMode?(e="scrollLeft",this.clientWidth):(e="scrollTop",this.clientHeight),this[e]);if("active"!==n)return;i=Math.clamp(i,o+r+8-2-t,o),this[e]!==i&&(this[e]=i);break}}}getDirName(){let e="";var t=this.selections;switch(t.length){case 0:var i=this.links["nav"],i=i.selections;1===i.length&&(e=i[0].path);break;case 1:i=t[0];e=i.path,i instanceof q&&(e=E.dirname(e))}return e}createFolder(){var e=this.getDirName();if(e){const{path:t,route:i}=R.getFileName(e,"New Folder");z.mkdir(i,{recursive:!0}).then(()=>h.update()).then(e=>{e&&(e=h.getFolder(t)).path===t&&(this.links.nav.load(e.parent),this.select(e),this.rename(e))})}}showInExplorer(){let e=0;var t=this.elements;for(const a of this.selections){var i=a.getContext(this)["element"];if(t.includes(i)&&(R.showInExplorer(R.route(a.path)),10==++e))break}}openFile(e){var t;e instanceof B&&(t=this.links["nav"],t.load(e),t.scrollToSelection("middle")),e instanceof q&&this.openEventEnabled&&((t=new Event("open")).value=e,this.dispatchEvent(t))}deleteFiles(){const e=[];var t=this["selections"];if(!t.includes(h.assets)){var i=this.elements;for(const s of t){var a=s.getContext(this)["element"];i.includes(a)&&e.push(s)}}var n,t=e["length"];0!==t&&(n=N.createGetter("confirmation"),O.confirm({message:1===t?n("deleteSingleFile").replace("<filename>",e[0].alias??e[0].name):n("deleteMultipleFiles").replace("<number>",t)},[{label:n("yes"),click:()=>{h.deleteFiles(e).then(()=>h.update())}},{label:n("no")}]))}rename(e){var t,i=De["textBox"];document.activeElement!==this.content||e===h.assets||i.parentNode||(t=e.getContext(this).element)&&t.parentNode&&(t.nameBox.hide(),t.appendChild(i),i.write(e.basename??e.name),i.getFocus("all"),"list"===this.viewMode?i.fitContent():i.style.width="")}cancelRenaming(){var e=this["timer"];e.target&&(e.target=null),e.running&&(e.running=!1,e.remove())}importFiles(){var e=this.links["nav"],e=e.selections;if(1===e.length){const l=e[0],c=P.config.dialogs;var e=E.normalize(c.import),t=["png","jpg","jpeg","cur","webp"],i=["mp3","m4a","ogg","wav","flac"],a=["mp4","mkv","webm"],n=["ttf","otf","woff","woff2"];R.showOpenDialog({defaultPath:e,filters:[{name:"Resources",extensions:[...t,...i,...a,...n]},{name:"Images",extensions:t},{name:"Audio",extensions:i},{name:"Videos",extensions:a},{name:"Fonts",extensions:n}],properties:["multiSelections"]}).then(({filePaths:t})=>{if(0!==t.length){var i=l.path,a=[],n=t.length;for(let e=0;e<n;e++){var s=E.slash(t[e]),r=E.extname(s),o=E.basename(s,r),o=R.getFileName(i,o,r).route;a.push(z.copyFile(s,o))}Promise.all(a).then(()=>h.update()),c.import=E.slash(E.dirname(t[0]))}})}}exportFile(){const i=this.selections,a=P.config.dialogs;if(1===i.length&&i[0]instanceof q){const t=i[0];R.showSaveDialog({defaultPath:E.resolve(a.export,t.name)}).then(({filePath:e})=>{if(e)return a.export=E.slash(E.dirname(e)),z.copyFile(R.route(t.path),e)}).finally(()=>{h.update()})}else R.showOpenDialog({defaultPath:E.normalize(a.export),properties:["openDirectory"]}).then(({filePaths:e})=>{if(1===e.length){const t=e[0];return a.export=E.slash(t),h.readdir(i.map(e=>R.route(e.path))).then(e=>h.copyFiles(t,e))}}).finally(()=>{h.update()})}clearElements(e){var t=this["elements"];256<t.length&&t.length!==e&&(t.length=e);let i=e;for(;void 0!==t[i];)t[i++]=void 0}clear(){return this.unselect(),this.content.textContent="",this.clearElements(0),this.elements.count=0,this.elements.start=-1,this.elements.end=-1,this.resetContentStyle(),this}on(e,t,i){switch(super.on(e,t,i),e){case"open":this.openEventEnabled=!0;break;case"select":this.selectEventEnabled=!0;break;case"unselect":this.unselectEventEnabled=!0;break;case"popup":this.popupEventEnabled=!0}}keydown(e){if(e.cmdOrCtrlKey){switch(e.code){case"ArrowUp":this.scrollTop-=20;break;case"ArrowDown":this.scrollTop+=20;break;case"KeyA":this.selectAll();break;default:return}e.stopImmediatePropagation()}else if(!e.altKey){switch(e.code){case"Space":e.preventDefault(),this.links.nav.focus();break;case"Enter":case"NumpadEnter":var t=this.selections;1===t.length&&(i=(t=t[0]).getContext(this)["element"],this.elements.includes(i))&&this.openFile(t);break;case"Delete":this.deleteFiles();break;case"Backspace":var i=this.links["browser"];i.backToParentFolder();break;case"ArrowLeft":e.preventDefault(),"list"===this.viewMode?this.selectRelativeInGridMode("prev-line"):this.selectRelativeInGridMode("prev");break;case"ArrowRight":e.preventDefault(),"list"===this.viewMode?this.selectRelativeInGridMode("next-line"):this.selectRelativeInGridMode("next");break;case"ArrowUp":e.preventDefault(),"list"===this.viewMode?this.selectRelativeInGridMode("prev"):this.selectRelativeInGridMode("prev-line");break;case"ArrowDown":e.preventDefault(),"list"===this.viewMode?this.selectRelativeInGridMode("next"):this.selectRelativeInGridMode("next-line");break;case"F2":t=this.selections;1===t.length&&(this.cancelRenaming(),this.rename(t[0]));break;default:return}e.stopImmediatePropagation()}}pointerdown(e){switch(this.cancelRenaming(),e.button){case 0:case 2:{let a=e.target;if((a=a===this.content?this:a)===this)this.contains(document.activeElement)&&this.isInContent(e)&&this.unselect();else if("FILE-BODY-ITEM"===(a="FILE-BODY-ICON"!==a.tagName&&"FILE-BODY-NAME"!==a.tagName?a:a.parentNode).tagName){var n=this.selections,s=n.length;if(e.cmdOrCtrlKey&&0!==s){var t=this.elements;const c=Array.from(n);for(let e=s-1;0<=e;e--){var i=c[e].getContext(this)["element"];t.includes(i)||c.splice(e,1)}if(n.includes(a.file)){c.remove(a.file);const h=e=>{this.pressing===h&&(this.pressing=null,a.contains(e.target))&&this.select(...c)};this.pressing=h,window.on("pointerup",h,{once:!0})}else c.append(a.file),this.select(...c);return}if(e.shiftKey&&0!==s){var r=this.elements;let t=r.indexOf(a),i=t;for(let e=0;e<s;e++){var o=n[e].getContext(this)["element"],o=r.indexOf(o);-1!==o&&(t=Math.min(t,o),i=Math.max(i,o))}if(-1!==t)return l=r.slice(t,i+1),void this.select(...l.map(e=>e.file))}if(a.hasClass("selected")){if(0===e.button)if(1<s){const d=e=>{this.pressing===d&&(this.pressing=null,a.contains(e.target))&&this.select(a.file)};this.pressing=d,window.on("pointerup",d,{once:!0})}else"closed"===ve.state&&document.activeElement===this.content&&"FILE-BODY-NAME"===e.target.tagName&&(this.timer.target=e.target)}else this.select(a.file)}e.target===this&&(e.preventDefault(),this.content.focus());break}case 3:var l=this.links["browser"];l.backToParentFolder()}}pointerup(e){switch(e.button){case 0:document.activeElement===this.content&&this.timer.target===e.target&&(this.timer.running=!0,this.timer.elapsed=0,this.timer.add());break;case 2:var t;document.activeElement===this.content&&this.popupEventEnabled&&((t=new Event("popup")).raw=e,t.clientX=e.clientX,t.clientY=e.clientY,this.dispatchEvent(t))}}doubleclick(e){let t=e.target;"FILE-BODY-ITEM"===(t="FILE-BODY-ICON"!==t.tagName&&"FILE-BODY-NAME"!==t.tagName?t:t.parentNode).tagName&&(e.preventDefault(),this.cancelRenaming(),this.openFile(t.file))}wheel(e){var t,i=e["deltaY"];if(0!==i){if(e.cmdOrCtrlKey)return e.preventDefault(),e=this.viewIndex,t=Math.sign(-i),this.setViewIndex(e+t);"list"===this.viewMode&&this.clientWidth<this.scrollWidth&&(this.scrollLeft+=i<0?-60:60)}}static textBox=(e=new $,e.setMaxLength(64),e.addClass("file-body-text-box"),e.input.addClass("file-body-text-box-input"),e.on("keydown",function(e){switch(e.stopPropagation(),e.code){case"Enter":case"NumpadEnter":case"Escape":var t=this.parentNode.parentNode;this.input.blur(),t.focus()}}),e.on("beforeinput",function(e){"insertText"===e.inputType&&"string"==typeof e.data&&/[\\/:*?"<>|"]/.test(e.data)&&(e.preventDefault(),e.stopPropagation())}),e.on("input",function(e){""!==this.style.width&&this.fitContent()}),e.on("select",function(e){e.stopPropagation()}),e.on("blur",function(e){const t=this.parentNode,i=t.file,a=this.read().trim();let n=a;if((this.remove(),t.nameBox.show(),a)&&(i instanceof q&&("string"==typeof(s=i.meta?.guid)&&(n+="."+s),n+=i.extname),n!==i.name)){var s=E.dirname(i.path);const r=R.route(s+"/"+n);z.stat(r,B.bigint).then(e=>{if(e.ino===i.stats.ino)throw new Error("same file")}).catch(e=>z.rename(R.route(i.path),r).then(()=>(t.nameBox.textContent=a,h.update())))}}),e)}customElements.define("file-body-pane",De);const _e={textEncoder:new TextEncoder,textDecoder:new TextDecoder,encodeScene:null,decodeScene:null,encodeTilemap:null,decodeTilemap:null,encodeTiles:null,decodeTiles:null,encodeTerrains:null,decodeTerrains:null,encodeRelations:null,decodeRelations:null,encodeClone:null,decodeClone:null,getTilemaps:null};_e.encodeScene=function(e){var t,i,a={};for(const n of this.getTilemaps(e))_e.encodeTilemap(n);for([t,i]of Object.entries(e))"terrains"===t?(e.terrainsChanged&&(e.terrainsChanged=!1,e.terrainsCode=this.encodeTerrains(i)),a.terrains=e.terrainsCode):a[t]=i;return JSON.stringify(a,null,2)},_e.decodeScene=function(e){var e=JSON.parse(e),t=(Object.defineProperty(e,"terrainsCode",{writable:!0,value:e.terrains}),Object.defineProperty(e,"terrainsChanged",{writable:!0,value:!1}),e.terrains=this.decodeTerrains(e.terrains,e.width,e.height),this.getTilemaps(e));for(const i of t)_e.decodeTilemap(i);return e},_e.encodeTilemap=function(e){if(e.changed){e.changed=!1,e.code=_e.encodeTiles(e.tiles);var t={},i=e.tilesetMap,a=Object.keys(i);for(const h of a)t[h]=!1;var n=e.tiles,s=n.length;for(let e=0;e<s;e++){var r=n[e]>>24;0!=r&&(t[r]=!0)}var o,l={},c={};for(const d of a)t[d]&&(o=i[d],c[l[d]=o]=parseInt(d));e.tilesetMap=l,e.reverseMap=c}},_e.decodeTilemap=function(e){var t,i,a=_e.decodeTiles(e.code,e.width,e.height),{tilesetMap:a,reverseMap:n}=(Object.defineProperty(e,"tiles",{writable:!0,value:a}),Object.defineProperty(e,"changed",{writable:!0,value:!1}),Object.defineProperty(e,"reverseMap",{writable:!0,value:{}}),e);for([t,i]of Object.entries(a))n[i]=parseInt(t);return e},_e.encodeTiles=function(e){var t=this["encodeClone"],i=e,a=i.length,n=We.arrays[0].uint8;let s=0,r=0;for(;r<a;)if(0===i[r]){let e=1;for(r+=1;0===i[r];)e++,r++;e<=16?n[s++]=e+109:(n[s++]=126,s=t(n,s,e))}else if(i[r]===i[r-1]){let e=1;for(r+=1;i[r]===i[r-1];)e++,r++;e<=10?n[s++]=e+98:(n[s++]=109,s=t(n,s,e))}else{var o=i[r];n[s]=35+(o>>26),n[s+1]=35+(o>>20&63),n[s+2]=35+(o>>14&63),n[s+3]=35+(o>>8&63),n[s+4]=35+(63&o),s+=5,r+=1}return this.textDecoder.decode(new Uint8Array(n.buffer,0,s))},_e.decodeTiles=function(e,t,i){var a=this["decodeClone"],n=this.textEncoder.encode(e),s=n.length,r=A.createTiles(t,i),e=r.length;let o=0,l=0;for(;o<s;){var c=n[o];if(c<=98)r[l]=(n[o]-35<<26)+(n[o+1]-35<<20)+(n[o+2]-35<<14)+(n[o+3]-35<<8)+(n[o+4]-35),l+=1,o+=5;else if(c<=109)if(109!==c){for(var h=r[l-1],d=l+c-98;l<d;)r[l++]=h;o+=1}else{for(var{index:u,count:p}=a(n,++o),m=r[l-1],g=l+p;l<g;)r[l++]=m;o=u}else 126!==c?(l+=c-109,o+=1):({index:p,count:u}=a(n,++o),l+=u,o=p)}if(o!==s||l!==e)throw new RangeError(`
    Failed to decode tiles.
    Processed bytes: ${o} / ${s}
    Restored data: ${l} / ${e}
    `);return r},_e.encodeTerrains=function(e){var t=this["encodeClone"],i=e,a=i.length,n=We.arrays[0].uint8;let s=0,r=0;for(;r<a;)if(0===i[r]){let e=1;for(r+=1;0===i[r];)e++,r++;e<=49?n[s++]=e+76:e<=98?(n[s++]=125,n[s++]=e-49+76):(n[s++]=126,s=t(n,s,e))}else if(i[r]===i[r-1]&&i[r]===i[r+1]){let e=2;for(r+=2;i[r]===i[r-1];)e++,r++;e<=25?n[s++]=e+50:e<=50?(n[s++]=75,n[s++]=e-25+50):(n[s++]=76,s=t(n,s,e))}else n[s++]=i[r++]+35;return this.textDecoder.decode(new Uint8Array(n.buffer,0,s))},_e.decodeTerrains=function(e,t,i){var a=this["decodeClone"],n=this.textEncoder.encode(e),s=n.length,r=A.createTerrains(t,i),e=r.length;let o=0,l=0;for(;o<s;){var c=n[o];if(c<=50)r[l]=c-35,l+=1,o+=1;else if(c<=76)if(76!==c){for(var h=r[l-1],d=l+c-50;l<d;)r[l++]=h;o+=1}else{for(var{index:u,count:p}=a(n,++o),m=r[l-1],g=l+p;l<g;)r[l++]=m;o=u}else 126!==c?(l+=c-76,o+=1):({index:p,count:u}=a(n,++o),l+=u,o=p)}if(o!==s||l!==e)throw new RangeError(`
    Failed to decode terrains.
    Processed bytes: ${o} / ${s}
    Restored data: ${l} / ${e}
    `);return r},_e.encodeRelations=function(e){var t=e,i=t.length,a=We.arrays[0].uint8;let n=0,s=0;for(;s<i;)a[n++]=35+(t[s]|t[s+1]<<1|t[s+2]<<2|t[s+3]<<3|t[s+4]<<4|t[s+5]<<5),s+=6;return this.textDecoder.decode(new Uint8Array(a.buffer,0,n))},_e.decodeRelations=function(e,t){var i=this.textEncoder.encode(e),a=i.length,e=(t+1)/2*t,n=new Uint8Array(e);let s=0,r=0;for(;s<a;){var o=i[s]-35;n[r]=1&o,n[r+1]=o>>1&1,n[r+2]=o>>2&1,n[r+3]=o>>3&1,n[r+4]=o>>4&1,n[r+5]=o>>5,r+=6,s+=1}if(s!==a||r<e)throw new RangeError(`
    Failed to decode relations.
    Processed bytes: ${s} / ${a}
    Restored data: ${r} / ${e}
    `);return n},_e.encodeClone=function(){const{ceil:r,log2:o}=Math;return(t,i,a)=>{var e=r(o(a+1)),n=r(e/5);for(let e=0;e<n;e++){var s=n-e-1;t[i++]=35+((0!=s?1:0)<<5|a>>5*s&31)}return i}}(),_e.decodeClone=function(){const n={index:0,count:0};return(e,t)=>{let i=0;for(var a;a=e[t++]-35,i=i<<5|31&a,32&a;);return n.index=t,n.count=i,n}}(),_e.getTilemaps=function(){const a=(e,t)=>{for(const i of e)switch(i.class){case"folder":a(i.children,t);continue;case"tilemap":t.push(i);continue}return t};return function(e){return a(e.objects,[])}}();let We;{var e=document.createElement("canvas");e.width=0,e.height=0,e.style.position="absolute",e.style.width="100%",e.style.height="100%";const vi={light:{r:200,g:200,b:200},dark:{r:32,g:32,b:32}};window.on("themechange",function(e){var{r:e,g:t,b:i}=vi[e.value];We.BACKGROUND_RED=e/255,We.BACKGROUND_GREEN=t/255,We.BACKGROUND_BLUE=i/255}),e.on("webglcontextlost",function(e){e.preventDefault(),setTimeout(()=>We.WEBGL_lose_context.restoreContext())}),e.on("webglcontextrestored",function(e){We.restore()});var Oe={antialias:!1,alpha:!1,depth:!0,stencil:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,desynchronized:!0};(We=e.getContext("webgl2",Oe))instanceof WebGL2RenderingContext||((We=e.getContext("webgl",Oe)).getExtension("OES_element_index_uint"),e=We.getExtension("OES_vertex_array_object"),We.createVertexArray=e.createVertexArrayOES.bind(e),We.deleteVertexArray=e.deleteVertexArrayOES.bind(e),We.isVertexArray=e.isVertexArrayOES.bind(e),We.bindVertexArray=e.bindVertexArrayOES.bind(e),Oe=We.getExtension("EXT_blend_minmax"),We.MIN=Oe.MIN_EXT,We.MAX=Oe.MAX_EXT,(e=WebGLRenderingContext.prototype)._bufferData=e.bufferData,e.bufferData=function(e,t,i,a,n){return void 0!==n&&(n*=t.BYTES_PER_ELEMENT,t=new Uint8Array(t.buffer,a,n)),this._bufferData(e,t,i)}),We.WEBGL_lose_context=We.getExtension("WEBGL_lose_context")}We.restore=function(){var{contrast:e,ambient:t}=this;this.textureManager.restore(),this.initialize(),this.setContrast(e),this.setAmbientLight(t),this.updateLightTexSize()},We.initialize=function(){this.flip=this.flip??-1,this.alpha=this.alpha??1,this.blend=this.blend??"normal",this.matrix=this.matrix??new Ze,this.width=this.drawingBufferWidth,this.height=this.drawingBufferHeight,this.program=null,this.binding=null,this.masking=!1,this.depthTest=!1,this.contrast=0,this.ambient={red:-1,green:-1,blue:-1},this.textureManager=this.textureManager??new Xe,this.maxTexUnits=16,this.lightmap=this.lightmap??new je({format:this.RGB,magFilter:this.LINEAR,minFilter:this.LINEAR}),this.lightmap.base.protected=!0,this.lightmap.fbo=this.createTextureFBO(this.lightmap),this.activeTexture(this.TEXTURE0+this.maxTexUnits-1),this.bindTexture(this.TEXTURE_2D,this.lightmap.base.glTexture),this.activeTexture(this.TEXTURE0),this.stencilTexture=this.stencilTexture??new je({format:this.ALPHA}),this.stencilTexture.base.protected=!0,this.maskTexture=this.maskTexture??new je({format:this.RGBA}),this.maskTexture.fbo=this.createTextureFBO(this.maskTexture),this.layers=this.layers??new Uint32Array(262144),this.zeros=this.zeros??new Uint32Array(262144);var e,t,i,a,n=262144,s=(this.arrays||(e=new ArrayBuffer(96*n),t=new ArrayBuffer(12*n),i=new ArrayBuffer(8*n),a=new ArrayBuffer(40*n),this.arrays={0:{uint8:new Uint8Array(e,0,96*n),uint32:new Uint32Array(e,0,24*n),float32:new Float32Array(e,0,24*n)},1:{uint16:new Uint16Array(t,0,6*n),uint32:new Uint32Array(t,0,3*n),float32:new Float32Array(t,0,3*n)},2:{uint32:new Uint32Array(i,0,2*n)},3:{uint32:new Uint32Array(a,0,10*n),float32:new Float32Array(a,0,10*n)}}),this.frameBuffer=this.createFramebuffer(),this.vertexBuffer=this.createBuffer(),this.arrays[0].uint32);for(let e=0;e<n;e++){var r=6*e,o=4*e;s[r]=o,s[1+r]=1+o,s[2+r]=2+o,s[3+r]=o,s[4+r]=2+o,s[5+r]=3+o}this.elementBuffer=this.createBuffer(),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.elementBuffer),this.bufferData(this.ELEMENT_ARRAY_BUFFER,s,this.STATIC_DRAW,0,6*n),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,null),this.updateBlending=this.createBlendingUpdater(),this.batchRenderer=new Ge(this),this.context2d=this.context2d??this.createContext2D(),this.imageProgram=this.createImageProgram(),this.tileProgram=this.createTileProgram(),this.textProgram=this.createTextProgram(),this.spriteProgram=this.createSpriteProgram(),this.particleProgram=this.createParticleProgram(),this.lightProgram=this.createLightProgram(),this.graphicProgram=this.createGraphicProgram(),this.dashedLineProgram=this.createDashedLineProgram()},We.createProgramWithShaders=function(e,t){var i,a,e=this.loadShader(this.VERTEX_SHADER,e),t=this.loadShader(this.FRAGMENT_SHADER,t);return e&&t?(i=this.createProgram())?(this.attachShader(i,e),this.attachShader(i,t),this.linkProgram(i),this.getProgramParameter(i,this.LINK_STATUS)?i:(a=this.getProgramInfoLog(i),console.error("Failed to link program: "+a),this.deleteProgram(i),this.deleteShader(t),this.deleteShader(e),null)):(console.error("Failed to create program"),null):null},We.loadShader=function(e,t){e=this.createShader(e);return e?(this.shaderSource(e,t),this.compileShader(e),this.getShaderParameter(e,this.COMPILE_STATUS)?e:(t=this.getShaderInfoLog(e),console.error("Failed to compile shader: "+t),this.deleteShader(e),null)):(console.error("Unable to create shader"),null)},We.createImageProgram=function(){const e=this.createProgramWithShaders(`
    attribute   vec2        a_Position;
    attribute   vec2        a_TexCoord;
    uniform     float       u_Flip;
    uniform     mat3        u_Matrix;
    uniform     vec3        u_Ambient;
    uniform     float       u_Contrast;
    uniform     int         u_LightMode;
    uniform     vec2        u_LightCoord;
    uniform     vec4        u_LightTexSize;
    uniform     sampler2D   u_LightSampler;
    varying     vec2        v_TexCoord;
    varying     vec3        v_LightColor;

    vec3 getLightColor() {
      if (u_LightMode == 0) {
        return vec3(1.0, 1.0, 1.0);
      }
      if (u_LightMode == 1) {
        return vec3(
          gl_Position.x / u_LightTexSize.x + u_LightTexSize.z,
          gl_Position.y / u_LightTexSize.y * u_Flip + u_LightTexSize.w,
          -1.0
        );
      }
      if (u_LightMode == 2) {
        vec2 anchorCoord = (u_Matrix * vec3(u_LightCoord, 1.0)).xy;
        vec2 lightCoord = vec2(
          anchorCoord.x / u_LightTexSize.x + u_LightTexSize.z,
          anchorCoord.y / u_LightTexSize.y * u_Flip + u_LightTexSize.w
        );
        return texture2D(u_LightSampler, lightCoord).rgb * u_Contrast;
      }
      if (u_LightMode == 3) {
        return u_Ambient * u_Contrast;
      }
    }

    void main() {
      gl_Position.xyw = u_Matrix * vec3(a_Position, 1.0);
      v_TexCoord = a_TexCoord;
      v_LightColor = getLightColor();
    }
    `,`
    precision   highp       float;
    varying     vec2        v_TexCoord;
    varying     vec3        v_LightColor;
    uniform     vec2        u_Viewport;
    uniform     int         u_Masking;
    uniform     float       u_Alpha;
    uniform     int         u_ColorMode;
    uniform     vec4        u_Color;
    uniform     vec4        u_Tint;
    uniform     vec4        u_Repeat;
    uniform     float       u_Contrast;
    uniform     sampler2D   u_Sampler;
    uniform     sampler2D   u_MaskSampler;
    uniform     sampler2D   u_LightSampler;

    vec3 getLightColor() {
      if (v_LightColor.z != -1.0) return v_LightColor;
      return texture2D(u_LightSampler, v_LightColor.xy).rgb * u_Contrast;
    }

    void main() {
      if (u_ColorMode == 0) {
        gl_FragColor = texture2D(u_Sampler, fract(v_TexCoord));
        if (gl_FragColor.a == 0.0) discard;
        gl_FragColor.rgb = gl_FragColor.rgb * (1.0 - u_Tint.a) + u_Tint.rgb +
        dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114)) * u_Tint.a;
      } else if (u_ColorMode == 1) {
        float alpha = texture2D(u_Sampler, v_TexCoord).a;
        if (alpha == 0.0) discard;
        gl_FragColor = vec4(u_Color.rgb, u_Color.a * alpha);
      } else if (u_ColorMode == 2) {
        vec2 uv = vec2(
          mod(v_TexCoord.x - u_Repeat.x, u_Repeat.z) + u_Repeat.x,
          mod(v_TexCoord.y - u_Repeat.y, u_Repeat.w) + u_Repeat.y
        );
        gl_FragColor = texture2D(u_Sampler, uv);
        if (gl_FragColor.a == 0.0) discard;
        gl_FragColor.rgb = gl_FragColor.rgb * (1.0 - u_Tint.a) + u_Tint.rgb +
        dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114)) * u_Tint.a;
      }
      gl_FragColor.rgb *= getLightColor();
      gl_FragColor.a *= u_Alpha;
      if (u_Masking == 1) {
        vec2 fragCoord = vec2(gl_FragCoord.x, (u_Viewport.y - gl_FragCoord.y));
        gl_FragColor.a *= texture2D(u_MaskSampler, fragCoord / u_Viewport).a;
      }
    }
    `);this.useProgram(e);var t=this.getAttribLocation(e,"a_Position"),i=this.getAttribLocation(e,"a_TexCoord");const a=this.getUniformLocation(e,"u_Flip");var n=this.getUniformLocation(e,"u_Matrix"),s=this.getUniformLocation(e,"u_Ambient"),r=this.getUniformLocation(e,"u_Contrast"),o=this.getUniformLocation(e,"u_LightMode"),l=this.getUniformLocation(e,"u_LightCoord"),c=this.getUniformLocation(e,"u_LightTexSize"),h=(this.uniform1i(this.getUniformLocation(e,"u_LightSampler"),this.maxTexUnits-1),this.getUniformLocation(e,"u_Viewport")),d=this.getUniformLocation(e,"u_Masking");const u=this.getUniformLocation(e,"u_Alpha");var p=this.getUniformLocation(e,"u_ColorMode"),m=this.getUniformLocation(e,"u_Color"),g=this.getUniformLocation(e,"u_Tint"),f=this.getUniformLocation(e,"u_Repeat"),v=this.getUniformLocation(e,"u_MaskSampler"),b=this.createVertexArray();this.bindVertexArray(b),this.enableVertexAttribArray(t),this.enableVertexAttribArray(i),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(t,2,this.FLOAT,!1,16,0),this.vertexAttribPointer(i,2,this.FLOAT,!1,16,8),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.elementBuffer);return e.use=()=>(this.program!==e&&(this.program=e,this.useProgram(e)),e.flip!==this.flip&&(e.flip=this.flip,this.uniform1f(a,e.flip)),e.alpha!==this.alpha&&(e.alpha=this.alpha,this.uniform1f(u,e.alpha)),this.updateMasking(),this.updateBlending(),e),e.vao=b,e.alpha=0,e.masking=!1,e.a_Position=t,e.a_TexCoord=i,e.u_Matrix=n,e.u_Ambient=s,e.u_Contrast=r,e.u_LightMode=o,e.u_LightCoord=l,e.u_LightTexSize=c,e.u_Viewport=h,e.u_Masking=d,e.u_MaskSampler=v,e.u_ColorMode=p,e.u_Color=m,e.u_Tint=g,e.u_Repeat=f,e},We.createTileProgram=function(){const t=this.createProgramWithShaders(`
    attribute   vec2        a_Position;
    attribute   vec2        a_TexCoord;
    attribute   float       a_TexIndex;
    uniform     float       u_Flip;
    uniform     mat3        u_Matrix;
    uniform     vec3        u_Ambient;
    uniform     float       u_Contrast;
    uniform     int         u_LightMode;
    uniform     vec4        u_LightTexSize;
    uniform     sampler2D   u_LightSampler;
    varying     float       v_TexIndex;
    varying     vec2        v_TexCoord;
    varying     vec3        v_LightColor;

    vec3 getLightColor() {
      if (u_LightMode == 0) {
        return vec3(1.0, 1.0, 1.0);
      }
      if (u_LightMode == 1) {
        return vec3(
          gl_Position.x / u_LightTexSize.x + u_LightTexSize.z,
          gl_Position.y / u_LightTexSize.y * u_Flip + u_LightTexSize.w,
          -1.0
        );
      }
      if (u_LightMode == 2) {
        return u_Ambient * u_Contrast;
      }
    }

    void main() {
      gl_Position.xyw = u_Matrix * vec3(a_Position, 1.0);
      v_TexCoord = a_TexCoord;
      v_TexIndex = a_TexIndex;
      v_LightColor = getLightColor();
    }
    `,`
    precision   highp       float;
    varying     float       v_TexIndex;
    varying     vec2        v_TexCoord;
    varying     vec3        v_LightColor;
    uniform     float       u_Alpha;
    uniform     int         u_TintMode;
    uniform     vec4        u_Tint;
    uniform     float       u_Contrast;
    uniform     sampler2D   u_Samplers[15];
    uniform     sampler2D   u_LightSampler;

    vec4 sampler(int index, vec2 uv) {
      for (int i = 0; i < 15; i++) {
        if (i == index) {
          return texture2D(u_Samplers[i], uv);
        }
      }
    }

    vec3 getLightColor() {
      if (v_LightColor.z != -1.0) return v_LightColor;
      return texture2D(u_LightSampler, v_LightColor.xy).rgb * u_Contrast;
    }

    void main() {
      gl_FragColor = sampler(int(v_TexIndex), v_TexCoord);
      if (gl_FragColor.a == 0.0) {
        discard;
      }
      if (u_TintMode == 1) {
        gl_FragColor.rgb = gl_FragColor.rgb * (1.0 - u_Tint.a) + u_Tint.rgb +
        dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114)) * u_Tint.a;
      }
      gl_FragColor.rgb *= getLightColor();
      gl_FragColor.a *= u_Alpha;
    }
    `);this.useProgram(t);var e=this.getAttribLocation(t,"a_Position"),i=this.getAttribLocation(t,"a_TexCoord"),a=this.getAttribLocation(t,"a_TexIndex");const n=this.getUniformLocation(t,"u_Flip");var s=this.getUniformLocation(t,"u_Matrix"),r=this.getUniformLocation(t,"u_Ambient"),o=this.getUniformLocation(t,"u_Contrast"),l=this.getUniformLocation(t,"u_LightMode"),c=this.getUniformLocation(t,"u_LightTexSize");this.uniform1i(this.getUniformLocation(t,"u_LightSampler"),this.maxTexUnits-1);const h=this.getUniformLocation(t,"u_Alpha");var d=this.getUniformLocation(t,"u_TintMode"),u=this.getUniformLocation(t,"u_Tint"),p=this.maxTexUnits-1,m=[];for(let e=0;e<p;e++)m.push(this.getUniformLocation(t,`u_Samplers[${e}]`));var g=this.createVertexArray();this.bindVertexArray(g),this.enableVertexAttribArray(e),this.enableVertexAttribArray(i),this.enableVertexAttribArray(a),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(e,2,this.FLOAT,!1,20,0),this.vertexAttribPointer(i,2,this.FLOAT,!1,20,8),this.vertexAttribPointer(a,1,this.FLOAT,!1,20,16),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.elementBuffer);return t.use=()=>(this.program!==t&&(this.program=t,this.useProgram(t)),t.flip!==this.flip&&(t.flip=this.flip,this.uniform1f(n,t.flip)),t.alpha!==this.alpha&&(t.alpha=this.alpha,this.uniform1f(h,t.alpha)),t),t.vao=g,t.flip=null,t.alpha=0,t.samplerNum=1,t.a_Position=e,t.a_TexCoord=i,t.a_TexIndex=a,t.u_Matrix=s,t.u_Ambient=r,t.u_Contrast=o,t.u_LightMode=l,t.u_LightTexSize=c,t.u_TintMode=d,t.u_Tint=u,t.u_Samplers=m,t},We.createTextProgram=function(){const e=this.createProgramWithShaders(`
    attribute   vec2        a_Position;
    attribute   vec2        a_TexCoord;
    attribute   vec4        a_TextColor;
    varying     vec2        v_TexCoord;
    varying     vec4        v_TextColor;

    void main() {
      gl_Position.xyw = vec3(a_Position, 1.0);
      v_TexCoord = a_TexCoord;
      v_TextColor = a_TextColor;
    }
    `,`
    precision   highp       float;
    varying     vec2        v_TexCoord;
    varying     vec4        v_TextColor;
    uniform     float       u_Alpha;
    uniform     float       u_Threshold;
    uniform     sampler2D   u_Sampler;

    void main() {
      float texAlpha = texture2D(u_Sampler, v_TexCoord).a;
      if (texAlpha == 0.0 || texAlpha < u_Threshold) {
        discard;
      }
      gl_FragColor.rgb = v_TextColor.rgb;
      gl_FragColor.a = u_Threshold == 0.0
      ? v_TextColor.a * u_Alpha * texAlpha
      : v_TextColor.a * u_Alpha;
    }
    `);this.useProgram(e);var t=this.getAttribLocation(e,"a_Position"),i=this.getAttribLocation(e,"a_TexCoord"),a=this.getAttribLocation(e,"a_TextColor");const n=this.getUniformLocation(e,"u_Alpha");var s=this.getUniformLocation(e,"u_Threshold"),r=this.createVertexArray();this.bindVertexArray(r),this.enableVertexAttribArray(t),this.enableVertexAttribArray(i),this.enableVertexAttribArray(a),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(t,2,this.FLOAT,!1,20,0),this.vertexAttribPointer(i,2,this.FLOAT,!1,20,8),this.vertexAttribPointer(a,4,this.UNSIGNED_BYTE,!0,20,16),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.elementBuffer);return e.use=()=>(this.program!==e&&(this.program=e,this.useProgram(e)),e.alpha!==this.alpha&&(e.alpha=this.alpha,this.uniform1f(n,e.alpha)),this.updateBlending(),e),e.vao=r,e.alpha=0,e.a_Position=t,e.a_TexCoord=i,e.a_TextColor=a,e.u_Threshold=s,e},We.createSpriteProgram=function(){const t=this.createProgramWithShaders(`
    attribute   vec2        a_Position;
    attribute   vec2        a_TexCoord;
    attribute   vec3        a_TexParam;
    attribute   vec4        a_Tint;
    attribute   vec2        a_LightCoord;
    uniform     float       u_Flip;
    uniform     mat3        u_Matrix;
    uniform     float       u_Contrast;
    uniform     vec4        u_LightTexSize;
    uniform     sampler2D   u_LightSampler;
    varying     float       v_TexIndex;
    varying     float       v_Opacity;
    varying     vec4        v_Tint;
    varying     vec2        v_TexCoord;
    varying     vec3        v_LightColor;

    vec3 getLightColor() {
      if (a_TexParam.z == 0.0) {
        return vec3(1.0, 1.0, 1.0);
      }
      if (a_TexParam.z == 1.0) {
        return vec3(
          gl_Position.x / u_LightTexSize.x + u_LightTexSize.z,
          gl_Position.y / u_LightTexSize.y * u_Flip + u_LightTexSize.w,
          -1.0
        );
      }
      if (a_TexParam.z == 2.0) {
        return texture2D(u_LightSampler, a_LightCoord).rgb * u_Contrast;
      }
    }

    void main() {
      gl_Position.xyw = u_Matrix * vec3(a_Position, 1.0);
      v_TexIndex = a_TexParam.x;
      v_Opacity = a_TexParam.y / 255.0;
      v_Tint = a_Tint / 255.0 - 1.0;
      v_TexCoord = a_TexCoord;
      v_LightColor = getLightColor();
    }
    `,`
    precision   highp       float;
    varying     float       v_TexIndex;
    varying     float       v_Opacity;
    varying     vec4        v_Tint;
    varying     vec2        v_TexCoord;
    varying     vec3        v_LightColor;
    uniform     float       u_Alpha;
    uniform     vec4        u_Tint;
    uniform     float       u_Contrast;
    uniform     sampler2D   u_Samplers[15];
    uniform     sampler2D   u_LightSampler;

    vec4 sampler(int index, vec2 uv) {
      for (int i = 0; i < 15; i++) {
        if (i == index) {
          return texture2D(u_Samplers[i], uv);
        }
      }
    }

    vec3 tint(vec3 color, vec4 tint) {
      return color.rgb * (1.0 - tint.a) + tint.rgb +
      dot(color.rgb, vec3(0.299, 0.587, 0.114)) * tint.a;
    }

    vec3 getLightColor() {
      if (v_LightColor.z != -1.0) return v_LightColor;
      return texture2D(u_LightSampler, v_LightColor.xy).rgb * u_Contrast;
    }

    void main() {
      gl_FragColor = sampler(int(v_TexIndex), v_TexCoord);
      if (gl_FragColor.a == 0.0) {
        discard;
      }
      gl_FragColor.rgb = tint(tint(gl_FragColor.rgb, v_Tint), u_Tint) * getLightColor();
      gl_FragColor.a *= v_Opacity * u_Alpha;
    }
    `);this.useProgram(t);var e=this.getAttribLocation(t,"a_Position"),i=this.getAttribLocation(t,"a_TexCoord"),a=this.getAttribLocation(t,"a_TexParam"),n=this.getAttribLocation(t,"a_Tint"),s=this.getAttribLocation(t,"a_LightCoord");const r=this.getUniformLocation(t,"u_Flip");var o=this.getUniformLocation(t,"u_Matrix"),l=this.getUniformLocation(t,"u_Contrast"),c=this.getUniformLocation(t,"u_LightTexSize");this.uniform1i(this.getUniformLocation(t,"u_LightSampler"),this.maxTexUnits-1);const h=this.getUniformLocation(t,"u_Alpha");var d=this.getUniformLocation(t,"u_Tint"),u=this.maxTexUnits-1,p=[];for(let e=0;e<u;e++)p.push(this.getUniformLocation(t,`u_Samplers[${e}]`));var m=this.createVertexArray();this.bindVertexArray(m),this.enableVertexAttribArray(e),this.enableVertexAttribArray(i),this.enableVertexAttribArray(a),this.enableVertexAttribArray(n),this.enableVertexAttribArray(s),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(e,2,this.FLOAT,!1,32,0),this.vertexAttribPointer(i,2,this.FLOAT,!1,32,8),this.vertexAttribPointer(a,3,this.UNSIGNED_BYTE,!1,32,16),this.vertexAttribPointer(n,4,this.UNSIGNED_SHORT,!1,32,20),this.vertexAttribPointer(s,2,this.UNSIGNED_SHORT,!0,32,28),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.elementBuffer);return t.use=()=>(this.program!==t&&(this.program=t,this.useProgram(t)),t.flip!==this.flip&&(t.flip=this.flip,this.uniform1f(r,t.flip)),t.alpha!==this.alpha&&(t.alpha=this.alpha,this.uniform1f(h,t.alpha)),t),t.vao=m,t.flip=null,t.alpha=0,t.samplerNum=1,t.a_Position=e,t.a_TexCoord=i,t.a_TexParam=a,t.a_Tint=n,t.a_LightCoord=s,t.u_Matrix=o,t.u_Contrast=l,t.u_LightTexSize=c,t.u_Tint=d,t.u_Samplers=p,t},We.createParticleProgram=function(){const e=this.createProgramWithShaders(`
    attribute   vec2        a_Position;
    attribute   vec2        a_TexCoord;
    attribute   vec4        a_Color;
    uniform     mat3        u_Matrix;
    varying     vec2        v_TexCoord;
    varying     vec4        v_Color;

    void main() {
      gl_Position.xyw = u_Matrix * vec3(a_Position, 1.0);
      v_TexCoord = a_TexCoord;
      v_Color = a_Color;
    }
    `,`
    precision   highp       float;
    varying     vec2        v_TexCoord;
    varying     vec4        v_Color;
    uniform     float       u_Alpha;
    uniform     int         u_Mode;
    uniform     vec4        u_Tint;
    uniform     sampler2D   u_Sampler;

    void main() {
      if (u_Mode == 0) {
        float alpha = texture2D(u_Sampler, v_TexCoord).a;
        gl_FragColor.a = alpha * v_Color.a * u_Alpha;
        if (gl_FragColor.a == 0.0) {
          discard;
        }
        gl_FragColor.rgb = v_Color.rgb;
        return;
      }
      if (u_Mode == 1) {
        gl_FragColor = texture2D(u_Sampler, v_TexCoord);
        gl_FragColor.a *= v_Color.a * u_Alpha;
        if (gl_FragColor.a == 0.0) {
          discard;
        }
        gl_FragColor.rgb = gl_FragColor.rgb * (1.0 - u_Tint.a) + u_Tint.rgb +
        dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114)) * u_Tint.a;
        return;
      }
    }
    `);this.useProgram(e);var t=this.getAttribLocation(e,"a_Position"),i=this.getAttribLocation(e,"a_TexCoord"),a=this.getAttribLocation(e,"a_Color"),n=this.getUniformLocation(e,"u_Matrix");const s=this.getUniformLocation(e,"u_Alpha");var r=this.getUniformLocation(e,"u_Mode"),o=this.getUniformLocation(e,"u_Tint"),l=this.createVertexArray();this.bindVertexArray(l),this.enableVertexAttribArray(t),this.enableVertexAttribArray(i),this.enableVertexAttribArray(a),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(t,2,this.FLOAT,!1,20,0),this.vertexAttribPointer(i,2,this.FLOAT,!1,20,8),this.vertexAttribPointer(a,4,this.UNSIGNED_BYTE,!0,20,16),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.elementBuffer);return e.use=()=>(this.program!==e&&(this.program=e,this.useProgram(e)),e.alpha!==this.alpha&&(e.alpha=this.alpha,this.uniform1f(s,e.alpha)),this.updateBlending(),e),e.vao=l,e.alpha=0,e.a_Position=t,e.a_TexCoord=i,e.a_Color=a,e.u_Matrix=n,e.u_Mode=r,e.u_Tint=o,e},We.createLightProgram=function(){const e=this.createProgramWithShaders(`
    attribute   vec2        a_Position;
    attribute   vec2        a_LightCoord;
    uniform     mat3        u_Matrix;
    varying     vec2        v_LightCoord;

    void main() {
      gl_Position.xyw = u_Matrix * vec3(a_Position, 1.0);
      v_LightCoord = a_LightCoord;
    }
    `,`
    precision   highp       float;
    const       float       PI = 3.1415926536;
    varying     vec2        v_LightCoord;
    uniform     int         u_LightMode;
    uniform     vec4        u_LightColor;
    uniform     sampler2D   u_LightSampler;

    vec3 computeLightColor() {
      if (u_LightMode == 0) {
        float dist = length(vec2(
          (v_LightCoord.x - 0.5),
          (v_LightCoord.y - 0.5)
        ));
        if (dist > 0.5) {
          discard;
        }
        float angle = dist * PI;
        float factor = mix(1.0 - sin(angle), cos(angle), u_LightColor.a);
        return u_LightColor.rgb * factor;
      }
      if (u_LightMode == 1) {
        vec4 lightColor = texture2D(u_LightSampler, v_LightCoord);
        if (lightColor.a == 0.0) {
          discard;
        }
        return u_LightColor.rgb * lightColor.rgb * lightColor.a;
      }
      if (u_LightMode == 2) {
        return u_LightColor.rgb;
      }
    }

    void main() {
      gl_FragColor = vec4(computeLightColor(), 1.0);
    }
    `);this.useProgram(e);var t=this.getAttribLocation(e,"a_Position"),i=this.getAttribLocation(e,"a_LightCoord"),a=this.getUniformLocation(e,"u_Matrix"),n=this.getUniformLocation(e,"u_LightMode"),s=this.getUniformLocation(e,"u_LightColor"),r=this.createVertexArray();this.bindVertexArray(r),this.enableVertexAttribArray(t),this.enableVertexAttribArray(i),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(t,2,this.FLOAT,!1,16,0),this.vertexAttribPointer(i,2,this.FLOAT,!1,16,8);return e.use=()=>(this.program!==e&&(this.program=e,this.useProgram(e)),this.updateBlending(),e),e.vao=r,e.a_Position=t,e.a_LightCoord=i,e.u_Matrix=a,e.u_LightMode=n,e.u_LightColor=s,e},We.createGraphicProgram=function(){const e=this.createProgramWithShaders(`
    attribute   vec2        a_Position;
    attribute   vec4        a_Color;
    uniform     mat3        u_Matrix;
    varying     vec4        v_Color;

    void main() {
      gl_Position.xyw = u_Matrix * vec3(a_Position, 1.0);
      v_Color = a_Color;
    }
    `,`
    precision   highp       float;
    varying     vec4        v_Color;
    uniform     float       u_Alpha;

    void main() {
      gl_FragColor.rgb = v_Color.rgb;
      gl_FragColor.a = v_Color.a * u_Alpha;
    }
    `);this.useProgram(e);var t=this.getAttribLocation(e,"a_Position"),i=this.getAttribLocation(e,"a_Color"),a=this.getUniformLocation(e,"u_Matrix");const n=this.getUniformLocation(e,"u_Alpha");var s=this.createVertexArray();this.bindVertexArray(s),this.enableVertexAttribArray(t),this.enableVertexAttribArray(i),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(t,2,this.FLOAT,!1,12,0),this.vertexAttribPointer(i,4,this.UNSIGNED_BYTE,!0,12,8),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.elementBuffer),s.a10=this.createVertexArray(),this.bindVertexArray(s.a10),this.enableVertexAttribArray(t),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(t,2,this.FLOAT,!1,0,0),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.elementBuffer);return e.use=()=>(this.program!==e&&(this.program=e,this.useProgram(e)),e.alpha!==this.alpha&&(e.alpha=this.alpha,this.uniform1f(n,e.alpha)),this.updateBlending(),e),e.vao=s,e.alpha=0,e.a_Position=t,e.a_Color=i,e.u_Matrix=a,e},We.createDashedLineProgram=function(){const e=this.createProgramWithShaders(`
    attribute   vec2        a_Position;
    attribute   float       a_Distance;
    uniform     mat3        u_Matrix;
    varying     float       v_Distance;

    void main() {
      gl_Position.xyw = u_Matrix * vec3(a_Position, 1.0);
      v_Distance = a_Distance;
    }
    `,`
    precision   highp       float;
    const       float       REPEAT = 4.0;
    varying     float       v_Distance;
    uniform     float       u_Alpha;
    uniform     vec4        u_Color;

    void main() {
      float alpha = floor(2.0 * fract(v_Distance / REPEAT));
      gl_FragColor.rgb = u_Color.rgb;
      gl_FragColor.a = u_Color.a * alpha * u_Alpha;
    }
    `);this.useProgram(e);var t=this.getAttribLocation(e,"a_Position"),i=this.getAttribLocation(e,"a_Distance"),a=this.getUniformLocation(e,"u_Matrix");const n=this.getUniformLocation(e,"u_Alpha");var s=this.getUniformLocation(e,"u_Color"),r=this.createVertexArray();this.bindVertexArray(r),this.enableVertexAttribArray(t),this.enableVertexAttribArray(i),this.bindBuffer(this.ARRAY_BUFFER,this.vertexBuffer),this.vertexAttribPointer(t,2,this.FLOAT,!1,12,0),this.vertexAttribPointer(i,1,this.FLOAT,!1,12,8);return e.use=()=>(this.program!==e&&(this.program=e,this.useProgram(e)),e.alpha!==this.alpha&&(e.alpha=this.alpha,this.uniform1f(n,e.alpha)),this.updateBlending(),e),e.vao=r,e.alpha=0,e.a_Position=t,e.a_Distance=i,e.u_Matrix=a,e.u_Color=s,e},We.reset=function(){this.blend="normal",this.alpha=1,this.matrix.reset()},We.updateMasking=function(){this.program.masking!==this.masking&&(this.program.masking=this.masking,this.masking?(this.uniform1i(this.program.u_Masking,1),this.uniform1i(this.program.u_MaskSampler,1),this.activeTexture(this.TEXTURE1),this.bindTexture(this.TEXTURE_2D,this.maskTexture.base.glTexture)):(this.uniform1i(this.program.u_Masking,0),this.uniform1i(this.program.u_MaskSampler,0),this.activeTexture(this.TEXTURE1),this.bindTexture(this.TEXTURE_2D,null)),this.activeTexture(this.TEXTURE0)),this.masking&&this.uniform2f(this.program.u_Viewport,this.width,this.height)},We.createBlendingUpdater=function(){this.enable(this.BLEND);const e={normal:()=>{this.blendEquation(this.FUNC_ADD),this.blendFuncSeparate(this.SRC_ALPHA,this.ONE_MINUS_SRC_ALPHA,this.ONE,this.ZERO)},screen:()=>{this.blendEquation(this.FUNC_ADD),this.blendFunc(this.ONE,this.ONE_MINUS_SRC_COLOR)},additive:()=>{this.blendEquation(this.FUNC_ADD),this.blendFuncSeparate(this.SRC_ALPHA,this.DST_ALPHA,this.ONE,this.ZERO)},subtract:()=>{this.blendEquation(this.FUNC_REVERSE_SUBTRACT),this.blendFuncSeparate(this.SRC_ALPHA,this.DST_ALPHA,this.ONE,this.ZERO)},upper:()=>{this.blendEquation(this.FUNC_ADD),this.blendFuncSeparate(this.SRC_ALPHA,this.ONE_MINUS_SRC_ALPHA,this.ONE,this.ONE_MINUS_SRC_ALPHA)},lower:()=>{this.blendEquation(this.FUNC_ADD),this.blendFuncSeparate(this.ONE_MINUS_DST_ALPHA,this.DST_ALPHA,this.ONE_MINUS_DST_ALPHA,this.ONE)},max:()=>{this.blendEquation(this.MAX)},copy:()=>{this.disable(this.BLEND),a=i}};var t=()=>{(a=e)[n](),this.enable(this.BLEND)};const i={normal:t,screen:t,additive:t,subtract:t,upper:t,lower:t,max:t};let a=e,n="";return()=>{n!==this.blend&&a[n=this.blend]()}},We.setContrast=function(e){if(this.contrast!==e){this.contrast=e;var t=this.program;for(const i of[this.imageProgram,this.tileProgram,this.spriteProgram])this.useProgram(i),this.uniform1f(i.u_Contrast,e);this.useProgram(t)}},We.setAmbientLight=function({red:e,green:t,blue:i}){var a=this.ambient;if(a.red!==e||a.green!==t||a.blue!==i){a.red=e,a.green=t,a.blue=i;var e=this.program,n=a.red/255,s=a.green/255,r=a.blue/255;for(const o of[this.imageProgram,this.tileProgram])this.useProgram(o),this.uniform3f(o.u_Ambient,n,s,r);this.useProgram(e)}},We.resizeLightmap=function(){var e,t,{lightmap:i,width:a,height:n}=this;i.innerWidth===a&&i.innerHeight===n||(i.innerWidth=a,i.innerHeight=n,void 0===i.paddingLeft&&(t=He.config["lightArea"],i.paddingLeft=Math.min(4*t.expansionLeft,1024),i.paddingTop=Math.min(4*t.expansionTop,1024),i.paddingRight=Math.min(4*t.expansionRight,1024),i.paddingBottom=Math.min(4*t.expansionBottom,1024)),t=i.paddingLeft,e=i.paddingTop,a=a+t+i.paddingRight,t=n+e+i.paddingBottom,i.scaleX=0,i.scaleY=0,i.resize(a,t),this.bindTexture(this.TEXTURE_2D,null),this.updateLightTexSize())},We.updateLightTexSize=function(){var e=this.lightmap;if(0!==e.width){var t=this.drawingBufferWidth,i=this.drawingBufferHeight,a=e.width/t*2,n=e.height/i*2,s=(e.paddingLeft+t/2)/e.width,r=(e.paddingTop+i/2)/e.height;const o=this.program;for(const o of[this.imageProgram,this.tileProgram,this.spriteProgram])this.useProgram(o),this.uniform4f(o.u_LightTexSize,a,n,s,r);this.useProgram(o)}},We.updateSamplerNum=function(t){var e=this.program,i=e.samplerNum;if(i!==t){var a=e.u_Samplers;if(i<t)for(let e=i;e<t;e++)this.uniform1i(a[e],e);else for(let e=t;e<i;e++)this.uniform1i(a[e],0);e.samplerNum=t}},We.bindFBO=function(e){this.binding=e,this.flip=1,this.bindFramebuffer(this.FRAMEBUFFER,e)},We.unbindFBO=function(){this.binding=null,this.flip=-1,this.bindFramebuffer(this.FRAMEBUFFER,null)},We.setViewport=function(e,t,i,a){this.width=i,this.height=a,this.viewport(e,t,i,a)},We.resetViewport=function(){var e=this.drawingBufferWidth,t=this.drawingBufferHeight;this.width=e,this.height=t,this.viewport(0,0,e,t)},We.resize=function(e,t){var i=this.canvas;i.width!==e&&(i.width=e),i.height!==t&&(i.height=t),null!==this.binding||this.width===e&&this.height===t||(this.width=e,this.height=t,this.viewport(0,0,e,t),this.maskTexture.resize(e,t))},We.drawImage=function(){const v=new Uint8Array(4);return function(e,t,i,a,n,s=v){var r,o,l,c,h,d,u,p,m,g,f;e.complete&&(r=this.imageProgram.use(),o=this.arrays[0].float32,l=e.base,u=e.x,g=e.y,p=e.width,e=e.height,m=l.width,f=l.height,c=Ze.instance.project(this.flip,this.width,this.height).multiply(this.matrix),a=(t=t+.004)+a,n=(i=i+.004)+n,h=u/m,d=g/f,u=(u+p)/m,p=(g+e)/f,o[0]=t,o[1]=i,o[2]=h,o[3]=d,o[4]=t,o[5]=n,o[6]=h,o[7]=p,o[8]=a,o[9]=n,o[10]=u,o[11]=p,o[12]=a,o[13]=i,o[14]=u,o[15]=d,m=s[0]/255,g=s[1]/255,e=s[2]/255,f=s[3]/255,this.bindVertexArray(r.vao),this.uniformMatrix3fv(r.u_Matrix,!1,c),this.uniform1i(r.u_LightMode,0),this.uniform1i(r.u_ColorMode,0),this.uniform4f(r.u_Tint,m,g,e,f),this.bufferData(this.ARRAY_BUFFER,o,this.STREAM_DRAW,0,16),this.bindTexture(this.TEXTURE_2D,l.glTexture),this.drawArrays(this.TRIANGLE_FAN,0,4))}}(),We.drawSliceImage=function(e,t,i,a,n,s,r,o){if(e.complete){var t=Ze.instance.project(this.flip,this.width,this.height).multiply(this.matrix).translate(t+.004,i+.004),i=e["sliceClip"],i=(e.sliceWidth===a&&e.sliceHeight===n&&i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&e.sliceBorder===r||e.updateSliceData(a,n,s,r),o[0]/255),a=o[1]/255,n=o[2]/255,s=o[3]/255,l=this.imageProgram.use(),r=e.sliceVertices,c=e.sliceThresholds,h=e.sliceCount;this.bindVertexArray(l.vao),this.uniformMatrix3fv(l.u_Matrix,!1,t),this.uniform1i(l.u_LightMode,0),this.uniform1i(l.u_ColorMode,2),this.uniform4f(l.u_Tint,i,a,n,s),this.bufferData(this.ARRAY_BUFFER,r,this.STREAM_DRAW,0,16*h),this.bindTexture(this.TEXTURE_2D,e.base.glTexture);for(let e=0;e<h;e++){var d=4*e,u=c[d],p=c[1+d],m=c[2+d],d=c[3+d];this.uniform4f(l.u_Repeat,u,p,m,d),this.drawArrays(this.TRIANGLE_FAN,4*e,4)}}},We.drawText=function(e,t,i,a,n,s){var r,o,l,c,h,d,u,p,m,g,f,v,b,y,w,x,k;e.complete&&(r=this.textProgram.use(),o=this.arrays[0].float32,l=this.arrays[0].uint32,c=e.base,x=e.x,h=e.y,k=e.width,e=e.height,d=c.width,u=c.height,a=(t=t)+a,n=(i=i)+n,p=(b=Ze.instance.project(this.flip,this.width,this.height).multiply(this.matrix))[0],m=b[1],g=b[3],f=b[4],v=b[6],b=b[7],y=x/d,w=h/u,x=(x+k)/d,k=(h+e)/u,o[0]=p*t+g*i+v,o[1]=m*t+f*i+b,o[2]=y,o[3]=w,l[4]=s,o[5]=p*t+g*n+v,o[6]=m*t+f*n+b,o[7]=y,o[8]=k,l[9]=s,o[10]=p*a+g*n+v,o[11]=m*a+f*n+b,o[12]=x,o[13]=k,l[14]=s,o[15]=p*a+g*i+v,o[16]=m*a+f*i+b,o[17]=x,o[18]=w,l[19]=s,this.bindVertexArray(r.vao),this.bufferData(this.ARRAY_BUFFER,o,this.STREAM_DRAW,0,20),this.bindTexture(this.TEXTURE_2D,c.glTexture),this.drawArrays(this.TRIANGLE_FAN,0,4))},We.fillRect=function(e,t,i,a,n){var s=this.graphicProgram.use(),r=this.arrays[0].float32,o=this.arrays[0].uint32,l=Ze.instance.project(this.flip,this.width,this.height).multiply(this.matrix),c=e,h=t,e=e+i,i=t+a;r[0]=c,r[1]=h,o[2]=n,r[3]=c,r[4]=i,o[5]=n,r[6]=e,r[7]=i,o[8]=n,r[9]=e,r[10]=h,o[11]=n,this.bindVertexArray(s.vao),this.uniformMatrix3fv(s.u_Matrix,!1,l),this.bufferData(this.ARRAY_BUFFER,r,this.STREAM_DRAW,0,12),this.drawArrays(this.TRIANGLE_FAN,0,4)},We.createContext2D=function(){const i=document.createElement("canvas");i.width=0,i.height=0;var e=i.getContext("2d");return e.resize=function(e,t){i.width===e&&i.height===t?i.width=e:(i.width!==e&&(i.width=e),i.height!==t&&(i.height=t))},e},We.fillTextWithOutline=function(){const S=[{ox:-1,oy:0,rgba:0},{ox:1,oy:0,rgba:0},{ox:0,oy:-1,rgba:0},{ox:0,oy:1,rgba:0},{ox:0,oy:0,rgba:0}];return function(t,e,i,a,n){var s=this.context2d,r=s.size,o=s.measureText(t).width,l=(e-=o/2,Math.ceil(r/10)),c=Math.floor(e);const h=e-c,d=.85*r;var u=r+l,p=Math.min(16384,Math.ceil(o+s.paddingItalic+h));if(0<e+p&&e<this.width&&0<i+u&&i<this.height){var r=s.font,l=(s.resize(p,u),s.font=r,s.fillStyle="#ffffff",s.fillText(t,h,d),S[0].rgba=n,S[1].rgba=n,S[2].rgba=n,S[3].rgba=n,S[4].rgba=a,this.textProgram.use()),m=this.arrays[0].float32,g=this.arrays[0].uint32,o=this.matrix.project(this.flip,this.width,this.height),f=o[0],v=o[1],b=o[3],y=o[4],w=o[6],x=o[7];let e=0;for(const{ox:h,oy:d,rgba:M}of S){var k=c+h,T=i+d,I=k+p,C=T+u,E=f*k+b*T+w,k=v*k+y*T+x,T=f*I+b*C+w,I=v*I+y*C+x;m[e]=E,m[e+1]=k,m[e+2]=0,m[e+3]=0,g[e+4]=M,m[e+5]=E,m[e+6]=I,m[e+7]=0,m[e+8]=1,g[e+9]=M,m[e+10]=T,m[e+11]=I,m[e+12]=1,m[e+13]=1,g[e+14]=M,m[e+15]=T,m[e+16]=k,m[e+17]=1,m[e+18]=0,g[e+19]=M,e+=20}this.stencilTexture.fromImage(s.canvas),this.bindVertexArray(l.vao),this.bufferData(this.ARRAY_BUFFER,m,this.STREAM_DRAW,0,e),this.drawElements(this.TRIANGLES,30,this.UNSIGNED_INT,0)}}}(),We.createNormalTexture=function(e={}){var t=e.magFilter??this.NEAREST,i=e.minFilter??this.LINEAR,a=new Ye;return a.magFilter=t,a.minFilter=i,a.format=e.format??We.RGBA,this.bindTexture(this.TEXTURE_2D,a.glTexture),this.texParameteri(this.TEXTURE_2D,this.TEXTURE_MAG_FILTER,t),this.texParameteri(this.TEXTURE_2D,this.TEXTURE_MIN_FILTER,i),this.texParameteri(this.TEXTURE_2D,this.TEXTURE_WRAP_S,this.CLAMP_TO_EDGE),this.texParameteri(this.TEXTURE_2D,this.TEXTURE_WRAP_T,this.CLAMP_TO_EDGE),this.textureManager.append(a),a},We.createImageTexture=function(e,t={}){const i=t.magFilter??this.NEAREST,a=t.minFilter??this.LINEAR,n=e instanceof Image?e.guid:e,s=this.textureManager;let r=s.images[n];return r||((r=new Ye).guid=n,r.image=null,r.refCount=0,r.magFilter=i,r.minFilter=a,s.append(r),s.images[n]=r,t=e=>{s.images[n]===r&&e?(r.image=e,r.width=e.naturalWidth,r.height=e.naturalHeight,this.bindTexture(this.TEXTURE_2D,r.glTexture),this.texParameteri(this.TEXTURE_2D,this.TEXTURE_MAG_FILTER,i),this.texParameteri(this.TEXTURE_2D,this.TEXTURE_MIN_FILTER,a),this.texParameteri(this.TEXTURE_2D,this.TEXTURE_WRAP_S,this.CLAMP_TO_EDGE),this.texParameteri(this.TEXTURE_2D,this.TEXTURE_WRAP_T,this.CLAMP_TO_EDGE),this.texImage2D(this.TEXTURE_2D,0,this.RGBA,this.RGBA,this.UNSIGNED_BYTE,e),r.reply("load")):r.reply("error")},e instanceof Image?t(e):R.get({guid:n,type:"image"}).then(t)),r.refCount++,r},We.createTextureFBO=function(i){var e=this.createFramebuffer();this.bindFramebuffer(this.FRAMEBUFFER,e),this.framebufferTexture2D(this.FRAMEBUFFER,this.COLOR_ATTACHMENT0,this.TEXTURE_2D,i.base.glTexture,0);const a=this.createRenderbuffer();return this.bindRenderbuffer(this.RENDERBUFFER,a),this.framebufferRenderbuffer(this.FRAMEBUFFER,this.DEPTH_STENCIL_ATTACHMENT,this.RENDERBUFFER,a),this.renderbufferStorage(this.RENDERBUFFER,this.DEPTH_STENCIL,i.base.width,i.base.height),this.bindRenderbuffer(this.RENDERBUFFER,null),this.bindFramebuffer(this.FRAMEBUFFER,null),i.depthStencilBuffer=a,i.resize=(e,t)=>{je.prototype.resize.call(i,e,t),this.bindRenderbuffer(this.RENDERBUFFER,a),this.renderbufferStorage(this.RENDERBUFFER,this.DEPTH_STENCIL,e,t),this.bindRenderbuffer(this.RENDERBUFFER,null)},e};class Ye{constructor(){this.glTexture=We.createTexture(),this.width=0,this.height=0}restoreNormalTexture(){this.glTexture=We.createTexture();var{format:e,width:t,height:i}=this;We.bindTexture(We.TEXTURE_2D,this.glTexture),We.texParameteri(We.TEXTURE_2D,We.TEXTURE_MAG_FILTER,this.magFilter),We.texParameteri(We.TEXTURE_2D,We.TEXTURE_MIN_FILTER,this.minFilter),We.texParameteri(We.TEXTURE_2D,We.TEXTURE_WRAP_S,We.CLAMP_TO_EDGE),We.texParameteri(We.TEXTURE_2D,We.TEXTURE_WRAP_T,We.CLAMP_TO_EDGE),We.texImage2D(We.TEXTURE_2D,0,e,t,i,0,e,We.UNSIGNED_BYTE,null)}restoreImageTexture(){this.glTexture=We.createTexture(),We.bindTexture(We.TEXTURE_2D,this.glTexture),We.texParameteri(We.TEXTURE_2D,We.TEXTURE_MAG_FILTER,this.magFilter),We.texParameteri(We.TEXTURE_2D,We.TEXTURE_MIN_FILTER,this.minFilter),We.texParameteri(We.TEXTURE_2D,We.TEXTURE_WRAP_S,We.CLAMP_TO_EDGE),We.texParameteri(We.TEXTURE_2D,We.TEXTURE_WRAP_T,We.CLAMP_TO_EDGE),We.texImage2D(We.TEXTURE_2D,0,We.RGBA,We.RGBA,We.UNSIGNED_BYTE,this.image)}on(e,t){let i=this[Ye.CALLBACK];i===e?t(this):"object"==typeof(i=void 0===i?this[Ye.CALLBACK]={load:[],error:[]}:i)&&i[e].push(t)}reply(e){var t=this[Ye.CALLBACK];if("object"==typeof t)for(const i of t[e])i(this);this[Ye.CALLBACK]=e}static CALLBACK=Symbol("LOAD_CALLBACK")}class je{complete;base;gl;x;y;width;height;constructor(e={}){new.target===je&&(this.complete=!0,this.base=We.createNormalTexture(e),this.gl=We,this.x=0,this.y=0,this.width=0,this.height=0)}clip(e,t,i,a){return this.x=e,this.y=t,this.width=i,this.height=a,this}clear(e=0,t=0,i=0,a=0){var n=this.gl;n.bindFBO(n.frameBuffer),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.base.glTexture,0),n.clearColor(e,t,i,a),n.clear(n.COLOR_BUFFER_BIT),n.unbindFBO()}resize(e,t){var{gl:i,base:a}=this,n=a["format"];return a.width=e,a.height=t,i.bindTexture(i.TEXTURE_2D,a.glTexture),i.texImage2D(i.TEXTURE_2D,0,n,e,t,0,n,i.UNSIGNED_BYTE,null),this.clip(0,0,e,t)}fromImage(e){var t=this.gl,i=this.base,a=i.format,n=e.width,s=e.height;return i.image=e,i.width=n,i.height=s,t.bindTexture(t.TEXTURE_2D,i.glTexture),t.texImage2D(t.TEXTURE_2D,0,a,a,t.UNSIGNED_BYTE,e),this.clip(0,0,n,s)}getImageData(e,t,i,a){var n,s,r,o=this.gl,l=this.base;return l instanceof WebGLTexture?({buffer:r,length:s}=(n=o.context2d.createImageData(i,a)).data,r=new Uint8Array(r,0,s),o.bindFramebuffer(o.FRAMEBUFFER,o.frameBuffer),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,l.glTexture,0),o.readPixels(e,t,i,a,o.RGBA,o.UNSIGNED_BYTE,r),o.binding?o.bindFBO(o.binding):o.unbindFBO(),n):null}destroy(){this.base&&(this.complete=!1,this.gl.textureManager.delete(this.base),this.base=null)}}class $e extends je{constructor(e,t={}){super(t);const i=We.createImageTexture(e,t);this.complete=!1,this.base=i,this.gl=We,this.x=0,this.y=0,this.width=0,this.height=0,i.on("load",()=>{this.base===i&&(this.complete=!0,this.width=this.width||i.width,this.height=this.height||i.height,this.reply("load"))}),i.on("error",()=>{this.destroy(),this.reply("error")})}updateSliceData(n,s,r,o){if(this.complete){var{min:l,max:c}=Math;const[w,x,k,T]=r;var h=l(o,k/2,T/2),d=c(k-2*h,0),m=c(T-2*h,0),g=c(n-2*h,0),c=c(s-2*h,0);let e,t,i,a;t=0<g?e=h:n-(e=l(h,n)),a=0<c?i=h:s-(i=l(h,s)),this.sliceClip||(this.sliceClip=new Uint32Array(4),this.sliceVertices=new Float32Array(144),this.sliceThresholds=new Float32Array(36),l=this["gl"],this.base.magFilter=l.NEAREST,this.base.minFilter=l.NEAREST,l.bindTexture(l.TEXTURE_2D,this.base.glTexture),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST));const I=this.base.width,C=this.base.height,E=this.sliceVertices,M=this.sliceThresholds;let u=0,p=0;var l=(e,t,i,a,n,s,r,o)=>{var l,c,h,d;i*a*r*o!=0&&(l=(n=n)+r,c=(s=s)+o,h=(w+e)/I,d=(x+t)/C,e=(w+e+r)/I,r=(x+t+o)/C,E[u]=n,E[u+1]=s,E[u+2]=h,E[u+3]=d,E[u+4]=n,E[u+5]=c,E[u+6]=h,E[u+7]=r,E[u+8]=l,E[u+9]=c,E[u+10]=e,E[u+11]=r,E[u+12]=l,E[u+13]=s,E[u+14]=e,E[u+15]=d,M[p]=h,M[p+1]=d,M[p+2]=i/I,M[p+3]=a/C,u+=16,p+=4)},f=h+d,v=h+m,b=e+g,y=i+c;l(h,h,d,m,e,i,g,c),l(0,0,h,h,0,0,e,i),l(h,0,d,h,e,0,g,i),l(f,0,h,h,b,0,t,i),l(0,h,h,m,0,i,e,c),l(f,h,h,m,b,i,t,c),l(0,v,h,h,0,y,e,a),l(h,v,d,h,e,y,g,a),l(f,v,h,h,b,y,t,a),this.sliceClip.set(r),this.sliceWidth=n,this.sliceHeight=s,this.sliceBorder=o,this.sliceCount=u/16}}destroy(){this.base&&(this.complete=!1,0==--this.base.refCount&&this.gl.textureManager.delete(this.base),this.base=null)}}$e.prototype.on=Ye.prototype.on,$e.prototype.reply=Ye.prototype.reply;class Xe{gl;map;images;pointer;count;constructor(){this.gl=We,this.map={},this.images={},this.pointer=0,this.count=0}updateImage(i){const a=this.images[i];void 0!==a&&R.get({guid:i,type:"image"}).then(e=>{var t;this.images[i]===a&&e&&(t=this["gl"],a.image=e,a.width=e.naturalWidth,a.height=e.naturalHeight,t.bindTexture(t.TEXTURE_2D,a.glTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e))})}append(t){if(void 0===t.index){let e=this.pointer;for(var i=this.map;void 0!==i[e];)e++;(i[e]=t).index=e,this.pointer=e+1,this.count++}}delete(e){var t=e.index,{gl:i,map:a}=this;i.deleteTexture(e.glTexture),0===e.refCount&&delete this.images[e.guid],a[t]===e&&(delete a[t],this.count--,this.pointer>t)&&(this.pointer=t)}clear(){var{gl:e,map:t,images:i}=this;for(const a of Object.values(t))void 0===a.protected&&(delete t[a.index],e.deleteTexture(a.glTexture),this.count--,this.pointer>a.index)&&(this.pointer=a.index);for(const n of Object.values(i))void 0===n.protected&&delete i[n.guid]}replace(e,t){t.index=e.index,this.map[e.index]&&(this.map[e.index]=t),e instanceof $e&&e.guid===t.guid&&this.images[e.guid]===e&&(this.images[e.guid]=t)}restore(){for(const e of Object.values(this.map))e.onRestore?e.onRestore(e):void 0!==e.image?e.restoreImageTexture():e.restoreNormalTexture()}}class Ge{response;setAttrSize;getEndIndex;setBlendMode;bindProgram;unbindProgram;push;draw;constructor(s){const t=s.arrays[0].float32,r=s.textureManager.map,o=s.maxTexUnits-1,l=new Uint32Array(262144),c=o+3,h=new Int8Array(1e4).fill(-1),a=new Uint32Array(2);let d=0,u=0,p=0,m=0,g=0,f="normal",v=null;const i=()=>{if(0!==g){if(0!==p){for(let e=0;e<p;e++)h[l[u+e]]=-1;var e=u+o;l[e]=p,l[e+1]=m,l[e+2]=g,u+=c,p=0}null!==v&&v!==s.program&&(v.use(),s.bindVertexArray(v.vao));e=g*d;0<e&&s.bufferData(s.ARRAY_BUFFER,t,s.STREAM_DRAW,0,e),s.blend=f,s.updateBlending();for(let t=0;t<u;t+=c){var i=t+c,a=l[i-3],n=1.5*l[i-2],i=1.5*l[i-1];for(let e=a-1;0<=e;e--)s.activeTexture(s.TEXTURE0+e),s.bindTexture(s.TEXTURE_2D,r[l[t+e]].glTexture);s.updateSamplerNum(a),s.drawElements(s.TRIANGLES,i-n,s.UNSIGNED_INT,4*n)}u=0,m=0,g=0}};this.response=a,this.setAttrSize=e=>{d=e},this.getEndIndex=()=>g,this.setBlendMode=e=>{f!==e&&(i(),f=e)},this.bindProgram=()=>{v=s.program},this.unbindProgram=()=>{v=null},this.push=e=>{let t=h[e];if(-1===t){if((t=p)===o){for(let e=0;e<p;e++)h[l[u+e]]=-1;var i=u+o;l[i]=p,l[i+1]=m,l[i+2]=g,m=g,u+=c,p=0,t=0}l[u+t]=e,h[e]=t,p+=1}a[0]=g,a[1]=t,g+=4},this.draw=i}}class Ve{constructor(e=0,t=0){this.x=e,this.y=t}get length(){var{x:e,y:t}=this;return Math.sqrt(e*e+t*t)}set length(e){var t=this["length"];0!==t&&(this.x*=e=e/t,this.y*=e)}set(e,t){return this.x=e,this.y=t,this}add(e){return this.x+=e.x,this.y+=e.y,this}cos(e){return(this.x*e.x+this.y*e.y)/(Math.sqrt(this.x**2+this.y**2)*Math.sqrt(e.x**2+e.y**2))}sin(e){e=this.cos(e);return Math.sqrt(1-e**2)}normalize(){return this.length=1,this}static instances=[new Ve,new Ve,new Ve,new Ve,new Ve,new Ve,new Ve,new Ve]}class Ze extends Float32Array{constructor(){super(9),this[0]=1,this[4]=1,this[8]=1}reset(){return this[0]=1,this[1]=0,this[3]=0,this[4]=1,this[6]=0,this[7]=0,this}set(e){return this[0]=e[0],this[1]=e[1],this[3]=e[3],this[4]=e[4],this[6]=e[6],this[7]=e[7],this}set6f(e,t,i,a,n,s){return this[0]=e,this[1]=t,this[3]=i,this[4]=a,this[6]=n,this[7]=s,this}multiply(e){var t=this[0],i=this[1],a=this[3],n=this[4],s=this[6],r=this[7],o=e[0],l=e[1],c=e[3],h=e[4],d=e[6],e=e[7];return this[0]=t*o+a*l,this[1]=i*o+n*l,this[3]=t*c+a*h,this[4]=i*c+n*h,this[6]=t*d+a*e+s,this[7]=i*d+n*e+r,this}rotate(e){var t=Math.cos(e),e=Math.sin(e),i=this[0],a=this[1],n=this[3],s=this[4];return this[0]=i*t+n*e,this[1]=a*t+s*e,this[3]=n*t-i*e,this[4]=s*t-a*e,this}rotateAt(e,t,i){var a=Math.cos(i),i=Math.sin(i),n=this[0],s=this[1],r=this[3],o=this[4];return this[0]=n*a+r*i,this[1]=s*a+o*i,this[3]=r*a-n*i,this[4]=o*a-s*i,this[6]+=(n-this[0])*e+(r-this[3])*t,this[7]+=(s-this[1])*e+(o-this[4])*t,this}scale(e,t){return this[0]*=e,this[1]*=e,this[3]*=t,this[4]*=t,this}scaleAt(e,t,i,a){var n=this[0],s=this[1],r=this[3],o=this[4];return this[0]*=i,this[1]*=i,this[3]*=a,this[4]*=a,this[6]+=(n-this[0])*e+(r-this[3])*t,this[7]+=(s-this[1])*e+(o-this[4])*t,this}translate(e,t){return this[6]+=this[0]*e+this[3]*t,this[7]+=this[1]*e+this[4]*t,this}skewAt(e,t,i,a){var n=this[0],s=this[1],r=this[3],o=this[4];return this[0]=n+r*a,this[1]=s+o*a,this[3]=n*i+r,this[4]=s*i+o,this[6]+=(n-this[0])*e+(r-this[3])*t,this[7]+=(s-this[1])*e+(o-this[4])*t,this}mirrorh(){return this[0]=-this[0],this[3]=-this[3],this}mirrorv(){return this[1]=-this[1],this[4]=-this[4],this}project(e,t,i){return this[0]=2/t,this[1]=0,this[3]=0,this[4]=2*e/i,this[6]=-1,this[7]=-e,this}static instance=new Ze}We.initialize();const Je={context:null,player:null,analyser:null,waveforms:{},initialize:null,getWaveform:null,close:null};Je.initialize=function(){this.context=new AudioContext,this.analyser=this.context.createAnalyser(),this.analyser.connect(this.context.destination),this.player=new Qe},Je.getWaveform=function(m){const g=this.waveforms,e=g[m];switch(typeof e){case"string":return Promise.resolve().then(()=>e);case"object":return e}const t=g[m]=R.get({guid:m,type:"arraybuffer"}).then(e=>{if(g[m]===t){if(!t.canceled)return this.context.decodeAudioData(e).then(t=>{var i=document.createElement("canvas"),a=(i.width=512,i.height=160,i.getContext("2d")),n=t.numberOfChannels,s=8*i.width,r=i.height/n/2;let o=r;for(let e=0;e<n;e++){var l=t.getChannelData(e),c=Math.min(l.length,s),h=l.length/c,d=i.width/c,u=Math.floor;a.beginPath(),a.moveTo(0,o);for(let e=0;e<c;e++){var p=u(e*h),p=o+r*l[p];a.lineTo(e*d,p)}a.strokeStyle="white",a.stroke(),o+=2*r}return g[m]=`url(${i.toDataURL()})`});delete g[m]}});return t},Je.close=function(){this.player.stop(),this.waveforms={}};class Qe{audio;source;panner;reverb;constructor(){var e=Je["context"];this.audio=new Audio,this.source=e.createMediaElementSource(this.audio),this.panner=e.createStereoPanner(),this.reverb=null,this.audio.path="",this.source.connect(this.panner),this.panner.connect(Je.analyser)}play(e){var t;e?(t=this.audio).path===e&&4===t.readyState&&!0!==t.ended||(t.src=R.route(e),t.path=e,t.play()):this.stop()}stop(){var e=this.audio;e.path&&(e.pause(),e.currentTime=0,e.path="")}setVolume(e){this.audio.volume=Math.clamp(e,0,1)}setPan(e){this.panner.pan.value=Math.clamp(e,-1,1)}setReverb(e,t){null!==this.reverb||1===e&&0===t||new et(this),null!==this.reverb&&this.reverb.set(e,t)}getParams(){return{volume:Math.roundTo(this.audio.volume,2),pan:Math.roundTo(this.panner.pan.value,2),dry:this.reverb?Math.roundTo(this.reverb.dryGain.gain.value,2):1,wet:this.reverb?Math.roundTo(this.reverb.wetGain.gain.value/2,2):0}}}class et{player;input;output;dryGain;wetGain;convolver;dry;wet;constructor(e){var t=Je["context"];this.player=e,this.input=e.panner,this.output=Je.analyser,this.dryGain=t.createGain(),this.wetGain=t.createGain(),this.convolver=this.getConvolver(),this.dry=-1,this.wet=-1,this.connect()}connect(){(this.player.reverb=this).input.disconnect(this.output),this.input.connect(this.dryGain),this.dryGain.connect(this.output),this.input.connect(this.wetGain),this.wetGain.connect(this.convolver)}disconnect(){this.player.reverb=null,this.input.disconnect(this.dryGain),this.dryGain.disconnect(this.output),this.input.disconnect(this.wetGain),this.wetGain.disconnect(this.convolver),this.input.connect(this.output)}set(e,t){this.setDry(e),this.setWet(t),1===e&&0===t&&this.disconnect()}setDry(e){this.dry!==e&&(this.dry=e,this.dryGain.gain.value=e)}setWet(e){this.wet!==e&&(this.wet=e,this.wetGain.gain.value=2*e)}getConvolver(){if(!et.convolver){var e=Je.context,t=e.sampleRate,i=Math.round(2.1*t),a=e.createConvolver(),n=e.createBiquadFilter(),s=e.createBuffer(2,i,t),r=s.length,o=Math.round(.1*r/2.1),l=Math.round(2*r/2.1),c=Math.random;for(let e=0;e<s.numberOfChannels;e++){var h=s.getChannelData(e);for(let e=0;e<o;e++)h[e]=(2*c()-1)*e/o;for(let e=o;e<r;e++){var d=(r-e)/l;h[e]=(2*c()-1)*d}}a.buffer=s,n.type="lowpass",n.frequency.value=3e3,a.connect(n),n.connect(Je.analyser),et.convolver=a}return et.convolver}static convolver=null}class tt{texture;context;content;buffer;x;y;width;height;index;commands;paddingLeft;paddingTop;paddingRight;paddingBottom;lineHeight;lineSpacing;letterSpacing;breakable;_direction;_horizontalAlign;_verticalAlign;horizontal;alignmentFactorX;alignmentFactorY;wordWrap;truncate;printWidth;printHeight;fonts;styles;weights;sizes;colors;effects;constructor(e){e.base.printer=this,e.base.onRestore=tt.restoreTexture,this.texture=e,this.context=We.context2d,this.content="",this.buffer="",this.x=0,this.y=0,this.width=0,this.height=0,this.index=0,this.commands=null,this.paddingLeft=0,this.paddingTop=0,this.paddingRight=0,this.paddingBottom=0,this.lineHeight=0,this.lineSpacing=0,this.letterSpacing=0,this.breakable=!1,this.direction="horizontal-tb",this.horizontalAlign="left",this.verticalAlign="top",this.wordWrap=!1,this.truncate=!1,this.printWidth=null,this.printHeight=null,this.fonts=[tt.font],this.styles=["normal"],this.weights=["normal"],this.sizes=[tt.size],this.colors=[tt.color],this.effects=[tt.effect]}get direction(){return this._direction}set direction(e){switch(this._direction=e){case"horizontal-tb":this.horizontal=!0;break;case"vertical-lr":case"vertical-rl":this.horizontal=!1}}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(e){switch(this._horizontalAlign=e){case"left":this.alignmentFactorX=0;break;case"center":this.alignmentFactorX=.5;break;case"right":this.alignmentFactorX=1}}get verticalAlign(){return this._verticalAlign}set verticalAlign(e){switch(this._verticalAlign=e){case"top":this.alignmentFactorY=0;break;case"middle":this.alignmentFactorY=.5;break;case"bottom":this.alignmentFactorY=1}}reset(){this.content="",this.x=0,this.y=0,this.width=0,this.height=0,this.index=0,this.lineHeight=0,this.breakable=!1;var e=this.fonts,t=this.styles,i=this.weights,a=this.sizes,n=this.colors,s=this.effects;return 1!==e.length&&(this.fonts=[e[e.length-1]]),1!==t.length&&(this.styles=[t[t.length-1]]),1!==i.length&&(this.weights=[i[i.length-1]]),1!==a.length&&(this.sizes=[a[a.length-1]]),1!==n.length&&(this.colors=[n[n.length-1]]),1!==s.length&&(this.effects=[s[s.length-1]]),this}updateFont(){var e=this.styles[0],t=this.weights[0],i=this.sizes[0],a=this.fonts.join(", "),n=this.context;n.font=e+` normal ${t} ${i}px `+a,n.paddingItalic="italic"===e?Math.ceil(i/4):0,n.paddingVertical=Math.ceil(i/10),n.size=i}calculatePadding(){var e=this.context,t=this.effects[0],i=e["paddingItalic"],a=e["paddingVertical"];switch(t.type){case"none":this.paddingLeft=Math.max(-this.x,this.paddingLeft),this.paddingTop=Math.max(a-this.y,this.paddingTop),this.paddingRight=Math.max(i,this.paddingRight),this.paddingBottom=Math.max(a,this.paddingBottom);break;case"shadow":var{shadowOffsetX:n,shadowOffsetY:s}=t,r=Math.max(-n,0),o=Math.max(-s,0),n=Math.max(n,0),s=Math.max(s,0);this.paddingLeft=Math.max(r-this.x,this.paddingLeft),this.paddingTop=Math.max(o+a-this.y,this.paddingTop),this.paddingRight=Math.max(n+i,this.paddingRight),this.paddingBottom=Math.max(s+a,this.paddingBottom);break;case"stroke":r=Math.ceil(t.strokeWidth/2);this.paddingLeft=Math.max(r-this.x,this.paddingLeft),this.paddingTop=Math.max(r+a-this.y,this.paddingTop),this.paddingRight=Math.max(r+i,this.paddingRight),this.paddingBottom=Math.max(r+a,this.paddingBottom);break;case"outline":this.paddingLeft=Math.max(1-this.x,this.paddingLeft),this.paddingTop=Math.max(1+a-this.y,this.paddingTop),this.paddingRight=Math.max(1+i,this.paddingRight),this.paddingBottom=Math.max(1+a,this.paddingBottom)}}measureWidth(e){return this.horizontal?this.context.measureText(e).width:this.sizes[0]*e.length}measureHeight(i){if(this.horizontal)return this.sizes[0];{let t=0;var a=this.context,n=i.length;for(let e=0;e<n;e++)t=Math.max(t,a.measureText(i[e]).width);return t}}drawBuffer(){var t=this.buffer;if(""!==t){this.calculatePadding();var i=this.context,a=this.colors[0],n=this.effects[0],s=this.horizontal;let e=tt.lineWidth;0===e&&(e=this.measureWidth(t));var r=this.measureHeight(t),o=this.commands,l=tt.fetchCommand();o.push(l),l.string=t,l.x=this.x,l.y=this.y,l.font=i.font,l.size=i.size,l.color=a,l.effect=n,l.paddingItalic=i.paddingItalic,l.paddingVertical=i.paddingVertical,l.horizontalWidth=s?e:r,l.drawingMethod=tt[tt.drawingMethods[n.type]],tt.lineWidth=0,this.buffer="",this.breakable=!0,s?(this.x+=e,this.lineHeight=Math.max(this.lineHeight,r),this.width=Math.max(this.width,this.x),this.height=Math.max(this.height,this.y+this.lineHeight)):(this.y+=e,this.lineHeight=Math.max(this.lineHeight,r),this.width=Math.max(this.width,this.x+this.lineHeight),this.height=Math.max(this.height,this.y))}}computeTextPosition(){switch(this.direction){case"horizontal-tb":case"vertical-lr":break;case"vertical-rl":{var s=this.commands,r=s.length;let t=this.width,i=0,a,n;for(let e=0;e<r;e++){var o=s[e];if(a!==o.x){for(;i<e;)s[i++].x=t-n;void 0!==a&&(t-=o.x-a),a=o.x,n=0}n=Math.max(n,o.horizontalWidth)}for(;i<r;)s[i++].x=t-n;break}}if(this.horizontal){var a=this.alignmentFactorX;if(0!==a){var n=this.commands,e=this.letterSpacing,l=this.width+e;let t,i;for(let e=n.length-1;0<=e;e--){var c=n[e];i!==c.y&&(i=c.y,t=a*(l-c.x-c.horizontalWidth)),c.x+=t}}}else{var h=this.alignmentFactorY;if(0!==h){var d=this.commands,u=this.letterSpacing,p=this.height+u;let t,i;for(let e=d.length-1;0<=e;e--){var m=d[e];t!==m.x&&(t=m.x,i=h*(p-m.y-m.string.length*(m.size+u))),m.y+=i}}}}executeCommands(){var e=We,t=this.texture.base,i=(e.bindFBO(e.frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.glTexture,0),e.setViewport(0,0,t.width,t.height),e.reset(),this.commands);const a=i.length;var n=this.horizontal,s=this.paddingLeft,r=this.paddingTop,o=this.letterSpacing,l=tt.charWidths;let c=0;for(let e=0;e<a;e++){var h=i[e],d=h.string,u=h.drawingMethod;if(h.x+=s,h.y+=r,n)if(0!==o){const a=d.length;for(let e=0;e<a;e++){var p=l[c++];h.horizontalWidth=p,u(h,d[e]),h.x+=p+o}}else u(h,d);else{var m=h.size;const a=d.length;for(let e=0;e<a;e++)u(h,d[e]),h.y+=m+o}}this.commands=null,e.unbindFBO(),e.resetViewport(),tt.resetCommands()}newLine(){this.breakable&&(this.breakable=!1,this.horizontal?(this.x=0,this.y+=(this.lineHeight||this.sizes[0])+this.lineSpacing):(this.x+=(this.lineHeight||this.sizes[0])+this.lineSpacing,this.y=0),this.lineHeight=0)}draw(e){this.content=e,this.index=0,this.commands=[],this.paddingLeft=0,this.paddingTop=0,this.paddingRight=0,this.paddingBottom=0,this.updateFont();var t=this.wordWrap,i=this.truncate,a=this.horizontal,n=this.printWidth,s=this.printHeight,r=this.letterSpacing,o=tt.charWidths,l=e.length;let c=0,h=0;for(;this.index<l;){var d=e[this.index];if("<"!==d||!this.matchTag())if("\n"===d)this.drawBuffer(),this.newLine(),this.index+=1;else{if(i&&(a?this.y+Math.max(this.lineHeight,this.measureHeight(d))>s:this.x+Math.max(this.lineHeight,this.measureHeight(d))>n)){this.drawBuffer();break}t&&(a?this.x+tt.lineWidth+(h=this.measureWidth(d))>n:this.y+tt.lineWidth+(h=this.measureWidth(d))>s)&&(this.breakable||0!==this.buffer.length)?(this.drawBuffer(),this.newLine()):(0!==r&&(!1===t&&(h=this.measureWidth(d)),o[c++]=h,tt.lineWidth+=r),tt.lineWidth+=h,this.buffer+=d,this.index+=1)}}this.drawBuffer(),a?this.width=Math.max(this.width-r,0):this.height=Math.max(this.height-r,0);var u=Math.ceil(this.width+this.paddingLeft+this.paddingRight),p=Math.ceil(this.height+this.paddingTop+this.paddingBottom);this.texture.resize(Math.min(u,16384),Math.min(p,16384)),this.computeTextPosition(),this.executeCommands()}matchTag(){var e,t,i,a=tt.regexps,n=this.index,s=this.content.indexOf(">",n+1)+1,n=this.content.slice(n,s);let r;return(r=n.match(a.colorIndex))?(s=parseInt(r[1]),s=He.config.indexedColors[s].code,s=o(s),this.drawBuffer(),this.colors.unshift(s),this.index+=r[0].length,!0):(r=n.match(a.color))?(s=parseInt(r[1],16)+256*(parseInt(r[2],16)+256*(parseInt(r[3],16)+256*parseInt(r[4]||"ff",16))),this.drawBuffer(),this.colors.unshift(s),this.index+=r[0].length,!0):(r=n.match(a.colorRestore))&&1<this.colors.length?(this.drawBuffer(),this.colors.shift(),this.index+=r[0].length,!0):(r=n.match(a.font))?(s=""+r[1]+(r[2]?", "+r[2]:""),this.drawBuffer(),this.fonts.unshift(s),this.updateFont(),this.index+=r[0].length,!0):(r=n.match(a.fontRestore))&&1<this.fonts.length?(this.drawBuffer(),this.fonts.shift(),this.updateFont(),this.index+=r[0].length,!0):(r=n.match(a.italic))?(this.drawBuffer(),this.styles.unshift("italic"),this.updateFont(),this.index+=r[0].length,!0):(r=n.match(a.italicRestore))&&1<this.styles.length?(this.drawBuffer(),this.styles.shift(),this.updateFont(),this.index+=r[0].length,!0):(r=n.match(a.bold))?(this.drawBuffer(),this.weights.unshift("bold"),this.updateFont(),this.index+=r[0].length,!0):(r=n.match(a.boldRestore))&&1<this.weights.length?(this.drawBuffer(),this.weights.shift(),this.updateFont(),this.index+=r[0].length,!0):(r=n.match(a.fontSize))?(s=parseInt(r[1]),this.drawBuffer(),this.sizes.unshift(s),this.updateFont(),this.index+=r[0].length,!0):(r=n.match(a.fontSizeRestore))&&1<this.sizes.length?(this.drawBuffer(),this.sizes.shift(),this.updateFont(),this.index+=r[0].length,!0):(r=n.match(a.textPosition))?(s=r[1].toLowerCase(),i=r[2]||"set",t=parseInt(r[3]),this.drawBuffer(),i="set"===i?t:"add"===i?this[s]+t:null,this[s]=Math.max(i,0),this.index+=r[0].length,!0):(r=n.match(a.textShadow))?(t=parseInt(r[3],16),s=parseInt(r[4],16),i=parseInt(r[5],16),e=parseInt(r[6]||"ff",16),t={type:"shadow",shadowOffsetX:parseInt(r[1]),shadowOffsetY:parseInt(r[2]),color:t+256*(s+256*(i+256*e))},this.drawBuffer(),this.effects.unshift(t),this.index+=r[0].length,!0):(r=n.match(a.textShadowRestore))&&1<this.effects.length&&"shadow"===this.effects[0].type?(this.drawBuffer(),this.effects.shift(),this.index+=r[0].length,!0):(r=n.match(a.textStroke))?(s=parseInt(r[2],16),i=parseInt(r[3],16),e=parseInt(r[4],16),t=parseInt(r[5]||"ff",16),s={type:"stroke",strokeWidth:parseInt(r[1]),color:s+256*(i+256*(e+256*t))},this.drawBuffer(),this.effects.unshift(s),this.index+=r[0].length,!0):(r=n.match(a.textStrokeRestore))&&1<this.effects.length&&"stroke"===this.effects[0].type?(this.drawBuffer(),this.effects.shift(),this.index+=r[0].length,!0):(r=n.match(a.textOutline))?(i={type:"outline",color:parseInt(r[1],16)+256*(parseInt(r[2],16)+256*(parseInt(r[3],16)+256*parseInt(r[4]||"ff",16)))},this.drawBuffer(),this.effects.unshift(i),this.index+=r[0].length,!0):!!((r=n.match(a.textOutlineRestore))&&1<this.effects.length&&"outline"===this.effects[0].type)&&(this.drawBuffer(),this.effects.shift(),this.index+=r[0].length,!0)}static font=null;static size=null;static color=null;static effect=null;static lineWidth=0;static charWidths=null;static regexps=null;static commands=null;static commandCount=null;static commandMaximum=null;static drawingMethods=null;static imported=[];static importing=[];static regexps={colorIndex:/^<color:(\d|1[0-5])>$/i,color:/^<color:([\da-f]{2})([\da-f]{2})([\da-f]{2})([\da-f]{2})?>$/i,colorRestore:/^<\/color>$/i,font:/^<font:([\S ]+)>$/i,fontRestore:/^<\/font>$/i,italic:/^<italic>$/i,italicRestore:/^<\/italic>$/i,bold:/^<bold>$/i,boldRestore:/^<\/bold>$/i,fontSize:/^<size:([1-9]\d|[1-3]\d\d|400)>$/i,fontSizeRestore:/^<\/size>$/i,textPosition:/^<(x|y):(?:(add),)?(-?(?:\d|[1-9]\d|[1-9]\d\d|1000))>$/i,textShadow:/^<shadow:(0|-?[1-9]),(0|-?[1-9]),([\da-f]{2})([\da-f]{2})([\da-f]{2})([\da-f]{2})?>$/i,textShadowRestore:/^<\/shadow>$/i,textStroke:/^<stroke:([1-9]|1\d|20),([\da-f]{2})([\da-f]{2})([\da-f]{2})([\da-f]{2})?>$/i,textStrokeRestore:/^<\/stroke>$/i,textOutline:/^<outline:([\da-f]{2})([\da-f]{2})([\da-f]{2})([\da-f]{2})?>$/i,textOutlineRestore:/^<\/outline>$/i};static initialize(){this.charWidths=new Float64Array(We.arrays[1].uint32.buffer,0,We.arrays[1].uint32.length/2),this.commandCount=0,this.commandMaximum=100,this.commands=new Array(this.commandMaximum),this.drawingMethods={none:"drawText",shadow:"drawTextWithShadow",stroke:"drawTextWithStroke",outline:"drawTextWithOutline"},window.on("datachange",this.datachange)}static loadDefault(){var e=He.config["font"],e=(this.font=e.default||"sans-serif",this.size=16,this.color=o("ffffffff"),this.effect={type:"none"},e)["imports"];return this.imported.signature=e.join(),this.importFonts(e)}static importFonts(e){var t=this.imported;const i=this.importing;var a=/([^/]+)\.\S+\.\S+$/,n=[];for(const r of e){var s=R.getPath(r);const o=s.match(a)?.[1];o&&!t.includes(o)&&(t.push(o),i.push(o),n.push(R.get({path:s,type:"arraybuffer"}).then(e=>{new FontFace(o,e).load().then(e=>{i.remove(o)&&(document.fonts.add(e),e.imported=!0)},e=>{i.remove(o)})},e=>{i.remove(o)})))}return Promise.all(n).then(()=>{Y.updateElementFont()})}static clearFonts(){var e=document.fonts;for(const t of e)t.imported&&e.delete(t);this.imported.length=0,this.importing.length=0}static parseEffect(e){e=Object.clone(e);return void 0!==e.color&&(e.color=o(e.color)),e}static fetchCommand(){var e=this.commandCount;const t=this.commands[e];if(void 0!==t)return this.commandCount++,t;{const t={string:"",x:0,y:0,font:"",size:0,color:0,effect:null,paddingItalic:0,paddingVertical:0,horizontalWidth:0,drawingMethod:""};return e<this.commandMaximum&&(this.commands[e]=t,this.commandCount++),t}}static resetCommands(){var t=this.commands,i=this.commandCount;for(let e=0;e<i;e++)t[e].string="";this.commandCount=0}static restoreTexture(t){t.restoreNormalTexture(),Promise.resolve().then(()=>{var e=t.printer["content"];t.printer.reset(),t.printer.draw(e)})}static drawText(e,t){var{x:i,y:a,font:n,size:s,color:r}=e,{paddingItalic:e,paddingVertical:o,horizontalWidth:l}=e,c=We,h=c.context2d,d=Math.floor(i),a=a-o,i=i-d,u=o+.85*s,s=s+2*o,o=Math.min(16384,Math.ceil(l+e+i)),l=(h.resize(o,s),h.font=n,h.fillStyle="#ffffff",h.fillText(t,i,u),c.stencilTexture.fromImage(h.canvas)),e=c.blend;c.blend="upper",c.drawText(l,d,a,o,s,r),c.blend=e}static drawTextWithShadow(e,t){var{x:i,y:a,font:n,size:s,color:r,effect:o}=e,{paddingItalic:e,paddingVertical:l,horizontalWidth:c}=e,h=o.shadowOffsetX,d=o.shadowOffsetY,o=o.color,u=We,p=u.context2d,m=Math.floor(i),a=a-l,i=i-m,g=l+.85*s,s=s+2*l,l=Math.min(16384,Math.ceil(c+e+i)),c=(p.resize(l,s),p.font=n,p.fillStyle="#ffffff",p.fillText(t,i,g),u.stencilTexture.fromImage(p.canvas)),e=u.blend;u.blend="lower",u.drawText(c,m+h,a+d,l,s,o),u.blend="upper",u.drawText(c,m,a,l,s,r),u.blend=e}static drawTextWithStroke(e,t){var{x:i,y:a,font:n,size:s,effect:r}=e,{paddingItalic:o,paddingVertical:l,horizontalWidth:c}=e,h=r.color,r=r.strokeWidth,d=Math.ceil(r/2),u=We,p=u.context2d,l=l+d,m=Math.floor(i-d),a=a-l,i=i-m,g=l+.85*s,s=s+2*l,l=Math.min(16384,Math.ceil(c+o+d+i)),c=(p.resize(l,s),p.font=n,p.lineWidth=r,p.strokeStyle="#ffffff",p.strokeText(t,i,g),u.stencilTexture.fromImage(p.canvas)),o=u.blend;u.blend="lower",u.drawText(c,m,a,l,s,h),u.blend=o,tt.drawText(e,t)}static drawTextWithOutline(e,t){var{x:i,y:a,font:n,size:s,color:r,effect:o}=e,{paddingItalic:e,paddingVertical:l,horizontalWidth:c}=e,o=o.color,h=We,d=h.context2d,u=Math.floor(i),a=a-l,i=i-u,p=l+.85*s,s=s+2*l,l=Math.min(16384,Math.ceil(c+e+i)),c=(d.resize(l,s),d.font=n,d.fillStyle="#ffffff",d.fillText(t,i,p),h.stencilTexture.fromImage(d.canvas)),e=h.blend;h.blend="lower",h.drawText(c,u-1,a,l,s,o),h.drawText(c,u+1,a,l,s,o),h.drawText(c,u,a-1,l,s,o),h.drawText(c,u,1+a,l,s,o),h.blend="upper",h.drawText(c,u,a,l,s,r),h.blend=e}static datachange(e){if("config"===e.key){e=He.config.font.default||"sans-serif";if(tt.font!==e){tt.font=e;for(const i of b.tabBar.data)"ui"===i.type&&(i.fontChanged=!0);Y.updateElementFont()}var e=He.config.font["imports"],t=e.join();tt.imported.signature!==t&&(tt.imported.signature=t,tt.clearFonts(),tt.importFonts(e))}}}const He={manifest:null,uiLinks:null,actors:null,skills:null,triggers:null,items:null,equipments:null,states:null,events:null,scripts:null,easings:null,teams:null,autotiles:null,variables:null,attribute:null,enumeration:null,plugins:null,commands:null,config:null,scenes:null,ui:null,animations:null,particles:null,tilesets:null,loadAll:null,loadMeta:null,loadFile:null,loadScene:null,close:null,createEasingItems:null,createTeamItems:null,createDataMaps:null,createGUIDMap:null,createTeamMap:null,createVariableMap:null,createAttributeContext:null,createEnumerationContext:null,addUILinks:null,removeUILinks:null,createManifest:null,saveManifest:null,inheritMetaData:null,parseGUID:null,loadScript:null,fuck:function(){for(var[e,t]of Object.entries(this.animations)){for(const a of t.motions){var i=a.dirMap;delete a.dirMap,a.dirCases=i}R.planToSave(He.manifest.guidMap[e])}}};He.loadAll=function(){return this.createDataMaps(),this.createManifest(),Promise.all([this.loadMeta(),this.loadFile("easings"),this.loadFile("teams"),this.loadFile("autotiles"),this.loadFile("variables"),this.loadFile("attribute"),this.loadFile("enumeration"),this.loadFile("plugins"),this.loadFile("commands"),this.loadFile("config")]).then(()=>{He.createGUIDMap(this.easings),He.createGUIDMap(this.autotiles),He.createTeamMap(),He.createVariableMap(),He.createAttributeContext(),He.createEnumerationContext()})},He.loadMeta=function(){const t="manifest.json";return R.get({path:t,type:"json"}).then(e=>{null!==e&&Object.defineProperty(this.manifest,"last",{configurable:!0,value:e})},e=>{throw e.message=t,e})},He.loadFile=function(i){const a=`data/${i}.json`;return R.get({path:a,type:"json"}).then(e=>{var t;if(e)return t={guid:i,path:a,dataMap:this},this.manifest.project[i]=t,this.manifest.guidMap[t.guid]=t,this[i]=e;throw new SyntaxError(a)})},He.loadScene=function(t){const i=this["scenes"];if(i[t])return new Promise(e=>{e(_e.decodeScene(i[t]))});var e=this.manifest.guidMap[t];if(!e)return new Promise((e,t)=>{t(new URIError("Metadata is undefined."))});const a=e.path;return R.get({path:a,type:"text"}).then(e=>{try{return _e.decodeScene(i[t]=e)}catch(e){throw e.message=a+`
`+e.message,e}})},He.close=function(){this.manifest=null,this.uiLinks=null,this.actors=null,this.skills=null,this.triggers=null,this.items=null,this.equipments=null,this.states=null,this.events=null,this.scripts=null,this.easings=null,this.teams=null,this.autotiles=null,this.variables=null,this.attribute=null,this.plugins=null,this.commands=null,this.config=null,this.scenes=null,this.ui=null,this.animations=null,this.particles=null,this.tilesets=null},He.createEasingItems=function(){let t=this.easings.items;if(void 0===t){t=this.easings.items=[];var i=this.easings,a=i.length,n=Number.computeIndexDigits(a);for(let e=0;e<a;e++){var s=e.toString().padStart(n,"0"),r=i[e];t.push({name:s+":"+r.name,value:r.id})}}return t},He.createTeamItems=function(){let t=this.teams.list.items;if(void 0===t){t=this.teams.list.items=[];var i=this.teams.list,a=i.length,n=Number.computeIndexDigits(a);for(let e=0;e<a;e++){var s=e.toString().padStart(n,"0"),r=i[e];t.push({name:s+":"+r.name,value:r.id})}}return t},He.createDataMaps=function(){this.uiLinks={},this.actors={},this.skills={},this.triggers={},this.items={},this.equipments={},this.states={},this.events={},this.scripts={},this.scenes={},this.ui={},this.animations={},this.particles={},this.tilesets={}},He.createGUIDMap=function(e){var t={};for(const i of e)t[i.id]=i;Object.defineProperty(e,"map",{configurable:!0,value:t})},He.createTeamMap=function(){var e={},t=this.teams;for(const i of t.list)e[i.id]=i;Object.defineProperty(t,"map",{configurable:!0,value:e})},He.createVariableMap=function(){const a=(e,t)=>{for(const i of e)i.children?a(i.children,t):t[i.id]=i};return function(){var e={};a(this.variables,e),Object.defineProperty(this.variables,"map",{configurable:!0,value:e})}}(),He.createAttributeContext=function(){Object.defineProperty(this.attribute,"context",{configurable:!0,value:new st(this.attribute)})},He.createEnumerationContext=function(){Object.defineProperty(this.enumeration,"context",{configurable:!0,value:new rt(this.enumeration)})},He.addUILinks=function(){let i,a;const n=e=>{for(const t of e)a[t.presetId]=i,0!==t.children.length&&n(t.children)};return function(e){var t=this.ui[e];t&&(i=e,a=this.uiLinks,n(t.nodes),a=null)}}(),He.removeUILinks=function(){let a,n;const s=e=>{for(const i of e){var t=i["presetId"];n[t]===a&&delete n[t],0!==i.children.length&&s(i.children)}};return function(e){var t=this.ui[e];t&&(a=e,n=this.uiLinks,s(t.nodes),n=null)}}(),He.createManifest=function(){this.manifest=new it},He.saveManifest=function(){const e=this.manifest;if(e?.changed){e.changed=!1;const i=JSON.stringify(e,null,2),a=e.code;if(i!==a){const n=R.route("manifest.json");return P.protectPromise(z.writeFile(n,i).then(()=>{e.code=i}).catch(e=>{var t=n+".cache";z.writeFile(t,i),z.writeFile(n,a),oi.throw(e)}))}}return null},He.inheritMetaData=function(){var e=this.manifest,t=e.last,i=e.guidMap;if(void 0!==t){for(const s of t.scenes){var a=i[this.parseGUID(s)];void 0!==a&&(a.x=s.x,a.y=s.y)}for(const r of t.tilesets){var n=i[this.parseGUID(r)];void 0!==n&&(n.x=r.x,n.y=r.y)}delete e.last}},He.parseGUID=function(){const t=/(?<=\.)[0-9a-f]{16}(?=\.\S+$)/;return function(e){e=e.path.match(t);return e?e[0]:""}}(),He.loadScript=async function(e){const t=e.meta;if(void 0!==t){const i=this["scripts"],a=t["guid"];await e.promise,i[a]=R.get({path:e.path,type:"text"}).then(e=>(w.parseMeta(t,e),i[a]=t)).catch(e=>{delete i[a]})}};class it{actors=[];skills=[];triggers=[];items=[];equipments=[];states=[];events=[];scenes=[];tilesets=[];ui=[];animations=[];particles=[];images=[];audio=[];videos=[];fonts=[];script=[];others=[];constructor(){Object.defineProperties(this,{metaList:{value:[]},guidMap:{value:{}},pathMap:{value:{}},project:{value:{}},changes:{value:[]},changed:{writable:!0,value:!1},code:{writable:!0,value:""}})}update(){var e=this["metaList"],t=this["guidMap"],i=this["pathMap"],a=at["versionId"];let n=e.length;for(;0<=--n;){var s=e[n];if(s.versionId!==a){var{guid:r,path:o}=s,o=(e.splice(n,1),s.group.remove(s),t[r]===s&&delete t[r],i[o]===s&&delete i[o],s)["dataMap"];if(o){switch(R.cancelSave(s),o){case He.scenes:case He.ui:case He.animations:case He.particles:b.tabBar.closeByProperty("meta",s)}o===He.ui&&He.removeUILinks(r),delete o[r]}this.changed=!0,console.log(s)}}}}const at=function(){const r={...q.dataMapNames,image:"images",audio:"audio",video:"videos",script:"script",font:"fonts",other:"others"},o={path:null,type:"json"},l={writable:!0,value:null},c={writable:!0,value:""},h={value:null},d={value:null},u={file:l,guid:c,group:h,mtimeMs:{writable:!0,value:null},versionId:{writable:!0,value:0}};return class{path;constructor(e,t){const{type:i,path:a}=e;switch(this.path=a,i){case"scene":this.x=10,this.y=10;break;case"tileset":this.x=0,this.y=0;break;case"script":this.parameters=Array.empty}var n=q.dataMapNames[i],n=(void 0!==n&&(d.value=He[n],Object.defineProperty(this,"dataMap",d),"scene"!==i)&&(n=e.promise??Promise.resolve(),e.promise=n.then(async()=>{o.path=this.path,this.dataMap[t]=await R.get(o),"ui"===i&&He.addUILinks(t)}).catch(e=>{console.log("读取失败: "+e.message)})),r[i]);if(void 0===n)throw new Error("Unknown meta type");var s=He["manifest"];s.changed=!0,s[n].push(this),s.metaList.push(this),s.guidMap[t]=this,s.pathMap[a]=this,l.value=e,c.value=t,h.value=s[n],Object.defineProperties(this,u)}redirect(e){var t,i,a;return this.file.type===e.type&&(this.file=e,(t=this.path)!==(e=e.path)&&(this.path=e,i=He["manifest"],a=i["pathMap"],a[t]===this&&delete a[t],a[e]=this,i.changed=!0),!0)}static versionId=0}}(),nt={data:null,changed:!1,importedFonts:null,initialize:null,open:null,windowClose:null,windowClosed:null,dataChange:null,paramInput:null,confirm:null},u=(nt.initialize=function(){_("#config-window-display").loadItems([{name:"Window",value:"window"},{name:"Maximized",value:"maximized"},{name:"Fullscreen",value:"fullscreen"}]),_("#config-collision-actor-enabled").loadItems([{name:"Enabled",value:!0},{name:"Disabled",value:!1}]),_("#config-collision-actor-enabled").enableHiddenMode().relate([{case:!0,targets:[_("#config-collision-actor-ignoreTeamMember")]}]),_("#config-collision-actor-ignoreTeamMember").loadItems([{name:"Enabled",value:!0},{name:"Disabled",value:!1}]),_("#config-collision-scene-enabled").loadItems([{name:"Enabled",value:!0},{name:"Disabled",value:!1}]),_("#config-collision-scene-enabled").enableHiddenMode().relate([{case:!0,targets:[_("#config-collision-scene-actorSize")]}]),_("#config-font-imports").bind(this.importedFonts),_("#config-font-pixelated").loadItems([{name:"Enabled",value:!0},{name:"Disabled",value:!1}]),_("#config-font-pixelated").enableHiddenMode().relate([{case:!0,targets:[_("#config-font-threshold")]}]),_("#config-actor-partyInventory").loadItems([{name:"Share the Player's Inventory",value:"shared"},{name:"Use Separate Inventorys",value:"separate"}]),_("#config-actor-tempAttributes").bind(new mt),_("#config-script-language").loadItems([{name:"JavaScript",value:"javascript"},{name:"TypeScript",value:"typescript"}]),_("#config-script-language").enableHiddenMode().relate([{case:"typescript",targets:[_("#config-script-outDir")]}]),_("#project-settings").on("close",this.windowClose),_("#project-settings").on("closed",this.windowClosed),_("#project-settings").on("change",this.dataChange),_("#project-confirm").on("click",this.confirm),_(`#config-window-title, #config-window-width, #config-window-height,
    #config-window-display, #config-resolution-width, #config-resolution-height,
    #config-scene-padding, #config-scene-animationInterval,
    #config-tileArea-expansionTop, #config-tileArea-expansionLeft,
    #config-tileArea-expansionRight, #config-tileArea-expansionBottom,
    #config-animationArea-expansionTop, #config-animationArea-expansionLeft,
    #config-animationArea-expansionRight, #config-animationArea-expansionBottom,
    #config-lightArea-expansionTop, #config-lightArea-expansionLeft,
    #config-lightArea-expansionRight, #config-lightArea-expansionBottom,
    #config-collision-actor-enabled, #config-collision-actor-ignoreTeamMember,
    #config-collision-scene-enabled, #config-collision-scene-actorSize,
    #config-font-default, #config-font-pixelated, #config-font-threshold,
    #config-event-startup, #config-event-loadGame, #config-event-initScene,
    #config-event-showText, #config-event-showChoices,
    #config-actor-playerTeam, #config-actor-playerActor,
    #config-actor-partyMembers-0, #config-actor-partyMembers-1,
    #config-actor-partyMembers-2, #config-actor-partyMembers-3,
    #config-actor-partyInventory,
    #config-animation-frameRate, #config-script-language, #config-script-outDir`).on("input",this.paramInput)},nt.open=function(){O.open("project-settings"),this.data=Object.clone(He.config);var e=He.createTeamItems(),e=(_("#config-actor-playerTeam").loadItems(e),D("config",this.data));e("window-title"),e("window-width"),e("window-height"),e("window-display"),e("resolution-width"),e("resolution-height"),e("scene-padding"),e("scene-animationInterval"),e("tileArea-expansionTop"),e("tileArea-expansionLeft"),e("tileArea-expansionRight"),e("tileArea-expansionBottom"),e("animationArea-expansionTop"),e("animationArea-expansionLeft"),e("animationArea-expansionRight"),e("animationArea-expansionBottom"),e("lightArea-expansionTop"),e("lightArea-expansionLeft"),e("lightArea-expansionRight"),e("lightArea-expansionBottom"),e("collision-actor-enabled"),e("collision-actor-ignoreTeamMember"),e("collision-scene-enabled"),e("collision-scene-actorSize"),e("font-imports"),e("font-default"),e("font-pixelated"),e("font-threshold"),e("event-startup"),e("event-loadGame"),e("event-initScene"),e("event-showText"),e("event-showChoices"),e("actor-playerTeam"),e("actor-playerActor"),e("actor-partyMembers-0"),e("actor-partyMembers-1"),e("actor-partyMembers-2"),e("actor-partyMembers-3"),e("actor-partyInventory"),e("actor-tempAttributes"),e("animation-frameRate"),e("script-language"),e("script-outDir")},nt.windowClose=function(e){nt.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedProjectSettings")},[{label:e("yes"),click:()=>{nt.changed=!1,O.close("project-settings")}},{label:e("no")}]))},nt.windowClosed=function(e){nt.data=null},nt.dataChange=function(e){this.changed=!0,console.log(e)}.bind(nt),nt.paramInput=function(e){var t=j.getKey(this),i=this.read(),a=t.split("-"),n=a.length-1;let s=nt.data;for(let e=0;e<n;e++)s=s[a[e]];t=a[n];s[t]!==i&&(s[t]=i)},nt.confirm=function(e){var t,i,a;this.changed&&(this.changed=!1,t=He.config,a=He.config.window.title,i=this.data.window.title,He.config=this.data,R.planToSave(He.manifest.project.config),a!==i&&b.updateTitleName(),(a=new Event("datachange")).key="config",a.last=t,window.dispatchEvent(a)),O.close("project-settings")}.bind(nt),nt.importedFonts={fontId:null,filter:"font",initialize:function(){},parse:function(e){return I.parseFileName(e)},open:function(e=""){this.fontId=e,zt.open(this,!1)},save:function(){return this.fontId},read:function(){return this.fontId},input:function(e){this.fontId=e,this.target.save()}},{list:_("#easing-list"),curve:_("#easing-curve-canvas"),preview:_("#easing-preview-canvas"),data:null,points:null,dragging:null,activePoint:null,scale:null,originX:null,originY:null,timer:null,reverse:null,elapsed:null,duration:null,delay:null,curveMap:null,easingMap:null,pointImage:null,previewImage:null,startPoint:null,endPoint:null,changed:!1,initialize:null,get:null,clear:null,open:null,load:null,insert:null,copy:null,paste:null,delete:null,createId:null,createData:null,setEasingKey:null,getItemById:null,updateMaps:null,updateCanvases:null,drawCurve:null,drawPreview:null,updatePoints:null,selectPointByCoords:null,createPointImage:null,createPreviewImage:null,requestRendering:null,renderingFunction:null,stopRendering:null,windowClose:null,windowClosed:null,dprchange:null,themechange:null,dataChange:null,listKeydown:null,listSelect:null,listOpen:null,listPopup:null,modeSelect:null,pointInput:null,scaleInput:null,curveKeydown:null,curvePointerdown:null,curveWheel:null,curveBlur:null,pointerup:null,pointermove:null,reverseInput:null,durationInput:null,delayInput:null,confirm:null,CurveMap:null,EasingMap:null});u.list.saveSelection=null,u.list.restoreSelection=null,u.list.updateNodeElement=null,u.list.updateItemName=null,u.list.addElementClass=null,u.list.updateTextNode=null,u.list.createKeyTextNode=null,u.list.updateKeyTextNode=null,u.initialize=function(){this.startPoint={x:0,y:0},this.endPoint={x:1,y:1};var e=this["list"],t=(e.removable=!0,e.renamable=!0,e.bind(()=>this.data),e.creators.push(e.addElementClass),e.updaters.push(e.updateTextNode),e.creators.push(e.createKeyTextNode),e.updaters.push(e.updateKeyTextNode),_("#easing-mode").loadItems([{name:"Use 2 Points",value:2},{name:"Use 5 Points",value:5},{name:"Use 8 Points",value:8}]),_("#easing-preview-reverse").loadItems([{name:"ON",value:!0},{name:"OFF",value:!1}]),[]);for(let e=0;e<8;e++)t.push(_(`#easing-points-${e}-x`),_(`#easing-points-${e}-y`));_("#easing-mode").enableHiddenMode().relate([{case:2,targets:t.slice(0,4)},{case:5,targets:t.slice(0,10)},{case:8,targets:t}]),this.scale=1,_("#easing-scale").write(this.scale),this.reverse=!0,this.duration=400,this.delay=400,_("#easing-preview-reverse").write(this.reverse),_("#easing-preview-duration").write(this.duration),_("#easing-preview-delay").write(this.delay),this.timer=new f({duration:this.duration,update:e=>{"playing"===e.state&&(this.elapsed=e.elapsed,this.requestRendering(),this.drawPreview())},callback:e=>{switch(e.state){case"playing":if(0!==this.delay){e.state="waiting",e.elapsed=0<e.playbackRate?0:this.delay,e.duration=this.delay;break}case"waiting":switch(e.state="playing",e.duration=this.duration,e.playbackRate){case 1:this.reverse?(e.playbackRate=-1,e.elapsed=e.duration):e.elapsed=0;break;case-1:e.playbackRate=1}}return!0}}),window.on("dprchange",this.dprchange),window.on("themechange",this.themechange),_("#easing").on("close",this.windowClose),_("#easing").on("closed",this.windowClosed),_("#easing-points-grid").on("change",this.dataChange),e.on("keydown",this.listKeydown),e.on("select",this.listSelect),e.on("change",this.dataChange),e.on("open",this.listOpen),e.on("popup",this.listPopup),_("#easing-mode").on("input",this.modeSelect),_(`#easing-points-0-x, #easing-points-0-y, #easing-points-1-x, #easing-points-1-y,
    #easing-points-2-x, #easing-points-2-y, #easing-points-3-x, #easing-points-3-y,
    #easing-points-4-x, #easing-points-4-y, #easing-points-5-x, #easing-points-5-y,
    #easing-points-6-x, #easing-points-6-y, #easing-points-7-x, #easing-points-7-y`).on("input",this.pointInput),_("#easing-scale").on("input",this.scaleInput),this.curve.on("keydown",this.curveKeydown),this.curve.on("pointerdown",this.curvePointerdown),this.curve.on("wheel",this.curveWheel),this.curve.on("blur",this.curveBlur),_("#easing-preview-reverse").on("input",this.reverseInput),_("#easing-preview-duration").on("input",this.durationInput),_("#easing-preview-delay").on("input",this.delayInput),_("#easing-confirm").on("click",this.confirm)};{const bi={},yi={map:e=>e};u.get=e=>{const t=bi[e];if(void 0!==t)return t;var i=He.easings.map[e];if(i){var i=i["points"],{startPoint:a,endPoint:n}=u;const t=new u.EasingMap;return t.update(a,...i,n),bi[e]=t}return yi},u.clear=()=>{for(const e of Object.keys(bi))delete bi[e]}}u.open=function(){O.open("easing"),this.data=Object.clone(He.easings),this.curveMap=new u.CurveMap,this.easingMap=new u.EasingMap,this.timer.state="playing",this.timer.playbackRate=1,this.timer.elapsed=0,this.timer.add(),this.createPointImage(),this.createPreviewImage(),this.updateCanvases(),this.list.restoreSelection(),this.list.getFocus()},u.load=function(e){var t=e.points,i=(this.points=t,D("easing",e)),a=t.length;i("mode",a);for(let e=0;e<a;e++)i(`points-${e}-x`),i(`points-${e}-y`);for(let e=a;e<8;e++)i(`points-${e}-x`,0),i(`points-${e}-y`,0);this.updateMaps(),this.requestRendering()},u.insert=function(e){this.list.addNodeTo(this.createData(),e)},u.copy=function(e){e&&Clipboard.write("yami.data.easing",e)},u.paste=function(e){var t=Clipboard.read("yami.data.easing");t&&(t.name+=" - Copy",t.id=this.createId(),this.list.addNodeTo(t,e))},u.delete=function(i){const a=this.data;var e;1<a.length&&(e=N.createGetter("confirmation"),O.confirm({message:e("deleteSingleFile").replace("<filename>",i.name)},[{label:e("yes"),click:()=>{var e=a.indexOf(i),t=(this.list.deleteNode(i),a.length-1);this.list.select(a[Math.min(e,t)])}},{label:e("no")}]))},u.createId=function(){let e;for(;e=X.generate64bit(),this.getItemById(e););return e},u.createData=function(){return{id:this.createId(),key:"",name:"",points:[{x:0,y:0},{x:1,y:1}]}},u.setEasingKey=function(t){dt.open(t.key,e=>{t.key=e,this.changed=!0,this.list.updateKeyTextNode(t)})},u.getItemById=function(t){var i=this["data"],a=i["length"];for(let e=0;e<a;e++)if(i[e].id===t)return i[e]},u.updateMaps=function(){var{startPoint:e,endPoint:t}=this;this.curveMap.update(e,...this.points,t),this.easingMap.update(e,...this.points,t)},u.updateCanvases=function(){var e=this["curve"],{width:t,height:i}=CSS.getDevicePixelContentBoxSize(e),i=(e.width===t&&e.height===i||(e.width!==t&&(e.width=t),e.height!==i&&(e.height=i),e.centerX=t>>1,e.centerY=i>>1,e.spacing=2*Math.floor(Math.max(t/12,20)/2)),this)["preview"],{width:e,height:t}=CSS.getDevicePixelContentBoxSize(i);i.width!==e&&(i.width=e),i.height!==t&&(i.height=t)},u.drawCurve=function(){var i=this.curve,e=this.scale,t=i.width,a=i.height,n=i.spacing*e,s=10*n,r=this.originX=i.centerX-5*n,o=this.originY=i.centerY+5*n;let l=i["context"];(l=l||(i.context=i.getContext("2d",{desynchronized:!0}))).clearRect(0,0,t,a),l.beginPath();for(let e=o%n;e<a;e+=n)l.moveTo(0,e+.5),l.lineTo(t,e+.5);for(let e=r%n;e<t;e+=n)l.moveTo(e+.5,0),l.lineTo(e+.5,a);l.strokeStyle=i.gridColor,l.setLineDash([1]),l.stroke(),l.strokeStyle=i.axisColor,l.beginPath(),l.moveTo(r,o-s+.5),l.lineTo(r+s+.5,o-s+.5),l.lineTo(r+s+.5,o),l.stroke(),l.beginPath(),l.moveTo(0,o+.5),l.lineTo(t,o+.5),l.moveTo(.5+r,0),l.lineTo(.5+r,a),l.strokeStyle=i.axisColor,l.setLineDash([]),l.stroke(),l.textBaseline="top",l.font="12px Arial",l.fillStyle=i.textColor,l.fillText("TIME",4+r,o+4),l.translate(r,o),l.rotate(3*Math.PI/2),l.fillText("PROGRESSION",4,-12),l.setTransform(1,0,0,1,0,0),l.lineWidth=2,l.strokeStyle=i.curveColor,l.beginPath(),l.moveTo(.5+r,o+.5);var c=this.curveMap,h=c.count;for(let e=2;e<h;e+=2)l.lineTo(r+c[e]*s+.5,o-c[e+1]*s+.5);l.stroke(),l.strokeStyle=i.curveColorActive,l.beginPath(),l.moveTo(.5+r,o+.5);var d=this.easingMap,u=d.length-1,e=this.elapsed/this.duration,p=Math.ceil(u*e)+1;for(let e=1;e<p;e++)l.lineTo(r+e*s/u+.5,o-d[e]*s+.5);l.stroke(),l.lineWidth=1;var m=this.activePoint,g=this.points,f=g.length;for(let t=0;t<f;t++){let e;switch(t%3){case 0:e=g[t-1]??this.startPoint;break;case 1:e=g[t+1]??this.endPoint;break;default:continue}var v=g[t],b=r+Math.round(v.x*s),y=o-Math.round(v.y*s),w=r+Math.round(e.x*s),x=o-Math.round(e.y*s);l.strokeStyle=m===v?i.linkColorActive:i.axisColor,l.beginPath(),l.moveTo(b+.5,.5+y),l.lineTo(w+.5,.5+x),l.stroke()}var k=this.pointImage;if(null!==k)for(let e=0;e<f;e++){var T=g[e],I=r+Math.round(T.x*s),C=o-Math.round(T.y*s),E=3*e,T=m===T;C-3<0?(l.drawImage(k,7,T?22:15,7,4,I-3,0,7,4),l.drawImage(k,E,T?10:5,3,5,I-1,3,3,5)):a<=4+C?(l.drawImage(k,7,T?25:18,7,4,I-3,a-4,7,4),l.drawImage(k,E,T?10:5,3,5,I-1,a-8,3,5)):(l.drawImage(k,0,T?22:15,7,7,I-3,C-3,7,7),l.drawImage(k,E,0,3,5,I-1,C-2,3,5))}},u.drawPreview=function(){var e=this.preview,t=e.width,i=e.height,a=this.previewImage,n=a.height,s=n/2,r=Math.floor((t-4*n)/5),o=Math.floor(i/2),l=this.easingMap.map(this.elapsed/this.duration),c=window.devicePixelRatio;let h=e["context"];(h=h||(e.context=e.getContext("2d",{desynchronized:!0}))).clearRect(0,0,t,i);e=Math.round(60*c);h.drawImage(a,0,0,n,n,r,(o-s+e)*(1-l)+(o-s-e)*l,n,n);t=n*(.5*c)*(1-l)+n*(1.75*c)*l,i=t/2,h.drawImage(a,n,0,n,n,2*r+3*s-i,o-i,t,t),e=l*Math.PI*2;h.translate(3*r+5*s,o+20),h.rotate(e),h.drawImage(a,2*n,0,n,n,-s,-s,n,n),h.setTransform(1,0,0,1,0,0);c=4*r+6*s,i=o+20-s;h.globalAlpha=l,h.drawImage(a,3*n,0,n,n,c,i,n,n),h.globalAlpha=1},u.updatePoints=function(){var t=g("easing"),i=t("mode"),a=this.points,n=a.length;if(n!==i){a.length=i;for(let e=n;e<i;e++)a[e]={x:t(`points-${e}-x`),y:t(`points-${e}-y`)}}},u.selectPointByCoords=function(e,t){let i=null,a=0;var n=this.curve,s=n.spacing*this.scale*10,r=(e-this.originX)/s,o=(this.originY-t)/s,l=t<20,c=t>=n.height-20,h=l?this.originY/s:c?(this.originY-n.height)/s:null,d=this.points;for(let e=d.length-1;0<=e;e--){var u=d[e],p=Math.abs(u.x-r),m=Math.abs(u.y-o);(p<=.1&&m<=.1||l&&p<=.1&&u.y>h||c&&p<=.1&&u.y<h)&&(p=-Math.hypot(p,m),null===i||a<p)&&(i=u,a=p)}return this.activePoint!==i&&(this.activePoint=i,this.requestRendering()),i},u.createPointImage=function(){this.pointImage||R.get({local:"Images/curve_mark.png",type:"image"}).then(e=>{this.pointImage=e})},u.createPreviewImage=function(){var e,t,i;this.previewImage||((e=document.createElement("canvas")).width=480,e.height=120,t=e.getContext("2d"),i=(e.height-64)/2+54.4,t.fillStyle="#000000",t.fillRect(0,0,480,120),t.fillStyle="#ffffff",t.textAlign="center",t.font="64px Microsoft YaHei UI",t.fillText("Y",60,i),t.fillText("A",180,i),t.fillText("M",300,i),t.fillText("I",420,i),this.previewImage=e)},u.requestRendering=function(){null!==this.data&&f.appendUpdater("sharedRendering",this.renderingFunction)},u.renderingFunction=function(){u.drawCurve()},u.stopRendering=function(){f.removeUpdater("sharedRendering",this.renderingFunction)},u.windowClose=function(e){u.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedEasings")},[{label:e("yes"),click:()=>{u.changed=!1,O.close("easing")}},{label:e("no")}]))},u.windowClosed=function(e){this.list.saveSelection(),this.curve.blur(),this.timer.remove(),this.data=null,this.points=null,this.curveMap=null,this.easingMap=null,this.activePoint=null,this.previewImage=null,this.list.clear(),this.stopRendering()}.bind(u),u.dprchange=function(e){null!==this.data&&(this.updateCanvases(),this.requestRendering())}.bind(u),u.themechange=function(e){var t=this.curve;switch(e.value){case"light":t.textColor="#808080",t.gridColor="#c0c0c0",t.axisColor="#606060",t.curveColor="#808080",t.curveColorActive="#000000",t.linkColorActive="#00a0f0";break;case"dark":t.textColor="#808080",t.gridColor="#404040",t.axisColor="#808080",t.curveColor="#000000",t.curveColorActive="#d8d8d8",t.linkColorActive="#00bbff"}this.requestRendering()}.bind(u),u.dataChange=function(e){this.changed=!0,console.log(e)}.bind(u),u.listKeydown=function(e){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyC":u.copy(t);break;case"KeyV":u.paste()}else if(!e.altKey)switch(e.code){case"Insert":u.insert(t);break;case"Delete":u.delete(t)}},u.listSelect=function(e){u.load(e.value)},u.listOpen=function(e){u.setEasingKey(e.value)},u.listPopup=function(e){const t=e.value;var i=!!t,a=Clipboard.has("yami.data.easing"),n=i&&1<u.data.length,s=N.createGetter("menuEasingList");ve.popup({x:e.clientX,y:e.clientY},[{label:s("insert"),accelerator:"Insert",click:()=>{u.insert(t)}},{label:s("copy"),accelerator:p("C"),enabled:i,click:()=>{u.copy(t)}},{label:s("paste"),accelerator:p("V"),enabled:a,click:()=>{u.paste(t)}},{label:s("delete"),accelerator:"Delete",enabled:n,click:()=>{u.delete(t)}},{label:s("rename"),accelerator:"F2",enabled:i,click:()=>{this.rename(t)}},{label:s("set-key"),enabled:i,click:()=>{u.setEasingKey(t)}}])},u.modeSelect=function(e){this.updatePoints();var t=this.points,i=this.easingMap,a=D("easing"),n=g("easing");if(5===t.length&&0===t[2].x&&0===t[2].y&&0===t[3].x&&0===t[3].y&&0===t[4].x&&0===t[4].y){var s=i.map(.5),r=i.map(.5+.5/3),o=i.map(.5+1/3);a("points-2-x",.5),a("points-2-y",s),a("points-3-x",.5+.5/3),a("points-3-y",r),a("points-4-x",.5+1/3),a("points-4-y",o);for(let e=2;e<5;e++)t[e].x=n(`points-${e}-x`),t[e].y=n(`points-${e}-y`)}if(8===t.length&&0===t[5].x&&0===t[5].y&&0===t[6].x&&0===t[6].y&&0===t[7].x&&0===t[7].y){var s=t[2].x,r=s+(1-s)/2,o=i.map(r),s=r+(1-r)/3,l=i.map(s),c=r+2*(1-r)/3,i=i.map(c);a("points-5-x",r),a("points-5-y",o),a("points-6-x",s),a("points-6-y",l),a("points-7-x",c),a("points-7-y",i);for(let e=5;e<8;e++)t[e].x=n(`points-${e}-x`),t[e].y=n(`points-${e}-y`)}this.updateMaps(),this.requestRendering()}.bind(u),u.pointInput=function(e){var t=j.getKey(this),i=this.read(),a=t.split("-"),n=a.length-1;let s=u.list.read();for(let e=0;e<n;e++)s=s[a[e]];t=a[n];s[t]!==i&&(s[t]=i),u.updateMaps(),u.requestRendering()},u.scaleInput=function(e){this.scale=e.value,this.requestRendering()}.bind(u),u.curveKeydown=function(e){var t=this.activePoint;if(null!==t)switch(e.code){case"ArrowUp":var i=this.points.indexOf(t),i=_(`#easing-points-${i}-y`);i.write(t.y+.01),t.y=i.read(),this.changed=!0,this.updateMaps(),this.requestRendering();break;case"ArrowDown":i=this.points.indexOf(t),i=_(`#easing-points-${i}-y`);i.write(t.y-.01),t.y=i.read(),this.changed=!0,this.updateMaps(),this.requestRendering();break;case"ArrowLeft":i=this.points.indexOf(t),i=_(`#easing-points-${i}-x`);i.write(t.x-.01),t.x=i.read(),this.changed=!0,this.updateMaps(),this.requestRendering();break;case"ArrowRight":i=this.points.indexOf(t),i=_(`#easing-points-${i}-x`);i.write(t.x+.01),t.x=i.read(),this.changed=!0,this.updateMaps(),this.requestRendering()}}.bind(u),u.curvePointerdown=function(e){var t,i,a;0===e.button&&(i=e.getRelativeCoords(this.curve),a=window.devicePixelRatio,t=i.x*a,i=i.y*a,a=this.selectPointByCoords(t,i))&&((this.dragging=e).pointStartX=a.x,e.pointStartY=a.y,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove))}.bind(u),u.curveWheel=function(t){if(!this.dragging&&0!==t.deltaY){var i=document.getElementsByName("easing-scale"),a=i.length;for(let e=0;e<a;e++)if(i[e].dataValue===this.scale){var n=t.deltaY<0?-1:1,n=i[e+n];void 0!==n&&n.pointerdown(t);break}}}.bind(u),u.curveBlur=function(e){this.pointerup(),null!==this.activePoint&&(this.activePoint=null,this.requestRendering())}.bind(u),u.pointerup=function(e){var t=this["dragging"];null!==t&&this.dragging.relate(e=void 0===e?t:e)&&(this.dragging=null,window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove))}.bind(u),u.pointermove=function(e){var t,i,a,n,s;null!==this.activePoint&&(s=this.dragging,t=this.activePoint,i=this.points.indexOf(t),a=this.curve.spacing*this.scale*10,n=Math.roundTo((e.clientX-s.clientX)/a,2),e=Math.roundTo((s.clientY-e.clientY)/a,2),a=Math.clamp(Math.roundTo(s.pointStartX+n,2),0,1),n=Math.clamp(Math.roundTo(s.pointStartY+e,2),-5,5),s=_(`#easing-points-${i}-x`),e=_(`#easing-points-${i}-y`),s.write(a),e.write(n),t.x=s.read(),t.y=e.read(),this.changed=!0,this.updateMaps(),this.requestRendering())}.bind(u),u.reverseInput=function(e){u.reverse=this.read()},u.durationInput=function(e){u.duration=this.read();var t,i=u.timer;"playing"===i.state&&(t=i.duration,i.duration=u.duration,i.elapsed=i.elapsed*i.duration/t)},u.delayInput=function(e){u.delay=this.read();var t,i=u.timer;"waiting"===i.state&&(t=i.duration,i.duration=u.delay,i.elapsed=i.elapsed*i.duration/t)},u.confirm=function(e){var t;this.changed&&(this.changed=!1,this.clear(),t=this.data,Ee.deleteCaches(t),He.easings=t,He.createGUIDMap(t),R.planToSave(He.manifest.project.easings),(t=new Event("datachange")).key="easings",window.dispatchEvent(t)),O.close("easing")}.bind(u),u.CurveMap=class extends Float64Array{count;constructor(){super(6002)}update(...t){var i=t.length-1;for(let e=0;e<i;e+=3){var{x:a,y:n}=t[e],{x:s,y:r}=t[e+1],{x:o,y:l}=t[e+2],{x:c,y:h}=t[e+3],d=e/3*2e3;for(let e=0;e<=1e3;e++){var u=e/1e3,p=1-u,m=p**3,g=3*u*p**2,p=3*u**2*p,u=u**3,f=n*m+r*g+l*p+h*u;this[d+2*e]=a*m+s*g+o*p+c*u,this[d+2*e+1]=f}}this.count=2e3*Math.floor(t.length/3)+2}},u.EasingMap=function(){const b=Math.round;return class e extends Float32Array{constructor(){super(1001)}update(...t){var i=t.length-1;let a=-1;for(let e=0;e<i;e+=3){var{x:n,y:s}=t[e],{x:r,y:o}=t[e+1],{x:l,y:c}=t[e+2],{x:h,y:d}=t[e+3];for(let e=0;e<=1e3;e++){var u=e/1e3,p=1-u,m=p**3,g=3*u*p**2,p=3*u**2*p,u=u**3,f=n*m+r*g+l*p+h*u,v=b(1e3*f);if(v>a&&v<=1e3){if(this[v]=s*m+o*g+c*p+d*u,v>a+1)for(let e=a+1;e<v;e++)this[e]=this[a]+(this[v]-this[a])*(e-a)/(v-a);a=v}}}return this[1e3]=1,this}map(e){return this[b(1e3*e)]}static easeInOut=(new e).update({x:0,y:0},{x:.42,y:0},{x:.58,y:1},{x:1,y:1})}}(),u.list.saveSelection=function(){var e=He["easings"],t=(void 0===e.selection&&Object.defineProperty(e,"selection",{writable:!0,value:""}),this.read());t&&(e.selection=t.id)},u.list.restoreSelection=function(){var e=He.easings.selection,e=u.getItemById(e)??this.data[0];this.select(e),this.update(),this.scrollToSelection()},u.list.updateNodeElement=function(e){var t=e["item"];if(!e.textNode){var i=document.createTextNode("");e.appendChild(i),e.draggable=!0,e.textNode=i;for(const a of this.creators)a(t)}for(const n of this.updaters)n(t)},u.list.updateItemName=function(e){this.updateTextNode(e),this.updateKeyTextNode(e)},u.list.addElementClass=function(e){e.element.addClass("plain")},u.list.updateTextNode=function(e){var t=e.element.textNode,i=e.parent.children,a=i.indexOf(e),i=i.length,i=Number.computeIndexDigits(i),a=a.toString().padStart(i,"0")+":"+e.name;t.nodeValue!==a&&(t.nodeValue=a)},u.list.createKeyTextNode=function(e){var t=document.createElement("text");t.key="",t.addClass("variable-init-text"),e.element.appendChild(t),e.element.keyTextNode=t},u.list.updateKeyTextNode=function(e){var t=e.element.keyTextNode,e=e.key;t.key!==e&&(t.key=e,t.textContent=" = "+e)};const c={list:_("#team-list"),data:null,maximum:null,changed:!1,initialize:null,open:null,createId:null,createData:null,getItemById:null,unpackTeams:null,packTeams:null,windowClose:null,windowClosed:null,listKeydown:null,listPointerdown:null,listSelect:null,listChange:null,listPopup:null,confirm:null},w=(c.list.insert=null,c.list.copy=null,c.list.paste=null,c.list.delete=null,c.list.saveSelection=null,c.list.restoreSelection=null,c.list.updateNodeElement=u.list.updateNodeElement,c.list.createIcon=null,c.list.updateIcon=null,c.list.updateItemName=null,c.list.addElementClass=u.list.addElementClass,c.list.updateTextNode=u.list.updateTextNode,c.list.createMark=null,c.list.updateMark=null,c.initialize=function(){this.maximum=256;var e=this["list"];e.removable=!0,e.renamable=!0,e.bind(()=>this.data),e.creators.push(e.addElementClass),e.creators.push(e.createIcon),e.updaters.push(e.updateTextNode),e.creators.push(e.createMark),e.updaters.push(e.updateMark),_("#team").on("close",this.windowClose),_("#team").on("closed",this.windowClosed),e.on("keydown",this.listKeydown),e.on("pointerdown",this.listPointerdown),e.on("select",this.listSelect),e.on("change",this.listChange),e.on("popup",this.listPopup),_("#team-confirm").on("click",this.confirm)},c.open=function(e){O.open("team"),this.unpackTeams(),this.list.restoreSelection(),this.list.getFocus()},c.createId=function(){let e;for(;e=X.generate64bit(),this.getItemById(e););return e},c.createData=function(){var e=this.createId(),t={},i=this.data,a=i.length;for(let e=0;e<a;e++)t[i[e].id]=0;return t[e]=1,{id:e,name:"",color:"000000ff",relations:t}},c.getItemById=u.getItemById,c.unpackTeams=function(){var e=He.teams.relations,i=He.teams.list,a=i.length,n=_e.decodeRelations(e,a),s=new Array(a),r=2*a;for(let t=0;t<a;t++){var o=i[t],l={};for(let e=0;e<t;e++){var c=(r-e+1)/2*e-e+t;l[i[e].id]=n[c]}var h=(r-t+1)/2*t-t;for(let e=t;e<a;e++){var d=h+e;l[i[e].id]=n[d]}s[t]={id:o.id,name:o.name,color:o.color,relations:l}}this.data=s},c.packTeams=function(){var i=this.data,a=i.length,e=new Array(a),n=We.arrays[0].uint8;let s=0;for(let t=0;t<a;t++){var r=i[t],o=r.relations;for(let e=t;e<a;e++)n[s++]=o[i[e].id];e[t]={id:r.id,name:r.name,color:r.color}}var t=_e.encodeRelations(new Uint8Array(n.buffer,0,s));He.teams.list=e,He.teams.relations=t,He.createTeamMap()},c.windowClose=function(e){c.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedTeams")},[{label:e("yes"),click:()=>{c.changed=!1,O.close("team")}},{label:e("no")}]))},c.windowClosed=function(e){this.data=null,this.list.clear()}.bind(c),c.listKeydown=function(e){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyC":this.copy(t);break;case"KeyV":this.paste()}else if(!e.altKey)switch(e.code){case"Insert":this.insert(t);break;case"Delete":this.delete(t)}},c.listPointerdown=function(e){if(0===e.button){if(e.target.hasClass("team-icon")){const i=e.target.parentNode.item;return m.open({read:()=>i.color,input:e=>{i.color=e,this.updateIcon(i),c.changed=!0}})}var t;e.target.hasClass("team-mark")&&(e=e.target.parentNode,(t=this.read())!==(e=e.item))&&(t.relations[e.id]^=1,e.relations[t.id]^=1,this.updateMark(e),c.changed=!0)}},c.listSelect=function(e){for(const i of this.data){var t=i.element;void 0!==t&&(t.changed=!0,t.parentNode)&&this.updateMark(i)}},c.listChange=function(e){c.changed=!0},c.listPopup=function(e){const t=e.value;var i=c.data.length,a=!!t,n=i<c.maximum,s=n&&Clipboard.has("yami.data.team"),i=a&&1<i,r=N.createGetter("menuTeamList");ve.popup({x:e.clientX,y:e.clientY},[{label:r("insert"),accelerator:"Insert",enabled:n,click:()=>{this.insert(t)}},{label:r("copy"),accelerator:p("C"),enabled:a,click:()=>{this.copy(t)}},{label:r("paste"),accelerator:p("V"),enabled:s,click:()=>{this.paste(t)}},{label:r("delete"),accelerator:"Delete",enabled:i,click:()=>{this.delete(t)}},{label:r("rename"),accelerator:"F2",enabled:a,click:()=>{this.rename(t)}}])},c.confirm=function(e){var t;this.changed&&(this.changed=!1,this.packTeams(),R.planToSave(He.manifest.project.teams),(t=new Event("datachange")).key="teams",window.dispatchEvent(t)),O.close("team")}.bind(c),c.list.insert=function(e){if(this.data.length<c.maximum){var t=c.createData(),i=t.id;for(const a of this.data)a.relations[i]=0;this.addNodeTo(t,e)}},c.list.copy=function(e){e&&Clipboard.write("yami.data.team",e)},c.list.paste=function(e){var t=Clipboard.read("yami.data.team");if(t){var i=c.createId(),a=t.relations,n={};for(const l of this.data){var s=l.id,r=l.relations,o=a[s]??0;r[i]=o,n[s]=o}n[i]=1,t.name+=" - Copy",t.id=i,t.relations=n,this.addNodeTo(t,e)}},c.list.delete=function(a){const n=this.data;var e;1<n.length&&(e=N.createGetter("confirmation"),O.confirm({message:e("deleteSingleFile").replace("<filename>",a.name)},[{label:e("yes"),click:()=>{var e=a.id;for(const a of n)delete a.relations[e];var t=n.indexOf(a),i=(this.deleteNode(a),n.length-1);this.select(n[Math.min(t,i)])}},{label:e("no")}]))},c.list.saveSelection=function(){var e=He["teams"],t=(void 0===e.selection&&Object.defineProperty(e,"selection",{writable:!0,value:""}),this.read());t&&(e.selection=t.id)},c.list.restoreSelection=function(){var e=He.teams.selection,e=c.getItemById(e)??this.data[0];this.select(e),this.update(),this.scrollToSelection()},c.list.createIcon=function(e){var t=e["element"],i=document.createElement("node-icon");i.addClass("team-icon"),t.nodeIcon=i,t.insertBefore(i,t.textNode),c.list.updateIcon(e)},c.list.updateIcon=function(e){var t,i,a,n=e.element.nodeIcon,e=e.color;n.color!==e&&(n.color=e,t=parseInt(e.slice(0,2),16),i=parseInt(e.slice(2,4),16),a=parseInt(e.slice(4,6),16),e=parseInt(e.slice(6,8),16)/255,n.style.backgroundColor=`rgba(${t}, ${i}, ${a}, ${e})`)},c.list.updateItemName=function(e){this.updateTextNode(e)},c.list.createMark=function(e){var e=e["element"],t=document.createElement("text");t.addClass("team-mark"),e.mark=t,e.appendChild(t)},c.list.updateMark=function(e){var t=c.list.read();if(null!==t){var i=e.element.mark,t=t.relations[e.id];if(i.relation!==t)switch(i.relation=t){case 0:i.removeClass("friend"),i.addClass("enemy"),i.textContent="";break;case 1:i.removeClass("enemy"),i.addClass("friend"),i.textContent=""}}},{list:_("#plugin-list"),overviewPane:_("#plugin-overview-detail").hide(),overview:_("#plugin-overview"),parameterPane:_("#plugin-parameter-pane").hide(),data:null,meta:null,symbol:null,detailed:!1,changed:!1,initialize:null,open:null,load:null,unload:null,loadOverview:null,createOverview:null,createData:null,getItemById:null,switchOverviewMode:null,parseMeta:null,reconstruct:null,saveToProject:null,loadFromProject:null,windowClose:null,windowClosed:null,keydown:null,pointerdown:null,scriptChange:null,listKeydown:null,listSelect:null,listUnselect:null,listChange:null,listPopup:null,listOpen:null,overviewPointerdown:null,parameterPaneUpdate:null,confirm:null,apply:null}),d=(w.list.insert=null,w.list.toggle=null,w.list.copy=null,w.list.paste=null,w.list.delete=null,w.list.saveSelection=null,w.list.restoreSelection=null,w.list.updateNodeElement=u.list.updateNodeElement,w.list.addElementClass=null,w.list.updateTextNode=null,w.list.updateToggleStyle=null,w.list.createEditIcon=null,w.parameterPane.createDetailBox=null,w.parameterPane.clear=null,w.initialize=function(){var e=this["list"];e.removable=!0,e.bind(()=>this.data),e.creators.push(e.addElementClass),e.creators.push(e.updateToggleStyle),e.updaters.push(e.updateTextNode),e.creators.push(e.createEditIcon),this.parameterPane.bind(e),_("#plugin").on("close",this.windowClose),_("#plugin").on("closed",this.windowClosed),e.on("keydown",this.listKeydown),e.on("select",this.listSelect),e.on("unselect",this.listUnselect),e.on("change",this.listChange),e.on("popup",this.listPopup),e.on("open",this.listOpen),e.on("pointerdown",vt.listPointerdown),this.overview.on("pointerdown",this.overviewPointerdown),this.parameterPane.on("update",this.parameterPaneUpdate),_("#plugin-confirm").on("click",this.confirm),_("#plugin-apply").on("click",this.apply)},w.open=function(){O.open("plugin"),this.data=Object.clone(He.plugins),this.list.restoreSelection(),this.list.getFocus(),window.on("keydown",this.keydown),window.on("pointerdown",this.pointerdown),window.on("script-change",this.scriptChange)},w.load=async function(e){var t=this.symbol=Symbol(),e=await He.scripts[e.id];this.symbol===t&&(this.symbol=null,this.meta=e,this.loadOverview(),this.parameterPane.update())},w.unload=function(){this.meta=null,this.symbol=null,this.overview.clear(),this.overviewPane.hide(),this.parameterPane.hide(),this.parameterPane.clear()},w.loadOverview=function(){var{meta:e,detailed:t}=this;if(e){var e=this.createOverview(e,t),i=this.overview.clear();for(const a of e)i.appendChild(a);this.overviewPane.show()}},w.createOverview=function(e,t){var i,a=[],n=N.createGetter("plugin"),s=e.langMap.update();const{plugin:r,author:o,link:l,version:c,desc:h}=e.overview;if(r&&((d=document.createElement("text")).addClass("plugin-title"),a.push(d),(i=document.createElement("text")).textContent=s.get(r),i.addClass("plugin-name"),d.appendChild(i),c)&&((i=document.createElement("text")).textContent=" ver"+c,i.addClass("plugin-version"),d.appendChild(i)),o&&(a.length&&a.push(document.createTextNode("\n")),(d=document.createElement("text")).textContent=n("author")+": ",d.addClass("plugin-label"),a.push(d),(i=document.createElement("text")).textContent=o,i.addClass("plugin-type"),l&&(i.addClass("plugin-link"),i.onclick=()=>R.openURL(l)),a.push(i)),h&&(a.length&&a.push(document.createTextNode("\n\n")),a.push(document.createTextNode(s.get(h)))),t){var d=e["parameters"],u=e.manager["states"];a.length&&d.length&&a.push(document.createTextNode("\n\n"));for(const w of d){const{key:x,type:k,alias:T,desc:h}=w;var p=document.createElement("text"),m=(p.addClass("plugin-wrap"),a.push(p),document.createElement("text")),m=(m.textContent=s.get(T)??x,m.addClass("plugin-key"),p.appendChild(m),document.createElement("text"));switch(m.textContent=": ",m.addClass("plugin-label"),p.appendChild(m),k){case"attribute":case"attribute-key":{var g=document.createElement("text");let e="attribute",t=("any"!==w.filter&&(e+="."+w.filter),n(e));"attribute-key"===k&&(t+=`(${n("key")})`),g.textContent=t,g.addClass("plugin-type"),p.appendChild(g);break}case"attribute-group":g=document.createElement("text");g.textContent=n("attribute.group"),g.addClass("plugin-type"),p.appendChild(g);break;case"enum":case"enum-value":{var f=document.createElement("text");let e="enum",t=("any"!==w.filter&&(e+="."+w.filter),n(e));"enum-value"===k&&(t+=`(${n("value")})`),f.textContent=t,f.addClass("plugin-type"),p.appendChild(f);break}case"enum-group":f=document.createElement("text");f.textContent=n("enum.group"),f.addClass("plugin-type"),p.appendChild(f);break;case"element-id":var v=document.createElement("text");v.textContent=`${n("element")}(${n("id")})`,v.addClass("plugin-type"),p.appendChild(v);break;case"file":if(w.filter){var b=w.filter.split("|");for(let e=0;e<b.length;e++){0!==e&&((y=document.createElement("text")).textContent="|",y.addClass("plugin-label"),p.appendChild(y));var y=document.createElement("text");y.textContent=n("file."+b[e]),y.addClass("plugin-type"),p.appendChild(y)}break}default:v=document.createElement("text");v.textContent=n(k),v.addClass("plugin-type"),p.appendChild(v)}x in u&&((m=document.createElement("text")).textContent="?",m.addClass("plugin-label"),p.appendChild(m)),h&&((m=document.createElement("text")).textContent=s.get(h),m.addClass("plugin-param-desc"),p.appendChild(m))}}return a.length||a.push(document.createTextNode("No Description")),a},w.createData=function(e){return{id:e??"",enabled:!0,parameters:{}}},w.getItemById=u.getItemById,w.switchOverviewMode=function(){this.meta&&(this.detailed=!this.detailed,this.loadOverview())},w.parseMeta=function(){const a=new Event("script-change"),n=/\/\*\s*@plugin\s[\s\S]+?(?=\*\/)/,s=/@([a-z\-[\]]+)([\s\S]*?)(?=\s@|$)/g,e=/^https?:\/\/.+$/,r=/^(.+?)\{([\s\S]+?)\}$/,t=/^[\da-f]{8}$/,o=/\s*,\s*/,l=/\s+/,i=/(?:'[^']*'|"[^"]")(?=\s*,?)/g,c=/^([a-zA-Z\-]+)(?:\s+extends\s+([a-zA-Z\-]+))?/,h=/(#\S+)\s+([\s\S]+?)(?=\s+#|$)/g,d=e=>{switch(e){case"true":return!0;case"false":return!1;default:return null}},u=e=>{e=parseFloat(e);return isNaN(e)?null:e},p=e=>{var t=e.length-1,i=e[0],a=e[t];return"'"===i&&"'"===a||'"'===i&&'"'===a?e.slice(1,t):null},m=()=>{if("["!==B[0]||"]"!==B[B.length-1])return null;var e=[];for(const i of B.slice(1,-1).split(o)){var t=u(i);null!==t&&e.push(t)}return e},g=()=>{if("["!==B[0]||"]"!==B[B.length-1])return null;for(var e=[];t=i.exec(B);){var t=p(t[0]);null!==t&&e.push(t)}return e},f=()=>t.test(B)?B:null,v=()=>{var e=r.exec(B);if(e){var t=e[1].trim(),i=[];for(const n of e[2].trim().split(o)){var a=p(n)??u(n)??d(n);null!==a&&i.append(a)}if(0!==i.length)return{key:t,values:i}}return null};var b=()=>{P[B]||(F={key:B,type:z,value:(()=>{switch(z){case"boolean":return!1;case"number[]":case"string[]":return[];case"keycode":return"";case"color":return"ffffffff";default:return""}})()},A.push(F),P[B]=F)},y=()=>{P[B]||(F={key:B,type:z,value:""},Object.defineProperties(F,{filter:{writable:!0,value:"any"}}),A.push(F),P[B]=F)},w=()=>{P[B]||(F={key:B,type:z,value:""},Object.defineProperties(F,{filter:{writable:!0,value:"any"}}),A.push(F),P[B]=F)};const x={actor:!0,skill:!0,trigger:!0,item:!0,equipment:!0,state:!0,event:!0,scene:!0,tileset:!0,ui:!0,animation:!0,particle:!0,image:!0,audio:!0,video:!0,script:!0,font:!0,other:!0},k={actor:1,skill:1,state:1,item:1,equipment:1,element:1},T={"shortcut-key":1,"cooldown-key":1,"equipment-slot":1,"global-event":1,"scene-event":1,"actor-event":1,"skill-event":1,"state-event":1,"equipment-event":1,"item-event":1,"region-event":1,"light-event":1,"animation-event":1,"particle-event":1,"parallax-event":1,"tilemap-event":1,"element-event":1};class I extends Array{constructor(){super(),this.wraps={},this.states={}}append({key:t,values:i}){var{wraps:a,states:n}=this,s=F.key,r=P[t];if(void 0!==r&&r!==F&&"option"===r.type&&!n[s]){let e=a[t];void 0===e&&(e=new C(r),a[t]=e,this.push(e)),n[s]=!0,e.relate(i)}}sort(){for(var{owner:t}of this){let e=0;for(;t=t.parent;){var i=t["wrap"];i.priority=Math.max(i.priority,++e)}}return super.sort(I.sorter)}update(e){var t=this["states"];for(const i of this)i.switch(t,e)}static sorter=(e,t)=>t.priority-e.priority}class C{constructor(e){this.owner=e,this.map={},this.priority=0,Object.defineProperty(e,"wrap",{value:this})}relate(e){var t=this["owner"];if("option"===F.type){let e=t;for(;e=e.parent;)if(e===F)return;Object.defineProperty(F,"parent",{value:t})}var i=this["map"],a=F["key"],n=t["options"];for(const s of e)n.includes(s)&&(void 0===i[s]?i[s]=[a]:i[s].append(a))}switch(e,t){let i;var{owner:a,map:n}=this;const{key:s,options:r}=a;!1!==e[s]&&(i=t[s],r.includes(i)||(i=a.value));var o=n[i]??Array.empty;for(const c of r){var l=n[c];if(void 0!==l)for(const s of l)e[s]=o.includes(s)}}}class E{constructor(){this.language="",this.active={},this.packs=[]}update(){if(this.language!==N.language){this.language=N.language;var e=this.packs;let t=e[0],i=0;var a=N.language.split("-");for(const r of e){var n=r.name.split("-");if(a[0]===n[0]){let e=0;for(var s of a)n.includes(s)&&e++;i<e&&(i=e,t=r)}}t&&(this.parse(t),this.active=t.map)}return this}parse(e){var t=e.code;if(void 0!==t){delete e.code;for(var i,a=e.base,n=e.map={};i=h.exec(t);)n[i[1]]=i[2];if(a)for(const e of this.packs)if(e.name===a){this.parse(e);try{Object.setPrototypeOf(n,e.map)}catch(e){}}}}get(e){return e&&"#"===e[0]?this.active[e]??e:e}append(e){var t=e["name"],i=this["packs"];for(const e of i)if(e.name===t)return;i.push(e)}}const M={plugin:()=>{S.plugin=B},author:()=>{S.author=B},link:()=>{e.test(B)&&(S.link=B)},version:()=>{S.version=B},boolean:b,number:()=>{P[B]||(F={key:B,type:z,value:0},Object.defineProperties(F,{min:{writable:!0,value:-1e9},max:{writable:!0,value:1e9},decimals:{writable:!0,value:10}}),A.push(F),P[B]=F)},string:b,"number[]":b,"string[]":b,keycode:b,color:b,option:()=>{var e,t=v();null===t||({key:t,values:e}=t,P[t])||(F={key:t,type:z,value:e[0],options:e},Object.defineProperty(F,"dataItems",{configurable:!0,value:e.map(e=>({name:e.toString(),value:e}))}),A.push(F),P[t]=F)},easing:b,team:b,variable:b,attribute:y,"attribute-key":y,"attribute-group":b,enum:w,"enum-value":w,"enum-group":b,actor:b,region:b,light:b,animation:b,particle:b,parallax:b,tilemap:b,element:b,"element-id":b,file:()=>{P[B]||(F={key:B,type:z,value:""},Object.defineProperties(F,{filter:{writable:!0,value:""}}),A.push(F),P[B]=F)},filter:()=>{switch(F?.type){case"file":{var t=B.split(l);let e=t.length;for(;0<=--e;)x[t[e]]||t.splice(e,1);0!==t.length&&(F.filter=t.join("|"));break}case"attribute":case"attribute-key":k[B]&&(F.filter=B);break;case"enum":case"enum-value":T[B]&&(F.filter=B)}},clamp:()=>{if("number"===F?.type){var t=B.split(l);if(2===t.length){for(let e=0;e<2;e++){var i=u(t[e]);if(null===i)return;t[e]=i}var e=Math.max(-1e9,Math.min(...t)),a=Math.min(1e9,Math.max(...t));F.value=Math.clamp(F.value,e,a),F.min=e,F.max=a}}},decimals:()=>{var e;"number"===F?.type&&null!==(e=u(B))&&0<=e&&e<=10&&(F.decimals=e)},default:()=>{var e;null!==F&&null!==(e=(()=>{switch(F.type){case"boolean":return d(B);case"number":return u(B);case"string":return p(B);case"option":var e=p(B)??u(B)??d(B);return F.options.includes(e)?e:null;case"number[]":return m();case"string[]":return g();case"keycode":return p(B);case"color":return f();default:return null}})())&&(F.value=e)},alias:()=>{if(null!==F)if("option"===F.type){var e=(e=r.exec(B))?{key:e[1].trim(),values:e[2].trim().split(o)}:{key:B,values:[]};Object.defineProperty(F,"alias",{configurable:!0,value:e.key});const n=L;var t=e.values,i=F.dataItems,a=Math.min(i.length,t.length);for(let e=0;e<a;e++){const s=t[e];""!==s&&("#"===s[0]?Object.defineProperty(i[e],"name",{configurable:!0,get:()=>n.get(s)}):i[e].name=s)}}else Object.defineProperty(F,"alias",{configurable:!0,value:B})},desc:()=>{null===F?S.desc=B:Object.defineProperty(F,"desc",{configurable:!0,value:B})},cond:()=>{var e;null!==F&&(e=v())&&R.append(e)},lang:()=>{var e=c.exec(B);e&&L.append({name:e[1],base:e[2]??"",code:B})}};let S=null,A=null,P=null,L=null,R=null,F=null,z="",B="";return function(e,t){S={},A=[],P={},L=new E,R=new I;let i=n.exec(t);if(i){const t=i[0];if(e.overview?.code===t)return;for(S.code=t;i=s.exec(t);)z=i[1],B=i[2].trim(),M[z]?.()}t=!!e.overview;e.parameters=A,He.manifest.changed=!0,Object.defineProperties(e,{overview:{configurable:!0,value:S},langMap:{configurable:!0,value:L},manager:{configurable:!0,value:R.sort()}}),S=null,A=null,P=null,L=null,R=null,F=null,z="",B="",t&&(a.changedMeta=e,window.dispatchEvent(a))}}(),w.reconstruct=function(){const u=/^[0-9a-f]{16}$/,p=/^[\da-f]{8}$/;return function(e){var{id:i,parameters:a}=e,n=Object.entries(a),i=He.manifest.guidMap[i],s=i?.parameters;if(void 0!==s){i.manager.update(a);let t=!1;var r=s.length;if(r!==n.length)t=!0;else for(let e=0;e<r;e++){var o=n[e];if(!((e,t,i)=>{if(e.key!==t)return!1;var a,n,s,r=e["type"];switch(r){case"boolean":case"string":return typeof i===r;case"number":if(typeof i===r)return{min:a,max:n,decimals:s}=e,Math.clamp(Math.roundTo(i,s),a,n)===i;case"option":return e.options.includes(i);case"easing":return!!He.easings.map[i];case"team":return!!He.teams.map[i];case"variable":return""===i||!!He.variables.map[i];case"attribute":case"attribute-key":return""===i?!0:"any"===e.filter?!!v.getAttribute(i):!!v.getGroupAttribute(e.filter,i);case"attribute-group":return!!v.getGroup(i);case"enum":case"enum-value":return""===i?!0:"any"===e.filter?!!M.getString(i):!!M.getGroupString(e.filter,i);case"enum-group":return!!M.getEnumGroup(i);case"actor":case"region":case"light":case"animation":case"particle":case"parallax":case"tilemap":case"element":case"element-id":return"string"==typeof i;case"file":return""===i||u.test(i);case"number[]":case"string[]":if(i instanceof Array){var o=r.slice(0,-2);for(const l of i)if(typeof l!==o)return!1;return!0}return!1;case"keycode":return"string"==typeof i;case"color":return p.test(i)}})(s[e],...o)){t=!0;break}}if(t){var l={};for(const d of s){var c=d.key,h=a[c],h=((e,t)=>{var i,a,n,s=e["type"];switch(s){case"boolean":case"string":return typeof t===s?t:e.value;case"number":return typeof t===s?({min:i,max:a,decimals:n}=e,Math.clamp(Math.roundTo(t,n),i,a)):e.value;case"option":return e.options.includes(t)?t:e.value;case"easing":return He.easings.map[t]?t:He.easings[0].id;case"team":return He.teams.map[t]?t:He.teams.list[0].id;case"variable":return He.variables.map[t]?t:"";case"attribute":case"attribute-key":if("any"===e.filter){if(v.getAttribute(t))return t}else if(v.getGroupAttribute(e.filter,t))return t;return"";case"attribute-group":return v.getGroup(t)?t:"";case"enum":case"enum-value":if("any"===e.filter){if(M.getString(t))return t}else if(M.getGroupString(e.filter,t))return t;return"";case"enum-group":return M.getEnumGroup(t)?t:"";case"actor":case"region":case"light":case"animation":case"particle":case"parallax":case"tilemap":case"element":case"element-id":return"string"==typeof t?t:"";case"file":return u.test(t)?t:"";case"number[]":case"string[]":if(t instanceof Array)e:{var r=s.slice(0,-2);for(const o of t)if(typeof o!==r)break e;return t}return e.value;case"keycode":return"string"==typeof t?t:e.value;case"color":return p.test(t)?t:e.value}})(d,h);l[c]=h}return e.parameters=l,!0}}return!1}}(),w.saveToProject=function(e){e=e.plugin;e.detailed=this.detailed},w.loadFromProject=function(e){e=e.plugin;this.detailed=e.detailed},w.windowClose=function(e){this.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedPlugins")},[{label:e("yes"),click:()=>{this.changed=!1,O.close("plugin")}},{label:e("no")}]))}.bind(w),w.windowClosed=function(e){this.list.saveSelection(),this.data=null,this.list.clear(),window.off("keydown",this.keydown),window.off("pointerdown",this.pointerdown),window.off("script-change",this.scriptChange)}.bind(w),w.keydown=function(e){e.cmdOrCtrlKey&&"KeyD"===e.code&&w.switchOverviewMode()},w.pointerdown=function(e){e.target===document.documentElement&&(e.preventDefault(),document.activeElement.blur())},w.scriptChange=function(e){w.meta===e.changedMeta&&w.loadOverview()},w.listKeydown=function(e){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyC":this.copy(t);break;case"KeyV":this.paste()}else if(!e.altKey)switch(e.code){case"Insert":this.insert(t);break;case"Slash":this.toggle(t);break;case"Delete":this.delete(t)}},w.listSelect=function(e){w.load(e.value)},w.listUnselect=function(e){w.unload()},w.listChange=function(e){w.changed=!0},w.listPopup=function(e){const t=e.value;var i=!!t,a=Clipboard.has("yami.data.plugin"),n=i,s=N.createGetter("menuPluginList");ve.popup({x:e.clientX,y:e.clientY},[{label:s("edit"),accelerator:"Enter",enabled:i,click:()=>{this.edit(t)}},{label:s("insert"),accelerator:"Insert",click:()=>{this.insert(t)}},{label:s("toggle"),accelerator:"/",enabled:i,click:()=>{this.toggle(t)}},{label:s("copy"),accelerator:p("C"),enabled:i,click:()=>{this.copy(t)}},{label:s("paste"),accelerator:p("V"),enabled:a,click:()=>{this.paste(t)}},{label:s("delete"),accelerator:"Delete",enabled:n,click:()=>{this.delete(t)}}])},w.listOpen=function(e){this.edit(e.value)},w.overviewPointerdown=function(){const t={once:!0},i=e=>{w.overview.contains(e.target)&&ve.popup({x:e.clientX,y:e.clientY},[{label:N.get("menuPluginOverview.detail"),accelerator:p("D"),checked:w.detailed,click:()=>{w.switchOverviewMode()}}])};return function(e){2===e.button&&window.on("pointerup",i,t)}}(),w.parameterPaneUpdate=function(e){0!==this.wraps.length?this.show():this.hide()},w.confirm=function(e){this.apply(),O.close("plugin")}.bind(w),w.apply=function(t){if(this.changed){this.changed=!1;let e=this.data;t instanceof Event?e=Object.clone(e):Ee.deleteCaches(e),He.plugins=e,R.planToSave(He.manifest.project.plugins)}}.bind(w),w.list.edit=function(t){zt.open({filter:"script",read:()=>t.id,input:e=>{t.id!==e&&(t.id=e,t.parameters={},w.changed=!0,w.parameterPane.update()),this.update()}},!1)},w.list.insert=function(t){zt.open({filter:"script",read:()=>"",input:e=>{this.addNodeTo(w.createData(e),t)}},!1)},w.list.toggle=function(e){e&&(e.enabled=!e.enabled,this.updateToggleStyle(e),w.changed=!0)},w.list.copy=function(e){e&&Clipboard.write("yami.data.plugin",e)},w.list.paste=function(e){var t=Clipboard.read("yami.data.plugin");t&&this.addNodeTo(t,e)},w.list.delete=function(a){var e=N.createGetter("confirmation"),t=I.parseFileName(a.id);O.confirm({message:e("deleteSingleFile").replace("<filename>",t)},[{label:e("yes"),click:()=>{var e=this.data,t=e.indexOf(a),i=(this.deleteNode(a),e.length-1);this.select(e[Math.min(t,i)])}},{label:e("no")}])},w.list.saveSelection=function(){var e=He["plugins"],t=(void 0===e.selection&&Object.defineProperty(e,"selection",{writable:!0,value:""}),this.read());t&&(e.selection=t.id)},w.list.restoreSelection=function(){var e=He.plugins.selection,e=w.getItemById(e)??this.data[0];this.select(e),this.update(),this.scrollToSelection()},w.list.addElementClass=function(e){e.element.addClass("plugin-item")},w.list.updateTextNode=function(e){var t=e.element.textNode,e=I.parseFileName(e.id);t.nodeValue!==e&&(t.nodeValue=e)},w.list.updateToggleStyle=function(e){return e.enabled?e.element.removeClass("weak"):e.element.addClass("weak")},w.list.createEditIcon=function(e){var t=document.createElement("box");t.textContent="",t.addClass("script-edit-button"),t.addClass("plugin-item-button"),e.element.appendChild(t)},w.parameterPane.createDetailBox=function(){var e=_("#plugin-parameter-detail");const t={box:e,grid:_("#plugin-parameter-grid"),children:[]};return e.wrap=t,function(){return t}}(),w.parameterPane.clear=function(){this.metas=[];var t=this["wraps"];if(0!==t.length){var{children:i,box:a}=t[0];let e=i.length;for(;0<=--e;)this.recycle(i[e]);a.meta=null,a.data=null,i.length=0,t.length=0}this.scriptList.data||window.off("script-change",this.scriptChange)},{list:_("#variable-list"),panel:_("#variable-properties-flex").hide(),manager:_("#variable-value-manager"),searcher:_("#variable-searcher"),inputs:{name:_("#variable-name"),sort:_("#variable-sort"),type:_("#variable-type"),value:_("#variable-value-box"),boolean:_("#variable-value-boolean"),number:_("#variable-value-number"),string:_("#variable-value-string"),note:_("#variable-note")},target:null,data:null,idList:null,history:null,changed:!1,initialize:null,open:null,undo:null,redo:null,createId:null,getVariableById:null,openPropertyPanel:null,closePropertyPanel:null,unpackVariables:null,packVariables:null,saveHistory:null,windowClose:null,windowClosed:null,keydown:null,listKeydown:null,listPointerdown:null,listSelect:null,listRecord:null,listPopup:null,listOpen:null,nameInput:null,sortWrite:null,sortInput:null,typeWrite:null,typeInput:null,valueInput:null,noteInput:null,panelKeydown:null,searcherInput:null,confirm:null,apply:null}),v=(d.list.copy=null,d.list.paste=null,d.list.delete=null,d.list.saveScroll=null,d.list.restoreScroll=null,d.list.cancelSearch=null,d.list.createFolder=null,d.list.createVariable=null,d.list.createIcon=null,d.list.updateIcon=null,d.list.addElementClass=null,d.list.updateItemClass=null,d.list.createInitText=null,d.list.updateInitText=null,d.list.createNoteIcon=null,d.list.updateNoteIcon=null,d.initialize=function(){const s=this["list"];s.removable=!0,s.renamable=!0,s.bind(()=>this.data),s.creators.push(s.addElementClass),s.creators.push(s.updateItemClass),s.creators.push(s.createInitText),s.creators.push(s.updateInitText),s.creators.push(s.createNoteIcon),s.creators.push(s.updateNoteIcon),this.panel.variable=null,this.searcher.addCloseButton(),l.processors["variable-list-operation"]=(e,t)=>{t=t.response;s.restore(e,t),null===s.read()&&null!==this.panel.variable&&this.closePropertyPanel(),this.changed=!0},l.processors["variable-name-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.name,i.name=a,s.updateItemName(i),this.panel.variable===i?this.inputs.name.write(a):(s.select(i),s.expandToSelection(),s.scrollToSelection()),this.changed=!0},l.processors["variable-sort-change"]=(e,t)=>{var{item:i,value:{sort:a,value:n}}=t;t.value.sort=i.sort,t.value.value=i.value,i.sort=a,i.value=n,s.updateIcon(i),s.updateInitText(i),s.updateItemClass(i),this.panel.variable===i?(t=typeof n,this.inputs.sort.write(a),this.inputs.type.write(t),this.inputs[t]?.write(n)):(s.select(i),s.expandToSelection(),s.scrollToSelection()),this.changed=!0},l.processors["variable-type-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.value,i.value=a,s.updateIcon(i),s.updateInitText(i),this.panel.variable===i?(this.inputs.type.write(t=typeof a),this.inputs[t]?.write(a)):(s.select(i),s.expandToSelection(),s.scrollToSelection()),this.changed=!0},l.processors["variable-value-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.value,i.value=a,s.updateInitText(i),this.panel.variable===i?this.inputs[typeof a].write(a):(s.select(i),s.expandToSelection(),s.scrollToSelection()),this.changed=!0},l.processors["variable-note-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.note,i.note=a,s.updateNoteIcon(i),this.panel.variable===i?this.inputs.note.write(a):(s.select(i),s.expandToSelection(),s.scrollToSelection()),this.changed=!0},_("#variable").on("close",this.windowClose),_("#variable").on("closed",this.windowClosed),s.on("keydown",this.listKeydown),s.on("pointerdown",this.listPointerdown),s.on("select",this.listSelect),s.on("record",this.listRecord),s.on("popup",this.listPopup),s.on("open",this.listOpen),this.inputs.name.on("input",this.nameInput),this.inputs.sort.on("write",this.sortWrite),this.inputs.sort.on("input",this.sortInput),this.inputs.type.on("write",this.typeWrite),this.inputs.type.on("input",this.typeInput),this.inputs.boolean.on("input",this.valueInput),this.inputs.number.on("input",this.valueInput),this.inputs.string.on("input",this.valueInput),this.inputs.string.on("compositionend",this.valueInput),this.inputs.note.on("input",this.noteInput),this.inputs.note.on("compositionend",this.noteInput),this.panel.on("keydown",this.panelKeydown),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),_("#variable-confirm").on("click",this.confirm),_("#variable-apply").on("click",this.apply)},d.open=function(e=null){this.target=e,this.history=new l(100),this.unpackVariables(),O.open("variable");var t=this.list,i=e?this.getVariableById(e.read()):void 0;i&&"folder"!==i.class?(t.initialize(),t.select(i),t.expandToSelection(!1),t.update(),t.restoreScroll(),t.scrollToSelection("middle")):(t.update(),t.restoreScroll(),e instanceof Object&&t.select(t.data[0])),t.getFocus(),window.on("keydown",this.keydown)},d.undo=function(){this.history.canUndo()&&this.history.restore("undo")},d.redo=function(){this.history.canRedo()&&this.history.restore("redo")},d.createId=function(){let e;for(;e=X.generate64bit(),this.idList.includes(e););return this.idList.push(e),e},d.getVariableById=function(){const s=(t,i)=>{var a=t.length;for(let e=0;e<a;e++){var n=t[e];if("folder"!==n.class){if(n.id===i)return n}else{n=s(n.children,i);if(void 0!==n)return n}}};return function(e){return s(this.data,e)}}(),d.openPropertyPanel=function(e){var t,i,a,n,s=this.panel;s.variable!==e&&(s.variable=e,s.show(),s=this["inputs"],{name:e,sort:t,value:i,note:a}=e,n=typeof i,s.name.write(e),s.sort.write(t),s.type.write(n),s.boolean.write("boolean"==n&&i),s.number.write("number"==n?i:0),s.string.write("string"==n?i:""),s.note.write(a))},d.closePropertyPanel=function(){var e=this.panel;e.variable&&(e.variable=null,e.hide())},d.unpackVariables=function(){class s{constructor(e){this.data=e,this.class=e.class,this.name=e.name,this.children=t(e.children)}get expanded(){return this.data.expanded}set expanded(e){this.data.expanded=e,R.planToSave(He.manifest.project.variables)}}const t=t=>{var i=t.length,a=new Array(i);for(let e=0;e<i;e++){var n=t[e];"folder"!==n.class?a[e]=Object.clone(n):a[e]=new s(n)}return a};return function(){this.idList=Object.keys(He.variables.map),this.data=t(He.variables)}}(),d.packVariables=function(){const s=t=>{var i=t.length,a=new Array(i);for(let e=0;e<i;e++){var n=t[e];"folder"!==n.class?a[e]=Object.clone(n):a[e]={class:n.class,name:n.name,expanded:n.expanded,children:s(n.children)}}return a};return function(){He.variables=s(this.data),He.createVariableMap()}}(),d.saveHistory=function(e,t,i){var t=`variable-${t}-change`,a=this.history,n=a.index,s=a.length,r=a[n];n===s-1&&void 0!==r&&r.type===t&&r.item===e||a.save({type:t,item:e,value:i})},d.windowClose=function(e){this.list.saveScroll(),this.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedVariables")},[{label:e("yes"),click:()=>{this.changed=!1,O.close("variable")}},{label:e("no")}]))}.bind(d),d.windowClosed=function(e){this.target=null,this.data=null,this.idList=null,this.history=null,this.searcher.write(""),this.list.clear(),this.closePropertyPanel(),window.off("keydown",this.keydown)}.bind(d),d.keydown=function(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyZ":return d.undo();case"KeyY":return d.redo()}},d.listKeydown=function(e){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyC":this.copy(t);break;case"KeyV":this.paste()}else if(!e.altKey)switch(e.code){case"Insert":t&&this.addNodeTo(this.createVariable(),t);break;case"Delete":this.delete(t);break;case"Backspace":this.cancelSearch()}},d.listPointerdown=function(e){3===e.button&&this.cancelSearch()},d.listSelect=function(e){e=e.value;return"folder"!==e.class?d.openPropertyPanel(e):d.closePropertyPanel()},d.listRecord=function(e){d.changed=!0;var t=e.value;switch(t.type){case"rename":var{item:i,oldValue:a,newValue:n}=t;if(d.panel.variable===i){d.inputs.name.write(n),d.saveHistory(i,"name",a);break}default:d.history.save({type:"variable-list-operation",response:t})}},d.listPopup=function(e){const t=e.value;var i=!!t,a=i&&"folder"!==t.class,n=Clipboard.has("yami.data.variable"),s=d.history.canUndo(),r=d.history.canRedo(),o=N.createGetter("menuVariableList");let l=Array.empty;a&&(l=[{label:"ID: "+t.id,style:"id",click:()=>{navigator.clipboard.writeText(t.id)}}]),ve.popup({x:e.clientX,y:e.clientY},[...l,{label:o("create"),submenu:[{label:o("create.folder"),click:()=>{this.addNodeTo(this.createFolder(),t)}},{label:o("create.variable"),accelerator:"Insert",click:()=>{this.addNodeTo(this.createVariable(),t)}}]},{label:o("copy"),accelerator:p("C"),enabled:a,click:()=>{this.copy(t)}},{label:o("paste"),accelerator:p("V"),enabled:n,click:()=>{this.paste(t)}},{label:o("delete"),accelerator:"Delete",enabled:i,click:()=>{this.delete(t)}},{label:o("rename"),accelerator:"F2",enabled:i,click:()=>{this.rename(t)}},{label:o("undo"),accelerator:p("Z"),enabled:s,click:()=>{d.undo()}},{label:o("redo"),accelerator:p("Y"),enabled:r,click:()=>{d.redo()}}])},d.listOpen=function(e){"folder"!==e.value.class&&d.target instanceof Object&&(d.target.getFocus?.(),d.confirm())},d.nameInput=function(e){var t=d.panel.variable;"folder"!==t.class&&(d.saveHistory(t,"name",t.name),t.name=e.target.value,d.list.updateItemName(t),d.changed=!0)},d.sortWrite=function(e){switch(e.value){case 0:case 1:_("#variable-type-object").disable();break;case 2:_("#variable-type-object").enable()}},d.sortInput=function(e){var t=d.panel.variable,e=e.value;d.saveHistory(t,"sort",{sort:t.sort,value:t.value}),null===t.value&&(t.value=d.inputs.boolean.read(),d.inputs.type.write("boolean"),d.list.updateIcon(t),d.list.updateInitText(t)),t.sort=e,d.list.updateItemClass(t),d.changed=!0},d.typeWrite=function(e){var t=d.inputs.value["style"];switch(d.manager.switch(e.value),e.value){case"boolean":case"number":case"string":t.visibility="visible";break;case"object":t.visibility="hidden"}},d.typeInput=function(e){var t=d.panel.variable,i=e.value;switch(d.saveHistory(t,"type",t.value),i){case"boolean":case"number":case"string":t.value=d.inputs[i].read();break;case"object":t.value=null}d.list.updateIcon(t),d.list.updateInitText(t),d.changed=!0},d.valueInput=function(e){"insertCompositionText"!==e.inputType&&(e=d.panel.variable,d.saveHistory(e,"value",e.value),e.value=this.read(),d.list.updateInitText(e),d.changed=!0)},d.noteInput=function(e){"insertCompositionText"!==e.inputType&&(e=d.panel.variable,d.saveHistory(e,"note",e.note),e.note=this.read(),d.list.updateNoteIcon(e),d.changed=!0)},d.panelKeydown=function(e){switch(e.target.tagName){case"INPUT":case"TEXTAREA":if(e.cmdOrCtrlKey)switch(e.code){case"Enter":case"NumpadEnter":break;default:e.stopPropagation()}}},d.searcherInput=function(e){"insertCompositionText"!==e.inputType&&(e=this.input.value,d.list.searchNodes(e))},d.confirm=function(e){var t=this.target;if(t instanceof Object){var i=this.panel.variable;if(null===i)return this.list.getFocus();var a=t.filter;switch(a){case"boolean":case"number":case"string":case"object":if(typeof i.value!==a)return _("#variable-type-"+a).getFocus()}this.apply(),t.input(i.id)}else this.apply();O.close("variable")}.bind(d),d.apply=function(e){this.changed&&(this.changed=!1,this.packVariables(),R.planToSave(He.manifest.project.variables),window.dispatchEvent(new Event("variablechange")))}.bind(d),d.list.copy=function(e){e&&"folder"!==e.class&&Clipboard.write("yami.data.variable",e)},d.list.paste=function(e){var t=Clipboard.read("yami.data.variable");t&&(t.id=d.createId(),t.name+=" - Copy",this.addNodeTo(t,e))},d.list.delete=function(a){var e;a&&(e=N.createGetter("confirmation"),O.confirm({message:e("deleteSingleFile").replace("<filename>",a.name)},[{label:e("yes"),click:()=>{var e=this.elements,t=e.indexOf(a.element),i=(this.deleteNode(a),d.closePropertyPanel(),e.count-1),e=e[Math.min(t,i)];e instanceof HTMLElement&&this.select(e.item)}},{label:e("no")}]))},d.list.saveScroll=function(){var e=He["variables"];void 0===e.scrollTop&&Object.defineProperty(e,"scrollTop",{writable:!0,value:0}),e.scrollTop=this.scrollTop},d.list.restoreScroll=function(){this.scrollTop=He.variables.scrollTop??0},d.list.cancelSearch=function(){var e;"search"===this.display&&(e=document.activeElement,d.searcher.deleteInputContent(),this.expandToSelection(),this.scrollToSelection(),e.focus())},d.list.createFolder=function(){return{class:"folder",name:"New Folder",expanded:!1,children:[]}},d.list.createVariable=function(){return{id:d.createId(),name:"Variable",value:!1,sort:0,note:""}},d.list.createIcon=function(){const i={boolean:"icon-boolean",number:"icon-number",string:"icon-string",object:"icon-object"};return function(e){var t=document.createElement("node-icon");return"folder"!==e.class?t.addClass(i[typeof e.value]):t.addClass("icon-folder"),t}}(),d.list.updateIcon=function(e){var t=e["element"];t?.nodeIcon&&(e=this.createIcon(e),t.replaceChild(e,t.nodeIcon),t.nodeIcon=e)},d.list.addElementClass=function(e){e.element.addClass("variable-item")},d.list.updateItemClass=function(e){var t=e["element"];switch(e.sort){case 0:t.removeClass("shared-variable"),t.removeClass("temporary-variable");break;case 1:t.addClass("shared-variable"),t.removeClass("temporary-variable");break;case 2:t.removeClass("shared-variable"),t.addClass("temporary-variable")}},d.list.createInitText=function(e){var t;"folder"!==e.class&&(e=e["element"],(t=document.createElement("text")).addClass("variable-init-text"),e.appendChild(t),e.initText=t,e.initValue=void 0)},d.list.updateInitText=function(e){var t=e["element"];if(void 0!==t.initText){var i=e["value"];if(t.initValue!==i)switch(typeof(t.initValue=i)){case"boolean":case"number":t.initText.textContent=" = "+i;break;case"string":i=`"${I.parseMultiLineString(i)}"`,t.initText.textContent=" = "+i;break;case"object":t.initText.textContent=""}}},d.list.createNoteIcon=function(e){var t;"folder"!==e.class&&(e=e["element"],(t=document.createElement("node-icon")).addClass("icon-note"),t.textContent="",e.appendChild(t),e.noteIcon=t,e.annotated=null)},d.list.updateNoteIcon=function(e){var t=e["element"];void 0!==t.noteIcon&&(e=""!==e.note,t.annotated!==e)&&((t.annotated=e)?t.noteIcon.show():t.noteIcon.hide())},{list:_("#attribute-list"),panel:_("#attribute-properties-flex").hide(),searcher:_("#attribute-searcher"),inputs:{name:_("#attribute-name"),key:_("#attribute-key"),type:_("#attribute-type"),note:_("#attribute-note"),enum:_("#attribute-enum"),enumBox:_("#attribute-enum-box")},mode:null,target:null,data:null,idList:null,settings:null,settingKeys:null,history:null,changed:!1,initialize:null,open:null,undo:null,redo:null,createId:null,getItemById:null,setFolderGroup:null,getGroup:null,getAttribute:null,getGroupAttribute:null,getDefAttributeId:null,getAttributeItems:null,openPropertyPanel:null,closePropertyPanel:null,unpackAttribute:null,packAttribute:null,saveHistory:null,windowClose:null,windowClosed:null,keydown:null,listKeydown:null,listPointerdown:null,listDoubleclick:null,listSelect:null,listRecord:null,listOpen:null,listPopup:null,nameInput:null,keyInput:null,typeWrite:null,typeInput:null,enumInput:null,noteInput:null,panelKeydown:null,searcherInput:null,confirm:null,apply:null});v.list.copy=null,v.list.paste=null,v.list.delete=null,v.list.saveScroll=null,v.list.restoreScroll=null,v.list.cancelSearch=null,v.list.createAttribute=null,v.list.createIcon=null,v.list.updateIcon=null,v.list.addElementClass=null,v.list.createGroupText=null,v.list.updateGroupText=null,v.list.createInitText=null,v.list.updateInitText=null,v.list.createNoteIcon=null,v.list.updateNoteIcon=null,v.initialize=function(){const n=this["list"];n.removable=!0,n.renamable=!0,n.bind(()=>this.data),n.creators.push(n.addElementClass),n.creators.push(n.createGroupText),n.updaters.push(n.updateGroupText),n.creators.push(n.createInitText),n.creators.push(n.updateInitText),n.creators.push(n.createNoteIcon),n.creators.push(n.updateNoteIcon),this.panel.attribute=null,this.searcher.addCloseButton(),l.processors["attribute-list-operation"]=(e,t)=>{t=t.response;n.restore(e,t),null===n.read()&&null!==this.panel.attribute&&this.closePropertyPanel(),this.changed=!0},l.processors["attribute-settings-change"]=(e,t)=>{var i=t["settings"];t.settings=this.settings,this.settings=i,n.update(),this.changed=!0},l.processors["attribute-name-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.name,i.name=a,n.updateItemName(i),this.panel.attribute===i?this.inputs.name.write(a):(n.select(i),n.expandToSelection(),n.scrollToSelection()),this.changed=!0},l.processors["attribute-key-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.key,i.key=a,n.updateInitText(i),this.panel.attribute===i?this.inputs.key.write(a):(n.select(i),n.expandToSelection(),n.scrollToSelection()),this.changed=!0},l.processors["attribute-type-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.type,i.type=a,n.updateIcon(i),this.panel.attribute===i?this.inputs.type.write(a):(n.select(i),n.expandToSelection(),n.scrollToSelection()),this.changed=!0},l.processors["attribute-enum-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.enum,i.enum=a,this.panel.attribute===i?this.inputs.enum.write(a):(n.select(i),n.expandToSelection(),n.scrollToSelection()),this.changed=!0},l.processors["attribute-note-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.note,i.note=a,n.updateNoteIcon(i),this.panel.attribute===i?this.inputs.note.write(a):(n.select(i),n.expandToSelection(),n.scrollToSelection()),this.changed=!0},_("#attribute").on("close",this.windowClose),_("#attribute").on("closed",this.windowClosed),n.on("keydown",this.listKeydown),n.on("pointerdown",this.listPointerdown),n.on("doubleclick",this.listDoubleclick,{capture:!0}),n.on("select",this.listSelect),n.on("record",this.listRecord),n.on("open",this.listOpen),n.on("popup",this.listPopup),this.inputs.name.on("input",this.nameInput),this.inputs.key.on("input",this.keyInput),this.inputs.type.on("write",this.typeWrite),this.inputs.type.on("input",this.typeInput),this.inputs.enum.on("input",this.enumInput),this.inputs.note.on("input",this.noteInput),this.inputs.note.on("compositionend",this.noteInput),this.panel.on("keydown",this.panelKeydown),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),_("#attribute-confirm").on("click",this.confirm),_("#attribute-apply").on("click",this.apply)},v.open=function(e=null,t="normal"){this.mode=t,this.target=e,this.history=new l(100),this.unpackAttribute(),O.open("attribute");var t=this.list,i=e?this.getItemById(e.read()):void 0;i?(t.initialize(),t.select(i),t.expandToSelection(!1),t.update(),t.restoreScroll(),t.scrollToSelection("middle")):(t.update(),t.restoreScroll(),e instanceof Object&&t.select(t.data[0])),this.list.getFocus(),window.on("keydown",this.keydown)},v.undo=function(){this.history.canUndo()&&this.history.restore("undo")},v.redo=function(){this.history.canRedo()&&this.history.restore("redo")},v.createId=function(){let e;for(;e=X.generate64bit(),this.idList.includes(e););return this.idList.push(e),e},v.getItemById=function(){const s=(t,i)=>{var a=t.length;for(let e=0;e<a;e++){var n=t[e];if(n.id===i)return n;if("folder"===n.class){n=s(n.children,i);if(void 0!==n)return n}}};return function(e){return s(this.data,e)}}(),v.setFolderGroup=function(e,t){var i,a=e.element.group;a!==t&&(i=Object.clone(this.settings),a&&(this.settings[a]=""),t&&(this.settings[t]=e.id),this.history.save({type:"attribute-settings-change",settings:i}),this.list.update(),this.changed=!0)},v.getGroup=function(e){return He.attribute.context.getGroup(e)},v.getAttribute=function(e){return He.attribute.context.getAttribute(e)},v.getGroupAttribute=function(e,t){return He.attribute.context.getGroupAttribute(e,t)},v.getDefAttributeId=function(e,t){return He.attribute.context.getDefAttributeId(e,t)},v.getAttributeItems=function(e,t,i){return He.attribute.context.getAttributeItems(e,t,i)},v.openPropertyPanel=function(e){var t=this.panel;t.attribute!==e&&(t.attribute=e,t.show(),t=this["inputs"],t.name.write(e.name),t.key.write(e.key),t.type.write(e.type),t.enum.write(e.enum),t.note.write(e.note))},v.closePropertyPanel=function(){var e=this.panel;e.attribute&&(e.attribute=null,e.hide())},v.unpackAttribute=function(){class s{constructor(e){this.data=e,this.class=e.class,this.id=e.id,this.name=e.name,this.children=t(e.children)}get expanded(){return this.data.expanded}set expanded(e){this.data.expanded=e,R.planToSave(He.manifest.project.attribute)}}const t=t=>{var i=t.length,a=new Array(i);for(let e=0;e<i;e++){var n=t[e];v.idList.push(n.id),"folder"!==n.class?a[e]=Object.clone(n):a[e]=new s(n)}return a};return function(){this.idList=[],this.data=t(He.attribute.keys),this.settings=Object.clone(He.attribute.settings),this.settingKeys||(this.settingKeys=Object.keys(this.settings))}}(),v.packAttribute=function(){const r=t=>{var i=t.length,a=new Array(i);for(let e=0;e<i;e++){var n,s=t[e];"folder"!==s.class?(""!==(n=Object.clone(s)).enum&&"enum"!==n.type&&(n.enum=""),a[e]=n):a[e]={class:s.class,id:s.id,name:s.name,expanded:s.expanded,children:r(s.children)}}return a};return function(){He.attribute.keys=r(this.data),He.attribute.settings=Object.clone(this.settings),He.createAttributeContext()}}(),v.saveHistory=function(e,t,i){var t=`attribute-${t}-change`,a=this.history,n=a.index,s=a.length,r=a[n];n===s-1&&void 0!==r&&r.type===t&&r.item===e||a.save({type:t,item:e,value:i})},v.windowClose=function(e){this.list.saveScroll(),this.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedAttributes")},[{label:e("yes"),click:()=>{this.changed=!1,O.close("attribute")}},{label:e("no")}]))}.bind(v),v.windowClosed=function(e){this.data=null,this.idList=null,this.history=null,this.searcher.write(""),this.list.clear(),this.closePropertyPanel(),window.off("keydown",this.keydown)}.bind(v),v.keydown=function(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyZ":return v.undo();case"KeyY":return v.redo()}},v.listKeydown=function(e){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyC":this.copy(t);break;case"KeyV":this.paste()}else if(!e.altKey)switch(e.code){case"Insert":t&&this.addNodeTo(this.createAttribute(),t);break;case"Delete":this.delete(t);break;case"Backspace":this.cancelSearch()}},v.listPointerdown=function(e){switch(e.button){case 0:e.target===this&&(this.unselect(),v.closePropertyPanel());break;case 3:this.cancelSearch()}},v.listDoubleclick=function(e){switch(v.mode){case"group":"folder"===v.list.read()?.class&&(v.target.getFocus?.(),e.stopPropagation(),v.confirm());break;case"attribute":void 0!==v.list.read()?.key&&(v.target.getFocus?.(),e.stopPropagation(),v.confirm())}},v.listSelect=function(e){e=e.value;return"folder"!==e.class?v.openPropertyPanel(e):v.closePropertyPanel()},v.listRecord=function(e){v.changed=!0;var t=e.value;switch(t.type){case"rename":var{item:i,oldValue:a,newValue:n}=t;if(v.panel.attribute===i){v.inputs.name.write(n),v.saveHistory(i,"name",a);break}default:v.history.save({type:"attribute-list-operation",response:t})}},v.listOpen=function(e){v.listDoubleclick(e)},v.listPopup=function(e){const t=e.value;var i=!!t,a=i&&"folder"!==t.class,n=Clipboard.has("yami.data.attribute"),s=v.history.canUndo(),r=v.history.canRedo(),o=N.createGetter("menuAttributeList");let l=Array.empty,c=Array.empty;if(i&&(l=[{label:"ID: "+t.id,style:"id",click:()=>{navigator.clipboard.writeText(t.id)}}]),i&&"folder"===t.class){var h=t.element.group,d=[{label:o("set-as.none"),checked:""===h,click:()=>{v.setFolderGroup(t,"")}}];for(const u of v.settingKeys)d.push({label:o("set-as."+u),checked:h===u,click:()=>{v.setFolderGroup(t,u)}});c=[{label:o("set-as"),submenu:d}]}ve.popup({x:e.clientX,y:e.clientY},[...l,{label:o("create"),submenu:[{label:o("create.folder"),click:()=>{this.addNodeTo(this.createFolder(),t)}},{label:o("create.attribute"),accelerator:"Insert",click:()=>{this.addNodeTo(this.createAttribute(),t)}}]},{label:o("copy"),accelerator:p("C"),enabled:a,click:()=>{this.copy(t)}},{label:o("paste"),accelerator:p("V"),enabled:n,click:()=>{this.paste(t)}},{label:o("delete"),accelerator:"Delete",enabled:i,click:()=>{this.delete(t)}},{label:o("rename"),accelerator:"F2",enabled:i,click:()=>{this.rename(t)}},{label:o("undo"),accelerator:p("Z"),enabled:s,click:()=>{v.undo()}},{label:o("redo"),accelerator:p("Y"),enabled:r,click:()=>{v.redo()}},...c])},v.nameInput=function(e){var t=v.panel.attribute;"folder"!==t.class&&(v.saveHistory(t,"name",t.name),t.name=e.target.value,v.list.updateItemName(t),v.changed=!0)},v.keyInput=function(e){var t=v.panel.attribute;"folder"!==t.class&&(v.saveHistory(t,"key",t.key),t.key=e.target.value,v.list.updateInitText(t),v.changed=!0)},v.typeWrite=function(e){var t=v.inputs.enumBox["style"];switch(e.value){case"enum":t.visibility="visible";break;case"boolean":case"number":case"string":case"object":t.visibility="hidden"}},v.typeInput=function(e){var t=v.panel.attribute;v.saveHistory(t,"type",t.type),t.type=e.value,v.list.updateIcon(t),v.changed=!0},v.enumInput=function(e){var t=v.panel.attribute;v.saveHistory(t,"enum",t.enum),t.enum=e.value,v.changed=!0},v.noteInput=function(e){"insertCompositionText"!==e.inputType&&(e=v.panel.attribute,v.saveHistory(e,"note",e.note),e.note=this.read(),v.list.updateNoteIcon(e),v.changed=!0)},v.panelKeydown=function(e){switch(e.target.tagName){case"INPUT":case"TEXTAREA":if(e.cmdOrCtrlKey)switch(e.code){case"Enter":case"NumpadEnter":break;default:e.stopPropagation()}}},v.searcherInput=function(e){"insertCompositionText"!==e.inputType&&(e=this.input.value,v.list.searchNodes(e))},v.confirm=function(e){switch(this.mode){case"normal":this.apply();break;case"group":var t=this.list.read();if(t&&"folder"!==t.class)return this.list.getFocus();this.apply(),this.target.input(t?t.id:"");break;case"attribute":t=this.list.read();if(t&&"folder"===t.class)return this.list.getFocus();this.apply(),this.target.input(t?t.id:"")}O.close("attribute")}.bind(v),v.apply=function(e){this.changed&&(this.changed=!1,this.packAttribute(),R.planToSave(He.manifest.project.attribute),window.dispatchEvent(new Event("attributechange")))}.bind(v),v.list.copy=function(e){"folder"!==e.class&&Clipboard.write("yami.data.attribute",e)},v.list.paste=function(e){var t=Clipboard.read("yami.data.attribute");t&&(t.id=v.createId(),t.name+=" - Copy",this.addNodeTo(t,e))},v.list.delete=function(a){var e;a&&(e=N.createGetter("confirmation"),O.confirm({message:e("deleteSingleFile").replace("<filename>",a.name)},[{label:e("yes"),click:()=>{var e=this.elements,t=e.indexOf(a.element),i=(this.deleteNode(a),v.closePropertyPanel(),e.count-1),e=e[Math.min(t,i)];e instanceof HTMLElement&&this.select(e.item)}},{label:e("no")}]))},v.list.saveScroll=function(){var e=He["attribute"];void 0===e.scrollTop&&Object.defineProperty(e,"scrollTop",{writable:!0,value:0}),e.scrollTop=this.scrollTop},v.list.restoreScroll=function(){this.scrollTop=He.attribute.scrollTop??0},v.list.cancelSearch=function(){var e;"search"===this.display&&(e=document.activeElement,v.searcher.deleteInputContent(),this.expandToSelection(),this.scrollToSelection(),e.focus())},v.list.createFolder=function(){return{class:"folder",id:v.createId(),name:"New Folder",expanded:!1,children:[]}},v.list.createAttribute=function(){return{id:v.createId(),key:"",type:"number",name:"Attribute",enum:"",note:""}},v.list.createIcon=function(){const i={boolean:"icon-boolean",number:"icon-number",string:"icon-string",enum:"icon-string",object:"icon-object"};return function(e){var t=document.createElement("node-icon");return"folder"!==e.class?t.addClass(i[e.type]):t.addClass("icon-folder"),t}}(),v.list.updateIcon=function(e){var t=e["element"];t?.nodeIcon&&(e=this.createIcon(e),t.replaceChild(e,t.nodeIcon),t.nodeIcon=e)},v.list.addElementClass=function(e){e.element.addClass("attribute-item")},v.list.createGroupText=function(e){var t;"folder"===e.class&&(e=e["element"],(t=document.createElement("text")).addClass("enum-init-text"),e.appendChild(t),e.groupText=t,e.group="")},v.list.updateGroupText=function(t){var i=t["element"];if(void 0!==i.groupText){let e="";for(const a of v.settingKeys)t.id===v.settings[a]&&(e=a);i.group!==e&&(i.group=e,i.groupText.textContent=e?" ★":"")}},v.list.createInitText=function(e){var t;"folder"!==e.class&&(e=e["element"],(t=document.createElement("text")).addClass("attribute-init-text"),e.appendChild(t),e.initText=t,e.attrKey="")},v.list.updateInitText=function(e){var t=e["element"];void 0!==t.initText&&(e=e["key"],t.attrKey!==e)&&(t.attrKey=e,t.initText.textContent=e?" = "+e:"")},v.list.createNoteIcon=function(e){var t;"folder"!==e.class&&(e=e["element"],(t=document.createElement("node-icon")).addClass("icon-note"),t.textContent="",e.appendChild(t),e.noteIcon=t,e.annotated=null)},v.list.updateNoteIcon=function(e){var t=e["element"];void 0!==t.noteIcon&&(e=""!==e.note,t.annotated!==e)&&((t.annotated=e)?t.noteIcon.show():t.noteIcon.hide())};class st{itemMap;groupMap;itemCache;itemLists;constructor(e){const s={},r={},o=(t,e)=>{for(const n of e){var i=n.id;if("folder"===(s[i]=n).class)r[i]={groupName:n.name,itemMap:{},itemList:[]},t.push(i),o(t,n.children),t.pop();else for(let e=0;e<t.length;e++){var a=r[t[e]];a.itemMap[i]=n,a.itemList.push(n)}}};o([],e.keys);var t,i,a=e.settings;for([t,i]of Object.entries(a))i in r?r[t]=r[i]:(""!==i&&(a[t]=""),r[t]={groupName:"",itemMap:Object.empty,itemList:Array.empty});this.itemMap=s,this.groupMap=r,this.itemCache={},this.itemLists={}}getGroup(e){return this.groupMap[e]}getAttribute(e){return this.itemMap[e]}getGroupAttribute(e,t){return this.groupMap[e]?.itemMap[t]}getDefAttributeId(e,t){e=this.groupMap[e];if(e)for(const i of e.itemList)if(!t||i.type===t)return i.id;return""}getAttributeItems(e,t="",i=!1){let a=e+t;if(i&&(a+="-allowNone"),!this.itemLists[a]){var n=[],e=this.groupMap[e];if(e){var s=t.split("|"),r=(s.includes("string")&&s.append("enum"),this.itemCache);for(const o of e.itemList)if(!t||s.includes(o.type)){let e=r[o.id];void 0===e&&(e=r[o.id]={name:o.name,value:o.id}),n.push(e)}}i&&n.unshift({name:N.get("common.none"),value:""}),0===n.length&&n.push({name:N.get("common.none"),value:""}),this.itemLists[a]=n}return this.itemLists[a]}}const M={list:_("#enum-list"),panel:_("#enum-properties-flex").hide(),searcher:_("#enum-searcher"),inputs:{name:_("#enum-name"),value:_("#enum-value"),note:_("#enum-note")},mode:null,target:null,data:null,idList:null,settings:null,settingKeys:null,history:null,changed:!1,initialize:null,open:null,undo:null,redo:null,createId:null,getItemById:null,setFolderGroup:null,getEnumGroup:null,getString:null,getGroupString:null,getDefStringId:null,getStringItems:null,getMergedItems:null,openPropertyPanel:null,closePropertyPanel:null,unpackEnumeration:null,packEnumeration:null,saveHistory:null,windowClose:null,windowClosed:null,keydown:null,listKeydown:null,listPointerdown:null,listDoubleclick:null,listSelect:null,listRecord:null,listOpen:null,listPopup:null,nameInput:null,valueInput:null,noteInput:null,panelKeydown:null,searcherInput:null,confirm:null,apply:null};M.list.copy=null,M.list.paste=null,M.list.delete=null,M.list.saveScroll=null,M.list.restoreScroll=null,M.list.cancelSearch=null,M.list.createString=null,M.list.createIcon=null,M.list.addElementClass=null,M.list.createGroupText=null,M.list.updateGroupText=null,M.list.createInitText=null,M.list.updateInitText=null,M.list.createNoteIcon=null,M.list.updateNoteIcon=null,M.initialize=function(){const n=this["list"];n.removable=!0,n.renamable=!0,n.bind(()=>this.data),n.creators.push(n.addElementClass),n.creators.push(n.createGroupText),n.updaters.push(n.updateGroupText),n.creators.push(n.createInitText),n.creators.push(n.updateInitText),n.creators.push(n.createNoteIcon),n.creators.push(n.updateNoteIcon),this.panel.enumString=null,this.searcher.addCloseButton(),l.processors["enum-list-operation"]=(e,t)=>{t=t.response;n.restore(e,t),null===n.read()&&null!==this.panel.enumString&&this.closePropertyPanel(),this.changed=!0},l.processors["enum-settings-change"]=(e,t)=>{var i=t["settings"];t.settings=this.settings,this.settings=i,n.update(),this.changed=!0},l.processors["enum-name-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.name,i.name=a,n.updateItemName(i),this.panel.enumString===i?this.inputs.name.write(a):(n.select(i),n.expandToSelection(),n.scrollToSelection()),this.changed=!0},l.processors["enum-value-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.value,i.value=a,n.updateInitText(i),this.panel.enumString===i?this.inputs.value.write(a):(n.select(i),n.expandToSelection(),n.scrollToSelection()),this.changed=!0},l.processors["enum-note-change"]=(e,t)=>{var{item:i,value:a}=t;t.value=i.note,i.note=a,n.updateNoteIcon(i),this.panel.enumString===i?this.inputs.note.write(a):(n.select(i),n.expandToSelection(),n.scrollToSelection()),this.changed=!0},_("#enum").on("close",this.windowClose),_("#enum").on("closed",this.windowClosed),n.on("keydown",this.listKeydown),n.on("pointerdown",this.listPointerdown),n.on("doubleclick",this.listDoubleclick,{capture:!0}),n.on("select",this.listSelect),n.on("record",this.listRecord),n.on("open",this.listOpen),n.on("popup",this.listPopup),this.inputs.name.on("input",this.nameInput),this.inputs.value.on("input",this.valueInput),this.inputs.note.on("input",this.noteInput),this.inputs.note.on("compositionend",this.noteInput),this.panel.on("keydown",this.panelKeydown),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),_("#enum-confirm").on("click",this.confirm),_("#enum-apply").on("click",this.apply)},M.open=function(e=null,t="normal"){this.mode=t,this.target=e,this.history=new l(100),this.unpackEnumeration(),O.open("enum");var t=this.list,i=e?this.getItemById(e.read()):void 0;i?(t.initialize(),t.select(i),t.expandToSelection(!1),t.update(),t.restoreScroll(),t.scrollToSelection("middle")):(t.update(),t.restoreScroll(),e instanceof Object&&t.select(t.data[0])),t.getFocus(),window.on("keydown",this.keydown)},M.undo=function(){this.history.canUndo()&&this.history.restore("undo")},M.redo=function(){this.history.canRedo()&&this.history.restore("redo")},M.createId=function(){let e;for(;e=X.generate64bit(),this.idList.includes(e););return this.idList.push(e),e},M.getItemById=function(){const s=(t,i)=>{var a=t.length;for(let e=0;e<a;e++){var n=t[e];if(n.id===i)return n;if("folder"===n.class){n=s(n.children,i);if(void 0!==n)return n}}};return function(e){return s(this.data,e)}}(),M.setFolderGroup=function(e,t){var i,a=e.element.group;a!==t&&(i=Object.clone(this.settings),a&&(this.settings[a]=""),t&&(this.settings[t]=e.id),this.history.save({type:"enum-settings-change",settings:i}),this.list.update(),this.changed=!0)},M.getEnumGroup=function(e){return He.enumeration.context.getEnumGroup(e)},M.getString=function(e){return He.enumeration.context.getString(e)},M.getGroupString=function(e,t){return He.enumeration.context.getGroupString(e,t)},M.getDefStringId=function(e){return He.enumeration.context.getDefStringId(e)},M.getStringItems=function(e,t){return He.enumeration.context.getStringItems(e,t)},M.getMergedItems=function(e,t,i){return He.enumeration.context.getMergedItems(e,t,i)},M.openPropertyPanel=function(e){var t=this.panel;t.enumString!==e&&(t.enumString=e,t.show(),t=this["inputs"],t.name.write(e.name),t.value.write(e.value),t.note.write(e.note))},M.closePropertyPanel=function(){var e=this.panel;e.enumString&&(e.enumString=null,e.hide())},M.unpackEnumeration=function(){class s{constructor(e){this.data=e,this.class=e.class,this.id=e.id,this.name=e.name,this.children=t(e.children)}get expanded(){return this.data.expanded}set expanded(e){this.data.expanded=e,R.planToSave(He.manifest.project.enumeration)}}const t=t=>{var i=t.length,a=new Array(i);for(let e=0;e<i;e++){var n=t[e];M.idList.push(n.id),"folder"!==n.class?a[e]=Object.clone(n):a[e]=new s(n)}return a};return function(){this.idList=[],this.data=t(He.enumeration.strings),this.settings=Object.clone(He.enumeration.settings),this.settingKeys||(this.settingKeys=Object.keys(this.settings))}}(),M.packEnumeration=function(){const s=t=>{var i=t.length,a=new Array(i);for(let e=0;e<i;e++){var n=t[e];"folder"!==n.class?a[e]=Object.clone(n):a[e]={class:n.class,id:n.id,name:n.name,expanded:n.expanded,children:s(n.children)}}return a};return function(){He.enumeration.strings=s(this.data),He.enumeration.settings=Object.clone(this.settings),He.createEnumerationContext()}}(),M.saveHistory=function(e,t,i){var t=`enum-${t}-change`,a=this.history,n=a.index,s=a.length,r=a[n];n===s-1&&void 0!==r&&r.type===t&&r.item===e||a.save({type:t,item:e,value:i})},M.windowClose=function(e){this.list.saveScroll(),this.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedEnumeration")},[{label:e("yes"),click:()=>{this.changed=!1,O.close("enum")}},{label:e("no")}]))}.bind(M),M.windowClosed=function(e){this.data=null,this.idList=null,this.settings=null,this.history=null,this.searcher.write(""),this.list.clear(),this.closePropertyPanel(),window.off("keydown",this.keydown)}.bind(M),M.keydown=function(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyZ":return M.undo();case"KeyY":return M.redo()}},M.listKeydown=function(e){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyC":this.copy(t);break;case"KeyV":this.paste()}else if(!e.altKey)switch(e.code){case"Insert":t&&this.addNodeTo(this.createString(),t);break;case"Delete":this.delete(t);break;case"Backspace":this.cancelSearch()}},M.listPointerdown=function(e){switch(e.button){case 0:e.target===this&&(this.unselect(),M.closePropertyPanel());break;case 3:this.cancelSearch()}},M.listDoubleclick=function(e){switch(M.mode){case"group":"folder"===M.list.read()?.class&&(M.target.getFocus?.(),e.stopPropagation(),M.confirm());break;case"string":void 0!==M.list.read()?.value&&(M.target.getFocus?.(),e.stopPropagation(),M.confirm())}},M.listSelect=function(e){e=e.value;return"folder"!==e.class?M.openPropertyPanel(e):M.closePropertyPanel()},M.listRecord=function(e){M.changed=!0;var t=e.value;switch(t.type){case"rename":var{item:i,oldValue:a,newValue:n}=t;if(M.panel.enumString===i){M.inputs.name.write(n),M.saveHistory(i,"name",a);break}default:M.history.save({type:"enum-list-operation",response:t})}},M.listOpen=function(e){M.listDoubleclick(e)},M.listPopup=function(e){const t=e.value;var i=!!t,a=i&&"folder"!==t.class,n=Clipboard.has("yami.data.enumeration"),s=M.history.canUndo(),r=M.history.canRedo(),o=N.createGetter("menuEnumList");let l=Array.empty,c=Array.empty;if(i&&(l=[{label:"ID: "+t.id,style:"id",click:()=>{navigator.clipboard.writeText(t.id)}}]),i&&"folder"===t.class){var h=t.element.group,d=[{label:o("set-as.none"),checked:""===h,click:()=>{M.setFolderGroup(t,"")}}];for(const u of M.settingKeys)d.push({label:o("set-as."+u),checked:h===u,click:()=>{M.setFolderGroup(t,u)}});c=[{label:o("set-as"),submenu:d}]}ve.popup({x:e.clientX,y:e.clientY},[...l,{label:o("create"),submenu:[{label:o("create.folder"),click:()=>{this.addNodeTo(this.createFolder(),t)}},{label:o("create.string"),accelerator:"Insert",click:()=>{this.addNodeTo(this.createString(),t)}}]},{label:o("copy"),accelerator:p("C"),enabled:a,click:()=>{this.copy(t)}},{label:o("paste"),accelerator:p("V"),enabled:n,click:()=>{this.paste(t)}},{label:o("delete"),accelerator:"Delete",enabled:i,click:()=>{this.delete(t)}},{label:o("rename"),accelerator:"F2",enabled:i,click:()=>{this.rename(t)}},{label:o("undo"),accelerator:p("Z"),enabled:s,click:()=>{M.undo()}},{label:o("redo"),accelerator:p("Y"),enabled:r,click:()=>{M.redo()}},...c])},M.nameInput=function(e){var t=M.panel.enumString;"folder"!==t.class&&(M.saveHistory(t,"name",t.name),t.name=e.target.value,M.list.updateItemName(t),M.changed=!0)},M.valueInput=function(e){var t=M.panel.enumString;"folder"!==t.class&&(M.saveHistory(t,"value",t.value),t.value=e.target.value,M.list.updateInitText(t),M.changed=!0)},M.noteInput=function(e){"insertCompositionText"!==e.inputType&&(e=M.panel.enumString,M.saveHistory(e,"note",e.note),e.note=this.read(),M.list.updateNoteIcon(e),M.changed=!0)},M.panelKeydown=function(e){switch(e.target.tagName){case"INPUT":case"TEXTAREA":if(e.cmdOrCtrlKey)switch(e.code){case"Enter":case"NumpadEnter":break;default:e.stopPropagation()}}},M.searcherInput=function(e){"insertCompositionText"!==e.inputType&&(e=this.input.value,M.list.searchNodes(e))},M.confirm=function(e){switch(this.mode){case"normal":this.apply();break;case"group":var t=this.list.read();if(t&&"folder"!==t.class)return this.list.getFocus();this.apply(),this.target.input(t?t.id:"");break;case"string":t=this.list.read();if(t&&"folder"===t.class)return this.list.getFocus();this.apply(),this.target.input(t?t.id:"")}O.close("enum")}.bind(M),M.apply=function(e){this.changed&&(this.changed=!1,this.packEnumeration(),R.planToSave(He.manifest.project.enumeration),window.dispatchEvent(new Event("enumchange")))}.bind(M),M.list.copy=function(e){"folder"!==e.class&&Clipboard.write("yami.data.enumeration",e)},M.list.paste=function(e){var t=Clipboard.read("yami.data.enumeration");t&&(t.id=M.createId(),t.name+=" - Copy",this.addNodeTo(t,e))},M.list.delete=function(a){var e;a&&(e=N.createGetter("confirmation"),O.confirm({message:e("deleteSingleFile").replace("<filename>",a.name)},[{label:e("yes"),click:()=>{var e=this.elements,t=e.indexOf(a.element),i=(this.deleteNode(a),M.closePropertyPanel(),e.count-1),e=e[Math.min(t,i)];e instanceof HTMLElement&&this.select(e.item)}},{label:e("no")}]))},M.list.saveScroll=function(){var e=He["enumeration"];void 0===e.scrollTop&&Object.defineProperty(e,"scrollTop",{writable:!0,value:0}),e.scrollTop=this.scrollTop},M.list.restoreScroll=function(){this.scrollTop=He.enumeration.scrollTop??0},M.list.cancelSearch=function(){var e;"search"===this.display&&(e=document.activeElement,M.searcher.deleteInputContent(),this.expandToSelection(),this.scrollToSelection(),e.focus())},M.list.createFolder=function(){return{class:"folder",id:M.createId(),name:"New Folder",expanded:!1,children:[]}},M.list.createString=function(){return{id:M.createId(),value:"",name:"Item",note:""}},M.list.createIcon=function(e){var t=document.createElement("node-icon");return"folder"!==e.class?t.addClass("icon-string"):t.addClass("icon-folder"),t},M.list.addElementClass=function(e){e.element.addClass("enum-item")},M.list.createGroupText=function(e){var t;"folder"===e.class&&(e=e["element"],(t=document.createElement("text")).addClass("enum-init-text"),e.appendChild(t),e.groupText=t,e.group="")},M.list.updateGroupText=function(t){var i=t["element"];if(void 0!==i.groupText){let e="";for(const a of M.settingKeys)t.id===M.settings[a]&&(e=a);i.group!==e&&(i.group=e,i.groupText.textContent=e?" ★":"")}},M.list.createInitText=function(e){var t;"folder"!==e.class&&(e=e["element"],(t=document.createElement("text")).addClass("enum-init-text"),e.appendChild(t),e.initText=t,e.attrValue="")},M.list.updateInitText=function(e){var t=e["element"];void 0!==t.initText&&(e=e["value"],t.attrValue!==e)&&(t.attrValue=e,t.initText.textContent=e?" = "+e:"")},M.list.createNoteIcon=function(e){var t;"folder"!==e.class&&(e=e["element"],(t=document.createElement("node-icon")).addClass("icon-note"),t.textContent="",e.appendChild(t),e.noteIcon=t,e.annotated=null)},M.list.updateNoteIcon=function(e){var t=e["element"];void 0!==t.noteIcon&&(e=""!==e.note,t.annotated!==e)&&((t.annotated=e)?t.noteIcon.show():t.noteIcon.hide())};class rt{itemMap;groupMap;itemCache;itemLists;constructor(e){const s={},r={},o=(t,e)=>{for(const n of e){var i=n.id;if("folder"===(s[i]=n).class)r[i]={groupName:n.name,itemMap:{},itemList:[]},t.push(i),o(t,n.children),t.pop();else for(let e=0;e<t.length;e++){var a=r[t[e]];a.itemMap[i]=n,a.itemList.push(n)}}};o([],e.strings);var t,i,a=e.settings;for([t,i]of Object.entries(a))i in r?r[t]=r[i]:(""!==i&&(a[t]=""),r[t]={groupName:"",itemMap:Object.empty,itemList:Array.empty});this.itemMap=s,this.groupMap=r,this.itemCache={},this.itemLists={}}getEnumGroup(e){return this.groupMap[e]}getString(e){return this.itemMap[e]}getGroupString(e,t){return this.groupMap[e]?.itemMap[t]}getDefStringId(e){return this.groupMap[e]?.itemList[0]?.id??""}getStringItems(e,t=!1){let i=e;if(t&&(i+="-allowNone"),!this.itemLists[i]){var a=[],e=this.groupMap[e];if(e){var n=this.itemCache;for(const s of e.itemList){let e=n[s.id];void 0===e&&(e=n[s.id]={name:s.name,value:s.id}),a.push(e)}}t&&a.unshift({name:N.get("common.none"),value:""}),0===a.length&&a.push({name:N.get("common.none"),value:""}),this.itemLists[i]=a}return this.itemLists[i]}getMergedItems(e,t,i="merged"){i=t+"-"+i;if(!this.itemLists[i]){var a=[...e],e=this.groupMap[t];if(e){var n=this.itemCache;for(const s of e.itemList){let e=n[s.id];void 0===e&&(e=n[s.id]={name:s.name,value:s.id}),a.push(e)}}this.itemLists[i]=a}return this.itemLists[i]}}const O={ambient:_("#window-ambient"),frames:[],positionMode:"center",absolutePos:{x:0,y:0},overlapRoot:null,activeElement:null,initialize:null,open:null,close:null,closeAll:null,isWindowOpen:null,setPositionMode:null,saveActiveElement:null,restoreActiveElement:null,refocus:null,confirm:null,keydown:null,cancel:null},N=(O.initialize=function(){var t=document.getElementsByName("cancel"),i=t.length;for(let e=0;e<i;e++)t[e].on("click",this.cancel)},O.open=function(e){const t=this.frames,i=document.getElementById(e);if(i){const a=document["activeElement"];t.includes(i)||(0<t.length?t[t.length-1].blur():(b.pointermove({target:null}),O.saveActiveElement(),x.disableFocusableElements(),document.body.style.pointerEvents="none",document.activeElement.blur(),window.off("keydown",Tt.keydown),window.off("keydown",A.keydown),window.off("keydown",Y.keydown),window.off("keydown",Ke.keydown),window.off("keydown",S.keydown),window.on("keydown",O.keydown)),b.target.tabIndex=-1,b.target.focus(),setTimeout(()=>{document.activeElement===a&&t[t.length-1]===i&&b.target.focus()}),i.open())}},O.close=function(e=null){var t,i=this.frames;i.length&&(t=i[i.length-1],e&&e!==t.id||t.close()&&(0<i.length?i[i.length-1].focus():(b.pointerenter(),O.restoreActiveElement(),x.enableFocusableElements(),document.body.style.pointerEvents="inherit",window.on("keydown",Tt.keydown),window.on("keydown",A.keydown),window.on("keydown",Y.keydown),window.on("keydown",Ke.keydown),window.on("keydown",S.keydown),window.off("keydown",O.keydown)),this.overlapRoot===t)&&this.setPositionMode("center"))},O.closeAll=function(){var e=this.frames;let t=e.length;for(;0<=--t;){var i=e[t],a=i.closeEventEnabled;i.closeEventEnabled=!1,this.close(i.id),i.closeEventEnabled=a}},O.isWindowOpen=function(e){for(const t of this.frames)if(t.id===e)return!0;return!1},O.setPositionMode=function(e){if(this.positionMode!==e){switch(this.overlapRoot&&(this.overlapRoot=null),e){case"center":case"absolute":break;case"overlap":var t=this["frames"],i=t["length"];if(0===i)return;this.overlapRoot=t[i-1]}this.positionMode=e}},O.saveActiveElement=function(){var e=document["activeElement"];e!==document.body&&(this.activeElement=e,this.activeElement.blur())},O.restoreActiveElement=function(){this.activeElement&&(this.activeElement.focus(),this.activeElement=null)},O.refocus=function(){var e=document.activeElement;e!==document.body&&(e.blur(),e.focus())},O.confirm=function(){const l=_("#confirmation"),c=_("#confirmation-message"),h=[_("#confirmation-button-0"),_("#confirmation-button-1"),_("#confirmation-button-2")];return function(i,a){var e=i.message??"";function n(e){O.close("confirmation");var t=h.indexOf(this);a[t].click?.()}for(let e=0;e<h.length;e++){var t=h[e],s=a[e];s?(t.textContent=s.label,t.on("click",n),t.show()):t.hide()}0<a.length&&h[0].getFocus(),c.textContent=e,l.on("closed",e=>{for(const t of h)t.off("click",n);i.close?.()},{once:!0});var e=L(e),r=e.width,e=20*e.lines,o=98*a.length-10,r=Math.max(r,o)+20,o=50+e;l.style.width=r+"px",l.style.height=24+o+"px",O.open("confirmation")}}(),O.keydown=function(e){if(e.altKey)"F4"===e.code&&(e.preventDefault(),O.refocus(),O.close());else switch(e.code){case"Enter":case"NumpadEnter":var t=document.activeElement;if(t instanceof HTMLButtonElement&&!e.cmdOrCtrlKey)return;var i=O.frames,i=`#${i[i.length-1].id} > content-frame > button[name=confirm]`,i=document.querySelector(i);i instanceof HTMLButtonElement&&(e.preventDefault(),t!==document.body&&t.blur(),i.click());break;case"KeyS":if(!e.cmdOrCtrlKey)return;t=O.frames,i=`#${t[t.length-1].id} > content-frame > button[name=apply]`,t=document.querySelector(i);t instanceof HTMLButtonElement&&((i=document.activeElement)!==document.body&&(i.blur(),i.focus()),t.click());break;case"Escape":O.refocus(),O.close()}},O.cancel=function(e){let t=e.target.parentNode;for(;t;){if("WINDOW-FRAME"===t.tagName)return O.close(t.id);t=t.parentNode}},O.ambient.update=function(){var e=O.frames;let t=e.length;for(;0<=--t;)if(e[t].enableAmbient)return this.addClass("open"),void(this.style.zIndex=t+1);this.removeClass("open")},{active:null,dirname:"",language:null,languages:null,properties:{},initialize:null,update:null,readLanguageList:null,setLanguage:null,setProperties:null,setElement:null,createGetter:null,get:null}),ot=(N.initialize=function(){this.dirname=E.resolve(__dirname,"Locales"),this.readLanguageList().then(()=>this.setLanguage(P.config.language)).then(()=>{_("#menu").addClass("visible")})},N.readLanguageList=function(){const r=this.languages=[];return z.readdir(this.dirname,{withFileTypes:!0}).then(e=>{var t,i,a,n=/\.(.+)$/;for(const s of e)s.isDirectory()||(t=s.name,".json"===(i=E.extname(t))&&((a=(i=E.basename(t,i)).match(n))?r.push({key:i.slice(0,a.index),alias:a[1],filename:t}):r.push({key:i,alias:i,filename:t})));return r}).catch(e=>(oi.throw(e),r))},N.setLanguage=async function(i){if(""===(P.config.language=i)){i="en-US";let t=0;var a,n=navigator.language.split("-");for({key:a}of this.languages){var s=a.split("-");if(n[0]===s[0]){let e=0;for(var r of n)s.includes(r)&&e++;t<e&&(t=e,i=a)}}}for(var{key:e,filename:t}of this.languages)if(e===i){if(this.active!==t)try{var o=E.resolve(this.dirname,t);this.update(await R.get({local:o,type:"json"})),this.active=t,this.language=i,window.dispatchEvent(new Event("localize"))}catch(e){oi.throw(new Error("Failed to load language pack"))}return}if(P.config.language)return this.setLanguage("")},N.update=function(){const l=e=>{oi.devmode&&setTimeout(()=>{oi.throw(new Error("Localizing Error: "+e))},100)};return function(e){this.setProperties(e.properties);var t=this.setElement,i=Object.entries(e.components);const a=i.length;for(let e=0;e<a;e++){var[n,s]=i[e];if("["===n[0]){if("[comment]"!==n){var r="."===n[1]?document.getElementsByClassName(n.slice(2,-1)):document.getElementsByName(n.slice(1,-1));const a=r.length;if(0!==a)for(let e=0;e<a;e++)t(r[e],s);else l(`key '${n}' is invalid`)}}else{var o=document.getElementById(n);null!==o?t(o,s):l(`key '${n}' is invalid`)}}}}(),N.setProperties=function(){const n=(e,t,i)=>{if((e[t]=i)instanceof Object)for(const a of Object.keys(i))n(e,t+"."+a,i[a])};return function(e){var t=this.properties;if(e instanceof Object)for(const i of Object.keys(e))n(t,i,e[i])}}(),N.setElement=function(){const a=(t,i)=>{if(oi.devmode){let e;e=t.id?`element[#${t.id}]`:t.name?`element[@${t.name}]`:"element[unknown]",setTimeout(()=>{oi.throw(new Error("Localizing Error: "+i.replace("@element",e)))},100)}};return function(e,t){var i;void 0!==t.content&&(e.textContent=t.content),void 0!==t.title&&(e instanceof s?e.setTitle(t.title):a(e,"typeof @element is not window-frame")),void 0!==t.label&&((i=e.previousElementSibling)instanceof HTMLElement?i.textContent=t.label:a(e,"there is no label of @element")),void 0!==t.tip&&e.setTooltip(t.tip),void 0!==t.placeholder&&(e instanceof $?e.setPlaceholder(t.placeholder):a(e,"typeof @element is not text-box")),void 0!==t.options&&(e instanceof pe?e.setItemNames(t.options):a(e,"typeof @element is not select-box"))}}(),N.createGetter=function(e){const t=e+".";return e=>this.get(t+e)},N.get=function(e){return this.properties[e]??""},{window:_("#imageClip"),screen:_("#imageClip-screen"),image:_("#imageClip-image").hide(),marquee:_("#imageClip-marquee").hide(),target:null,symbol:null,dragging:null,initialize:null,open:null,loadImage:null,updateImage:null,updateTitle:null,updateMarquee:null,shiftMarquee:null,scrollToMarquee:null,startDragging:null,dprchange:null,windowClosed:null,windowResize:null,screenKeydown:null,marqueePointerdown:null,marqueeDoubleclick:null,pointerup:null,pointermove:null,paramInput:null,confirm:null}),m=(ot.initialize=function(){window.on("dprchange",this.dprchange),this.window.on("closed",this.windowClosed),this.window.on("resize",this.windowResize),this.screen.on("keydown",this.screenKeydown),this.marquee.on("pointerdown",this.marqueePointerdown),this.marquee.on("doubleclick",this.marqueeDoubleclick),_("#imageClip-x, #imageClip-y, #imageClip-width, #imageClip-height").on("input",this.paramInput),_("#imageClip-confirm").on("click",this.confirm)},ot.open=async function(e){this.target=e,O.open("imageClip");var t=D("imageClip"),[e,i,a,n]=e.read();t("x",e),t("y",i),t("width",a),t("height",n),this.loadImage()},ot.loadImage=function(){this.window.setTitle("");var e=this.target.getAttribute("image"),e=_("#"+e).read();const t=R.getPath(e);if(t){const i=this.image,a=(i.src=R.route(t),this.symbol=Symbol());new Promise(e=>{const t=setInterval(()=>{0!==i.naturalWidth?(this.symbol===a&&(this.updateImage(),this.updateMarquee(),this.scrollToMarquee("center")),clearInterval(t),e(i)):i.complete&&(clearInterval(t),e(null))})}).then(e=>{this.symbol===a&&(this.symbol=null,this.updateTitle(t,e))})}else this.updateTitle()},ot.updateImage=function(){var e=this.screen,t=this.image.hide(),i=this.marquee.hide(),a=window.devicePixelRatio,n=t.naturalWidth,s=t.naturalHeight,r=Math.max(e.clientWidth*a-n>>1,0),e=Math.max(e.clientHeight*a-s>>1,0);t.style.left=r/a+"px",t.style.top=e/a+"px",t.style.width=n/a+"px",t.style.height=s/a+"px",t.show(),i.scaleX=1/a,i.scaleY=1/a,i.style.left=r/a+"px",i.style.top=e/a+"px",i.style.width=n/a+"px",i.style.height=s/a+"px",i.show()},ot.updateTitle=function(e,t){let i;i=e&&t?(e=E.basename(e),R.filterGUID(e)+` - ${t.naturalWidth}x`+t.naturalHeight):N.get("common.none"),this.window.setTitle(i)},ot.updateMarquee=function(){var e=g("imageClip"),t=e("x"),i=e("y"),a=e("width"),e=e("height");this.marquee.select(t,i,a,e)},ot.shiftMarquee=function(e,t){var i,a,n,s,r,o=this.image,l=o.naturalWidth,o=o.naturalHeight;l*o!=0&&(r=g("imageClip"),i=D("imageClip"),a=r("x"),n=r("y"),s=r("width"),r=r("height"),e=Math.clamp(a+e*s,0,l-s),l=Math.clamp(n+t*r,0,o-r),a!==e&&i("x",e),n!==l&&i("y",l),this.updateMarquee(),this.scrollToMarquee("active"))},ot.scrollToMarquee=function(e){var t=this.screen,i=this.marquee,a=window.devicePixelRatio,n=i.x,s=i.y,r=i.width,o=i.height,l=t.clientWidth*a,c=t.clientHeight*a;switch(e){case"active":var h=(s+o-c)/a,d=s/a;t.scrollLeft=Math.clamp(t.scrollLeft,(n+r-l)/a,n/a),t.scrollTop=Math.clamp(t.scrollTop,h,d);break;case"center":h=s+o/2-(c>>1);t.scrollLeft=Math.round((n+r/2-(l>>1))/a),t.scrollTop=Math.round(h/a)}},ot.startDragging=function(e){pt.open("cursor-grab"),(this.dragging=e).mode="scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)},ot.dprchange=function(e){this.image.hasClass("hidden")||(this.updateImage(),this.updateMarquee())}.bind(ot),ot.windowClosed=function(e){this.dragging&&this.pointerup(this.dragging),this.target=null,this.symbol=null,this.image.src="",this.image.hide(),this.marquee.hide()}.bind(ot),ot.windowResize=function(e){this.image.hasClass("hidden")||this.updateImage()}.bind(ot),ot.screenKeydown=function(e){if(!this.dragging&&!e.cmdOrCtrlKey&&!e.altKey)switch(e.code){case"ArrowLeft":e.preventDefault(),this.shiftMarquee(-1,0);break;case"ArrowUp":e.preventDefault(),this.shiftMarquee(0,-1);break;case"ArrowRight":e.preventDefault(),this.shiftMarquee(1,0);break;case"ArrowDown":e.preventDefault(),this.shiftMarquee(0,1)}}.bind(ot),ot.marqueePointerdown=function(e){if(!this.dragging)switch(e.button){case 0:if(e.altKey)return this.startDragging(e);var t=this.marquee,i=e.getRelativeCoords(t),a=g("imageClip"),n=D("imageClip"),s=i.x/t.scaleX,i=i.y/t.scaleY,t=Math.max(a("width"),1),a=Math.max(a("height"),1),s=Math.floor(s/t)*t,t=Math.floor(i/a)*a;n("x",s),n("y",t),this.updateMarquee();break;case 2:this.startDragging(e)}}.bind(ot),ot.marqueeDoubleclick=function(e){e.altKey||this.confirm(e)}.bind(ot),ot.pointerup=function(e){var t=this["dragging"];t.relate(e)&&("scroll"===t.mode&&pt.close("cursor-grab"),this.dragging=null,window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove))}.bind(ot),ot.pointermove=function(e){var t=this["dragging"];t.relate(e)&&"scroll"===t.mode&&(this.screen.scrollLeft=t.scrollLeft+t.clientX-e.clientX,this.screen.scrollTop=t.scrollTop+t.clientY-e.clientY)}.bind(ot),ot.paramInput=function(e){ot.updateMarquee()},ot.confirm=function(e){var t=g("imageClip");this.target.input([t("x"),t("y"),t("width"),t("height")]),O.close("imageClip")}.bind(ot),{target:null,dragging:null,paletteX:null,paletteY:null,pillarY:null,indexEnabled:null,initialize:null,open:null,drawPalette:null,drawPillar:null,drawViewer:null,setPaletteCursor:null,setPillarCursor:null,getRGBFromPalette:null,getRGBFromPillar:null,getRGBAFromHex:null,getHexFromRGBA:null,getCSSColorFromRGBA:null,writeRGBAToInputs:null,readRGBAFromInputs:null,loadIndexedColors:null,simplifyHexColor:null,windowClosed:null,palettePointerdown:null,pillarPointerdown:null,indexedColorInput:null,indexedColorPointerdown:null,pointerup:null,pointermove:null,hexBeforeinput:null,hexInput:null,rgbaInput:null,confirm:null}),lt=(m.initialize=function(){_("#color-hex").setMaxLength(8),_("#color-index").cancelable=!0,_("#color").on("closed",this.windowClosed),_("#color-palette-frame").on("pointerdown",this.palettePointerdown),_("#color-pillar-frame").on("pointerdown",this.pillarPointerdown),_("#color-index").on("input",this.indexedColorInput),_('[name="color-index"]').on("pointerdown",this.indexedColorPointerdown),_("#color-r, #color-g, #color-b, #color-a").on("input",this.rgbaInput),_("#color-hex").on("beforeinput",this.hexBeforeinput,{capture:!0}),_("#color-hex").on("input",this.hexInput),_("#color-confirm").on("click",this.confirm)},m.open=function(e,t=!1){this.target=e,this.indexEnabled=t,O.open("color");let i=e.read();switch(typeof i){case"string":break;case"number":_("#color-index").write(i),i=He.config.indexedColors[i].code}t=this.getRGBAFromHex(i);this.drawPalette(),this.drawPillar(t),this.setPillarCursor(0),this.writeRGBAToInputs(t),this.drawViewer(t),this.loadIndexedColors(),_("#color-hex").getFocus("all")},m.drawPalette=function(){var e,t=_("#color-palette-canvas");t.initialized||(t.initialized=!0,(e=(t=t.getContext("2d")).createLinearGradient(.5,0,255.5,0)).addColorStop(0,"#ff0000"),e.addColorStop(1/6,"#ffff00"),e.addColorStop(2/6,"#00ff00"),e.addColorStop(.5,"#00ffff"),e.addColorStop(4/6,"#0000ff"),e.addColorStop(5/6,"#ff00ff"),e.addColorStop(1,"#ff0000"),t.fillStyle=e,t.fillRect(0,0,256,194),t.fillStyle="#ff0000",t.fillRect(0,0,1,194),t.fillStyle="#ffff00",t.fillRect(43,0,1,194),t.fillStyle="#00ff00",t.fillRect(85,0,1,194),t.fillStyle="#00ffff",t.fillRect(128,0,1,194),t.fillStyle="#0000ff",t.fillRect(170,0,1,194),t.fillStyle="#ff00ff",t.fillRect(213,0,1,194),t.fillStyle="#ff0000",t.fillRect(255,0,1,194),(e=t.createLinearGradient(0,.5,0,96.5)).addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=e,t.fillRect(0,0,256,97),(e=t.createLinearGradient(0,97.5,0,193.5)).addColorStop(0,"rgba(0, 0, 0, 0)"),e.addColorStop(1,"rgba(0, 0, 0, 1)"),t.fillStyle=e,t.fillRect(0,97,256,97),this.setPaletteCursor(0,193))},m.drawPillar=function([e,t,i]){var a=_("#color-pillar-canvas").getContext("2d"),n=a.createLinearGradient(0,.5,0,255.5);n.addColorStop(0,`rgba(${e}, ${t}, ${i})`),n.addColorStop(1,"rgba(255, 255, 255)"),a.fillStyle=n,a.fillRect(0,0,20,256)},m.drawViewer=function([e,t,i,a]){_("#color-viewer").style.backgroundColor=`rgba(${e}, ${t}, ${i}, ${a/255})`},m.setPaletteCursor=function(e,t){var i=_("#color-palette-cursor");this.paletteX=e,this.paletteY=t,i.style.left=e-5+"px",i.style.top=t-5+"px"},m.setPillarCursor=function(e){var t=_("#color-pillar-cursor");this.pillarY=e,t.style.top=e+"px"},m.getRGBFromPalette=function(){var e=Math.round(this.paletteX),t=Math.round(this.paletteY),[e,t,i,,]=_("#color-palette-canvas").getContext("2d").getImageData(e,t,1,1).data;return[e,t,i]},m.getRGBFromPillar=function(){var e=Math.round(this.pillarY),[e,t,i,,]=_("#color-pillar-canvas").getContext("2d").getImageData(0,e,1,1).data;return[e,t,i]},m.getRGBAFromHex=function(e){return[parseInt(e.slice(0,2)||"00",16),parseInt(e.slice(2,4)||"00",16),parseInt(e.slice(4,6)||"00",16),parseInt(e.slice(6,8)||"ff",16)]},m.getHexFromRGBA=function(e){return""+e[0].toString(16).padStart(2,"0")+e[1].toString(16).padStart(2,"0")+e[2].toString(16).padStart(2,"0")+e[3].toString(16).padStart(2,"0")},m.getCSSColorFromRGBA=function(e){var[e,t,i,a]=e;return`rgba(${e}, ${t}, ${i}, ${a/255})`},m.writeRGBAToInputs=function([e,t,i,a]){var n=D("color"),s=this.getHexFromRGBA([e,t,i,a]);n("hex",this.simplifyHexColor(s)),n("r",e),n("g",t),n("b",i),n("a",a)},m.readRGBAFromInputs=function(){var e=g("color");return[e("r"),e("g"),e("b"),e("a")]},m.loadIndexedColors=function(){var t=document.getElementsByName("color-index"),i=He.config.indexedColors,a=i.length;for(let e=0;e<a;e++){var n=t[e],s=i[e],r=this.getRGBAFromHex(s.code),r=this.getCSSColorFromRGBA(r);n.style.backgroundColor=r,n.setTooltip(s.name)}},m.simplifyHexColor=function(){const t=/^([\da-f]{6})ff$/i;return function(e){return e.replace(t,"$1")}}(),m.windowClosed=function(e){_("#color-index").reset(),this.dragging&&this.pointerup(this.dragging)}.bind(m),m.palettePointerdown=function(e){switch(e.button){case 0:case-1:this.dragging||((this.dragging=e).mode="palette",window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove));var t=_("#color-palette-canvas"),t=e.getRelativeCoords(t),i=Math.clamp(t.x,0,255),t=Math.clamp(t.y,0,193),i=(this.setPaletteCursor(i,t),this.getRGBFromPalette()),t=_("#color-a").read(),t=[...i,t];this.drawPillar(i),this.setPillarCursor(0),this.writeRGBAToInputs(t),this.drawViewer(t),_("#color-index").reset()}}.bind(m),m.pillarPointerdown=function(e){switch(e.button){case 0:case-1:this.dragging||((this.dragging=e).mode="pillar",window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove));var t=_("#color-pillar-canvas"),t=e.getRelativeCoords(t),t=Math.clamp(t.y,0,255),t=(this.setPillarCursor(t),this.getRGBFromPillar()),i=_("#color-a").read(),t=[...t,i];this.writeRGBAToInputs(t),this.drawViewer(t),_("#color-index").reset()}}.bind(m),m.indexedColorInput=function(e){var t=e.value,t=He.config.indexedColors[t].code,t=this.getRGBAFromHex(t);this.drawPillar(t),this.setPillarCursor(0),this.writeRGBAToInputs(t),this.drawViewer(t),this.indexEnabled||e.target.reset()}.bind(m),m.indexedColorPointerdown=function(e){switch(e.button){case 2:{const i=e.target,a=i.dataValue,n=He.config.indexedColors[a];var t=N.createGetter("menuIndexedColor");ve.popup({x:e.clientX,y:e.clientY},[{label:t("saveColor"),click:()=>{var e=this.readRGBAFromInputs(),t=this.getHexFromRGBA(e),e=this.getCSSColorFromRGBA(e);n.code!==t&&(n.code=t,i.style.backgroundColor=e,Y.updateIndexedColor(a),R.planToSave(He.manifest.project.config))}},{label:t("rename"),click:()=>{ht.open(n.name,e=>{n.name=e,i.setTooltip(e),R.planToSave(He.manifest.project.config)})}}]);break}}}.bind(m),m.pointerup=function(e){var t=this["dragging"];t.relate(e)&&(this.dragging=null,window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove))}.bind(m),m.pointermove=function(e){var t=this["dragging"];if(t.relate(e))switch(t.mode){case"palette":return this.palettePointerdown(e);case"pillar":return this.pillarPointerdown(e)}}.bind(m),m.hexBeforeinput=function(e){"insertText"===e.inputType&&"string"==typeof e.data&&/[^0-9a-f]/i.test(e.data)&&(e.preventDefault(),e.stopPropagation())},m.hexInput=function(e){var t=g("color"),i=D("color"),t=t("hex"),a=t.replace(/[^0-9a-f]/gi,""),[n,s,r,o]=this.getRGBAFromHex(a);t!==a&&i("hex",a),i("r",n),i("g",s),i("b",r),i("a",o),this.drawPillar([n,s,r]),this.setPillarCursor(0),this.drawViewer([n,s,r,o]),_("#color-index").reset()}.bind(m),m.rgbaInput=function(e){var t=g("color"),i=D("color"),a=t("r"),n=t("g"),s=t("b"),t=t("a"),r=this.getHexFromRGBA([a,n,s,t]);i("hex",this.simplifyHexColor(r)),this.drawPillar([a,n,s]),this.setPillarCursor(0),this.drawViewer([a,n,s,t]),_("#color-index").reset()}.bind(m),m.confirm=function(e){var t=_("#color-index").read();this.indexEnabled&&null!==t?this.target.input(t):(t=this.readRGBAFromInputs(),t=this.getHexFromRGBA(t),this.target.input(t)),O.close("color")}.bind(m),{target:null,inserting:null,regexps:{local:/<local:(.*?)>/,global:/<global:([0-9a-f]{16})?>/},initialize:null,match:null,insert:null,edit:null,wrap:null,inputKeydown:null,inputKeyup:null,inputPointerdown:null,inputPointerup:null,color:null,font:null,italic:null,bold:null,fontSize:null,textPosition:null,textEffect:null}),ct=(lt.initialize=function(){_("#font-confirm").on("click",this.font.confirm),_("#fontSize-confirm").on("click",this.fontSize.confirm),_("#textPosition-confirm").on("click",this.textPosition.confirm),_("#textEffect-confirm").on("click",this.textEffect.confirm),_("#localVariable-confirm").on("click",this.localVariable.confirm);var e,t={"color-hex":!0,"command-searcher":!0};for(const i of _("text-box"))t[i.id]||(e=i["input"],e.on("keydown",this.inputKeydown),e.on("keyup",this.inputKeyup),e.on("pointerdown",this.inputPointerdown),e.on("pointerup",this.inputPointerup));for(const a of _("textarea"))a.on("keydown",this.inputKeydown),a.on("keyup",this.inputKeyup),a.on("pointerdown",this.inputPointerdown),a.on("pointerup",this.inputPointerup);this.textPosition.initialize(),this.textEffect.initialize()},lt.match=function(){var i=document.activeElement;if("number"==typeof i.selectionStart){var a=(this.target=i).value,n=i.selectionStart,s=i.selectionEnd;if(0!==s){var r=tt.regexps,o=a.lastIndexOf("<",s-1),l=a.indexOf(">",n)+1;let e,t;return 0<=o&&0<l&&o<l&&o<=n&&s<=l&&((s=(n=a.slice(o,l)).match(r.colorIndex))?(e="color",t={color:parseInt(s[1])}):(s=n.match(r.color))?(e="color",t={color:""+s[1]+s[2]+s[3]+(s[4]||"ff")}):(s=n.match(r.font))?(e="font",t={font:s[1]}):n.match(r.italic)?(e="italic",t=null):n.match(r.bold)?(e="bold",t=null):(s=n.match(r.fontSize))?(e="fontSize",t={size:parseInt(s[1])}):(s=n.match(r.textPosition))?(e="textPosition",t={axis:s[1],operation:s[2]||"set",value:parseInt(s[3])}):(s=n.match(r.textShadow))?(e="textEffect",t={type:"shadow",shadowOffsetX:parseInt(s[1]),shadowOffsetY:parseInt(s[2]),color:""+s[3]+s[4]+s[5]+(s[6]||"ff")}):(s=n.match(r.textStroke))?(e="textEffect",t={type:"stroke",strokeWidth:parseInt(s[1]),color:""+s[2]+s[3]+s[4]+(s[5]||"ff")}):(s=n.match(r.textOutline))?(e="textEffect",t={type:"outline",color:""+s[1]+s[2]+s[3]+(s[4]||"ff")}):"tag-variable"===i.parentNode.getAttribute("menu")&&((s=n.match(this.regexps.local))?(e="localVariable",t={key:s[1]}):(s=n.match(this.regexps.global))&&(e="globalVariable",t={key:s[1]??""}))),e&&(i.selectionStart=o,i.selectionEnd=l,t)?{tag:e,params:t}:void 0}}},lt.insert=function(e){var t=document.activeElement;"number"==typeof t.selectionStart&&(this.target=t,this.inserting=!0,this[e].open())},lt.edit=function(){var e,t=this.match();t&&({tag:t,params:e}=t,this.inserting=!1,this[t].open(e))},lt.wrap=function({prefix:t,suffix:i}){var a=this.target,n=a.selectionStart,s=a.selectionEnd;if(a.focus(),this.inserting&&n!==s){let e;i?(s=a.value.slice(n,s),e=t+s+i):(e=t,a.selectionEnd=a.selectionStart),a.parentNode.insert(e)}else a.parentNode.insert(t);a.selectionStart=n},lt.inputKeydown=function(e){e.altKey&&"KeyE"===e.code&&this.match()}.bind(lt),lt.inputKeyup=function(e){e.altKey&&"KeyE"===e.code&&this.edit()}.bind(lt),lt.inputPointerdown=function(e){2===e.button&&setTimeout(()=>this.match())}.bind(lt),lt.inputPointerup=function(h){2===h.button&&navigator.clipboard.readText().then(e=>{const t=h.target;var i,a,n,s,r,o,l,c;document.activeElement===t&&(a=t.selectionStart,n=t.selectionEnd,i=!!this.match(),a=a!==n,n=!!e,s=t.history.canUndo(),r=t.history.canRedo(),o=N.createGetter("menuTextBox"),c=[],"tag"!==(l=t.parentNode.getAttribute("menu")??"tag")&&"tag-variable"!==l||c.push({label:o("tag.color"),click:()=>{lt.insert("color")}},{label:o("tag.font"),click:()=>{lt.insert("font")}},{label:o("tag.italic"),click:()=>{lt.insert("italic")}},{label:o("tag.bold"),click:()=>{lt.insert("bold")}},{label:o("tag.size"),click:()=>{lt.insert("fontSize")}},{label:o("tag.position"),click:()=>{lt.insert("textPosition")}},{label:o("tag.effect"),click:()=>{lt.insert("textEffect")}}),"tag-variable"===l&&c.push({label:o("tag.localVariable"),click:()=>{lt.insert("localVariable")}},{label:o("tag.globalVariable"),click:()=>{lt.insert("globalVariable")}}),ve.popup({x:h.clientX,y:h.clientY},[{label:o("edit"),accelerator:"Alt+E",enabled:i,click:()=>{lt.edit()}},{label:o("tag"),submenu:c},{type:"separator"},{label:o("cut"),accelerator:p("X"),enabled:a,click:()=>{t.dispatchEvent(new InputEvent("beforeinput",{inputType:"deleteByCut",bubbles:!0})),document.execCommand("cut")}},{label:o("copy"),accelerator:p("C"),enabled:a,click:()=>{document.execCommand("copy")}},{label:o("paste"),accelerator:p("V"),enabled:n,click:()=>{t.dispatchEvent(new InputEvent("beforeinput",{inputType:"insertFromPaste",data:e,bubbles:!0})),document.execCommand("paste")}},{label:o("delete"),accelerator:"Delete",enabled:a,click:()=>{t.dispatchEvent(new InputEvent("beforeinput",{inputType:"deleteContentForward",bubbles:!0})),document.execCommand("delete")}},{label:o("undo"),accelerator:p("Z"),enabled:s,click:()=>{t.history.restore("undo")}},{label:o("redo"),accelerator:p("Y"),enabled:r,click:()=>{t.history.restore("redo")}}]))})}.bind(lt),lt.color={open:function({color:e="000000ff"}={}){this.proxy.color=e,m.open(this.proxy,!0)},proxy:{color:null,read:function(){return this.color},input:function(e){"string"==typeof e&&(e=m.simplifyHexColor(e)),lt.wrap({prefix:`<color:${e}>`,suffix:"</color>"})}}},lt.font={open:function({font:e="sans-serif"}={}){O.open("font"),_("#font-font").write(e),_("#font-font").getFocus("all")},confirm:function(e){var t=_("#font-font").read();if(!t)return _("#font-font").getFocus("all");lt.wrap({prefix:`<font:${t}>`,suffix:"</font>"}),O.close("font")}},lt.italic={open:function(){lt.wrap({prefix:"<italic>",suffix:"</italic>"})}},lt.bold={open:function(){lt.wrap({prefix:"<bold>",suffix:"</bold>"})}},lt.fontSize={open:function({size:e=12}={}){O.open("fontSize"),_("#fontSize-size").write(e),_("#fontSize-size").getFocus("all")},confirm:function(e){var t=_("#fontSize-size").read();lt.wrap({prefix:`<size:${t}>`,suffix:"</size>"}),O.close("fontSize")}},lt.textPosition={initialize:function(){_("#textPosition-axis").loadItems([{name:"X",value:"x"},{name:"Y",value:"y"}]),_("#textPosition-operation").loadItems([{name:"Set",value:"set"},{name:"Add",value:"add"}])},open:function({axis:e="x",operation:t="set",value:i=0}={}){O.open("textPosition"),_("#textPosition-axis").write(e),_("#textPosition-operation").write(t),_("#textPosition-value").write(i)},confirm:function(e){var t=_("#textPosition-axis").read(),i=_("#textPosition-operation").read(),a=_("#textPosition-value").read();let n;switch(i){case"set":n=""+a;break;case"add":n=i+","+a}lt.wrap({prefix:`<${t}:${n}>`,suffix:""}),O.close("textPosition")}},lt.textEffect={initialize:function(){_("#textEffect-type").loadItems([{name:"Shadow",value:"shadow"},{name:"Stroke",value:"stroke"},{name:"Outline",value:"outline"}]),_("#textEffect-type").enableHiddenMode().relate([{case:"shadow",targets:[_("#textEffect-shadowOffsetX"),_("#textEffect-shadowOffsetY"),_("#textEffect-color")]},{case:"stroke",targets:[_("#textEffect-strokeWidth"),_("#textEffect-color")]},{case:"outline",targets:[_("#textEffect-color")]}])},open:function({type:e="shadow",shadowOffsetX:t=1,shadowOffsetY:i=1,strokeWidth:a=1,color:n="000000ff"}={}){O.open("textEffect"),_("#textEffect-type").write(e),_("#textEffect-shadowOffsetX").write(t),_("#textEffect-shadowOffsetY").write(i),_("#textEffect-strokeWidth").write(a),_("#textEffect-color").write(n)},confirm:function(e){var t=_("#textEffect-type").read(),i=m.simplifyHexColor(_("#textEffect-color").read());let a;switch(t){case"shadow":var n=_("#textEffect-shadowOffsetX").read(),s=_("#textEffect-shadowOffsetY").read();a=n+`,${s},`+i;break;case"stroke":n=_("#textEffect-strokeWidth").read();a=n+","+i;break;case"outline":a=""+i}lt.wrap({prefix:`<${t}:${a}>`,suffix:`</${t}>`}),O.close("textEffect")}},lt.localVariable={open:function({key:e=""}={}){O.open("localVariable"),_("#localVariable-key").write(e),_("#localVariable-key").getFocus("all")},confirm:function(e){var t=_("#localVariable-key").read();if(!t)return _("#localVariable-key").getFocus("all");lt.wrap({prefix:`<local:${t}>`,suffix:""}),O.close("localVariable")}},lt.globalVariable={open:function({key:e=""}={}){this.proxy.key=e,d.open(this.proxy)},proxy:{key:"",filter:"",read:function(){return this.key},input:function(e){lt.wrap({prefix:`<global:${e}>`,suffix:""})}}},{initialize:null,getFactor:null,open:null,confirm:null}),ht=(ct.initialize=function(){_("#zoom-confirm").on("click",this.confirm)},ct.open=function(){O.open("zoom"),_("#zoom-factor").write(this.getFactor()),_("#zoom-factor").getFocus("all")},ct.getFactor=function(){return require("electron").webFrame.getZoomFactor()},ct.confirm=function(e){O.close("zoom"),require("electron").webFrame.setZoomFactor(P.config.zoom=_("#zoom-factor").read())},{callback:null,initialize:null,open:null,windowClosed:null,confirm:null}),dt=(ht.initialize=function(){_("#rename").on("closed",this.windowClosed),_("#rename-confirm").on("click",this.confirm)},ht.open=function(e,t){this.callback=t,O.open("rename"),_("#rename-name").write(e),_("#rename-name").getFocus("all")},ht.windowClosed=function(e){this.callback=null}.bind(ht),ht.confirm=function(e){this.callback(_("#rename-name").read()),O.close("rename")}.bind(ht),{callback:null,initialize:null,open:null,windowClosed:null,confirm:null}),ut=(dt.initialize=function(){_("#setKey").on("closed",this.windowClosed),_("#setKey-confirm").on("click",this.confirm)},dt.open=function(e,t){this.callback=t,O.open("setKey"),_("#setKey-key").write(e),_("#setKey-key").getFocus("all")},dt.windowClosed=function(e){this.callback=null}.bind(dt),dt.confirm=function(e){this.callback(_("#setKey-key").read()),O.close("setKey")}.bind(dt),{callback:null,initialize:null,open:null,windowClosed:null,confirm:null}),pt=(ut.initialize=function(){_("#setQuantity").on("closed",this.windowClosed),_("#setQuantity-confirm").on("click",this.confirm)},ut.open=function(e,t,i){this.callback=i,O.open("setQuantity"),_("#setQuantity-quantity").input.max=t,_("#setQuantity-quantity").write(e),_("#setQuantity-quantity").getFocus("all")},ut.windowClosed=function(e){this.callback=null}.bind(ut),ut.confirm=function(e){this.callback(_("#setQuantity-quantity").read()),O.close("setQuantity")}.bind(ut),{region:_("#cursor-region"),open:null,close:null});pt.open=function(e){this.region.addClass(e)},pt.close=function(e){this.region.removeClass(e)};class l extends Array{index;capacity;onSave;onRestore;constructor(e){super(),this.index=-1,this.capacity=e,this.onSave=null,this.onRestore=null}reset(){0!==this.length&&(this.length=0,this.index=-1)}save(e){var t=this.index+1;t<this.length&&(this.length=t),this.length<this.capacity?this.index++:this.shift(),this.push(e),this.onSave?.(e)}restore(e){var t="undo"===e?this.index:"redo"===e?this.index+1:null;if(0<=t&&t<this.length){var t=this[t],i=l.processors[t.type];if(i){switch(i(e,t),e){case"undo":this.index--;break;case"redo":this.index++}this.onRestore?.(t)}}}canUndo(){return null!==this&&0<=this.index}canRedo(){return null!==this&&this.index+1<this.length}static processors={}}class mt{target;type;history;editor;owner;constructor(e,t){this.editor=e??null,this.owner=t??null}initialize(e){this.target=null,this.type="object-attribute",this.group=e.getAttribute("group");var{editor:t,owner:i}=this;t&&i&&(this.history=new j.ParamHistory(t,i,e))}parse(s){if(s instanceof Object){let{key:e,value:t}=s;"string"==typeof t&&(t=I.parseMultiLineString(t));var r=v.getGroupAttribute(this.group,e);let i="",a="",n="";switch(r?.type){case"boolean":case"number":case"string":i=r.name,typeof t!==r.type&&(n="invalid");break;case"enum":{i=r.name;const s=M.getGroupString(r.enum,t);s?t=s.name:(t=I.parseUnlinkedId(t),n="invalid");break}case void 0:i=I.parseUnlinkedId(e),a="invalid"}return[{content:i,class:a},{content:t,class:n}]}return s}open(e={key:"",value:0}){O.open("object-attribute"),mt.target=this.target;var t=""===e.key;if(t)switch(e.key=v.getDefAttributeId(this.group),v.getGroupAttribute(this.group,e.key)?.type){case"boolean":e.value=!1;break;case"number":e.value=0;break;case"string":case"enum":e.value=""}var i=e.key,a=v.getGroupAttribute(this.group,i)?.type??typeof e.value,n="boolean"===a&&e.value,s="number"===a?e.value:0,r="string"===a?e.value:"",o="enum"===a?e.value:"",l=(_("#object-attribute-key").loadItems(v.getAttributeItems(this.group,"boolean|number|string")),!v.getGroupAttribute(this.group,i)),c=(l&&mt.typeBox.write(a),D("object-attribute"));if(c("key",i),c("boolean-value",n),c("number-value",s),c("string-value",r),o&&c("enum-value",o),t||l)return _("#object-attribute-key").getFocus();switch(a){case"boolean":return _("#object-attribute-boolean-value").getFocus();case"number":return _("#object-attribute-number-value").getFocus("all");case"string":return _("#object-attribute-string-value").getFocus("all");case"enum":return _("#object-attribute-enum-value").getFocus()}}save(){var e=g("object-attribute"),t=mt.typeBox.read(),i=e("key");if(""===i)return _("#object-attribute-key").getFocus();let a;switch(t){case"boolean":a=e("boolean-value");break;case"number":a=e("number-value");break;case"string":a=e("string-value");break;case"enum":if(""===(a=e("enum-value")))return _("#object-attribute-enum-value").getFocus()}return O.close("object-attribute"),{key:i,value:a}}static target=null;static initialize(){this.typeBox.loadItems([{name:"Boolean",value:"boolean"},{name:"Number",value:"number"},{name:"String",value:"string"},{name:"Enum",value:"enum"}]),this.typeBox.enableHiddenMode().relate([{case:"boolean",targets:[_("#object-attribute-boolean-value")]},{case:"number",targets:[_("#object-attribute-number-value")]},{case:"string",targets:[_("#object-attribute-string-value")]},{case:"enum",targets:[_("#object-attribute-enum-value")]}]),_("#object-attribute-boolean-value").loadItems([{name:"False",value:!1},{name:"True",value:!0}]),_("#object-attribute-key").on("write",this.keyWrite),_("#object-attribute-confirm").on("click",e=>{mt.target.save()})}static typeBox=new pe;static keyWrite(e){var t=mt.target.getAttribute("group"),t=v.getGroupAttribute(t,e.value);t&&(mt.typeBox.write(t.type),"enum"===t.type)&&((e=_("#object-attribute-enum-value")).loadItems(M.getStringItems(t.enum)),e.write(M.getDefStringId(t.enum)))}}class gt{target;type;history;editor;owner;constructor(e,t){this.editor=e??null,this.owner=t??null}initialize(t){this.target=null,this.type="condition";var{editor:e,owner:i}=this;e&&i&&(this.history=new j.ParamHistory(e,i,t)),window.on("localize",e=>{t.data&&t.update()})}parseVariable(e){switch(e.type){case"boolean":case"number":case"string":return I.parseGlobalVariable(e.key)}}parse(e){var t=this.parseVariable(e);switch(e.type){case"boolean":return t+` ${_t.parseBooleanOperation(e)} `+e.value.toString();case"number":return t+` ${_t.parseNumberOperation(e)} `+e.value.toString();case"string":return t+` ${_t.parseStringOperation(e)} `+`"${I.parseMultiLineString(e.value)}"`;case"absent":return N.get("condition.absent")}}update(e){var t=this.editor?.target;if(t?.conditions===e.read()){const e=t.element?.parentNode;e instanceof Ee&&e.updateConditionIcon(t)}}open(e={type:"boolean",key:"",operation:"equal",value:!0}){O.open("condition"),gt.target=this.target;var t=D("condition");let i="equal",a=!0,n="equal",s=0,r="equal",o="";switch(e.type){case"boolean":i=e.operation,a=e.value;break;case"number":n=e.operation,s=e.value;break;case"string":r=e.operation,o=e.value}t("type",e.type),t("key",e.key??""),t("boolean-operation",i),t("boolean-value",a),t("number-operation",n),t("number-value",s),t("string-operation",r),t("string-value",o),_("#condition-type").getFocus()}save(){var e=g("condition"),t=e("type");let i;switch(t){case"boolean":var a=e("boolean-operation"),n=e("key");if(""===n)return _("#condition-key").getFocus();var s=e("boolean-value");i={type:t,key:n,operation:a,value:s};break;case"number":n=e("number-operation"),a=e("key");if(""===a)return _("#condition-key").getFocus();s=e("number-value");i={type:t,key:a,operation:n,value:s};break;case"string":a=e("string-operation"),n=e("key");if(""===n)return _("#condition-key").getFocus();s=e("string-value");i={type:t,key:n,operation:a,value:s};break;case"absent":i={type:t}}return O.close("condition"),i}static target=null;static initialize(){_("#condition-type").loadItems([{name:"Boolean",value:"boolean"},{name:"Number",value:"number"},{name:"String",value:"string"},{name:"Absent",value:"absent"}]),_("#condition-boolean-operation").loadItems([{name:"==",value:"equal"},{name:"!=",value:"unequal"}]),_("#condition-boolean-value").loadItems([{name:"False",value:!1},{name:"True",value:!0}]),_("#condition-number-operation").loadItems([{name:"==",value:"equal"},{name:"!=",value:"unequal"},{name:">=",value:"greater-or-equal"},{name:"<=",value:"less-or-equal"},{name:">",value:"greater"},{name:"<",value:"less"}]),_("#condition-string-operation").loadItems([{name:"==",value:"equal"},{name:"!=",value:"unequal"}]),_("#condition-type").enableHiddenMode().relate([{case:"boolean",targets:[_("#condition-key"),_("#condition-boolean-operation"),_("#condition-boolean-value")]},{case:"number",targets:[_("#condition-key"),_("#condition-number-operation"),_("#condition-number-value")]},{case:"string",targets:[_("#condition-key"),_("#condition-string-operation"),_("#condition-string-value")]}]),_("#condition-type").on("write",e=>{var t=e.value;switch(t){case"boolean":case"number":case"string":_("#condition-key").filter=t}}),_("#condition-confirm").on("click",e=>{gt.target.save()})}}class ft{target;type;filter;editor;owner;constructor(e,t){this.editor=e??null,this.owner=t??null}initialize(t){this.filter=t.getAttribute("filter"),this.type=this.filter+".event",this.editCallback=()=>t.save(),this.insertCallback=()=>{t.inserting?(t.save(),t.inserting=!1):(t.start--,t.save(),t.select(t.start+1))};var{editor:e,owner:i}=this;e&&i&&(this.history=new j.ParamHistory(e,i,t),this.history.save=ft.historySave),window.on("localize",e=>{t.data&&t.update()})}parse(e){var t,e=e["type"];return ft.guidRegExp.test(e)?(I.invalid=!1,t=this.filter+"-event",{content:I.parseGroupEnumString(t,e),class:I.invalid?"invalid":""}):N.get("eventTypes."+e)}update(e){var t=e.elements,i=e.read(),a=i.length;if(0!==a){var n={};for(let e=a-1;0<=e;e--){var s=i[e]["type"];n[s]?t[e].addClass("weak"):n[s]=!0}}a=this.editor?.target;if(a?.events===e.read()){const e=a.element?.parentNode;e instanceof Ee&&e.updateEventIcon(a)}}open(e){var t=this.filter;let i=this.editCallback;return void 0===e&&(e=j.fileEvent.create(t),i=this.insertCallback,Nt.inserting=!0),Nt.open(t,e,i)}save(){return Nt.save()}static guidRegExp=/^[0-9a-f]{16}$/;static historySave(e){j.ParamHistory.prototype.save.call(this,e),"inspector-param-replace"===e.type&&delete e.oldItem.commands.symbol}}class vt{target;type;filter;script;editor;owner;constructor(e,t){this.editor=e??null,this.owner=t??null}initialize(e){this.target=null,this.script=null,this.filter="script",this.type="script",e.toggleable=!0;var{editor:t,owner:i}=this;t&&i&&(this.history=new j.ParamHistory(t,i,e)),e.on("pointerdown",vt.listPointerdown)}parse(e){var t=document.createElement("box"),i=(t.textContent="",t.addClass("script-edit-button"),I.invalid=!1,I.parseFileName(e.id));return[{content:i,class:I.invalid?"invalid":e.enabled?"":"weak"},t]}update(e){var t=this.editor?.target;if(t?.scripts===e.read()){const e=t.element?.parentNode;e instanceof Ee&&e.updateScriptIcon(t)}}open(e=w.createData()){this.script=e,zt.open(this,!1)}save(){return this.script}read(){return this.script.id}input(e){this.script.id=e,this.target.save()}static listPointerdown=function(){let t=null;const i={once:!0},a=e=>{t.contains(e.target)&&(e=(e=t.parentNode).dataItem??e.item,e=R.getPath(e.id))&&T.openScript(e),t=null};return function(e){0===e.button&&"BOX"===e.target.tagName&&(t=e.target,window.on("pointerup",a,i))}}()}const bt={list:_("#presetObject-list"),searcher:_("#presetObject-searcher"),target:null,nodes:null,initialize:null,open:null,buildNodes:null,getDefaultPresetId:null,windowClosed:null,searcherKeydown:null,searcherInput:null,listOpen:null,confirm:null},yt=(bt.list.createIcon=null,bt.initialize=function(){this.list.bind(()=>this.nodes),this.list.createIcon=A.list.createIcon,this.searcher.addCloseButton(),this.list.on("open",this.listOpen),this.searcher.on("keydown",this.searcherKeydown),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),_("#presetObject").on("closed",this.windowClosed),_("#presetObject-confirm").on("click",this.confirm)},bt.open=function(e){this.target=e,O.open("presetObject");var{searcher:t,list:i}=this,a=A.objects,n=e.read()||(A.target?.presetId??""),a=a?bt.buildNodes(a,e.filter):Array.empty,e=(this.nodes=a,this.list.update(),t.getFocus(),i.getItemByProperties({presetId:n}));e?(i.select(e),i.expandToSelection(),i.scrollToSelection("middle")):0!==a.length&&bt.list.select(a[0])},bt.buildNodes=function(){const n=(e,t)=>{var i=[];for(const a of e)"folder"===a.class?i.push({class:a.class,name:a.name,expanded:a.expanded,children:n(a.children,t)}):"any"!==t&&a.class!==t||i.push({class:a.class,name:a.name,presetId:a.presetId,teamId:a.teamId??"",color:a.color??"",red:a.red??0,green:a.green??0,blue:a.blue??0,image:a.image??""});return i};return function(e,t){return n(e,t)}}(),bt.getDefaultPresetId=function(e="any"){return!A.target||"any"!==e&&A.target.class!==e?"":A.target.presetId},bt.windowClosed=function(e){bt.target=null,bt.nodes=null,bt.searcher.write(""),bt.list.clear()},bt.searcherKeydown=function(e){switch(e.code){case"ArrowUp":case"ArrowDown":e.preventDefault(),bt.list.selectRelative(e.code.slice(5).toLowerCase());break;case"PageUp":bt.list.pageUp(!0);break;case"PageDown":bt.list.pageDown(!0)}},bt.searcherInput=function(e){if("insertCompositionText"!==e.inputType){var e=this.input.value,t=bt.list,i=(t.searchNodes(e),t.elements);for(let e=0;e<i.count;e++){var a=i[e]["item"];if("folder"!==a.class){t.select(a);break}}}},bt.listOpen=function(e){bt.confirm()},bt.confirm=function(e){var t=this.list.read()?.presetId;if(!t)return this.list.getFocus();this.target.input(t),O.close("presetObject")}.bind(bt),{ui:_("#presetElement-uiId"),list:_("#presetElement-list"),target:null,nodes:null,initialize:null,open:null,buildNodes:null,getDefaultPresetId:null,windowClosed:null,uiIdWrite:null,listOpen:null,confirm:null}),wt=(yt.list.createIcon=null,yt.initialize=function(){this.list.bind(()=>this.nodes),this.list.createIcon=Y.list.createIcon,this.ui.on("write",this.uiIdWrite),this.list.on("open",this.listOpen),_("#presetElement").on("closed",this.windowClosed),_("#presetElement-confirm").on("click",this.confirm)},yt.open=function(e){this.target=e,O.open("presetElement");var{ui:t,list:i}=this,e=e.read()||(Y.target?.presetId??""),a=He.uiLinks[e]??Y.meta?.guid??"",a=(t.write(a),t.getFocus(),i.getItemByProperties({presetId:e}));a&&(i.select(a),i.expandToSelection(),i.scrollToSelection("middle"))},yt.buildNodes=function(){const s=t=>{var i=t.length,a=new Array(i);for(let e=0;e<i;e++){var n=t[e];a[e]={class:n.class,name:n.name,expanded:n.expanded,presetId:n.presetId,children:s(n.children)}}return a};return function(e){return s(e)}}(),yt.getDefaultPresetId=function(){return Y.target?.presetId??""},yt.windowClosed=function(e){yt.target=null,yt.nodes=null,yt.list.clear()},yt.uiIdWrite=function(e){e=He.ui[e.value],e=e?yt.buildNodes(e.nodes):Array.empty;yt.nodes=e,yt.list.update(),0!==e.length?(yt.list.select(e[0]),yt.list.scrollTop=0):yt.list.unselect()},yt.listOpen=function(e){yt.confirm()},yt.confirm=function(e){var t;return this.ui.read()?(t=this.list.read()?.presetId)?(this.target.input(t),void O.close("presetElement")):this.list.getFocus():this.ui.getFocus()}.bind(yt),{list:_("#arrayList-list"),target:null,changed:!1,interface:null,initialize:null,open:null,windowClose:null,windowClosed:null,listChange:null,confirm:null}),b=(wt.initialize=function(){this.list.bind(this.interface),_("#arrayList").on("close",this.windowClose),_("#arrayList").on("closed",this.windowClosed),this.list.on("change",this.listChange),_("#arrayList-confirm").on("click",this.confirm)},wt.open=function(e){var t=(this.target=e).previousSibling.textContent;_("#arrayList").setTitle(t),O.open("arrayList"),this.list.write(e.read().slice()),this.list.getFocus()},wt.windowClose=function(e){this.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedData")},[{label:e("yes"),click:()=>{this.changed=!1,O.close("arrayList")}},{label:e("no")}]))}.bind(wt),wt.windowClosed=function(e){wt.target=null,wt.list.clear()},wt.listChange=function(e){wt.changed=!0},wt.confirm=function(e){this.changed=!1,this.target.input(this.list.read()),O.close("arrayList")}.bind(wt),wt.interface={parsers:{number:e=>e.toString(),string:e=>I.parseMultiLineString(e)},defaults:{number:0,string:""},windows:{number:"arrayList-number",string:"arrayList-string"},inputs:{number:_("#arrayList-number-value"),string:_("#arrayList-string-value")},initialize:function(e){_("#arrayList-number-confirm").on("click",()=>e.save()),_("#arrayList-string-confirm").on("click",()=>e.save())},parse:function(e,t,i){var a=wt.target["filter"],n=document.createElement("text"),i=(n.addClass("array-index"),n.textContent=Number.padZero(i,t.length," ")+":",document.createElement("text"));return i.addClass("array-value"),i.textContent=this.parsers[a](e),[n,i]},open:function(e){var t=wt.target["filter"],t=(e=e??this.defaults[t],O.open(this.windows[t]),this.inputs[t]);t.write(e),t.getFocus("all")},save:function(){var e=wt.target["filter"],t=this.inputs[e].read();return O.close(this.windows[e]),t}},{target:_("#title"),tabBar:_("#title-tabBar"),theme:null,maximized:!1,fullscreen:!1,initialize:null,newProject:null,openProject:null,closeProject:null,deployment:null,addRecentTab:null,getClosedTabMeta:null,openTab:null,reopenClosedTab:null,askWhetherToSave:null,updateTitleName:null,updateBodyClass:null,updateAppRegion:null,switchTheme:null,dispatchThemechangeEvent:null,playGame:null,saveToConfig:null,loadFromConfig:null,saveToProject:null,loadFromProject:null,windowClose:null,windowMaximize:null,windowUnmaximize:null,windowEnterFullScreen:null,windowLeaveFullScreen:null,windowDrop:null,windowDirchange:null,windowLocalize:null,pointerenter:null,pointermove:null,tabBarPointerdown:null,tabBarSelect:null,tabBarClosed:null,tabBarPopup:null,playClick:null,minimizeClick:null,maximizeClick:null,closeClick:null}),xt=(b.initialize=function(){var e=require("electron")["ipcRenderer"];e.invoke("update-max-min-icon").then(e=>{switch(e){case"maximize":this.windowMaximize(event);break;case"unmaximize":this.windowUnmaximize(event);break;case"enter-full-screen":this.windowEnterFullScreen(event)}}),this.target.element=this.target.appendChild(document.createElement("div")),this.pointerenter(),this.tabBar.parseIcon=function(e){switch(e){case"scene":return"";case"ui":return"";case"animation":return"";case"particle":return""}},this.tabBar.parseName=function(e){return R.parseMetaName(e)},window.on("drop",this.windowDrop),window.on("dirchange",this.windowDirchange),window.on("localize",this.windowLocalize),_("#title").on("pointerenter",this.pointerenter),_("#title-tabBar").on("pointerdown",this.tabBarPointerdown),_("#title-tabBar").on("select",this.tabBarSelect),_("#title-tabBar").on("closed",this.tabBarClosed),_("#title-tabBar").on("popup",this.tabBarPopup),_("#title-play").on("click",this.playClick),_("#title-minimize").on("click",this.minimizeClick),_("#title-maximize").on("click",this.maximizeClick),_("#title-close").on("click",this.closeClick),e.on("close",this.windowClose),e.on("maximize",this.windowMaximize),e.on("unmaximize",this.windowUnmaximize),e.on("enter-full-screen",this.windowEnterFullScreen),e.on("leave-full-screen",this.windowLeaveFullScreen),xt.initialize(),kt.initialize()},b.newProject=function(){this.askWhetherToSave(()=>{xt.open()})},b.openProject=function(){this.askWhetherToSave(()=>{var e=P.config.dialogs,e=E.normalize(e.open);R.showOpenDialog({defaultPath:e,filters:[{name:"Project",extensions:["yamirpg"]}]}).then(({filePaths:e})=>{1===e.length&&P.open(e[0])})})},b.closeProject=function(){this.askWhetherToSave(()=>{P.close().then(()=>{x.manager.switch("home")})})},b.deployment=function(){this.askWhetherToSave(()=>{kt.open()})},b.addRecentTab=function(e){var t=P.project.recentTabs;if(t.remove(e))t.unshift(e);else for(t.unshift(e);10<t.length;)t.pop()},b.getClosedTabMeta=function(){var e=P.project["recentTabs"];e:for(const t of e){for(const i of this.tabBar.data)if(i.meta.guid===t)continue e;return He.manifest.guidMap[t]}},b.openTab=function(e){var t,i,a=this["tabBar"],{meta:e,type:n}=e;let s=a.find(e);void 0===s&&(t=a.parseIcon(n),i=a.parseName(e),a.insert(s={icon:t,name:i,meta:e,type:n})),a.select(s)},b.reopenClosedTab=function(e){(e=e??this.getClosedTabMeta())&&(e=h.getFile(e.path))instanceof q&&this.openTab(e)},b.askWhetherToSave=function(e){var t;0<He.manifest?.changes.length?(t=N.createGetter("confirmation"),O.confirm({message:t("closeUnsavedProject")},[{label:t("yes"),click:()=>{R.save(),e()}},{label:t("no"),click:()=>{e()}},{label:t("cancel")}])):e()},b.updateTitleName=function(){const t=_("title")[0];return function(){let e="Yami RPG Editor";"open"===P.state&&(e=He.config.window.title+" - "+e),t.textContent=e}}(),b.updateBodyClass=function(){this.maximized||this.fullscreen?(document.body.addClass("maximized"),document.body.removeClass("border")):(document.body.removeClass("maximized"),document.body.addClass("border"))},b.updateAppRegion=function(){const e=this["target"];e.element.show(),setTimeout(()=>e.element.hide())},b.switchTheme=function(e){switch(e){case"light":document.documentElement.removeClass("dark")&&this.dispatchThemechangeEvent("light");break;case"dark":document.documentElement.addClass("dark")&&this.dispatchThemechangeEvent("dark")}},b.dispatchThemechangeEvent=function(){const t=new Event("themechange");return function(e){this.theme=e,t.value=e,window.dispatchEvent(t)}}(),b.playGame=async function(){const t=_("#title-play");var e;"open"!==P.state||t.hasClass("selected")||(t.addClass("selected"),e=document["activeElement"],e=(e.blur(),e.focus(),Je.player.stop(),await R.save(!1),require("electron"))["ipcRenderer"],e.send("create-player-window",R.root),e.once("player-window-closed",e=>{t.removeClass("selected")}))},b.saveToConfig=function(e){e.theme=this.theme},b.loadFromConfig=function(e){e=e.theme;switch(e){case"light":document.documentElement.removeClass("dark");break;case"dark":document.documentElement.addClass("dark")}this.dispatchThemechangeEvent(e)},b.saveToProject=function(e){var t=this.tabBar.data,i=t.length,a=new Array(i);for(let e=0;e<i;e++)a[e]=t[e].meta.guid;e.openTabs=a;var n=this.tabBar.read();e.activeTab=n?.meta.guid??""},b.loadFromProject=function(e){var{openTabs:e,activeTab:t}=e,i={icon:"",name:N.get("common.directory"),meta:{guid:""},type:"directory"},a=[i],n=this.tabBar,s=(n.dirItem=i,He.manifest.guidMap);for(const h of e){var r=s[h];if(r){let e;switch(E.extname(r.path)){case".scene":e="scene";break;case".ui":e="ui";break;case".anim":e="animation";break;case".particle":e="particle";break;default:continue}var o=n.parseIcon(e),l=n.parseName(r);a.push({icon:o,name:l,meta:r,type:e})}}if(n.data=a,n.update(),t){i=n.childNodes;for(const d of i){var c=d.item;if(c.meta.guid===t)return n.select(c)}if(0!==i.length)return e=i[0].item,n.select(e)}x.manager.switch("directory")},b.windowClose=function(e){0===O.frames.length&&b.askWhetherToSave(()=>{P.quit()})},b.windowMaximize=function(e){this.maximized=!0,this.updateBodyClass()}.bind(b),b.windowUnmaximize=function(e){this.maximized=!1,this.updateBodyClass()}.bind(b),b.windowEnterFullScreen=function(e){this.fullscreen=!0,this.updateBodyClass()}.bind(b),b.windowLeaveFullScreen=function(e){this.fullscreen=!1,this.updateBodyClass()}.bind(b),b.windowDrop=function(e){if(0===O.frames.length){e=e.dataTransfer["files"];for(const t of e)/\.yamirpg$/i.test(t.name)&&this.askWhetherToSave(()=>{P.open(t.path)})}}.bind(b),b.windowDirchange=function(e){var t,i=b["tabBar"];for(const a of i.data)a!==i.dirItem&&(t=i.parseName(a.meta),a.name!==t&&(a.name=t,a.tab))&&(a.tab.text.textContent=i.parseTabName(a))},b.windowLocalize=function(e){var t=b.tabBar.dirItem?.tab?.text;t instanceof HTMLElement&&(t.textContent=N.get("common.directory"))},b.pointerenter=function(e){var t=this["target"];t.active||(t.active=!0,t.style.WebkitAppRegion="drag",this.updateAppRegion(),window.on("pointermove",this.pointermove))}.bind(b),b.pointermove=function(t){var i=this["target"];if(i.active){let e=t.target;for(;e;){if(e===i)return;e=e.parentNode}e||(i.active=!1,i.style.WebkitAppRegion="no-drag",this.updateAppRegion(),window.off("pointermove",this.pointermove))}}.bind(b),b.tabBarPointerdown=function(e){switch(this.read()?.type){case"scene":x.readyToFocus(A.screen);break;case"ui":x.readyToFocus(Y.screen);break;case"animation":x.readyToFocus(Ke.screen);break;case"particle":x.readyToFocus(S.screen)}},b.tabBarSelect=function(e){x.resizing&&x.pointerup();var t=e.value;switch(t.type){case"directory":x.manager.switch("directory");break;case"scene":x.manager.switch("scene"),A.open(t),A.screen.focus();break;case"ui":x.manager.switch("ui"),Y.open(t),Y.screen.focus();break;case"animation":x.manager.switch("animation"),Ke.open(t),Ke.screen.focus();break;case"particle":x.manager.switch("particle"),S.open(t),S.screen.focus()}},b.tabBarClosed=function(e){var{closedItems:e,lastValue:t}=e;for(const i of e){switch(i.type){case"scene":A.destroy(i);break;case"ui":Y.destroy(i);break;case"animation":Ke.destroy(i);break;case"particle":S.destroy(i)}i.meta.guid&&b.addRecentTab(i.meta.guid)}e.includes(t)&&((t=(e=this.data)[Math.min(this.selectionIndex,e.length-1)])instanceof Object?this.select(t):x.manager.switch("directory"))},b.tabBarPopup=function(e){const t=e.value;var i,a,n;t&&(a=(i=this.data)[i.length-1],n=N.createGetter("menuTab"),ve.popup({x:e.clientX,y:e.clientY},[{label:n("close"),accelerator:p("W"),enabled:"directory"!==t.type,click:()=>{this.close(t)}},{label:n("closeOtherTabs"),enabled:1<i.length,click:()=>{this.closeOtherTabs(t)}},{label:n("closeTabsToTheRight"),enabled:t!==a,click:()=>{this.closeTabsToTheRight(t)}}]))},b.playClick=function(e){b.playGame()},b.minimizeClick=function(e){require("electron").ipcRenderer.send("minimize-window")},b.maximizeClick=function(e){require("electron").ipcRenderer.send("maximize-window")},b.closeClick=function(e){require("electron").ipcRenderer.send("close-window")},{state:"passed",timer:null,initialize:null,open:null,check:null,readFileList:null,copyFilesTo:null,writeData:null,getNewFolder:null,folderBeforeinput:null,folderInput:null,locationInput:null,chooseClick:null,confirm:null}),kt=(xt.initialize=function(){_("#newProject-folder").on("beforeinput",this.folderBeforeinput,{capture:!0}),_("#newProject-folder").on("input",this.folderInput),_("#newProject-location").on("input",this.locationInput),_("#newProject-choose").on("click",this.chooseClick),_("#newProject-confirm").on("click",this.confirm)},xt.open=function(){O.open("newProject");var e=D("newProject"),t=P.config.dialogs,t=E.normalize(t.new);e("folder",this.getNewFolder(t)),e("location",t),_("#newProject-folder").getFocus("all"),this.check()},xt.check=function(){var e=_("#newProject-folder").read(),t=_("#newProject-location").read();e?F.existsSync(E.resolve(t,e))?"existing"!==this.state&&(this.state="existing",_("#newProject-warning").textContent="项目已存在",_("#newProject-confirm").disable()):"passed"!==this.state&&(this.state="passed",_("#newProject-warning").textContent="",_("#newProject-confirm").enable()):"unnamed"!==this.state&&(this.state="unnamed",_("#newProject-warning").textContent="名称为空",_("#newProject-confirm").disable())},xt.readFileList=function(){const e=E.resolve(__dirname,"Templates/project"),t={withFileTypes:!0},r=(n,s)=>z.readdir(e+"/"+n,t).then(async e=>{n&&(n+="/");var t=[];for(const a of e){var i=""+n+a.name;a.isDirectory()?(s.push({folder:!0,path:i}),t.push(r(i,s))):s.push({path:i})}return 0!==t.length&&await Promise.all(t),s});return function(){return r("",[])}}(),xt.copyFilesTo=function(e){O.open("copyProgress");const d=_("#copyProgress-bar"),u=_("#copyProgress-info");return d.style.width="0",u.textContent="",this.readFileList().then(t=>{let i=0,a=0,n="";var s=E.resolve(__dirname,"Templates/project")+"/",r=e+"/",o=[],l=t.length;for(let e=0;e<l;e++){var c=t[e];const h=c.path;!0!==c.folder?(o.push(z.copyFile(s+h,r+h).then(()=>{a++,n=h})),i++):F.mkdirSync(r+h)}return this.timer=new f({duration:1/0,update:e=>{var t=Math.round(a/i*100);d.style.width=t+"%",u.textContent=n}}).add(),Promise.all(o)})},xt.writeData=function(e){const t=e+"/data/config.json";return z.readFile(t,"utf8").then(e=>{e=JSON.parse(e),e.gameId=X.generate64bit(),e=JSON.stringify(e,null,2);return z.writeFile(t,e)})},xt.getNewFolder=function(t){for(let e=1;;e++){1;{var i="Project"+e;if(!F.existsSync(E.resolve(t,i)))return i}}},xt.folderBeforeinput=function(e){"insertText"===e.inputType&&"string"==typeof e.data&&/[\\/:*?"<>|"]/.test(e.data)&&(e.preventDefault(),e.stopPropagation())},xt.folderInput=function(e){var t=this.read(),i=t.replace(/[\\/:*?"<>|"]/g,"");t!==i&&this.write(i),xt.check()},xt.locationInput=function(e){xt.check()},xt.chooseClick=function(e){const t=_("#newProject-location");R.showOpenDialog({defaultPath:t.read(),properties:["openDirectory"]}).then(({filePaths:e})=>{1===e.length&&(t.write(e[0]),xt.check())})},xt.confirm=function(e){const t=_("#newProject-location").read();var i=_("#newProject-folder").read();const a=E.resolve(t,i);O.close("newProject"),P.close().then(()=>z.mkdir(a,{recursive:!0})).then(e=>xt.copyFilesTo(a)).then(e=>xt.writeData(a)).finally(()=>{O.close("copyProgress"),xt.timer&&(xt.timer.remove(),xt.timer=null)}).then(()=>{P.open(a+"/game.yamirpg"),P.config.dialogs.new=E.slash(E.resolve(t))}).catch(e=>{oi.throw(e),O.confirm({message:"Failed to create project",close:()=>{x.manager.switch("home")}},[{label:"Confirm"}])})},{state:"passed",timer:null,initialize:null,open:null,check:null,readShellList:null,readFileList:null,copyFilesTo:null,folderBeforeinput:null,folderInput:null,locationInput:null,chooseClick:null,confirm:null}),Tt=(kt.initialize=function(){_("#deployment-platform").loadItems([{name:"Windows - Electron",value:"windows-electron"},{name:"Windows - NWJS",value:"windows-nwjs"},{name:"Web / Android / iOS",value:"web"}]),_("#deployment-folder").on("beforeinput",this.folderBeforeinput,{capture:!0}),_("#deployment-folder").on("input",this.folderInput),_("#deployment-location").on("input",this.locationInput),_("#deployment-choose").on("click",this.chooseClick),_("#deployment-confirm").on("click",this.confirm)},kt.open=function(){O.open("deployment");var e=D("deployment"),t=P.config.dialogs,t=E.normalize(t.deploy);e("platform","windows-electron"),e("folder","Output"),e("location",t),_("#deployment-platform").getFocus(),this.check()},kt.check=function(){var e=_("#deployment-folder").read(),t=_("#deployment-location").read();e?F.existsSync(E.resolve(t,e))?"existing"!==this.state&&(this.state="existing",_("#deployment-warning").textContent="项目已存在",_("#deployment-confirm").disable()):"passed"!==this.state&&(this.state="passed",_("#deployment-warning").textContent="",_("#deployment-confirm").enable()):"unnamed"!==this.state&&(this.state="unnamed",_("#deployment-warning").textContent="名称为空",_("#deployment-confirm").disable())},kt.readShellList=function(){let o;const e={withFileTypes:!0},l=(s,r)=>z.readdir(o+s,e).then(async e=>{s&&(s+="/");var t=[];for(const n of e){var i=""+s+n.name,a=o+i;n.isDirectory()?(r.push({folder:!0,srcPath:a,newPath:i}),t.push(l(i,r))):r.push({srcPath:a,newPath:i})}return 0!==t.length&&await Promise.all(t),r});return function(e){return o=E.resolve(__dirname,e)+"/",l("",[])}}(),kt.readFileList=async function(e){let t;switch(e){case"windows-electron":t=await this.readShellList("Templates/electron-win");break;case"windows-nwjs":var i=He.config["window"];(t=await this.readShellList("Templates/nwjs-win")).push({path:"package.json",data:{name:i.title,main:"index.html",window:{icon:"Icon/icon.png",title:i.title,width:i.width,height:i.height,position:"center",fullscreen:"fullscreen"===i.display}}});break;case"web":t=[]}t.push({folder:!0,path:"Assets"},{folder:!0,path:"Icon"},{folder:!0,path:"Data"},{folder:!0,path:"Script"});var a,n,s={deployed:!0,actors:He.actors,skills:{},items:{},equipments:{},triggers:He.triggers,states:He.states,events:He.events,tilesets:He.tilesets,ui:He.ui,animations:He.animations,particles:He.particles,scenes:[],images:[],audio:[],videos:[],fonts:[],script:[],others:[]},r=/\.[0-9a-f]{16}\.\S+$/;for(const I of["skills","items","equipments"]){var o,l,c=He[I],h=s[I];for({guid:o,path:l}of He.manifest[I]){var d=c[o];void 0!==d&&(h[o]={...d,filename:E.basename(l).replace(r,"")})}}t.push({data:s,path:"manifest.json"},{data:He.config,path:"Data/config.json"},{data:He.easings,path:"Data/easings.json"},{data:He.teams,path:"Data/teams.json"},{data:He.autotiles,path:"Data/autotiles.json"},{data:He.variables,path:"Data/variables.json"},{data:He.attribute,path:"Data/attribute.json"},{data:He.enumeration,path:"Data/enumeration.json"},{data:He.plugins,path:"Data/plugins.json"},{data:He.commands,path:"Data/commands.json"}),t.push({path:"index.html"},{path:"Icon/icon.png"},{path:"Script/util.js"},{path:"Script/file.js"},{path:"Script/codec.js"},{path:"Script/webgl.js"},{path:"Script/audio.js"},{path:"Script/printer.js"},{path:"Script/variable.js"},{path:"Script/animation.js"},{path:"Script/data.js"},{path:"Script/stage.js"},{path:"Script/camera.js"},{path:"Script/scene.js"},{path:"Script/actor.js"},{path:"Script/trigger.js"},{path:"Script/filter.js"},{path:"Script/controller.js"},{path:"Script/ui.js"},{path:"Script/time.js"},{path:"Script/event.js"},{path:"Script/command.js"},{path:"Script/main.js"});for({guid:a,path:n}of He.manifest.scenes){var u=`Assets/${a}.json`;s.scenes.push({path:u}),t.push({srcPath:R.route(n),newPath:u})}var p,m,g,f=/\.ts$/,v=He.config.script.outDir.replace(/\/$/,"");for({guid:p,path:m,parameters:g}of He.manifest.script){f.test(m)&&(m=m.replace("Assets",v).replace(f,".js"));var b=`Assets/${p}.js`;s.script.push({path:b,parameters:g}),t.push({srcPath:R.route(m),newPath:b})}for(const C of["images","audio","videos","fonts","others"]){var y,w,x=He.manifest[C],k=s[C];for({guid:y,path:w}of x){var T=E.extname(w),T="Assets/"+y+T;k.push({path:T}),t.push({srcPath:R.route(w),newPath:T})}}return t},kt.copyFilesTo=function(e){O.open("copyProgress");var t=_("#deployment-platform").read();const u=_("#copyProgress-bar"),p=_("#copyProgress-info");return u.style.width="0",p.textContent="",this.readFileList(t).then(t=>{let i=0,a=0,n="";var s=e+"/",r=[],o=t.length;for(let e=0;e<o;e++){var l=t[e],c=l.srcPath??R.route(l.path);const d=l.newPath??l.path;var h=s+d;!0!==l.folder?(l.data?(l=JSON.stringify(l.data),r.push(z.writeFile(h,l).then(()=>{a++,n=d}))):r.push(z.copyFile(c,h).then(()=>{a++,n=d})),i++):F.mkdirSync(h)}return this.timer=new f({duration:1/0,update:e=>{var t=Math.round(a/i*100);u.style.width=t+"%",p.textContent=n}}).add(),Promise.all(r)})},kt.folderBeforeinput=function(e){"insertText"===e.inputType&&"string"==typeof e.data&&/[\\/:*?"<>|"]/.test(e.data)&&(e.preventDefault(),e.stopPropagation())},kt.folderInput=function(e){var t=this.read(),i=t.replace(/[\\/:*?"<>|"]/g,"");t!==i&&this.write(i),kt.check()},kt.locationInput=function(e){kt.check()},kt.chooseClick=function(e){const t=_("#deployment-location");R.showOpenDialog({defaultPath:t.read(),properties:["openDirectory"]}).then(({filePaths:e})=>{1===e.length&&(t.write(e[0]),kt.check())})},kt.confirm=function(e){const t=_("#deployment-location").read();var i=_("#deployment-folder").read();const a=E.resolve(t,i);return O.close("deployment"),z.mkdir(a,{recursive:!0}).then(e=>kt.copyFilesTo(a)).finally(()=>{O.close("copyProgress"),kt.timer&&(kt.timer.remove(),kt.timer=null)}).then(()=>{P.config.dialogs.deploy=E.slash(E.resolve(t))}).catch(e=>{oi.throw(e),O.confirm({message:"Failed to deploy project:\n"+e.message},[{label:"Confirm"}])})},{initialize:null,toggleFullScreen:null,popupFileMenu:null,popupEditMenu:null,popupViewMenu:null,popupWindowMenu:null,popupHelpMenu:null,createRecentItems:null,createLanguageItems:null,createColorIcon:null,keydown:null,pointerdown:null,pointerup:null,pointerover:null}),It=(Tt.initialize=function(){window.on("keydown",this.keydown),_("#menu").on("pointerdown",this.pointerdown),_("#menu").on("pointerup",this.pointerup),_("#menu").on("pointerover",this.pointerover)},Tt.toggleFullScreen=function(){require("electron").ipcRenderer.send("toggle-full-screen")},Tt.popupFileMenu=function(e){var t,i,a;e.hasClass("selected")||(e.addClass("selected"),t=e.rect(),i="open"===P.state,a=N.createGetter("menuFile"),ve.popup({x:t.left,y:t.bottom,close:()=>{e.removeClass("selected")}},[{label:a("newProject"),accelerator:p("N"),click:()=>{b.newProject()}},{label:a("openProject"),accelerator:p("O"),click:()=>{b.openProject()}},{label:a("openRecent"),enabled:i,submenu:this.createRecentItems()},{label:a("saveProject"),accelerator:p("S"),enabled:i,click:()=>{R.save()}},{label:a("closeProject"),enabled:i,click:()=>{b.closeProject()}},{label:a("deployment"),enabled:i,click:()=>{b.deployment()}},{type:"separator"},{label:a("exit"),click:()=>{b.closeClick()}}]))},Tt.popupEditMenu=function(e){if(!e.hasClass("selected")){e.addClass("selected");var t,i,a=e.rect(),n=N.createGetter("menuEdit"),s={cut:{label:n("cut"),accelerator:p("X"),enabled:!1,click:null},copy:{label:n("copy"),accelerator:p("C"),enabled:!1,click:null},paste:{label:n("paste"),accelerator:p("V"),enabled:!1,click:null},delete:{label:n("delete"),accelerator:"Delete",enabled:!1,click:null},undo:{label:n("undo"),accelerator:p("Z"),enabled:!1,click:null},redo:{label:n("redo"),accelerator:p("Y"),enabled:!1,click:null}};switch(document.activeElement.blur(),x.manager.index){case"scene":"open"===A.state&&(t=A.target instanceof Object,i=Clipboard.has("yami.scene.object"),s.cut.enabled=t,s.copy.enabled=t,s.paste.enabled=i,s.delete.enabled=t,s.undo.enabled=A.history.canUndo(),s.redo.enabled=A.history.canRedo(),s.cut.click=()=>{A.copy(),A.delete()},s.copy.click=()=>{A.copy()},s.paste.click=()=>{A.paste()},s.delete.click=()=>{A.delete()},s.undo.click=()=>{A.undo()},s.redo.click=()=>{A.redo()});break;case"ui":"open"===Y.state&&(i=Y.target instanceof Object,t=Clipboard.has("yami.ui.object"),s.cut.enabled=i,s.copy.enabled=i,s.paste.enabled=t,s.delete.enabled=i,s.undo.enabled=Y.history.canUndo(),s.redo.enabled=Y.history.canRedo(),s.cut.click=()=>{Y.copy(),Y.delete()},s.copy.click=()=>{Y.copy()},s.paste.click=()=>{Y.paste()},s.delete.click=()=>{Y.delete()},s.undo.click=()=>{Y.undo()},s.redo.click=()=>{Y.redo()});break;case"animation":"open"===Ke.state&&(t=Ke.motion instanceof Object,i=Clipboard.has("yami.animation.object"),s.cut.enabled=t,s.copy.enabled=t,s.paste.enabled=i,s.delete.enabled=t,s.undo.enabled=Ke.history.canUndo(),s.redo.enabled=Ke.history.canRedo(),s.cut.click=()=>{Ke.copy(),Ke.delete()},s.copy.click=()=>{Ke.copy()},s.paste.click=()=>{Ke.paste()},s.delete.click=()=>{Ke.delete()},s.undo.click=()=>{Ke.undo()},s.redo.click=()=>{Ke.redo()});break;case"particle":"open"===S.state&&(s.undo.enabled=S.history.canUndo(),s.redo.enabled=S.history.canRedo(),s.undo.click=()=>{S.undo()},s.redo.click=()=>{S.redo()})}ve.popup({x:a.left,y:a.bottom,close:()=>{e.removeClass("selected")}},[s.cut,s.copy,s.paste,s.delete,s.undo,s.redo])}},Tt.popupViewMenu=function(e){var t,i,a,n,s,r,o,l,c;e.hasClass("selected")||(e.addClass("selected"),t=e.rect(),i="open"===P.state,a=b.fullscreen,n=A.showGrid,s=A.showLight,r=A.showAnimation,l=!(o=document.documentElement.hasClass("dark")),c=N.createGetter("menuView"),ve.popup({x:t.left,y:t.bottom,close:()=>{e.removeClass("selected")}},[{label:c("fullscreen"),accelerator:"F11",checked:a,click:()=>{Tt.toggleFullScreen()}},{label:c("scene"),enabled:i,submenu:[{label:c("scene.grid"),checked:n,click:()=>{A.switchGrid()}},{label:c("scene.light"),checked:s,click:()=>{A.switchLight()}},{label:c("scene.animation"),checked:r,click:()=>{A.switchAnimation()}},{label:c("scene.background"),icon:this.createColorIcon(A.background.hex),click:()=>{m.open(A.background)}}]},{label:c("ui"),enabled:i,submenu:[{label:c("ui.background"),icon:this.createColorIcon(Y.background.hex),click:()=>{m.open(Y.background)}},{label:c("ui.foreground"),icon:this.createColorIcon(Y.foreground.hex),click:()=>{m.open(Y.foreground)}}]},{label:c("animation"),enabled:i,submenu:[{label:c("animation.background"),icon:this.createColorIcon(Ke.background.hex),click:()=>{m.open(Ke.background)}}]},{label:c("particle"),enabled:i,submenu:[{label:c("particle.background"),icon:this.createColorIcon(S.background.hex),click:()=>{m.open(S.background)}}]},{label:c("layout"),enabled:i,submenu:[{label:c("layout.default"),click:()=>{x.switchLayout(x.default)}},{label:c("layout.zoom")+": "+ct.getFactor(),click:()=>{ct.open()}}]},{label:c("theme"),submenu:[{label:c("theme.light"),checked:l,click:()=>{b.switchTheme("light")}},{label:c("theme.dark"),checked:o,click:()=>{b.switchTheme("dark")}}]},{label:c("language"),submenu:this.createLanguageItems()}]))},Tt.popupWindowMenu=function(e){var t,i,a;e.hasClass("selected")||(e.addClass("selected"),t=e.rect(),i="open"===P.state,a=N.createGetter("menuWindow"),ve.popup({x:t.left,y:t.bottom,close:()=>{e.removeClass("selected")}},[{label:a("project"),accelerator:"F1",enabled:i,click:()=>{nt.open()}},{label:a("variable"),accelerator:"F3",enabled:i,click:()=>{d.open()}},{label:a("attribute"),accelerator:"F6",enabled:i,click:()=>{v.open()}},{label:a("enum"),accelerator:"F7",enabled:i,click:()=>{M.open()}},{label:a("easing"),accelerator:"F8",enabled:i,click:()=>{u.open()}},{label:a("team"),enabled:i,click:()=>{c.open()}},{label:a("plugin"),accelerator:"F9",enabled:i,click:()=>{w.open()}},{label:a("command"),accelerator:"F10",enabled:i,click:()=>{n.open()}},{label:a("run"),accelerator:"F4",enabled:i,click:()=>{b.playGame()}},{label:a("log"),enabled:i,click:()=>{O.open("log")}}]))},Tt.popupHelpMenu=function(e){var t,i;e.hasClass("selected")||(e.addClass("selected"),t=e.rect(),i=N.createGetter("menuHelp"),ve.popup({x:t.left,y:t.bottom,close:()=>{e.removeClass("selected")}},[{label:i("document"),click:()=>{}},{label:i("about"),click:()=>{let e="";var t=navigator.userAgent.match(/Windows NT [0-9.]+/),i=navigator.userAgent.match(/(?<!\w)x64|x86(?!\w)/);t&&(e+=t),t&&i&&(e+=" "+i),e=e||"unknown",O.open("about"),_("#editor-version").textContent="1.0.0",_("#electron-version").textContent=process.versions.electron,_("#chrome-version").textContent=process.versions.chrome,_("#node-version").textContent=process.versions.node,_("#v8-version").textContent=process.versions.v8,_("#os-version").textContent=e}}]))},Tt.createRecentItems=function(){if("closed"===P.state)return[];const e=P.project["recentTabs"];var t=[],i=N.createGetter("menuFile");if(t.push({label:i("openRecent.reopenClosedFile"),enabled:!!b.getClosedTabMeta(),accelerator:p("Shift+T"),click:()=>{b.reopenClosedTab()}}),0!==e.length){var a=function(){b.reopenClosedTab(this.meta)},n=(t.push({type:"separator"}),He.manifest.guidMap);for(const r of e){var s=n[r];void 0!==s&&t.push({label:R.filterGUID(s.path),meta:s,click:a})}}return t.push({type:"separator"}),t.push({label:i("openRecent.clearItems"),enabled:0!==e.length,click:()=>{e.length=0}}),t},Tt.createLanguageItems=function(){const s=N.createGetter("menuView.language"),r=""===P.config.language,o=s("auto"),l=[{label:o,checked:r,click:()=>{r||N.setLanguage("")}}];return N.readLanguageList().then(e=>{var t=N.active;0!==e.length&&l.push({type:"separator"});for(const{key:i,alias:a,filename:n}of e){let e=n===t;e&&r&&(e=!1,l[0].label=o+" - "+a),l.push({label:a,checked:e,click:()=>{e||N.setLanguage(i)}})}l.push({type:"separator"}),l.push({label:s("showInExplorer"),click:()=>{R.openPath(N.dirname)}})}),l},Tt.createColorIcon=function(e){var t=document.createElement("menu-icon"),i=parseInt(e.slice(0,2),16),a=parseInt(e.slice(2,4),16),n=parseInt(e.slice(4,6),16),e=parseInt(e.slice(6,8),16)/255;return t.style.backgroundColor=`rgba(${i}, ${a}, ${n}, ${e})`,t.addClass("color-icon"),0==e&&t.addClass("transparent"),t},Tt.keydown=function(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyN":b.newProject();break;case"KeyO":b.openProject();break;case"KeyS":R.save();break;case"KeyT":e.shiftKey&&b.reopenClosedTab();break;case"KeyW":b.tabBar.close(b.tabBar.read());break;case"KeyZ":A.undo(),Y.undo(),Ke.undo(),S.undo();break;case"KeyY":A.redo(),Y.redo(),Ke.redo(),S.redo()}else if(e.altKey)switch(e.code){case"Digit1":case"Digit2":case"Digit3":case"Digit4":case"Digit5":case"Digit6":case"Digit7":case"Digit8":case"Digit9":var t=b.tabBar.childNodes,i=parseInt(e.code.slice(-1))-1;i<t.length&&b.tabBar.select(t[i].item)}else switch(e.code){case"F1":nt.open();break;case"F3":d.open();break;case"F6":v.open();break;case"F7":M.open();break;case"F8":u.open();break;case"F9":w.open();break;case"F4":b.playGame();break;case"F10":n.open();break;case"KeyF":Ue.flipTiles();break;case"Pause":We.WEBGL_lose_context.loseContext()}},Tt.pointerdown=function(e){switch(e.button){case 0:case-1:var t=e.target;if("ITEM"===t.tagName&&!t.hasClass("selected"))switch(t.getAttribute("value")){case"file":return Tt.popupFileMenu(t);case"edit":return Tt.popupEditMenu(t);case"view":return Tt.popupViewMenu(t);case"window":return Tt.popupWindowMenu(t);case"help":return Tt.popupHelpMenu(t)}}},Tt.pointerup=function(e){var t;0===e.button&&"ITEM"===(t=e.target).tagName&&t.hasClass("selected")&&e.stopPropagation()},Tt.pointerover=function(e){var t,i=e.target;"ITEM"===i.tagName&&null!==(t=i.parentNode.querySelector(".selected"))&&t!==i&&Tt.pointerdown(e)},{initialize:null,parseRecentProjects:null,removeRecentProject:null,readFileList:null,windowLocalize:null,startClick:null,recentClick:null,recentPointerup:null}),x=(It.initialize=function(){window.on("localize",this.windowLocalize),_("#home-start-list").on("click",this.startClick),_("#home-recent-list").on("click",this.recentClick),_("#home-recent-list").on("pointerup",this.recentPointerup)},It.parseRecentProjects=function(){var t=_(".home-recent-item"),i=P.config.recent;for(let e=0;e<t.length;e++){const m=t[e].clear();var a=i[e];if(a){m.show();var n=document.createElement("box");n.addClass("home-recent-bar"),m.appendChild(n);const d=document.createElement("text");d.addClass("home-recent-title"),n.appendChild(d);var s=document.createElement("text"),r=new Date(a.date),o=r.getFullYear(),l=r.getMonth()+1,c=r.getDate(),h=r.getHours(),r=r.getMinutes().toString().padStart(2,"0"),o=(s.addClass("home-recent-date"),s.textContent=o+`/${l}/${c} ${h}:`+r,n.appendChild(s),document.createElement("text"));const u=a.path,g=(o.addClass("home-recent-path"),o.textContent=E.normalize(u),m.appendChild(o),document.createElement("box")),p=(g.addClass("home-recent-stat"),m.appendChild(g),E.dirname(u));new Promise((e,t)=>{var i;F.existsSync(u)?(i=p+"/data/config.json",e(z.readFile(i,"utf8"))):t(new URIError)}).then(e=>{e=JSON.parse(e).window;return d.textContent=e.title,this.readFileList(p)}).then(t=>{var i={folder:0,data:0,script:0,image:0,media:0,other:0,total:0},a={folder:0,data:0,script:0,image:0,media:0,other:0,total:0},n=t.length;for(let e=0;e<n;e++){var{type:s,size:r}=t[e];i[s]+=1,a[s]+=r}i.total=i.data+i.script+i.image+i.media+i.other,a.total=a.data+a.script+a.image+a.media+a.other;var e,o,l=N.createGetter("stats");for({type:e,name:o}of[{type:"data",name:l("data")},{type:"script",name:l("script")},{type:"image",name:l("image")},{type:"media",name:l("media")},{type:"other",name:l("other")},{type:"total",name:l("total")}]){var c=i[e],h=R.parseFileSize(a[e]),d=document.createElement("text"),u=document.createElement("text"),p=document.createElement("text");d.addClass("home-recent-data"),u.addClass("home-recent-data"),p.addClass("home-recent-data"),d.textContent=o,u.textContent=h,p.textContent=`(${c})`,g.appendChild(d),g.appendChild(u),g.appendChild(p)}m.show()}).catch(e=>{m.addClass("disabled"),e instanceof URIError?d.textContent="Project does not exist":d.textContent="Failed to load data"})}else m.hide()}},It.removeRecentProject=function(t){var i=_(".home-recent-item"),e=P.config.recent,a=e[t];const n=i[t];if(a&&n){e.remove(a),n.clear();var s=i.length-1;for(let e=t;e<s;e++){var r=i[e+1],o=i[e];for(const n of Array.from(r.childNodes))o.appendChild(n)}i[e.length].hide()}},It.readFileList=function(){const l={".actor":"data",".skill":"data",".trigger":"data",".item":"data",".equip":"data",".state":"data",".event":"data",".scene":"data",".tile":"data",".ui":"data",".anim":"data",".particle":"data",".json":"data",".js":"script",".ts":"script",".png":"image",".jpg":"image",".jpeg":"image",".cur":"image",".webp":"image",".mp3":"media",".m4a":"media",".ogg":"media",".wav":"media",".flac":"media",".mp4":"media",".mkv":"media",".webm":"media",".ttf":"other",".otf":"other",".woff":"other",".woff2":"other"},e={withFileTypes:!0},c=(r,o)=>z.readdir(r,e).then(async e=>{r&&(r+="/");var t=[];for(const n of e){var i=n.name,a=""+r+i;if(n.isDirectory())o.push({type:"folder",size:0}),t.push(c(a,o));else{i=E.extname(i);const s={type:l[i]??"other",size:0};o.push(s),t.push(z.stat(a).then(e=>{s.size=e.size}))}}return 0!==t.length&&await Promise.all(t),o});return function(e){return c(e,[])}}(),It.windowLocalize=function(e){"home"===x.manager.index&&It.parseRecentProjects()},It.startClick=function(e){e=e.target;if(e.hasClass("home-start-item"))switch(e.getAttribute("value")){case"new":b.newProject();break;case"open":b.openProject()}},It.recentClick=function(e){var e=e.target;e.hasClass("home-recent-item")&&!e.hasClass("disabled")&&(e=e.getAttribute("value"),e=P.config.recent[parseInt(e)])&&P.open(e.path)},It.recentPointerup=function(e){switch(e.button){case 2:{const a=e.target;if(a.hasClass("home-recent-item")&&0!==a.childNodes.length&&document.activeElement===a.parentNode){a.addClass("hover");const n=parseInt(a.getAttribute("value"));var t=!a.hasClass("disabled"),i=N.createGetter("menuRecent");ve.popup({x:e.clientX,y:e.clientY,close:()=>{a.removeClass("hover")}},[{label:i("openProject"),enabled:t,click:()=>{var e=P.config.recent[n];e&&P.open(e.path)}},{label:i("showInExplorer"),enabled:t,click:()=>{var e=P.config.recent[n];e&&R.showInExplorer(e.path)}},{label:i("removeFromList"),click:()=>{It.removeRecentProject(n)}}])}break}}},{manager:_("#workspace-page-manager"),items:null,heads:null,layouts:null,layout:null,default:null,dragging:null,resizing:null,focusableSelector:null,focusableElements:null,initialize:null,switchLayout:null,createGroups:null,updateGroups:null,updateGroupTabs:null,updateGroupInfo:null,mergeGroups:null,setGroupSize:null,computeSizesBefore:null,computeSizesAfter:null,updateHint:null,getKeyGroups:null,getGroupOfElement:null,readyToFocus:null,createGroupContent:null,createGroupBorder:null,enableFocusableElements:null,disableFocusableElements:null,saveNavStates:null,saveLayoutScheme:null,loadLayoutScheme:null,saveToConfig:null,loadFromConfig:null,windowResize:null,windowLocalize:null,pageSwitch:null,navWrite:null,navPointerdown:null,navDragstart:null,navDragend:null,navDragenter:null,navDragleave:null,navDragover:null,navDrop:null,regionDragleave:null,regionDragover:null,borderPointerdown:null,pointerup:null,pointermove:null}),A=(x.initialize=function(){var e=_("#layout-nav"),t=_("#layout-page-manager"),i=this.items={};for(const n of e.childNodes){var a=n.getAttribute("value");n.draggable=!0,i[a]=n}for(const s of t.childNodes)i[s.getAttribute("value")].page=s;Object.defineProperty(i,"list",{value:Object.values(i)}),this.heads=[A.head,A.list.head,Y.head,Y.list.head,Ke.head,Ke.list.head,Ke.timeline.head,T.head,Ue.head],R.get({local:"default.json",type:"json"}).then(e=>{this.default=e.layout}),this.focusableSelector=`
  input, textarea, button, select-box, check-box, radio-box,
  color-box, custom-box, common-list, node-list, param-list,
  command-list, file-body-content`,window.on("resize",this.windowResize),window.on("localize",this.windowLocalize),this.manager.on("switch",this.pageSwitch)},x.switchLayout=function(e){this.layout=e;var t=this["manager"];for(const i of t.childNodes)void 0!==i.scheme&&delete i.scheme;t=t.index;void 0!==e[t]&&this.loadLayoutScheme(t)},x.createGroups=function(e,t){var i=document.createElement("group");if(t.appendChild(i),e.children){i.end=e.end,i.split=e.split,i.addClass(e.split);for(const s of e.children)this.createGroups(s,i)}else{var{end:t,tabs:e}=e,{nav:a,manager:n}=(i.end=t,i.tabs=e,this.createGroupContent(i),i);for(const r of e){const e=this.items[r];a.appendChild(e),n.appendChild(e.page)}}this.createGroupBorder(i)},x.updateGroups=function(){const d=(t,i,e)=>{var a=t.end,n=t.style;switch(i){case"horizontal":var s=t.parentNode.clientWidth,r=CSS.rasterize(s*e),s=CSS.rasterize(s*a);n.left=r+"px",n.top="0",n.width=s-r+"px",n.height="100%";break;case"vertical":s=t.parentNode.clientHeight,r=CSS.rasterize(s*e),s=CSS.rasterize(s*a);n.left="0",n.top=r+"px",n.width="100%",n.height=s-r+"px";break;case"full":n.left="0",n.top="0",n.width="100%",n.height="100%"}if(t.split){const i=t.split;let e=0;for(const h of t.childNodes)"GROUP"===h.tagName&&(e=d(h,i,e))}else{var i=t.manager.active,o=t.clientWidth,l=t.clientHeight,c=window.devicePixelRatio;!i||i.dpr===c&&i.width===o&&i.height===l||(i.dpr=c,i.width=o,i.height=l,i.dispatchResizeEvent())}return a};return function(e){switch(this.manager.index){case null:case"home":return}var t=this.manager.active,i=t.childNodes[0],a=t.clientWidth,t=t.clientHeight,n=window.devicePixelRatio;a*t==0||!e&&i.dpr===n&&i.width===a&&i.height===t||(i.dpr=n,i.width=a,i.height=t,d(i,"full",0))}}(),x.updateGroupTabs=function(e){var t=[];for(const i of e.nav.childNodes)t.push(i.getAttribute("value"));e.tabs=t},x.updateGroupInfo=function(){for(const t of this.resizing.infos){var e=CSS.getDevicePixelContentBoxSize(t.manager);t.textContent=e.width+" x "+e.height}},x.mergeGroups=function(){const h=e=>{const t=e.childNodes;let i=t.length;for(;0<=--i;){var a=t[i];if(a.split===e.split){var n=a.previousSibling,s=n?n.end:0,r=a.end;const t=a.childNodes;for(;1<t.length;){var o=t[0],l=o.end;void 0!==l&&(o.end=Math.roundTo(s*(1-l)+r*l,6)),e.insertBefore(o,a)}a.remove()}}for(const c of t)void 0!==c.split&&h(c)};return function(){h(this.manager.active.childNodes[0])}}(),x.setGroupSize=function(t,e,i){var a=t.parentNode,n=t.previousSibling,s=t.nextSibling;let r,o;switch(a.split){case"horizontal":r=a.clientWidth,o=t.clientLeft+e.width;break;case"vertical":r=a.clientHeight,o=t.clientTop+e.height}if("GROUP"===s.tagName&&(o+=1),0!==r){let e=o/r;switch(i){case"forward":n&&(e=n.end+e),s===a.border&&(e=1),t.end=Math.roundTo(e,6),this.computeSizesBefore(t),this.computeSizesAfter(t);break;case"backward":n&&(e=t.end-e,n.end=Math.roundTo(e,6),this.computeSizesBefore(n),this.computeSizesAfter(n))}}},x.computeSizesBefore=function(i){var e=i.parentNode,a="horizontal"===e.split?e.clientWidth:"vertical"===e.split?e.clientHeight:0;if(0!==a){var e=e.childNodes,t=Array.prototype.indexOf.call(e,i),n=Array.prototype.slice.call(e,0,t+1),s=e[0],r=n.length,o=Math.min(.1,32/a);for(let e=r-2,t=i.end;0<=e;e--){const i=n[e];t=Math.min(i.end,t-o-2/a),t=Math.roundTo(t,6),i.end=t}for(let e=0,t=0;e<r;e++){const i=n[e];var l=1+(i===s?0:1);t=Math.max(i.end,t+o+l/a),t=Math.roundTo(t,6),i.end=t}}},x.computeSizesAfter=function(i){var e=i.parentNode,a="horizontal"===e.split?e.clientWidth:"vertical"===e.split?e.clientHeight:0;if(0!==a){var e=e.childNodes,i=Array.prototype.indexOf.call(e,i),n=Array.prototype.slice.call(e,i,-1),s=e[e.length-2],r=n.length-1,o=Math.min(.1,32/a);for(let e=0,t=0;e<r;e++){const i=n[e];t=Math.max(i.end,t+o+2/a),t=Math.roundTo(t,6),i.end=t}for(let e=r-1,t=1;0<=e;e--){const i=n[e];var l=1+(n[e+1]===s?0:1);t=Math.min(i.end,t-o-l/a),t=Math.roundTo(t,6),i.end=t}}},x.updateHint=function(n){var s=this["dragging"],r=s["hint"];if(s.location&&(o=s.location["trigger"],"NAV-ITEM"===o.tagName)&&o.removeClass("drag-entered"),s.location=n){var o=s["group"],s=n["trigger"],l=n["target"],n=n["direction"],c=o.clientWidth,h=o.clientHeight,o=l.rect();let e=l.clientLeft+o.left,t=l.clientTop+o.top,i=l.clientWidth,a=l.clientHeight;switch(n){case"inside":break;case"top":a=Math.min(a/2-1,h);break;case"bottom":t+=a,a=Math.min(a/2-1,h),t-=a;break;case"left":i=Math.min(i/2-1,c);break;case"right":e+=i,i=Math.min(i/2-1,c),e-=i}"NAV-ITEM"===s.tagName&&s.addClass("drag-entered"),document.body.appendChild(r),r.set({left:e,top:t,width:i,height:a})}else r.remove()},x.getKeyGroups=function(){const a=(e,t)=>{if(void 0!==t.split)for(const i of t.childNodes)"GROUP"===i.tagName&&a(e,i);else"GROUP"===t.tagName&&e.push(t);return e};return function(){return a([],this.manager.active.childNodes[0])}}(),x.getGroupOfElement=function(e){for(;e=e.parentNode;)if("GROUP"===e.tagName)return e;return null},x.readyToFocus=function(e){const t=this.getGroupOfElement(e);t&&(t.addClass("ready-to-focus"),setTimeout(()=>{t.removeClass("ready-to-focus"),e.focus()}))},x.createGroupContent=function(e){var t=document.createElement("nav-bar"),i=(t.on("write",this.navWrite),t.on("pointerdown",this.navPointerdown),t.on("dragstart",this.navDragstart),t.on("dragend",this.navDragend),e.appendChild(t),document.createElement("page-manager"));i.addClass("group-manager"),e.appendChild(i),e.nav=t,e.manager=i},x.createGroupBorder=function(e){var t=document.createElement("group-border");t.on("pointerdown",this.borderPointerdown),e.appendChild(t),e.border=t},x.enableFocusableElements=function(){var e=this.focusableElements;if(e){for(const t of e)0!==t.clientWidth&&(t.tabIndex+=1);this.focusableElements=null}},x.disableFocusableElements=function(){var e=this.manager["active"];if(e){var t=[],i=this.focusableSelector;for(const a of e.querySelectorAll(i))0!==a.clientWidth&&(--a.tabIndex,t.push(a));this.focusableElements=t}},x.saveNavStates=function(){for(const t of this.items.list){var e;t.hasClass("selected")&&((e=t.parentNode).lastValue=t.dataValue,e.write(null))}},x.saveLayoutScheme=function(){const s=(e,t)=>{if(void 0!==t.split){var i,a=[];e.end=t.end,e.split=t.split,e.children=a;for(const n of t.childNodes)n!==t.border&&(i={},s(i,n),a.push(i))}else e.end=t.end,e.tabs=t.tabs;return e};return function(e){return s({},e)}}(),x.loadLayoutScheme=function(e){var e=x.layout[e],t=this.manager.active;if(t.scheme!==e){t.scheme=e,this.createGroups(e,t.clear()),this.updateGroups();for(const l of this.getKeyGroups())l.nav.write(l.tabs[0])}else{var i,a=this.items,e=this.getKeyGroups();for(const c of e){var{tabs:n,nav:s,manager:r}=c;for(const h of n){var o=a[h];s.appendChild(o),r.appendChild(o.page)}}this.updateGroups(!0);for({nav:i}of e)i.write(i.lastValue)}},x.saveToConfig=function(e){var t=this["layout"];for(const n of this.manager.childNodes){var i,a=n.getAttribute("value");void 0!==n.scheme&&n.scheme===t[a]&&(i=n.childNodes[0],t[a]=this.saveLayoutScheme(i))}e.layout=t},x.loadFromConfig=function(e){this.layout=e.layout},x.windowResize=function(e){x.updateGroups()},x.windowLocalize=function(e){if(null!==x.manager.active)for(const t of x.getKeyGroups())t.manager.active.dispatchResizeEvent()},x.pageSwitch=function(e){switch(e.last){case"scene":A.save(),A.close();break;case"ui":Y.save(),Y.close();break;case"animation":Ke.save(),Ke.close();break;case"particle":S.save(),S.close()}switch(e.last){case"directory":case"scene":case"ui":case"animation":case"particle":x.saveNavStates()}switch(e.value){case"scene":var t=A.body,i=t.firstChild;t.insertBefore(We.canvas,i);break;case"ui":t=Y.body,i=t.firstChild;t.insertBefore(We.canvas,i);break;case"animation":t=Ke.body,i=t.firstChild;t.insertBefore(We.canvas,i);break;case"particle":t=S.body,i=t.firstChild;t.insertBefore(We.canvas,i);break;default:We.canvas.remove()}switch(e.value){case"home":b.tabBar.removeClass("visible"),It.parseRecentProjects();break;case"directory":b.tabBar.addClass("visible"),b.tabBar.select(b.tabBar.dirItem),x.loadLayoutScheme("directory");break;case"scene":b.tabBar.addClass("visible"),x.loadLayoutScheme("scene");break;case"ui":b.tabBar.addClass("visible"),x.loadLayoutScheme("ui");break;case"animation":b.tabBar.addClass("visible"),x.loadLayoutScheme("animation");break;case"particle":b.tabBar.addClass("visible"),x.loadLayoutScheme("particle")}},x.navWrite=function(e){e=e.value;this.parentNode.manager.switch(e)},x.navPointerdown=function(e){if(0===e.button){e=e.target;if("NAV-ITEM"===e.tagName&&e.hasClass("selected"))if("inspector"===e.dataValue)x.readyToFocus(j.manager);else{var e=e.page,t=e.querySelectorAll("[tabindex]");for(let e=t.length-1;0<=e;e--){var i=t[e];if(0!==i.clientWidth&&0!==i.clientHeight){x.readyToFocus(i);break}}x.readyToFocus(e)}}},x.navDragstart=function(e){if(!x.dragging){x.dragging=e,Object.defineProperty(e,"clientX",{writable:!0}),Object.defineProperty(e,"clientY",{writable:!0}),e.preventDefault=Function.empty,e.dataTransfer.hideDragImage(),e.group=this.parentNode,e.hint=document.createElement("drag-and-drop-hint"),e.hint.addClass("for-group"),window.on("dragenter",x.navDragover),window.on("dragover",x.navDragover);var t=x.getKeyGroups(),i=e.navs=[],a=e.regions=[];for(const s of t){var n=s.nav,n=(n.on("dragenter",x.navDragenter),n.on("dragleave",x.navDragleave),n.on("drop",x.navDrop),i.push(n),document.createElement("group-region"));n.on("dragleave",x.regionDragleave),n.on("dragover",x.regionDragover),n.on("drop",x.navDrop),s.appendChild(n),a.push(n)}for(const r of x.heads)r.style.pointerEvents="none"}},x.navDragend=function(e){var t=x["dragging"];if(t){window.off("dragenter",x.navDragover),window.off("dragover",x.navDragover);for(const i of t.navs)i.off("dragenter",x.navDragenter),i.off("dragleave",x.navDragleave),i.off("drop",x.navDrop);for(const a of t.regions)a.off("dragleave",x.regionDragleave),a.off("dragover",x.regionDragover),a.off("drop",x.navDrop),a.remove();for(const n of x.heads)n.style.pointerEvents="";x.updateHint(null),x.dragging=null}},x.navDragenter=function(e){var t,i,a,n,s=x["dragging"];s&&(e.preventDefault(),e.dataTransfer.dropEffect="move",e=e.target,t=this.parentNode,i=s.group,s=s.target,n=(a=i.nav).childNodes,t!==i||1<n.length&&e!==s&&(e!==a||s!==a.lastChild)&&e!==s.nextSibling?x.updateHint({trigger:e,target:t,direction:"inside"}):x.updateHint(null))},x.navDragleave=function(e){var t=x["dragging"];t&&t.location&&t.location.trigger===e.target&&x.updateHint(null)},x.navDragover=function(e){e.preventDefault(),e.dataTransfer.dropEffect="move"},x.navDrop=function(a){var n=x["dragging"];if(n&&(a.stopPropagation(),n.location)){var a=n.group,s=n.target,r=n["hint"],n=n["location"],o=n["trigger"],l=n["target"],n=n["direction"];let e=l.parentNode,t,i;switch(n){case"left":case"right":i="horizontal";break;case"top":case"bottom":i="vertical"}switch(void 0!==i&&e.split!==i&&(e.replaceChild(e=document.createElement("group"),l),e.end=l.end,e.split=i,e.addClass(i),e.style.left=l.style.left,e.style.top=l.style.top,e.style.width=l.style.width,e.style.height=l.style.height,e.appendChild(l),l.end=1,x.createGroupBorder(e)),n){case"inside":t=l;break;case"left":case"top":t=document.createElement("group"),e.insertBefore(t,l),x.createGroupContent(t),x.createGroupBorder(t);break;case"right":case"bottom":(t=document.createElement("group")).end=l.end,e.insertBefore(t,l.nextSibling),x.createGroupContent(t),x.createGroupBorder(t)}var c=a.nav,h=t.nav,d=a.manager,u=t.manager,d=(c!==h&&(h.write(null),u.index=d.index,u.active=d.active,d.index=null,d.active=null),s.page);if("NAV-ITEM"===o.tagName?(h.insertBefore(s,o),u.insertBefore(d,o.page)):(h.appendChild(s),u.appendChild(d)),x.updateGroupTabs(a),x.updateGroupTabs(t),d.width=null,d.height=null,c!==h){switch(c.hasChildNodes()?c.write(c.childNodes[0].getAttribute("value")):(o=a.parentNode,u=a.previousSibling,d=a.nextSibling,h=o.border,c=o.childNodes,u&&d===h&&(u.end=1),a.remove(),2===c.length&&(c[0].end=o.end,o.parentNode.replaceChild(c[0],o))),n){case"left":case"top":x.mergeGroups(),x.setGroupSize(t,r,"forward");break;case"right":case"bottom":x.mergeGroups(),x.setGroupSize(t,r,"backward")}x.updateGroups(!0),x.navPointerdown({button:0,target:s})}}},x.regionDragleave=function(e){var t=x["dragging"];t&&t.location&&t.location.trigger===this&&x.updateHint(null)},x.regionDragover=function(i){var a=x["dragging"];if(a&&a.clientX!==i.clientX||a.clientY!==i.clientY){a.clientX=i.clientX,a.clientY=i.clientY;var n=x.manager.active.childNodes[0];let e=this.parentNode;var s=e.parentNode,r=s.childNodes;let t;n.split&&({x:d,y:c}=i.getRelativeCoords(n),h=n.clientWidth,l=n.clientHeight,u=n.childNodes,!t&&c<28&&(t="top","horizontal"===n.split&&(e=n),"vertical"===n.split)&&(e=u[0]),!t&&l-8<c&&(t="bottom","horizontal"===n.split&&(e=n),"vertical"===n.split)&&(e=u[u.length-2]),!t&&d<8&&(t="left","horizontal"===n.split&&(e=u[0]),"vertical"===n.split)&&(e=n),!t)&&h-8<d&&(t="right","horizontal"===n.split&&(e=u[u.length-2]),"vertical"===n.split)&&(e=n);var o,{x:l,y:c}=i.getRelativeCoords(this),h=this.clientWidth,d=this.clientHeight,u=Math.min(h,d)/4,n=u,i=h-u,p=d-u,m=u/3;switch(!(t=!t&&n<=l&&l<i&&u<=c&&c<p?"center":t)&&c<u&&(u=Math.atan2(c,l),o=Math.atan2(c,l-h),u<.25*Math.PI)&&o>.75*Math.PI&&(t="top",c<m)&&("horizontal"===s.split&&(e=s),"vertical"===s.split)&&e===r[0]&&"GROUP"===(u=s.parentNode).tagName&&(e=u),!t&&p<=c&&(o=Math.atan2(c-d,l),u=Math.atan2(c-d,l-h),o>.25*-Math.PI)&&u<.75*-Math.PI&&(t="bottom",d-m<=c)&&("horizontal"===s.split&&(e=s),"vertical"===s.split)&&e===r[r.length-2]&&"GROUP"===(p=s.parentNode).tagName&&(e=p),!t&&l<n&&(t="left",l<m)&&("horizontal"===s.split&&e===r[0]&&"GROUP"===(o=s.parentNode).tagName&&(e=o),"vertical"===s.split)&&(e=s),!t&&i<=l&&(t="right",h-m<=l)&&("horizontal"===s.split&&e===r[r.length-2]&&"GROUP"===(u=s.parentNode).tagName&&(e=u),"vertical"===s.split)&&(e=s),t){case"left":case"top":case"right":case"bottom":var g=a.group,f=g.nav.childNodes,v=e.parentNode.split,b=e.previousSibling,y=e.nextSibling;if(1<f.length||e!==g&&("left"===t&&("horizontal"!==v||b!==g)||"top"===t&&("vertical"!==v||b!==g)||"right"===t&&("horizontal"!==v||y!==g)||"bottom"===t&&("vertical"!==v||y!==g))){a.location&&a.location.trigger===this&&a.location.target===e&&a.location.direction===t||x.updateHint({trigger:this,target:e,direction:t});break}default:a.location&&x.updateHint(null)}}},x.borderPointerdown=function(e){if(0===e.button)if(!x.resizing){x.resizing=e;var t=this.parentNode,i=t.parentNode;switch(i.split){case"horizontal":e.mode="col-resize",e.startX=Math.round(i.clientWidth*t.end),pt.open("cursor-col-resize");break;case"vertical":e.mode="row-resize",e.startY=Math.round(i.clientHeight*t.end),pt.open("cursor-row-resize")}e.outer=i,e.group=t,e.end=t.end,window.on("pointerup",x.pointerup),window.on("pointermove",x.pointermove);var a=x.getKeyGroups(),n=e.infos=[];for(const r of a){var s=document.createElement("group-info");s.manager=r.manager,r.appendChild(s),n.push(s)}x.updateGroupInfo()}},x.pointerup=function(e){var t=x["resizing"];if(null!==t&&t.relate(e=void 0===e?t:e)){switch(t.mode){case"col-resize":pt.close("cursor-col-resize");break;case"row-resize":pt.close("cursor-row-resize")}for(const i of t.infos)i.remove();x.resizing=null,window.off("pointerup",x.pointerup),window.off("pointermove",x.pointermove)}},x.pointermove=function(e){let t;var i,a,n=x["resizing"];switch(n.mode){case"col-resize":t=(e.clientX+n.startX-n.clientX)/n.outer.clientWidth;break;case"row-resize":t=(e.clientY+n.startY-n.clientY)/n.outer.clientHeight}t=Math.clamp(t,0,1),void 0!==(t=Math.roundTo(t,6))&&(i=n["group"],(a=i.end)!==t)&&((i.end=t)>a?x.computeSizesAfter(i):x.computeSizesBefore(i),x.updateGroups(!0),x.updateGroupInfo())},{state:"closed",page:_("#scene"),head:_("#scene-head"),body:_("#scene-body").hide(),info:_("#scene-info"),screen:_("#scene-screen"),marquee:_("#scene-marquee"),searcher:_("#scene-searcher"),list:_("#scene-list"),dragging:null,tilemap:null,target:null,layer:null,brush:null,symbol:null,history:null,textures:null,shiftKey:!1,translationKey:0,translationTimer:null,showGrid:!1,showLight:!1,showAnimation:!1,animationFrame:null,animationElapsed:null,background:null,matrix:null,zoom:null,zoomTimer:null,scale:null,scaleX:null,scaleY:null,scaledTileWidth:null,scaledTileHeight:null,aspectRatio:null,outerWidth:null,outerHeight:null,scrollLeft:null,scrollTop:null,scrollRight:null,scrollBottom:null,scrollCenterX:null,scrollCenterY:null,centerOffsetX:null,centerOffsetY:null,lightLeft:null,lightTop:null,lightRight:null,lightBottom:null,padding:null,paddingLeft:null,paddingTop:null,patternOriginX:null,patternOriginY:null,inspectorTypeMap:null,tilemapLightSamplingModes:null,defaultLightSamplingModes:null,startPositionTexture:null,blendModeMap:null,activeTilemapId:null,sharedPoint:null,presets:null,context:null,meta:null,width:null,height:null,tileWidth:null,tileHeight:null,animationInterval:null,contrast:null,ambient:null,terrains:null,events:null,scripts:null,objects:null,tilemaps:null,actors:null,regions:null,lights:null,animations:null,particles:null,parallaxes:null,backgrounds:null,foregrounds:null,doodads:null,initialize:null,open:null,load:null,save:null,close:null,destroy:null,shiftTilemap:null,shiftTerrains:null,shiftObjects:null,computeObjectShifting:null,copy:null,paste:null,create:null,delete:null,undo:null,redo:null,setZoom:null,setSize:null,setTileSize:null,setTilemapSize:null,setTarget:null,openTilemap:null,closeTilemap:null,computeActiveTilemapId:null,revealTarget:null,shiftTarget:null,redirectTarget:null,updateTarget:null,updateTargetInfo:null,updateTargetItem:null,updateTargetEditor:null,updateAnimationInterval:null,updateLightAreaExpansion:null,updateActorTeams:null,updateHead:null,resize:null,getTileCoords:null,getConvertedCoords:null,getParallaxAnchor:null,getGridContext:null,rasterizeScrollPosition:null,updateLightTexParameters:null,updateCamera:null,updateTransform:null,setPresetId:null,loadPresets:null,sortLayers:null,loadObjects:null,loadTextures:null,loadAllContexts:null,loadActorContext:null,loadLightContext:null,loadAnimationContext:null,loadParallaxContext:null,loadParticleContext:null,loadObjectContext:null,reloadObjectContext:null,destroyObjectContext:null,updateParallaxes:null,drawScene:null,drawBackgrounds:null,drawForegrounds:null,updateAnimations:null,updateParticles:null,drawParticles:null,drawTileLayer:null,drawGridLayer:null,drawRegionLayer:null,drawRegionBorders:null,drawObjectLayer:null,drawNameLayer:null,drawTerrainLayer:null,drawLightLayer:null,drawTilemap:null,drawTilePreview:null,drawTileMarquee:null,drawTerrainMarquee:null,drawTilemapWireframe:null,drawAnimationWireframe:null,drawAnimationAnchor:null,drawLightWireframe:null,drawRegionWireframe:null,drawParticleEmitterWireframe:null,drawParallaxWireframe:null,drawOvalWireframe:null,drawTargetAnchor:null,drawRectWireframe:null,drawRectWireframeOnTilemap:null,setRectWireframeVertices:null,createStartPositionTexture:null,drawStartPosition:null,selectObject:null,selectRegion:null,selectLight:null,selectParticleEmitter:null,selectSortedLayer:null,edit:null,editInPencilMode:null,editInRectMode:null,editInOvalMode:null,editInFillMode:null,setTile:null,setTileFrame:null,setTerrain:null,createTiles:null,cloneTiles:null,createTerrains:null,getNewTilesetIndex:null,requestAnimation:null,updateAnimation:null,stopAnimation:null,requestRendering:null,renderingFunction:null,stopRendering:null,switchLayer:null,switchBrush:null,switchGrid:null,switchLight:null,switchAnimation:null,switchSettings:null,switchTerrain:null,resetAnimations:null,updateFont:null,planToSave:null,planToSaveTerrains:null,beginMapRecord:null,closeMapRecord:null,saveMapRecord:null,recordMapData:null,restoreMapData:null,undoMapData:null,redoMapData:null,createHistory:null,createDefaultAnimation:null,saveToConfig:null,loadFromConfig:null,saveToProject:null,loadFromProject:null,webglRestored:null,windowResize:null,themechange:null,dprchange:null,datachange:null,keydown:null,headPointerdown:null,switchPointerdown:null,layerPointerdown:null,brushPointerdown:null,zoomFocus:null,zoomInput:null,screenKeydown:null,shiftKeyup:null,translationKeyup:null,screenWheel:null,screenUserscroll:null,screenBlur:null,marqueePointerdown:null,marqueePointermove:null,marqueePointerleave:null,marqueeDoubleclick:null,pointerup:null,pointermove:null,menuPopup:null,searcherInput:null,listKeydown:null,listPointerdown:null,listSelect:null,listRecord:null,listPopup:null,listOpen:null,listRename:null,listChange:null,listPageResize:null,Textures:null,Point:null});A.marquee.key=null,A.marquee.offsetX=null,A.marquee.offsetY=null,A.marquee.tilesetMap=null,A.marquee.tiles=null,A.marquee.terrain=null,A.marquee.previewTiles=!1,A.marquee.pointerevent=null,A.marquee.save=null,A.marquee.switch=null,A.marquee.resize=null,A.marquee.clear=null,A.marquee.select=null,A.marquee.selectInPencilMode=null,A.marquee.selectInRectMode=null,A.marquee.selectInCopyMode=null,A.marquee.selectInObjectMode=null,A.marquee.getTiles=null,A.list.page=_("#scene-object"),A.list.head=_("#scene-list-head"),A.list.copy=null,A.list.paste=null,A.list.delete=null,A.list.cancelSearch=null,A.list.createFolder=null,A.list.createTilemapShortcutItems=null,A.list.restoreRecursiveStates=null,A.list.setRecursiveStates=null,A.list.updateFolderState=null,A.list.canSwitchState=null,A.list.createIcon=null,A.list.updateIcon=null,A.list.updateHead=null,A.list.updateTilemapClass=null,A.list.createConditionIcon=null,A.list.updateConditionIcon=null,A.list.createEventIcon=null,A.list.updateEventIcon=null,A.list.createScriptIcon=null,A.list.updateScriptIcon=null,A.list.createVisibilityIcon=null,A.list.updateVisibilityIcon=null,A.list.createLockIcon=null,A.list.updateLockIcon=null,A.list.onCreate=null,A.list.onRemove=null,A.list.onDelete=null,A.list.onResume=null,A.initialize=function(){this.screen.addScrollbars(),this.translationTimer=new f({duration:1/0,update:e=>{if("open"!==this.state||null!==this.dragging)return!1;{var i=this.translationKey,a=this.meta,n=.04*f.deltaTime/this.scale;let e=0,t=0;1&i&&(e-=n),2&i&&(t-=n),4&i&&(e+=n),8&i&&(t+=n);var i=this.screen,n=i.scrollLeft,s=i.scrollTop,r=Math.roundTo(a.x+e,4),a=Math.roundTo(a.y+t,4);this.updateCamera(r,a),this.updateTransform(),i.scrollLeft===n&&i.scrollTop===s||(this.requestRendering(),this.marquee.resize(),this.screen.updateScrollbars())}}}),this.zoomTimer=new f({duration:80,update:e=>{if("open"!==this.state)return this.scale=e.end,!1;var{elapsed:e,duration:t,start:i,end:a}=e,e=e/t;this.scale=i*(1-e)+a*e,this.resize(),this.requestRendering()}}),this.marquee.key="tile",this.marquee.x=0,this.marquee.y=0,this.marquee.width=1,this.marquee.height=1,this.marquee.offsetX=0,this.marquee.offsetY=0,this.marquee.tilesetMap=Ue.tilesetMap,this.marquee.tiles=this.createTiles(1,1),this.marquee.terrain=2,this.marquee.save("eraser"),this.marquee.save("tile"),this.marquee.save("object"),this.marquee.save("terrain"),this.marquee.backgroundColorNormal=[0,192/255,1,.2],this.marquee.borderColorNormal=[1,1,1,1],this.marquee.backgroundColorCopy=[0,1,0,.2],this.marquee.borderColorCopy=[0,1,0,1],this.marquee.backgroundColorRect=[0,192/255,1,.2],this.marquee.borderColorRect=[1,1,1,1],this.marquee.backgroundColorInvalid=[192/255,0,0,.2],this.padding=800,this.matrix=new Ze,this.inspectorTypeMap={actor:"sceneActor",region:"sceneRegion",light:"sceneLight",animation:"sceneAnimation",parallax:"sceneParallax",particle:"sceneParticle",tilemap:"sceneTilemap"},this.tilemapLightSamplingModes={raw:0,global:1,ambient:2},this.defaultLightSamplingModes={raw:0,global:0,anchor:0},this.blendModeMap={0:"normal",1:"additive",2:"subtract",normal:0,additive:1,subtract:2},this.sharedPoint=new A.Point,this.searcher.addCloseButton(),this.searcher.addKeydownFilter();const n=this["list"];n.removable=!0,n.renamable=!0,n.bind(()=>this.objects),n.creators.push(n.updateTilemapClass),n.creators.push(n.createConditionIcon),n.creators.push(n.updateConditionIcon),n.creators.push(n.createEventIcon),n.creators.push(n.updateEventIcon),n.creators.push(n.createScriptIcon),n.creators.push(n.updateScriptIcon),n.creators.push(n.createVisibilityIcon),n.updaters.push(n.updateVisibilityIcon),n.creators.push(n.createLockIcon),n.updaters.push(n.updateLockIcon),l.processors["scene-folder-rename"]=(e,t)=>{t=t.response;n.restore(e,t)},l.processors["scene-object-create"]=(e,t)=>{var{response:t,parent:i}=t;n.restore(e,t),n.updateFolderState(i,"hidden"),n.updateFolderState(i,"locked")},l.processors["scene-object-delete"]=(e,t)=>{var t=t["response"],i=t.item.parent;n.restore(e,t),n.updateFolderState(i,"hidden"),n.updateFolderState(i,"locked")},l.processors["scene-object-remove"]=(e,t)=>{var t=t["response"],i=t.source.parent,a=t.destination.parent;n.restore(e,t),n.updateFolderState(i,"hidden"),n.updateFolderState(i,"locked"),i!==a&&(n.updateFolderState(a,"hidden"),n.updateFolderState(a,"locked"))},l.processors["scene-object-hidden"]=(e,t)=>{var{item:t,oldValues:i,newValue:a}=t;"undo"===e?n.restoreRecursiveStates(t,"hidden",i):n.setRecursiveStates(t,"hidden",a),n.updateFolderState(t.parent,"hidden"),n.update(),A.requestRendering(),A.planToSave()},l.processors["scene-object-locked"]=(e,t)=>{var{item:t,oldValues:i,newValue:a}=t;"undo"===e?n.restoreRecursiveStates(t,"locked",i):n.setRecursiveStates(t,"locked",a),n.updateFolderState(t.parent,"locked"),n.update(),A.planToSave()},l.processors["scene-resize"]=(e,t)=>{var{editor:i,width:a,height:n,terrains:s}=t;t.width=A.width,t.height=A.height,t.terrains=A.terrains,A.width=a,A.height=n,A.terrains=s,i.target===A?i.write({width:a,height:n}):j.open("fileScene",A),A.planToSaveTerrains(),A.resize(),A.requestRendering(),A.planToSave()},l.processors["scene-tilemap-resize"]=(e,t)=>{var{editor:i,tilemap:a,width:n,height:s,tiles:r,tilesetMap:o}=t;t.width=a.width,t.height=a.height,t.tiles=a.tiles,a.width=n,a.height=s,a.tiles=r,a.tilesetMap=o,a.changed=!0,i.target===a&&i.write({width:n,height:s}),A.setTarget(a),A.marquee.resize(),A.requestRendering(),A.planToSave()},l.processors["scene-tilemap-shortcut"]=(e,t)=>{var{tilemap:i,shortcut:a}=t;t.shortcut=i.shortcut,i.shortcut=a,A.setTarget(i),A.tilemaps.shortcuts.update(),A.planToSave()},l.processors["scene-tilemap-shift"]=(e,t)=>{var{tilemap:t,shiftX:i,shiftY:a}=t;"undo"===e?A.shiftTilemap(t,-i,-a):A.shiftTilemap(t,i,a),t.changed=!0,A.setTarget(t),A.planToSave()},l.processors["scene-shift"]=(e,t)=>{var{shiftX:t,shiftY:i,changes:a}=t;"undo"===e?A.shiftTerrains(-t,-i):A.shiftTerrains(t,i),A.shiftObjects(a),A.planToSaveTerrains(),A.planToSave()},l.processors["scene-tilemap-change"]=(e,t)=>{var{tilemap:i,changes:a,tilesetMap:t}=t;switch(e){case"undo":A.undoMapData(i.tiles,a);break;case"redo":A.redoMapData(i.tiles,a)}i.tilesetMap=t,i.changed=!0,A.requestRendering(),A.planToSave()},l.processors["scene-terrain-change"]=(e,t)=>{var{terrains:i,changes:a}=t;switch(e){case"undo":A.undoMapData(i,a);break;case"redo":A.redoMapData(i,a)}A.planToSaveTerrains(),A.requestRendering(),A.planToSave()},l.processors["scene-target-shift"]=(e,t)=>{var{editor:i,target:a,x:n,y:s}=t;t.x=a.x,t.y=a.y,a.x=n,a.y=s,i.target===a&&i.write({x:n,y:s}),A.setTarget(a),A.updateTargetInfo(),A.requestRendering(),A.planToSave()},l.processors["scene-target-redirect"]=(e,t)=>{var{editor:i,target:a,angle:n}=t;t.angle=a.angle,a.angle=n,a.player.setAngle(Math.radians(n)),i.target===a&&i.write({angle:n}),A.setTarget(a),A.requestRendering(),A.planToSave()},window.on("themechange",this.themechange),window.on("dprchange",this.dprchange),window.on("datachange",this.datachange),window.on("keydown",this.keydown),this.page.on("resize",this.windowResize),this.head.on("pointerdown",this.headPointerdown),We.canvas.on("webglcontextrestored",this.webglRestored),_("#scene-head-start").on("pointerdown",this.switchPointerdown),_("#scene-layer").on("pointerdown",this.layerPointerdown),_("#scene-brush").on("pointerdown",this.brushPointerdown),_("#scene-zoom").on("focus",this.zoomFocus),_("#scene-zoom").on("input",this.zoomInput),this.screen.on("keydown",this.screenKeydown),this.screen.on("wheel",this.screenWheel),this.screen.on("userscroll",this.screenUserscroll),this.screen.on("blur",this.screenBlur),this.marquee.on("pointerdown",this.marqueePointerdown),this.marquee.on("pointermove",this.marqueePointermove),this.marquee.on("pointerleave",this.marqueePointerleave),this.marquee.on("doubleclick",this.marqueeDoubleclick),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),n.on("keydown",this.listKeydown),n.on("pointerdown",this.listPointerdown),n.on("select",this.listSelect),n.on("record",this.listRecord),n.on("popup",this.listPopup),n.on("open",this.listOpen),n.on("change",this.listChange),n.page.on("resize",this.listPageResize),Ct.initialize(),Et.initialize(),Mt.initialize()},A.open=function(t){if(this.context!==t){this.save(),this.close();var e=t["meta"];if(this.context=t,this.meta=e,S.Element.stage=this,!t.scene){this.state="loading";const i=this.symbol=Symbol();return He.loadScene(e.guid).then(e=>{this.symbol===i&&(t.scene=e,this.symbol=null,this.load(t))},e=>{oi.throw(e);var t=e instanceof URIError?"Failed to read file":e instanceof SyntaxError?"Syntax error":e instanceof RangeError?"Decoding error":"Unknown error";this.close(),x.manager.switch("directory"),O.confirm({message:t+": "+e.message},[{label:"Confirm"}])})}this.state="open",this.load(t),this.body.show(),this.resize(),this.requestAnimation(),this.requestRendering()}},A.load=function(e){var t=!e.editor,{scene:i,editor:a}=(t&&((i=[]).shortcuts=new Mt(i),(a=[]).visibleList=[],a.visibleList.count=0,e.changed=!1,e.editor={target:null,tilemap:null,history:this.createHistory(),textures:new A.Textures,tilemaps:i,actors:[],regions:a,lights:[],animations:[],particles:[],parallaxes:[],backgrounds:[],foregrounds:[],doodads:[],presets:{},animationFrame:0,animationElapsed:0,animationInterval:-1}),e);this.width=i.width,this.height=i.height,this.tileWidth=i.tileWidth,this.tileHeight=i.tileHeight,this.contrast=i.contrast,this.ambient=i.ambient,this.terrains=i.terrains,this.events=i.events,this.scripts=i.scripts,this.objects=i.objects,this.history=a.history,this.textures=a.textures,this.tilemaps=a.tilemaps,this.actors=a.actors,this.regions=a.regions,this.lights=a.lights,this.animations=a.animations,this.particles=a.particles,this.parallaxes=a.parallaxes,this.backgrounds=a.backgrounds,this.foregrounds=a.foregrounds,this.doodads=a.doodads,this.presets=a.presets,this.animationFrame=a.animationFrame,this.animationElapsed=a.animationElapsed,this.animationInterval=a.animationInterval,this.updateAnimationInterval(),this.updateFont(),t&&(this.loadObjects(),this.loadTextures(),this.loadPresets()),this.loadAllContexts(),this.list.update(),this.tilemaps.shortcuts.update(),this.setTarget(a.target),a.tilemap&&this.openTilemap(a.tilemap),We.setContrast(this.contrast),We.setAmbientLight(this.ambient)},A.save=function(){var e,t;"open"===this.state&&({scene:e,editor:t}=this.context,e.width=this.width,e.height=this.height,e.tileWidth=this.tileWidth,e.tileHeight=this.tileHeight,e.contrast=this.contrast,e.ambient=this.ambient,e.terrains=this.terrains,e.events=this.events,e.scripts=this.scripts,e.objects=this.objects,t.target=this.target,t.tilemap=this.tilemap,t.history=this.history,t.textures=this.textures,t.tilemaps=this.tilemaps,t.actors=this.actors,t.regions=this.regions,t.lights=this.lights,t.animations=this.animations,t.particles=this.particles,t.parallaxes=this.parallaxes,t.backgrounds=this.backgrounds,t.foregrounds=this.foregrounds,t.doodads=this.doodads,t.presets=this.presets,t.animationFrame=this.animationFrame,t.animationElapsed=this.animationElapsed,t.animationInterval=this.animationInterval,this.context.changed)&&(this.context.changed=!1,He.scenes[this.meta.guid]=_e.encodeScene(e))},A.close=function(){"closed"!==this.state&&(this.screen.blur(),this.closeTilemap(),this.setTarget(null),"fileScene"===j.type&&j.close(),this.state="closed",this.symbol=null,this.context=null,this.meta=null,this.width=null,this.height=null,this.tileWidth=null,this.tileHeight=null,this.contrast=null,this.ambient=null,this.terrains=null,this.events=null,this.scripts=null,this.objects=null,this.tilemaps=null,this.actors=null,this.regions=null,this.lights=null,this.animations=null,this.particles=null,this.parallaxes=null,this.backgrounds=null,this.foregrounds=null,this.doodads=null,this.history=null,this.textures=null,this.presets=null,this.closeMapRecord(),this.searcher.write(""),this.marquee.clear(),this.list.clear(),this.body.hide(),this.stopAnimation(),this.stopRendering())},A.destroy=function(e){var t=e["editor"];if(t){this.context===e&&(this.save(),this.close()),t.textures.destroy();for(const i of t.actors)i.player.destroy();for(const a of t.animations)a.player.destroy();for(const n of t.particles)n.emitter?.destroy();for(const s of t.parallaxes)s.player.destroy()}},A.shiftTilemap=function(e,t,i){var a=e.width,n=e.height;if(0!==a&&0!==n){var s=(t%a+a)%a,r=(i%n+n)%n,o=We.arrays[0].uint32,l=e.tiles,c=l.rowOffset;o.set(l);for(let e=0;e<n;e++){var h=e*c,d=(e+r)%n*c;for(let e=0;e<a;e++){var u=e+h;l[(e+s)%a+d]=o[u]}}this.requestRendering()}},A.shiftTerrains=function(e,t){var i=this.width,a=this.height;if(0!==i&&0!==a){var n=(e%i+i)%i,s=(t%a+a)%a,r=We.arrays[0].uint8,o=this.terrains,l=o.rowOffset;r.set(o);for(let e=0;e<a;e++){var c=e*l,h=(e+s)%a*l;for(let e=0;e<i;e++){var d=e+c;o[(e+n)%i+h]=r[d]}}this.requestRendering()}},A.shiftObjects=function(e){var{targets:t,posX:i,posY:a}=e,n=t.length;for(let e=0;e<n;e++){var s=t[e],r=i[e],o=a[e];i[e]=s.x,a[e]=s.y,s.x=r,s.y=o}this.requestRendering()},A.computeObjectShifting=function(t,i){var e=["actors","regions","lights","animations","particles","parallaxes","tilemaps"];let a=0,n=0;for(const d of e)n+=this[d].length;var s=Math.clamp,r=new Array(n),o=new Float64Array(n),l=new Float64Array(n);for(const u of e){var c=this[u];const n=c.length;for(let e=0;e<n;e++){var h=c[e];r[a]=h,o[a]=s(h.x+t,-128,640),l[a]=s(h.y+i,-128,640),a++}}return{targets:r,posX:o,posY:l}},A.copy=function(){"open"===this.state&&null!==this.target&&this.list.copy(this.target)},A.paste=function(t,i){"open"===this.state&&null===this.dragging&&(void 0===t&&(t=this.meta.x,i=this.meta.y),this.list.paste("auto",e=>{switch(e.class){case"tilemap":case"actor":case"region":case"light":case"animation":case"particle":case"parallax":e.x=Math.clamp(Math.floor(t),0,this.width-1)+.5,e.y=Math.clamp(Math.floor(i),0,this.height-1)+.5}}))},A.create=function(e,t,i){var a=P.project.scene.defaultFolders[e],a=a?this.list.getItemByProperties({class:"folder",name:a}):null,e=this.inspectorTypeMap[e],e=j[e].create();e.x=t,e.y=i,this.list.addNodeTo(e,a)},A.delete=function(){"open"===this.state&&null!==this.target&&null===this.dragging&&this.list.delete(this.target)},A.undo=function(){"open"===this.state&&!this.dragging&&this.history.canUndo()&&this.history.restore("undo")},A.redo=function(){"open"===this.state&&!this.dragging&&this.history.canRedo()&&this.history.restore("redo")},A.setZoom=function(){const i=_("#scene-zoom");return function(t){if(this.zoom!==t){let e;switch(t){case 0:e=.25;break;case 1:e=.5;break;case 2:e=1;break;case 3:e=2;break;case 4:e=4;break;default:return}this.zoom=t,i.write(t),"open"===this.state?((t=this.zoomTimer).start=this.scale,t.end=e,t.elapsed=0,t.add()):this.scale=e}}}(),A.setSize=function(e,t){if(this.width!==e||this.height!==t){this.closeMapRecord(),this.planToSaveTerrains(),this.history.save({type:"scene-resize",editor:j.fileScene,width:this.width,height:this.height,terrains:this.terrains});var i=this.createTerrains(e,t),a=i.rowOffset,n=this.terrains,s=n.rowOffset,r=Math.min(e,this.width),o=Math.min(t,this.height);for(let t=0;t<o;t++)for(let e=0;e<r;e++){var l=e+t*s;i[e+t*a]=n[l]}this.terrains=i,this.width=e,this.height=t,this.resize(),this.requestRendering()}},A.setTileSize=function(e,t){this.tileWidth=e,this.tileHeight=t,this.resize(),this.requestRendering()},A.setTilemapSize=function(e,t,i){if(e.width!==t||e.height!==i){this.history.save({type:"scene-tilemap-resize",editor:j.sceneTilemap,tilemap:e,width:e.width,height:e.height,tiles:e.tiles,tilesetMap:e.tilesetMap});var a=this.createTiles(t,i),n=a.rowOffset,s=e.tiles,r=s.rowOffset,o=Math.min(t,e.width),l=Math.min(i,e.height);for(let t=0;t<l;t++)for(let e=0;e<o;e++){var c=e+t*r;a[e+t*n]=s[c]}e.tiles=a,e.width=t,e.height=i,e.changed=!0,this.marquee.resize()}},A.setTarget=function(e){var t;this.target!==e&&(null!==e&&null!==this.tilemap&&this.tilemap!==e&&this.closeTilemap(),this.target=e,this.updateTargetInfo(),this.updateTargetItem(),this.requestRendering(),e?(t=this.inspectorTypeMap[e.class],j.open(t,e)):j.close())},A.openTilemap=function(e){e instanceof Object&&this.tilemap!==e&&(this.closeTilemap(!1),this.tilemap=e,this.tilemap.element?.addClass("highlight"),0!==this.tilemap.shortcut&&Mt.elements[this.tilemap.shortcut].addClass("selected"),this.switchLayer("tilemap"),this.computeActiveTilemapId(),this.requestRendering(),this.marquee.resize())},A.closeTilemap=function(e=!0){null!==this.tilemap&&(this.tilemap.element?.removeClass("highlight"),0!==this.tilemap.shortcut&&Mt.elements[this.tilemap.shortcut].removeClass("selected"),this.tilemap=null,e)&&(this.switchLayer("object"),this.computeActiveTilemapId())},A.computeActiveTilemapId=function(){var e=this["tilemap"];switch(e?.layer){case"background":this.activeTilemapId=this.backgrounds.indexOf(e);break;case"foreground":this.activeTilemapId=131072|this.foregrounds.indexOf(e);break;case"object":this.activeTilemapId=65536|this.doodads.indexOf(e);break;default:this.activeTilemapId=-1}},A.revealTarget=function(){const n=new f({duration:200,update:e=>{var t=e["target"];if(t!==A.target)return e.target=null,!1;var t=u.EasingMap.easeInOut.map(e.elapsed/e.duration),i=e.startX*(1-t)+e.endX*t,e=e.startY*(1-t)+e.endY*t,t=A.screen,a=t.scrollLeft,n=t.scrollTop;A.updateCamera(i,e),A.updateTransform(),t.scrollLeft===a&&t.scrollTop===n||(A.requestRendering(),A.marquee.resize(),A.screen.updateScrollbars())},callback:e=>{e.target=null}});return function(){var{target:e,meta:t}=this,i=1/this.scaledTileWidth/this.scaleX,a=1/this.scaledTileHeight/this.scaleY;e&&!n.target&&(Math.abs(e.x-t.x)>i||Math.abs(e.y-t.y)>a)&&(n.target=e,n.startX=t.x,n.startY=t.y,n.endX=e.x,n.endY=e.y,n.elapsed=0,n.add())}}(),A.shiftTarget=function(e,t){var i,a,n,s,r,o=this.target,l=this.inspectorTypeMap[o?.class],l=j[l];void 0===l||o.x===e&&o.y===t||(this.planToSave(),a=(i=this.history).index,n=i.length,s=i[a],r="scene-target-shift",a===n-1&&void 0!==s&&s.type===r&&s.target===o||i.save({type:r,editor:l,target:o,x:o.x,y:o.y}),o.x=e,o.y=t,this.updateTargetInfo(),this.updateTargetEditor(),this.requestRendering())},A.redirectTarget=function(e){var t,i,a,n,s,r=this.target,o=this.inspectorTypeMap[r?.class],o=j[o];void 0!==o&&r.angle!==e&&(this.planToSave(),i=(t=this.history).index,a=t.length,n=t[i],s="scene-target-redirect",i===a-1&&void 0!==n&&n.type===s&&n.target===r||t.save({type:s,editor:o,target:r,angle:r.angle}),this.requestRendering(),r.angle=e,r.player.setAngle(Math.radians(e)),o.target===r)&&o.write({angle:e})},A.updateTarget=function(){let e=this.list.read();(e="folder"===e?.class?null:e)!==this.target&&this.setTarget(e)},A.updateTargetInfo=function(){if("object"===this.layer)switch(this.target?.class){case"tilemap":case"actor":case"region":case"light":case"animation":case"particle":case"parallax":var e=this.target,t=e.name,i=Math.floor(e.x),e=Math.floor(e.y);this.info.textContent=t+` ${i},`+e;break;default:var a,n,t=this.marquee,i=t.pointerevent;i instanceof PointerEvent&&({x:e,y:i}=this.getTileCoords(i,!0),a=this.width,n=this.height,0<=e)&&e<a&&0<=i&&i<n?e===t.x&&i===t.y&&t.visible||t.selectInObjectMode(e,i):t.clear()}},A.updateTargetItem=function(){var e,t=this["target"];null!==t&&(e=this["list"],e.read()!==t)&&(e.selectWithNoEvent(t),t)&&(e.expandToSelection(),e.scrollToSelection())},A.updateTargetEditor=function(){var e=this.target,t=this.inspectorTypeMap[e?.class],t=j[t];void 0!==t&&t.target===e&&t.write({x:e.x,y:e.y})},A.updateAnimationInterval=function(){var e=He.config.scene["animationInterval"];this.animationInterval!==e&&(0===e&&0!==this.animationFrame&&(this.animationFrame=0,this.requestRendering()),this.animationElapsed=0,this.animationInterval=e)},A.updateLightAreaExpansion=function(e){var t;this.showLight&&(t=He.config.lightArea,e.expansionLeft===t.expansionLeft&&e.expansionTop===t.expansionTop&&e.expansionRight===t.expansionRight&&e.expansionBottom===t.expansionBottom||(We.lightmap.innerWidth=0,We.lightmap.paddingLeft=void 0,We.resizeLightmap(),this.updateLightTexParameters(),this.updateTransform(),this.requestRendering()))},A.updateActorTeams=function(){var e=this.list;for(const t of this.actors)e.updateIcon(t)},A.updateHead=function(){var e,t,i,{page:a,head:n}=this;0!==a.clientWidth&&(a=x.getGroupOfElement(n)["nav"],i=a.rect(),t=(a=a.lastChild.rect()).right-i.left,n.left!==t&&(n.left=t,n.style.left=t+"px"),t=i.right-a.right,n.width!==t)&&(n.width=t,[a,t,n]=n.children,n.style.marginLeft="",a=a.rect(),t=t.rect(),t=(e=n.rect()).left-a.right-t.width,a=a.right-i.left-e.width,i=Math.min(t,a),n.style.marginLeft=i+"px")},A.resize=function(){var e,t,i,a,n,s,r,o,l,c,h;"open"===this.state&&0!==this.screen.clientWidth&&(t=this.scale,c=Math.round(this.padding*t),e=Math.round(this.tileWidth*t),t=Math.round(this.tileHeight*t),i=this.width*e,a=this.height*t,n=(s=CSS.getDevicePixelContentBoxSize(this.screen)).width,s=s.height,r=Math.max(n-i>>1,c),o=Math.max(s-a>>1,c),l=i+r+Math.max(n-i-r,c),c=a+o+Math.max(s-a-o,c),h=window.devicePixelRatio,this.scaleX=e/this.tileWidth,this.scaleY=t/this.tileHeight,this.scaledTileWidth=e,this.scaledTileHeight=t,this.aspectRatio=e/t,this.outerWidth=l,this.outerHeight=c,this.centerOffsetX=n<l?n/2:r+i/2,this.centerOffsetY=s<c?s/2:o+a/2,this.paddingLeft=r,this.paddingTop=o,this.marquee.style.width=l/h+"px",this.marquee.style.height=c/h+"px",We.resize(n,s),We.resizeLightmap(),this.updateLightTexParameters(),this.updateCamera(),this.updateTransform(),this.marquee.resize(),this.screen.updateScrollbars())},A.getTileCoords=function(){const c={x:0,y:0};return function(e,t=!1){var e=e.getRelativeCoords(this.marquee),i=this.scaledTileWidth,a=this.scaledTileHeight,n=window.devicePixelRatio;let s=e.x*n-this.paddingLeft,r=e.y*n-this.paddingTop,o=("tilemap"===this.layer&&(e=this.getGridContext(),s-=e.offsetX*this.scaleX,r-=e.offsetY*this.scaleY),s/i),l=r/a;return t&&(o=Math.floor(o),l=Math.floor(l)),c.x=o,c.y=l,c}}(),A.getConvertedCoords=function(){const t={x:0,y:0};return e=>(t.x=e.x*A.tileWidth,t.y=e.y*A.tileHeight,t)}(),A.getParallaxAnchor=function(){const l={x:0,y:0};return function(e,t=!1){var i=this.tileWidth,a=this.tileHeight,n=this.scrollCenterX,s=this.scrollCenterY,r=e.x*i,o=e.y*a,r=n+e.parallaxFactorX*(r-n),n=s+e.parallaxFactorY*(o-s);return t?(l.x=r/i,l.y=n/a):(l.x=r,l.y=n),l}}(),A.getGridContext=function(){const l={width:0,height:0,offsetX:0,offsetY:0};return function(){var e,t,i,a,n,s,r,o;return"tilemap"===this.layer?(o=this.tilemap,e=this.getParallaxAnchor(o),r=this.tileWidth,t=this.tileHeight,i=o.width,a=o.height,n=o.offsetX,s=o.offsetY,r=o.anchorX*i*r,o=o.anchorY*a*t,l.width=i,l.height=a,l.offsetX=e.x-r+n,l.offsetY=e.y-o+s):(l.width=this.width,l.height=this.height,l.offsetX=0,l.offsetY=0),l}}(),A.rasterizeScrollPosition=function(){const l={left:0,top:0,right:0,bottom:0};return function(e,t){var i=this.scaleX,a=this.scaleY,n=this.scrollLeft,s=this.scrollTop,r=this.scrollRight,o=this.scrollBottom;return l.left=Math.round((n+e)*i)/i,l.top=Math.round((s+t)*a)/a,l.right=l.left+r-n,l.bottom=l.top+o-s,l}}(),A.updateLightTexParameters=function(){var e,t,i,a,n,s,r,o,l,c=He.config.lightArea,h=We.lightmap,d=this.scaleX,u=this.scaleY;h.scaleX===d&&h.scaleY===u||(h.scaleX=d,h.scaleY=u,{ceil:l,min:e}=Math,t=h.paddingLeft,i=h.paddingTop,a=h.paddingRight,n=h.paddingBottom,s=l(e(c.expansionLeft*d,t)),r=l(e(c.expansionTop*u,i)),o=l(e(c.expansionRight*d,a)),l=l(e(c.expansionBottom*u,n)),h.expansionLeft=s/d,h.expansionTop=r/u,h.expansionRight=o/d,h.expansionBottom=l/u,h.maxExpansionLeft=t/d,h.maxExpansionTop=i/u,h.maxExpansionRight=a/d,h.maxExpansionBottom=n/u,h.clipX=t-s,h.clipY=i-r,h.clipWidth=We.width+s+o,h.clipHeight=We.height+r+l)},A.updateCamera=function(e=this.meta.x,t=this.meta.y){var i=window.devicePixelRatio,a=this.screen,e=e*this.scaledTileWidth+this.paddingLeft,t=t*this.scaledTileHeight+this.paddingTop,n=1e-4*this.scaledTileWidth,s=1e-4*this.scaledTileHeight;a.rawScrollLeft=Math.clamp(e-this.centerOffsetX,0,this.outerWidth-We.width)/i,a.rawScrollTop=Math.clamp(t-this.centerOffsetY,0,this.outerHeight-We.height)/i,a.scrollLeft=(e-(We.width>>1)+n)/i,a.scrollTop=(t-(We.height>>1)+s)/i},A.updateTransform=function(){var e=window.devicePixelRatio,t=this.screen,i=Math.roundTo(t.scrollLeft*e-this.paddingLeft,4),a=Math.roundTo(t.scrollTop*e-this.paddingTop,4),n=i+We.width,s=a+We.height,r=this.scaleX,o=this.scaleY,l=We.lightmap,i=(this.scrollLeft=i/r,this.scrollTop=a/o,this.scrollRight=n/r,this.scrollBottom=s/o,this.scrollCenterX=(this.scrollLeft+this.scrollRight)/2,this.scrollCenterY=(this.scrollTop+this.scrollBottom)/2,this.lightLeft=this.scrollLeft-l.expansionLeft,this.lightTop=this.scrollTop-l.expansionTop,this.lightRight=this.scrollRight+l.expansionRight,this.lightBottom=this.scrollBottom+l.expansionBottom,this.matrix.reset().scale(r,o).translate(-this.scrollLeft,-this.scrollTop),t.rawScrollLeft*e+this.centerOffsetX),a=t.rawScrollTop*e+this.centerOffsetY;this.meta.x=Math.roundTo((i-this.paddingLeft)/this.scaledTileWidth,4),this.meta.y=Math.roundTo((a-this.paddingTop)/this.scaledTileHeight,4),He.manifest.changed=!0},A.setPresetId=function(e){let t;for(;(t=X.generate64bit())in A.presets;);e.presetId=t,A.presets[t]=e},A.loadPresets=function(){const n=e=>{var t=A["presets"];for(const a of e){var i=a["presetId"];void 0!==i?t[i]=a:n(a.children)}};return function(){n(this.objects)}}(),A.sortLayers=function(){const e=(e,t)=>e.order-t.order;return function(){this.backgrounds.sort(e),this.foregrounds.sort(e),this.doodads.sort(e)}}(),A.loadObjects=function(){const t=this.actors,i=this.regions,a=this.lights,n=this.animations,s=this.particles,r=this.parallaxes,o=this.tilemaps,l=this.backgrounds,c=this.foregrounds,h=this.doodads;let d=0,u=0,p=0,m=0,g=0,f=0,v=0,b=0,y=0,w=0;const x={background:e=>{l[b++]=e},foreground:e=>{c[y++]=e},object:e=>{h[w++]=e}},k={folder:e=>T(e.children),actor:e=>t[u++]=e,region:e=>i[p++]=e,light:e=>a[m++]=e,animation:e=>n[g++]=e,particle:e=>s[v++]=e,parallax:e=>{r[f++]=e,x[e.layer](e)},tilemap:e=>{o[d++]=e,x[e.layer](e)}},T=t=>{var i=t.length;for(let e=0;e<i;e++){var a=t[e];k[a.class](a)}};T(this.objects),o.length!==d&&(o.length=d),t.length!==u&&(t.length=u),i.length!==p&&(i.length=p),a.length!==m&&(a.length=m),n.length!==g&&(n.length=g),s.length!==v&&(s.length=v),r.length!==f&&(r.length=f),l.length!==b&&(l.length=b),c.length!==y&&(c.length=y),h.length!==w&&(h.length=w),this.sortLayers(),this.computeActiveTilemapId()},A.loadTextures=async function(){if("closed"!==this.state){var t=[],i=this.textures,a=He.tilesets,n=He.autotiles.map;for(const u of this.tilemaps){var{tiles:s,tilesetMap:r}=u,o=s.length;for(let e=0;e<o;e++){var l=s[e];if(0!==l){var c=a[r[l>>24]];if(void 0!==c)switch(c.type){case"normal":var h=c.image;void 0===i[h]&&t.push(i.load(h));break;case"auto":var h=(l>>8&255)+(l>>16&255)*c.width,d=c.tiles[h];d&&void 0===i[d.image]&&void 0!==n[d.template]&&t.push(i.load(d.image))}}}}var e=this.symbol=Symbol();0<t.length&&await Promise.all(t),this.symbol===e&&(this.symbol=null,this.state="open",this.body.show(),this.resize(),this.requestAnimation(),this.requestRendering(),0===O.frames.length)&&document.activeElement===document.body&&this.screen.focus()}},A.loadAllContexts=function(){for(const e of this.actors)this.loadActorContext(e);for(const t of this.lights)this.loadLightContext(t);for(const i of this.animations)this.loadAnimationContext(i);for(const a of this.particles)this.loadParticleContext(a);for(const n of this.parallaxes)this.loadParallaxContext(n)},A.loadActorContext=function(e){e.player&&(e.player.destroy(),delete e.player);var t=e.actorId,t=He.actors[t];if(void 0!==t){Object.defineProperty(e,"data",{configurable:!0,value:t});var i=t["animationId"],i=He.animations[i];if(void 0!==i){var i=new Ke.Player(i),a={},n=t.sprites,s=n.length;for(let e=0;e<s;e++){var r=n[e];a[r.name]=r.image}return i.angle=Math.radians(e.angle),i.setSpriteImages(a),i.setMotion(t.idleMotion),void Object.defineProperty(e,"player",{configurable:!0,value:i})}}Object.defineProperty(e,"player",{configurable:!0,value:this.createDefaultAnimation(e)})},A.loadLightContext=function(e){Object.defineProperty(e,"instance",{configurable:!0,value:new At(e)})},A.loadAnimationContext=function(e){e.player&&(e.player.destroy(),delete e.player);var t=e.animationId,t=He.animations[t];void 0!==t?(Object.defineProperty(e,"data",{configurable:!0,value:t}),(t=new Ke.Player(t)).setMotion(e.motion),t.setAngle(Math.radians(e.angle)),Object.defineProperty(e,"player",{configurable:!0,value:t})):Object.defineProperty(e,"player",{configurable:!0,value:this.createDefaultAnimation(e)})},A.loadParallaxContext=function(e){e.player&&(e.player.destroy(),delete e.player),Object.defineProperty(e,"player",{configurable:!0,value:new St(e)})},A.loadParticleContext=function(e){e.emitter&&(e.emitter.destroy(),delete e.emitter);var t=He.particles[e.particleId];void 0!==t&&((t=new S.Emitter(t)).scale=e.scale,t.speed=e.speed,Object.defineProperty(e,"emitter",{configurable:!0,value:t}))},A.loadObjectContext=function(e){switch(e.class){case"actor":this.loadActorContext(e);break;case"light":this.loadLightContext(e);break;case"animation":this.loadAnimationContext(e);break;case"particle":this.loadParticleContext(e);break;case"parallax":this.loadParallaxContext(e)}},A.reloadObjectContext=function(e){switch(e.class){case"folder":for(const t of e.children)this.reloadObjectContext(t);break;case"actor":this.loadActorContext(e);break;case"animation":this.loadAnimationContext(e);break;case"particle":this.loadParticleContext(e);break;case"parallax":this.loadParallaxContext(e);break;case"tilemap":0!==e.shortcut&&this.tilemaps.shortcuts.update()}},A.destroyObjectContext=function(e){switch(e.class){case"folder":for(const t of e.children)this.destroyObjectContext(t);break;case"actor":case"animation":e.player.destroy(),delete e.player;break;case"particle":e.emitter?.destroy(),delete e.emitter;break;case"parallax":e.player.destroy(),delete e.player;break;case"tilemap":this.tilemap===e&&this.closeTilemap(),0!==e.shortcut&&this.tilemaps.shortcuts.update()}},A.updateParallaxes=function(e){for(const t of this.parallaxes)t.hidden||t.player.update(e)},A.drawScene=function(){if(We.width*We.height!=0)switch(this.layer){case"object":this.drawLightLayer(),this.drawBackgrounds(),this.drawRegionLayer(),this.drawStartPosition(),this.drawGridLayer(),this.drawAnimationWireframe(),this.drawObjectLayer(),this.drawForegrounds(),this.drawParticles(),this.drawRegionBorders(),this.drawRegionWireframe(),this.drawLightWireframe(),this.drawAnimationAnchor(),this.drawParticleEmitterWireframe(),this.drawTilemapWireframe(),this.drawParallaxWireframe(),this.drawNameLayer();break;case"tilemap":this.drawLightLayer(),this.drawBackgrounds(),this.drawObjectLayer(),this.drawForegrounds(),We.alpha=.25,this.drawParticles(),this.drawTilePreview(),We.alpha=1,this.drawGridLayer(),this.drawTileMarquee();break;case"terrain":this.drawLightLayer(),this.drawBackgrounds(),this.drawObjectLayer(),this.drawForegrounds(),this.drawParticles(),this.drawGridLayer(),this.drawTerrainLayer(),this.drawTerrainMarquee()}},A.drawBackgrounds=function(){We.clearColor(...this.background.getGLRGBA()),We.clear(We.COLOR_BUFFER_BIT);var t=this.activeTilemapId,i=this.backgrounds,a=i.length;for(let e=0;e<a;e++){var n=i[e];if(!n.hidden||e===t)switch(n.class){case"parallax":n.player.draw(e);continue;case"tilemap":this.drawTilemap(n,e);continue}}We.alpha=1},A.drawForegrounds=function(){var t=this.activeTilemapId,i=this.foregrounds,a=i.length;for(let e=0;e<a;e++){var n=i[e],s=131072|e;if(!n.hidden||s===t)switch(n.class){case"parallax":n.player.draw(s);continue;case"tilemap":this.drawTilemap(n,s);continue}}We.alpha=1},A.updateAnimations=function(t){var e=We.lightmap,i=He.config.animationArea,a=this.scrollLeft-i.expansionLeft,n=this.scrollTop-i.expansionTop,s=this.scrollRight+i.expansionRight,r=this.scrollBottom+i.expansionBottom,o=this.scrollLeft-e.maxExpansionLeft,l=this.scrollTop-e.maxExpansionTop,c=this.scrollRight+e.maxExpansionRight-o,h=this.scrollBottom+e.maxExpansionBottom-l,d=this["showAnimation"],{actors:u,animations:p}=this;for(let e=0;e<2;e++){var m=0===e?u:p,g=m.length;for(let e=0;e<g;e++){var f,v,b=m[e];b.hidden||null!==(f=b.player).motion&&(f.update(t),{x:b,y:v}=this.getConvertedCoords(b),a<=b&&b<s&&n<=v&&v<r?(f.setPosition(b,v),f.computeIndex(),f.updateFrameParameters(f.contexts,f.index),f.anchorX=(b-o)/c,f.anchorY=(v-l)/h,f.visible=!0,d&&(f.emitParticles(t),f.updateParticles(t))):(f.visible=!1,d&&0!==f.emitters.length&&f.updateParticles(t)))}}},A.updateParticles=function(t){if(this.showAnimation){var i=this.particles,a=i.length;for(let e=0;e<a;e++){var n,s=i[e];s.hidden||void 0!==(n=s.emitter)&&(s=this.getConvertedCoords(s),n.startX=s.x,n.startY=s.y,n.update(t))}}},A.drawParticles=function(){if(this.showAnimation){var t=this.particles,i=t.length;for(let e=0;e<i;e++){var a=t[e];a.hidden||a.emitter?.draw()}}},A.drawTilemap=function(e,t){let i,a;var n=this.activeTilemapId,n=(-1===n||t===n?(i="upper",a=1):t<n?(i="lower",a=1):n<t&&(i="upper",a=.25),this.getParallaxAnchor(e)),t=this.tileWidth,s=this.tileHeight,t=e.width*t,s=e.height*s,t=e.anchorX*t,s=e.anchorY*s,t=n.x-t+e.offsetX,n=n.y-s+e.offsetY;return this.drawTileLayer(i,e.light,e.blend,e.opacity*a,e.tilesetMap,e.tiles,t,n)},A.drawTilePreview=function(){var i=this.marquee;if(i.visible&&i.previewTiles){var a=i.tilesetMap,n=i.tiles,i=this.getConvertedCoords(i);let e=i.x,t=i.y;"tilemap"===this.layer&&(i=this.getGridContext(),e+=i.offsetX,t+=i.offsetY),this.drawTileLayer("upper","global","normal",.6,a,n,e,t),We.alpha=1}},A.drawTileLayer=function(N,q,D,_,O,e,t,i){var a=We,n=a.arrays[0].float32,s=a.batchRenderer.push,r=a.batchRenderer.response,o=this.textures,l=e.width,Y=e.height,j=e.rowOffset,c=this.tileWidth,h=this.tileHeight,X=He.tilesets,G=He.autotiles.map,t=this.rasterizeScrollPosition(-t,-i);const d=t.left,u=t.top,p=t.right,m=t.bottom;var i=He.config.tileArea,t=d-i.expansionLeft,g=u-i.expansionTop,f=p+i.expansionRight,i=m+i.expansionBottom,V=Math.max(Math.floor(t/c),0),t=Math.max(Math.floor(g/h),0),W=Math.min(Math.ceil(f/c),l),H=Math.min(Math.ceil(i/h),Y);a.batchRenderer.setAttrSize(0),a.batchRenderer.setBlendMode(D);for(let a=t;a<H;a++)for(let i=V;i<W;i++){var v=e[i+a*j];if(0!==v){var b=X[O[v>>24]];if(void 0!==b)switch(b.type){case"normal":var y=o[b.image];if(y instanceof $e){s(y.base.index);var w=b.tileWidth,x=b.tileHeight,k=(v>>8&255)*w,T=(v>>16&255)*x,I=i*c+(c-w)/2+b.globalOffsetX,C=a*h+(h-x)+b.globalOffsetY,E=I+w,M=C+x;let e=(.002+k)/y.width,t=(k+w-.002)/y.width;1&v&&(k=e,e=t,t=k);const u=(.002+T)/y.height,m=(T+x-.002)/y.height;w=5*r[0],k=r[1];n[w]=I,n[1+w]=C,n[2+w]=e,n[3+w]=u,n[4+w]=k,n[5+w]=I,n[6+w]=M,n[7+w]=e,n[8+w]=m,n[9+w]=k,n[10+w]=E,n[11+w]=M,n[12+w]=t,n[13+w]=m,n[14+w]=k,n[15+w]=E,n[16+w]=C,n[17+w]=t,n[18+w]=u,n[19+w]=k}else void 0===y&&(T=b.image,(x=Ue.images[T])instanceof Image?(o.append(new $e(x)),i--):o.load(T));break;case"auto":I=(v>>8&255)+(v>>16&255)*b.width,M=b.tiles[I];if(M){E=G[M.template];if(void 0!==E){C=E.nodes[63&v];if(void 0!==C){w=o[M.image];if(w instanceof $e){s(w.base.index);var k=this.animationFrame%C.frames.length,y=C.frames[k],S=b.tileWidth,A=b.tileHeight,P=(M.x+(255&y))*S,L=(M.y+(y>>8))*A,R=i*c+(c-S)/2+b.globalOffsetX,F=a*h+(h-A)+b.globalOffsetY,z=R+S,K=F+A;const d=(.002+P)/w.width,u=(.002+L)/w.height,p=(P+S-.002)/w.width,m=(L+A-.002)/w.height;P=5*r[0],S=r[1];n[P]=R,n[1+P]=F,n[2+P]=d,n[3+P]=u,n[4+P]=S,n[5+P]=R,n[6+P]=K,n[7+P]=d,n[8+P]=m,n[9+P]=S,n[10+P]=z,n[11+P]=K,n[12+P]=p,n[13+P]=m,n[14+P]=S,n[15+P]=z,n[16+P]=F,n[17+P]=p,n[18+P]=u,n[19+P]=S}else void 0===w&&(L=M.image,(A=Ue.images[L])instanceof Image?(o.append(new $e(A)),i--):o.load(L))}}}}}}g=a.batchRenderer.getEndIndex();if(0!==g){a.alpha=_;var B=a.tileProgram.use(),f=this.tilemapLightSamplingModes[this.showLight?q:"raw"],l=a.matrix.project(a.flip,p-d,m-u).translate(-d,-u);switch(N){case"upper":a.uniform1i(B.u_TintMode,0);break;case"lower":a.uniform1i(B.u_TintMode,1),a.uniform4f(B.u_Tint,-.2,-.2,-.2,.8)}a.bindVertexArray(B.vao),a.uniformMatrix3fv(B.u_Matrix,!1,l),a.uniform1i(B.u_LightMode,f),a.bufferData(a.ARRAY_BUFFER,n,a.STREAM_DRAW,0,5*g),a.batchRenderer.draw()}},A.drawGridLayer=function(){if(this.showGrid&&this.width*this.height){var e=We,i=e.arrays[0].float32,a=this.getGridContext(),n=a.width,s=a.height,r=a.offsetX,a=a.offsetY,o=this.tileWidth,l=this.tileHeight,r=this.rasterizeScrollPosition(-r,-a),a=r.left,c=r.top,h=r.right,r=r.bottom,d=.5/this.scaleX/o,u=.5/this.scaleY/l,p=Math.max(Math.ceil(a/o),0),m=Math.max(Math.ceil(c/l),0),g=Math.min(Math.ceil(h/o),n+1),f=Math.min(Math.ceil(r/l),s+1),v=Math.max(Math.floor(a/o),0),b=Math.max(Math.floor(c/l),0),y=Math.min(g,n+1/this.scaleX/o),w=Math.min(f,s+1/this.scaleY/l);let t=0;for(let e=m;e<f;e++)i[t]=v,i[t+1]=e+u,i[t+2]=y,i[t+3]=e+u,t+=4;for(let e=p;e<g;e++)i[t]=e+d,i[t+1]=b,i[t+2]=e+d,i[t+3]=w,t+=4;0!==t&&(n=e.graphicProgram.use(),e.matrix.project(e.flip,h-a,r-c).translate(-a,-c).scale(o,l),e.bindVertexArray(n.vao.a10),e.uniformMatrix3fv(n.u_Matrix,!1,e.matrix),e.bufferData(e.ARRAY_BUFFER,i,e.STREAM_DRAW,0,t),e.vertexAttrib4f(n.a_Color,1,1,1,.5),e.drawArrays(e.LINES,0,t/2))}},A.drawRegionLayer=function(){var e=We,t=e.arrays[0].float32,i=e.arrays[0].uint32,a=this.tileWidth,n=this.tileHeight,s=this.scrollLeft,r=this.scrollTop,o=this.scrollRight,l=this.scrollBottom,c=this.regions,h=c.length,d=c.visibleList;let u=0,p=0;for(let e=0;e<h;e++){var m,g,f,v,b,y=c[e];y.hidden||(f=y.x,v=y.y,f=(m=f-(f=y.width)/2)+f,v=(g=v-(v=y.height)/2)+v,m*a<o&&g*n<l&&s<f*a&&r<v*n&&(b=y.color,b=parseInt(b.slice(0,2),16)|parseInt(b.slice(2,4),16)<<8|parseInt(b.slice(4,6),16)<<16|parseInt(b.slice(6,8),16)<<24,d[u++]=y,t[p]=m,t[p+1]=g,i[p+2]=b,t[p+3]=m,t[p+4]=v,i[p+5]=b,t[p+6]=f,t[p+7]=v,i[p+8]=b,t[p+9]=f,t[p+10]=g,i[p+11]=b,p+=12))}var w,x=d.count;for(let e=u;e<x;e++)d[e]=void 0;d.count=u,0!==p&&(w=e.graphicProgram.use(),e.matrix.project(e.flip,o-s,l-r).translate(-s,-r).scale(a,n),e.bindVertexArray(w.vao),e.uniformMatrix3fv(w.u_Matrix,!1,e.matrix),e.bufferData(e.ARRAY_BUFFER,t,e.STREAM_DRAW,0,p),e.drawElements(e.TRIANGLES,p/2,e.UNSIGNED_INT,0))},A.drawRegionBorders=function(){var e=We,t=e.arrays[0].float32,i=this.tileWidth,a=this.tileHeight,n=this.scrollLeft,s=this.scrollTop,r=this.scrollRight,o=this.scrollBottom,l=.5/this.scaleX/i,c=.5/this.scaleY/a,h=this.regions.visibleList,d=h.count;let u=0;for(let e=0;e<d;e++){var p=h[e],m=p.x,g=p.y,f=p.width,p=p.height,m=m-f/2+l,g=g-p/2+c,f=m+f,p=g+p;t[u]=m,t[u+1]=g,t[u+2]=m,t[u+3]=p,t[u+4]=m,t[u+5]=p,t[u+6]=f,t[u+7]=p,t[u+8]=f,t[u+9]=p,t[u+10]=f,t[u+11]=g,t[u+12]=f,t[u+13]=g,t[u+14]=m,t[u+15]=g,u+=16}var v,b,y,w=He.config["startPosition"];w.sceneId===this.meta.guid&&(b=1+(v=w.x-.5+l),y=1+(w=w.y-.5+c),t[u]=v,t[u+1]=w,t[u+2]=v,t[u+3]=y,t[u+4]=v,t[u+5]=y,t[u+6]=b,t[u+7]=y,t[u+8]=b,t[u+9]=y,t[u+10]=b,t[u+11]=w,t[u+12]=b,t[u+13]=w,t[u+14]=v,t[u+15]=w,u+=16),0!==u&&(y=e.graphicProgram.use(),e.matrix.project(e.flip,r-n,o-s).translate(-n,-s).scale(i,a),e.bindVertexArray(y.vao.a10),e.uniformMatrix3fv(y.u_Matrix,!1,e.matrix),e.bufferData(e.ARRAY_BUFFER,t,e.STREAM_DRAW,0,u),e.vertexAttrib4f(y.a_Color,1,1,1,1),e.drawArrays(e.LINES,0,u/2))},A.drawObjectLayer=function(){var{max:a,min:n,floor:N,ceil:q,round:s}=Math,D=this.activeTilemapId,_=-1!==D&&D<131072,O=_?.25:1,e=We,Y=this.showLight?Ke.Player.lightSamplingModes:this.defaultLightSamplingModes,j=this.blendModeMap,r=this.textures,X=He.tilesets,G=He.autotiles.map,V=He.config.tileArea,t=We.lightmap,W=this.tileWidth,o=this.tileHeight;const l=this.scrollLeft,c=this.scrollTop,H=this.scrollRight,K=this.scrollBottom;var U=l-t.maxExpansionLeft,$=c-t.maxExpansionTop,Z=H+t.maxExpansionRight-U,J=K+t.maxExpansionBottom-$,Q=o/2/J,ee=e.layers,h=e.zeros,d=e.arrays[1].uint32,u=e.arrays[2].uint32,p=e.arrays[3].float32,m=e.arrays[3].uint32;let g=0,f=2,v=0;var te=this.doodads;const ie=te.length;for(let e=0;e<ie;e++){var b=te[e],ae=(65536|e)===D;if(!b.hidden||ae){var ne=b.tilesetMap,se=b.tiles,re=se.width,oe=se.height,le=se.rowOffset,ce=this.getParallaxAnchor(b),he=b.anchorX*re*W,y=b.anchorY*oe*o,he=ce.x-he+b.offsetX,ce=ce.y-y+b.offsetY,y=this.rasterizeScrollPosition(-he,-ce),he=y.left-V.expansionLeft,ce=y.top-V.expansionTop,de=y.right+V.expansionRight,ue=y.bottom+V.expansionBottom,pe=l-y.left,me=c-y.top,ge=a(N(he/W),0),y=a(N(ce/o),0),fe=n(q(de/W),re),ve=n(q(ue/o),oe);let i=b.opacity;_&&!ae&&(i/=4),i=Math.round(255*i)<<8;for(let t=y;t<ve;t++)for(let e=ge;e<fe;e++){var w=se[e+t*le];if(0!==w){var x=X[ne[w>>24]];if(void 0!==x)switch(x.type){case"normal":var k,be,T=r[x.image];T instanceof $e?(S=(C=w>>8&255)+(E=w>>16&255)*x.width,S=x.priorities[S]+x.globalPriority,I=C*(C=x.tileWidth),we=E*(E=x.tileHeight),M=(e+.5)*W+pe,k=(t+1)*o+me,R=(be=M-C/2+x.globalOffsetX)+C,ye=(Me=k-E+x.globalOffsetY)+E,M=(M-U)/Z,S=a(0,n(262143,s(131072*(k=(k-$+S*o)/J)+65536))),M=s(65535*a(n(M,1),0))|s(65535*a(n(k-Q,1),0))<<16,p[v]=T.base.index,p[v+1]=be,p[v+2]=Me,p[v+3]=R,p[v+4]=ye,p[v+5]=(.002+I)/T.width,p[v+6]=(.002+we)/T.height,p[v+7]=(I+C-.002)/T.width,p[v+8]=(we+E-.002)/T.height,m[v+9]=M,m[v+10]=i,m[v+11]=Y[b.light],m[v+12]=j[b.blend],1&w&&(p[v+9]=p[v+5],p[v+5]=p[v+7],p[v+7]=p[v+9]),0===h[S]?(h[S]=f,ee[g++]=S):u[d[S]+1]=f,d[S]=f,u[f++]=v,u[f++]=0,v+=13):void 0===T&&(k=x.image,(be=Ue.images[k])instanceof Image?(r.append(new $e(be)),e--):r.load(k));break;case"auto":var ye,I,C,we,E,M,S,xe,ke,Te,Ie,Ce,A,P,L,Ee,Me=(w>>8&255)+(w>>16&255)*x.width,R=x.tiles[Me];R&&void 0!==(ye=G[R.template])&&void 0!==(I=ye.nodes[63&w])&&((C=r[R.image])instanceof $e?(we=this.animationFrame%I.frames.length,E=I.frames[we],M=x.priorities[Me]+x.globalPriority,S=x.tileWidth,T=x.tileHeight,xe=(R.x+(255&E))*S,ke=(R.y+(E>>8))*T,P=(e+.5)*W+pe,L=(t+1)*o+me,Ie=(Ee=P-S/2+x.globalOffsetX)+S,Ce=(Te=L-T+x.globalOffsetY)+T,P=(P-U)/Z,A=a(0,n(262143,s(131072*(L=(L-$+M*o)/J)+65536))),P=s(65535*a(n(P,1),0))|s(65535*a(n(L-Q,1),0))<<16,p[v]=C.base.index,p[v+1]=Ee,p[v+2]=Te,p[v+3]=Ie,p[v+4]=Ce,p[v+5]=(.002+xe)/C.width,p[v+6]=(.002+ke)/C.height,p[v+7]=(xe+S-.002)/C.width,p[v+8]=(ke+T-.002)/C.height,m[v+9]=P,m[v+10]=i,m[v+11]=Y[b.light],m[v+12]=j[b.blend],0===h[A]?(h[A]=f,ee[g++]=A):u[d[A]+1]=f,d[A]=f,u[f++]=v,u[f++]=0,v+=13):void 0===C&&(L=R.image,(Ee=Ue.images[L])instanceof Image?(r.append(new $e(Ee)),e--):r.load(L)))}}}}}var Se=this.actors,Ae=this.animations;for(let e=0;e<2;e++){var Pe=e+1<<16,Le=0===e?Se:Ae;const ie=Le.length;for(let e=0;e<ie;e++){var i=Le[e];i.hidden||(i=i.player).visible&&(i=a(0,n(262143,s(131072*i.anchorY+65536))),p[v]=e|Pe,0===h[i]?(h[i]=f,ee[g++]=i):u[d[i]+1]=f,d[i]=f,u[f++]=v,u[f++]=0,v+=1)}}if(0!==g){var F=e.arrays[0].float32,z=e.arrays[0].uint32,Re=e.batchRenderer.setBlendMode,Fe=e.batchRenderer.push,ze=e.batchRenderer.response,t=e.spriteProgram.use(),Be=e.matrix.project(e.flip,H-l,K-c).translate(-l,-c),Ne=(D<131072?e.uniform4f(t.u_Tint,0,0,0,0):e.uniform4f(t.u_Tint,-.2,-.2,-.2,.8),e.batchRenderer.bindProgram(),e.batchRenderer.setAttrSize(8),e.bindVertexArray(t.vao),e.uniformMatrix3fv(t.u_Matrix,!1,Be),new Uint32Array(ee.buffer,0,g).sort());for(let t=0;t<g;t++){var qe=Ne[t];let e=h[qe];h[qe]=0;do{const v=u[e];var De=p[v];if(De<65536){Re(j[m[v+12]]),Fe(De);var _e=p[v+1],Oe=p[v+2],Ye=p[v+3],je=p[v+4];const l=p[v+5],c=p[v+6],H=p[v+7],K=p[v+8];var Xe=m[v+9],Ge=m[v+10],Ve=m[v+11]<<16,B=8*ze[0],Ge=ze[1]|Ge|Ve;F[B]=_e,F[1+B]=Oe,F[2+B]=l,F[3+B]=c,z[4+B]=Ge,z[5+B]=16711935,z[6+B]=16711935,z[7+B]=Xe,F[8+B]=_e,F[9+B]=je,F[10+B]=l,F[11+B]=K,z[12+B]=Ge,z[13+B]=16711935,z[14+B]=16711935,z[15+B]=Xe,F[16+B]=Ye,F[17+B]=je,F[18+B]=H,F[19+B]=K,z[20+B]=Ge,z[21+B]=16711935,z[22+B]=16711935,z[23+B]=Xe,F[24+B]=Ye,F[25+B]=Oe,F[26+B]=H,F[27+B]=c,z[28+B]=Ge,z[29+B]=16711935,z[30+B]=16711935,z[31+B]=Xe}else(De<131072?Se:Ae)[65535&De].player.draw(O)}while(0!==(e=u[e+1]))}e.batchRenderer.draw(),e.batchRenderer.unbindProgram(),e.blend="normal"}},A.drawNameLayer=function(){var e,t,i,a,n,s,r;this.target?.name&&(e=We,r=this.scrollLeft*this.scaleX,t=this.scrollTop*this.scaleY,s=this.scaledTileWidth,i=this.scaledTileHeight,a=We.context2d.size,s=(n=this.target).x*s-r,r=n.y*i-t-a-8,e.fillTextWithOutline(n.name,s,r,4294967295,2147483648))},A.drawTerrainLayer=function(){var e=We,i=e.arrays[0].float32,a=this.terrains,n=a.rowOffset,t=this.width,s=this.height,r=this.tileWidth,o=this.tileHeight,l=this.scrollLeft,c=this.scrollTop,h=this.scrollRight,d=this.scrollBottom,u=Math.max(Math.floor(l/r),0),p=Math.max(Math.floor(c/o),0),m=Math.min(Math.ceil(h/r),t),g=Math.min(Math.ceil(d/o),s);let f=0,v=!1;for(let t=p;t<g;t++){for(let e=u;e<m;e++)2===a[e+t*n]?v||(v=!0,i[f]=e,i[f+1]=t,i[f+2]=e,i[f+3]=t+1):v&&(v=!1,i[f+4]=e,i[f+5]=t+1,i[f+6]=e,i[f+7]=t,f+=8);v&&(v=!1,i[f+4]=m,i[f+5]=t+1,i[f+6]=m,i[f+7]=t,f+=8)}t=f;for(let t=p;t<g;t++){for(let e=u;e<m;e++)1===a[e+t*n]?v||(v=!0,i[f]=e,i[f+1]=t,i[f+2]=e,i[f+3]=t+1):v&&(v=!1,i[f+4]=e,i[f+5]=t+1,i[f+6]=e,i[f+7]=t,f+=8);v&&(v=!1,i[f+4]=m,i[f+5]=t+1,i[f+6]=m,i[f+7]=t,f+=8)}var s=f,b=.5/this.scaleX/r,y=.5/this.scaleY/o;for(let t=p;t<=g;t++){for(let e=u;e<m;e++){var w=e+t*n;(t<g&&2===a[w]?0===t||2!==a[w-n]:0!==t&&2===a[w-n])?v||(v=!0,i[f]=e,i[f+1]=t+y):v&&(v=!1,i[f+2]=e+2*b,i[f+3]=t+y,f+=4)}v&&(v=!1,i[f+2]=m+2*b,i[f+3]=t+y,f+=4)}for(let t=u;t<=m;t++){for(let e=p;e<g;e++){var x=t+e*n;(t<m&&2===a[x]?0===t||2!==a[x-1]:0!==t&&2===a[x-1])?v||(v=!0,i[f]=t+b,i[f+1]=e):v&&(v=!1,i[f+2]=t+b,i[f+3]=e+2*y,f+=4)}v&&(v=!1,i[f+2]=t+b,i[f+3]=g+2*y,f+=4)}var k,T=f;for(let t=p;t<=g;t++){for(let e=u;e<m;e++){var I=e+t*n;(t<g&&1===a[I]?0===t||0===a[I-n]:0!==t&&1===a[I-n])?v||(v=!0,i[f]=e,i[f+1]=t+y):v&&(v=!1,i[f+2]=e+2*b,i[f+3]=t+y,f+=4)}v&&(v=!1,i[f+2]=m+2*b,i[f+3]=t+y,f+=4)}for(let t=u;t<=m;t++){for(let e=p;e<g;e++){var C=t+e*n;(t<m&&1===a[C]?0===t||0===a[C-1]:0!==t&&1===a[C-1])?v||(v=!0,i[f]=t+b,i[f+1]=e):v&&(v=!1,i[f+2]=t+b,i[f+3]=e+2*y,f+=4)}v&&(v=!1,i[f+2]=t+b,i[f+3]=g+2*y,f+=4)}0!==f&&(k=e.graphicProgram.use(),e.matrix.project(e.flip,h-l,d-c).translate(-l,-c).scale(r,o),e.bindVertexArray(k.vao.a10),e.uniformMatrix3fv(k.u_Matrix,!1,e.matrix),e.bufferData(e.ARRAY_BUFFER,i,e.STREAM_DRAW,0,f),t!==s&&(e.vertexAttrib4f(k.a_Color,0,0,1,.25),e.drawElements(e.TRIANGLES,.75*(s-t),e.UNSIGNED_INT,3*t)),0!==t&&(e.vertexAttrib4f(k.a_Color,1,0,0,.25),e.drawElements(e.TRIANGLES,.75*t,e.UNSIGNED_INT,0)),T!==f&&(e.vertexAttrib4f(k.a_Color,0,0,1,1),e.drawArrays(e.LINES,T/2,(f-T)/2)),s!==T)&&(e.vertexAttrib4f(k.a_Color,1,0,0,1),e.drawArrays(e.LINES,s/2,(T-s)/2))},A.drawLightLayer=function(){if(this.showLight){var e=We,s=this.ambient,r=s.red/255,o=s.green/255,s=s.blue/255,l=e.lightmap.clipX,c=e.lightmap.clipY,h=e.lightmap.clipWidth,d=e.lightmap.clipHeight,u=(e.bindFBO(e.lightmap.fbo),e.setViewport(l,c,h,d),e.clearColor(r,o,s,0),e.clear(e.COLOR_BUFFER_BIT),e.arrays[1].uint16),p=this.tileWidth,m=this.tileHeight,g=p/2,f=p/m,v=this.lightLeft,b=this.lightTop,y=this.lightRight,w=this.lightBottom,x=this.lights,k=x.length;let t=0,i=0,a=0,n=0;for(let e=0;e<k;e++){var T=x[e];if(!T.hidden){var I=T.x*p,C=T.y*m;switch(T.type){case"point":if(((I<v?v:y<I?y:I)-I)**2+(((C<b?b:w<C?w:C)-C)*f)**2<(T.range*g)**2)switch(T.blend){case"max":u[t++]=e;continue;case"screen":u[65536|i++]=e;continue;case"additive":u[131072|a++]=e;continue;case"subtract":u[196608|n++]=e;continue}continue;case"area":var E=T.instance,M=I+E.measureOffsetX*p,S=C+E.measureOffsetY*m,A=M+E.measureWidth*p,E=S+E.measureHeight*m;if(M<y&&S<w&&v<A&&b<E)switch(T.blend){case"max":u[t++]=e;continue;case"screen":u[65536|i++]=e;continue;case"additive":u[131072|a++]=e;continue;case"subtract":u[196608|n++]=e;continue}continue}}}var P=t+i+a+n;if(0!==P){var L=Ze.instance.project(e.flip,y-v,w-b).translate(-v,-b).scale(p,m);for(let e=0;e<i;e++)u[t+e]=u[65536|e];for(let e=0;e<a;e++)u[t+i+e]=u[131072|e];for(let e=0;e<n;e++)u[t+i+a+e]=u[196608|e];for(let e=0;e<P;e++)x[u[e]].instance.draw(L);e.blend="normal"}e.resetViewport(),e.unbindFBO()}},A.drawTileMarquee=function(){var a=this.marquee;if(a.visible){var n=We,s=n.arrays[0].float32,r=this.getGridContext(),o=r.offsetX,r=r.offsetY,l=this.tileWidth,c=this.tileHeight,o=this.rasterizeScrollPosition(-o,-r),r=o.left,h=o.top,d=o.right,o=o.bottom,u=a.x,p=a.y,m=u+a.width,g=p+a.height,f=.5/this.scaleX/l,v=.5/this.scaleY/c;s[0]=u+f,s[1]=p+v,s[2]=u+f,s[3]=g+v,s[4]=m+f,s[5]=g+v,s[6]=m+f,s[7]=p+v;let e=8,t=null,i=null;var b,y,w,u=A.tilemap??A,g=u.width,m=u.height,f=a.width,p=a.height,v=a.x,u=a.y,f=v+f,p=u+p,x=Math.max,k=Math.min,T=(0<f&&v<g&&0<p&&u<m?(T=x(v,0),b=x(u,0),y=k(f,g),w=k(p,m),s[e]=T,s[e+1]=b,s[e+2]=T,s[e+3]=w,s[e+4]=y,s[e+5]=w,s[e+6]=y,s[e+7]=b,t=e,e+=8,v<0&&(s[e]=0,s[e+1]=x(u,0),s[e+2]=v,s[e+3]=u,s[e+4]=v,s[e+5]=p,s[e+6]=0,s[e+7]=k(p,m),i=i||e,e+=8),u<0&&(s[e]=x(v,0),s[e+1]=0,s[e+2]=v,s[e+3]=u,s[e+4]=f,s[e+5]=u,s[e+6]=k(f,g),s[e+7]=0,i=i||e,e+=8),g<f&&(s[e]=g,s[e+1]=x(u,0),s[e+2]=f,s[e+3]=u,s[e+4]=f,s[e+5]=p,s[e+6]=g,s[e+7]=k(p,m),i=i||e,e+=8),m<p&&(s[e]=x(v,0),s[e+1]=m,s[e+2]=v,s[e+3]=p,s[e+4]=f,s[e+5]=p,s[e+6]=k(f,g),s[e+7]=m,i=i||e,e+=8)):(s[e]=v,s[e+1]=u,s[e+2]=v,s[e+3]=p,s[e+4]=f,s[e+5]=p,s[e+6]=f,s[e+7]=u,i=e,e+=8),null!==t&&(t={start:.75*t,count:6}),null!==i&&(i={start:.75*i,count:.75*(e-i)}),n.graphicProgram.use());n.matrix.project(n.flip,d-r,o-h).translate(-r,-h).scale(l,c),n.bindVertexArray(T.vao.a10),n.uniformMatrix3fv(T.u_Matrix,!1,n.matrix),n.bufferData(n.ARRAY_BUFFER,s,n.STREAM_DRAW,0,e),null!==t&&(n.vertexAttrib4fv(T.a_Color,a.backgroundColor),n.drawElements(n.TRIANGLES,t.count,n.UNSIGNED_INT,4*t.start)),null!==i&&(n.vertexAttrib4fv(T.a_Color,a.backgroundColorInvalid),n.drawElements(n.TRIANGLES,i.count,n.UNSIGNED_INT,4*i.start)),n.vertexAttrib4fv(T.a_Color,a.borderColor),n.drawArrays(n.LINE_LOOP,0,4)}},A.drawTerrainMarquee=function(){var e=this.marquee;if(e.visible){var t=We,i=t.arrays[0].float32,a=this.tileWidth,n=this.tileHeight,s=this.scrollLeft,r=this.scrollTop,o=this.scrollRight,l=this.scrollBottom,c=e.x,h=e.y,d=e.x+e.width,u=e.y+e.height,p=.5/this.scaleX/a,m=.5/this.scaleY/n,g=(i[0]=c+p,i[1]=h+m,i[2]=c+p,i[3]=u+m,i[4]=d+p,i[5]=u+m,i[6]=d+p,i[7]=h+m,t.graphicProgram.use());switch(t.matrix.project(t.flip,o-s,l-r).translate(-s,-r).scale(a,n),t.bindVertexArray(g.vao.a10),t.uniformMatrix3fv(g.u_Matrix,!1,t.matrix),t.bufferData(t.ARRAY_BUFFER,i,t.STREAM_DRAW,0,8),e.terrain){case 0:t.vertexAttrib4f(g.a_Color,0,1,0,.25);break;case 1:t.vertexAttrib4f(g.a_Color,0,0,1,.25);break;case 2:t.vertexAttrib4f(g.a_Color,1,0,0,.25)}t.drawArrays(t.TRIANGLE_FAN,0,4),t.vertexAttrib4f(g.a_Color,1,1,1,1),t.drawArrays(t.LINE_LOOP,0,4)}},A.drawTilemapWireframe=function(){var e,t,i,a,n,s,r,o,l,c,h,d,u,p,m,g,f,v;"tilemap"===this.target?.class&&(e=this.target,t=this.getParallaxAnchor(e),i=this.scrollLeft,a=this.scrollTop,n=this.scrollRight,s=this.scrollBottom,r=this.tileWidth,o=this.tileHeight,l=e.x,c=e.y,h=e.width,d=e.height,v=e.offsetX,u=e.offsetY,f=e.anchorX*(p=h*r),g=e.anchorY*(m=d*o),f=t.x-f+v,v=t.y-g+u,f<n)&&v<s&&i<f+p&&a<v+m&&(this.drawRectWireframeOnTilemap(f/r,v/o,h,d,l,c,0),this.drawTargetAnchor(e,0))},A.drawAnimationWireframe=function(){switch(this.target?.class){case"actor":case"animation":var e,t,i,a,n,s,r,o=this.target,l=o.data;void 0!==l&&(r=this.scrollLeft,e=this.scrollTop,t=this.scrollRight,i=this.scrollBottom,a=this.tileWidth,n=this.tileHeight,s=o.x,o=o.y,r<(s+(l=(r=Math.max(l.size??1,1))/2))*a)&&(s-l)*a<t&&e<(o+l)*n&&(o-l)*n<i&&this.drawRectWireframeOnTilemap(s-l,o-l,r,r,s,o,0)}},A.drawAnimationAnchor=function(){switch(this.target?.class){case"actor":var e=He.teams.map[this.target.teamId],e=o(e?.color??"ffffffff");this.drawTargetAnchor(this.target,0,e);break;case"animation":this.drawTargetAnchor(this.target,0)}},A.drawLightWireframe=function(){if("light"===this.target?.class){var e=this.target,t=this.tileWidth,i=this.tileHeight,a=this.scrollLeft,n=this.scrollTop,s=this.scrollRight,r=this.scrollBottom;switch(e.type){case"point":var o=e.x*t,l=e.y*i,c=e.range/2*t;((o<a?a:s<o?s:o)-o)**2+(((l<n?n:r<l?r:l)-l)*(t/i))**2<c**2&&(h=e.range/2*i,this.drawOvalWireframe(o,l,c,h,4294967295),this.drawTargetAnchor(e,0));break;case"area":var o=e.instance,l=e.x,c=e.y,h=e.x*t,d=e.y*i,h=h+o.measureOffsetX*t,d=d+o.measureOffsetY*i,u=h+o.measureWidth*t,p=d+o.measureHeight*i;h<s&&d<r&&a<u&&n<p&&(h=e.x-o.anchorOffsetX,d=e.y-o.anchorOffsetY,u=e.width,p=e.height,o=o.angle,this.drawRectWireframeOnTilemap(h,d,u,p,l,c,o),this.drawTargetAnchor(e,o))}}},A.drawRegionWireframe=function(){var e,t,i,a,n,s,r,o,l,c,h,d,u;"region"===this.target?.class&&(e=this.target,t=this.tileWidth,i=this.tileHeight,a=this.scrollLeft,n=this.scrollTop,s=this.scrollRight,r=this.scrollBottom,o=e.x,l=e.y,c=e.width,u=l-(h=e.height)/2,(d=o-c/2)*t<s)&&u*i<r&&a<(d+c)*t&&n<(u+h)*i&&(this.drawRectWireframeOnTilemap(d,u,c,h,o,l,0),this.drawTargetAnchor(e,0))},A.drawParticleEmitterWireframe=function(){if("particle"===this.target?.class){var e=this.target,t=e.emitter;if(void 0!==t){var i,a=Math.radians(e.angle);for({area:i}of t.data.layers)switch(i.type){case"point":case"edge":this.drawTargetAnchor(e,a);break;case"rectangle":var n=this.getConvertedCoords(e),s=n.x,n=n.y,r=i.width,o=i.height;this.drawRectWireframe(s-r/2,n-o/2,s+r/2,n+o/2,s,n,a),this.drawTargetAnchor(e,a);break;case"circle":r=this.getConvertedCoords(e),o=r.x,s=r.y,n=i.radius;this.drawOvalWireframe(o,s,n,n,4294967295),this.drawTargetAnchor(e,a)}}this.drawTargetAnchor(e,0)}},A.drawParallaxWireframe=function(){var e,t,i,a,n,s,r,o,l,c,h,d;"parallax"===this.target?.class&&(e=this.target,t=this.scrollLeft,i=this.scrollTop,a=this.scrollRight,n=this.scrollBottom,o=(s=e.player.texture)?.width??128,s=s?.height??128,c=this.getParallaxAnchor(e),o=e.scaleX*e.repeatX*o,s=e.scaleY*e.repeatY*s,l=e.offsetX,d=e.offsetY,r=e.anchorX*o,h=e.anchorY*s,l=(r=c.x-r+l)+o,c=(o=c.y-h+d)+s,r<a)&&o<n&&t<l&&i<c&&({x:h,y:d}=this.getConvertedCoords(e),this.drawRectWireframe(r,o,l,c,h,d,0),this.drawTargetAnchor(e,0))},A.createStartPositionTexture=function(){let e=this.startPositionTexture;var t,i,a;return null===e&&((t=document.createElement("canvas")).width=256,t.height=256,i=t.getContext("2d"),a=(t.height-160)/2+136,i.fillStyle="rgba(0, 255, 255, 0.5)",i.fillRect(0,0,256,256),i.fillStyle="#ffffff",i.textAlign="center",i.shadowColor="#000000",i.shadowBlur=4,i.shadowOffsetY=4,i.font="160px Awesome",i.fillText("",128,a),(e=new je).fromImage(t),e.base.protected=!0,this.startPositionTexture=e),e},A.drawStartPosition=function(){var e,t,i,a,n,s,r,o,l,c=He.config["startPosition"];c.sceneId===this.meta.guid&&(n=this.tileWidth,l=this.tileHeight,e=this.scrollLeft,t=this.scrollTop,i=this.scrollRight,a=this.scrollBottom,n=(o=(c.x-.5)*n)+n,l=(c=(c.y-.5)*l)+l,o<i)&&c<a&&e<n&&t<l&&((r=(s=We).arrays[0].float32)[0]=o,r[1]=c,r[2]=0,r[3]=0,r[4]=o,r[5]=l,r[6]=0,r[7]=1,r[8]=n,r[9]=l,r[10]=1,r[11]=1,r[12]=n,r[13]=c,r[14]=1,r[15]=0,o=this.createStartPositionTexture(),l=s.imageProgram.use(),s.matrix.project(s.flip,i-e,a-t).translate(-e,-t),s.bindVertexArray(l.vao),s.uniformMatrix3fv(l.u_Matrix,!1,s.matrix),s.uniform1i(l.u_LightMode,0),s.uniform1i(l.u_ColorMode,0),s.uniform4f(l.u_Tint,0,0,0,0),s.bufferData(s.ARRAY_BUFFER,r,s.STREAM_DRAW,0,16),s.bindTexture(s.TEXTURE_2D,o.base.glTexture),s.drawElements(s.TRIANGLES,6,s.UNSIGNED_INT,0))},A.selectObject=function(t,i){let a=!1,n=null,s=0;if(!n){var r=this.actors,o=this.animations;for(let e=0;e<2;e++){var l=0===e?r:o;for(let e=l.length-1;0<=e;e--){var c,h,d,u=l[e];u.hidden||u.locked||(h=u.data?.size??1,h=Math.max(h,1)/2,d=u.x,c=u.y,d-h<=t&&t<d+h&&c-h-1<=i&&i<c+h&&(d=((h=Math.dist(t,i,d,c)<=h)?0:-100)+c/2-Math.abs(t-d)-Math.abs(i-c),null===n||s<d)&&(a=a||h,n=u,s=d))}}}return n=(n=!(n=(n=a?n:this.selectRegion(t,i)??n)||this.selectParticleEmitter(t,i))&&this.showLight?this.selectLight(t,i):n)||this.selectSortedLayer(t,i)},A.selectRegion=function(t,i){let a=null,n=0;var s=this.regions;for(let e=s.length-1;0<=e;e--){var r,o,l,c,h=s[e];h.hidden||h.locked||(r=h.width,o=h.height,c=h.x-r/2,l=h.y-o/2,c<=t&&l<=i&&t<c+r&&i<l+o&&(c=-Math.min(r,o)-Math.abs(t-h.x)-Math.abs(i-h.y),null===a||n<c)&&(a=h,n=c))}return a},A.selectLight=function(t,i){let a=null,n=0;var s=this.lights;for(let e=s.length-1;0<=e;e--){var r=s[e];if(!r.hidden&&!r.locked)switch(r.type){case"point":var o=t-r.x,l=i-r.y,c=r.range/2;o**2+l**2<=c**2&&(c=-Math.PI*c**2-Math.abs(o)-Math.abs(l),null===a||n<c)&&(a=r,n=c);continue;case"area":var o=r.instance,l=t-r.x,c=i-r.y,h=r.width,d=r.height,u=-o.anchorOffsetX,p=-o.anchorOffsetY,m=u+h,g=p+d,f=o.angle,v=Math.cos(-f),f=Math.sin(-f),b=l*v-c*f,f=l*f+c*v;u<=b&&p<=f&&b<m&&f<g&&(v=-h*d-Math.abs(l)-Math.abs(c),null===a||n<v)&&(a=r,n=v);continue}}return a},A.selectParticleEmitter=function(t,i){let a=null,n=0;var s=this.getConvertedCoords;const r=s(this.sharedPoint.set(t,i));var o=r.x,l=r.y,c=this.tileWidth/2,h=this.tileHeight/2,d=this.particles;for(let e=d.length-1;0<=e;e--){var u=d[e];if(!u.hidden&&!u.locked){var p=u.emitter;if(p)for(var{area:m}of p.data.layers)switch(m.type){case"point":var g=u.x-.5,f=u.y-.5,v=u.x+.5,b=u.y+.5;g<=t&&f<=i&&t<v&&i<b&&(g=-Math.abs(t-u.x)-Math.abs(i-u.y),null===a||n<g)&&(a=u,n=g);continue;case"rectangle":{const r=s(u);var f=o-r.x,v=l-r.y,b=m.width,g=m.height,y=-Math.max(b/2,c),w=-Math.max(g/2,h),x=-y,k=-w,T=Math.radians(u.angle),I=Math.cos(-T),T=Math.sin(-T),C=f*I-v*T,T=f*T+v*I;y<=C&&w<=T&&C<x&&T<k&&(I=-b*g-Math.abs(f)-Math.abs(v),null===a||n<I)&&(a=u,n=I);continue}case"circle":{const r=s(u);y=o-r.x,w=l-r.y,C=Math.max(m.radius,c);y**2+w**2<=C**2&&(x=-Math.PI*C**2-Math.abs(y)-Math.abs(w),null===a||n<x)&&(a=u,n=x);continue}}else{var p=u.x-.5,E=u.y-.5,M=u.x+.5,S=u.y+.5;p<=t&&E<=i&&t<M&&i<S&&(p=-Math.abs(t-u.x)-Math.abs(i-u.y),null===a||n<p)&&(a=u,n=p)}}}return a},A.selectSortedLayer=function(i,a){var e=this.sharedPoint.set(i,a),e=this.getConvertedCoords(e),n=e.x,s=e.y,r=this.tileWidth,o=this.tileHeight;for(let e=0;e<3;e++){let t;switch(e){case 0:t=this.foregrounds;break;case 1:t=this.doodads;break;case 2:t=this.backgrounds}for(let e=t.length-1;0<=e;e--){var l=t[e];if(!l.hidden&&!l.locked)switch(l.class){case"parallax":var c=l,h=c.player.texture,d=h?.width??128,h=h?.height??128,d=c.scaleX*c.repeatX*d,h=c.scaleY*c.repeatY*h,u=this.getParallaxAnchor(c),p=c.offsetX,m=c.offsetY,g=c.anchorX*d,f=c.anchorY*h,g=u.x-g+p,p=u.y-f+m;if(g<=n&&p<=s&&n<g+d&&s<p+h)return c;continue;case"tilemap":var u=l,f=this.getParallaxAnchor(u,!0),m=u.width,g=u.height,d=u.offsetX,p=u.offsetY,h=u.anchorX*m,c=u.anchorY*g,v=f.x-h+d/r,b=f.y-c+p/o;if(v<=i&&b<=a&&i<v+m&&a<b+g)return u;continue}}}return null},A.drawOvalWireframe=function(i,a,e,t,n){var s=We,r=s.arrays[0].float32,o=this.scale,l=this.scrollLeft,c=this.scrollTop,h=this.scrollRight,d=this.scrollBottom,u=Math.max(1,.5/o),p=e-u,m=t-u,g=2*Math.PI/360;let f=0;for(let e=0,t=1;e<360;e++,t=-t){var v=e*g,b=t*u;r[f]=i+(p+b)*Math.cos(v),r[f+1]=a+(m+b)*Math.sin(v),f+=2}r[f]=r[0],r[f+1]=r[1],r[f+2]=r[2],r[f+3]=r[3],f+=4;var o=s.graphicProgram.use(),e=(255&n)/255,t=(n>>8&255)/255,y=(n>>16&255)/255,n=(n>>24&255)/255;s.matrix.project(s.flip,h-l,d-c).translate(-l,-c),s.bindVertexArray(o.vao.a10),s.uniformMatrix3fv(o.u_Matrix,!1,s.matrix),s.bufferData(s.ARRAY_BUFFER,r,s.STREAM_DRAW,0,f),s.vertexAttrib4f(o.a_Color,e,t,y,n),s.drawArrays(s.TRIANGLE_STRIP,0,f/2)},A.drawTargetAnchor=function(e,t,i=4278255360){var{x:e,y:a}=this.getConvertedCoords(e),n=We,s=n.arrays[0].float32,r=this.scale,o=this.scrollLeft,l=this.scrollTop,c=this.scrollRight,h=this.scrollBottom,d=Math.max(1,.5/r),r=r<=.5?.5:0,u=d,d=4*d,d=(s[0]=e-u,s[1]=a-d,s[2]=e-u,s[3]=a+d,s[4]=e+u,s[5]=a+d,s[6]=e+u,s[7]=a+d,s[8]=e+u,s[9]=a-d,s[10]=e-u,s[11]=a-d,s[12]=e-d,s[13]=a-u,s[14]=e-d,s[15]=a+u,s[16]=e+d,s[17]=a+u,s[18]=e+d,s[19]=a+u,s[20]=e+d,s[21]=a-u,s[22]=e-d,s[23]=a-u,n.graphicProgram.use()),u=(255&i)/255,p=(i>>8&255)/255,m=(i>>16&255)/255,i=(i>>24&255)/255;n.matrix.project(n.flip,c-o,h-l).translate(r-o,-l).rotateAt(e,a,t),n.bindVertexArray(d.vao.a10),n.uniformMatrix3fv(d.u_Matrix,!1,n.matrix),n.bufferData(n.ARRAY_BUFFER,s,n.STREAM_DRAW,0,24),n.vertexAttrib4f(d.a_Color,u,p,m,i),n.drawArrays(n.TRIANGLES,0,12)},A.drawRectWireframe=function(e,t,i,a,n,s,r){var o=We,l=o.arrays[0].float32,c=this.scrollLeft,h=this.scrollTop,d=this.scrollRight,u=this.scrollBottom,p=this.scale<=.5?.5:0,p=(o.matrix.reset().translate(p-c,-h).rotateAt(n,s,r),this.setRectWireframeVertices(l,e,t,i,a,o.matrix),o.graphicProgram.use());o.matrix.project(o.flip,d-c,u-h),o.bindVertexArray(p.vao.a10),o.uniformMatrix3fv(p.u_Matrix,!1,o.matrix),o.bufferData(o.ARRAY_BUFFER,l,o.STREAM_DRAW,0,20),o.vertexAttrib4f(p.a_Color,1,1,1,1),o.drawArrays(o.TRIANGLE_STRIP,0,10)},A.drawRectWireframeOnTilemap=function(e,t,i,a,n,s,r){var o=We,l=o.arrays[0].float32,c=this.tileWidth,h=this.tileHeight,d=this.scrollLeft,u=this.scrollTop,p=this.scrollRight,m=this.scrollBottom,g=e,f=t,e=e+i,i=t+a,t=this.scale<=.5?.5:0,a=(o.matrix.reset().translate(t-d,-u).scale(c,h).rotateAt(n,s,r),this.setRectWireframeVertices(l,g,f,e,i,o.matrix),o.graphicProgram.use());o.matrix.project(o.flip,p-d,m-u),o.bindVertexArray(a.vao.a10),o.uniformMatrix3fv(a.u_Matrix,!1,o.matrix),o.bufferData(o.ARRAY_BUFFER,l,o.STREAM_DRAW,0,20),o.vertexAttrib4f(a.a_Color,1,1,1,1),o.drawArrays(o.TRIANGLE_STRIP,0,10)},A.setRectWireframeVertices=function(e,t,i,a,n,s){var r=s[0],o=s[1],l=s[3],c=s[4],h=s[6],s=s[7],d=r*t+l*i+h,u=o*t+c*i+s,p=r*t+l*n+h,t=o*t+c*n+s,m=r*a+l*n+h,n=o*a+c*n+s,r=r*a+l*i+h,l=o*a+c*i+s,h=Ve.instances,o=h[0].set(r-d,l-u),a=h[1].set(p-d,t-u),c=h[2].set(d-p,u-t),i=h[3].set(m-p,n-t),s=h[4].set(p-m,t-n),g=h[5].set(r-m,l-n),f=h[6].set(m-r,n-l),h=h[7].set(d-r,u-l),o=o.normalize().add(a.normalize()),c=c.normalize().add(i.normalize()),s=s.normalize().add(g.normalize()),f=f.normalize().add(h.normalize()),v=Math.max(1,.5/this.scale);o.length=v/o.sin(a),c.length=v/c.sin(i),s.length=v/s.sin(g),f.length=v/f.sin(h),e[0]=d-o.x,e[1]=u-o.y,e[2]=d+o.x,e[3]=u+o.y,e[4]=p-c.x,e[5]=t-c.y,e[6]=p+c.x,e[7]=t+c.y,e[8]=m-s.x,e[9]=n-s.y,e[10]=m+s.x,e[11]=n+s.y,e[12]=r-f.x,e[13]=l-f.y,e[14]=r+f.x,e[15]=l+f.y,e[16]=d-o.x,e[17]=u-o.y,e[18]=d+o.x,e[19]=u+o.y},A.edit=function(e,t,i,a){switch(this.brush){case"eraser":case"pencil":this.editInPencilMode(e,t,i,a);break;case"rect":this.editInRectMode(e,t,i,a);break;case"oval":this.editInOvalMode(e,t,i,a);break;case"fill":this.editInFillMode(e,t)}this.requestRendering(),this.planToSave()},A.editInPencilMode=function(e,t,i,a){var n=this.tilemap??this,s=n.width,n=n.height,r=this.patternOriginX,o=this.patternOriginY,l=this.layer,c=this.shiftKey||Ue.explicit,h=this.marquee.getTiles(!0);const d=Math.max(e,0),u=Math.max(t,0),p=Math.min(e+i,s),m=Math.min(t+a,n);for(let t=u;t<m;t++)for(let e=d;e<p;e++)"terrain"===l?this.setTerrain(e,t):this.setTile(h,e-r,t-o,e,t);if("terrain"!==l&&!c){const d=Math.max(e-1,0),u=Math.max(t-1,0),p=Math.min(e+i+1,s),m=Math.min(t+a+1,n);for(let t=u;t<m;t++)for(let e=d;e<p;e++)this.setTileFrame(e,t)}},A.editInRectMode=function(e,t,i,a){var n=this.tilemap??this,s=n.width,n=n.height,r=this.patternOriginX,o=this.patternOriginY,l=this.layer,c=this.shiftKey||Ue.explicit,h=this.marquee.getTiles(c);this.restoreMapData();const d=Math.max(e,0),u=Math.max(t,0),p=Math.min(e+i,s),m=Math.min(t+a,n);for(let t=u;t<m;t++)for(let e=d;e<p;e++)"terrain"===l?this.setTerrain(e,t):this.setTile(h,e-r,t-o,e,t);if("terrain"!==l&&!c){var g=e+1,f=t+1,v=e+i-2,b=t+a-2;const d=Math.max(e-1,0),u=Math.max(t-1,0),p=Math.min(e+i+1,s),m=Math.min(t+a+1,n);for(let t=u;t<m;t++)for(let e=d;e<p;e++)(e<g||e>v||t<f||t>b)&&this.setTileFrame(e,t)}},A.editInOvalMode=function(e,t,i,a){var n,s=this.tilemap??this,r=s.width,s=s.height,o=this.patternOriginX,l=this.patternOriginY,c=this.layer,h=this.shiftKey||Ue.explicit,d=this.marquee.getTiles(h),u=(this.restoreMapData(),(Math.max(i,a)/2-.1)**2),p=Math.max(i,a)/Math.min(i,a),m=e+(i-1)/2,g=t+(a-1)/2;let f,v,b;if("terrain"!==c&&!h){const y=Math.max(e,0)-1,w=Math.max(t,0)-1,x=Math.min(e+i,r)+1,k=Math.min(t+a,s)+1;f=x-y,v=new Uint8Array((x-y)*(k-w)),b=new Uint8Array(v.length)}const y=Math.max(e,0),w=Math.max(t,0),x=Math.min(e+i,r),k=Math.min(t+a,s);for(let t=w;t<k;t++)for(let e=y;e<x;e++)(i<a?((e-m)*p)**2+(t-g)**2:(e-m)**2+((t-g)*p)**2)<u&&("terrain"===c?this.setTerrain(e,t):(this.setTile(d,e-o,t-l,e,t),h||(n=e-y+1+(t-w+1)*f,v[n]=1)));if("terrain"!==c&&!h){const y=Math.max(e,0)-1,w=Math.max(t,0)-1,x=Math.min(e+i,r)+1,k=Math.min(t+a,s)+1;var T=x-1,I=k-1;for(let t=w;t<I;t++)for(let e=y;e<T;e++){var C=e-y+(t-w)*f;e<T&&v[C]!==v[1+C]&&(b[C]=1,b[1+C]=1),t<I&&v[C]!==v[C+f]&&(b[C]=1,b[C+f]=1),e<T&&t<I&&v[C]!==v[1+C+f]&&(b[C]=1,b[1+C+f]=1),0<e&&t<I&&v[C]!==v[C-1+f]&&(b[C]=1,b[C-1+f]=1)}for(let t=w;t<k;t++)for(let e=y;e<x;e++){var E=e-y+(t-w)*f;1===b[E]&&this.setTileFrame(e,t)}}},A.editInFillMode=function(t,i){let n,s,r,o,e,a;var l=this.layer;switch(l){case"tilemap":var c=this["tilemap"];n=c.tiles,s=c.width,r=c.height,o=6,e=this.shiftKey||Ue.explicit,a=this.marquee.getTiles(e);break;case"terrain":n=this.terrains,s=this.width,r=this.height,o=0}var h=this.patternOriginX,d=this.patternOriginY;const u=new Uint8Array(s*r);let p=t,m=i,g=t,f=i;const{min:v,max:b}=Math;var y=We.arrays[1].uint16.buffer,w=4*v(s,r);let x=new Uint16Array(y,0,w),k=new Uint16Array(y,2*w,w),T=2,I=0;x[0]=t,x[1]=i,u[t+i*s]=1;y=t+i*s;const C=n[y]>>o;for(var E=(e,t)=>{var i,a;return e<0||e>=s||t<0||t>=r?(p=v(e,p),m=v(t,m),g=b(e,g),f=b(t,f),-1):(i=e+t*s,0===u[i]?(a=e+t*s,n[a]>>o!==C?(p=v(e,p),m=v(t,m),g=b(e,g),f=b(t,f),u[i]=3):(k[I]=e,k[I+1]=t,I+=2,u[i]=1)):u[i])};0<T;){for(let e=0;e<T;e+=2){const t=x[e],i=x[e+1];"terrain"===l?this.setTerrain(t,i):this.setTile(a,t-h,i-d,t,i),3===E(t-1,i)&&(u[t+i*s]=2),3===E(t,i-1)&&(u[t+i*s]=2),3===E(t+1,i)&&(u[t+i*s]=2),3===E(t,i+1)&&(u[t+i*s]=2)}var M=x;x=k,k=M,T=I,I=0}if("terrain"!==l&&!e){var S=b(p,0),w=b(m,0),A=v(g+1,s),P=v(f+1,r);for(let t=w;t<P;t++)for(let e=S;e<A;e++){var L=e+t*s;switch(u[L]){case 2:this.setTileFrame(e,t);var R=e-1,F=R+t*s,F=(1!==u[F]||3!==E(e,t-1)&&3!==E(e,t+1)||(u[F]=2,this.setTileFrame(R,t)),e+1),R=F+t*s,R=(1!==u[R]||3!==E(e,t-1)&&3!==E(e,t+1)||(u[R]=2,this.setTileFrame(F,t)),e-1),F=t-1,z=R+F*s,z=(0===u[z]&&0<=R&&0<=F&&(u[z]=3,this.setTileFrame(R,F)),e+1),R=t-1,F=z+R*s,F=(0===u[F]&&z<s&&0<=R&&(u[F]=3,this.setTileFrame(z,R)),e+1),z=t+1,R=F+z*s,R=(0===u[R]&&F<s&&z<r&&(u[R]=3,this.setTileFrame(F,z)),e-1),F=t+1,z=R+F*s;0===u[z]&&0<=R&&F<r&&(u[z]=3,this.setTileFrame(R,F));break;case 3:this.setTileFrame(e,t)}}}},A.setTile=function(t,i,a,n,s){var r=t.width,o=t.height,l=t.rowOffset,c=this.tilemap,h=c.tiles,n=n+s*h.rowOffset,s=t[(i=(i%r+r)%r)+(a=(a%o+o)%o)*l],t=h[n];if(0===s)0!==t&&(this.recordMapData(n),h[n]=0);else{r=this.marquee.tilesetMap,i=c.reverseMap,o=r[s>>24];let e=i[o];if(void 0===e){a=c.tilesetMap;if(0===(e=this.getNewTilesetIndex(a)))return;i[a[e]=o]=e}l=16777215&s|e<<24;t!==l&&(this.recordMapData(n),h[n]=l)}},A.setTileFrame=function(e,i){var a=this.tilemap,n=a.width,s=a.height;if(!(e<0||n<=e||i<0||s<=i)){var r=a.tiles,o=r.rowOffset,l=e+i*o,c=r[l];if(0!==c){var a=a.tilesetMap,h=He.tilesets,d=He.autotiles.map,h=h[a[c>>24]];if(void 0!==h&&"auto"===h.type){a=(c>>8&255)+(c>>16&255)*h.width,h=h.tiles[a];if(h){a=d[h.template];if(void 0!==a){var d=c>>8,h=n-1,c=s-1,u=1+(0<e&&d!=r[l-1]>>8)|1+(0<e&&0<i&&d!=r[l-1-o]>>8)<<2|1+(0<i&&d!=r[l-o]>>8)<<4|1+(e<h&&0<i&&d!=r[l+1-o]>>8)<<6|1+(e<h&&d!=r[l+1]>>8)<<8|1+(e<h&&i<c&&d!=r[l+1+o]>>8)<<10|1+(i<c&&d!=r[l+o]>>8)<<12|1+(0<e&&i<c&&d!=r[l-1+o]>>8)<<14,p=a.nodes,m=p.length;let t=0;for(let e=0;e<m;e++){var g=p[e].rule|u;if(3!==Math.max(3&g,g>>2&3,g>>4&3,g>>6&3,g>>8&3,g>>10&3,g>>12&3,g>>14&3)){t=e;break}}n=d<<8|t;r[l]!==n&&(this.recordMapData(l),r[l]=n)}}}}}},A.setTerrain=function(e,t){var i=this.marquee.terrain,a=this.terrains,e=e+t*a.rowOffset;this.recordMapData(e),a[e]=i},A.createTiles=function(e,t){var i=new Uint32Array(e*t);return i.width=e,i.height=t,i.rowOffset=e,i},A.cloneTiles=function(e){var t=new Uint32Array(e);return t.width=e.width,t.height=e.height,t.rowOffset=e.rowOffset,t},A.createTerrains=function(e,t){t=new Uint8Array(e*t);return t.rowOffset=e,t},A.getNewTilesetIndex=function(t){for(let e=1;e<256;e++)if(void 0===t[e])return e;return 0},A.requestAnimation=function(){"open"===this.state&&this.showAnimation&&f.appendUpdater("stageAnimation",this.updateAnimation)},A.updateAnimation=function(e){var t=A["animationInterval"];0<t&&(A.animationElapsed+=e,A.animationElapsed>=t)&&(A.animationElapsed-=t,A.animationFrame+=1),A.updateParallaxes(e),A.updateAnimations(e),A.updateParticles(e),f.updaters.stageRendering!==A.renderingFunction&&A.drawScene()},A.stopAnimation=function(){f.removeUpdater("stageAnimation",this.updateAnimation)},A.requestRendering=function(){"open"===this.state&&f.appendUpdater("stageRendering",this.renderingFunction)},A.renderingFunction=function(){A.updateAnimations(0),A.drawScene()},A.stopRendering=function(){f.removeUpdater("stageRendering",this.renderingFunction)},A.switchLayer=function(){var e=_("#scene-layer");const a={tilemap:null};for(const i of e.children){var t=i.getAttribute("value");a[t]=i}let n=void 0;return function(e){var t=a[e];if(n!==t){null===n&&(this.closeTilemap(!1),this.computeActiveTilemapId()),n?.removeClass("selected"),t?.addClass("selected"),n=t;var i=this.marquee;switch(this.layer=e){case"object":i.switch("object"),this.updateTargetInfo();break;case"tilemap":i.switch("eraser"===this.brush?"eraser":"tile"),i.clear();break;case"terrain":i.switch("eraser"===this.brush?"eraser":"terrain"),i.clear()}i.resize(),"open"===this.state&&A.requestRendering()}}}(),A.switchBrush=function(){var e=_("#scene-brush");const a={};for(const i of e.children){var t=i.getAttribute("value");a[t]=i}let n=null;return function(e){var t=a[e];if(n!==t){n?.removeClass("selected"),t.addClass("selected"),n=t;var i=this.marquee;switch(this.brush=e){case"eraser":i.switch("eraser");break;case"pencil":case"rect":case"oval":case"fill":i.switch("terrain"===this.layer?"terrain":"tile")}i.clear(),i.resize()}}}(),A.switchGrid=function(){const t=_("#scene-switch-grid");return function(e=!this.showGrid){e?t.addClass("selected"):t.removeClass("selected"),this.showGrid=e,this.requestRendering()}}(),A.switchLight=function(){const t=_("#scene-switch-light");return function(e=!this.showLight){e?t.addClass("selected"):t.removeClass("selected"),this.showLight=e,this.requestRendering()}}(),A.switchAnimation=function(){const t=_("#scene-switch-animation");return function(e=!this.showAnimation){(this.showAnimation=e)?(t.addClass("selected"),this.requestAnimation()):(t.removeClass("selected"),this.stopAnimation(),this.resetAnimations()),this.requestRendering()}}(),A.switchSettings=function(){j.fileScene.button.hasClass("selected")?j.close():j.open("fileScene",A)},A.switchTerrain=function(){var e="terrain"===this.marquee.key?this.marquee:this.marquee.saveData.terrain;e.terrain=(e.terrain+1)%3,"eraser"===this.brush&&this.switchBrush("pencil"),this.marquee.visible&&this.requestRendering()},A.resetAnimations=function(){if("open"===this.state){for(var{player:e}of this.actors)e.clearParticles(),e.restart();for(var{player:t}of this.animations)t.clearParticles(),t.restart();for(var{emitter:i}of this.particles)i?.clear()}},A.updateFont=function(){var e=We.context2d,t=12*window.devicePixelRatio;"scene"===e.mode&&e.size===t||(e.mode="scene",e.font=t+"px "+document.body.css().fontFamily,e.paddingItalic=0,e.size=t,e=We.textProgram.use(),We.uniform1f(e.u_Threshold,0))},A.planToSave=function(){R.planToSave(this.meta),this.context.changed=!0},A.planToSaveTerrains=function(){this.context.scene.terrainsChanged=!0};{let e=null,i=null,a=null,n=null,s=0,t=0;A.beginMapRecord=function(){switch(this.layer){case"tilemap":e=this.tilemap,i=e.tiles;break;case"terrain":e=null,i=this.terrains}t<i.length&&(t=i.length,a=new Uint32Array(2*t),n=new Uint8Array(t))},A.closeMapRecord=function(){null!==i&&(e=null,i=null,a=null,n=null,s=0,t=0)},A.saveMapRecord=function(){if(0!==s){e?(e.changed=!0,this.history.save({type:"scene-tilemap-change",tilemap:e,changes:a.slice(0,s),tilesetMap:e.tilesetMap})):(this.planToSaveTerrains(),this.history.save({type:"scene-terrain-change",terrains:i,changes:a.slice(0,s)}));for(let e=0;e<s;e+=2)n[a[e]]=0;s=0}},A.recordMapData=function(e){0===n[e]&&(n[e]=1,a[s]=e,a[s+1]=i[e],s+=2)},A.restoreMapData=function(){for(let e=s-2;0<=e;e-=2){var t=a[e];i[t]=a[e+1],n[t]=0}s=0},A.undoMapData=function(t,i){for(let e=i.length-1;0<e;e-=2){var a=i[e-1],n=i[e];i[e]=t[a],t[a]=n}},A.redoMapData=function(t,i){var a=i.length;for(let e=1;e<a;e+=2){var n=i[e-1],s=i[e];i[e]=t[n],t[n]=s}}}A.createHistory=function(){const t=e=>{e.layer=A.tilemap??A.layer},i=e=>{var t=e["layer"];switch(t){case"object":case"terrain":A.switchLayer(t);break;default:A.openTilemap(t)}};return function(){var e=new l(100);return e.onSave=t,e.onRestore=i,e}}(),A.createDefaultAnimation=function(){let n,s;return R.get({local:"Images/default_actor.png",type:"image"}).then(e=>{var t,i;e&&(t=e.naturalWidth,i=e.naturalHeight/2,e.guid="scene:default_actor",(s=new $e(e)).width=t,s.height=i,s.offsetX=-t/2,s.offsetY=-i/2,s.base.protected=!0)}),function(e){if(!n){const i=j.animMotion.create("ffffffffffffffff"),a={mode:"1-dir",sprites:[],motions:[i]};var t=i.dirCases[0].layers[0].frames;t[0].y=-8,t[0].scaleX=.25,t[0].scaleY=.25,t[1]=Object.clone(t[0]),t[1].start=1,t[1].end=2,t[1].spriteY=1,n=class extends Ke.Player{constructor(e){super(a),this.target=e,this.setMotion(i.id)}getTexture(){return s}update(){}computeIndex(){this.index=this.target===A.target?1:0}destroy(){}}}return new n(e)}}(),A.saveToConfig=function(e){e.colors.sceneBackground=this.background.hex},A.loadFromConfig=function(e){this.background=new a(e.colors.sceneBackground,()=>this.requestRendering())},A.saveToProject=function(e){e=e.scene;this.closeTilemap(),e.grid=this.showGrid??e.grid,e.light=this.showLight??e.light,e.animation=this.showAnimation??e.animation,e.layer=this.layer??e.layer,e.brush=this.brush??e.brush,e.zoom=this.zoom??e.zoom},A.loadFromProject=function(e){e=e.scene;this.switchGrid(e.grid),this.switchLight(e.light),this.switchAnimation(e.animation),this.switchLayer(e.layer),this.switchBrush(e.brush),this.setZoom(e.zoom)},A.webglRestored=function(e){"open"===A.state&&A.requestRendering()},A.windowResize=function(e){this.updateHead(),"open"===this.state&&(this.resize(),this.requestRendering())}.bind(A),A.themechange=function(e){this.requestRendering()}.bind(A),A.dprchange=function(e){"open"===this.state&&this.updateFont()}.bind(A),A.datachange=function(e){if("open"===this.state)switch(e.key){case"config":this.updateAnimationInterval(),this.updateLightAreaExpansion(e.last.lightArea);break;case"teams":this.updateActorTeams()}}.bind(A),A.keydown=function(e){if("open"===A.state&&null===A.dragging&&!e.cmdOrCtrlKey)if(e.altKey)"KeyS"===e.code&&A.switchSettings();else switch(e.code){case"Escape":A.closeTilemap();break;case"Backquote":"object"!==A.layer?A.switchLayer("object"):A.switchLayer("terrain");break;case"Digit1":A.openTilemap(A.tilemaps.shortcuts[1]);break;case"Digit2":A.openTilemap(A.tilemaps.shortcuts[2]);break;case"Digit3":A.openTilemap(A.tilemaps.shortcuts[3]);break;case"Digit4":A.openTilemap(A.tilemaps.shortcuts[4]);break;case"Digit5":A.openTilemap(A.tilemaps.shortcuts[5]);break;case"Digit6":A.openTilemap(A.tilemaps.shortcuts[6]);break;case"KeyQ":A.switchBrush("eraser");break;case"KeyE":A.switchBrush("pencil");break;case"KeyR":A.switchBrush("rect");break;case"KeyT":A.switchBrush("oval");break;case"KeyY":A.switchBrush("fill")}},A.headPointerdown=function(e){e.target instanceof HTMLInputElement||(e.preventDefault(),document.activeElement!==A.screen&&A.screen.focus())},A.switchPointerdown=function(e){if(0===e.button){e=e.target;if("ITEM"===e.tagName)switch(e.getAttribute("value")){case"grid":return A.switchGrid();case"light":return A.switchLight();case"animation":return A.switchAnimation();case"settings":return A.switchSettings()}}},A.layerPointerdown=function(e){if(0===e.button)if(!A.dragging){e=e.target;if("ITEM"===e.tagName&&!e.hasClass("selected")){var t=e.getAttribute("value");switch(t){case"object":case"terrain":A.switchLayer(t);break;default:A.openTilemap(A.tilemaps.shortcuts[t])}}}},A.brushPointerdown=function(e){0!==e.button||A.dragging||"ITEM"!==(e=e.target).tagName||e.hasClass("selected")||A.switchBrush(e.getAttribute("value"))},A.zoomFocus=function(e){A.screen.focus()},A.zoomInput=function(e){A.setZoom(this.read())},A.screenKeydown=function(i){if("open"===this.state&&(null===this.dragging||"ShiftLeft"===i.code))if(i.cmdOrCtrlKey)switch(i.code){case"KeyX":this.copy(),this.delete();break;case"KeyC":this.copy();break;case"KeyV":this.paste();break;case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":if("object"===this.layer&&("actor"===this.target?.class||"animation"===this.target?.class)){let e;switch(i.code){case"ArrowLeft":e=180;break;case"ArrowUp":e=270;break;case"ArrowRight":e=0;break;case"ArrowDown":e=90}this.redirectTarget(e)}}else if(!i.altKey)switch(i.code){case"ShiftLeft":if(!this.shiftKey){if(this.shiftKey=!0,this.dragging)switch(this.dragging.mode){case"pencil":case"rect":case"oval":var e=this.marquee;this.edit(e.x,e.y,e.width,e.height);break;case"object-move":this.pointermove(this.dragging.latest)}window.on("keyup",this.shiftKeyup)}break;case"Enter":case"NumpadEnter":this.target&&this.listOpen({value:this.target});break;case"Delete":this.delete();break;case"Escape":this.setTarget(null);break;case"KeyA":0==(1&this.translationKey)&&(this.translationKey|=1,this.translationTimer.add(),this.screen.beginScrolling(),window.on("keyup",this.translationKeyup));break;case"KeyW":0==(2&this.translationKey)&&(this.translationKey|=2,this.translationTimer.add(),this.screen.beginScrolling(),window.on("keyup",this.translationKeyup));break;case"KeyD":0==(4&this.translationKey)&&(this.translationKey|=4,this.translationTimer.add(),this.screen.beginScrolling(),window.on("keyup",this.translationKeyup));break;case"KeyS":0==(8&this.translationKey)&&(this.translationKey|=8,this.translationTimer.add(),this.screen.beginScrolling(),window.on("keyup",this.translationKeyup));break;case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":if("object"===this.layer){i.preventDefault();var a=this.width,n=this.height,s=this.shiftKey;let e=0,t=0;switch(i.code){case"ArrowLeft":e=s?-.1:-1;break;case"ArrowUp":t=s?-.1:-1;break;case"ArrowRight":e=s?.1:1;break;case"ArrowDown":t=s?.1:1}switch(this.target?.class){case"actor":var r=this.target,o=r.data?.size??1,o=Math.max(o,1)/2,l=Math.clamp(r.x+e,o,a-o),r=Math.clamp(r.y+t,o,n-o);this.shiftTarget(Math.roundTo(l,4),Math.roundTo(r,4));break;case"region":o=this.target,l=o.width/2,r=o.height/2,l=Math.clamp(o.x+e,l,a-l),o=Math.clamp(o.y+t,r,n-r);this.shiftTarget(Math.roundTo(l,4),Math.roundTo(o,4));break;case"tilemap":case"light":case"animation":case"particle":case"parallax":r=this.target,l=Math.clamp(r.x+e,0,a),o=Math.clamp(r.y+t,0,n);this.shiftTarget(Math.roundTo(l,4),Math.roundTo(o,4))}}break;case"Minus":case"NumpadSubtract":this.setZoom(this.zoom-1);break;case"Equal":case"NumpadAdd":this.setZoom(this.zoom+1);break;case"Digit0":case"Numpad0":this.setZoom(2)}}.bind(A),A.shiftKeyup=function(e){if(this.shiftKey)switch(e?.code){case"ShiftLeft":case void 0:if(this.shiftKey){if(this.shiftKey=!1,this.dragging)switch(this.dragging.mode){case"pencil":case"rect":case"oval":var t=this.marquee;this.edit(t.x,t.y,t.width,t.height);break;case"object-move":this.pointermove(this.dragging.latest)}window.off("keyup",this.shiftKeyup)}}}.bind(A),A.translationKeyup=function(e){if(0!==this.translationKey){if(void 0===e)this.translationKey=0;else switch(e.code){case"KeyA":this.translationKey&=14;break;case"KeyW":this.translationKey&=13;break;case"KeyD":this.translationKey&=11;break;case"KeyS":this.translationKey&=7}0===this.translationKey&&(this.translationTimer.remove(),this.screen.endScrolling(),window.off("keyup",this.translationKeyup))}}.bind(A),A.screenWheel=function(e){"open"===this.state&&null===this.dragging&&(e.preventDefault(),0!==e.deltaY)&&(e=0<e.deltaY?-1:1,this.setZoom(this.zoom+e))}.bind(A),A.screenUserscroll=function(e){"open"===this.state&&(this.screen.rawScrollLeft=this.screen.scrollLeft,this.screen.rawScrollTop=this.screen.scrollTop,this.updateTransform(),this.requestRendering(),this.marquee.resize(),this.screen.updateScrollbars())}.bind(A),A.screenBlur=function(e){this.shiftKeyup(),this.translationKeyup(),this.pointerup()}.bind(A),A.marqueePointerdown=function(t){if(!this.dragging)switch(t.button){case 0:if(t.dragKey)return(this.dragging=t).mode="scroll",t.scrollLeft=this.screen.scrollLeft,t.scrollTop=this.screen.scrollTop,this.marquee.clear(),pt.open("cursor-grab"),window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove);var e=this.marquee;switch(this.layer){case"tilemap":case"terrain":var{x:i,y:a}=this.getTileCoords(t,!0),n=this.tilemap??this,s=i+e.offsetX,r=a+e.offsetY,o=e.width,l=e.height,c=n.width,h=n.height;switch(this.patternOriginX=s,this.patternOriginY=r,this.beginMapRecord(),this.brush){case"eraser":case"pencil":0<s+o&&s<c&&0<r+l&&r<h&&((this.dragging=t).mode=this.brush,t.pointerdownX=i,t.pointerdownY=a,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove),e.selectInPencilMode(s,r),this.edit(e.x,e.y,e.width,e.height));break;case"rect":case"oval":0<s+o&&s<c&&0<r+l&&r<h&&(0,(this.dragging=t).mode=this.brush,t.pointerdownX=i,t.pointerdownY=a,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove),e.save(),e.selectInRectMode(i,a,1,1),this.edit(e.x,e.y,e.width,e.height));break;case"fill":0<=i&&i<c&&0<=a&&a<h&&(e.selectInPencilMode(s,r),this.edit(i,a),this.saveMapRecord())}break;case"object":{var{x:n,y:d}=this.getTileCoords(t);let e;if(t.cmdOrCtrlKey)switch(this.target?.class){case"tilemap":case"actor":case"region":case"light":case"animation":case"particle":case"parallax":e=this.target}(e=void 0===e?this.selectObject(n,d):e)&&((this.dragging=t).mode="object-move",t.enabled=!1,(t.latest=t).startX=e.x,t.startY=e.y,t.pointerdownX=n,t.pointerdownY=d,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove),this.screen.addScrollListener("both",this.scale/2,!1,()=>{this.screen.beginScrolling(),this.screen.rawScrollLeft=this.screen.scrollLeft,this.screen.rawScrollTop=this.screen.scrollTop,this.updateTransform(),this.requestRendering(),this.screen.updateScrollbars(),this.pointermove(t.latest)})),this.setTarget(e);break}}break;case 2:var u=this.marquee;switch(this.layer){case"object":(this.dragging=t).mode="ready-to-scroll",t.scrollLeft=this.screen.scrollLeft,t.scrollTop=this.screen.scrollTop,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove);break;case"tilemap":var{x:p,y:m}=this.getTileCoords(t,!0),g=this.tilemap??this,f=g.width,g=g.height;0<=p&&p<f&&0<=m&&m<g&&("eraser"===this.brush&&this.switchBrush("pencil"),(this.dragging=t).mode="copy",t.pointerdownX=p,t.pointerdownY=m,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove),u.selectInCopyMode(p,m,1,1));break;case"terrain":this.switchTerrain()}break;case 3:"tilemap"===this.layer&&Ue.flipTiles();break;case 4:(this.dragging=t).mode="scroll",t.scrollLeft=this.screen.scrollLeft,t.scrollTop=this.screen.scrollTop,this.marquee.clear(),pt.open("cursor-grab"),window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}}.bind(A),A.marqueePointermove=function(e){var t=this.marquee;if(!this.dragging)switch(t.pointerevent=e,this.layer){case"tilemap":case"terrain":var{x:i,y:a}=this.getTileCoords(e,!0),n=this.tilemap??this,i=i+t.offsetX,a=a+t.offsetY,s=t.width,r=t.height,o=n.width,n=n.height;0<i+s&&i<o&&0<a+r&&a<n?i===t.x&&a===t.y&&t.visible||t.selectInPencilMode(i,a):t.clear();break;case"object":this.target||({x:s,y:o}=this.getTileCoords(e,!0),r=this.width,n=this.height,0<=s&&s<r&&0<=o&&o<n?s===t.x&&o===t.y&&t.visible||t.selectInObjectMode(s,o):t.clear())}}.bind(A),A.marqueePointerleave=function(e){null!==this.marquee.pointerevent&&(this.marquee.pointerevent=null,this.dragging||"object"===this.layer&&null!==this.target||this.marquee.clear())}.bind(A),A.marqueeDoubleclick=function(e){switch(this.layer){case"object":this.target&&("tilemap"===this.target.class?(this.screenBlur(),this.openTilemap(this.target)):(this.screenBlur(),this.revealTarget()));break;case"tilemap":var{x:t,y:i}=this.getTileCoords(e),{width:a,height:n}=this.getGridContext();(t<0||i<0||a<=t||n<=i)&&(this.screenBlur(),this.closeTilemap())}}.bind(A),A.pointerup=function(e){var t=this["dragging"];if(null!==t&&t.relate(e=void 0===e?t:e)){switch(t.mode){case"eraser":case"pencil":var i=this.marquee;null===i.pointerevent&&i.clear(),this.saveMapRecord();break;case"rect":case"oval":i=this.marquee;null===i.pointerevent&&i.clear(),i.restore(),null!==i.pointerevent&&(a=(n=this.getTileCoords(e,!0)).x+i.offsetX,n=n.y+i.offsetY,i.selectInPencilMode(a,n)),this.saveMapRecord();break;case"copy":var i=this.marquee,a=this.getTileCoords(e,!0),n=this.tilemap??this,s=Math.clamp(a.x,0,n.width-1),a=Math.clamp(a.y,0,n.height-1);i.offsetX=i.x-s,i.offsetY=i.y-a,null!==i.pointerevent?i.selectInPencilMode():i.clear(),Ue.copyTilesFromScene(i.x,i.y,i.width,i.height);break;case"object-move":this.screen.endScrolling(),this.screen.removeScrollListener();break;case"ready-to-scroll":e.target===this.marquee&&({x:n,y:s}=this.getTileCoords(e),a=this.selectObject(n,s),this.setTarget(a),this.menuPopup(e));break;case"scroll":this.screen.endScrolling(),pt.close("cursor-grab")}this.dragging=null,window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove)}}.bind(A),A.pointermove=function(i){var{dragging:a,marquee:t}=this;if(a.relate(i))switch(a.mode){case"eraser":case"pencil":var n=t.width,s=t.height,r=t.offsetX,o=t.offsetY,e=this.getTileCoords(i,!0),l=this.tilemap??this,r=Math.clamp(e.x,1-r-n,l.width-1-r)+r,e=Math.clamp(e.y,1-o-s,l.height-1-o)+o;if(r!==t.x||e!==t.y){l=Math.abs(r-t.x),o=Math.abs(e-t.y);if(1<l&&n<9||1<o&&s<9){var c=Math.max(l,o),h=(r-t.x)/c,d=(e-t.y)/c;for(let e=1;e<c;e++){var u=t.x+Math.round(e*h),p=t.y+Math.round(e*d);this.edit(u,p,n,s)}}t.selectInPencilMode(r,e),this.edit(r,e,n,s)}break;case"rect":case"oval":l=this.getTileCoords(i,!0),o=Math.min(l.x,a.pointerdownX),r=Math.min(l.y,a.pointerdownY),e=Math.abs(l.x-a.pointerdownX)+1,l=Math.abs(l.y-a.pointerdownY)+1;o===t.x&&r===t.y&&e===t.width&&l===t.height||(t.selectInRectMode(o,r,e,l),this.edit(o,r,e,l));break;case"copy":o=this.getTileCoords(i,!0),r=this.tilemap??this,e=Math.clamp(o.x,0,r.width-1),l=Math.clamp(o.y,0,r.height-1),o=Math.min(e,a.pointerdownX),r=Math.min(l,a.pointerdownY),e=Math.abs(e-a.pointerdownX)+1,l=Math.abs(l-a.pointerdownY)+1;o===t.x&&r===t.y&&e===t.width&&l===t.height||this.marquee.selectInCopyMode(o,r,e,l);break;case"object-move":{if(!a.enabled){o=i.clientX-a.clientX,r=i.clientY-a.clientY;if(!(4<Math.sqrt(o**2+r**2)||500<=i.timeStamp-a.timeStamp))break;a.enabled=!0}a.latest=i;var m=this.width,g=this.height,f=this.getTileCoords(i);let e,t;switch(this.target?.class){case"actor":var v=this.target.data?.size??1,v=Math.max(v,1)/2;t=this.shiftKey?(e=a.startX-a.pointerdownX+f.x,t=a.startY-a.pointerdownY+f.y,e=Math.roundTo(Math.clamp(e,v,m-v),4),Math.roundTo(Math.clamp(t,v,g-v),4)):(e=a.startX-Math.floor(a.pointerdownX)+Math.floor(f.x),t=a.startY-Math.floor(a.pointerdownY)+Math.floor(f.y),e=Math.clamp(e,v,m-v),Math.clamp(t,v,g-v)),this.shiftTarget(e,t);break;case"region":var v=this.target,b=v.width/2,v=v.height/2;t=this.shiftKey?(e=a.startX-a.pointerdownX+f.x,t=a.startY-a.pointerdownY+f.y,e=Math.roundTo(Math.clamp(e,b,m-b),4),Math.roundTo(Math.clamp(t,v,g-v),4)):(e=a.startX-Math.floor(a.pointerdownX)+Math.floor(f.x),t=a.startY-Math.floor(a.pointerdownY)+Math.floor(f.y),e=Math.clamp(e,b,m-b),Math.clamp(t,v,g-v)),this.shiftTarget(e,t);break;case"tilemap":case"light":case"animation":case"particle":case"parallax":t=this.shiftKey?(e=a.startX-a.pointerdownX+f.x,t=a.startY-a.pointerdownY+f.y,e=Math.roundTo(Math.clamp(e,0,m),4),Math.roundTo(Math.clamp(t,0,g),4)):(e=a.startX-Math.floor(a.pointerdownX)+Math.floor(f.x),t=a.startY-Math.floor(a.pointerdownY)+Math.floor(f.y),e=Math.clamp(e,0,m),Math.clamp(t,0,g)),this.shiftTarget(e,t)}break}case"ready-to-scroll":e=i.clientX-a.clientX,l=i.clientY-a.clientY;this.screen.setScroll(a.scrollLeft-e,a.scrollTop-l),4<Math.sqrt(e**2+l**2)&&(a.mode="scroll",pt.open("cursor-grab"));break;case"scroll":o=i.clientX-a.clientX,r=i.clientY-a.clientY;this.screen.beginScrolling(),this.screen.setScroll(a.scrollLeft-o,a.scrollTop-r)}}.bind(A),A.menuPopup=function(e){const{x:t,y:i}=this.getTileCoords(e,!0);var a,n,s,r=0<=t&&t<this.width&&0<=i&&i<this.height;(this.target||r)&&(this.translationKeyup(),a=!!this.target,n=Clipboard.has("yami.scene.object"),s=N.createGetter("menuScene"),ve.popup({x:e.clientX,y:e.clientY},[{label:s("create"),enabled:r,submenu:[{label:s("create.actor"),click:()=>{this.create("actor",t+.5,i+.5)}},{label:s("create.region"),click:()=>{this.create("region",t+.5,i+.5)}},{label:s("create.light"),click:()=>{this.create("light",t+.5,i+.5)}},{label:s("create.animation"),click:()=>{this.create("animation",t+.5,i+.5)}},{label:s("create.particleEmitter"),click:()=>{this.create("particle",t+.5,i+.5)}},{label:s("create.parallax"),click:()=>{this.create("parallax",t,i)}},{label:s("create.tilemap"),click:()=>{this.create("tilemap",t,i)}}]},{type:"separator"},{label:s("cut"),accelerator:p("X"),enabled:a,click:()=>{this.copy(),this.delete()}},{label:s("copy"),accelerator:p("C"),enabled:a,click:()=>{this.copy()}},{label:s("paste"),accelerator:p("V"),enabled:n,click:()=>{this.paste(t,i)}},{label:s("delete"),accelerator:"Delete",enabled:a,click:()=>{this.delete()}},{type:"separator"},{label:s("setStartPosition"),click:()=>{var e=He.config["startPosition"];e.sceneId=this.meta.guid,e.x=t+.5,e.y=i+.5,this.requestRendering(),R.planToSave(He.manifest.project.config)}}]))},A.searcherInput=function(e){"insertCompositionText"!==e.inputType&&(e=this.input.value,A.list.searchNodes(e))},A.listKeydown=function(e){if(this.data){var t=this.read(),i=t&&"folder"!==t.class;if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":i&&(this.copy(t),this.delete(t));break;case"KeyC":i&&this.copy(t);break;case"KeyV":this.paste("auto")}else switch(e.code){case"Delete":this.delete(t);break;case"Backspace":this.cancelSearch();break;case"Escape":A.setTarget(null)}}},A.listPointerdown=function(e){switch(e.button){case 0:var t=e.target;switch(t.tagName){case"VISIBILITY-ICON":var i=t.parentNode["item"];if(!this.canSwitchState(i))return;var a=i["hidden"],n=this.setRecursiveStates(i,"hidden",!a);this.updateFolderState(i.parent,"hidden"),this.update(),this.dispatchChangeEvent(),A.requestRendering(),A.history.save({type:"scene-object-hidden",item:i,oldValues:n,newValue:!a});break;case"LOCK-ICON":i=t.parentNode["item"];if(!this.canSwitchState(i))return;n=i["locked"],a=this.setRecursiveStates(i,"locked",!n);this.updateFolderState(i.parent,"locked"),this.update(),this.dispatchChangeEvent(),A.history.save({type:"scene-object-locked",item:i,oldValues:a,newValue:!n})}break;case 3:this.cancelSearch()}},A.listSelect=function(e){var t=e.value;switch(t.class){case"folder":A.setTarget(null);break;case"tilemap":A.tilemap?("closed"===Ue.state&&A.setTarget(t),A.openTilemap(t)):A.setTarget(t);break;default:A.setTarget(t)}},A.listRecord=function(e){var t=e.value;switch(t.type){case"rename":A.listRename(t);break;case"create":{let e=t.dItem;"folder"!==e.class&&(e=e.parent??e),this.updateFolderState(e,"hidden"),this.updateFolderState(e,"locked"),A.history.save({type:"scene-object-create",response:t,parent:e});break}case"delete":var i=t.item.parent;this.updateFolderState(i,"hidden"),this.updateFolderState(i,"locked"),A.history.save({type:"scene-object-delete",response:t});break;case"remove":var i=t.source.parent,a=t.destination.parent;this.updateFolderState(i,"hidden"),this.updateFolderState(i,"locked"),i!==a&&(this.updateFolderState(a,"hidden"),this.updateFolderState(a,"locked")),A.history.save({type:"scene-object-remove",response:t})}},A.listPopup=function(e){const i=e.value;var t=[],a=N.createGetter("menuSceneList");let n,s,r,o;if(i){switch(i.class){case"folder":n=!1;break;case"tilemap":n=!0,t.push({label:a("edit"),accelerator:"Enter",click:()=>{A.openTilemap(i)}},{label:a("shift"),enabled:0!==i.tiles.length,click:()=>{Et.open((e,t)=>{A.history.save({type:"scene-tilemap-shift",tilemap:i,shiftX:e,shiftY:t}),A.shiftTilemap(i,e,t)})}},{label:a("reveal"),click:()=>{A.revealTarget()}},{label:a("shortcut"),submenu:this.createTilemapShortcutItems(i)});break;case"actor":case"region":case"light":case"animation":case"particle":case"parallax":n=!0,t.push({label:a("reveal"),accelerator:"Enter",click:()=>{A.revealTarget()}})}s=Clipboard.has("yami.scene.object"),r=!0,o=!0}else n=!1,s=Clipboard.has("yami.scene.object"),r=!1,o=!1;t.push({label:a("create"),submenu:[{label:a("create.folder"),click:()=>{this.addNodeTo(this.createFolder(),i)}},{label:a("create.actor"),click:()=>{this.addNodeTo(j.sceneActor.create(),i)}},{label:a("create.region"),click:()=>{this.addNodeTo(j.sceneRegion.create(),i)}},{label:a("create.light"),click:()=>{this.addNodeTo(j.sceneLight.create(),i)}},{label:a("create.animation"),click:()=>{this.addNodeTo(j.sceneAnimation.create(),i)}},{label:a("create.particleEmitter"),click:()=>{this.addNodeTo(j.sceneParticle.create(),i)}},{label:a("create.parallax"),click:()=>{this.addNodeTo(j.sceneParallax.create(),i)}},{label:a("create.tilemap"),click:()=>{j.fileTileset.close(),this.addNodeTo(j.sceneTilemap.create(A.width,A.height),i)}}]},{type:"separator"},{label:a("cut"),accelerator:p("X"),enabled:n,click:()=>{this.copy(i),this.delete(i)}},{label:a("copy"),accelerator:p("C"),enabled:n,click:()=>{this.copy(i)}},{label:a("paste"),accelerator:p("V"),enabled:s,click:()=>{this.paste(i)}},{label:a("delete"),accelerator:"Delete",enabled:r,click:()=>{this.delete(i)}},{label:a("rename"),accelerator:"F2",enabled:o,click:()=>{this.rename(i)}}),i||t.push({type:"separator"},{label:a("shiftAll"),click:()=>{Et.open((e,t)=>{var i=A.computeObjectShifting(e,t);A.history.save({type:"scene-shift",shiftX:e,shiftY:t,changes:i}),A.shiftTerrains(e,t),A.shiftObjects(i)})}},{label:a("settings"),click:()=>{Ct.open()}}),ve.popup({x:e.clientX,y:e.clientY},t)},A.listOpen=function(e){var t=e.value;switch(t.class){case"tilemap":A.openTilemap(t);break;case"actor":case"region":case"light":case"animation":case"particle":case"parallax":A.revealTarget()}},A.listRename=function(e){var t,i,a,n=e.item;"folder"===n.class?A.history.save({type:"scene-folder-rename",response:e}):(t=A.inspectorTypeMap[n.class],{oldValue:e,newValue:a}=e,(i=(t=j[t]).nameBox).write(a),A.updateTargetInfo(),A.requestRendering(),A.history.save({type:"inspector-change",editor:t,target:n,changes:[{input:i,oldValue:e,newValue:a}]}))},A.listChange=function(e){A.planToSave()},A.listPageResize=function(e){A.list.updateHead(),A.list.resize()},A.marquee.save=function(e="default"){let t;switch(e){case"object":t={};break;case"tile":t={x:this.x,y:this.y,width:this.width,height:this.height,offsetX:this.offsetX,offsetY:this.offsetY,tiles:this.tiles};break;case"terrain":t={x:this.x,y:this.y,width:this.width,height:this.height,offsetX:this.offsetX,offsetY:this.offsetY,terrain:this.terrain};break;case"eraser":t={x:this.x,y:this.y,width:this.width,height:this.height,offsetX:this.offsetX,offsetY:this.offsetY,tiles:this.tiles,terrain:0};break;default:t={x:this.x,y:this.y,width:this.width,height:this.height,offsetX:this.offsetX,offsetY:this.offsetY}}this.saveData[e]=t},A.marquee.switch=function(e){this.key!==e&&(this.save(this.key),this.restore(this.key=e))},A.marquee.resize=function(){null!==this.pointerevent&&A.marqueePointermove(this.pointerevent)},A.marquee.clear=function(){this.visible&&(this.visible=!1,A.requestRendering()),!A.info.textContent||"object"===A.layer&&null!==A.target||(A.info.textContent="")},A.marquee.select=function(e=this.x,t=this.y,i=this.width,a=this.height){this.x=e,this.y=t,this.width=i,this.height=a,this.visible=!0,A.requestRendering()},A.marquee.selectInPencilMode=function(e,t,i,a){this.backgroundColor=this.backgroundColorNormal,this.borderColor=this.borderColorNormal,this.previewTiles=!0,this.select(e,t,i,a);e=this.x-this.offsetX,t=this.y-this.offsetY;A.info.textContent=e+","+t},A.marquee.selectInRectMode=function(e,t,i,a){this.backgroundColor=this.backgroundColorRect,this.borderColor=this.borderColorRect,this.previewTiles=!1,this.select(e,t,i,a),A.info.textContent=this.width+" x "+this.height},A.marquee.selectInCopyMode=function(e,t,i,a){this.backgroundColor=this.backgroundColorCopy,this.borderColor=this.borderColorCopy,this.previewTiles=!1,this.select(e,t,i,a),A.info.textContent=this.width+" x "+this.height},A.marquee.selectInObjectMode=function(e,t){A.info.textContent=e+","+t},A.marquee.getTiles=function(e){var t=this.tiles;if(e)return t;let i=t.standard;if(void 0===i){i=t;var a=this.tilesetMap,n=He.tilesets,s=t.length;for(let e=0;e<s;e++){var r=t[e];0!==r&&"auto"===n[a[r>>24]]?.type&&((i=i===t?A.cloneTiles(t):i)[e]=4294967232&r)}t.standard=i}return i},A.list.copy=function(e){e&&("tilemap"===e.class&&_e.encodeTilemap(e),Clipboard.write("yami.scene.object",e))},A.list.paste=function(e,t){var i,a=Clipboard.read("yami.scene.object");a&&this.data&&("tilemap"===a.class&&(_e.decodeTilemap(a),a.shortcut=0),"auto"===e&&(e=(i=P.project.scene.defaultFolders[a.class])?this.getItemByProperties({class:"folder",name:i}):null),t?.(a),this.addNodeTo(a,e),A.requestRendering())},A.list.delete=function(e){e&&this.deleteNode(e)},A.list.cancelSearch=function(){var e;"search"===this.display&&(e=document.activeElement,A.searcher.deleteInputContent(),this.expandToSelection(),this.scrollToSelection(),e.focus())},A.list.createFolder=function(){return{class:"folder",name:"New Folder",expanded:!1,hidden:!0,locked:!0,children:[]}},A.list.createTilemapShortcutItems=function(t){const i=A.tilemaps["shortcuts"],a=t["shortcut"];var n=[];for(let e=0;e<7;e++){var s=i[e],r=a===e,o=()=>{a!==e&&(t.shortcut=e,i.update(),A.planToSave(),A.history.save({type:"scene-tilemap-shortcut",tilemap:t,shortcut:a}))};0===e?n.push({label:N.get("menuSceneList.shortcut.none"),checked:r,click:o}):n.push({label:e+": "+(s?.name??""),enabled:!s||r,checked:r,click:o})}return n},A.list.restoreRecursiveStates=function(){const r=(e,t,i,a)=>{void 0!==e[t]&&(e[t]=i[a++]);var n=e.children;if(void 0!==n){var s=n.length;for(let e=0;e<s;e++)a=r(n[e],t,i,a)}return a};return function(e,t,i){return r(e,t,i,0)}}(),A.list.setRecursiveStates=function(){const r=(e,t,i,a)=>{void 0!==e[t]&&(a.push(e[t]),e[t]=i);var n=e.children;if(void 0!==n){var s=n.length;for(let e=0;e<s;e++)r(n[e],t,i,a)}return a};return function(e,t,i){return r(e,t,i,[])}}(),A.list.updateFolderState=function(){let n;const t=A.list,i=e=>{if("folder"===e.class){var t=e,e=t.children;if(t[n]){for(const i of e)if(!1===i[n])return void s(t)}else{for(const a of e)if(!1===a[n])return;s(t)}}},s=e=>{switch(e[n]=!e[n],n){case"hidden":t.updateVisibilityIcon(e);break;case"locked":t.updateLockIcon(e)}i(e.parent)};return function(e,t){return n=t,i(e)}}(),A.list.canSwitchState=function(){const i=e=>{if("folder"!==e.class)return!0;for(const t of e.children)if(i(t))return!0;return!1};return function(e){return i(e)}}(),A.list.createIcon=function(){const t={folder:()=>{var e=document.createElement("node-icon");return e.addClass("icon-folder"),e},actor:e=>{var e=He.teams.map[e.teamId],e=e?e.color:"ffffffff",t=parseInt(e.slice(0,2),16),i=parseInt(e.slice(2,4),16),a=parseInt(e.slice(4,6),16),e=parseInt(e.slice(6,8),16)/255,n=document.createElement("node-icon");return n.textContent="",n.style.color=`rgba(${t}, ${i}, ${a}, ${e})`,n},region:e=>{var e=e.color,t=parseInt(e.slice(0,2),16),i=parseInt(e.slice(2,4),16),a=parseInt(e.slice(4,6),16),e=parseInt(e.slice(6,8),16)/255,n=document.createElement("node-icon");return n.addClass("icon-scene-region"),n.style.backgroundColor=`rgba(${t}, ${i}, ${a}, ${e})`,n},light:e=>{var t=document.createElement("node-icon"),i=e.red,a=e.green,e=e.blue;return t.textContent="",t.style.color=`rgba(${i}, ${a}, ${e})`,t},animation:()=>{var e=document.createElement("node-icon");return e.textContent="",e},particle:()=>{var e=document.createElement("node-icon");return e.textContent="",e},parallax:e=>{var t=document.createElement("node-icon"),e=R.getPath(e.image);return e?(t.addClass("icon-scene-parallax"),t.style.backgroundImage=CSS.encodeURL(R.route(e))):t.textContent="",t},tilemap:()=>{var e=document.createElement("node-icon");return e.textContent="",e}};return function(e){return t[e.class](e)}}(),A.list.updateIcon=function(e){var t=e["element"];t?.nodeIcon&&(e=this.createIcon(e),t.replaceChild(e,t.nodeIcon),t.nodeIcon=e)},A.list.updateHead=function(){var e,{page:t,head:i}=this;0!==t.clientWidth&&(t=x.getGroupOfElement(i)["nav"],e=t.rect(),t=t.lastChild.rect().right-e.left,i.left!==t)&&(i.left=t,i.style.left=t+"px")},A.list.updateTilemapClass=function(e){e===A.tilemap&&e.element.addClass("highlight")},A.list.createConditionIcon=function(e){var t;e.conditions instanceof Array&&(e=e["element"],(t=document.createElement("node-icon")).addClass("icon-conditional"),e.appendChild(t),e.conditionIcon=t,e.condition="")},A.list.updateConditionIcon=function(t){var i=t["element"];if(void 0!==i.conditionIcon){t=t["conditions"];let e="none";if(0!==t.length){e="conditional";for(var{type:a}of t)if("absent"===a){e="absent";break}}if(i.condition!==e){i.condition=e;var n=i.conditionIcon;switch(e){case"none":n.hide();break;case"conditional":n.textContent="?",n.show();break;case"absent":n.textContent="!",n.show()}}}},A.list.createEventIcon=function(e){var t;e.events instanceof Array&&(e=e["element"],(t=document.createElement("node-icon")).addClass("icon-eventEnabled"),t.textContent="E",e.appendChild(t),e.eventIcon=t,e.eventEnabled=null)},A.list.updateEventIcon=function(e){var t=e["element"];void 0!==t.eventIcon&&(e=0!==e.events.length,t.eventEnabled!==e)&&((t.eventEnabled=e)?t.eventIcon.show():t.eventIcon.hide())},A.list.createScriptIcon=function(e){var t;e.scripts instanceof Array&&(e=e["element"],(t=document.createElement("node-icon")).addClass("icon-scriptEnabled"),t.textContent="",e.appendChild(t),e.scriptIcon=t,e.scriptEnabled=null)},A.list.updateScriptIcon=function(e){var t=e["element"];void 0!==t.scriptIcon&&(e=0!==e.scripts.length,t.scriptEnabled!==e)&&((t.scriptEnabled=e)?t.scriptIcon.show():t.scriptIcon.hide())},A.list.createVisibilityIcon=function(e){var e=e["element"],t=document.createElement("visibility-icon");e.appendChild(t),e.hiddenIcon=t,e.hiddenState=null},A.list.updateVisibilityIcon=function(e){var t,i=e["element"];i.hiddenState!==e.hidden&&(t=i["hiddenIcon"],(i.hiddenState=e.hidden)?(t.textContent="",t.addClass("node-icon-highlight")):(t.textContent="",t.removeClass("node-icon-highlight")))},A.list.createLockIcon=function(e){var e=e["element"],t=document.createElement("lock-icon");e.appendChild(t),e.lockIcon=t,e.lockState=null},A.list.updateLockIcon=function(e){var t,i=e["element"];i.lockState!==e.locked&&(t=i["lockIcon"],(i.lockState=e.locked)?(t.textContent="",t.addClass("node-icon-highlight")):(t.textContent="",t.removeClass("node-icon-highlight")))},A.list.onCreate=function(e){"folder"!==e.class&&(A.setPresetId(e),A.loadObjects(),A.loadObjectContext(e),A.requestRendering())},A.list.onRemove=function(){A.loadObjects(),A.requestRendering()},A.list.onDelete=function(e){A.updateTarget(),A.loadObjects(),A.destroyObjectContext(e),A.requestRendering()},A.list.onResume=function(e){A.loadObjects(),A.reloadObjectContext(e),A.requestRendering()},A.Textures=class{state;constructor(){this.state="open",this[""]=null}append(e){"open"===this.state&&(this[e.base.guid]=e)}load(t){if(!this[t]){const i=new $e(t);if(i.complete)return this[t]=i,Promise.resolve().then(()=>(A.requestRendering(),i));this[t]=new Promise(e=>{i.on("load",()=>"open"===this.state&&this[t]instanceof Promise?(this[t]=i,A.requestRendering(),e(i)):(i.destroy(),e(null)))})}return this[t]}destroy(){this.state="closed";for(const e of Object.values(this))e instanceof $e&&e.destroy()}},A.Point=class{x;y;constructor(){this.x=0,this.y=0}set(e,t){return this.x=e,this.y=t,this}};const Ct={initialize:null,open:null,confirm:null},Et=(Ct.initialize=function(){_("#object-folder-confirm").on("click",this.confirm)},Ct.open=function(){O.open("object-folder");var e=P.project.scene.defaultFolders,e=D("object-folder",e);e("tilemap"),e("actor"),e("region"),e("light"),e("animation"),e("particle"),e("parallax")},Ct.confirm=function(e){var t=g("object-folder");P.project.scene.defaultFolders={tilemap:t("tilemap"),actor:t("actor"),region:t("region"),light:t("light"),animation:t("animation"),particle:t("particle"),parallax:t("parallax")},O.close("object-folder")},{callback:null,initialize:null,open:null,windowClosed:null,confirm:null});Et.initialize=function(){_("#scene-shift").on("closed",this.windowClosed),_("#scene-shift-confirm").on("click",this.confirm)},Et.open=function(e){this.callback=e,O.open("scene-shift"),_("#scene-shift-x").write(0),_("#scene-shift-y").write(0),_("#scene-shift-x").getFocus("all")},Et.windowClosed=function(e){Et.callback=null},Et.confirm=function(e){var t=_("#scene-shift-x").read(),i=_("#scene-shift-y").read();if(0===t&&0===i)return _("#scene-shift-x").getFocus();Et.callback(t,i),O.close("scene-shift")};class Mt{constructor(e){this.tilemaps=e,this.reset()}reset(){this[1]=null,this[2]=null,this[3]=null,this[4]=null,this[5]=null,this[6]=null}update(){this.reset();for(const s of this.tilemaps){var e=s["shortcut"];0!==e&&(this[e]=s)}var t=Mt["elements"],i=A.tilemap;for(let e=1;e<=6;e++){var a=t[e],n=this[e];n?(n===i&&a.addClass("selected"),a.show()):(a.removeClass("selected"),a.hide())}A.head.width=0,A.updateHead()}static elements={1:_("#scene-layer-tilemap-1"),2:_("#scene-layer-tilemap-2"),3:_("#scene-layer-tilemap-3"),4:_("#scene-layer-tilemap-4"),5:_("#scene-layer-tilemap-5"),6:_("#scene-layer-tilemap-6")};static initialize(){var e=this["elements"];for(let t=1;t<=6;t++)e[t].setTooltip(()=>{var e=A.tilemaps?.shortcuts[t];return e?e.name:""})}}class St{data;shiftX;shiftY;texture;constructor(e){this.data=e,this.shiftX=0,this.shiftY=0,this.texture=null,this.loadTexture()}update(e){var t,{shiftSpeedX:i,shiftSpeedY:a}=this.data;0===i&&0===a||(t=this.texture)instanceof $e&&(this.shiftX=(this.shiftX+i*e/1e3/t.width)%1,this.shiftY=(this.shiftY+a*e/1e3/t.height)%1)}draw(e){var t,i,a,n,s,r,o,l,c,h,d,u,p,m,g,f,v=this.texture;v instanceof $e?(t=We,i=this.data,a=t.arrays[0].float32,p=v.width*i.scaleX*i.repeatX,r=v.height*i.scaleY*i.repeatY,u=i.offsetX,s=i.offsetY,f=i.anchorX*p,h=i.anchorY*r,u=(f=(n=A.getParallaxAnchor(i)).x-f+u)+p,h=(p=n.y-h+s)+r,s=A.scrollLeft,r=A.scrollTop,o=A.scrollRight,l=A.scrollBottom,f<o&&s<u&&p<l&&r<h&&(c=this.shiftX,g=this.shiftY,m=c+i.repeatX,d=g+i.repeatY,a[0]=f,a[1]=p,a[2]=c,a[3]=g,a[4]=f,a[5]=h,a[6]=c,a[7]=d,a[8]=u,a[9]=h,a[10]=m,a[11]=d,a[12]=u,a[13]=p,a[14]=m,a[15]=g,t.blend=i.blend,t.alpha=i.opacity,-1!==(f=A.activeTilemapId)&&f<e&&(t.alpha*=.25),c=t.imageProgram.use(),d=(h=i.tint)[0]/255,u=h[1]/255,p=h[2]/255,m=h[3]/255,f=St.lightSamplingModes[g=A.showLight?i.light:"raw"],e=t.matrix.project(t.flip,o-s,l-r).translate(-s,-r),t.bindVertexArray(c.vao),t.uniformMatrix3fv(c.u_Matrix,!1,e),t.uniform1i(c.u_LightMode,f),"anchor"===g&&t.uniform2f(c.u_LightCoord,n.x,n.y),t.uniform1i(c.u_ColorMode,0),t.uniform4f(c.u_Tint,d,u,p,m),t.bufferData(t.ARRAY_BUFFER,a,t.STREAM_DRAW,0,16),t.bindTexture(t.TEXTURE_2D,v.base.glTexture),t.drawArrays(t.TRIANGLE_FAN,0,4),t.blend="normal")):this.drawDefaultImage()}drawDefaultImage(){var e=this.data,t=128*e.scaleX*e.repeatX,i=128*e.scaleY*e.repeatY,a=e.offsetX,n=e.offsetY,s=e.anchorX*t,r=e.anchorY*i,o=A.getParallaxAnchor(e),s=o.x-s+a,a=o.y-r+n;We.matrix.set(A.matrix),We.alpha=e.opacity,We.blend=e.blend,We.fillRect(s,a,t,i,2164260863)}loadTexture(){var e=this.data.image;if(e){e=new $e(e);if((this.texture=e).complete)return e;this.update=Function.empty,this.draw=Function.empty,e.on("load",()=>{A.requestRendering(),delete this.update,delete this.draw})}}destroy(){this.texture instanceof $e&&this.texture.destroy(),this.texture=null}static lightSamplingModes={raw:0,global:1,anchor:2,ambient:3}}class At{data;angle;anchorOffsetX;anchorOffsetY;measureOffsetX;measureOffsetY;measureWidth;measureHeight;constructor(e){this.data=e,this.measure()}draw(e){switch(this.data.type){case"point":return this.drawPointLight(e);case"area":return this.drawAreaLight(e)}}drawPointLight(e){var t=We,i=t.arrays[0].float32,a=this.data,n=a.range/2,s=a.x,r=a.y,o=s-n,l=r-n,s=s+n,r=r+n,n=(i[0]=o,i[1]=l,i[2]=0,i[3]=0,i[4]=o,i[5]=r,i[6]=0,i[7]=1,i[8]=s,i[9]=r,i[10]=1,i[11]=1,i[12]=s,i[13]=l,i[14]=1,i[15]=0,t.blend=a.blend,t.lightProgram.use()),o=a.red/255,r=a.green/255,s=a.blue/255,l=a.intensity;t.bindVertexArray(n.vao),t.uniformMatrix3fv(n.u_Matrix,!1,e),t.uniform1i(n.u_LightMode,0),t.uniform4f(n.u_LightColor,o,r,s,l),t.bufferData(t.ARRAY_BUFFER,i,t.STREAM_DRAW,0,16),t.drawArrays(t.TRIANGLE_FAN,0,4)}drawAreaLight(e){var t,i,a,n,s,r,o,l=this.data,c=A.textures,h=c[l.mask];if(void 0===h)return c.load(l.mask);h instanceof Promise||(t=(c=We).arrays[0].float32,i=l.x,a=l.y,n=i-this.anchorOffsetX,o=a-this.anchorOffsetY,r=n+l.width,s=o+l.height,t[0]=n,t[1]=o,t[2]=0,t[3]=0,t[4]=n,t[5]=s,t[6]=0,t[7]=1,t[8]=r,t[9]=s,t[10]=1,t[11]=1,t[12]=r,t[13]=o,t[14]=1,t[15]=0,c.blend=l.blend,n=c.lightProgram.use(),s=null!==h?1:2,r=l.red/255,o=l.green/255,l=l.blue/255,e=c.matrix.set(e).rotateAt(i,a,this.angle),c.bindVertexArray(n.vao),c.uniformMatrix3fv(n.u_Matrix,!1,e),c.uniform1i(n.u_LightMode,s),c.uniform4f(n.u_LightColor,r,o,l,0),c.bufferData(c.ARRAY_BUFFER,t,c.STREAM_DRAW,0,16),c.bindTexture(c.TEXTURE_2D,h?.base.glTexture),c.drawArrays(c.TRIANGLE_FAN,0,4))}measure(){var e,t,i,a,n,s,r,o,l,c,h,d,u,p,m=this.data;"area"===m.type&&(d=m.width,i=m.height,d=(p=-(e=d*m.anchorX))+d,i=(c=-(t=i*m.anchorY))+i,m=Math.radians(m.angle),r=Math.atan2(c,p)+m,l=Math.atan2(c,d)+m,h=Math.atan2(i,d)+m,u=Math.atan2(i,p)+m,o=Math.sqrt(p*p+c*c),c=Math.sqrt(d*d+c*c),d=Math.sqrt(d*d+i*i),p=Math.sqrt(p*p+i*i),i=Math.cos(r)*o,a=Math.cos(l)*c,n=Math.cos(h)*d,s=Math.cos(u)*p,r=Math.sin(r)*o,o=Math.sin(l)*c,l=Math.sin(h)*d,c=Math.sin(u)*p,h=Math.min(i,a,n,s),d=Math.min(r,o,l,c),u=Math.max(Math.abs(i-n),Math.abs(a-s)),p=Math.max(Math.abs(r-l),Math.abs(o-c)),this.angle=m,this.anchorOffsetX=e,this.anchorOffsetY=t,this.measureOffsetX=h,this.measureOffsetY=d,this.measureWidth=u,this.measureHeight=p)}}const Y={state:"closed",page:_("#ui"),head:_("#ui-head"),body:_("#ui-body").hide(),screen:_("#ui-screen"),marquee:_("#ui-marquee"),searcher:_("#ui-searcher"),list:_("#ui-list"),dragging:null,target:null,hover:null,history:null,controlPoints:null,controlPointActive:null,controlPointRotation:null,controlPointTexture:null,translationKey:0,translationTimer:null,background:null,foreground:null,matrix:null,zoom:null,zoomTimer:null,scale:null,scaleX:null,scaleY:null,outerWidth:null,outerHeight:null,scrollLeft:null,scrollTop:null,scrollRight:null,scrollBottom:null,centerX:null,centerY:null,centerOffsetX:null,centerOffsetY:null,padding:null,paddingLeft:null,paddingTop:null,inspectorTypeMap:null,context:null,meta:null,width:null,height:null,nodes:null,root:null,initialize:null,open:null,load:null,save:null,close:null,destroy:null,copy:null,paste:null,create:null,delete:null,toggle:null,undo:null,redo:null,setZoom:null,setSize:null,setHover:null,setTarget:null,revealTarget:null,shiftAnchor:null,shiftTarget:null,resizeTarget:null,rotateTarget:null,setControlPoint:null,updateHover:null,updateTarget:null,updateTargetItem:null,updateElementFont:null,updateIndexedColor:null,updateControlPoints:null,updateElement:null,deleteElement:null,updateHead:null,resize:null,getPointerCoords:null,updateCamera:null,updateTransform:null,setPresetId:null,unlinkPresetId:null,loadElement:null,drawBackground:null,drawElements:null,drawCoordinateAxes:null,drawHoverWireframe:null,drawTargetWireframe:null,drawTargetAnchor:null,drawControlPoints:null,selectControlPoint:null,selectObject:null,requestRendering:null,renderingFunction:null,stopRendering:null,switchSettings:null,updateFont:null,planToSave:null,saveToConfig:null,loadFromConfig:null,saveToProject:null,loadFromProject:null,webglRestored:null,windowResize:null,themechange:null,datachange:null,keydown:null,headPointerdown:null,switchPointerdown:null,zoomFocus:null,zoomInput:null,screenKeydown:null,translationKeyup:null,screenWheel:null,screenUserscroll:null,screenBlur:null,marqueePointerdown:null,marqueePointermove:null,marqueePointerleave:null,marqueeDoubleclick:null,pointerup:null,pointermove:null,menuPopup:null,searcherInput:null,listKeydown:null,listPointerdown:null,listSelect:null,listRecord:null,listPopup:null,listOpen:null,listRename:null,listChange:null,listPageResize:null,Element:null,Root:null,Image:null,Text:null,TextBox:null,DialogBox:null,ProgressBar:null,Video:null,Window:null,Container:null},Ke=(Y.marquee.resize=null,Y.list.page=_("#ui-element"),Y.list.head=_("#ui-list-head"),Y.list.copy=null,Y.list.paste=null,Y.list.delete=null,Y.list.toggle=null,Y.list.cancelSearch=null,Y.list.restoreRecursiveStates=A.list.restoreRecursiveStates,Y.list.setRecursiveStates=A.list.setRecursiveStates,Y.list.createIcon=null,Y.list.updateHead=null,Y.list.createConditionIcon=null,Y.list.updateConditionIcon=null,Y.list.createEventIcon=A.list.createEventIcon,Y.list.updateEventIcon=A.list.updateEventIcon,Y.list.createScriptIcon=A.list.createScriptIcon,Y.list.updateScriptIcon=A.list.updateScriptIcon,Y.list.createVisibilityIcon=A.list.createVisibilityIcon,Y.list.updateVisibilityIcon=A.list.updateVisibilityIcon,Y.list.createLockIcon=A.list.createLockIcon,Y.list.updateLockIcon=A.list.updateLockIcon,Y.list.onCreate=null,Y.list.onRemove=null,Y.list.onDelete=null,Y.list.onResume=null,Y.initialize=function(){this.screen.addScrollbars();var e={rotate:{TL:{x:0,y:0,angle:225},TR:{x:0,y:0,angle:315},BL:{x:0,y:0,angle:135},BR:{x:0,y:0,angle:45}},resize:{T:{x:0,y:0,angle:270},L:{x:0,y:0,angle:180},R:{x:0,y:0,angle:0},B:{x:0,y:0,angle:90},TL:{x:0,y:0,angle:225},TR:{x:0,y:0,angle:315},BL:{x:0,y:0,angle:135},BR:{x:0,y:0,angle:45}},list:null};e.list=[e.rotate.TL,e.rotate.TR,e.rotate.BL,e.rotate.BR,e.resize.T,e.resize.L,e.resize.R,e.resize.B,e.resize.TL,e.resize.TR,e.resize.BL,e.resize.BR],this.controlPoints=e,R.get({local:"Images/ui_control_point.png",type:"image"}).then(e=>{e&&(e.guid="ui:control-point",this.controlPointTexture=new $e(e),this.controlPointTexture.base.protected=!0)}),this.translationTimer=new f({duration:1/0,update:e=>{if("open"!==this.state||null!==this.dragging)return!1;{var i=this.translationKey,a=1.5*f.deltaTime/this.scale;let e=0,t=0;1&i&&(e-=a),2&i&&(t-=a),4&i&&(e+=a),8&i&&(t+=a);var i=this.screen,a=i.scrollLeft,n=i.scrollTop,s=Math.roundTo(this.centerX+e,4),r=Math.roundTo(this.centerY+t,4);this.updateCamera(s,r),this.updateTransform(),i.scrollLeft===a&&i.scrollTop===n||(this.requestRendering(),this.marquee.resize(),this.screen.updateScrollbars())}}}),this.zoomTimer=new f({duration:80,update:e=>{if("open"!==this.state)return this.scale=e.end,!1;var{elapsed:e,duration:t,start:i,end:a}=e,e=e/t;this.scale=i*(1-e)+a*e,this.resize(),this.requestRendering()}}),this.padding=800,this.matrix=new Ze,this.inspectorTypeMap={image:"uiImage",text:"uiText",textbox:"uiTextBox",dialogbox:"uiDialogBox",progressbar:"uiProgressBar",video:"uiVideo",window:"uiWindow",container:"uiContainer"},this.searcher.addCloseButton(),this.searcher.addKeydownFilter();const r=this["list"];r.removable=!0,r.renamable=!0,r.bind(()=>this.nodes),r.creators.push(r.createConditionIcon),r.creators.push(r.updateConditionIcon),r.creators.push(r.createEventIcon),r.creators.push(r.updateEventIcon),r.creators.push(r.createScriptIcon),r.creators.push(r.updateScriptIcon),r.creators.push(r.createVisibilityIcon),r.updaters.push(r.updateVisibilityIcon),r.creators.push(r.createLockIcon),r.updaters.push(r.updateLockIcon),l.processors["ui-object-create"]=(e,t)=>{t=t.response;r.restore(e,t)},l.processors["ui-object-delete"]=(e,t)=>{t=t.response;r.restore(e,t)},l.processors["ui-object-remove"]=(e,t)=>{var t=t["response"],i=t["item"];r.restore(e,t),Y.updateElement(i)},l.processors["ui-object-toggle"]=(e,t)=>{var{item:t,oldValue:i,newValue:a}=t;t.enabled="undo"===e?i:a,r.updateConditionIcon(t),Y.planToSave()},l.processors["ui-object-hidden"]=(e,t)=>{var{item:t,oldValues1:i,oldValues2:a,newValue:n}=t,s=t["instance"];"undo"===e?(r.restoreRecursiveStates(t,"hidden",i),r.restoreRecursiveStates(s,"visible",a)):(r.setRecursiveStates(t,"hidden",n),r.setRecursiveStates(s,"visible",!n)),r.update(),Y.requestRendering(),Y.planToSave()},l.processors["ui-object-locked"]=(e,t)=>{var{item:t,oldValues:i,newValue:a}=t;"undo"===e?r.restoreRecursiveStates(t,"locked",i):r.setRecursiveStates(t,"locked",a),r.update(),Y.planToSave()},l.processors["ui-target-anchor"]=(e,t)=>{var{editor:i,target:a,anchorX:n,anchorY:s}=t,{instance:r,transform:o}=a;t.anchorX=o.anchorX,t.anchorY=o.anchorY,o.anchorX=n,o.anchorY=s,i.target===a&&i.write({anchorX:n,anchorY:s}),r.resize(),Y.setTarget(a),Y.requestRendering(),Y.planToSave()},l.processors["ui-target-shift"]=(e,t)=>{var{editor:i,target:a,x:n,y:s}=t,{instance:r,transform:o}=a;t.x=o.x,t.y=o.y,o.x=n,o.y=s,i.target===a&&i.write({x:n,y:s}),r.resize(),Y.setTarget(a),Y.requestRendering(),Y.planToSave()},l.processors["ui-target-resize"]=(e,t)=>{var{editor:i,target:a,width:n,height:s}=t,{instance:r,transform:o}=a;t.width=o.width,t.height=o.height,o.width=n,o.height=s,i.target===a&&i.write({width:n,height:s}),r.resize(),Y.setTarget(a),Y.requestRendering(),Y.planToSave()},l.processors["ui-target-rotate"]=(e,t)=>{var{editor:i,target:a,rotation:n}=t,{instance:s,transform:r}=a;t.rotation=r.rotation,r.rotation=n,i.target===a&&i.write({rotation:n}),s.resize(),Y.setTarget(a),Y.requestRendering(),Y.planToSave()},window.on("themechange",this.themechange),window.on("datachange",this.datachange),window.on("keydown",this.keydown),this.page.on("resize",this.windowResize),this.head.on("pointerdown",this.headPointerdown),We.canvas.on("webglcontextrestored",this.webglRestored),_("#ui-head-start").on("pointerdown",this.switchPointerdown),_("#ui-zoom").on("focus",this.zoomFocus),_("#ui-zoom").on("input",this.zoomInput),this.screen.on("keydown",this.screenKeydown),this.screen.on("wheel",this.screenWheel),this.screen.on("userscroll",this.screenUserscroll),this.screen.on("blur",this.screenBlur),this.marquee.on("pointerdown",this.marqueePointerdown),this.marquee.on("pointermove",this.marqueePointermove),this.marquee.on("pointerleave",this.marqueePointerleave),this.marquee.on("doubleclick",this.marqueeDoubleclick),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),r.on("keydown",this.listKeydown),r.on("pointerdown",this.listPointerdown),r.on("select",this.listSelect),r.on("record",this.listRecord),r.on("popup",this.listPopup),r.on("open",this.listOpen),r.on("change",this.listChange),r.page.on("resize",this.listPageResize)},Y.open=function(e){var t;this.context!==e&&(this.save(),this.close(),t=e["meta"],e.ui||(e.ui=He.ui[t.guid]),e.ui?(this.state="open",this.context=e,this.meta=t,this.body.show(),this.load(e),this.resize(),this.requestRendering()):(x.manager.switch("directory"),O.confirm({message:"Failed to read file: "+t.path},[{label:"Confirm"}])))},Y.load=function(e){var t=!e.editor,{ui:e,editor:i}=(t&&(e.editor={target:null,root:new Y.Root,history:new l(100),centerX:e.ui.width/2,centerY:e.ui.height/2}),e);if(this.width=e.width,this.height=e.height,this.nodes=e.nodes,this.root=i.root,this.history=i.history,this.centerX=i.centerX,this.centerY=i.centerY,this.updateFont(),t){var a=this.nodes,n=a.length;for(let e=0;e<n;e++)this.loadElement(a[e],this.root)}this.list.update(),this.setTarget(i.target),this.context.fontChanged&&this.updateElementFont()},Y.save=function(){var e,t;"open"===this.state&&({ui:e,editor:t}=this.context,e.width=this.width,e.height=this.height,e.nodes=this.nodes,t.target=this.target,t.root=this.root,t.history=this.history,t.centerX=this.centerX,t.centerY=this.centerY)},Y.close=function(){"closed"!==this.state&&(this.screen.blur(),"fileUI"===j.type&&j.close(),this.setTarget(null),this.state="closed",this.context=null,this.meta=null,this.nodes=null,this.root=null,this.history=null,this.searcher.write(""),this.list.clear(),this.body.hide(),this.stopRendering())},Y.destroy=function(e){this.context===e&&(this.save(),this.close()),e.editor?.root.destroy()},Y.copy=function(){"open"===this.state&&null!==this.target&&this.list.copy(this.target)},Y.paste=function(t,i){"open"===this.state&&null===this.dragging&&(void 0===t&&(t=this.centerX,i=this.centerY),this.list.paste(null,e=>{e=e.transform;e.x=Math.round(t),e.x=0,e.y=Math.round(i),e.y=0}))},Y.create=function(e,t,i){e=this.inspectorTypeMap[e],e=j[e].create();e.transform.x=t,e.transform.y=i,this.list.addNodeTo(e)},Y.delete=function(){"open"===this.state&&null!==this.target&&null===this.dragging&&this.list.delete(this.target)},Y.toggle=function(){this.list.toggle(this.target)},Y.undo=function(){"open"===this.state&&!this.dragging&&this.history.canUndo()&&(this.history.restore("undo"),this.marquee.resize())},Y.redo=function(){"open"===this.state&&!this.dragging&&this.history.canRedo()&&(this.history.restore("redo"),this.marquee.resize())},Y.setZoom=function(){const i=_("#ui-zoom");return function(t){if(this.zoom!==t){let e;switch(t){case 0:e=.25;break;case 1:e=.5;break;case 2:e=1;break;case 3:e=2;break;case 4:e=4;break;default:return}this.zoom=t,i.write(t),"open"===this.state?((t=this.zoomTimer).start=this.scale,t.end=e,t.elapsed=0,t.add()):this.scale=e}}}(),Y.setSize=function(e,t){this.width!==e&&(this.centerX=this.centerX*e/this.width,this.width=e),this.height!==t&&(this.centerY=this.centerY*t/this.height,this.height=t),this.resize(),this.requestRendering()},Y.setHover=function(e){this.hover!==e&&(this.hover=e,this.requestRendering())},Y.setTarget=function(e){var t;this.target!==e&&(this.target=e,this.updateTargetItem(),this.requestRendering(),e?(t=this.inspectorTypeMap[e.class],j.open(t,e)):j.close())},Y.revealTarget=function(){const d=new f({duration:200,update:e=>{var t=e["target"];if(t!==Y.target)return e.target=null,!1;var t=u.EasingMap.easeInOut.map(e.elapsed/e.duration),i=e.startX*(1-t)+e.endX*t,e=e.startY*(1-t)+e.endY*t,t=Y.screen,a=t.scrollLeft,n=t.scrollTop;Y.updateCamera(i,e),Y.updateTransform(),t.scrollLeft===a&&t.scrollTop===n||(Y.requestRendering(),Y.marquee.resize(),Y.screen.updateScrollbars())},callback:e=>{e.target=null}});return function(){var e,t,i,a,n,s,r,o,l,c,h=this.target;h&&!d.target&&(r=(l=h.instance).matrix,o=l.x,e=l.y,t=o+l.width,l=e+l.height,n=r[0],c=r[1],a=r[3],i=r[4],n=(n*o+a*e+(s=r[6])+(n*o+a*l+s)+(n*t+a*l+s)+(n*t+a*e+s))/4,s=(c*o+i*e+(a=r[7])+(c*o+i*l+a)+(c*t+i*l+a)+(c*t+i*e+a))/4,r=.5/this.scaleX,o=.5/this.scaleY,{centerX:l,centerY:c}=this,Math.abs(n-l)>r||Math.abs(s-c)>o)&&(d.target=h,d.startX=l,d.startY=c,d.endX=n,d.endY=s,d.elapsed=0,d.add())}}(),Y.shiftAnchor=function(e,t){var i,a,n,s,r,o,l,c,h=this.target;null!==h&&(this.planToSave(),i=h.instance,a=h.transform,n=j.uiElement,r=(s=this.history).index,o=s.length,l=s[r],c="ui-target-anchor",r===o-1&&void 0!==l&&l.type===c&&l.target===h||s.save({type:c,editor:n,target:h,anchorX:a.anchorX,anchorY:a.anchorY}),a.anchorX=e,a.anchorY=t,i.resize(),this.requestRendering(),n.target===h)&&n.write({anchorX:e,anchorY:t})},Y.shiftTarget=function(e,t){var i,a,n,s,r,o,l,c,h=this.target;null!==h&&(this.planToSave(),i=h.instance,a=h.transform,n=j.uiElement,r=(s=this.history).index,o=s.length,l=s[r],c="ui-target-shift",r===o-1&&void 0!==l&&l.type===c&&l.target===h||s.save({type:c,editor:n,target:h,x:a.x,y:a.y}),a.x=e,a.y=t,i.resize(),this.requestRendering(),n.target===h)&&n.write({x:e,y:t})},Y.resizeTarget=function(e,t){var i,a,n,s,r,o,l,c,h=this.target;null!==h&&(this.planToSave(),i=h.instance,a=h.transform,n=j.uiElement,r=(s=this.history).index,o=s.length,l=s[r],c="ui-target-resize",r===o-1&&void 0!==l&&l.type===c&&l.target===h||s.save({type:c,editor:n,target:h,width:a.width,height:a.height}),void 0!==e&&(a.width=e),void 0!==t&&(a.height=t),i.resize(),this.requestRendering(),n.target===h)&&n.write({width:e,height:t})},Y.rotateTarget=function(e){var t,i,a,n,s,r,o,l,c=this.target;null!==c&&(this.planToSave(),t=c.instance,i=c.transform,a=j.uiElement,s=(n=this.history).index,r=n.length,o=n[s],l="ui-target-rotate",s===r-1&&void 0!==o&&o.type===l&&o.target===c||n.save({type:l,editor:a,target:c,rotation:i.rotation}),i.rotation=e,t.resize(),this.requestRendering(),a.target===c)&&a.write({rotation:e})},Y.setControlPoint=function(t){if(this.controlPointActive!==t){this.controlPointActive=t;var i=this.controlPoints;let e;switch(t){case null:e="";break;case i.rotate.TL:case i.rotate.TR:case i.rotate.BL:case i.rotate.BR:e="alias";break;case i.resize.T:case i.resize.L:case i.resize.R:case i.resize.B:case i.resize.TL:case i.resize.TR:case i.resize.BL:case i.resize.BR:var a=Math.modDegrees(t.angle+this.controlPointRotation,180);e=a<22.5||157.5<=a?"ew-resize":a<67.5?"nwse-resize":a<112.5?"ns-resize":"nesw-resize"}this.body.style.cursor=e}},Y.updateHover=function(){this.hover&&!this.hover.instance&&this.setHover(null)},Y.updateTarget=function(){var e=this.list.read();e!==this.target&&this.setTarget(e)},Y.updateTargetItem=function(){var e,t=this["target"];null!==t&&(e=this["list"],e.read()!==t)&&(e.selectWithNoEvent(t),t)&&(e.expandToSelection(),e.scrollToSelection())},Y.updateElementFont=function(){if("open"===this.state){this.context.fontChanged&&delete this.context.fontChanged;const a=Y.Text,n=Y.TextBox,s=Y.DialogBox,r=e=>{(e instanceof a||e instanceof n||e instanceof s)&&null!==e.printer&&(e.printer.reset(),""===e._font&&(e._font=void 0,e.font=""),this.requestRendering());var t=e.children,i=t.length;for(let e=0;e<i;e++)r(t[e])};r(this.root)}},Y.updateIndexedColor=function(e){if("open"===this.state){const a=Y.Text,n=new RegExp(`<color:${e}>`,"i"),s=e=>{e instanceof a&&n.test(e.content)&&(e.printer.reset(),this.requestRendering());var t=e.children,i=t.length;for(let e=0;e<i;e++)s(t[e])};s(this.root)}},Y.updateControlPoints=function(){if(null!==this.target){var i=4/this.scale,a=this.target["instance"],n=this.controlPoints,s=a.matrix,r=a.x,o=a.y,l=r+a.width,c=o+a.height,h=s[0],d=s[1],u=s[3],p=s[4],m=s[6],s=s[7],g=h*r+u*o+m,f=d*r+p*o+s,v=h*r+u*c+m,r=d*r+p*c+s,b=h*l+u*c+m,c=d*l+p*c+s,h=h*l+u*o+m,u=d*l+p*o+s,m=Math.atan2(f-r,g-v),d=Math.atan2(r-c,v-b),l=Math.atan2(c-u,b-h),p=Math.atan2(u-f,h-g),o=-Math.cos(l)*i,s=Math.sin(m)*i,m=-Math.cos(p)*i,d=Math.sin(d)*i,y=Math.cos(l)*i,l=Math.sin(l)*i,w=Math.cos(p)*i,p=Math.sin(p)*i,i=n["rotate"],i=(i.TL.x=g+3*(o-w),i.TL.y=f+3*(s-p),i.TR.x=h+3*(w-y),i.TR.y=u+3*(p-l),i.BL.x=v+3*(m-o),i.BL.y=r+3*(d-s),i.BR.x=b+3*(y-m),i.BR.y=c+3*(l-d),n)["resize"];i.T.x=(h+g)/2+o,i.T.y=(u+f)/2+s,i.L.x=(g+v)/2+m,i.L.y=(f+r)/2+d,i.R.x=(b+h)/2+w,i.R.y=(c+u)/2+p,i.B.x=(v+b)/2+y,i.B.y=(r+c)/2+l,i.TL.x=g+o-w,i.TL.y=f+s-p,i.TR.x=h+w-y,i.TR.y=u+p-l,i.BL.x=v+m-o,i.BL.y=r+d-s,i.BR.x=b+y-m,i.BR.y=c+l-d;let e=a,t=e.transform.rotation;for(;(e=e.parent)?.transform;)t+=e.transform.rotation;this.controlPointRotation=t}},Y.updateElement=function(n){let e,t;if(this.nodes.includes(n))e=this.nodes,t=this.root;else{const s=e=>{var t=e.children;if(t.includes(n))return e;for(const a of t){var i=s(a);if(i)return i}return null};var i=s({instance:this.root,children:this.nodes});i&&(e=i.children,t=i.instance)}t&&t.appendChildTo(n.instance,e.indexOf(n)),this.requestRendering()},Y.deleteElement=function(e){e.instance.remove(),e.instance.destroy()},Y.updateHead=function(){var e,{page:t,head:i}=this;0!==t.clientWidth&&(t=x.getGroupOfElement(i)["nav"],e=t.rect(),t=t.lastChild.rect().right-e.left,i.left!==t)&&(i.left=t,i.style.left=t+"px")},Y.resize=function(){var e,t,i,a,n,s,r,o,l;"open"===this.state&&0!==this.screen.clientWidth&&(t=this.scale,o=Math.round(this.padding*t),e=2*Math.round(this.width*t/2),t=2*Math.round(this.height*t/2),i=(a=CSS.getDevicePixelContentBoxSize(this.screen)).width,a=a.height,n=Math.max(i-e>>1,o),s=Math.max(a-t>>1,o),r=e+n+Math.max(i-e-n,o),o=t+s+Math.max(a-t-s,o),l=window.devicePixelRatio,this.scaleX=e/this.width,this.scaleY=t/this.height,this.outerWidth=r,this.outerHeight=o,this.centerOffsetX=i<r?i/2:n+e/2,this.centerOffsetY=a<o?a/2:s+t/2,this.paddingLeft=n,this.paddingTop=s,this.marquee.style.width=r/l+"px",this.marquee.style.height=o/l+"px",We.resize(i,a),this.updateCamera(),this.updateTransform(),this.root.resize(),this.marquee.resize(),this.screen.updateScrollbars())},Y.getPointerCoords=function(){const i={x:0,y:0};return function(e){var e=e.getRelativeCoords(this.marquee),t=window.devicePixelRatio;return i.x=(e.x*t-this.paddingLeft)/this.scaleX,i.y=(e.y*t-this.paddingTop)/this.scaleY,i}}(),Y.updateCamera=function(e=this.centerX,t=this.centerY){var i=window.devicePixelRatio,a=this.screen,e=e*this.scaleX+this.paddingLeft,t=t*this.scaleY+this.paddingTop;a.rawScrollLeft=Math.clamp(e-this.centerOffsetX,0,this.outerWidth-We.width)/i,a.rawScrollTop=Math.clamp(t-this.centerOffsetY,0,this.outerHeight-We.height)/i,a.scrollLeft=(e-(We.width>>1)+1e-4)/i,a.scrollTop=(t-(We.height>>1)+1e-4)/i},Y.updateTransform=function(){var e=window.devicePixelRatio,t=this.screen,i=Math.roundTo(t.scrollLeft*e-this.paddingLeft,4),a=Math.roundTo(t.scrollTop*e-this.paddingTop,4),n=i+We.width,s=a+We.height,i=(this.scrollLeft=i/this.scaleX,this.scrollTop=a/this.scaleY,this.scrollRight=n/this.scaleX,this.scrollBottom=s/this.scaleY,this.matrix.reset().scale(this.scaleX,this.scaleY).translate(-this.scrollLeft,-this.scrollTop),t.rawScrollLeft*e+this.centerOffsetX),a=t.rawScrollTop*e+this.centerOffsetY;this.centerX=Math.roundTo((i-this.paddingLeft)/this.scaleX,4),this.centerY=Math.roundTo((a-this.paddingTop)/this.scaleY,4)},Y.setPresetId=function(){const n=e=>{var t=He["uiLinks"],i=e["presetId"];""===i||i in t?e.presetId=(()=>{var e=He["uiLinks"];let t;for(;(t=X.generate64bit())in e;);return e[t]=Y.meta.guid,t})():t[i]=Y.meta.guid;for(const a of e.children)n(a)};return function(e){n(e)}}(),Y.unlinkPresetId=function(){const i=e=>{delete He.uiLinks[e.presetId];for(const t of e.children)i(t)};return function(e){i(e)}}(),Y.loadElement=function(e,t){let i;switch(e.class){case"image":i=new Y.Image(e);break;case"text":i=new Y.Text(e);break;case"textbox":i=new Y.TextBox(e);break;case"dialogbox":i=new Y.DialogBox(e);break;case"progressbar":i=new Y.ProgressBar(e);break;case"video":i=new Y.Video(e);break;case"window":i=new Y.Window(e);break;case"container":i=new Y.Container(e)}void 0!==t&&t.appendChild(i),i.node=e,Object.defineProperty(e,"instance",{configurable:!0,value:i});for(const a of e.children)Y.loadElement(a,i)},Y.drawBackground=function(){var e=We;e.clearColor(...this.background.getGLRGBA()),e.clear(e.COLOR_BUFFER_BIT)},Y.drawElements=function(){this.root.draw()},Y.drawCoordinateAxes=function(){var e,t,i,a,n,s,r,o,l,c,h,d,u,p,m,g,f,v,b,y,w,x,k,T,I,C,E;null!==this.target&&(b=this.target.instance["parent"],t=(e=We).arrays[0].float32,i=e.matrix.set(Y.matrix).multiply(b.matrix),x=b.x,a=b.y,h=x+b.width,b=a+b.height,n=x-1e4/this.scaleX,T=a-1e4/this.scaleY,v=h+1e4/this.scaleX,s=b+1e4/this.scaleY,r=i[0],C=i[1],o=i[3],E=i[4],l=i[6],d=C*n+E*a+(c=i[7]),u=r*v+o*a+l,p=C*v+E*a+c,m=r*n+o*b+l,g=C*n+E*b+c,f=r*v+o*b+l,v=C*v+E*b+c,b=r*x+o*T+l,y=C*x+E*T+c,w=r*x+o*s+l,x=C*x+E*s+c,k=r*h+o*T+l,T=C*h+E*T+c,I=r*h+o*s+l,C=C*h+E*s+c,t[0]=h=r*n+o*a+l,t[1]=d+.5,t[2]=0,t[3]=u,t[4]=p+.5,t[5]=Math.dist(h,d,u,p),t[6]=m,t[7]=g+.5,t[8]=0,t[9]=f,t[10]=v+.5,t[11]=Math.dist(m,g,f,v),t[12]=b+.5,t[13]=y,t[14]=0,t[15]=w+.5,t[16]=x,t[17]=Math.dist(b,y,w,x),t[18]=k+.5,t[19]=T,t[20]=0,t[21]=I+.5,t[22]=C,t[23]=Math.dist(k,T,I,C),i.project(e.flip,e.width,e.height),e.alpha=1,e.blend="normal",E=e.dashedLineProgram.use(),e.bindVertexArray(E.vao),e.uniformMatrix3fv(E.u_Matrix,!1,i),e.uniform4f(E.u_Color,.5,0,1,1),e.bufferData(e.ARRAY_BUFFER,t,e.STREAM_DRAW,0,24),e.drawArrays(e.LINES,0,8))},Y.drawHoverWireframe=function(){var e;null!==this.hover&&this.hover!==this.target&&(e=this.hover["instance"],e.visible)&&e.drawWireframe(4294967295)},Y.drawTargetWireframe=function(){var e;null!==this.target&&(e=this.target["instance"],e.drawWireframe(4290838272))},Y.drawTargetAnchor=function(){var e,t,i,a,n,s,r,o,l;null!==this.target&&(n=this.target["instance"],t=(e=We).arrays[0].float32,i=e.matrix.set(Y.matrix).multiply(n.matrix),r=n.transform,a=n.x+n.width*r.anchorX,n=n.y+n.height*r.anchorY,r=i[0],l=i[1],o=i[3],s=i[4],r=r*a+o*n+i[6],o=l*a+s*n+i[7],t[0]=r+.5-8,t[1]=o+.5,t[2]=r+.5+9,t[3]=o+.5,t[4]=r+.5,t[5]=o+.5-8,t[6]=r+.5,t[7]=o+.5+9,i.project(e.flip,e.width,e.height),e.alpha=1,e.blend="normal",l=e.graphicProgram.use(),e.bindVertexArray(l.vao.a10),e.uniformMatrix3fv(l.u_Matrix,!1,i),e.bufferData(e.ARRAY_BUFFER,t,e.STREAM_DRAW,0,8),e.vertexAttrib4f(l.a_Color,1,0,0,1),e.drawArrays(e.LINES,0,4))},Y.drawControlPoints=function(){var e=this.target,i=this.controlPointTexture;if(null!==e&&null!==i){this.updateControlPoints();var a=4/this.scale,e=We,n=e.arrays[0].float32;let t=0;var s=this.controlPoints["list"],r=s.length;for(let e=4;e<r;e++){var{x:o,y:l}=s[e],c=o-a,h=l-a,o=o+a,l=l+a;n[t]=c,n[t+1]=h,n[t+2]=0,n[t+3]=0,n[t+4]=c,n[t+5]=l,n[t+6]=0,n[t+7]=1,n[t+8]=o,n[t+9]=l,n[t+10]=1,n[t+11]=1,n[t+12]=o,n[t+13]=h,n[t+14]=1,n[t+15]=0,t+=16}e.blend="normal";var d=e.imageProgram.use(),u=e.matrix.project(e.flip,e.width,e.height).multiply(Y.matrix);e.bindVertexArray(d.vao),e.uniformMatrix3fv(d.u_Matrix,!1,u),e.uniform1i(d.u_LightMode,0),e.uniform1i(d.u_ColorMode,0),e.uniform4f(d.u_Tint,0,0,0,0),e.bufferData(e.ARRAY_BUFFER,n,e.STREAM_DRAW,0,t),e.bindTexture(e.TEXTURE_2D,i.base.glTexture),e.drawElements(e.TRIANGLES,t/16*6,e.UNSIGNED_INT,0)}},Y.selectControlPoint=function(t,i){if(null!==this.target){var a=6/this.scale,n=this.controlPoints["list"];for(let e=n.length-1;0<=e;e--){var s=n[e],r=s.x-a,o=s.x+a,l=s.y-a,c=s.y+a;if(r<=t&&t<o&&l<=i&&i<c)return s}}return null},Y.selectObject=function(){const r=(t,i,a)=>{for(let e=t.length-1;0<=e;e--){var n=t[e],s=r(n.children,i,a);if(s)return s;if(n.visible&&!n.node.locked&&n.isPointIn(i,a))return n.node}return null};return function(e,t){return r(this.root.children,e,t)}}(),Y.requestRendering=function(){"open"===this.state&&f.appendUpdater("stageRendering",this.renderingFunction)},Y.renderingFunction=function(){We.width*We.height!=0&&(Y.drawBackground(),Y.drawElements(),Y.drawCoordinateAxes(),Y.drawHoverWireframe(),Y.drawTargetWireframe(),Y.drawTargetAnchor(),Y.drawControlPoints())},Y.stopRendering=function(){f.removeUpdater("stageRendering",this.renderingFunction)},Y.switchSettings=function(){j.fileUI.button.hasClass("selected")?j.close():j.open("fileUI",Y)},Y.updateFont=function(){var e=We.context2d,{pixelated:t,threshold:i}=He.config.font;return("ui"!==e.mode||e.pixelated!==t||e.threshold!==i)&&(e.mode="ui",e.pixelated=t,e.threshold=i,e=We.textProgram.use(),We.uniform1f(e.u_Threshold,t?i/255:0),!0)},Y.planToSave=function(){R.planToSave(this.meta)},Y.saveToConfig=function(e){e.colors.uiBackground=this.background.hex,e.colors.uiForeground=this.foreground.hex},Y.loadFromConfig=function(e){this.background=new a(e.colors.uiBackground,()=>this.requestRendering()),this.foreground=new a(e.colors.uiForeground,()=>{"open"===this.state&&(this.root.resize(),this.requestRendering())})},Y.saveToProject=function(e){e=e.ui;e.zoom=this.zoom??e.zoom},Y.loadFromProject=function(e){e=e.ui;this.setZoom(e.zoom)},Y.webglRestored=function(e){"open"===Y.state&&Y.requestRendering()},Y.windowResize=function(e){this.updateHead(),"open"===this.state&&(this.resize(),this.updateCamera(),this.requestRendering())}.bind(Y),Y.themechange=function(e){this.requestRendering()}.bind(Y),Y.datachange=function(e){"config"===e.key&&"open"===Y.state&&Y.updateFont()&&Y.updateElementFont()},Y.keydown=function(e){"open"!==Y.state||null!==Y.dragging||e.cmdOrCtrlKey||e.altKey&&"KeyS"===e.code&&Y.switchSettings()},Y.headPointerdown=function(e){e.target instanceof HTMLInputElement||(e.preventDefault(),document.activeElement!==Y.screen&&Y.screen.focus())},Y.switchPointerdown=function(e){if(0===e.button){e=e.target;if("ITEM"===e.tagName&&"settings"===e.getAttribute("value"))return Y.switchSettings()}},Y.zoomFocus=function(e){Y.screen.focus()},Y.zoomInput=function(e){Y.setZoom(this.read())},Y.screenKeydown=function(i){if("open"===this.state&&null===this.dragging){if(i.cmdOrCtrlKey)switch(i.code){case"KeyX":return this.copy(),void this.delete();case"KeyC":return void this.copy();case"KeyV":return void this.paste();case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":break;default:return}if(!i.altKey)switch(i.code){case"Enter":case"NumpadEnter":this.revealTarget();break;case"Slash":this.toggle();break;case"Delete":this.delete();break;case"Escape":this.setTarget(null);break;case"KeyA":0==(1&this.translationKey)&&(this.translationKey|=1,this.translationTimer.add(),this.screen.beginScrolling(),window.on("keyup",this.translationKeyup));break;case"KeyW":0==(2&this.translationKey)&&(this.translationKey|=2,this.translationTimer.add(),this.screen.beginScrolling(),window.on("keyup",this.translationKeyup));break;case"KeyD":0==(4&this.translationKey)&&(this.translationKey|=4,this.translationTimer.add(),this.screen.beginScrolling(),window.on("keyup",this.translationKeyup));break;case"KeyS":0==(8&this.translationKey)&&(this.translationKey|=8,this.translationTimer.add(),this.screen.beginScrolling(),window.on("keyup",this.translationKeyup));break;case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":if(null!==this.target){i.preventDefault();var a=this.target.transform;let e=0,t=0;switch(i.code){case"ArrowLeft":e=-1;break;case"ArrowUp":t=-1;break;case"ArrowRight":e=1;break;case"ArrowDown":t=1}if(i.cmdOrCtrlKey)return n=Math.roundTo(a.anchorX-.5*e,4),s=Math.roundTo(a.anchorY-.5*t,4),this.shiftAnchor(n,s);i.shiftKey&&(e*=10,t*=10);var n=Math.roundTo(a.x+e,4),s=Math.roundTo(a.y+t,4);this.shiftTarget(n,s)}break;case"Minus":case"NumpadSubtract":this.setZoom(this.zoom-1);break;case"Equal":case"NumpadAdd":this.setZoom(this.zoom+1);break;case"Digit0":case"Numpad0":this.setZoom(2)}}}.bind(Y),Y.translationKeyup=function(e){if(0!==this.translationKey){if(void 0===e)this.translationKey=0;else switch(e.code){case"KeyA":this.translationKey&=14;break;case"KeyW":this.translationKey&=13;break;case"KeyD":this.translationKey&=11;break;case"KeyS":this.translationKey&=7}0===this.translationKey&&(this.translationTimer.remove(),this.screen.endScrolling(),window.off("keyup",this.translationKeyup))}}.bind(Y),Y.screenWheel=function(e){"open"===this.state&&null===this.dragging&&(e.preventDefault(),0!==e.deltaY)&&(e=0<e.deltaY?-1:1,this.setZoom(this.zoom+e))}.bind(Y),Y.screenUserscroll=function(e){"open"===this.state&&(this.screen.rawScrollLeft=this.screen.scrollLeft,this.screen.rawScrollTop=this.screen.scrollTop,this.updateTransform(),this.requestRendering(),this.marquee.resize(),this.screen.updateScrollbars())}.bind(Y),Y.screenBlur=function(e){this.translationKeyup(),this.pointerup()}.bind(Y),Y.marqueePointerdown=function(e){if(!this.dragging)switch(e.button){case 0:if(e.altKey)return(this.dragging=e).mode="scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove);if(this.controlPointActive&&this.target){var t=this.target["transform"],i=this.controlPoints;switch(this.dragging=e,this.controlPointActive){case i.rotate.TL:case i.rotate.TR:case i.rotate.BL:case i.rotate.BR:var a=this.target["instance"],n=Ze.instance.set(Y.matrix).multiply(a.matrix),s=a.x+a.width*t.anchorX,a=a.y+a.height*t.anchorY,r=n[0],o=n[1],l=n[3],c=n[4],r=r*s+l*a+n[6],l=o*s+c*a+n[7],{x:o,y:s}=e.getRelativeCoords(We.canvas);e.mode="object-rotate",e.absoluteAnchorX=r,e.absoluteAnchorY=l,e.lastAngle=Math.atan2(s-l,o-r),e.rotationRadians=0,e.startRotation=t.rotation;break;case i.resize.T:case i.resize.L:case i.resize.R:case i.resize.B:case i.resize.TL:case i.resize.TR:case i.resize.BL:case i.resize.BR:e.mode="object-resize",e.startWidth=t.width,e.startHeight=t.height}return window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove)}var{x:i,y:h}=this.getPointerCoords(e),i=this.selectObject(i,h);i&&((this.dragging=e).mode="object-move",e.enabled=!1,e.startX=i.transform.x,e.startY=i.transform.y,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)),this.setTarget(i);break;case 2:(this.dragging=e).mode="ready-to-scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}}.bind(Y),Y.marqueePointermove=function(e){if(!this.dragging){this.marquee.pointerevent=e;var{x:e,y:t}=this.getPointerCoords(e);if(this.target){var i=this.selectControlPoint(e,t);if(i)return this.setHover(null),void this.setControlPoint(i)}this.controlPointActive&&this.setControlPoint(null);i=this.selectObject(e,t);this.setHover(i)}}.bind(Y),Y.marqueePointerleave=function(e){this.marquee.pointerevent&&(this.marquee.pointerevent=null,this.setHover(null))}.bind(Y),Y.marqueeDoubleclick=function(e){this.target&&(this.screenBlur(),this.revealTarget())}.bind(Y),Y.pointerup=function(e){var t,i,a=this["dragging"];if(null!==a&&a.relate(e=void 0===e?a:e)){switch(a.mode){case"object-rotate":case"object-resize":case"object-move":break;case"ready-to-scroll":e.target===this.marquee&&({x:i,y:t}=this.getPointerCoords(e),i=this.selectObject(i,t),this.setTarget(i),this.menuPopup(e));break;case"scroll":this.screen.endScrolling(),pt.close("cursor-grab")}this.dragging=null,window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove)}}.bind(Y),Y.pointermove=function(a){var n=this["dragging"];if(n.relate(a))switch(n.mode){case"object-rotate":if(this.target){var{x:s,y:r}=a.getRelativeCoords(We.canvas),s=s-n.absoluteAnchorX,r=r-n.absoluteAnchorY,r=Math.atan2(r,s),s=Math.modRadians(r-n.lastAngle);n.rotationRadians+=s<Math.PI?s:s-2*Math.PI;let e=Math.round(n.startRotation+Math.degrees(n.rotationRadians));a.shiftKey&&(e=15*Math.round(e/15)),this.target.transform.rotation!==e&&this.rotateTarget(e),n.lastAngle=r}break;case"object-resize":if(this.target){var s=this.target["instance"],{parent:o,transform:l}=s,c=this.controlPoints,h=this.controlPointActive,d=Math.radians(h.angle+this.controlPointRotation),r=(a.clientX-n.clientX)/this.scaleX,s=(a.clientY-n.clientY)/this.scaleY,u=Math.sqrt(r**2+s**2),p=Math.atan2(s,r),m=Math.abs(l.scaleX)||1,g=Math.abs(l.scaleY)||1;let t=void 0,i=void 0;switch(h){case c.resize.T:case c.resize.L:case c.resize.R:case c.resize.B:var e=u*Math.cos(p-d);switch(h){case c.resize.T:case c.resize.B:i=e/g;break;case c.resize.L:case c.resize.R:t=e/m}break;case c.resize.TL:case c.resize.TR:case c.resize.BL:case c.resize.BR:if(a.shiftKey){var f=n.startWidth+o.width*l.width2,v=n.startHeight+o.height*l.height2,b=Math.atan2(v,f);let e;switch(h){case c.resize.TL:case c.resize.BR:e=d-Math.PI/4+b;break;case c.resize.TR:case c.resize.BL:e=d+Math.PI/4-b}v=p-e,f=u*Math.cos(v),v=f*Math.cos(b),f=f*Math.sin(b);t=v/m,i=f/g}else{var v=p-(d-Math.PI/4),y=u*Math.cos(v),w=u*Math.sin(v);switch(h){case c.resize.TL:case c.resize.BR:t=y/m,i=w/g;break;case c.resize.TR:case c.resize.BL:t=w/g,i=y/m}}}void 0!==t&&(s=-Math.ceil(o.width*l.width2),t=Math.max(Math.round(n.startWidth+t),s)),void 0!==i&&(r=-Math.ceil(o.height*l.height2),i=Math.max(Math.round(n.startHeight+i),r)),(void 0!==t&&l.width!==t||void 0!==i&&l.height!==i)&&this.resizeTarget(t,i)}break;case"object-move":if(!n.enabled){s=a.clientX-n.clientX,r=a.clientY-n.clientY;if(!(4<Math.sqrt(s**2+r**2)||500<=a.timeStamp-n.timeStamp))break;n.enabled=!0}if(this.target){var s=this.target.transform,i=(a.clientX-n.clientX)/this.scaleX,x=(a.clientY-n.clientY)/this.scaleY;let e,t;if(a.shiftKey){r=Math.atan2(x,i),r=Math.modRadians(r)/(2*Math.PI);switch(Math.floor((4*r+.5)%4)){case 0:case 2:e=Math.round(n.startX+i),t=n.startY;break;case 1:case 3:e=n.startX,t=Math.round(n.startY+x)}}else e=Math.round(n.startX+i),t=Math.round(n.startY+x);s.x===e&&s.y===t||this.shiftTarget(e,t)}break;case"ready-to-scroll":r=a.clientX-n.clientX,s=a.clientY-n.clientY;this.screen.setScroll(n.scrollLeft-r,n.scrollTop-s),4<Math.sqrt(r**2+s**2)&&(n.mode="scroll",pt.open("cursor-grab"));break;case"scroll":r=a.clientX-n.clientX,s=a.clientY-n.clientY;this.screen.beginScrolling(),this.screen.setScroll(n.scrollLeft-r,n.scrollTop-s)}}.bind(Y),Y.menuPopup=function(e){this.translationKeyup();const{x:t,y:i}=this.getPointerCoords(e),a=this.target;var n=!!a,s=Clipboard.has("yami.ui.object"),r=N.createGetter("menuUI");ve.popup({x:e.clientX,y:e.clientY},[{label:r("create"),submenu:[{label:r("create.image"),click:()=>{this.create("image",t,i)}},{label:r("create.text"),click:()=>{this.create("text",t,i)}},{label:r("create.textBox"),click:()=>{this.create("textbox",t,i)}},{label:r("create.dialogBox"),click:()=>{this.create("dialogbox",t,i)}},{label:r("create.progressBar"),click:()=>{this.create("progressbar",t,i)}},{label:r("create.video"),click:()=>{this.create("video",t,i)}},{label:r("create.window"),click:()=>{this.create("window",t,i)}},{label:r("create.container"),click:()=>{this.create("container",t,i)}}]},{label:r("toggle"),accelerator:"/",enabled:n,click:()=>{this.toggle()}},{type:"separator"},{label:r("cut"),accelerator:p("X"),enabled:n,click:()=>{this.copy(),this.delete()}},{label:r("copy"),accelerator:p("C"),enabled:n,click:()=>{this.copy()}},{label:r("paste"),accelerator:p("V"),enabled:s,click:()=>{this.paste(t,i)}},{label:r("delete"),accelerator:"Delete",enabled:n,click:()=>{this.delete()}},{label:r("copy-id"),enabled:n,click:()=>{navigator.clipboard.writeText(a.presetId)}}])},Y.searcherInput=function(e){"insertCompositionText"!==e.inputType&&(e=this.input.value,Y.list.searchNodes(e))},Y.listKeydown=function(e){if(this.data){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":t&&(this.copy(t),this.delete(t));break;case"KeyC":this.copy(t);break;case"KeyV":this.paste(null)}else switch(e.code){case"Slash":this.toggle(t);break;case"Delete":this.delete(t);break;case"Backspace":this.cancelSearch();break;case"Escape":Y.setTarget(null)}}},Y.listPointerdown=function(e){switch(e.button){case 0:var t=e.target;switch(t.tagName){case"VISIBILITY-ICON":var i=t.parentNode["item"],{instance:a,hidden:n}=i,s=this.setRecursiveStates(i,"hidden",!n),r=this.setRecursiveStates(a,"visible",n),o=Math.max(s.length,r.length);for(let e=0;e<o;e++)if(s[e]===r[e])throw new Error("Failed to switch hidden state");this.update(),this.dispatchChangeEvent(),Y.requestRendering(),Y.history.save({type:"ui-object-hidden",item:i,oldValues1:s,oldValues2:r,newValue:!n});break;case"LOCK-ICON":a=t.parentNode["item"],i=a["locked"],n=this.setRecursiveStates(a,"locked",!i);this.update(),this.dispatchChangeEvent(),Y.history.save({type:"ui-object-locked",item:a,oldValues:n,newValue:!i})}break;case 3:this.cancelSearch()}},Y.listSelect=function(e){Y.setTarget(e.value)},Y.listRecord=function(e){var t=e.value;switch(t.type){case"rename":Y.listRename(t);break;case"create":Y.history.save({type:"ui-object-create",response:t});break;case"delete":Y.history.save({type:"ui-object-delete",response:t});break;case"remove":Y.history.save({type:"ui-object-remove",response:t})}},Y.listPopup=function(e){const t=e.value;var i=[],a=N.createGetter("menuUIList");let n,s,r,o,l;i.push({label:a("create"),submenu:[{label:a("create.image"),click:()=>{this.addNodeTo(j.uiImage.create(),t)}},{label:a("create.text"),click:()=>{this.addNodeTo(j.uiText.create(),t)}},{label:a("create.textBox"),click:()=>{this.addNodeTo(j.uiTextBox.create(),t)}},{label:a("create.dialogBox"),click:()=>{this.addNodeTo(j.uiDialogBox.create(),t)}},{label:a("create.progressBar"),click:()=>{this.addNodeTo(j.uiProgressBar.create(),t)}},{label:a("create.video"),click:()=>{this.addNodeTo(j.uiVideo.create(),t)}},{label:a("create.window"),click:()=>{this.addNodeTo(j.uiWindow.create(),t)}},{label:a("create.container"),click:()=>{this.addNodeTo(j.uiContainer.create(),t)}}]}),t?(n=!0,s=!0,r=Clipboard.has("yami.ui.object"),o=!0,l=!0,i.push({label:a("reveal"),accelerator:"Enter",click:()=>{Y.revealTarget(t)}},{label:a("toggle"),accelerator:"/",click:()=>{this.toggle(t)}})):(n=!1,s=!1,r=Clipboard.has("yami.ui.object"),o=!1,l=!1),i.push({type:"separator"},{label:a("cut"),accelerator:p("X"),enabled:s,click:()=>{this.copy(t),this.delete(t)}},{label:a("copy"),accelerator:p("C"),enabled:s,click:()=>{this.copy(t)}},{label:a("paste"),accelerator:p("V"),enabled:r,click:()=>{this.paste(t)}},{label:a("delete"),accelerator:"Delete",enabled:o,click:()=>{this.delete(t)}},{label:a("rename"),accelerator:"F2",enabled:l,click:()=>{this.rename(t)}},{label:a("copy-id"),enabled:n,click:()=>{navigator.clipboard.writeText(t.presetId)}}),ve.popup({x:e.clientX,y:e.clientY},i)},Y.listOpen=function(e){Y.revealTarget(e.value)},Y.listRename=function(e){var t=j.uiElement,i=e.item,a=t.nameBox,{oldValue:e,newValue:n}=e;a.write(n),Y.history.save({type:"inspector-change",editor:t,target:i,changes:[{input:a,oldValue:e,newValue:n}]})},Y.listChange=function(e){Y.planToSave()},Y.listPageResize=function(e){Y.list.updateHead(),Y.list.resize()},Y.marquee.resize=function(){this.pointerevent&&Y.marqueePointermove(this.pointerevent)},Y.list.copy=function(e){e&&Clipboard.write("yami.ui.object",e)},Y.list.paste=function(e,t){var i=Clipboard.read("yami.ui.object");i&&this.data&&(t?.(i),this.addNodeTo(i,e),Y.requestRendering())},Y.list.delete=function(e){e&&(this.deleteNode(e),Y.requestRendering())},Y.list.toggle=function(e){e&&(Y.history.save({type:"ui-object-toggle",item:e,oldValue:e.enabled,newValue:!e.enabled}),e.enabled=!e.enabled,this.updateConditionIcon(e),this.dispatchChangeEvent())},Y.list.cancelSearch=function(){var e;"search"===this.display&&(e=document.activeElement,Y.searcher.deleteInputContent(),this.expandToSelection(),this.scrollToSelection(),e.focus())},Y.list.createIcon=function(){const t={image:()=>{var e=document.createElement("node-icon");return e.addClass("icon-ui-image"),e},text:()=>{var e=document.createElement("node-icon");return e.addClass("icon-ui-text"),e},textbox:()=>{var e=document.createElement("node-icon");return e.addClass("icon-ui-textbox"),e},dialogbox:()=>{var e=document.createElement("node-icon");return e.addClass("icon-ui-dialogbox"),e},progressbar:()=>{var e=document.createElement("node-icon");return e.addClass("icon-ui-progressbar"),e},video:()=>{var e=document.createElement("node-icon");return e.addClass("icon-ui-video"),e},window:()=>{var e=document.createElement("node-icon");return e.addClass("icon-ui-window"),e},container:()=>{var e=document.createElement("node-icon");return e.addClass("icon-ui-container"),e}};return function(e){return t[e.class]()}}(),Y.list.updateHead=function(){var e,{page:t,head:i}=this;0!==t.clientWidth&&(t=x.getGroupOfElement(i)["nav"],e=t.rect(),t=t.lastChild.rect().right-e.left,i.left!==t)&&(i.left=t,i.style.left=t+"px")},Y.list.createConditionIcon=function(e){var e=e["element"],t=document.createElement("node-icon");t.addClass("icon-conditional"),e.appendChild(t),e.conditionIcon=t,e.condition=""},Y.list.updateConditionIcon=function(e){var{element:e,enabled:t}=e,t=t?"none":"absent";if(e.condition!==t){e.condition=t;var i=e.conditionIcon;switch(t){case"none":i.hide();break;case"absent":i.textContent="!",i.show()}}},Y.list.onCreate=function(e){Y.setPresetId(e),Y.loadElement(e),Y.updateElement(e)},Y.list.onRemove=function(e){Y.updateElement(e)},Y.list.onDelete=function(e){Y.unlinkPresetId(e),Y.deleteElement(e),Y.updateHover(),Y.updateTarget(),Y.requestRendering()},Y.list.onResume=function(e){Y.setPresetId(e),Y.loadElement(e),Y.updateElement(e)},Y.Element=class{node;x;y;width;height;matrix;opacity;transform;parent;children;visible;connected;constructor(e){this.x=0,this.y=0,this.width=0,this.height=0,this.matrix=new Ze,this.opacity=1,this.transform=e.transform,this.parent=null,this.children=[],this.visible=!e.hidden,this.connected=!1}drawWireframe(e){var t=We,i=t.arrays[0].float32,a=t.arrays[0].uint32,n=t.matrix.set(Y.matrix).multiply(this.matrix),s=this.x,r=this.y,o=s+this.width,l=r+this.height,c=n[0],h=n[1],d=n[3],u=n[4],p=n[6],m=n[7],g=c*s+d*r+p,f=h*s+u*r+m,v=c*s+d*l+p,s=h*s+u*l+m,b=c*o+d*l+p,l=h*o+u*l+m,c=c*o+d*r+p,d=h*o+u*r+m,p=Math.atan2(f-s,g-v),h=Math.atan2(s-l,v-b),o=Math.atan2(l-d,b-c),u=Math.atan2(d-f,c-g),r=.5*Math.cos(p),m=.5*Math.sin(p),p=.5*Math.cos(h),h=.5*Math.sin(h),y=.5*Math.cos(o),o=.5*Math.sin(o),w=.5*Math.cos(u),u=.5*Math.sin(u),f=f+u-m,v=v+r-p,s=s+m-h,m=b+p-y,b=l+h-o,p=c+y-w,l=d+o-u,h=(i[0]=g+w-r,i[1]=f,a[2]=e,i[3]=v,i[4]=s,a[5]=e,i[6]=m,i[7]=b,a[8]=e,i[9]=p,i[10]=l,a[11]=e,n.project(t.flip,t.width,t.height),t.alpha=1,t.blend="normal",t.graphicProgram.use());t.bindVertexArray(h.vao),t.uniformMatrix3fv(h.u_Matrix,!1,n),t.bufferData(t.ARRAY_BUFFER,i,t.STREAM_DRAW,0,12),t.drawArrays(t.LINE_LOOP,0,4)}drawDefaultImage(){We.alpha=this.opacity,We.blend=this.blend,We.matrix.set(Y.matrix).multiply(this.matrix),We.fillRect(this.x,this.y,this.width,this.height,2164260863)}connect(){this.connected=!0,this.connectChildren()}disconnect(){this.connected=!1,this.disconnectChildren()}connectChildren(){var t=this.children,i=t.length;for(let e=0;e<i;e++)t[e].connect()}disconnectChildren(){var t=this.children,i=t.length;for(let e=0;e<i;e++)t[e].disconnect()}drawChildren(){var t=this.children,i=t.length;for(let e=0;e<i;e++)t[e].draw()}resizeChildren(){var t=this.children,i=t.length;for(let e=0;e<i;e++)t[e].resize()}destroyChildren(){var t=this.children,i=t.length;for(let e=0;e<i;e++)t[e].destroy()}appendChild(e){e&&this.children.append(e)&&(e.parent instanceof Y.Element&&e.parent.children.remove(e),(e.parent=this).connected)&&(e.connected||e.connect(),e.resize())}appendChildTo(e,t){e instanceof Y.Element&&(e.parent instanceof Y.Element&&e.parent.children.remove(e),e.parent instanceof Y.Window&&e.parent.requestResizing(),(e.parent=this).children.splice(t,0,e),this.connected)&&(e.connected||e.connect(),e.resize())}remove(){this.parent instanceof Y.Element&&this.parent.children.remove(this)&&(this.parent instanceof Y.Window&&this.parent.requestResizing(),this.parent=null,this.connected)&&this.disconnect()}calculatePosition(){var e,t,i,a,n,s,r,o,l,c,h,d,u,p;!1!==this.connected&&(e=this.parent,t=this.matrix.set(e.matrix),p=this.transform,n=e.width,s=e.height,i=e.x+p.x+p.x2*n,a=e.y+p.y+p.y2*s,n=Math.max(p.width+p.width2*n,0),s=Math.max(p.height+p.height2*s,0),r=p.anchorX*n,o=p.anchorY*s,l=p.rotation,c=p.scaleX,h=p.scaleY,d=p.skewX,u=p.skewY,p=p.opacity*e.opacity,this.x=i-r,this.y=a-o,this.width=n,this.height=s,this.opacity=p,0!==l&&t.rotateAt(i,a,Math.radians(l)),1===c&&1===h||t.scaleAt(i,a,c,h),0!==d||0!==u)&&t.skewAt(i,a,d,u)}contains(e){for(;e;){if(e===this)return!0;e=e.parent}return!1}isPointIn(e,t){var i,a,n,s,r,o,l,c,h,d,u,p,m=this.width,g=this.height;return m*g!=0&&(d=this.matrix,i=this.x,p=this.y,a=d[0],r=d[1],n=d[3],h=d[4],u=(o=a*(m=i+m)+n*(g=p+g)+(s=d[6])-e)*(c=r*m+h*p+(d=d[7])-t)-(l=r*m+h*g+d-t)*(m=a*m+n*p+s-e),p=m*(m=r*i+h*p+d-t)-c*(c=a*i+n*p+s-e),0<=(h=c*(c=r*i+h*g+d-t)-m*(r=a*i+n*g+s-e))*(d=r*l-c*o))&&0<=d*u&&0<=u*p&&0<=p*h}},Y.Root=class extends Y.Element{background;constructor(){super({transform:null,hidden:!1}),this.connected=!0,this.background=null}draw(){We.matrix.set(Y.matrix),We.alpha=1,We.blend="normal",We.fillRect(this.x,this.y,this.width,this.height,this.background),this.drawChildren()}resize(){this.x=0,this.y=0,this.width=Y.width,this.height=Y.height,this.background=Y.foreground.getINTRGBA(),this.resizeChildren()}destroy(){this.destroyChildren()}},Y.Image=class wi extends Y.Element{texture;_display;_image;flip;shiftX;shiftY;border;clip;tint;blend;constructor(e){super(e),this.texture=null,this.display=e.display,this.image=e.image,this.flip=e.flip,this.shiftX=e.shiftX,this.shiftY=e.shiftY,this.border=e.border,this.clip=e.clip,this.tint=e.tint,this.blend=e.blend}get image(){return this._image}set image(e){this._image!==e&&(this._image=e,this.texture&&(this.texture.destroy(),this.texture=null),e)&&(this.texture=new $e(e),this.texture.on("load",()=>{Y.requestRendering()}))}get display(){return this._display}set display(e){this._display=e}draw(){if(!1===this.visible)return this.drawChildren();var e,t,i,a,n=this["texture"];if(null!==n)e:{let e=this.x,t=this.y,i=this.width,a=this.height;if("mask"===this.blend){if(We.maskTexture.binding)break e;We.depthTest&&We.disable(We.DEPTH_TEST),We.maskTexture.binding=this,We.bindFBO(We.maskTexture.fbo),We.alpha=1,We.blend="normal"}else We.alpha=this.opacity,We.blend=this.blend;switch(We.matrix.set(Y.matrix).multiply(this.matrix),this.display){case"stretch":n.clip(this.shiftX,this.shiftY,n.base.width,n.base.height);break;case"tile":n.clip(this.shiftX,this.shiftY,this.width,this.height);break;case"clip":n.clip(...this.clip);break;case"slice":We.drawSliceImage(n,e,t,i,a,this.clip,this.border,this.tint);break e}switch(this.flip){case"none":break;case"horizontal":e+=i,i*=-1;break;case"vertical":t+=a,a*=-1;break;case"both":e+=i,t+=a,i*=-1,a*=-1}We.drawImage(n,e,t,i,a,this.tint)}else this.drawDefaultImage();We.maskTexture.binding===this?(We.unbindFBO(),We.depthTest&&We.enable(We.DEPTH_TEST),We.masking=!0,this.drawChildren(),We.masking=!1,We.maskTexture.binding=null,[e,t,i,a]=this.computeBoundingRectangle(),e=Math.max(Math.floor(e-1),0),t=Math.max(Math.floor(t-1),0),i=Math.min(Math.ceil(i+1),We.maskTexture.width)-e,a=Math.min(Math.ceil(a+1),We.maskTexture.height)-t,0<i&&0<a&&(We.bindFBO(We.maskTexture.fbo),We.enable(We.SCISSOR_TEST),We.scissor(e,t,i,a),We.clearColor(0,0,0,0),We.clear(We.COLOR_BUFFER_BIT),We.disable(We.SCISSOR_TEST),We.unbindFBO())):this.drawChildren()}resize(){if(this.parent instanceof Y.Window)return this.parent.requestResizing();this.calculatePosition(),this.resizeChildren()}destroy(){this.texture?.destroy(),this.destroyChildren(),delete this.node.instance}computeBoundingRectangle(){var e=We.matrix.set(Y.matrix).multiply(this.matrix),t=this.x,i=this.y,a=t+this.width,n=i+this.height,s=e[0],r=e[1],o=e[3],l=e[4],c=e[6],e=e[7],h=s*t+o*i+c,d=r*t+l*i+e,u=s*t+o*n+c,t=r*t+l*n+e,p=s*a+o*n+c,n=r*a+l*n+e,s=s*a+o*i+c,o=r*a+l*i+e,c=wi.sharedFloat64Array;return c[0]=Math.min(h,u,p,s),c[1]=Math.min(d,t,n,o),c[2]=Math.max(h,u,p,s),c[3]=Math.max(d,t,n,o),c}static sharedFloat64Array=new Float64Array(4)},Y.Text=class extends Y.Element{texture;printer;_direction;_horizontalAlign;_verticalAlign;content;_size;_lineSpacing;_letterSpacing;_color;_font;style;weight;_typeface;_effect;wordWrap;truncate;_overflow;textOuterX;textOuterY;textOuterWidth;textOuterHeight;blend;constructor(e){super(e),this.texture=null,this.printer=null,this.direction=e.direction,this.horizontalAlign=e.horizontalAlign,this.verticalAlign=e.verticalAlign,this.content=e.content,this.size=e.size,this.lineSpacing=e.lineSpacing,this.letterSpacing=e.letterSpacing,this.color=e.color,this.font=e.font,this.style=null,this.weight=null,this.typeface=e.typeface,this.effect=e.effect,this.wordWrap=!1,this.truncate=!1,this.overflow=e.overflow,this.textOuterX=0,this.textOuterY=0,this.textOuterWidth=0,this.textOuterHeight=0,this.blend=e.blend}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e,this.printer)&&(this.printer.reset(),this.printer.direction=e)}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(e){if(this._horizontalAlign!==e){switch(e){case"left":case"center":case"right":break;default:return}this._horizontalAlign=e,this.printer&&(this.printer.reset(),this.printer.horizontalAlign=e)}}get verticalAlign(){return this._verticalAlign}set verticalAlign(e){if(this._verticalAlign!==e){switch(e){case"top":case"middle":case"bottom":break;default:return}this._verticalAlign=e,this.printer&&(this.printer.reset(),this.printer.verticalAlign=e)}}get size(){return this._size}set size(e){this._size!==e&&(this._size=e,this.printer)&&(this.printer.reset(),this.printer.sizes[0]=e)}get lineSpacing(){return this._lineSpacing}set lineSpacing(e){this._lineSpacing!==e&&(this._lineSpacing=e,this.printer)&&(this.printer.reset(),this.printer.lineSpacing=e)}get letterSpacing(){return this._letterSpacing}set letterSpacing(e){this._letterSpacing!==e&&(this._letterSpacing=e,this.printer)&&(this.printer.reset(),this.printer.letterSpacing=e)}get color(){return this._color}set color(e){this._color!==e&&(this._color=e,this.printer)&&(this.printer.reset(),this.printer.colors[0]=o(e))}get font(){return this._font}set font(e){this._font!==e&&(this._font=e,this.printer)&&(this.printer.reset(),this.printer.fonts[0]=e||tt.font)}get typeface(){return this._typeface}set typeface(e){if(this._typeface!==e){switch(e){case"regular":this.style="normal",this.weight="normal";break;case"bold":this.style="normal",this.weight="bold";break;case"italic":this.style="italic",this.weight="normal";break;case"bold-italic":this.style="italic",this.weight="bold";break;default:return}this._typeface=e,this.printer&&(this.printer.reset(),this.printer.styles[0]=this.style,this.printer.weights[0]=this.weight)}}get effect(){return this._effect}set effect(e){this._effect=e,this.printer&&(this.printer.reset(),this.printer.effects[0]=tt.parseEffect(e))}get overflow(){return this._overflow}set overflow(e){if(this._overflow!==e){switch(this._overflow=e){case"visible":this.wordWrap=!1,this.truncate=!1;break;case"wrap":this.wordWrap=!0,this.truncate=!1;break;case"truncate":this.wordWrap=!1,this.truncate=!0;break;case"wrap-truncate":this.wordWrap=!0,this.truncate=!0}this.printer&&(this.printer.reset(),this.printer.wordWrap=this.wordWrap,this.printer.truncate=this.truncate)}}update(){let e=this.printer;var t;null===e&&(t=new je,(e=new tt(t)).direction=this.direction,e.horizontalAlign=this.horizontalAlign,e.verticalAlign=this.verticalAlign,e.sizes[0]=this.size,e.lineSpacing=this.lineSpacing,e.letterSpacing=this.letterSpacing,e.colors[0]=o(this.color),e.fonts[0]=this.font||tt.font,e.styles[0]=this.style,e.weights[0]=this.weight,e.effects[0]=tt.parseEffect(this.effect),e.wordWrap=this.wordWrap,e.truncate=this.truncate,this.texture=t,this.printer=e),(e.content!==this.content||e.wordWrap&&(e.horizontal?e.printWidth!==this.width:e.printHeight!==this.height)||e.truncate&&(e.horizontal?e.printHeight!==this.height:e.printWidth!==this.width))&&(e.content&&e.reset(),e.printWidth=this.width,e.printHeight=this.height,e.draw(this.content),this.calculateTextPosition())}draw(){if(!1===this.visible)return this.drawChildren();this.update(),this.content&&(We.alpha=this.opacity,We.blend=this.blend,We.matrix.set(Y.matrix).multiply(this.matrix),We.drawImage(this.texture,this.textOuterX,this.textOuterY,this.textOuterWidth,this.textOuterHeight)),this.drawChildren()}resize(){if(this.parent instanceof Y.Window)return this.parent.requestResizing();this.calculatePosition(),this.calculateTextPosition(),this.resizeChildren()}calculateTextPosition(){var e,t,i,a,n,s,r,o,l=this.printer;null!==l&&(n=l.paddingLeft,r=l.paddingTop,s=l.paddingRight,o=l.paddingBottom,e=this.x-n,t=this.y-r,i=this.texture.width,a=this.texture.height,n=this.width-(i-n-s),s=this.height-(a-r-o),r=l.alignmentFactorX,o=s*l.alignmentFactorY,this.textOuterX=e+n*r,this.textOuterY=t+o,this.textOuterWidth=i,this.textOuterHeight=a)}destroy(){this.texture?.destroy(),this.destroyChildren(),delete this.node.instance}},Y.TextBox=class extends Y.Element{focusing;texture;_type;_align;content;text;maxLength;number;min;max;decimals;_padding;_size;_font;_color;_colorInt;textX;textY;textShiftY;innerWidth;innerHeight;selectionY;selectionWidth;selectionHeight;_selectionColor;_selectionColorInt;_selectionBgColor;_selectionBgColorInt;printer;constructor(e){super(e),this.focusing=!1,this.texture=null,this.align=e.align,this.text=e.text,this.maxLength=e.maxLength,this.number=e.number,this.min=e.min,this.max=e.max,this.decimals=e.decimals,this.type=e.type,this.padding=e.padding,this.size=e.size,this.font=e.font,this.color=e.color,this.textX=null,this.textY=null,this.textShiftY=null,this.innerWidth=null,this.innerHeight=null,this.selectionY=null,this.selectionWidth=null,this.selectionHeight=null,this.selectionColor=e.selectionColor,this.selectionBgColor=e.selectionBgColor,this.printer=null}get type(){return this._type}set type(e){if(this._type!==e)switch(this._type=e){case"text":this.content=this.text;break;case"number":this.content=this.number.toString()}}get align(){return this._align}set align(e){this._align=e,this.connected&&this.calculateTextPosition()}get padding(){return this._padding}set padding(e){this._padding!==e&&(this._padding=e,this.connected)&&this.calculateTextPosition()}get size(){return this._size}set size(e){this._size!==e&&(this._size=e,this.printer)&&(this.printer.reset(),this.printer.sizes[0]=e)}get font(){return this._font}set font(e){this._font!==e&&(this._font=e,this.printer)&&(this.printer.reset(),this.printer.fonts[0]=e||tt.font)}get color(){return this._color}set color(e){this._color!==e&&(this._color=e,this._colorInt=o(e))}get selectionColor(){return this._selectionColor}set selectionColor(e){this._selectionColor!==e&&(this._selectionColor=e,this._selectionColorInt=o(e))}get selectionBgColor(){return this._selectionBgColor}set selectionBgColor(e){this._selectionBgColor!==e&&(this._selectionBgColor=e,this._selectionBgColorInt=o(e))}update(){let e=this.printer;var t;null===e&&(t=new je,(e=new tt(t)).matchTag=Function.empty,e.sizes[0]=this.size,e.fonts[0]=this.font||tt.font,e.colors[0]=4294967295,e.effects[0]={type:"none"},this.texture=t,this.printer=e),e.content!==this.content&&(e.content&&e.reset(),e.draw(this.content),this.connected)&&this.calculateTextPosition()}draw(){if(!1===this.visible)return this.drawChildren();this.update(),We.alpha=this.opacity,We.blend="normal",We.matrix.set(Y.matrix).multiply(this.matrix);var e,t,i,a,n,s=this.texture;null!==s&&(e=s.base,Y.hover===this.node?(a=this.textX,n=this.selectionY,t=this.selectionWidth,i=this.selectionHeight,We.fillRect(a,n,t,i,this._selectionBgColorInt),a=this.textShiftY,n=Math.min(e.width,this.innerWidth),t=this.innerHeight,We.drawText(s.clip(0,a,n,t),this.textX,this.textY,s.width,s.height,this._selectionColorInt)):this.content&&(i=this.textShiftY,a=Math.min(e.width,this.innerWidth),n=this.innerHeight,We.drawText(s.clip(0,i,a,n),this.textX,this.textY,s.width,s.height,this._colorInt))),this.drawChildren()}resize(){if(this.parent instanceof Y.Window)return this.parent.requestResizing();this.calculatePosition(),this.calculateTextPosition(),this.resizeChildren()}calculateTextPosition(){if(this.texture){var e=this.printer,t=e.sizes[0],i=(this.height-t)/2,a=e.paddingTop,n=this.texture.base;switch(this.textX=this.x+this.padding,this.textY=this.y+Math.max(i-a,0),this.textShiftY=Math.max(a-i,0),this.innerWidth=Math.max(this.width-2*this.padding,0),this.innerHeight=Math.min(this.height+this.y-this.textY,n.height),this.selectionY=this.y+Math.max(i,0),this.selectionWidth=Math.min(this.innerWidth,e.width),this.selectionHeight=Math.min(this.height,t),this.align){case"center":n.width<this.innerWidth&&(this.textX+=(this.innerWidth-n.width)/2);break;case"right":n.width<this.innerWidth&&(this.textX+=this.innerWidth-n.width+1)}a=Math.max(this.transform.scaleX,1),i=Math.max(this.transform.scaleY,1);this.textX=Math.round(this.textX*a)/a,this.textY=Math.round(this.textY*i)/i}}destroy(){this.texture?.destroy(),this.destroyChildren(),delete this.node.instance}},Y.DialogBox=class extends Y.Text{constructor(e){super({...e,direction:"horizontal-tb",horizontalAlign:"left",verticalAlign:"top",overflow:"wrap-truncate"})}},Y.ProgressBar=class extends Y.Element{texture;_image;display;clip;type;step;centerX;centerY;startAngle;centralAngle;progress;colorMode;color;blend;constructor(e){super(e),this.texture=null,this.image=e.image,this.display=e.display,this.clip=e.clip,this.type=e.type,this.step=e.step,this.centerX=e.centerX,this.centerY=e.centerY,this.startAngle=e.startAngle,this.centralAngle=e.centralAngle,this.progress=e.progress,this.colorMode=e.colorMode,this.color=e.color,this.blend=e.blend}get image(){return this._image}set image(e){this._image!==e&&(this._image=e,this.texture&&(this.texture.destroy(),this.texture=null),e)&&(this.texture=new $e(e),this.texture.on("load",()=>{Y.requestRendering()}))}draw(){if(!1===this.visible)return this.drawChildren();var e=this["texture"];if(null===e)this.drawDefaultImage();else if(e.complete){var t=e["base"];switch(this.display){case"stretch":e.clip(0,0,t.width,t.height);break;case"clip":e.clip(...this.clip)}var i=this.width/e.width,a=this.height/e.height,{vertices:n,vertexLength:s,drawingLength:r}=this.calculateProgressVertices(),o=(We.alpha=this.opacity,We.blend=this.blend,We.matrix.project(We.flip,We.width,We.height).multiply(Y.matrix).multiply(this.matrix).translate(this.x,this.y).scale(i,a),We.imageProgram.use());switch(We.bindVertexArray(o.vao),We.uniformMatrix3fv(o.u_Matrix,!1,We.matrix),We.uniform1i(o.u_LightMode,0),this.colorMode){case"texture":We.uniform1i(o.u_ColorMode,0),We.uniform4f(o.u_Tint,0,0,0,0);break;case"fixed":var l=this.color,c=l[0]/255,h=l[1]/255,d=l[2]/255,l=l[3]/255;We.uniform1i(o.u_ColorMode,1),We.uniform4f(o.u_Color,c,h,d,l)}We.bufferData(We.ARRAY_BUFFER,n,We.STREAM_DRAW,0,s),We.bindTexture(We.TEXTURE_2D,t.glTexture),We.drawArrays(We.TRIANGLE_FAN,0,r)}this.drawChildren()}calculateProgressVertices(){var n=this.type,r=Math.clamp(this.progress,0,1),e=this.texture;const o=e.x,l=e.y;var c=e.width,h=e.height,d=e.base.width,u=e.base.height,p=Y.ProgressBar.response,m=p.vertices,g=this.step;switch(n){case"horizontal":{let e=c*r;var f=h,v=(0!==g&&(e=Math.round(e/g)*g,e=Math.clamp(e,0,c)),e),t=f,i=o/d,a=l/u,b=(o+e)/d,f=(l+f)/u;return m[0]=0,m[1]=0,m[2]=i,m[3]=a,m[4]=0,m[5]=t,m[6]=i,m[7]=f,m[8]=v,m[9]=t,m[10]=b,m[11]=f,m[12]=v,m[13]=0,m[14]=b,m[15]=a,p.vertexLength=16,p.drawingLength=4,p}case"vertical":{i=c;let e=h*r;0!==g&&(e=Math.round(e/g)*g,e=Math.clamp(e,0,h));var t=h-e,f=i,v=h,b=o/d,a=(l+t)/u,i=(o+i)/d,y=(l+h)/u;return m[0]=0,m[1]=t,m[2]=b,m[3]=a,m[4]=0,m[5]=v,m[6]=b,m[7]=y,m[8]=f,m[9]=v,m[10]=i,m[11]=y,m[12]=f,m[13]=t,m[14]=i,m[15]=a,p.vertexLength=16,p.drawingLength=4,p}case"round":{var w=p.angles,x=p.array;let e=this.startAngle;b=this.centralAngle;let t=b*r;0!==g&&(t=Math.round(t/g)*g,t=0<=b?Math.min(t,b):Math.max(t,b)),t<0&&(t=-t,e-=t),e=Math.radians(e),t=Math.radians(t);var k=c,T=h,I=c*this.centerX,C=h*this.centerY,E=I+o,M=C+l,v=E/d,y=M/u,S=o/d,A=l/u,P=(o+c)/d,L=(l+h)/u;w[0]=Math.modRadians(Math.atan2(0-C,k-I)-e),w[1]=Math.modRadians(Math.atan2(T-C,k-I)-e),w[2]=Math.modRadians(Math.atan2(T-C,0-I)-e),w[3]=Math.modRadians(Math.atan2(0-C,0-I)-e),m[0]=I,m[1]=C,m[2]=v,m[3]=y;let i=w[0],a=0;for(let e=1;e<4;e++)w[e]<i&&(i=w[e],a=e);let n=8,s=a;for(let e=0;e<4;e++){var R=(a+e)%4;if(!(w[R]<t)){s=R;break}switch(R){case 0:m[n]=k,m[n+1]=0,m[n+2]=P,m[n+3]=A;break;case 1:m[n]=k,m[n+1]=T,m[n+2]=P,m[n+3]=L;break;case 2:m[n]=0,m[n+1]=T,m[n+2]=S,m[n+3]=L;break;case 3:m[n]=0,m[n+1]=0,m[n+2]=S,m[n+3]=A}n+=4}x[0]=e,x[1]=a,x[2]=4,x[3]=e+t,x[4]=s,x[5]=n;for(let e=0;e<6;e+=3){var F=x[e],D=x[e+1],z=x[e+2];switch(D){case 0:{const o=Math.tan(F+.5*Math.PI)*C;var B=I+o,N=(E+o)/d;m[z]=B,m[z+1]=0,m[z+2]=N,m[z+3]=A;break}case 1:{const l=Math.tan(F)*(c-I);B=C+l,N=(M+l)/u;m[z]=k,m[z+1]=B,m[z+2]=P,m[z+3]=N;break}case 2:{const o=Math.tan(F-.5*Math.PI)*(h-C);var q=I-o,_=(E-o)/d;m[z]=q,m[z+1]=T,m[z+2]=_,m[z+3]=L;break}case 3:{const l=Math.tan(F-Math.PI)*I;q=C-l,_=(M-l)/u;m[z]=0,m[z+1]=q,m[z+2]=S,m[z+3]=_;break}}}f=n/4+1;return p.vertexLength=4*f,p.drawingLength=f,p}}}resize(){if(this.parent instanceof Y.Window)return this.parent.requestResizing();this.calculatePosition(),this.resizeChildren()}destroy(){this.texture?.destroy(),this.destroyChildren(),delete this.node.instance}static response={vertices:new Float32Array(28),angles:new Float64Array(4),array:new Float64Array(6),vertexLength:null,drawingLength:null}},Y.Video=class extends Y.Element{video;loop;flip;blend;constructor(e){super(e),this.video=e.video,this.loop=e.loop,this.flip=e.flip,this.blend=e.blend}draw(){this.drawDefaultImage(),this.drawChildren()}resize(){if(this.parent instanceof Y.Window)return this.parent.requestResizing();this.calculatePosition(),this.resizeChildren()}destroy(){this.destroyChildren(),delete this.node.instance}},Y.Window=class xi extends Y.Element{_layout;scrollWidth;scrollHeight;_scrollX;_scrollY;gridWidth;gridHeight;gridGapX;gridGapY;paddingX;paddingY;overflow;columns;rows;constructor(e){super(e),this.layout=e.layout,this.scrollWidth=0,this.scrollHeight=0,this.scrollX=e.scrollX,this.scrollY=e.scrollY,this.gridWidth=e.gridWidth,this.gridHeight=e.gridHeight,this.gridGapX=e.gridGapX,this.gridGapY=e.gridGapY,this.paddingX=e.paddingX,this.paddingY=e.paddingY,this.overflow=e.overflow,this.columns=0,this.rows=0}get layout(){return this._layout}set layout(e){if(this._layout!==e){switch(this._layout=e){case"normal":delete this.resize;break;case"horizontal-grid":this.resize=xi.horizontalGridResize;break;case"vertical-grid":this.resize=xi.verticalGridResize}this.connected&&this.resize()}}get scrollX(){return this._scrollX}set scrollX(e){var t=this.scrollWidth-this.width,e=Math.clamp(e,0,t);this._scrollX!==e&&(this._scrollX=e,this.connected)&&(this.resize(),Y.requestRendering())}get scrollY(){return this._scrollY}set scrollY(e){var t=this.scrollHeight-this.height,t=Math.clamp(e,0,t);this._scrollY!==e&&(this._scrollY=t,this.connected)&&(this.resize(),Y.requestRendering())}draw(){switch(this.overflow){case"visible":this.drawChildren();break;case"hidden":We.depthTest||(We.alpha=1,We.blend="normal",We.depthTest=!0,We.enable(We.DEPTH_TEST),We.depthFunc(We.ALWAYS),We.matrix.set(Y.matrix).multiply(this.matrix),We.fillRect(this.x,this.y,this.width,this.height,0),We.depthFunc(We.EQUAL),this.drawChildren(),We.clear(We.DEPTH_BUFFER_BIT),We.disable(We.DEPTH_TEST),We.depthTest=!1)}}resize(){if(this.parent instanceof Y.Window)return this.parent.requestResizing();this.calculatePosition();var t=this["children"],i=t["length"],a=xi["proxy"];a.x=this.x-this.scrollX,a.y=this.y-this.scrollY,a.width=this.width,a.height=this.height,a.matrix=this.matrix,a.opacity=this.opacity;for(let e=0;e<i;e++){var n=t[e];n.parent=a,n.resize(),n.parent=this}this._calculateScrollArea()}requestResizing=(()=>{const e=new f({duration:0,callback:()=>this.resize()});return()=>e.add()})();_calculateScrollArea(){var t=Math["max"],i=this["children"],a=i["length"],n=this.width,s=this.height;let r=this.width,o=this.height;for(let e=0;e<a;e++){var l=i[e]["transform"],c=l.scaleX,h=l.scaleY,d=l.x+l.x2*n,u=l.y+l.y2*s,p=t(l.width+l.width2*n,0),m=t(l.height+l.height2*s,0);r=t(r,d+(1-l.anchorX)*p*c),o=t(o,u+(1-l.anchorY)*m*h)}this.scrollWidth=r,this.scrollHeight=o}destroy(){this.destroyChildren(),delete this.node.instance}static proxy={x:0,y:0,width:0,height:0,matrix:null,opacity:0};static horizontalGridResize(){this.calculatePosition();var t=this["children"],i=t["length"];if(0===i)this.columns=0,this.rows=0;else{var{floor:a,ceil:e,max:n}=Math,s=xi["proxy"],{gridWidth:r,gridHeight:o,gridGapX:l,gridGapY:c,paddingX:h,paddingY:d}=this,u=r+l,p=o+c,m=0===u?i:n(a((this.width+l-2*h)/u),1),l=e(i/m),e=l*p-c+2*d,g=(this.scrollWidth=n(this.width,r),this.scrollHeight=n(this.height,e),this.columns=m,this.rows=l,s.width=r,s.height=o,s.matrix=this.matrix,s.opacity=this.opacity,this.x-this.scrollX+h),f=this.y-this.scrollY+d;for(let e=0;e<i;e++){var v=t[e];s.x=g+e%m*u,s.y=f+a(e/m)*p,v.parent=s,v.resize(),v.parent=this}}}static verticalGridResize(){this.calculatePosition();var t=this["children"],i=t["length"];if(0===i)this.columns=0,this.rows=0;else{var{floor:a,ceil:e,max:n}=Math,s=xi["proxy"],{gridWidth:r,gridHeight:o,gridGapX:l,gridGapY:c,paddingX:h,paddingY:d}=this,u=r+l,p=o+c,m=0===p?i:n(a((this.height+c-2*d)/p),1),c=e(i/m),g=(this.scrollWidth=n(this.width,c*u-l+2*h),this.scrollHeight=n(this.height,o),this.columns=c,this.rows=m,s.width=r,s.height=o,s.matrix=this.matrix,s.opacity=this.opacity,this.x-this.scrollX+h),f=this.y-this.scrollY+d;for(let e=0;e<i;e++){var v=t[e];s.x=g+a(e/m)*u,s.y=f+e%m*p,v.parent=s,v.resize(),v.parent=this}}}},Y.Container=class extends Y.Element{draw(){this.drawChildren()}resize(){if(this.parent instanceof Y.Window)return this.parent.requestResizing();this.calculatePosition(),this.resizeChildren()}destroy(){this.destroyChildren(),delete this.node.instance}},{state:"closed",page:_("#animation"),head:_("#animation-head"),body:_("#animation-body").hide(),screen:_("#animation-screen"),marquee:_("#animation-marquee"),dirList:_("#animation-dirList"),searcher:_("#animation-searcher"),list:_("#animation-list"),layerList:_("#animation-layer-list"),timeline:_("#animation-timeline").hide(),toolbar:_("#animation-timeline-toolbar"),outerRuler:_("#animation-timeline-ruler-outer"),innerRuler:_("#animation-timeline-ruler-inner"),outerTimelineList:_("#animation-timeline-list-outer"),innerTimelineList:_("#animation-timeline-list-inner"),timelineCursor:_("#animation-timeline-cursor").hide(),timelineMarquee:_("#animation-timeline-marquee").hide(),timelineMarqueeShift:_("#animation-timeline-marquee-shift").hide(),outerPointerArea:_("#animation-timeline-pointer-area-outer"),innerPointerArea:_("#animation-timeline-pointer-area-inner"),pointer:_("#animation-timeline-pointer"),dirTags:null,dragging:null,playing:!1,motion:null,direction:0,target:null,hover:null,history:null,contextLoaded:!1,particleUpdating:!1,targetContext:null,controlPoints:null,controlPointVisible:!1,controlPointActive:null,controlPointRotation:null,translationKey:0,translationTimer:null,showMark:!1,showOnionskin:!1,mirror:!1,loop:!1,background:null,matrix:null,speed:null,zoom:null,zoomTimer:null,scale:null,scaleX:null,scaleY:null,outerWidth:null,outerHeight:null,scrollLeft:null,scrollTop:null,scrollRight:null,scrollBottom:null,centerX:null,centerY:null,centerOffsetX:null,centerOffsetY:null,padding:null,inspectorTypeMap:null,context:null,meta:null,player:null,mode:null,sprites:null,motions:null,layers:null,animIndex:null,frameMax:null,initialize:null,open:null,load:null,save:null,close:null,destroy:null,play:null,stop:null,copy:null,paste:null,delete:null,undo:null,redo:null,openLayer:null,previousFrame:null,nextFrame:null,previousKeyFrame:null,nextKeyFrame:null,setSpeed:null,setZoom:null,setHover:null,setMotion:null,setMotionMode:null,setDirection:null,createDirItems:null,editMotion:null,getNewMotionId:null,revealTarget:null,shiftTarget:null,resizeTarget:null,rotateTarget:null,setControlPoint:null,updateMotion:null,updateMotionItem:null,updateTarget:null,updateTargetContext:null,updatePlayerMotion:null,updateFrameContexts:null,updateControlPoints:null,updateHead:null,resize:null,getPointerCoords:null,getFrameCoords:null,getKeyFrame:null,getLayerIndex:null,getMotionListItems:null,getSpriteListItems:null,updateCamera:null,updateTransform:null,updateMatrix:null,updateRuler:null,updateTimeline:null,updateTimelineLength:null,updatePointerArea:null,updatePointer:null,updateCursor:null,selectFrame:null,selectMarquee:null,unselectMarquee:null,updateMarquee:null,scrollToMarquee:null,updateMarqueeShift:null,selectFrameRelative:null,selectFrameAtHomeEnd:null,selectAllFramesOfKey:null,multiSelectFramesRelative:null,multiSelectFramesToHomeEnd:null,openFrame:null,loadTextures:null,loadFrames:null,drawBackground:null,drawOnionskins:null,drawSpriteLayers:null,drawEmitters:null,emitParticles:null,updateParticles:null,drawParticles:null,drawCoordinateAxes:null,drawJointNodes:null,drawJointArrows:null,drawJointSpinner:null,drawHoverWireframe:null,drawTargetWireframe:null,drawSpriteWireframe:null,drawEmitterWireframe:null,drawTargetAnchor:null,drawSpriteControlPoints:null,createTimelines:null,getFrame:null,sortFrames:null,shiftFrames:null,saveFrames:null,cloneFrame:null,insertFrame:null,extendFrame:null,deleteFrame:null,copyFrame:null,pasteFrame:null,selectAllFrames:null,dragAndDropFrame:null,adjustMarquee:null,shiftSelectedFrames:null,selectControlPoint:null,selectObject:null,isPointInFrame:null,getAnimationRange:null,requestRefreshingList:null,requestAnimation:null,updateAnimation:null,stopAnimation:null,requestRendering:null,renderingFunction:null,stopRendering:null,switchMark:null,switchOnionskin:null,switchMirror:null,switchSettings:null,switchLoop:null,planToSave:null,saveToConfig:null,loadFromConfig:null,saveToProject:null,loadFromProject:null,webglRestored:null,windowResize:null,themechange:null,datachange:null,enumchange:null,keydown:null,headPointerdown:null,switchPointerdown:null,speedInput:null,zoomFocus:null,zoomInput:null,screenKeydown:null,translationKeyup:null,screenWheel:null,screenUserscroll:null,screenBlur:null,marqueePointerdown:null,marqueePointermove:null,marqueePointerleave:null,marqueeDoubleclick:null,pointerup:null,pointermove:null,searcherInput:null,listKeydown:null,listPointerdown:null,listSelect:null,listRecord:null,listOpen:null,listPopup:null,listChange:null,listPageResize:null,dirListPointerdown:null,timelinePageResize:null,timelineToolbarPointerdown:null,layerListWheel:null,layerListScroll:null,layerListKeydown:null,layerListPointerdown:null,layerListSelect:null,layerListRecord:null,layerListPopup:null,layerListChange:null,outerTimelineListKeydown:null,outerTimelineListWheel:null,outerTimelineListScroll:null,outerTimelineListBlur:null,outerTimelineListPointerdown:null,outerTimelineListPointerup:null,outerTimelineListPointermove:null,innerTimelineListPointermove:null,innerTimelineListPointerleave:null,innerTimelineListDblclick:null,Player:null}),Pt=(Ke.marquee.resize=null,Ke.list.page=_("#animation-motion"),Ke.list.head=_("#animation-list-head"),Ke.list.copy=null,Ke.list.paste=null,Ke.list.delete=null,Ke.list.cancelSearch=null,Ke.list.updateHead=null,Ke.list.createIcon=null,Ke.list.createText=null,Ke.list.updateText=null,Ke.list.createLoopIcon=null,Ke.list.updateLoopIcon=null,Ke.list.onDelete=null,Ke.layerList.update=null,Ke.layerList.create=null,Ke.layerList.copy=null,Ke.layerList.paste=null,Ke.layerList.delete=null,Ke.layerList.restoreMotion=null,Ke.layerList.restoreRecursiveStates=A.list.restoreRecursiveStates,Ke.layerList.setRecursiveStates=A.list.setRecursiveStates,Ke.layerList.createIcon=null,Ke.layerList.createVisibilityIcon=A.list.createVisibilityIcon,Ke.layerList.updateVisibilityIcon=A.list.updateVisibilityIcon,Ke.layerList.createLockIcon=A.list.createLockIcon,Ke.layerList.updateLockIcon=A.list.updateLockIcon,Ke.layerList.onDelete=null,Ke.timeline.head=_("#animation-timeline-head"),Ke.timeline.updateHead=null,Ke.outerTimelineList.dragging=null,Ke.outerTimelineList.restoreMotionAndLayer=null,Ke.innerTimelineList.pointerevent=null,Ke.timelineCursor.pointerevent=null,Ke.timelineMarquee.layer=null,Ke.timelineMarquee.x=-1,Ke.timelineMarquee.y=-1,Ke.timelineMarquee.length=-1,Ke.timelineMarquee.origin=-1,Ke.timelineMarquee.isPointIn=null,Ke.timelineMarquee.isSelected=null,Ke.timelineMarquee.isExtendable=null,Ke.timelineMarquee.isShrinkable=null,Ke.initialize=function(){this.screen.addSetScrollMethod();var e={jointRotate:{},rectRotate:{TL:{x:0,y:0,angle:225},TR:{x:0,y:0,angle:315},BL:{x:0,y:0,angle:135},BR:{x:0,y:0,angle:45}},rectResize:{T:{x:0,y:0,angle:270},L:{x:0,y:0,angle:180},R:{x:0,y:0,angle:0},B:{x:0,y:0,angle:90},TL:{x:0,y:0,angle:225},TR:{x:0,y:0,angle:315},BL:{x:0,y:0,angle:135},BR:{x:0,y:0,angle:45}},rectList:null};e.rectList=[e.rectRotate.TL,e.rectRotate.TR,e.rectRotate.BL,e.rectRotate.BR,e.rectResize.T,e.rectResize.L,e.rectResize.R,e.rectResize.B,e.rectResize.TL,e.rectResize.TR,e.rectResize.BL,e.rectResize.BR],this.controlPoints=e,this.translationTimer=new f({duration:1/0,update:e=>{if("open"!==this.state||null!==this.dragging)return!1;{var i=this.translationKey,a=1.5*f.deltaTime/this.scale;let e=0,t=0;1&i&&(e-=a),2&i&&(t-=a),4&i&&(e+=a),8&i&&(t+=a);var i=this.screen,a=i.scrollLeft,n=i.scrollTop,s=Math.roundTo(this.centerX+e,4),r=Math.roundTo(this.centerY+t,4);this.updateCamera(s,r),this.updateTransform(),i.scrollLeft===a&&i.scrollTop===n||(this.requestRendering(),this.marquee.resize())}}}),this.zoomTimer=new f({duration:80,update:e=>{if("open"!==this.state)return this.scale=e.end,!1;var{elapsed:e,duration:t,start:i,end:a}=e,e=e/t;this.scale=i*(1-e)+a*e,this.resize(),this.requestRendering()}}),this.dirTags={"1-dir":["→"],"1-dir-mirror":["→"],"2-dir":["←","→"],"3-dir-mirror":["↓","→","↑"],"4-dir":["↓","←","→","↑"],"5-dir-mirror":["↓","→","↑","↘","↗"],"8-dir":["↓","←","→","↑","↙","↘","↖","↗"]},this.padding=800,this.matrix=new Ze,this.inspectorTypeMap={joint:"animJointFrame",sprite:"animSpriteFrame",particle:"animParticleFrame"},this.searcher.addCloseButton(),this.searcher.addKeydownFilter();const r=this["list"],o=(r.removable=!0,r.bind(()=>this.motions),r.updaters.push(r.updateText),r.creators.push(r.createLoopIcon),r.creators.push(r.updateLoopIcon),this)["layerList"];o.removable=!0,o.renamable=!0,o.bind(()=>this.layers),o.creators.push(o.createVisibilityIcon),o.updaters.push(o.updateVisibilityIcon),o.creators.push(o.createLockIcon),o.updaters.push(o.updateLockIcon),l.processors["animation-object-create"]=(e,t)=>{t=t.response;r.restore(e,t)},l.processors["animation-object-delete"]=(e,t)=>{t=t.response;r.restore(e,t)},l.processors["animation-object-remove"]=(e,t)=>{t=t.response;r.restore(e,t)},l.processors["animation-motion-id-change"]=(e,t)=>{var{motion:i,id:a}=t;t.id=i.id,i.id=a,r.update(),r.select(i),r.scrollToSelection(),Ke.planToSave()},l.processors["animation-motion-mode-change"]=(e,t)=>{var{motion:i,direction:a,mode:n,dirCases:s}=t;t.mode=i.mode,t.dirCases=i.dirCases,i.mode=n,i.dirCases=s,r.update(),r.select(i),r.scrollToSelection(),j.open("animMotion",i),j.animMotion.write({mode:n}),Ke.createDirItems(),Ke.setDirection(a),Ke.planToSave()},l.processors["animation-layer-rename"]=(e,t)=>{var{motion:t,direction:i,response:a}=t;o.restoreMotion(t,i),o.restore(e,a)},l.processors["animation-layer-create"]=l.processors["animation-layer-delete"]=l.processors["animation-layer-remove"]=(e,t)=>{var{motion:t,direction:i,response:a}=t;Ke.contextLoaded=!1,o.restoreMotion(t,i),o.restore(e,a)},l.processors["animation-layer-hidden"]=(e,t)=>{var{motion:t,direction:i,item:a,oldValues:n,newValue:s}=t;o.restoreMotion(t,i),"undo"===e?o.restoreRecursiveStates(a,"hidden",n):o.setRecursiveStates(a,"hidden",s),o.update(),Ke.requestRendering(),Ke.planToSave()},l.processors["animation-layer-locked"]=(e,t)=>{var{motion:t,direction:i,item:a,oldValues:n,newValue:s}=t;o.restoreMotion(t,i),"undo"===e?o.restoreRecursiveStates(a,"locked",n):o.setRecursiveStates(a,"locked",s),o.update(),Ke.planToSave()},l.processors["animation-frames-change"]=(e,t)=>{var{motion:t,direction:i,changes:a,sMarquee:n,dMarquee:s}=t;for(const c of a){const{layer:r,frames:h}=c;c.frames=r.frames,r.frames=h}const{layer:r,x:o,length:l}="undo"===e?n:s;Ke.outerTimelineList.restoreMotionAndLayer(t,i,r),Ke.player.index=o,Ke.unselectMarquee(),Ke.updateTimeline();a=Ke.getLayerIndex(r);Ke.selectMarquee(o,a,l,o),Ke.scrollToMarquee(!1),Ke.planToSave()},l.processors["animation-easing-change"]=(e,t)=>{var{motion:i,direction:a,target:n,easingId:s}=t;t.easingId=n.easingId,n.easingId=s,Pt.target===n&&Pt.list.write(s),Pt.updateTimeline(n),Ke.setMotion(i),Ke.setDirection(a),Ke.selectFrame(n),Ke.updateFrameContexts(),Ke.requestRendering(),Ke.planToSave()},l.processors["animation-target-shift"]=(e,t)=>{var{editor:i,motion:a,direction:n,target:s,x:r,y:o}=t;t.x=s.x,t.y=s.y,s.x=r,s.y=o,i.target===s&&i.write({x:r,y:o}),Ke.setMotion(a),Ke.setDirection(n),Ke.selectFrame(s),Ke.updateFrameContexts(),Ke.requestRendering(),Ke.planToSave()},l.processors["animation-target-resize"]=(e,t)=>{var{editor:i,motion:a,direction:n,target:s,scaleX:r,scaleY:o}=t;t.scaleX=s.scaleX,t.scaleY=s.scaleY,s.scaleX=r,s.scaleY=o,i.target===s&&i.write({scaleX:r,scaleY:o}),Ke.setMotion(a),Ke.setDirection(n),Ke.selectFrame(s),Ke.updateFrameContexts(),Ke.requestRendering(),Ke.planToSave()},l.processors["animation-target-rotate"]=(e,t)=>{var{editor:i,motion:a,direction:n,target:s,rotation:r}=t;t.rotation=s.rotation,s.rotation=r,i.target===s&&i.write({rotation:r}),Ke.setMotion(a),Ke.setDirection(n),Ke.selectFrame(s),Ke.updateFrameContexts(),Ke.requestRendering(),Ke.planToSave()},l.processors["animation-target-index"]=(e,t)=>{var{motion:i,direction:a,target:n,hindex:s,vindex:r}=t;t.hindex=n.spriteX,t.vindex=n.spriteY,n.spriteX=s,n.spriteY=r,Ke.setMotion(i),Ke.setDirection(a),Ke.selectFrame(n),Ke.requestRendering(),"closed"!==y.state&&(y.marquee.select(s,r,1,1),y.updateTargetInfo()),Ke.planToSave()},window.on("themechange",this.themechange),window.on("datachange",this.datachange),window.on("enumchange",this.enumchange),window.on("keydown",this.keydown),this.page.on("resize",this.windowResize),this.head.on("pointerdown",this.headPointerdown),We.canvas.on("webglcontextrestored",this.webglRestored),_("#animation-head-start").on("pointerdown",this.switchPointerdown),_("#animation-speed").on("input",this.speedInput),_("#animation-zoom").on("focus",this.zoomFocus),_("#animation-zoom").on("input",this.zoomInput),this.screen.on("keydown",this.screenKeydown),this.screen.on("wheel",this.screenWheel),this.screen.on("userscroll",this.screenUserscroll),this.screen.on("blur",this.screenBlur),this.marquee.on("pointerdown",this.marqueePointerdown),this.marquee.on("pointermove",this.marqueePointermove),this.marquee.on("pointerleave",this.marqueePointerleave),this.marquee.on("doubleclick",this.marqueeDoubleclick),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),r.on("keydown",this.listKeydown),r.on("pointerdown",this.listPointerdown),r.on("select",this.listSelect),r.on("record",this.listRecord),r.on("open",this.listOpen),r.on("popup",this.listPopup),r.on("change",this.listChange),r.page.on("resize",this.listPageResize),this.dirList.on("pointerdown",this.dirListPointerdown),this.timeline.on("resize",this.timelinePageResize),this.toolbar.on("pointerdown",this.timelineToolbarPointerdown),this.layerList.on("wheel",this.layerListWheel),this.layerList.on("scroll",this.layerListScroll),this.layerList.on("keydown",this.layerListKeydown,{capture:!0}),this.layerList.on("pointerdown",this.layerListPointerdown),this.layerList.on("select",this.layerListSelect),this.layerList.on("record",this.layerListRecord),this.layerList.on("popup",this.layerListPopup),this.layerList.on("change",this.layerListChange),this.outerTimelineList.on("keydown",this.outerTimelineListKeydown),this.outerTimelineList.on("wheel",this.outerTimelineListWheel),this.outerTimelineList.on("scroll",this.outerTimelineListScroll),this.outerTimelineList.on("blur",this.outerTimelineListBlur),this.outerTimelineList.on("pointerdown",this.outerTimelineListPointerdown),this.innerTimelineList.on("pointermove",this.innerTimelineListPointermove),this.innerTimelineList.on("pointerleave",this.innerTimelineListPointerleave),this.innerTimelineList.on("dblclick",this.innerTimelineListDblclick),Pt.initialize()},Ke.open=function(e){var t;this.context!==e&&(this.save(),this.close(),S.Element.stage=this,t=e["meta"],e.animation||(e.animation=He.animations[t.guid]),e.animation?(this.state="open",this.context=e,this.meta=t,this.body.show(),this.load(e),this.resize(),this.requestRendering()):(x.manager.switch("directory"),O.confirm({message:"Failed to read file: "+t.path},[{label:"Confirm"}])))},Ke.load=function(e){var t=!e.editor,{animation:i,editor:e}=(t&&(i={mode:"1-dir",sprites:[],motions:[]},(i=new Ke.Player(i)).onionskin={prev:[],next:[]},e.editor={motion:null,target:null,player:i,history:new l(100),centerX:0,centerY:0,selectionX:0,selectionLength:0,listScrollTop:0}),e);this.mode=i.mode,this.sprites=i.sprites,this.motions=i.motions,this.player=e.player,this.history=e.history,this.centerX=e.centerX,this.centerY=e.centerY,Ke.Player.matrix.reset(),t&&this.loadTextures(),this.list.update(),this.setMotion(e.motion),e.target&&this.selectFrame(e.target,e.selectionX,e.selectionLength)},Ke.save=function(){var e,t;"open"===this.state&&({animation:e,editor:t}=this.context,e.mode=this.mode,e.sprites=this.sprites,e.motions=this.motions,t.motion=this.motion,t.target=this.target,t.player=this.player,t.history=this.history,t.centerX=this.centerX,t.centerY=this.centerY,t.selectionX=this.timelineMarquee.x,t.selectionLength=this.timelineMarquee.length)},Ke.close=function(){"closed"!==this.state&&(this.screen.blur(),this.setMotion(null),"fileAnimation"===j.type&&j.close(),this.state="closed",this.context=null,this.meta=null,this.player=null,this.mode=null,this.sprites=null,this.motions=null,this.history=null,this.searcher.write(""),this.list.clear(),this.layerList.clear(),this.innerTimelineList.clear(),this.body.hide(),this.stop(),this.stopAnimation(),this.stopRendering())},Ke.destroy=function(e){e.editor&&(this.context===e&&(this.save(),this.close()),e.editor.player.destroy())},Ke.play=function(){if(this.playing)return this.stop();var e,t;null!==this.motion&&(e=this.getAnimationRange(),(t=this.player).index<e.end-1?this.animIndex=t.index:this.animIndex=-1,this.playing=!0,this.requestAnimation(),t.clearParticles(),_("#animation-timeline-play").addClass("playing"))},Ke.stop=function(){this.playing&&(this.playing=!1,this.loadFrames(Math.floor(this.animIndex)),_("#animation-timeline-play").removeClass("playing"))},Ke.copy=function(){"open"===this.state&&null!==this.motion&&this.list.copy(this.motion)},Ke.paste=function(){"open"===this.state&&null===this.dragging&&this.list.paste(null)},Ke.delete=function(){"open"===this.state&&null!==this.motion&&null===this.dragging&&this.list.delete(this.motion)},Ke.undo=function(){"open"===this.state&&!this.dragging&&this.history.canUndo()&&(this.history.restore("undo"),this.marquee.resize())},Ke.redo=function(){"open"===this.state&&!this.dragging&&this.history.canRedo()&&(this.history.restore("redo"),this.marquee.resize())},Ke.openLayer=function(e){switch(this.layerList.selectWithNoEvent(e),e.class){case"joint":j.close();break;case"sprite":j.open("animSpriteLayer",e);break;case"particle":j.open("animParticleLayer",e)}},Ke.previousFrame=function(){var e,t=this.player["length"];t<=1||(t=(this.player.index-1+t)%t,-1!==(e=this.timelineMarquee.y)&&(this.selectMarquee(t,e,1,t),this.scrollToMarquee(!1)),this.loadFrames(t))},Ke.nextFrame=function(){var e,t=this.player["length"];t<=1||(t=(this.player.index+1)%t,-1!==(e=this.timelineMarquee.y)&&(this.selectMarquee(t,e,1,t),this.scrollToMarquee(!1)),this.loadFrames(t))},Ke.previousKeyFrame=function(){if(!(this.player.length<=1)){var i=this.player.contexts,a=this.player.index,t=this.timelineMarquee.y;if(-1!==t){let e=-1;var n=i[t].layer["frames"];for(const l of n){if(!(l.start<a))break;e=l.start}-1!==(e=-1===e&&0!==n.length?n[n.length-1].start:e)&&(this.selectMarquee(e,t,1,e),this.scrollToMarquee(!1),this.loadFrames(e))}else{let t=-1/0;var s=i["count"];for(let e=0;e<s;e++){var r=i[e].layer["frames"];for(const c of r){if(!(c.start<a))break;t=Math.max(t,c.start)}}if(t===-1/0)for(let e=0;e<s;e++){var o=i[e].layer["frames"];0!==o.length&&(t=Math.max(t,o[o.length-1].start))}t!==-1/0&&this.loadFrames(t)}}},Ke.nextKeyFrame=function(){if(!(this.player.length<=1)){var i=this.player.contexts,a=this.player.index,t=this.timelineMarquee.y;if(-1!==t){let e=-1;var n=i[t].layer["frames"];for(const l of n)if(l.start>a){e=l.start;break}-1!==(e=-1===e&&0!==n.length?n[0].start:e)&&(this.selectMarquee(e,t,1,e),this.scrollToMarquee(!1),this.loadFrames(e))}else{let t=1/0;var s=i["count"];for(let e=0;e<s;e++){var r=i[e].layer["frames"];for(const c of r)if(c.start>a){t=Math.min(t,c.start);break}}if(t===1/0)for(let e=0;e<s;e++){var o=i[e].layer["frames"];0!==o.length&&(t=Math.min(t,o[0].start))}t!==1/0&&this.loadFrames(t)}}},Ke.setSpeed=function(){const t=_("#animation-speed");return function(e){this.speed=e,t.write(e)}}(),Ke.setZoom=function(){const i=_("#animation-zoom");return function(t){if(this.zoom!==t){let e;switch(t){case 0:e=.25;break;case 1:e=.5;break;case 2:e=1;break;case 3:e=2;break;case 4:e=4;break;default:return}this.zoom=t,i.write(t),"open"===this.state?((t=this.zoomTimer).start=this.scale,t.end=e,t.elapsed=0,t.add()):this.scale=e}}}(),Ke.setHover=function(e){this.hover!==e&&(this.hover=e,this.requestRendering())},Ke.setMotion=function(e){this.motion!==e&&(this.motion=e,this.updateMotionItem(),this.createDirItems(),this.stop(),this.stopAnimation(),this.requestRendering(),this.player.destroyUpdatingEmitters(),e?(this.timeline.show(),this.timeline.updateHead(),Pt.open(),this.setDirection(this.direction)):(this.layers=null,this.timeline.hide(),this.layerList.clear(),this.innerTimelineList.clear(),this.updatePlayerMotion(),this.unselectMarquee(),j.close(),Pt.close()))},Ke.setMotionMode=function(e){if(this.motion){var t=this.motion.dirCases,e=(this.history.save({type:"animation-motion-mode-change",motion:this.motion,direction:this.direction,mode:this.motion.mode,dirCases:t.slice()}),this.motion.mode=e,this.dirTags[e]),i=e.length;for(let e=t.length;e<i;e++)t[e]=j.animMotion.createDir();t.length>i&&(t.length=i)}},Ke.setDirection=function(e){var t;this.motion&&(t=this.motion.dirCases,e=Math.min(e,t.length-1),t=this.motion.dirCases[e],this.direction=e,this.layers=t.layers,this.updatePlayerMotion(),this.contextLoaded=!1,this.layerList.update(),this.dirList.querySelector(".selected")?.removeClass("selected"),this.dirList.childNodes[e].addClass("selected"),void 0===t.loaded)&&Object.defineProperty(t,"loaded",{configurable:!0,value:!0})},Ke.createDirItems=function(){var t=this.dirList,e=this.motion?.mode??"none";if(t.mode!==e&&(t.mode=e,t.clear(),"none"!==e)){var i=this.dirTags[e];for(let e=0;e<i.length;e++){var a=document.createElement("anim-dir");e===Ke.direction&&a.addClass("selected"),a.direction=e,a.textContent=i[e],t.appendChild(a)}1<i.length?t.show():t.hide()}},Ke.editMotion=function(t){var e={read(){return t.id},input(e){t.id!==e&&(Ke.history.save({type:"animation-motion-id-change",motion:t,id:t.id}),t.id=e,Ke.requestRefreshingList())}};M.open(e,"string")},Ke.getNewMotionId=function(t){var e={read(){return""},input(e){t(e)}};M.open(e,"string")},Ke.revealTarget=function(){const o=new f({duration:200,update:e=>{var t=e["target"];if(t!==Ke.target)return e.target=null,!1;var t=u.EasingMap.easeInOut.map(e.elapsed/e.duration),i=e.startX*(1-t)+e.endX*t,e=e.startY*(1-t)+e.endY*t,t=Ke.screen,a=t.scrollLeft,n=t.scrollTop;Ke.updateCamera(i,e),Ke.updateTransform(),t.scrollLeft===a&&t.scrollTop===n||(Ke.requestRendering(),Ke.marquee.resize())},callback:e=>{e.target=null}});return function(){var e,t,i,a,n,s,r=this.target;r&&!o.target&&(e=(t=We.matrix.reset().multiply(this.targetContext.matrix))[6],t=t[7],i=.5/this.scaleX,a=.5/this.scaleY,{centerX:n,centerY:s}=this,Math.abs(e-n)>i||Math.abs(t-s)>a)&&(o.target=r,o.startX=n,o.startY=s,o.endX=e,o.endY=t,o.elapsed=0,o.add())}}(),Ke.shiftTarget=function(e,t){var i,a,n,s,r,o=this.targetContext,l=this.target;null!==o&&null!==l&&(this.planToSave(),o=this.inspectorTypeMap[o.layer.class],o=j[o],a=(i=this.history).index,n=i.length,s=i[a],r="animation-target-shift",a===n-1&&void 0!==s&&s.type===r&&s.target===l||i.save({type:r,editor:o,motion:this.motion,direction:this.direction,target:l,x:l.x,y:l.y}),l.x=e,l.y=t,this.updateFrameContexts(),this.requestRendering(),o.target===l)&&o.write({x:e,y:t})},Ke.resizeTarget=function(e,t){var i,a,n,s,r,o=this.targetContext,l=this.target;null!==o&&null!==l&&(this.planToSave(),o=this.inspectorTypeMap[o.layer.class],o=j[o],a=(i=this.history).index,n=i.length,s=i[a],r="animation-target-resize",a===n-1&&void 0!==s&&s.type===r&&s.target===l||i.save({type:r,editor:o,motion:this.motion,direction:this.direction,target:l,scaleX:l.scaleX,scaleY:l.scaleY}),void 0!==e&&(l.scaleX=e),void 0!==t&&(l.scaleY=t),this.updateFrameContexts(),this.requestRendering(),o.target===l)&&o.write({scaleX:e,scaleY:t})},Ke.rotateTarget=function(e){var t,i,a,n,s,r=this.targetContext,o=this.target;null!==r&&null!==o&&(this.planToSave(),r=this.inspectorTypeMap[r.layer.class],r=j[r],i=(t=this.history).index,a=t.length,n=t[i],s="animation-target-rotate",i===a-1&&void 0!==n&&n.type===s&&n.target===o||t.save({type:s,editor:r,motion:this.motion,direction:this.direction,target:o,rotation:o.rotation}),o.rotation=e,this.updateFrameContexts(),this.requestRendering(),r.target===o)&&r.write({rotation:e})},Ke.setControlPoint=function(t){if(this.controlPointActive!==t){this.controlPointActive=t;var i=this.controlPoints;let e;switch(t){case null:e="";break;case i.jointRotate:case i.rectRotate.TL:case i.rectRotate.TR:case i.rectRotate.BL:case i.rectRotate.BR:e="alias";break;case i.rectResize.T:case i.rectResize.L:case i.rectResize.R:case i.rectResize.B:case i.rectResize.TL:case i.rectResize.TR:case i.rectResize.BL:case i.rectResize.BR:var a=Math.modDegrees(t.angle+this.controlPointRotation,180);if(e=a<22.5||157.5<=a?"ew-resize":a<67.5?"nwse-resize":a<112.5?"ns-resize":"nesw-resize",this.mirror)switch(e){case"nwse-resize":e="nesw-resize";break;case"nesw-resize":e="nwse-resize"}}this.body.style.cursor=e}},Ke.updateMotion=function(){var e=this.list.read();e!==this.motion&&this.setMotion(e)},Ke.updateMotionItem=function(){var e,t=this["motion"];null!==t&&(e=this["list"],e.read()!==t)&&e.selectWithNoEvent(t)},Ke.updateTarget=function(){var e;null!==this.target&&(e=this.timelineMarquee["layer"],this.layerList.read()!==e)&&this.unselectMarquee()},Ke.updateTargetContext=function(){var t=this.target;if(null!==t){var i=this.player["contexts"],a=i["count"];for(let e=0;e<a;e++){var n=i[e];if(n.frame===t)return void(this.targetContext=n)}}this.targetContext=null},Ke.updatePlayerMotion=function(){this.player.motion=this.motion,this.player.direction=this.direction,this.player.layers=this.layers},Ke.updateFrameContexts=function(){var i=this.player,a=i.index;if(i.updateFrameParameters(i.contexts,a),this.showOnionskin){var n=i["length"];if(!(n<=1)){let e=a-1,t=a+1;this.loop&&(e=(e+n)%n,t%=n);var{prev:a,next:n}=i.onionskin;i.updateFrameParameters(a,e),i.updateFrameParameters(n,t)}}},Ke.updateControlPoints=function(e){let t,i,a,n;const{layer:s,frame:r}=e;switch(s.class){case"sprite":var o=s.sprite,o=this.player.textures[o];o instanceof $e&&(t=o.offsetX,i=o.offsetY,a=t+o.width,n=i+o.height);break;case"particle":var l=e.emitter;if(void 0!==l){l.hasArea=!1,l.outerWidth=0,l.outerHeight=0;for(var{area:c}of l.data.layers){switch(c.type){case"point":case"edge":continue}switch(void 0===t&&(t=i=a=n=0,l.hasArea=!0),c.type){case"rectangle":t=Math.min(t,-.5*c.width),i=Math.min(i,-.5*c.height),a=Math.max(a,.5*c.width),n=Math.max(n,.5*c.height);continue;case"circle":t=Math.min(t,-c.radius),i=Math.min(i,-c.radius),a=Math.max(a,+c.radius),n=Math.max(n,+c.radius);continue}}l.hasArea&&(l.outerWidth=a-t,l.outerHeight=n-i)}}if(void 0===t)return this.controlPointVisible=!1;var h=4/this.scale,d=this.controlPoints,u=e.matrix,p=u[0],m=u[1],g=u[3],f=u[4],v=u[6],u=u[7],b=p*t+g*i+v,y=m*t+f*i+u,w=p*t+g*n+v,x=m*t+f*n+u,k=p*a+g*n+v,T=m*a+f*n+u,p=p*a+g*i+v,g=m*a+f*i+u,v=Math.atan2(y-x,b-w),m=Math.atan2(x-T,w-k),f=Math.atan2(T-g,k-p),u=Math.atan2(g-y,p-b),I=-Math.cos(f)*h,v=Math.sin(v)*h,C=-Math.cos(u)*h,m=Math.sin(m)*h,E=Math.cos(f)*h,f=Math.sin(f)*h,M=Math.cos(u)*h,u=Math.sin(u)*h,h=d["rectRotate"],h=(h.TL.x=b+3*(I-M),h.TL.y=y+3*(v-u),h.TR.x=p+3*(M-E),h.TR.y=g+3*(u-f),h.BL.x=w+3*(C-I),h.BL.y=x+3*(m-v),h.BR.x=k+3*(E-C),h.BR.y=T+3*(f-m),d)["rectResize"];h.T.x=(p+b)/2+I,h.T.y=(g+y)/2+v,h.L.x=(b+w)/2+C,h.L.y=(y+x)/2+m,h.R.x=(k+p)/2+M,h.R.y=(T+g)/2+u,h.B.x=(w+k)/2+E,h.B.y=(x+T)/2+f,h.TL.x=b+I-M,h.TL.y=y+v-u,h.TR.x=p+M-E,h.TR.y=g+u-f,h.BL.x=w+C-I,h.BL.y=x+m-v,h.BR.x=k+E-C,h.BR.y=T+f-m;let S=r.rotation,A=e;for(;A=A.parent;){const r=A.frame;null!==r&&(S+=r.rotation)}return this.controlPointRotation=S,this.controlPointVisible=!0},Ke.updateHead=function(){var e,t,i,{page:a,head:n}=this;0!==a.clientWidth&&(a=x.getGroupOfElement(n)["nav"],i=a.rect(),t=(a=a.lastChild.rect()).right-i.left,n.left!==t&&(n.left=t,n.style.left=t+"px"),t=i.right-a.right,n.width!==t)&&(n.width=t,[a,t,n]=n.children,n.style.marginLeft="",a=a.rect(),t=t.rect(),t=(e=n.rect()).left-a.right-t.width,a=a.right-i.left-e.width,i=Math.min(t,a),n.style.marginLeft=i+"px")},Ke.resize=function(){var e,t,i,a,n,s,r,o,l;"open"===this.state&&0!==this.screen.clientWidth&&(s=this.scale,e=(t=CSS.getDevicePixelContentBoxSize(this.screen)).width,t=t.height,i=e+this.padding,a=t+this.padding,n=Math.round(i*s),s=Math.round(a*s),r=Math.max(e,n),o=Math.max(t,s),l=window.devicePixelRatio,this.outerWidth=r,this.outerHeight=o,this.centerOffsetX=e/2,this.centerOffsetY=t/2,this.scaleX=n/i,this.scaleY=s/a,this.marquee.style.width=r/l+"px",this.marquee.style.height=o/l+"px",We.resize(e,t),this.updateCamera(),this.updateTransform(),this.marquee.resize())},Ke.getPointerCoords=function(){const i={x:0,y:0};return function(e){var e=e.getRelativeCoords(this.marquee),t=window.devicePixelRatio;return i.x=(e.x*t-(this.outerWidth>>1))/this.scaleX,i.y=(e.y*t-(this.outerHeight>>1))/this.scaleY,this.mirror&&(i.x=-i.x),i}}(),Ke.getFrameCoords=function(){const r={x:0,y:0};return function(e,t=!1){var i,a=this.outerTimelineList,e=e.getRelativeCoords(a);let n=Math.floor(e.x/16),s=Math.floor(e.y/20);return t&&(e=a.scrollLeft/16,t=a.scrollTop/20,i=a.clientWidth/16+e,a=a.clientHeight/20+t,n=Math.clamp(n,Math.floor(e),Math.ceil(i)-1),s=Math.clamp(s,Math.floor(t),Math.ceil(a)-1)),r.x=n,r.y=s,r}}(),Ke.getKeyFrame=function(e,t){if(this.timelineMarquee.isPointIn(e,t)){var{layer:t,x:i,length:a}=this.timelineMarquee,n=i+a;for(const o of t.frames){var s=o.start,r=o.end;if(!(r<=i)){if(n<=s)break;return e===s?o:null}}}return null},Ke.getLayerIndex=function(t){var i=this.innerTimelineList.childNodes,a=i.length;for(let e=0;e<a;e++)if(i[e].layer===t)return e;return-1},Ke.getMotionListItems=function(e){e=He.animations[e]?.motions;if(!e)return[{name:N.get("common.none"),value:""}];"listItems"in e||Object.defineProperty(e,"listItems",{writable:!0,value:void 0});var t=[],i={};for(const s of e){var a,n=s.id;n in i||(i[n]=!0,a=M.getString(n)?.name??I.parseUnlinkedId(n),t.push({name:a,value:n}))}return 0===t.length&&t.push({name:N.get("common.none"),value:""}),t},Ke.getSpriteListItems=function(e){var t=He.animations[e]?.sprites;if(!t)return[{name:"No Image",value:""}];"listItems"in t||Object.defineProperty(t,"listItems",{writable:!0,value:void 0});let i=t.listItems;if(void 0===i){var a=t.length,n=Number.computeIndexDigits(a);(i=new Array(a+1))[0]={name:"No Image",value:""};for(let e=0;e<a;e++){var s=e.toString().padStart(n,"0"),r=t[e];i[e+1]={name:s+":"+r.name,value:r.id}}t.listItems=i}return i},Ke.updateCamera=function(e=this.centerX,t=this.centerY){var i=this.screen,a=window.devicePixelRatio,e=e*this.scaleX+this.outerWidth/2,t=t*this.scaleY+this.outerHeight/2;i.rawScrollLeft=Math.clamp(e-this.centerOffsetX,0,this.outerWidth-We.width)/a,i.rawScrollTop=Math.clamp(t-this.centerOffsetY,0,this.outerHeight-We.height)/a,i.scrollLeft=(e-(We.width>>1)+1e-4)/a,i.scrollTop=(t-(We.height>>1)+1e-4)/a},Ke.updateTransform=function(){var e=this.screen,t=window.devicePixelRatio,i=Math.roundTo(e.scrollLeft*t-(this.outerWidth>>1),4),a=Math.roundTo(e.scrollTop*t-(this.outerHeight>>1),4),n=i+We.width,s=a+We.height,i=(this.scrollLeft=i/this.scaleX,this.scrollTop=a/this.scaleY,this.scrollRight=n/this.scaleX,this.scrollBottom=s/this.scaleY,this.updateMatrix(),e.rawScrollLeft*t+this.centerOffsetX),a=e.rawScrollTop*t+this.centerOffsetY;this.centerX=Math.roundTo((i-this.outerWidth/2)/this.scaleX,4),this.centerY=Math.roundTo((a-this.outerHeight/2)/this.scaleY,4)},Ke.updateMatrix=function(){var e=this.matrix.reset().scale(this.scaleX,this.scaleY).translate(-this.scrollLeft,-this.scrollTop);this.mirror&&e.mirrorh()},Ke.updateRuler=function(){var{outerRuler:e,innerRuler:i}=this,e=e.clientWidth;if(0!==e){var a=Math.ceil((e+16)/80)+1,n=i.childNodes;let t=n.length;if(t!==a)if(t<a){let e=5*((i.start??0)+t);for(;t<a;){var s=document.createElement("box");s.addClass("timeline-number"),s.textContent=e.toString(),i.appendChild(s),e+=5,t++}}else for(;--t>=a;)n[t].remove()}},Ke.updateTimeline=function(){Ke.createTimelines(),Ke.updateTimelineLength(),Ke.updateMarquee(),Ke.updatePointerArea(),Ke.loadFrames(Ke.player.index,!0)},Ke.updateTimelineLength=function(){this.player.computeLength();var e=this.player.length,e=100*Math.floor(e/100+1);this.frameMax!==e&&(this.frameMax=e,this.innerTimelineList.style.width=this.innerPointerArea.style.width=16*e+"px")},Ke.updatePointerArea=function(){var e=this.outerTimelineList,t=this.outerPointerArea;0!==e.clientWidth&&(e.clientWidth<e.scrollWidth?t.addClass("has-horiz-scrollbar"):t.removeClass("has-horiz-scrollbar"),e.clientHeight<e.scrollHeight?t.addClass("has-vert-scrollbar"):t.removeClass("has-vert-scrollbar"))},Ke.updatePointer=function(){var e=Math.floor(this.player.index),t=this["pointer"];t.x!==e&&(t.x=e,t.style.left=16*e+"px")},Ke.updateCursor=function(e,t){var i=this["timelineCursor"];i.x===e&&i.y===t||(i.x=e,i.y=t,-1!==e?(i.style.left=16*e+"px",i.style.top=20*t+"px",i.show()):i.hide())},Ke.selectFrame=function(t,i,a){if(!t)return this.unselectMarquee();let n;var s=this.player["contexts"],r=s["count"];for(let e=0;e<r;e++){var o=s[e].layer;if(o.frames.includes(t)){n=o;break}}if(n&&(this.layerList.expandToItem(n),j.animSpriteFrame.target!==t)){var l,c,h,d=this.innerTimelineList.childNodes,u=d.length;for(let e=0;e<u;e++)d[e].layer===n&&(l=i??t.start,c=a??1,h=this.player.index,this.selectMarquee(l,e,c,l),this.scrollToMarquee(!1),h<l||l+c<=h)&&this.loadFrames(l)}},Ke.selectMarquee=function(e,t,i,a){this.stop();var n=this.innerTimelineList.childNodes,s=this.frameMax,r=n.length;0<=e&&e+i<=s&&0<=t&&t<r&&(s=n[t]["layer"],(r=this.timelineMarquee).layer===s&&r.x===e&&r.length===i||(r.layer=s,r.x=e,r.length=i,this.updateMarquee(),this.openFrame(),this.layerList.selectWithNoEvent(s)),void 0!==a)&&(r.origin=a)},Ke.unselectMarquee=function(e){var t=this.timelineMarquee;(void 0!==e?this.target===e:null!==t.layer)&&((t.layer=null)!==this.target&&(this.target=null,this.updateTargetContext(),this.requestRendering(),j.close()),t.x=-1,t.length=-1,t.origin=-1,this.updateMarquee())},Ke.updateMarquee=function(){var e=this.timelineMarquee,t=e["layer"];if(null!==t){var i,a,t=this.getLayerIndex(t);if(-1!==t)return{x:i,length:a}=e,e.y=t,e.style.left=16*i+"px",e.style.top=20*t+"px",e.style.width=16*a+"px",void e.show()}e.y=-1,e.hide()},Ke.scrollToMarquee=function(e){var t,i,a,n,{x:s,y:r,length:o,origin:l}=this.timelineMarquee;-1!==r&&(i=(t=this.outerTimelineList).scrollLeft,a=16*s+16*o-t.clientWidth,n=16*s,e=e&&s===l&&1<o?Math.max(Math.min(i,n),a):Math.min(Math.max(i,a),n),s=Math.clamp(t.scrollTop,20*r+20-t.clientHeight,20*r),t.scrollLeft!==e&&(t.scrollLeft=e),t.scrollTop!==s)&&(t.scrollTop=s)},Ke.updateMarqueeShift=function(e,t,i){var a=this.innerTimelineList.childNodes,n=this.timelineMarqueeShift;n.layer=a[t]?.layer??null,n.x!==e&&(n.x=e,n.style.left=16*e+"px"),n.y!==t&&(n.y=t,n.style.top=20*t+"px"),void 0!==i&&n.length!==i&&(n.length=i,n.style.width=16*i+"px")},Ke.selectFrameRelative=function(a){var n=this.timelineMarquee;if(-1!==n.y){let{x:e,y:t,length:i}=n;switch(a){case"left":e=1<i?e:e-1;break;case"up":t=Math.max(t-1,0);break;case"right":e=1<i?e+i-1:e+1;break;case"down":var s=this.innerTimelineList.childNodes.length;t=Math.min(t+1,s-1)}this.selectMarquee(e,t,1,e),this.scrollToMarquee(!1),this.loadFrames(e)}},Ke.selectFrameAtHomeEnd=function(n){var s=this.timelineMarquee;if(-1!==s.y){let{layer:e,x:t,y:i,length:a}=s;var r,o=e.frames,l=o.length;switch(n){case"home":t=0!==l&&(r=o[0].start,t!==r||1!==a)?r:0;break;case"end":t=0!==l&&(r=o[l-1].end-1,t!==r||1!==a)?r:this.frameMax-1}this.selectMarquee(t,i,1,t),this.scrollToMarquee(!1),this.loadFrames(t)}},Ke.selectAllFramesOfKey=function(){var e=this.timelineMarquee;if(-1!==e.y){var{layer:e,y:t,origin:i}=e;for(const s of e.frames){var a=s.start,n=s.end;if(!(n<=i)){if(i<a)break;return this.selectMarquee(a,t,n-a,i),void this.scrollToMarquee(!1)}}}},Ke.multiSelectFramesRelative=function(n){var s=this.timelineMarquee;if(-1!==s.y){let{x:e,y:t,length:i,origin:a}=s;var r=e===a;switch(n){case"left":r&&1<i?i--:(e--,i++);break;case"right":r?i++:(e++,i--)}this.selectMarquee(e,t,i),this.scrollToMarquee(!0),this.loadFrames(r?e+i-1:e)}},Ke.multiSelectFramesToHomeEnd=function(s){var r=this.timelineMarquee;if(-1!==r.y){let{layer:e,x:t,y:i,length:a,origin:n}=r;var o,l=e.frames,c=l.length;switch(s){case"home":t=0!==c&&(o=l[0].start,(t=t===n?t+a-1:t)!==o)?o:0;break;case"end":t=0!==c&&(o=l[c-1].end-1,(t=t===n?t+a-1:t)!==o)?o:this.frameMax-1}r=Math.min(t,n),s=Math.abs(t-n)+1;this.selectMarquee(r,i,s,n),this.scrollToMarquee(!0),this.loadFrames(t)}},Ke.openFrame=function(){var{layer:e,x:t}=this.timelineMarquee;for(const n of e.frames){var i=n.start,a=n.end;if(!(a<=t)){if(t<i)break;return void(this.target!==n&&(this.target=n,this.updateTargetContext(),this.requestRendering(),a=this.inspectorTypeMap[e.class],j.open(a,n)))}}null!==this.target&&(this.target=null,this.updateTargetContext(),this.requestRendering(),j.close())},Ke.loadTextures=function(){if("closed"!==this.state){const{floor:r,max:o}=Math,l=this.player;var e=l.textures;const c=l.textures={};for(const h of this.sprites){const d=h.id;var t=h.image,i=e[d];const{hframes:u,vframes:p}=h;if(i instanceof $e&&i.base.guid===t){var a=i["base"],n=r(o(a.width/u,1)),a=r(o(a.height/p,1));i.hframes=u,i.vframes=p,i.width=n,i.height=a,i.offsetX=-n/2,i.offsetY=-a/2,c[d]=i,this.requestRendering()}else if(t){const m=new $e(t);m.on("load",()=>{var e,t;l.textures===c?(t=m["base"],e=r(o(t.width/u,1)),t=r(o(t.height/p,1)),m.hframes=u,m.vframes=p,m.width=e,m.height=t,m.offsetX=-e/2,m.offsetY=-t/2,c[d]=m,this.requestRendering()):m.destroy()})}}for(const g of Object.keys(e)){var s=e[g];s!==c[g]&&s instanceof $e&&s.destroy()}}},Ke.loadFrames=function(e,t=!1){var i=this.player,a=i.length,e=Math.min(Math.max(e,0),a-1);i.index===e&&!t||(i.index=e,this.updateFrameContexts(),this.updateTargetContext(),this.updatePointer(),this.requestRendering())},Ke.drawBackground=function(){var e=We;e.clearColor(...this.background.getGLRGBA()),e.clear(e.COLOR_BUFFER_BIT)},Ke.drawOnionskins=function(){var e,t;this.showOnionskin&&(We.alpha=.25,{prev:e,next:t}=this.player.onionskin,this.drawSpriteLayers(e),this.drawSpriteLayers(t),We.alpha=1)},Ke.drawSpriteLayers=function(t=this.player.contexts){var i=this["player"],a=t["count"],n=We;let s=!1;for(let e=0;e<a;e++){var r,o=t[e],{layer:l,frame:c}=o;"sprite"!==l.class||l.hidden||null===c||(c=l.sprite,(l=i.textures[c])instanceof $e&&(s||(s=!0,c=n.spriteProgram.use(),r=n.matrix.project(n.flip,n.width,n.height).multiply(Ke.matrix),n.batchRenderer.setAttrSize(8),n.bindVertexArray(c.vao),n.uniformMatrix3fv(c.u_Matrix,!1,r),n.uniform4f(c.u_Tint,0,0,0,0)),i.drawSprite(o,l,"raw")))}n.batchRenderer.draw()},Ke.drawEmitters=function(){if(this.showMark){var i=We,a=i.arrays[0].float32,n=i.matrix,t=this.player["contexts"],s=t["count"];for(let e=0;e<s;e++){var r=t[e],{layer:o,frame:l}=r;if("particle"===o.class&&!o.hidden&&null!==l){n.set(Ke.matrix).multiply(r.matrix);let t=0;var c=n[6],h=n[7],o=Math.min(this.scale,1),d=6*o,u=20*o,p=2*Math.PI/8;a[t++]=c,a[t++]=h;for(let e=0;e<8;e++){var m=e*p-Math.PI/2,g=m+p/2;a[t]=c+u*Math.cos(m),a[t+1]=h+u*Math.sin(m),a[t+2]=c+d*Math.cos(g),a[t+3]=h+d*Math.sin(g),t+=4}a[t++]=a[2],a[t++]=a[3];var f=i.graphicProgram.use();switch(n.project(i.flip,i.width,i.height),i.bindVertexArray(f.vao.a10),i.uniformMatrix3fv(f.u_Matrix,!1,n),i.bufferData(i.ARRAY_BUFFER,a,i.STREAM_DRAW,0,t),l){case this.target:i.vertexAttrib4f(f.a_Color,0,1,1,1);break;case this.hover:i.vertexAttrib4f(f.a_Color,.75,1,1,1);break;default:i.vertexAttrib4f(f.a_Color,.75,1,.75,1)}i.drawArrays(i.TRIANGLE_FAN,0,t/2)}}}},Ke.emitParticles=function(t){var e=this["player"],i=e["contexts"],a=i["count"];for(let e=0;e<a;e++){var n=i[e],s=n["layer"];if("particle"===s.class&&!s.hidden){var{frame:r,emitter:o}=n;if(null!==r&&void 0!==o){switch(s.angle){case"default":o.angle=0;break;case"inherit":var l=n["matrix"],c=l[0],l=l[1];o.angle=Math.atan2(l,c)}o.emitParticles(t)}}}},Ke.updateParticles=function(e){this.particleUpdating=!1;var t=this.player["emitters"];let i=t.length;for(;0<=--i;){var a=t[i],n=a.updateParticles(e);!1===n&&a.disabled&&(a.destroy(),t.splice(i,1)),this.particleUpdating||=n}},Ke.drawParticles=function(){if(this.particleUpdating){var e=this.player["emitters"];for(const t of e)t.draw()}},Ke.drawCoordinateAxes=function(){var e=We,t=e.arrays[0].float32,i=e.matrix.set(Ke.matrix),a=-1e4/this.scaleX,n=-1e4/this.scaleY,s=1e4/this.scaleX,r=1e4/this.scaleY,o=i[0],l=i[1],c=i[3],h=i[4],d=i[6],u=i[7],p=o*a+d,a=l*a+u,o=o*s+d,l=l*s+u,s=c*n+d,n=h*n+u,c=c*r+d,d=h*r+u,h=(t[0]=p,t[1]=a+.5,t[2]=0,t[3]=o,t[4]=l+.5,t[5]=Math.dist(p,a,o,l),t[6]=s+.5,t[7]=n,t[8]=0,t[9]=c+.5,t[10]=d,t[11]=Math.dist(s,n,c,d),i.project(e.flip,e.width,e.height),e.alpha=1,e.blend="normal",e.dashedLineProgram.use());e.bindVertexArray(h.vao),e.uniformMatrix3fv(h.u_Matrix,!1,i),e.uniform4f(h.u_Color,.5,0,1,1),e.bufferData(e.ARRAY_BUFFER,t,e.STREAM_DRAW,0,12),e.drawArrays(e.LINES,0,4)},Ke.drawJointNodes=function(){if(this.showMark){var t=We,a=t.arrays[0].float32,n=t.matrix,i=this.player["contexts"],s=i["count"];for(let e=0;e<s;e++){var r=i[e],{layer:o,frame:l}=r;if("joint"===o.class&&!o.hidden&&null!==l){n.set(Ke.matrix).multiply(r.matrix);let i=0;var c=n[6],h=n[7],o=Math.min(this.scale,1),d=5.5*o,u=1.5*o,p=2*Math.PI/40;for(let e=0,t=1;e<40;e++,t=-t){var m=e*p,g=t*u;a[i]=c+(d+g)*Math.cos(m),a[i+1]=h+(d+g)*Math.sin(m),i+=2}a[i]=a[0],a[i+1]=a[1],a[i+2]=a[2],a[i+3]=a[3],i+=4;var f=t.graphicProgram.use();switch(n.project(t.flip,t.width,t.height),t.bindVertexArray(f.vao.a10),t.uniformMatrix3fv(f.u_Matrix,!1,n),t.bufferData(t.ARRAY_BUFFER,a,t.STREAM_DRAW,0,i),l){case this.target:t.vertexAttrib4f(f.a_Color,0,1,1,1);break;case this.hover:t.vertexAttrib4f(f.a_Color,.75,1,1,1);break;default:t.vertexAttrib4f(f.a_Color,1,1,1,1)}t.drawArrays(t.TRIANGLE_STRIP,0,i/2)}}}},Ke.drawJointArrows=function(){if(this.showMark){var t=We,i=t.arrays[0].float32,a=t.matrix,n=this.player["contexts"],s=n["count"];for(let e=0;e<s;e++){var r=n[e],{layer:o,frame:l,parent:c}=r;if("joint"===o.class&&null!==l&&null!==c&&null!==c.frame&&!c.layer.hidden){a.set(Ke.matrix).multiply(c.matrix);var o=a[6],l=a[7],r=(a.set(Ke.matrix).multiply(r.matrix),a[6]),h=a[7];if(o!==r||l!==h){var d=Math.min(this.scale,1),u=5.5*d,p=.5*d,d=9*d,m=Math.atan2(h-l,r-o),g=m+Math.PI/2,f=m-Math.PI/2,v=m+Math.PI/4,b=m-Math.PI/4,o=o+u*Math.cos(m),l=l+u*Math.sin(m),y=(i[0]=o,i[1]=l,i[2]=o+d*Math.cos(b),i[3]=l+d*Math.sin(b),i[4]=r+p*Math.cos(f),i[5]=h+p*Math.sin(f),i[6]=r+p*Math.cos(g),i[7]=h+p*Math.sin(g),i[8]=o+d*Math.cos(v),i[9]=l+d*Math.sin(v),t.graphicProgram.use());switch(a.project(t.flip,t.width,t.height),t.bindVertexArray(y.vao.a10),t.uniformMatrix3fv(y.u_Matrix,!1,a),t.bufferData(t.ARRAY_BUFFER,i,t.STREAM_DRAW,0,10),c.frame){case this.target:t.vertexAttrib4f(y.a_Color,0,1,1,1);break;case this.hover:t.vertexAttrib4f(y.a_Color,.75,1,1,1);break;default:t.vertexAttrib4f(y.a_Color,1,1,1,1)}t.drawArrays(t.TRIANGLE_FAN,0,5)}}}}},Ke.drawJointSpinner=function(){var a=this.targetContext,n=this.target;if(null!==n&&null!==a&&"joint"===a.layer.class&&!a.layer.hidden){var s=We,r=s.arrays[0].float32,o=s.matrix.set(Ke.matrix).multiply(a.matrix);let i=0;var l=o[6],c=o[7],h=Math.min(this.scale,1),d=12*h,u=2*h,p=2*Math.PI/40;for(let e=0,t=1;e<40;e++,t=-t){var m=e*p,g=t*u;r[i]=l+(d+g)*Math.cos(m),r[i+1]=c+(d+g)*Math.sin(m),i+=2}r[i]=r[0],r[i+1]=r[1],r[i+2]=r[2],r[i+3]=r[3];var f=i+=4,v=16*h,h=20*h;let e=n.rotation,t=a;for(;t=t.parent;){var b=t.frame;null!==b&&(e+=b.rotation)}var n=Math.radians(e),y=n-Math.PI/12,w=n+Math.PI/12;r[i]=l+h*Math.cos(n),r[i+1]=c+h*Math.sin(n),i+=2;for(let e=0;e<=5;e++){var x=e/5,x=y*(1-x)+w*x;r[i]=l+v*Math.cos(x),r[i+1]=c+v*Math.sin(x),i+=2}a=s.graphicProgram.use();o.project(s.flip,s.width,s.height),s.bindVertexArray(a.vao.a10),s.uniformMatrix3fv(a.u_Matrix,!1,o),s.bufferData(s.ARRAY_BUFFER,r,s.STREAM_DRAW,0,i),s.vertexAttrib4f(a.a_Color,1,0,0,1),s.drawArrays(s.TRIANGLE_STRIP,0,f/2),s.vertexAttrib4f(a.a_Color,1,0,0,1),s.drawArrays(s.TRIANGLE_FAN,f/2,(i-f)/2)}},Ke.drawHoverWireframe=function(){var t=this.hover;if(null!==t&&t!==this.target){var i=this.player["contexts"],a=i["count"];for(let e=0;e<a;e++){var n=i[e];if(n.frame===t&&!n.layer.hidden){switch(n.layer.class){case"joint":break;case"sprite":this.drawSpriteWireframe(n,4294967295);break;case"particle":this.drawEmitterWireframe(n,4294967295)}return}}}},Ke.drawTargetWireframe=function(){var e=this.targetContext;if(null!==e&&null!==this.target)switch(e.layer.class){case"joint":break;case"sprite":this.drawSpriteWireframe(e,4290838272);break;case"particle":this.drawEmitterWireframe(e,4290838272)}},Ke.drawSpriteWireframe=function(e,t){var i,a,n,s,r,o,l,c,h,d,u,p,m,g,f,v,b,y,w=e.layer.sprite,w=this.player.textures[w];w&&(a=(i=We).arrays[0].float32,n=i.arrays[0].uint32,e=i.matrix.set(Ke.matrix).multiply(e.matrix),g=w.offsetX,l=w.offsetY,h=g+w.width,w=l+w.height,r=e[0],y=e[1],o=e[3],p=e[4],s=r*g+o*l+(b=e[6]),u=y*g+p*l+(f=e[7]),m=r*g+o*w+b,g=y*g+p*w+f,v=r*h+o*w+b,w=y*h+p*w+f,r=r*h+o*l+b,o=y*h+p*l+f,b=Math.atan2(u-g,s-m),y=Math.atan2(g-w,m-v),h=Math.atan2(w-o,v-r),p=Math.atan2(o-u,r-s),l=.5*Math.cos(b),f=.5*Math.sin(b),b=.5*Math.cos(y),y=.5*Math.sin(y),c=.5*Math.cos(h),h=.5*Math.sin(h),d=.5*Math.cos(p),p=u+(u=.5*Math.sin(p))-f,m=m+l-b,g=g+f-y,f=v+b-c,v=w+y-h,b=r+c-d,w=o+h-u,a[0]=s+d-l,a[1]=p,n[2]=t,a[3]=m,a[4]=g,n[5]=t,a[6]=f,a[7]=v,n[8]=t,a[9]=b,a[10]=w,n[11]=t,e.project(i.flip,i.width,i.height),i.alpha=1,i.blend="normal",y=i.graphicProgram.use(),i.bindVertexArray(y.vao),i.uniformMatrix3fv(y.u_Matrix,!1,e),i.bufferData(i.ARRAY_BUFFER,a,i.STREAM_DRAW,0,12),i.drawArrays(i.LINE_LOOP,0,4))},Ke.drawEmitterWireframe=function(e,i){var t=e.emitter;if(t){var a,n=We,s=n.arrays[0].float32,r=n.arrays[0].uint32,o=n.matrix.set(Ke.matrix).multiply(e.matrix),l=o[0],c=o[1],h=o[3],d=o[4],u=o[6],p=o[7];for({area:a}of t.data.layers){switch(a.type){case"point":case"edge":continue}let t=0;switch(a.type){case"rectangle":var m=-.5*a.width,g=-.5*a.height,f=.5*a.width,v=.5*a.height,b=l*m+h*g+u,y=c*m+d*g+p,w=l*m+h*v+u,m=c*m+d*v+p,x=l*f+h*v+u,v=c*f+d*v+p,k=l*f+h*g+u,f=c*f+d*g+p,g=Math.atan2(y-m,b-w),T=Math.atan2(m-v,w-x),I=Math.atan2(v-f,x-k),C=Math.atan2(f-y,k-b),E=.5*Math.cos(g),g=.5*Math.sin(g),M=.5*Math.cos(T),T=.5*Math.sin(T),S=.5*Math.cos(I),I=.5*Math.sin(I),A=.5*Math.cos(C),C=.5*Math.sin(C),y=y+C-g,w=w+E-M,m=m+g-T,g=x+M-S,x=v+T-I,M=k+S-A,v=f+I-C;s[0]=b+A-E,s[1]=y,r[2]=i,s[3]=w,s[4]=m,r[5]=i,s[6]=g,s[7]=x,r[8]=i,s[9]=M,s[10]=v,r[11]=i,t=12;break;case"circle":var P=a.radius,L=2*Math.PI/100;for(let e=0;e<100;e++){var R=e*L,F=P*Math.cos(R),R=P*Math.sin(R);s[t]=l*F+h*R+u,s[t+1]=c*F+d*R+p,r[t+2]=i,t+=3}}n.alpha=1,n.blend="normal";var z=n.graphicProgram.use();o.project(n.flip,n.width,n.height),n.bindVertexArray(z.vao),n.uniformMatrix3fv(z.u_Matrix,!1,o),n.bufferData(n.ARRAY_BUFFER,s,n.STREAM_DRAW,0,t),n.drawArrays(n.LINE_LOOP,0,t/3)}}},Ke.drawTargetAnchor=function(){var e,t,i,a,n,s,r=this.targetContext;null!==r&&null!==this.target&&(t=(e=We).arrays[0].float32,i=e.arrays[0].uint32,s=(r=e.matrix.set(Ke.matrix).multiply(r.matrix))[6],a=r[7],n=4278190335,t[0]=s+.5-8,t[1]=a+.5,i[2]=n,t[3]=s+.5+9,t[4]=a+.5,i[5]=n,t[6]=s+.5,t[7]=a+.5-8,i[8]=n,t[9]=s+.5,t[10]=a+.5+9,i[11]=n,r.project(e.flip,e.width,e.height),e.alpha=1,e.blend="normal",s=e.graphicProgram.use(),e.bindVertexArray(s.vao),e.uniformMatrix3fv(s.u_Matrix,!1,r),e.bufferData(e.ARRAY_BUFFER,t,e.STREAM_DRAW,0,12),e.drawArrays(e.LINES,0,4))},Ke.drawSpriteControlPoints=function(){var e=this.targetContext,i=this.target,a=Y.controlPointTexture;if(e&&i&&a&&this.updateControlPoints(e)){var n=4/this.scale,i=We,s=i.arrays[0].float32;let t=0;var r=this.controlPoints["rectList"],o=r.length;for(let e=4;e<o;e++){var{x:l,y:c}=r[e],h=l-n,d=c-n,l=l+n,c=c+n;s[t]=h,s[t+1]=d,s[t+2]=0,s[t+3]=0,s[t+4]=h,s[t+5]=c,s[t+6]=0,s[t+7]=1,s[t+8]=l,s[t+9]=c,s[t+10]=1,s[t+11]=1,s[t+12]=l,s[t+13]=d,s[t+14]=1,s[t+15]=0,t+=16}i.blend="normal";var e=i.imageProgram.use(),u=i.matrix.project(i.flip,i.width,i.height).multiply(Ke.matrix);i.bindVertexArray(e.vao),i.uniformMatrix3fv(e.u_Matrix,!1,u),i.uniform1i(e.u_LightMode,0),i.uniform1i(e.u_ColorMode,0),i.uniform4f(e.u_Tint,0,0,0,0),i.bufferData(i.ARRAY_BUFFER,s,i.STREAM_DRAW,0,t),i.bindTexture(i.TEXTURE_2D,a.base.glTexture),i.drawElements(i.TRIANGLES,t/16*6,i.UNSIGNED_INT,0)}},Ke.createTimelines=function(){const c=e=>{for(const t of e){let i=t["timeline"];void 0===i&&((i=document.createElement("box")).addClass("timeline-frames"),i.layer=t,Object.defineProperty(t,"timeline",{configurable:!0,value:i})),Ke.innerTimelineList.appendChild(i.clear());var a=t.frames,n=a.length;for(let t=0;t<n;t++){var s=a[t],r=s.start,o=s.end-r,l=""!==s.easingId;let e=s["key"];void 0===e&&((e=document.createElement("box")).addClass("timeline-key"),Object.defineProperty(s,"key",{configurable:!0,value:e})),e.start!==r&&(e.start=r,e.style.left=16*r+"px"),e.length!==o&&(1!=(e.length=o)?(e.addClass("long"),e.style.width=16*o+"px"):(e.removeClass("long"),e.style.width="16px")),e.easing!==l&&((e.easing=l)?e.addClass("easing"):e.removeClass("easing")),i.appendChild(e)}t.expanded&&c(t.children)}};return function(){this.innerTimelineList.clear(),c(this.layers)}}(),Ke.getFrame=function(t,i){var a=t.length;for(let e=0;e<a;e++){var n=t[e],s=n.start,r=n.end;if(!(r<=i)){if(i<s)break;return n}}return null},Ke.sortFrames=function(i){let a=0;var e=i.length;for(let t=0;t<e;t++){let e=i[t];var n=e.start;n<a&&((e=this.cloneFrame(i,t)).start=a,e.end+=a-n),a=e.end}},Ke.shiftFrames=function(t,i,a){var n=t.length;for(let e=i;e<n;e++){var s=this.cloneFrame(t,e);s.start+=a,s.end+=a}},Ke.saveFrames=function(e,t,i=t){var a=[];for(const s of e){var n=s.frames.slice();a.push({layer:s,frames:n})}this.planToSave(),this.history.save({type:"animation-frames-change",motion:Ke.motion,direction:Ke.direction,changes:a,sMarquee:t,dMarquee:i})},Ke.cloneFrame=function(e,t){var i=e[t],e=e[t]=Object.clone(i);return Object.defineProperty(e,"key",{configurable:!0,value:i.key})},Ke.insertFrame=function(){var t=this.timelineMarquee;if(-1!==t.y){var{layer:t,x:i,length:a}=t,n=i+a,s=t.frames,r=s.length;this.saveFrames([t],{layer:t,x:i,length:a});for(let t=0;t<r;t++){var o=s[t],l=o.start,c=o.end;if(!(c<=i)){if(l<i){const e=Object.clone(o);e.start=i,e.end=Math.max(n,c),this.cloneFrame(s,t).end=i,s.splice(t+1,0,e)}else if(i===l){c=s[t-1]??o;const e=Object.clone(c);e.start=i,e.end=n,s.splice(t,0,e)}else{0!==t&&(this.cloneFrame(s,t-1).end=i);const e=Object.clone(o);e.start=i,e.end=n,s.splice(t,0,e)}return this.sortFrames(s),this.updateTimeline(),void this.openFrame()}}a=s[r-1];let e=a;e=a?Object.clone(a):(t=this.inspectorTypeMap[t.class],j[t].create()),a&&a.end!==i&&(this.cloneFrame(s,r-1).end=i),e.start=i,e.end=n,s.push(e),this.updateTimeline(),this.loadFrames(i),this.openFrame()}},Ke.extendFrame=function(){var e=this.timelineMarquee;if(-1!==e.y&&e.isExtendable()){var{layer:e,x:t,length:i}=e,a=t+i,n=e.frames,s=n.length;this.saveFrames([e],{layer:e,x:t,length:i});for(let e=0;e<s;e++){var r=n[e],o=r.start,r=r.end;if(!(r<=t)){if(o<=t)this.cloneFrame(n,e).end+=i;else{if(0===e)return;this.cloneFrame(n,e-1).end=a}return this.sortFrames(n),this.updateTimeline(),void this.openFrame()}}0!==s&&(this.cloneFrame(n,s-1).end=a,this.updateTimeline(),this.openFrame())}},Ke.deleteFrame=function(t=!1){var i=this.timelineMarquee;if(-1!==i.y&&(t||i.isSelected())){var{layer:i,x:a,length:n}=i,s=a+n,r=i.frames;let e=r.length;if(this.saveFrames([i],{layer:i,x:a,length:n}),t)e:{for(;0<=--e;){var o=r[e],l=o.start;if(l<s){a<=l?(l=o.end,o=Math.max(l-s,0),this.shiftFrames(r,++e,-n-o)):this.shiftFrames(r,++e,-n);break e}}this.shiftFrames(r,0,-n)}for(;0<=--e;){var c=r[e],h=c.start,c=c.end;if(!(s<=h)){if(c<=a)break;a<=h?r.splice(e,1):this.cloneFrame(r,e).end=a+Math.max(c-s,0)}}this.updateTimeline(),this.openFrame()}},Ke.copyFrame=function(a=!1){var n=this.timelineMarquee;if(-1!==n.y){let{layer:e,x:t,length:i}=n;var s=[],r=t+i,o=e.frames,l=o.length;for(let e=0;e<l;e++){var c=o[e],h=c.start,d=c.end;if(!(d<=t)){if(r<=h)break;s.push(Object.clone(c))}}if(0!==s.length){for(const u of s)u.start-=t,u.end-=t;n=s[s.length-1],n=(0<=n.start?i=Math.max(n.end,i):n.end=Math.min(n.end,i),s[0]),n=(n.start<0&&(n.start=0),{copies:s,length:i});if(a)return n;Clipboard.write("yami.animFrame."+e.class,n)}}},Ke.pasteFrame=function(e,t){var{layer:t,x:i,y:a,length:n}=t??this.timelineMarquee;if((e=e||Clipboard.read("yami.animFrame."+t.class))&&-1!==a){var{copies:s,length:e}=e;this.selectMarquee(i,a,e,i),this.saveFrames([t],{layer:t,x:i,length:n},{layer:t,x:i,length:e});for(const h of s)h.start+=i,h.end+=i;var r=t.frames,o=r.length;for(let e=0;e<o;e++){var l=r[e],c=l.start,l=l.end;if(!(l<=i))return c<i?(i<l&&(this.cloneFrame(r,e).end=i),r.splice(e+1,0,...s)):r.splice(e,0,...s),this.sortFrames(r),this.updateTimeline(),void this.openFrame()}r.push(...s),this.updateTimeline(),this.loadFrames(i),this.openFrame()}},Ke.selectAllFrames=function(){var e,t,i,a=this.timelineMarquee;-1!==a.y&&({layer:a,y:e}=a,a=a.frames,t=a.length,0!==t)&&(i=a[0].start,a=a[t-1].end,this.selectMarquee(i,e,a-i,i))},Ke.dragAndDropFrame=function(){var e,t,{layer:i,x:a,y:n,length:s}=this.timelineMarquee,{layer:r,x:o,y:l}=this.timelineMarqueeShift;(a!==o||n!==l&&i.class===r.class)&&(n=this.copyFrame(!0))&&({updateTimeline:l,openFrame:e,saveFrames:t}=this,a={layer:i,x:a,length:s},s={layer:r,x:o,length:0},(i=[i]).append(r),this.saveFrames(i,a,s),this.updateTimeline=Function.empty,this.openFrame=Function.empty,this.saveFrames=Function.empty,this.deleteFrame(),this.pasteFrame(n,this.timelineMarqueeShift),this.updateTimeline=l,this.openFrame=e,this.saveFrames=t,this.player.index=o,this.updateTimeline(),this.openFrame(),s.length=this.timelineMarquee.length)},Ke.adjustMarquee=function(){var s=this.timelineMarquee;if(-1!==s.y){let{layer:e,x:t,y:i,length:a}=s,n=!1;var r=t+a,o=e.frames,l=o.length;for(let e=0;e<l;e++){var c=o[e],h=c.start,c=c.end;if(!(t>=c)){if(r<=h)break;t!==h&&(a+=t-h,t=h,n=!0);break}}for(let e=l-1;0<=e;e--){var d=o[e],u=d.start,d=d.end;if(!(r<=u)){if(t>=d)break;d<r&&(a-=r-d,n=!0);break}}n&&this.selectMarquee(t,i,a,t)}},Ke.shiftSelectedFrames=function(i){var a=this.timelineMarquee;if(-1!==a.y){this.adjustMarquee();var n,s,r,o,{layer:l,x:a,y:c,length:h}=a,d=this.innerTimelineList.childNodes,u=this.frameMax,p=d.length;let e=a,t=c;switch(i){case"left":var m=l.frames,m=this.getFrame(m,e-1);e=m?m.start:e-1;break;case"up":for(;0<=--t;)if(d[t].layer.class===l.class)break;break;case"right":e++;break;case"down":for(;++t<p;)if(d[t].layer.class===l.class)break}0<=e&&e<u&&0<=t&&t<p&&(c=this.copyFrame(!0))&&({updateTimeline:i,openFrame:u,saveFrames:n}=this,r={layer:s=d[t].layer,x:e,y:t},a={layer:l,x:a,length:h},h={layer:s,x:e,length:0},(o=[l]).append(s),this.saveFrames(o,a,h),this.updateTimeline=Function.empty,this.openFrame=Function.empty,this.saveFrames=Function.empty,this.deleteFrame(),this.pasteFrame(c,r),this.updateTimeline=i,this.openFrame=u,this.saveFrames=n,this.player.index=e,this.updateTimeline(),this.openFrame(),this.scrollToMarquee(!1),h.length=this.timelineMarquee.length)}},Ke.selectControlPoint=function(t,i){var e=this.target,a=this.targetContext;if(null!==e&&null!==a){var n=this.controlPoints;switch(a.layer.class){case"joint":var s=10/Math.max(this.scale,1);if(e===this.selectObject(t,i)){var r=a.matrix[6],o=a.matrix[7];if(Math.dist(r,o,t,i)>s)return n.jointRotate}break;case"particle":if(!a.emitter?.hasArea)return null;case"sprite":if(this.controlPointVisible){var l=6/this.scale,c=n["rectList"];for(let e=c.length-1;0<=e;e--){var h=c[e],d=h.x-l,u=h.x+l,p=h.y-l,m=h.y+l;if(d<=t&&t<u&&p<=i&&i<m)return h}}}}return null},Ke.selectObject=function(i,a){var n=this.player["contexts"],s=n.count-1;let r=null,o=0;if(this.showMark&&null===r){var t=this.targetContext,l=16/Math.max(this.scale,1);for(let e=s;0<=e;e--){var c,h=n[e],d=h.frame,u=h.layer;null===d||"joint"!==u.class||u.hidden||u.locked||(u=h.matrix[6],c=h.matrix[7],(u=Math.dist(u,c,i,a))<=l&&(c=t===h?1/0:l-u,null===r||o<c)&&(r=d,o=c))}}if(this.showMark&&null===r){var p=32/Math.max(this.scale,1);for(let e=s;0<=e;e--){var m=n[e],g=m.frame,f=m.layer;null===g||"particle"!==f.class||f.hidden||f.locked||(f=m.matrix[6],m=m.matrix[7],(f=Math.dist(f,m,i,a))<=p&&(m=p-f,null===r||o<m)&&(r=g,o=m))}}if(this.showMark&&null===r){var v=this.targetContext,b=12/Math.max(this.scale,1);for(let t=s;0<=t;t--){var y,w,x,k,T,I,C=n[t];if(null!==C.frame){let e=C["parent"];for(;null!==e;){if(null!==e.frame){(e.layer.hidden||e.layer.locked)&&(e=null);break}e=e.parent}null!==e&&(w=e.matrix[6],x=e.matrix[7],T=C.matrix[6],C=C.matrix[7],4<(y=Math.dist(w,x,T,C))&&(C=Math.atan2(C-x,T-w),k=(T=i-w)*(w=Math.cos(-C))-(x=a-x)*(C=Math.sin(-C)),T=Math.abs(T*C+x*w),C=b/2,0<=k)&&k<y&&T<=C&&(I=v===e?1/0:(C-T)*(1-k/y)+t,null===r||o<I))&&(r=e.frame,o=I)}}}if(null===r)for(let e=s;0<=e;e--){var E=n[e],M=E.frame,S=E.layer;if(null!==M&&!S.hidden&&!S.locked&&this.isPointInFrame(E,i,a)){r=M;break}}return r},Ke.isPointInFrame=function(e,t,i){var a,n,s,r,o,l,c,h,d,u,p,m,g=e.layer.sprite,g=this.player.textures[g];return!!g&&(e=We.matrix.set(e.matrix),a=g.offsetX,m=g.offsetY,h=a+g.width,g=m+g.height,n=e[0],o=e[1],s=e[3],u=e[4],p=(l=n*h+s*g+(r=e[6])-t)*(d=o*h+u*m+(e=e[7])-i)-(c=o*h+u*g+e-i)*(h=n*h+s*m+r-t),m=h*(h=o*a+u*m+e-i)-d*(d=n*a+s*m+r-t),0<=(u=d*(d=o*a+u*g+e-i)-h*(o=n*a+s*g+r-t))*(e=o*c-d*l))&&0<=e*p&&0<=p*m&&0<=m*u},Ke.getAnimationRange=function(){const a=Ke.timelineMarquee,n={start:0,end:0};return function(){var e,t,i=this.player.length;return-1!==a.y?({x:e,length:t}=a,n.start=e<i-1?e:0,n.end=1===t?i:Math.min(e+t,i)):(n.start=0,n.end=i),n}}(),Ke.requestRefreshingList=function(){if("open"===this.state){const e=this.list;e.refreshing||(e.refreshing=!0,Promise.resolve().then(()=>{e.refreshing=!1,e.refresh()}))}},Ke.requestAnimation=function(){"open"===this.state&&f.appendUpdater("stageAnimation",this.updateAnimation)},Ke.updateAnimation=function(t){if(t*=Ke.speed,Ke.playing){var{start:i,end:a}=Ke.getAnimationRange(),n=t/Ke.Player.step;let e=Math.max(Ke.animIndex+n,i);if(e>=a){if(!Ke.loop)return Ke.animIndex=e,void Ke.stop();for(;(e+=i-a)>=a;);}Ke.animIndex=e,Ke.loadFrames(e),Ke.emitParticles(t)}Ke.updateParticles(t),Ke.playing||Ke.particleUpdating?Ke.requestRendering():Ke.stopAnimation()},Ke.stopAnimation=function(){f.removeUpdater("stageAnimation",this.updateAnimation)},Ke.requestRendering=function(){"open"===this.state&&f.appendUpdater("stageRendering",this.renderingFunction)},Ke.renderingFunction=function(){We.width*We.height!=0&&(Ke.drawBackground(),null!==Ke.layers)&&(Ke.drawOnionskins(),Ke.drawSpriteLayers(),Ke.drawParticles(),Ke.drawCoordinateAxes(),Ke.drawEmitters(),Ke.drawJointNodes(),Ke.drawJointArrows(),Ke.drawJointSpinner(),Ke.drawHoverWireframe(),Ke.drawTargetWireframe(),Ke.drawTargetAnchor(),Ke.drawSpriteControlPoints())},Ke.stopRendering=function(){f.removeUpdater("stageRendering",this.renderingFunction)},Ke.switchMark=function(){const t=_("#animation-switch-mark");return function(e=!this.showMark){e?t.addClass("selected"):t.removeClass("selected"),this.showMark=e,this.requestRendering()}}(),Ke.switchOnionskin=function(){const a=_("#animation-switch-onionskin");return function(e=!this.showOnionskin){var t,i;this.showOnionskin=e,this.requestRendering(),e?(a.addClass("selected"),"open"===this.state&&({prev:t,next:i}=(e=this.player).onionskin,e.loadContexts(t),e.loadContexts(i),this.updateFrameContexts())):a.removeClass("selected")}}(),Ke.switchMirror=function(){const t=_("#animation-switch-mirror");return function(e=!this.mirror){e?t.addClass("selected"):t.removeClass("selected"),this.mirror=e,this.requestRendering(),"open"===this.state&&this.updateMatrix()}}(),Ke.switchSettings=function(){j.fileAnimation.button.hasClass("selected")?j.close():j.open("fileAnimation",Ke)},Ke.switchLoop=function(){const t=_("#animation-timeline-loop");return function(e=!this.loop){e?t.addClass("selected"):t.removeClass("selected"),this.loop=e,this.showOnionskin&&"open"===this.state&&(this.updateFrameContexts(),this.requestRendering())}}(),Ke.planToSave=function(){R.planToSave(this.meta)},Ke.saveToConfig=function(e){e.colors.animationBackground=this.background.hex},Ke.loadFromConfig=function(e){this.background=new a(e.colors.animationBackground,()=>this.requestRendering())},Ke.saveToProject=function(e){e=e.animation;e.mark=this.showMark??e.mark,e.onionskin=this.showOnionskin??e.onionskin,e.mirror=this.mirror??e.mirror,e.loop=this.loop??e.loop,e.speed=this.speed??e.speed,e.zoom=this.zoom??e.zoom},Ke.loadFromProject=function(e){e=e.animation;this.switchMark(e.mark),this.switchOnionskin(e.onionskin),this.switchMirror(e.mirror),this.switchLoop(e.loop),this.setSpeed(e.speed),this.setZoom(e.zoom)},Ke.webglRestored=function(e){"open"===Ke.state&&Ke.requestRendering()},Ke.windowResize=function(e){this.updateHead(),"open"===this.state&&(this.resize(),this.updateCamera(),this.requestRendering())}.bind(Ke),Ke.themechange=function(e){this.requestRendering()}.bind(Ke),Ke.datachange=function(e){"config"===e.key&&this.Player.updateStep()}.bind(Ke),Ke.enumchange=function(e){this.requestRefreshingList()}.bind(Ke),Ke.keydown=function(e){if("open"===Ke.state&&null===Ke.dragging&&(e.altKey&&"KeyS"===e.code&&Ke.switchSettings(),Ke.motion)&&!e.cmdOrCtrlKey&&!e.altKey)switch(e.code){case"KeyQ":Ke.previousFrame();break;case"KeyE":Ke.nextFrame();break;case"KeyZ":Ke.previousKeyFrame();break;case"KeyX":Ke.nextKeyFrame();break;case"KeyC":Ke.switchMirror();break;case"Space":Ke.play()}},Ke.headPointerdown=function(e){e.target instanceof HTMLInputElement||(e.preventDefault(),document.activeElement!==Ke.screen&&Ke.screen.focus())},Ke.switchPointerdown=function(e){if(0===e.button){e=e.target;if("ITEM"===e.tagName)switch(e.getAttribute("value")){case"mark":return Ke.switchMark();case"onionskin":return Ke.switchOnionskin();case"mirror":return Ke.switchMirror();case"settings":return Ke.switchSettings()}}},Ke.speedInput=function(e){Ke.speed=this.read()},Ke.zoomFocus=function(e){Ke.screen.focus()},Ke.zoomInput=function(e){Ke.setZoom(this.read())},Ke.screenKeydown=function(i){if("open"===this.state&&null!==this.motion&&null===this.dragging){if(i.cmdOrCtrlKey)switch(i.code){case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":break;default:return}if(!i.altKey)switch(i.code){case"Enter":case"NumpadEnter":this.revealTarget();break;case"Escape":this.unselectMarquee();break;case"KeyA":0==(1&this.translationKey)&&(this.translationKey|=1,this.translationTimer.add(),window.on("keyup",this.translationKeyup));break;case"KeyW":0==(2&this.translationKey)&&(this.translationKey|=2,this.translationTimer.add(),window.on("keyup",this.translationKeyup));break;case"KeyD":0==(4&this.translationKey)&&(this.translationKey|=4,this.translationTimer.add(),window.on("keyup",this.translationKeyup));break;case"KeyS":0==(8&this.translationKey)&&(this.translationKey|=8,this.translationTimer.add(),window.on("keyup",this.translationKeyup));break;case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":if(null!==this.target){i.preventDefault();var a=this.target;let e=0,t=0;switch(i.code){case"ArrowLeft":e=-1;break;case"ArrowUp":t=-1;break;case"ArrowRight":e=1;break;case"ArrowDown":t=1}i.shiftKey&&(e*=10,t*=10);var n=Math.roundTo(a.x+e,4),a=Math.roundTo(a.y+t,4);this.shiftTarget(n,a)}break;case"Minus":case"NumpadSubtract":this.setZoom(this.zoom-1);break;case"Equal":case"NumpadAdd":this.setZoom(this.zoom+1);break;case"Digit0":case"Numpad0":this.setZoom(2)}}}.bind(Ke),Ke.translationKeyup=function(e){if(0!==this.translationKey){if(void 0===e)this.translationKey=0;else switch(e.code){case"KeyA":this.translationKey&=14;break;case"KeyW":this.translationKey&=13;break;case"KeyD":this.translationKey&=11;break;case"KeyS":this.translationKey&=7}0===this.translationKey&&(this.translationTimer.remove(),window.off("keyup",this.translationKeyup))}}.bind(Ke),Ke.screenWheel=function(e){"open"===this.state&&null===this.dragging&&(e.preventDefault(),0!==e.deltaY)&&(e=0<e.deltaY?-1:1,this.setZoom(this.zoom+e))}.bind(Ke),Ke.screenUserscroll=function(e){"open"===this.state&&(this.screen.rawScrollLeft=this.screen.scrollLeft,this.screen.rawScrollTop=this.screen.scrollTop,this.updateTransform(),this.requestRendering())}.bind(Ke),Ke.screenBlur=function(e){this.translationKeyup(),this.pointerup()}.bind(Ke),Ke.marqueePointerdown=function(e){if(!this.dragging&&this.motion)switch(e.button){case 0:if(e.altKey)return(this.dragging=e).mode="scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove);if(this.controlPointActive&&this.target){var t=this.targetContext,i=this.target,a=this.controlPoints;switch(this.dragging=e,this.controlPointActive){case a.jointRotate:case a.rectRotate.TL:case a.rectRotate.TR:case a.rectRotate.BL:case a.rectRotate.BR:var n=i.rotation,s=We.matrix.set(Ke.matrix).multiply(t.matrix),r=s[6],s=s[7],{x:o,y:l}=e.getRelativeCoords(We.canvas);e.mode="object-rotate",e.absoluteAnchorX=r,e.absoluteAnchorY=s,e.lastAngle=Math.atan2(l-s,o-r),e.rotationRadians=0,e.startRotation=n;break;case a.rectResize.T:case a.rectResize.L:case a.rectResize.R:case a.rectResize.B:case a.rectResize.TL:case a.rectResize.TR:case a.rectResize.BL:case a.rectResize.BR:var c=t.layer;switch(e.mode="object-resize",e.startScaleX=i.scaleX,e.startScaleY=i.scaleY,t.layer.class){case"sprite":var h=c.sprite,h=this.player.textures[h];e.startWidth=h.width,e.startHeight=h.height;break;case"particle":h=t.emitter;h.hasArea&&(e.startWidth=h.outerWidth,e.startHeight=h.outerHeight)}}return window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove)}var{x:a,y:d}=this.getPointerCoords(e),a=this.selectObject(a,d);a&&((this.dragging=e).mode="object-move",e.enabled=!1,e.startX=a.x,e.startY=a.y,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)),this.selectFrame(a);break;case 2:(this.dragging=e).mode="ready-to-scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}}.bind(Ke),Ke.marqueePointermove=function(e){if(!this.dragging&&this.motion){this.marquee.pointerevent=e;var{x:e,y:t}=this.getPointerCoords(e);if(this.target){var i=this.selectControlPoint(e,t);if(i)return this.setHover(null),void this.setControlPoint(i)}this.controlPointActive&&this.setControlPoint(null);i=this.selectObject(e,t);this.setHover(i)}}.bind(Ke),Ke.marqueePointerleave=function(e){this.marquee.pointerevent&&(this.marquee.pointerevent=null,this.setHover(null))}.bind(Ke),Ke.marqueeDoubleclick=function(e){this.target&&(this.screenBlur(),this.revealTarget())}.bind(Ke),Ke.pointerup=function(e){var t=Ke["dragging"];if(null!==t&&t.relate(e=void 0===e?t:e)){switch(t.mode){case"object-rotate":case"object-resize":case"object-move":case"ready-to-scroll":break;case"scroll":pt.close("cursor-grab")}Ke.dragging=null,window.off("pointerup",Ke.pointerup),window.off("pointermove",Ke.pointermove)}},Ke.pointermove=function(n){var s=Ke["dragging"];if(s.relate(n))switch(s.mode){case"object-rotate":if(Ke.target){var{x:r,y:o}=n.getRelativeCoords(We.canvas),r=r-s.absoluteAnchorX,o=o-s.absoluteAnchorY,o=Math.atan2(o,r),r=Math.modRadians(o-s.lastAngle),r=r<Math.PI?r:r-2*Math.PI;s.rotationRadians+=Ke.mirror?-r:r;let e=Math.round(s.startRotation+Math.degrees(s.rotationRadians));n.shiftKey&&(e=15*Math.round(e/15)),Ke.target.rotation!==e&&Ke.rotateTarget(e),s.lastAngle=o}break;case"object-resize":if(Ke.target){var l=Ke.controlPoints,c=Ke.controlPointActive,h=Math.radians(c.angle+Ke.controlPointRotation),r=(n.clientX-s.clientX)/Ke.scaleX,o=(n.clientY-s.clientY)/Ke.scaleY,d=Math.sqrt(r**2+o**2),u=Math.atan2(o,Ke.mirror?-r:r);let t=void 0,i=void 0;switch(c){case l.rectResize.T:case l.rectResize.L:case l.rectResize.R:case l.rectResize.B:var p=d*Math.cos(u-h);switch(c){case l.rectResize.T:case l.rectResize.B:i=p;break;case l.rectResize.L:case l.rectResize.R:t=p}break;case l.rectResize.TL:case l.rectResize.TR:case l.rectResize.BL:case l.rectResize.BR:if(n.shiftKey){var m=s.startWidth*s.startScaleX,g=s.startHeight*s.startScaleY,f=Math.atan2(g,m);let e;switch(c){case l.rectResize.TL:case l.rectResize.BR:e=h-Math.PI/4+f;break;case l.rectResize.TR:case l.rectResize.BL:e=h+Math.PI/4-f}g=u-e,m=d*Math.cos(g),g=m*Math.cos(f),m=m*Math.sin(f);t=g,i=m}else{var g=u-(h-Math.PI/4),v=d*Math.cos(g),b=d*Math.sin(g);switch(c){case l.rectResize.TL:case l.rectResize.BR:t=v,i=b;break;case l.rectResize.TR:case l.rectResize.BL:t=b,i=v}}}let e=void 0,a=void 0;void 0!==t&&(e=t/s.startWidth,e=Math.roundTo(s.startScaleX+e,2)),void 0!==i&&(a=i/s.startHeight,a=Math.roundTo(s.startScaleY+a,2)),(void 0!==e&&Ke.target.scaleX!==e||void 0!==a&&Ke.target.scaleY!==a)&&Ke.resizeTarget(e,a)}break;case"object-move":if(!s.enabled){o=n.clientX-s.clientX,r=n.clientY-s.clientY;if(!(4<Math.sqrt(o**2+r**2)||500<=n.timeStamp-s.timeStamp))break;s.enabled=!0}if(Ke.target){var o=Ke.target,r=Ke.mirror?-1:1,i=(n.clientX-s.clientX)/Ke.scaleX*r,a=(n.clientY-s.clientY)/Ke.scaleY;let e,t;if(n.shiftKey){r=Math.atan2(a,i),r=Math.modRadians(r)/(2*Math.PI);switch(Math.floor((4*r+.5)%4)){case 0:case 2:e=Math.round(s.startX+i),t=s.startY;break;case 1:case 3:e=s.startX,t=Math.round(s.startY+a)}}else e=Math.round(s.startX+i),t=Math.round(s.startY+a);o.x===e&&o.y===t||Ke.shiftTarget(e,t)}break;case"ready-to-scroll":r=n.clientX-s.clientX,o=n.clientY-s.clientY;Ke.screen.setScroll(s.scrollLeft-r,s.scrollTop-o),4<Math.sqrt(r**2+o**2)&&(s.mode="scroll",pt.open("cursor-grab"));break;case"scroll":r=n.clientX-s.clientX,o=n.clientY-s.clientY;Ke.screen.setScroll(s.scrollLeft-r,s.scrollTop-o)}},Ke.searcherInput=function(e){"insertCompositionText"!==e.inputType&&(e=this.input.value,Ke.list.searchNodes(e))},Ke.listKeydown=function(e){if(this.data){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":t&&(this.copy(t),this.delete(t));break;case"KeyC":this.copy(t);break;case"KeyV":this.paste(null)}else switch(e.code){case"Delete":this.delete(t);break;case"Backspace":this.cancelSearch()}}},Ke.listPointerdown=function(e){switch(e.button){case 0:var t=e.target;"NODE-ITEM"===t.tagName&&t.hasClass("selected")&&j.open("animMotion",t.item);break;case 3:this.cancelSearch()}},Ke.listSelect=function(e){Ke.setMotion(e.value)},Ke.listRecord=function(e){var t=e.value,i=t["type"];switch(i){case"create":case"delete":case"remove":Ke.history.save({type:"animation-object-"+i,response:t})}},Ke.listOpen=function(e){Ke.editMotion(e.value)},Ke.listPopup=function(e){const t=e.value;var i=N.createGetter("menuAnimationList");let a,n,s,r=(s=t?(a=!0,n=Clipboard.has("yami.animation.object"),!0):(a=!1,n=Clipboard.has("yami.animation.object"),!1),Array.empty);t&&(r=[{label:i("edit"),accelerator:"Enter",click:()=>{Ke.editMotion(t)}}]),ve.popup({x:e.clientX,y:e.clientY},[...r,{label:i("insert"),click:()=>{Ke.getNewMotionId(e=>{e=j.animMotion.create(e);this.addNodeTo(e,t),j.open("animMotion",e)})}},{type:"separator"},{label:i("cut"),accelerator:p("X"),enabled:a,click:()=>{this.copy(t),this.delete(t)}},{label:i("copy"),accelerator:p("C"),enabled:a,click:()=>{this.copy(t)}},{label:i("paste"),accelerator:p("V"),enabled:n,click:()=>{this.paste(t)}},{label:i("delete"),accelerator:"Delete",enabled:s,click:()=>{this.delete(t)}}])},Ke.listChange=function(e){Ke.planToSave()},Ke.listPageResize=function(e){Ke.list.updateHead(),Ke.list.resize()},Ke.dirListPointerdown=function(e){e=e.target;"ANIM-DIR"!==e.tagName||e.hasClass("selected")||(Ke.setDirection(e.direction),j.close())},Ke.timelinePageResize=function(e){Ke.updatePointerArea(),Ke.timeline.updateHead(),Ke.layerList.resize()},Ke.timelineToolbarPointerdown=function(e){if(0===e.button){e=e.target;if("ITEM"===e.tagName)switch(e.getAttribute("value")){case"previousKey":return Ke.previousKeyFrame();case"previous":return Ke.previousFrame();case"play":return Ke.play();case"next":return Ke.nextFrame();case"nextKey":return Ke.nextKeyFrame();case"loop":return Ke.switchLoop()}}},Ke.layerListWheel=function(e){e.preventDefault(),0!==e.deltaY&&(this.scrollTop+=0<e.deltaY?20:-20)},Ke.layerListScroll=function(e){var t=Ke["outerTimelineList"],i=this["scrollTop"];this.lastScrollTop=i,t.lastScrollTop!==i&&(t.scrollTop=i)},Ke.layerListKeydown=function(e){if(e.target===this&&this.data){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":t&&(this.copy(t),this.delete(t));break;case"KeyC":this.copy(t);break;case"KeyV":this.paste(null)}else e.shiftKey||"Delete"===e.code&&this.delete(t)}},Ke.layerListPointerdown=function(e){if(0===e.button){var t=e.target;switch(t.tagName){case"NODE-ITEM":t.hasClass("selected")&&Ke.openLayer(t.item);break;case"VISIBILITY-ICON":var i=t.parentNode["item"],a=i["hidden"],n=this.setRecursiveStates(i,"hidden",!a);this.update(),this.dispatchChangeEvent(),Ke.requestRendering(),Ke.history.save({type:"animation-layer-hidden",motion:Ke.motion,direction:Ke.direction,item:i,oldValues:n,newValue:!a});break;case"LOCK-ICON":i=t.parentNode["item"],n=i["locked"],a=this.setRecursiveStates(i,"locked",!n);this.update(),this.dispatchChangeEvent(),Ke.history.save({type:"animation-layer-locked",motion:Ke.motion,direction:Ke.direction,item:i,oldValues:a,newValue:!n})}}},Ke.layerListSelect=function(e){Ke.openLayer(e.value)},Ke.layerListRecord=function(e){var t=e.value,i=t["type"];switch(i){case"rename":case"create":case"delete":case"remove":Ke.contextLoaded=!1,Ke.history.save({type:"animation-layer-"+i,motion:Ke.motion,direction:Ke.direction,response:t})}},Ke.layerListPopup=function(e){const t=e.value;var i=N.createGetter("menuAnimationLayerList");let a,n,s,r;r=t?(a=!0,n=Clipboard.has("yami.animation.layer"),s=!0):(a=!1,n=Clipboard.has("yami.animation.layer"),s=!1),ve.popup({x:e.clientX,y:e.clientY},[{label:i("create"),submenu:[{label:i("create.joint"),click:()=>{this.create(t,"joint")}},{label:i("create.sprite"),click:()=>{this.create(t,"sprite")}},{label:i("create.particleEmitter"),click:()=>{this.create(t,"particle")}}]},{type:"separator"},{label:i("cut"),accelerator:p("X"),enabled:a,click:()=>{this.copy(t),this.delete(t)}},{label:i("copy"),accelerator:p("C"),enabled:a,click:()=>{this.copy(t)}},{label:i("paste"),accelerator:p("V"),enabled:n,click:()=>{this.paste(t)}},{label:i("delete"),accelerator:"Delete",enabled:s,click:()=>{this.delete(t)}},{label:i("rename"),accelerator:"F2",enabled:r,click:()=>{this.rename(t)}}])},Ke.layerListChange=function(e){Ke.planToSave()},Ke.outerTimelineListKeydown=function(e){if(null===this.dragging)if(e.cmdOrCtrlKey)switch(e.code){case"KeyA":Ke.selectAllFrames();break;case"KeyX":Ke.copyFrame(),Ke.deleteFrame();break;case"KeyC":Ke.copyFrame();break;case"KeyV":Ke.pasteFrame();break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":Ke.shiftSelectedFrames(e.code.slice(5).toLowerCase())}else if(e.shiftKey)switch(e.code){case"Delete":Ke.deleteFrame(!0);break;case"ArrowUp":case"ArrowDown":Ke.selectAllFramesOfKey();break;case"ArrowLeft":case"ArrowRight":Ke.multiSelectFramesRelative(e.code.slice(5).toLowerCase());break;case"Home":case"End":Ke.multiSelectFramesToHomeEnd(e.code.toLowerCase())}else switch(e.code){case"Space":e.preventDefault();break;case"Escape":Ke.unselectMarquee();break;case"KeyF":Ke.insertFrame();break;case"KeyG":Ke.extendFrame();break;case"Delete":Ke.deleteFrame();break;case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":e.preventDefault(),Ke.selectFrameRelative(e.code.slice(5).toLowerCase());break;case"Home":case"End":e.preventDefault(),Ke.selectFrameAtHomeEnd(e.code.toLowerCase());break;case"PageUp":case"PageDown":e.preventDefault()}},Ke.outerTimelineListWheel=function(e){e.preventDefault(),0!==e.deltaY&&(this.scrollTop+=0<e.deltaY?20:-20)},Ke.outerTimelineListScroll=function(e){var{scrollLeft:t,scrollTop:i}=this;if(this.lastScrollLeft!==t){this.lastScrollLeft=t;var{outerRuler:a,innerRuler:n,outerPointerArea:s}=Ke,r=Math.floor(t/80);if(n.start!==r){let e=5*(n.start=r);for(const o of n.childNodes)o.textContent=e.toString(),e+=5}a.scrollLeft=(t+1e-4)%80,s.scrollLeft=t}this.lastScrollTop!==i&&(this.lastScrollTop=i,r=Ke["layerList"],r.lastScrollTop!==i)&&(r.scrollTop=i);n=Ke.timelineCursor.pointerevent;null!==n&&Ke.innerTimelineListPointermove(n)},Ke.outerTimelineListBlur=function(e){Ke.outerTimelineListPointerup()},Ke.outerTimelineListPointerdown=function(n){if(!Ke.dragging)switch(n.button){case 0:if(n.altKey)return(this.dragging=n).mode="scroll",n.scrollLeft=this.scrollLeft,n.scrollTop=this.scrollTop,pt.open("cursor-grab"),window.on("pointerup",Ke.outerTimelineListPointerup),void window.on("pointermove",Ke.outerTimelineListPointermove);if(n.target===Ke.innerTimelineList){var s=Ke.timelineMarquee;let{x:e,y:t}=Ke.getFrameCoords(n),i=1,a=e;if(n.shiftKey){var{y:r,origin:o}=s;t===r&&(i=Math.abs(e-o)+1,e=Math.min(e,o),a=o)}else if(null!==Ke.getKeyFrame(e,t))return Ke.adjustMarquee(),{layer:r,length:o}=s,Ke.updateMarqueeShift(e,t,o),Ke.timelineMarqueeShift.show(),Ke.loadFrames(e),(this.dragging=n).mode="shift",n.layer=r,n.pointerdownX=e,n.pointerdownY=t,n.enableDblclickEvent=!0,window.on("pointerup",Ke.outerTimelineListPointerup),window.on("pointermove",Ke.outerTimelineListPointermove),void this.addScrollListener("both",1,!0,()=>{Ke.outerTimelineListPointermove(n.latest)});Ke.selectMarquee(e,t,i,a),Ke.scrollToMarquee(!1),Ke.loadFrames(e),(this.dragging=n).mode="select",n.pointerdownX=a,n.pointerdownY=t,n.enableDblclickEvent=!0,window.on("pointerup",Ke.outerTimelineListPointerup),window.on("pointermove",Ke.outerTimelineListPointermove),this.addScrollListener("horizontal",1,!0,()=>{Ke.outerTimelineListPointermove(n.latest)})}break;case 2:(this.dragging=n).mode="ready-to-scroll",n.scrollLeft=this.scrollLeft,n.scrollTop=this.scrollTop,window.on("pointerup",Ke.outerTimelineListPointerup),window.on("pointermove",Ke.outerTimelineListPointermove)}},Ke.outerTimelineListPointerup=function(e){var t,i,a,n,s,r=Ke.outerTimelineList["dragging"];if(null!==r&&r.relate(e=void 0===e?r:e)){switch(r.mode){case"select":Ke.outerTimelineList.removeScrollListener();break;case"shift":var o=Ke.timelineMarqueeShift;o.hasClass("disabled")||Ke.dragAndDropFrame(),o.hide(),o.layer=null,o.removeClass("disabled"),Ke.outerTimelineList.removeScrollListener();break;case"ready-to-scroll":e.target===Ke.innerTimelineList&&({x:o,y:i}=Ke.getFrameCoords(e),(t=Ke.timelineMarquee).isPointIn(o,i)||(Ke.selectMarquee(o,i,1,o),Ke.scrollToMarquee(!1),Ke.loadFrames(o)),t.isPointIn(o,i))&&(o=t.layer.class,i=t.isSelected(),o=Clipboard.has("yami.animFrame."+o),a=i||t.isExtendable(),n=i||t.isShrinkable(),s=N.createGetter("menuAnimationTimeline"),ve.popup({x:e.clientX,y:e.clientY},[{label:s("insert"),accelerator:"F",click:()=>{Ke.insertFrame()}},{label:s("extend"),accelerator:"G",enabled:a,click:()=>{Ke.extendFrame()}},{label:s("cut"),accelerator:p("X"),enabled:i,click:()=>{Ke.copyFrame(),Ke.deleteFrame()}},{label:s("copy"),accelerator:p("C"),enabled:i,click:()=>{Ke.copyFrame()}},{label:s("paste"),enabled:o,accelerator:p("V"),click:()=>{Ke.pasteFrame()}},{label:s("delete"),accelerator:"Delete",enabled:i,click:()=>{Ke.deleteFrame()}},{label:s("deleteAndShift"),accelerator:"Shift+Del",enabled:n,click:()=>{Ke.deleteFrame(!0)}},{label:s("selectAll"),accelerator:p("A"),enabled:0!==t.layer.frames.length,click:()=>{Ke.selectAllFrames()}}]));break;case"scroll":pt.close("cursor-grab")}Ke.innerTimelineList.pointerevent=r,Ke.outerTimelineList.dragging=null,window.off("pointerup",Ke.outerTimelineListPointerup),window.off("pointermove",Ke.outerTimelineListPointermove)}},Ke.outerTimelineListPointermove=function(e){var t=Ke.outerTimelineList["dragging"];if(t.relate(e))switch(t.mode){case"select":t.latest=e,t.enableDblclickEvent&&(i=e.clientX-t.clientX,a=e.clientY-t.clientY,4<Math.sqrt(i**2+a**2))&&(t.enableDblclickEvent=!1);var i=Ke.getFrameCoords(e,!0),a=Math.clamp(i.x,0,Ke.frameMax-1),i=Math.min(a,t.pointerdownX),n=Math.abs(a-t.pointerdownX)+1;Ke.selectMarquee(i,t.pointerdownY,n),Ke.loadFrames(a);break;case"shift":t.latest=e,t.enableDblclickEvent&&(i=e.clientX-t.clientX,n=e.clientY-t.clientY,4<Math.sqrt(i**2+n**2))&&(t.enableDblclickEvent=!1);var a=Ke.getFrameCoords(e,!0),i=Ke.timelineMarqueeShift,n=Ke.frameMax-i.length,s=Ke.innerTimelineList.childNodes.length-1,n=Math.clamp(a.x,0,n),a=Math.clamp(a.y,0,s);Ke.updateMarqueeShift(n,a),t.layer.class===i.layer?.class?i.removeClass("disabled"):i.addClass("disabled");break;case"ready-to-scroll":s=e.clientX-t.clientX,n=e.clientY-t.clientY;Ke.outerTimelineList.scroll(t.scrollLeft-s,t.scrollTop-n),4<Math.sqrt(s**2+n**2)&&(t.mode="scroll",pt.open("cursor-grab"));break;case"scroll":a=e.clientX-t.clientX,i=e.clientY-t.clientY;Ke.outerTimelineList.scroll(t.scrollLeft-a,t.scrollTop-i)}},Ke.innerTimelineListPointermove=function(e){var{x:t,y:i}=Ke.getFrameCoords(e),a=Ke.innerTimelineList,n=Ke.frameMax,a=a.childNodes.length;0<=t&&t<n&&0<=i&&i<a?Ke.updateCursor(t,i):Ke.updateCursor(-1,-1),Ke.timelineCursor.pointerevent=e},Ke.innerTimelineListPointerleave=function(e){Ke.timelineCursor.pointerevent=null,Ke.updateCursor(-1,-1)},Ke.innerTimelineListDblclick=function(e){if(this.pointerevent.enableDblclickEvent){var{x:t,y:i}=Ke.getFrameCoords(e),e=Ke.innerTimelineList.childNodes[i]?.layer;if(void 0!==e)for(const s of e.frames){var a=s.start,n=s.end;if(!(n<=t)){if(t<a)break;return Ke.selectMarquee(a,i,n-a,t),void Ke.scrollToMarquee(!1)}}}},Ke.marquee.resize=function(){this.pointerevent&&Ke.marqueePointermove(this.pointerevent)},Ke.list.copy=function(e){e&&Clipboard.write("yami.animation.object",e)},Ke.list.paste=function(e){var t=Clipboard.read("yami.animation.object");t&&this.data&&this.addNodeTo(t,e)},Ke.list.delete=function(e){e&&this.deleteNode(e)},Ke.list.cancelSearch=function(){var e;"search"===this.display&&(e=document.activeElement,Ke.searcher.deleteInputContent(),this.expandToSelection(),this.scrollToSelection(),e.focus())},Ke.list.updateHead=function(){var e,{page:t,head:i}=this;0!==t.clientWidth&&(t=x.getGroupOfElement(i)["nav"],e=t.rect(),t=t.lastChild.rect().right-e.left,i.left!==t)&&(i.left=t,i.style.left=t+"px")},Ke.list.createIcon=function(){var e=document.createElement("node-icon");return e.addClass("icon-string"),e},Ke.list.createText=function(e){var t=document.createElement("text");return t.style.pointerEvents="none",t},Ke.list.updateText=function(e){var t,i=e["element"];i.enumId!==e.id&&(i.enumId=e.id,t=M.getString(e.id),i.textNode.textContent=t?t.name:I.parseUnlinkedId(e.id))},Ke.list.createLoopIcon=function(e){var e=e["element"],t=document.createElement("node-icon");t.addClass("icon-loop"),t.textContent="",e.appendChild(t),e.loopIcon=t,e.loop=null},Ke.list.updateLoopIcon=function(e){var t=e["element"];void 0!==t.loopIcon&&(e=e.loop,t.loop!==e)&&((t.loop=e)?t.loopIcon.show():t.loopIcon.hide())},Ke.list.onDelete=function(){Ke.updateMotion()},Ke.layerList.update=function(){var e,t,i;Ee.prototype.update.call(this),Ke.contextLoaded||(Ke.contextLoaded=!0,e=Ke["player"],t=e["contexts"],e.destroyContextEmitters(),e.loadContexts(t),Ke.showOnionskin&&({prev:t,next:i}=e.onionskin,e.loadContexts(t),e.loadContexts(i))),Ke.updateTarget(),Ke.updateTimeline()},Ke.layerList.create=function(e,t){let i;switch(t){case"joint":i=j.animJointLayer.create();break;case"sprite":i=j.animSpriteLayer.create();break;case"particle":i=j.animParticleLayer.create()}this.addNodeTo(i,e)},Ke.layerList.copy=function(e){e&&Clipboard.write("yami.animation.layer",e)},Ke.layerList.paste=function(e){var t=Clipboard.read("yami.animation.layer");t&&this.data&&this.addNodeTo(t,e)},Ke.layerList.delete=function(e){e&&this.deleteNode(e)},Ke.layerList.restoreMotion=function(e,t){var i=this["update"];this.update=Function.empty,Ke.setMotion(e),Ke.setDirection(t),this.update=i},Ke.layerList.createIcon=function(){const t={joint:()=>{var e=document.createElement("node-icon");return e.addClass("anim-layer-joint"),e},sprite:()=>{var e=document.createElement("node-icon");return e.addClass("anim-layer-sprite"),e},particle:()=>{var e=document.createElement("node-icon");return e.addClass("anim-layer-particle"),e}};return function(e){return t[e.class]()}}(),Ke.layerList.onDelete=function(e){j[j.type]?.target===e&&j.close()},Ke.timeline.updateHead=function(){var e,t,i=this["head"];0!==this.clientWidth&&(e=x.getGroupOfElement(i)["nav"],t=e.rect(),t=(e=e.lastChild.rect()).right-t.left,i.left!==t&&(i.left=t,i.style.left=t+"px"),t=Ke.outerTimelineList.rect(),t=Math.max(t.left-e.right,0),i.padding!==t&&(i.padding=t,Ke.toolbar.style.width=t+"px",Ke.outerRuler.style.left=t+"px"),Ke.updateRuler())},Ke.outerTimelineList.restoreMotionAndLayer=function(e,t,i){var a=Ke["updateTimeline"];Ke.updateTimeline=Function.empty,Ke.setMotion(e),Ke.setDirection(t),Ke.layerList.expandToItem(i),Ke.updateTimeline=a},Ke.timelineMarquee.isPointIn=function(e,t){return e>=this.x&&e<this.x+this.length&&t===this.y},Ke.timelineMarquee.isSelected=function(){var{layer:e,x:t,length:i}=this,a=t+i,n=e.frames,s=n.length;for(let e=0;e<s;e++){var r=n[e],o=r.start,r=r.end;if(!(r<=t)){if(a<=o)break;return!0}}return!1},Ke.timelineMarquee.isExtendable=function(){var e=this.layer.frames[0];return!!e&&this.x>=e.start},Ke.timelineMarquee.isShrinkable=function(){var e=this.layer.frames,e=e[e.length-1];return!!e&&this.x<e.end},Ke.Player=class ki{visible;index;length;loopStart;anchorX;anchorY;mirror;data;dirMap;dirCases;angle;direction;motion;motions;sprites;images;textures;contexts;emitters;constructor(e){this.index=0,this.length=0,this.loopStart=0,this.anchorX=0,this.anchorY=0,this.mirror=!1,this.data=e,this.dirMap=Array.empty,this.dirCases=null,this.angle=0,this.direction=-1,this.motion=null,this.motions={},this.sprites={},this.images={},this.textures={},this.contexts=[],this.emitters=[],this.loadSprites(),this.loadMotions()}setMotion(e){var e=this.motions[e];return void 0!==e&&this.motion!==e&&(this.motion=e,this.dirCases=e.dirCases,e=ki.dirMaps[e.mode],this.dirMap!==e?(this.dirMap=e,this.direction=-1,this.setAngle(this.angle)):this.loadDirCase(),!0)}loadDirCase(){var e=this.dirMap[this.direction];e&&(e=this.dirCases[e.index],this.layers=e.layers,this.destroyContextEmitters(),this.loadContexts(this.contexts),this.computeLength())}setAngle(e){this.angle=e;var t=this.dirMap.length,e=Math.modRadians(e)/(2*Math.PI),e=Math.floor((e*t+.5)%t);return this.setDirection(e)}setDirection(e){var t;return this.direction!==e&&!!(t=this.dirMap[e])&&(this.direction=e,this.mirror=t.mirror,this.loadDirCase(),!0)}restart(){this.index=0}reset(){this.index=0,this.length=0,this.motion=null,this.contexts=[],this.destroyUpdatingEmitters(),this.destroyContextEmitters()}setPosition(e,t){e=ki.matrix.set6f(1,0,0,1,e,t);this.mirror&&e.mirrorh()}setSpriteImages(e){this.images=Object.setPrototypeOf(e,this.images)}updateFrameParameters(t,i){var a=t["count"];e:for(let e=0;e<a;e++){var n=t[e],s=n.layer.frames,r=s.length-1;for(let e=0;e<=r;e++){var o=s[e],l=o.start,c=o.end;if(l<=i&&i<c){var h,c=o.easingId;""!==c&&e<r?(h=s[e+1],c=u.get(c).map((i-l)/(h.start-l)),n.update(o,c,h)):n.update(o);continue e}}n.reset()}}loadSprites(){var t=this.sprites,i=this.images,a=this.data.sprites,n=a.length;for(let e=0;e<n;e++){var s=a[e];i[(t[s.id]=s).id]=s.image}}loadMotions(){var e=this.motions;for(const t of this.data.motions)e[t.id]=t}loadContexts(e){ki.loadContexts(this,e)}update(e){this.index+=e/ki.step}computeIndex(){this.index>=this.length&&(this.motion.loop?this.index=this.index%this.length+this.loopStart:this.index=this.length-1)}computeLength(){let t=0;var i=this["contexts"],a=i["count"];for(let e=0;e<a;e++){var n=i[e].layer.frames,n=n[n.length-1];void 0!==n&&(t=Math.max(t,n.end))}this.length=t,this.loopStart=Math.min(this.motion.loopStart,t-1)}emitParticles(t){var i=this["contexts"],a=i["count"];for(let e=0;e<a;e++){var n=i[e],s=n["layer"];if("particle"===s.class){var{frame:r,emitter:o}=n;if(null!==r&&void 0!==o){switch(s.angle){case"default":o.angle=0;break;case"inherit":var l=n["matrix"],c=l[0],l=l[1];o.angle=Math.atan2(l,c)}o.emitParticles(t)}}}}updateParticles(e){var t=this["emitters"];let i=t.length;for(;0<=--i;){var a=t[i];!1===a.updateParticles(e)&&a.disabled&&(a.destroy(),t.splice(i,1))}}draw(t){var i=this["contexts"],a=i["count"];for(let e=0;e<a;e++){var n=i[e],s=n["layer"];"sprite"===s.class&&null!==n.frame&&(s=s.sprite,null!==(s=this.getTexture(s)))&&(n.opacity*=t,this.drawSprite(n,s))}var r=this["emitters"],o=r["length"];if(0!==o){We.batchRenderer.draw();for(let e=0;e<o;e++)r[e].draw()}}drawSprite(e,t,i){var a=We,n=a.arrays[0].float32,s=a.arrays[0].uint32,a=a.batchRenderer,r=a.response,o=e.matrix,l=e.layer,c=e.frame,h=e.tint,d=t.base,u=d.width,p=d.height,m=t.width,g=t.height,f=c.spriteX*m,c=c.spriteY*g,v=t.offsetX,t=t.offsetY,b=v+m,y=t+g,w=o[0],x=o[1],k=o[3],T=o[4],I=o[6],o=o[7],C=w*v+k*t+I,E=x*v+T*t+o,M=w*v+k*y+I,v=x*v+T*y+o,S=w*b+k*y+I,y=x*b+T*y+o,w=w*b+k*t+I,k=x*b+T*t+o,I=f/u,x=c/p,b=(f+m)/u,T=(c+g)/p,t=(a.setBlendMode(l.blend),a.push(d.index),void 0===i&&(i=A.showLight?l.light:"raw"),8*r[0]),o=ki.lightSamplingModes[i],f=Math.round(255*e.opacity),m=r[1]|f<<8|o<<16,u=h[0]+(h[1]<<16)+16711935,c=h[2]+(h[3]<<16)+16711935,g="anchor"!==i?0:Math.round(65535*Math.clamp(this.anchorX,0,1))|Math.round(65535*Math.clamp(this.anchorY,0,1))<<16;n[t]=C,n[1+t]=E,n[2+t]=I,n[3+t]=x,s[4+t]=m,s[5+t]=u,s[6+t]=c,s[7+t]=g,n[8+t]=M,n[9+t]=v,n[10+t]=I,n[11+t]=T,s[12+t]=m,s[13+t]=u,s[14+t]=c,s[15+t]=g,n[16+t]=S,n[17+t]=y,n[18+t]=b,n[19+t]=T,s[20+t]=m,s[21+t]=u,s[22+t]=c,s[23+t]=g,n[24+t]=w,n[25+t]=k,n[26+t]=b,n[27+t]=x,s[28+t]=m,s[29+t]=u,s[30+t]=c,s[31+t]=g}getTexture(s){const r=this.textures,o=r[s];if(void 0!==o)return o;{const l=this.sprites[s];var e=this.images[s];if(void 0!==l&&e){const o=new $e(e);if(r[s]=null,o.on("load",()=>{var e,t,i,a,n;this.textures===r?({floor:n,max:e}=Math,t=o["base"],{hframes:a,vframes:i}=l,a=n(e(t.width/a,1)),n=n(e(t.height/i,1)),o.width=a,o.height=n,o.offsetX=-a/2,o.offsetY=-n/2,r[s]=o,A.requestRendering()):o.destroy()}),o.complete)return o}return null}}destroy(){for(const e of Object.values(this.textures))e instanceof $e&&e.destroy();this.textures=null,this.destroyUpdatingEmitters(),this.destroyContextEmitters();for(const t of Object.values(this.motions))for(const i of t.dirCases)if(void 0!==i.loaded){delete i.loaded;for(const a of i.layers)for(const n of a.frames)delete n.key}}destroyUpdatingEmitters(){var t=this["emitters"],i=t["length"];if(0!==i){for(let e=0;e<i;e++)t[e].destroy();t.length=0}}destroyContextEmitters(){var t=this["contexts"],i=t["count"];for(let e=0;e<i;e++){var a=t[e],n=a.emitter;void 0!==n&&(n.disabled=!0,n.isEmpty()&&(n.destroy(),this.emitters.remove(n)),delete a.emitter)}}clearParticles(){var t=this["emitters"],i=t["length"];if(0!==i)for(let e=0;e<i;e++)t[e].clear()}static step=0;static matrix=new Ze;static lightSamplingModes={raw:0,global:1,anchor:2};static stage;static dirMaps={"1-dir":[{index:0,mirror:!1}],"1-dir-mirror":[{index:0,mirror:!1},{index:0,mirror:!0}],"2-dir":[{index:1,mirror:!1},{index:0,mirror:!1}],"3-dir-mirror":[{index:1,mirror:!1},{index:0,mirror:!1},{index:1,mirror:!0},{index:2,mirror:!1}],"4-dir":[{index:2,mirror:!1},{index:0,mirror:!1},{index:1,mirror:!1},{index:3,mirror:!1}],"5-dir-mirror":[{index:1,mirror:!1},{index:3,mirror:!1},{index:0,mirror:!1},{index:3,mirror:!0},{index:1,mirror:!0},{index:4,mirror:!0},{index:2,mirror:!1},{index:4,mirror:!1}],"8-dir":[{index:2,mirror:!1},{index:5,mirror:!1},{index:0,mirror:!1},{index:4,mirror:!1},{index:1,mirror:!1},{index:6,mirror:!1},{index:3,mirror:!1},{index:7,mirror:!1}]};static updateStep(){this.step=1e3/He.config.animation.frameRate}static loadContexts(e,t){t.count=0,null!==e.layers&&this.#loadContext(e,e.layers,null,t)}static#loadContext(t,e,i,a){for(const n of e){let e=a[a.count];switch(void 0===e&&(e=a[a.count]={animation:t,parent:null,layer:null,frame:null,matrix:new Ze,opacity:0,update:null,reset:ki.contextReset}),a.count++,e.parent=i,(e.layer=n).class){case"joint":e.update=ki.contextUpdate;break;case"sprite":e.update=ki.contextUpdateSprite;break;case"particle":e.update=ki.contextUpdateParticle}"joint"===n.class&&this.#loadContext(t,n.children,e,a)}}static contextReset(){var e=this.parent,t=this.matrix;null!==e?(t.set(e.matrix),this.opacity=e.opacity):(t.set(ki.matrix),this.opacity=1),this.frame=null}static contextUpdate(e,t,i){var a=this.parent,n=this.matrix;null!==a?(n.set(a.matrix),this.opacity=a.opacity):(n.set(ki.matrix),this.opacity=1);let s=e.x,r=e.y,o=e.rotation,l=e.scaleX,c=e.scaleY,h=e.opacity;void 0!==i&&(a=1-t,s=s*a+i.x*t,r=r*a+i.y*t,o=o*a+i.rotation*t,l=l*a+i.scaleX*t,c=c*a+i.scaleY*t,h=h*a+i.opacity*t),n.translate(s,r).rotate(Math.radians(o)).scale(l,c),this.opacity*=h,this.frame=e}static contextUpdateSprite(e,t,i){ki.contextUpdate.call(this,e,t,i);let a=this.tint,n=(void 0===a&&(a=this.tint=new Int16Array(4)),e.tint[0]),s=e.tint[1],r=e.tint[2],o=e.tint[3];void 0!==i&&(e=1-t,n=Math.clamp(n*e+i.tint[0]*t,-255,255),s=Math.clamp(s*e+i.tint[1]*t,-255,255),r=Math.clamp(r*e+i.tint[2]*t,-255,255),o=Math.clamp(o*e+i.tint[3]*t,0,255)),a[0]=n,a[1]=s,a[2]=r,a[3]=o}static contextUpdateParticle(e,t,i){ki.contextUpdate.call(this,e,t,i);let a=this.emitter;if(void 0===a){var n=this.layer.particleId,n=He.particles[n];if(!n)return;(a=new S.Emitter(n)).matrix=this.matrix,this.emitter=a,this.animation.emitters.push(a)}let s=e.scale,r=e.speed;void 0!==i&&(n=1-t,s=s*n+i.scale*t,r=r*n+i.speed*t),a.scale=s,a.speed=r,a.opacity=this.opacity}},{state:"closed",page:_("#animation-easing").hide(),head:_("#animation-easing-head"),list:_("#animation-easing-id").hide(),canvas:_("#animation-easing-canvas"),target:null,index:null,curveMap:null,initialize:null,open:null,load:null,close:null,suspend:null,resume:null,updateHead:null,updateEasingOptions:null,updateTimeline:null,resize:null,drawCurve:null,requestRendering:null,renderingFunction:null,stopRendering:null,windowResize:null,themechange:null,datachange:null,easingIdWrite:null,easingIdInput:null,settingsPointerdown:null}),S=(Pt.initialize=function(){this.curveMap=new u.CurveMap,this.list.defaultItem={name:"No Easing",value:""},this.list.setItemNames=function(e){var t=this.defaultItem,e=e[t.value];void 0!==e&&(t.name=e),null!==this.dataValue&&this.update()},window.on("themechange",this.themechange),window.on("datachange",this.datachange),this.page.on("resize",this.windowResize),this.list.on("write",this.easingIdWrite),this.list.on("input",this.easingIdInput),_("#animation-easing-settings").on("pointerdown",this.settingsPointerdown)},Pt.open=function(){"closed"===this.state&&(this.state="open",this.page.show(),this.windowResize(),this.updateEasingOptions())},Pt.load=function(e){this.target!==e&&((this.target=e)?(this.list.show(),this.list.write(e.easingId)):(this.list.hide(),this.index=null,this.requestRendering()))},Pt.close=function(){"closed"!==this.state&&(this.state="closed",this.page.hide(),this.stopRendering())},Pt.suspend=function(){"open"===this.state&&(this.state="suspended",this.stopRendering())},Pt.resume=function(){"suspended"===this.state&&(this.state="open",this.resize(),this.requestRendering())},Pt.updateHead=function(){var e,{page:t,head:i}=this;0!==t.clientWidth&&(t=x.getGroupOfElement(i)["nav"],e=t.rect(),t=t.lastChild.rect().right-e.left,i.left!==t)&&(i.left=t,i.style.left=t+"px")},Pt.updateEasingOptions=function(){var e,t=this["list"],i=He["easings"];t.data!==i&&(t.data=i,i=t.defaultItem,e=He.createEasingItems(),t.loadItems([i,...e]))},Pt.updateTimeline=function(e){var t=""!==e.easingId,e=e["key"];e.easing!==t&&((e.easing=t)?e.addClass("easing"):e.removeClass("easing"))},Pt.resize=function(){var e,t;"open"===this.state&&(e=(t=CSS.getDevicePixelContentBoxSize(this.page)).width,t=t.height,this.canvas.width===e&&this.canvas.height===t||(this.canvas.width=e,this.canvas.height=t))},Pt.drawCurve=function(){var e=this.canvas,i=e.width,a=e.height;if(i*a!=0){var n=i>>1,s=a>>1,r=Math.floor(Math.min(i,a)/12),o=n-5*r,l=s+5*r,c=10*r;let t=e["context"];(t=t||(e.context=e.getContext("2d",{desynchronized:!0}))).clearRect(0,0,i,a),t.strokeStyle=e.gridColor,t.setLineDash([1]);for(let e=l%r;e<a;e+=r)t.beginPath(),t.moveTo(0,e+.5),t.lineTo(i,e+.5),t.stroke();for(let e=o%r;e<i;e+=r)t.beginPath(),t.moveTo(e+.5,0),t.lineTo(e+.5,a),t.stroke();switch(t.strokeStyle=e.axisColor,t.beginPath(),t.moveTo(o,l-c+.5),t.lineTo(o+c+.5,l-c+.5),t.lineTo(o+c+.5,l),t.stroke(),t.strokeStyle=e.axisColor,t.setLineDash([]),t.beginPath(),t.moveTo(0,.5+l),t.lineTo(i,.5+l),t.moveTo(.5+o,0),t.lineTo(.5+o,a),t.stroke(),t.textBaseline="top",t.font="12px Arial",t.fillStyle=e.textColor,t.fillText("TIME",4+o,4+l),t.translate(o,l),t.rotate(3*Math.PI/2),t.fillText("PROGRESSION",4,-12),t.setTransform(1,0,0,1,0,0),this.index){case null:break;case"":t.lineWidth=2,t.strokeStyle=e.curveColor,t.beginPath(),t.moveTo(.5+o,.5+l),t.lineTo(o+c+.5,.5+l),t.lineTo(o+c+.5,l-c+.5),t.stroke(),t.lineWidth=1;break;default:t.lineWidth=2,t.strokeStyle=e.curveColor,t.beginPath(),t.moveTo(.5+o,.5+l);var h=this.curveMap,d=h.count;for(let e=2;e<d;e+=2)t.lineTo(o+h[e]*c+.5,l-h[e+1]*c+.5);t.stroke(),t.lineWidth=1}}},Pt.requestRendering=function(){"open"===this.state&&f.appendUpdater("sharedRendering2",this.renderingFunction)},Pt.renderingFunction=function(){Pt.drawCurve()},Pt.stopRendering=function(){f.removeUpdater("sharedRendering2",this.renderingFunction)},Pt.windowResize=function(e){if(0===this.page.clientWidth)return this.suspend();switch(this.updateHead(),this.state){case"open":this.resize(),this.requestRendering();break;case"suspended":this.resume()}}.bind(Pt),Pt.themechange=function(e){var t=this["canvas"];switch(e.value){case"light":t.textColor="#808080",t.gridColor="#c0c0c0",t.axisColor="#606060",t.curveColor="#202020";break;case"dark":t.textColor="#808080",t.gridColor="#404040",t.axisColor="#808080",t.curveColor="#d8d8d8"}this.requestRendering()}.bind(Pt),Pt.datachange=function(e){"open"===Pt.state&&"easings"===e.key&&(Pt.updateEasingOptions(),e=Pt["index"],null!==e)&&(Pt.index=null,Pt.list.write(e))},Pt.easingIdWrite=function(e){var t,i,e=e.value;Pt.index!==e&&(Pt.index=e,Pt.requestRendering(),""!==e)&&(e=He.easings.map[e]?.points??[{x:0,y:0},{x:1,y:1}],{startPoint:t,endPoint:i}=u,Pt.curveMap.update(t,...e,i))},Pt.easingIdInput=function(e){Ke.history.save({type:"animation-easing-change",motion:Ke.motion,direction:Ke.direction,target:Ke.target,easingId:Pt.target.easingId}),Pt.target.easingId=e.value,Pt.updateTimeline(Pt.target)},Pt.settingsPointerdown=function(){u.open()},{state:"closed",page:_("#particle"),head:_("#particle-head"),body:_("#particle-body").hide(),info:_("#particle-info"),screen:_("#particle-screen"),marquee:_("#particle-marquee"),duration:_("#particle-duration"),list:_("#particle-list"),dragging:null,target:null,paused:!1,history:null,restartKey:!1,translationKey:0,translationTimer:null,showAxes:!0,showWireframe:!1,showAnchor:!1,background:null,matrix:null,speed:null,zoom:null,zoomTimer:null,scale:null,scaleX:null,scaleY:null,outerWidth:null,outerHeight:null,scrollLeft:null,scrollTop:null,scrollRight:null,scrollBottom:null,centerX:null,centerY:null,centerOffsetX:null,centerOffsetY:null,padding:null,context:null,meta:null,layers:null,emitter:null,initialize:null,open:null,load:null,save:null,close:null,destroy:null,restart:null,undo:null,redo:null,setSpeed:null,setZoom:null,setTarget:null,updateTarget:null,updateTargetItem:null,updateParticleInfo:null,updateHead:null,resize:null,getPointerCoords:null,updateCamera:null,updateTransform:null,updateElements:null,drawElements:null,drawBackground:null,drawCoordinateAxes:null,drawEmitterWireframe:null,drawEmitterAnchor:null,drawAreaWireframe:null,drawElementWireframes:null,drawElementAnchors:null,computeOuterRect:null,selectEmitter:null,requestAnimation:null,updateAnimation:null,stopAnimation:null,requestRendering:null,renderingFunction:null,stopRendering:null,switchWireframe:null,switchAnchor:null,switchPause:null,planToSave:null,saveToConfig:null,loadFromConfig:null,saveToProject:null,loadFromProject:null,webglRestored:null,windowResize:null,themechange:null,datachange:null,keydown:null,restartKeyup:null,headPointerdown:null,viewPointerdown:null,controlPointerdown:null,speedInput:null,durationInput:null,zoomFocus:null,zoomInput:null,screenKeydown:null,screenWheel:null,screenUserscroll:null,screenBlur:null,marqueePointerdown:null,marqueePointermove:null,marqueePointerleave:null,pointerup:null,pointermove:null,listKeydown:null,listPointerdown:null,listSelect:null,listRecord:null,listPopup:null,listChange:null,Emitter:null,Layer:null,Element:null}),Ue=(S.list.create=null,S.list.copy=null,S.list.paste=null,S.list.delete=null,S.list.createIcon=null,S.list.updateIcon=A.list.updateIcon,S.list.createVisibilityIcon=null,S.list.updateVisibilityIcon=A.list.updateVisibilityIcon,S.list.onCreate=null,S.list.onRemove=null,S.list.onDelete=null,S.list.onResume=null,S.initialize=function(){this.screen.addSetScrollMethod(),this.translationTimer=new f({duration:1/0,update:e=>{if("open"!==this.state||null!==this.dragging)return!1;{var i=this.translationKey,a=1.5*f.deltaTime/this.scale;let e=0,t=0;1&i&&(e-=a),2&i&&(t-=a),4&i&&(e+=a),8&i&&(t+=a);var i=this.screen,a=i.scrollLeft,n=i.scrollTop,s=Math.roundTo(this.centerX+e,4),r=Math.roundTo(this.centerY+t,4);this.updateCamera(s,r),this.updateTransform(),i.scrollLeft===a&&i.scrollTop===n||this.requestRendering()}}}),this.zoomTimer=new f({duration:80,update:e=>{if("open"!==this.state)return this.scale=e.end,!1;var{elapsed:e,duration:t,start:i,end:a}=e,e=e/t;this.scale=i*(1-e)+a*e,this.resize(),this.requestRendering()}}),this.padding=800,this.matrix=new Ze;const n=this["list"];n.removable=!0,n.renamable=!0,n.bind(()=>this.layers),n.creators.push(n.createVisibilityIcon),n.updaters.push(n.updateVisibilityIcon),l.processors["particle-layer-create"]=l.processors["particle-layer-delete"]=l.processors["particle-layer-remove"]=(e,t)=>{n.restore(e,t.response)},l.processors["particle-layer-hidden"]=(e,t)=>{var{item:t,oldValue:i,newValue:a}=t;t.hidden="undo"===e?i:a,n.update(),S.requestRendering(),S.planToSave()},window.on("themechange",this.themechange),window.on("datachange",this.datachange),window.on("keydown",this.keydown),this.page.on("resize",this.windowResize),this.head.on("pointerdown",this.headPointerdown),We.canvas.on("webglcontextrestored",this.webglRestored),_("#particle-head-start").on("pointerdown",this.viewPointerdown),_("#particle-control").on("pointerdown",this.controlPointerdown),_("#particle-speed").on("input",this.speedInput),this.duration.on("input",this.durationInput),_("#particle-zoom").on("focus",this.zoomFocus),_("#particle-zoom").on("input",this.zoomInput),this.screen.on("keydown",this.screenKeydown),this.screen.on("wheel",this.screenWheel),this.screen.on("userscroll",this.screenUserscroll),this.screen.on("blur",this.screenBlur),this.marquee.on("pointerdown",this.marqueePointerdown),this.marquee.on("pointermove",this.marqueePointermove),this.marquee.on("pointerleave",this.marqueePointerleave),this.list.on("keydown",this.listKeydown),this.list.on("pointerdown",this.listPointerdown),this.list.on("select",this.listSelect),this.list.on("record",this.listRecord),this.list.on("popup",this.listPopup),this.list.on("change",this.listChange)},S.open=function(e){var t;this.context!==e&&(this.save(),this.close(),S.Element.stage=this,t=e["meta"],e.particle||(e.particle=He.particles[t.guid]),e.particle?(this.state="open",this.context=e,this.meta=t,this.body.show(),this.load(e),this.resize(),this.requestAnimation(),this.requestRendering()):(x.manager.switch("directory"),O.confirm({message:"Failed to read file: "+t.path},[{label:"Confirm"}])))},S.load=function(e){e.editor||(e.editor={target:null,emitter:new S.Emitter(e.particle),history:new l(100),centerX:0,centerY:0,paused:!1});var{particle:e,editor:t}=e;this.layers=e.layers,this.duration.write(e.duration),this.emitter=t.emitter,this.history=t.history,this.centerX=t.centerX,this.centerY=t.centerY,this.switchPause(t.paused),this.list.update(),this.emitter.updateEasing(),this.computeOuterRect(),this.setTarget(t.target)},S.save=function(){var e;"open"===this.state&&(e=this.context["editor"],e.target=this.target,e.emitter=this.emitter,e.history=this.history,e.centerX=this.centerX,e.centerY=this.centerY,e.paused=this.paused)},S.close=function(){"closed"!==this.state&&(this.screen.blur(),this.setTarget(null),this.state="closed",this.context=null,this.meta=null,this.layers=null,this.emitter=null,this.history=null,this.body.hide(),this.stopAnimation(),this.stopRendering())},S.destroy=function(e){e.editor&&(this.context===e&&(this.save(),this.close()),e.editor.emitter.destroy())},S.restart=function(){this.emitter.clear(),this.requestRendering()},S.undo=function(){"open"===this.state&&!this.dragging&&this.history.canUndo()&&this.history.restore("undo")},S.redo=function(){"open"===this.state&&!this.dragging&&this.history.canRedo()&&this.history.restore("redo")},S.setSpeed=function(){const t=_("#particle-speed");return function(e){this.speed=e,t.write(e)}}(),S.setZoom=function(){const i=_("#particle-zoom");return function(t){if(this.zoom!==t){let e;switch(t){case 0:e=.25;break;case 1:e=.5;break;case 2:e=1;break;case 3:e=2;break;case 4:e=4;break;default:return}this.zoom=t,i.write(t),"open"===this.state?((t=this.zoomTimer).start=this.scale,t.end=e,t.elapsed=0,t.add()):this.scale=e}}}(),S.setTarget=function(e){this.target!==e&&(this.target=e,this.updateTargetItem(),this.requestRendering(),e?j.open("particleLayer",e):j.close())},S.updateTarget=function(){var e=this.list.read();e!==this.target&&this.setTarget(e)},S.updateTargetItem=function(){var e,t=this["target"];null!==t&&(e=this["list"],e.read()!==t)&&(e.selectWithNoEvent(t),t)&&e.scrollToSelection()},S.updateParticleInfo=function(){var{emitter:e,info:t}=this,i=I.words;for(const s of e.layers){var a=s.data["name"],n=s.elements["count"];i.push(a+" "+n)}e=i.join("\n");t.textContent!==e&&(t.textContent=e)},S.updateHead=function(){var e,t,i,{page:a,head:n}=this;0!==a.clientWidth&&(a=x.getGroupOfElement(n)["nav"],i=a.rect(),t=(a=a.lastChild.rect()).right-i.left,n.left!==t&&(n.left=t,n.style.left=t+"px"),t=i.right-a.right,n.width!==t)&&(n.width=t,[a,t,n]=n.children,n.style.marginLeft="",a=a.rect(),t=t.rect(),t=(e=n.rect()).left-a.right-t.width,a=a.right-i.left-e.width,i=Math.min(t,a),n.style.marginLeft=i+"px")},S.resize=function(){var e,t,i,a,n,s,r,o,l;"open"===this.state&&0!==this.screen.clientWidth&&(s=this.scale,e=(t=CSS.getDevicePixelContentBoxSize(this.screen)).width,t=t.height,i=e+this.padding,a=t+this.padding,n=Math.round(i*s),s=Math.round(a*s),r=Math.max(e,n),o=Math.max(t,s),l=window.devicePixelRatio,this.outerWidth=r,this.outerHeight=o,this.centerOffsetX=e/2,this.centerOffsetY=t/2,this.scaleX=n/i,this.scaleY=s/a,this.marquee.style.width=r/l+"px",this.marquee.style.height=o/l+"px",We.resize(e,t),this.updateCamera(),this.updateTransform())},S.getPointerCoords=function(){const i={x:0,y:0};return function(e){var e=e.getRelativeCoords(this.marquee),t=window.devicePixelRatio;return i.x=(e.x*t-(this.outerWidth>>1))/this.scaleX,i.y=(e.y*t-(this.outerHeight>>1))/this.scaleY,i}}(),S.updateCamera=function(e=this.centerX,t=this.centerY){var i=this.screen,a=window.devicePixelRatio,e=e*this.scaleX+this.outerWidth/2,t=t*this.scaleY+this.outerHeight/2;i.rawScrollLeft=Math.clamp(e-this.centerOffsetX,0,this.outerWidth-We.width)/a,i.rawScrollTop=Math.clamp(t-this.centerOffsetY,0,this.outerHeight-We.height)/a,i.scrollLeft=(e-(We.width>>1)+1e-4)/a,i.scrollTop=(t-(We.height>>1)+1e-4)/a},S.updateTransform=function(){var e=this.screen,t=window.devicePixelRatio,i=Math.roundTo(e.scrollLeft*t-(this.outerWidth>>1),4),a=Math.roundTo(e.scrollTop*t-(this.outerHeight>>1),4),n=i+We.width,s=a+We.height,i=(this.scrollLeft=i/this.scaleX,this.scrollTop=a/this.scaleY,this.scrollRight=n/this.scaleX,this.scrollBottom=s/this.scaleY,this.matrix.reset().scale(this.scaleX,this.scaleY).translate(-this.scrollLeft,-this.scrollTop),e.rawScrollLeft*t+this.centerOffsetX),a=e.rawScrollTop*t+this.centerOffsetY;this.centerX=Math.roundTo((i-this.outerWidth/2)/this.scaleX,4),this.centerY=Math.roundTo((a-this.outerHeight/2)/this.scaleY,4)},S.updateElements=function(e){this.emitter.update(e*this.speed)},S.drawElements=function(){for(const e of this.emitter.layers)e.data.hidden||e.draw()},S.drawBackground=function(){var e=We;e.clearColor(...this.background.getGLRGBA()),e.clear(e.COLOR_BUFFER_BIT)},S.drawCoordinateAxes=function(){var e,t,i,a,n,s,r,o,l,c,h,d,u,p,m;this.showAxes&&(t=(e=We).arrays[0].float32,i=e.matrix.set(S.matrix),a=-1e4/this.scaleX,d=-1e4/this.scaleY,h=1e4/this.scaleX,r=1e4/this.scaleY,n=i[0],c=i[1],u=i[3],p=i[4],s=i[6],o=c*a+(m=i[7]),l=n*h+s,c=c*h+m,h=u*d+s,d=p*d+m,u=u*r+s,p=p*r+m,t[0]=r=n*a+s,t[1]=o+.5,t[2]=0,t[3]=l,t[4]=c+.5,t[5]=Math.dist(r,o,l,c),t[6]=h+.5,t[7]=d,t[8]=0,t[9]=u+.5,t[10]=p,t[11]=Math.dist(h,d,u,p),i.project(e.flip,e.width,e.height),e.alpha=1,e.blend="normal",m=e.dashedLineProgram.use(),e.bindVertexArray(m.vao),e.uniformMatrix3fv(m.u_Matrix,!1,i),e.uniform4f(m.u_Color,.5,0,1,1),e.bufferData(e.ARRAY_BUFFER,t,e.STREAM_DRAW,0,12),e.drawArrays(e.LINES,0,4))},S.drawEmitterWireframe=function(){let e;var t,i,a,n,s,r,o,l=this.emitter;l.active&&(e=4294967295),void 0!==(e=l.selected?4290838272:e)&&(i=(t=We).arrays[0].float32,a=t.arrays[0].uint32,s=.5/this.scaleX,r=.5/this.scaleY,o=l.outerLeft+s,n=l.outerTop+r,s=l.outerRight-s,l=l.outerBottom-r,i[0]=o,i[1]=n,a[2]=e,i[3]=o,i[4]=l,a[5]=e,i[6]=s,i[7]=l,a[8]=e,i[9]=s,i[10]=n,a[11]=e,r=t.graphicProgram.use(),o=t.matrix.project(t.flip,t.width,t.height).multiply(S.matrix),t.bindVertexArray(r.vao),t.uniformMatrix3fv(r.u_Matrix,!1,o),t.bufferData(t.ARRAY_BUFFER,i,t.STREAM_DRAW,0,12),t.drawArrays(t.LINE_LOOP,0,4))},S.drawEmitterAnchor=function(){var e,t,i,a,n,s,r,o,l=this.emitter;l.selected&&(t=(e=We).arrays[0].float32,i=this.matrix,a=l.startX,l=l.startY,s=i[0],o=i[1],r=i[3],n=i[4],s=s*a+r*l+i[6],r=o*a+n*l+i[7],t[0]=s+.5-8,t[1]=r+.5,t[2]=s+.5+9,t[3]=r+.5,t[4]=s+.5,t[5]=r+.5-8,t[6]=s+.5,t[7]=r+.5+9,e.matrix.project(e.flip,e.width,e.height),e.alpha=1,e.blend="normal",o=e.graphicProgram.use(),e.bindVertexArray(o.vao.a10),e.uniformMatrix3fv(o.u_Matrix,!1,e.matrix),e.bufferData(e.ARRAY_BUFFER,t,e.STREAM_DRAW,0,8),e.vertexAttrib4f(o.a_Color,1,0,0,1),e.drawArrays(e.LINES,0,4))},S.drawAreaWireframe=function(){if(this.showWireframe&&this.target){let t=0;var e,i,a=We,n=a.arrays[0].float32,s=this.target["area"];switch(s.type){case"rectangle":var r=s.width,o=s.height,l=.5/this.scaleX,c=.5/this.scaleY,h=-.5*r+l,d=-.5*o+c,r=Math.max(h,.5*r-l),l=Math.max(d,.5*o-c);n[0]=h,n[1]=d,n[2]=h,n[3]=l,n[4]=r,n[5]=l,n[6]=r,n[7]=d,t=8;break;case"circle":var u=s.radius,p=2*Math.PI/100;for(let e=0;e<100;e++){var m=e*p;n[t]=u*Math.cos(m),n[t+1]=u*Math.sin(m),t+=2}break;default:return}0!==t&&(e=a.graphicProgram.use(),i=a.matrix.project(a.flip,a.width,a.height).multiply(S.matrix),a.bindVertexArray(e.vao.a10),a.uniformMatrix3fv(e.u_Matrix,!1,i),a.bufferData(a.ARRAY_BUFFER,n,a.STREAM_DRAW,0,t),a.vertexAttrib4f(e.a_Color,1,0,0,1),a.drawArrays(a.LINE_LOOP,0,t/2))}},S.drawElementWireframes=function(){if(this.showWireframe){var e,i=We,a=i.arrays[0].float32,n=i.matrix;let t=0;for(const E of this.emitter.layers){var s=E["texture"];if(s instanceof $e){var r=E.elements,o=r.count,l=E.unitWidth,c=E.unitHeight;for(let e=0;e<o;e++){var h=r[e],h=(n.set(S.matrix).translate(h.x,h.y).rotate(h.rotationAngle).scale(h.scaleFactor,h.scaleFactor).translate(-h.anchorX*l,-h.anchorY*c),l),d=n[0],u=n[1],p=n[3],m=n[4],g=n[6],f=n[7],v=g,b=f,y=p*c+g,w=m*c+f,p=d*h+p*c+g,m=u*h+m*c+f,d=d*h+g,g=u*h+f,u=Math.atan2(b-w,v-y),h=Math.atan2(w-m,y-p),f=Math.atan2(m-g,p-d),x=Math.atan2(g-b,d-v),k=.5*Math.cos(u),u=.5*Math.sin(u),T=.5*Math.cos(h),h=.5*Math.sin(h),I=.5*Math.cos(f),f=.5*Math.sin(f),C=.5*Math.cos(x),x=.5*Math.sin(x),v=v+C-k,b=b+x-u,y=y+k-T,k=w+u-h,w=p+T-I,u=m+h-f,p=d+I-C,T=g+f-x;a[t]=v,a[t+1]=b,a[t+2]=y,a[t+3]=k,a[t+4]=y,a[t+5]=k,a[t+6]=w,a[t+7]=u,a[t+8]=w,a[t+9]=u,a[t+10]=p,a[t+11]=T,a[t+12]=p,a[t+13]=T,a[t+14]=v,a[t+15]=b,t+=16}}}0!==t&&(e=i.graphicProgram.use(),n.project(i.flip,i.width,i.height),i.bindVertexArray(e.vao.a10),i.uniformMatrix3fv(e.u_Matrix,!1,n),i.bufferData(i.ARRAY_BUFFER,a,i.STREAM_DRAW,0,t),i.vertexAttrib4f(e.a_Color,1,1,1,1),i.drawArrays(i.LINES,0,t/2))}},S.drawElementAnchors=function(){if(this.showAnchor){var e,a=We,n=a.arrays[0].float32,s=a.arrays[1].float32,r=a.matrix;let t=0,i=0;for(const f of this.emitter.layers){var o=f.elements,l=o.count,c=f.unitWidth,h=f.unitHeight;for(let e=0;e<l;e++){var d=o[e],u=(r.set(S.matrix).translate(d.x,d.y),r[6]),p=r[7],m=(n[t]=u+.5-8,n[t+1]=p+.5,n[t+2]=u+.5+9,n[t+3]=p+.5,n[t+4]=u+.5,n[t+5]=p+.5-8,n[t+6]=u+.5,n[t+7]=p+.5+9,t+=8,d.anchorX),g=d.anchorY;.5===m&&.5===g||(r.rotate(d.rotationAngle).scale(d.scaleFactor,d.scaleFactor).translate((.5-m)*c,(.5-g)*h),d=r[6],m=r[7],s[i]=u+.5,s[i+1]=p+.5,s[i+2]=d+.5,s[i+3]=m+.5,i+=4)}}0!==t&&(e=a.graphicProgram.use(),r.project(a.flip,a.width,a.height),a.bindVertexArray(e.vao.a10),a.uniformMatrix3fv(e.u_Matrix,!1,r),a.bufferData(a.ARRAY_BUFFER,n,a.STREAM_DRAW,0,t),a.vertexAttrib4f(e.a_Color,1,0,0,1),a.drawArrays(a.LINES,0,t/2),0!==i)&&(a.bufferData(a.ARRAY_BUFFER,s,a.STREAM_DRAW,0,i),a.vertexAttrib4f(e.a_Color,0,1,0,1),a.drawArrays(a.LINES,0,i/2))}},S.computeOuterRect=function(){let e=1/0,t=1/0,i=-1/0,a=-1/0;var n,s,r=this.emitter,o=r.startX,l=r.startY;for({area:n}of r.data.layers)switch(n.type){case"edge":continue;case"point":e=Math.min(e,n.x),t=Math.min(t,n.y),i=Math.max(i,n.x),a=Math.max(a,n.y);break;case"rectangle":e=Math.min(e,n.x-.5*n.width),t=Math.min(t,n.y-.5*n.height),i=Math.max(i,n.x+.5*n.width),a=Math.max(a,n.y+.5*n.height);continue;case"circle":e=Math.min(e,n.x-n.radius),t=Math.min(t,n.y-n.radius),i=Math.max(i,n.x+n.radius),a=Math.max(a,n.y+n.radius);continue}e>i?e=i=0:i-e<32&&(s=32-(i-e),e+=-s>>1,i+=s>>1),t>a?t=a=0:a-t<32&&(s=32-(a-t),t+=-s>>1,a+=s>>1),r.outerLeft=o+e,r.outerTop=l+t,r.outerRight=o+i,r.outerBottom=l+a,0===e&&(r.active=!1,r.selected=!1,this.requestRendering())},S.selectEmitter=function(e,t){var i=this.emitter;return e>=i.outerLeft&&t>=i.outerTop&&e<i.outerRight&&t<i.outerBottom},S.requestAnimation=function(){"open"!==this.state||this.paused||f.appendUpdater("stageAnimation",this.updateAnimation)},S.updateAnimation=function(e){S.updateElements(e),S.updateParticleInfo(),f.updaters.stageRendering!==S.renderingFunction&&S.renderingFunction()},S.stopAnimation=function(){f.removeUpdater("stageAnimation",this.updateAnimation)},S.requestRendering=function(){"open"===this.state&&f.appendUpdater("stageRendering",this.renderingFunction)},S.renderingFunction=function(){We.width*We.height!=0&&(S.drawBackground(),S.drawElements(),S.drawCoordinateAxes(),S.drawAreaWireframe(),S.drawElementWireframes(),S.drawElementAnchors(),S.drawEmitterWireframe(),S.drawEmitterAnchor())},S.stopRendering=function(){f.removeUpdater("stageRendering",this.renderingFunction)},S.switchWireframe=function(){const t=_("#particle-view-wireframe");return function(e=!this.showWireframe){e?t.addClass("selected"):t.removeClass("selected"),this.showWireframe=e,this.requestRendering()}}(),S.switchAnchor=function(){const t=_("#particle-view-anchor");return function(e=!this.showAnchor){e?t.addClass("selected"):t.removeClass("selected"),this.showAnchor=e,this.requestRendering()}}(),S.switchPause=function(){const t=_("#particle-control-pause");return function(e=!this.paused){(this.paused=e)?(t.addClass("selected"),this.stopAnimation()):(t.removeClass("selected"),this.requestAnimation())}}(),S.planToSave=function(){R.planToSave(this.meta)},S.saveToConfig=function(e){e.colors.particleBackground=this.background.hex},S.loadFromConfig=function(e){this.background=new a(e.colors.particleBackground,()=>this.requestRendering())},S.saveToProject=function(e){e=e.particle;e.wireframe=this.showWireframe??e.wireframe,e.anchor=this.showAnchor??e.anchor,e.speed=this.speed??e.speed,e.zoom=this.zoom??e.zoom},S.loadFromProject=function(e){e=e.particle;this.switchWireframe(e.wireframe),this.switchAnchor(e.anchor),this.setSpeed(e.speed),this.setZoom(e.zoom)},S.webglRestored=function(e){"open"===S.state&&S.requestRendering()},S.windowResize=function(e){this.updateHead(),"open"===this.state&&(this.resize(),this.updateCamera(),this.requestRendering())}.bind(S),S.themechange=function(e){this.requestRendering()}.bind(S),S.datachange=function(e){"open"===S.state&&"easings"===e.key&&S.emitter.updateEasing()},S.keydown=function(e){if("open"===S.state&&null===S.dragging&&!e.cmdOrCtrlKey&&!e.altKey)switch(e.code){case"KeyR":S.restartKey||(S.restartKey=!0,S.restart(),_("#particle-control-restart").addClass("selected"),window.on("keyup",S.restartKeyup),window.on("blur",S.restartKeyup));break;case"Space":S.switchPause()}},S.restartKeyup=function(e){if(S.restartKey)switch(e.code){case"KeyR":case void 0:S.restartKey&&(S.restartKey=!1,_("#particle-control-restart").removeClass("selected"),window.off("keyup",S.restartKeyup),window.off("blur",S.restartKeyup))}},S.headPointerdown=function(e){e.target instanceof HTMLInputElement||(e.preventDefault(),document.activeElement!==S.screen&&S.screen.focus())},S.viewPointerdown=function(e){if(0===e.button){e=e.target;if("ITEM"===e.tagName)switch(e.getAttribute("value")){case"wireframe":return S.switchWireframe();case"anchor":return S.switchAnchor()}}},S.controlPointerdown=function(e){if(0===e.button){e=e.target;if("ITEM"===e.tagName)switch(e.getAttribute("value")){case"restart":return S.restart();case"pause":return S.switchPause()}}},S.speedInput=function(e){S.speed=this.read()},S.durationInput=function(e){var t=this.read();S.emitter.data.duration=t,S.emitter.duration=t||1/0,S.planToSave()},S.zoomFocus=function(e){S.screen.focus()},S.zoomInput=function(e){S.setZoom(this.read())},S.screenKeydown=function(e){if("open"===this.state&&null===this.dragging&&!e.cmdOrCtrlKey&&!e.altKey)switch(e.code){case"Minus":case"NumpadSubtract":this.setZoom(this.zoom-1);break;case"Equal":case"NumpadAdd":this.setZoom(this.zoom+1);break;case"Digit0":case"Numpad0":this.setZoom(2)}}.bind(S),S.screenWheel=function(e){"open"===this.state&&null===this.dragging&&(e.preventDefault(),0!==e.deltaY)&&(e=0<e.deltaY?-1:1,this.setZoom(this.zoom+e))}.bind(S),S.screenUserscroll=function(e){"open"===this.state&&(this.screen.rawScrollLeft=this.screen.scrollLeft,this.screen.rawScrollTop=this.screen.scrollTop,this.updateTransform(),this.requestRendering())}.bind(S),S.screenBlur=function(e){this.marqueePointerleave()}.bind(S),S.marqueePointerdown=function(e){if(!this.dragging)switch(e.button){case 0:if(!e.altKey){var t=this["emitter"];if(t.active){if(t.selected=!0,this.paused)break;(this.dragging=e).mode="object-move",e.enabled=!1,e.startX=t.startX,e.startY=t.startY,window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}else t.selected=!1;this.requestRendering();break}case 2:(this.dragging=e).mode="scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}}.bind(S),S.marqueePointermove=function(e){var t;this.dragging||(this.marquee.pointerevent=e,{x:e,y:t}=this.getPointerCoords(e),e=this.selectEmitter(e,t),this.emitter.active!==e&&(this.emitter.active=e,this.requestRendering()))}.bind(S),S.marqueePointerleave=function(e){this.marquee.pointerevent&&(this.marquee.pointerevent=null,this.emitter?.active)&&(this.emitter.active=!1,this.requestRendering())}.bind(S),S.pointerup=function(e){var t=S["dragging"];if(null!==t&&t.relate(e=void 0===e?t:e)){switch(t.mode){case"object-move":break;case"scroll":pt.close("cursor-grab")}S.dragging=null,window.off("pointerup",S.pointerup),window.off("pointermove",S.pointermove)}},S.pointermove=function(e){var t=S["dragging"];if(t.relate(e))switch(t.mode){case"object-move":if(!t.enabled){var i=e.clientX-t.clientX,a=e.clientY-t.clientY;if(!(4<Math.sqrt(i**2+a**2)||500<=e.timeStamp-t.timeStamp))break;t.enabled=!0}var i=S.emitter,a=(e.clientX-t.clientX)/S.scaleX,n=(e.clientY-t.clientY)/S.scaleY,a=Math.round(t.startX+a),n=Math.round(t.startY+n);i.startX===a&&i.startY===n||(i.startX=a,i.startY=n,S.computeOuterRect());break;case"scroll":a=e.clientX-t.clientX,i=e.clientY-t.clientY;S.screen.setScroll(t.scrollLeft-a,t.scrollTop-i)}},S.listKeydown=function(e){if(this.data){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":this.copy(t),this.delete(t);break;case"KeyC":this.copy(t);break;case"KeyV":this.paste()}else switch(e.code){case"Delete":this.delete(t);break;case"Escape":S.setTarget(null)}}},S.listPointerdown=function(e){var t;0===e.button&&"VISIBILITY-ICON"===(e=e.target).tagName&&(e=e.parentNode["item"],t=e["hidden"],e.hidden=!t,this.update(),this.dispatchChangeEvent(),S.requestRendering(),S.history.save({type:"particle-layer-hidden",item:e,oldValue:t,newValue:!t}))},S.listSelect=function(e){S.setTarget(e.value)},S.listRecord=function(e){var t=e.value;switch(t.type){case"rename":var i=j.particleLayer,a=i.nameBox,{item:n,oldValue:s,newValue:r}=t;a.write(r),S.updateParticleInfo(),S.requestRendering(),S.history.save({type:"inspector-change",editor:i,target:n,changes:[{input:a,oldValue:s,newValue:r}]});break;case"create":S.history.save({type:"particle-layer-create",response:t});break;case"delete":S.history.save({type:"particle-layer-delete",response:t});break;case"remove":S.history.save({type:"particle-layer-remove",response:t})}},S.listPopup=function(e){const t=e.value;var i=N.createGetter("menuParticleList");let a,n,s,r;r=t?(a=!0,n=Clipboard.has("yami.particle.layer"),s=!0):(a=!1,n=Clipboard.has("yami.particle.layer"),s=!1),ve.popup({x:e.clientX,y:e.clientY},[{label:i("insert"),click:()=>{this.create(t)}},{type:"separator"},{label:i("cut"),accelerator:p("X"),enabled:a,click:()=>{this.copy(t),this.delete(t)}},{label:i("copy"),accelerator:p("C"),enabled:a,click:()=>{this.copy(t)}},{label:i("paste"),accelerator:p("V"),enabled:n,click:()=>{this.paste(t)}},{label:i("delete"),accelerator:"Delete",enabled:s,click:()=>{this.delete(t)}},{label:i("rename"),accelerator:"F2",enabled:r,click:()=>{this.rename(t)}}])},S.listChange=function(e){S.planToSave()},S.list.create=function(e){this.addNodeTo(j.particleLayer.create(),e)},S.list.copy=function(e){e&&Clipboard.write("yami.particle.layer",e)},S.list.paste=function(e){var t=Clipboard.read("yami.particle.layer");t&&this.data&&this.addNodeTo(t,e)},S.list.delete=function(e){e&&this.deleteNode(e)},S.list.createIcon=function(e){var t=document.createElement("node-icon"),i=R.getPath(e.image);return i?(t.addClass("icon-particle-image"),De.prototype.setIconClip(t,i,0,0,-e.hframes,-e.vframes)):t.textContent="",t},S.list.createVisibilityIcon=function(e){var e=e["element"],t=document.createElement("visibility-icon");t.style.right="0",e.appendChild(t),e.hiddenIcon=t,e.hiddenState=null},S.list.onCreate=function(){S.emitter.updateLayers(),S.computeOuterRect(),S.requestRendering()},S.list.onRemove=function(){S.emitter.updateLayers(),S.requestRendering()},S.list.onDelete=function(){S.updateTarget(),S.emitter.updateLayers(),S.computeOuterRect(),S.requestRendering()},S.list.onResume=function(){S.emitter.updateLayers(),S.computeOuterRect(),S.requestRendering()},S.Emitter=class{data;startX;startY;angle;scale;speed;opacity;elapsed;duration;matrix;layers;constructor(e){var t=e.layers,i=t.length,a=new Array(i);for(let e=0;e<i;e++)a[e]=new S.Layer(this,t[e]);this.data=e,this.startX=0,this.startY=0,this.angle=0,this.scale=1,this.speed=1,this.opacity=1,this.elapsed=0,this.duration=e.duration||1/0,this.matrix=null,this.layers=a}getLayer(e){for(const t of this.layers)if(t.data===e)return t}updateLayers(){var i=new Map;for(const t of this.layers)i.set(t.data,t);var a=this.data.layers,e=a.length,n=new Array(e);for(let t=0;t<e;t++){var s=a[t];let e=i.get(s);e?i.delete(s):e=new S.Layer(this,s),n[t]=e}for(const r of i)r[1].destroy();this.layers=n}update(e){(this.elapsed+=e)>=this.duration&&this.clear(),this.emitParticles(e),this.updateParticles(e)}emitParticles(e){for(const t of this.layers)t.emit(e)}updateParticles(e){let t=!1;for(const i of this.layers)i.update(e)&&(t=!0);return t}draw(){for(const e of this.layers)e.draw()}updateEasing(){for(const e of this.layers)e.updateEasing()}isEmpty(){for(var{elements:e}of this.layers)if(0!==e.count)return!1;return!0}clear(){for(const e of this.layers)e.clear();this.elapsed=0}destroy(){for(const e of this.layers)e.destroy()}},S.Layer=class Ti{emitter;data;texture;textureWidth;textureHeight;unitWidth;unitHeight;elapsed;capacity;count;stocks;elements;reserves;constructor(e,t){this.emitter=e,this.data=t,this.texture=null,this.textureWidth=0,this.textureHeight=0,this.unitWidth=0,this.unitHeight=0,this.elapsed=t.interval-t.delay,this.capacity=0,this.count=0,this.stocks=0,this.elements=[],this.elements.count=0,this.reserves=[],this.reserves.count=0,this.updateCount(),this.updateEasing(),this.loadTexture()}emit(a){let n=this.stocks;if(0!==n){this.elapsed+=a*this.emitter.speed;var a=this.data,s=a.interval;let i=Math.floor(this.elapsed/s);if(0<i){this.elapsed-=s*i||0;var r=this.elements,o=a.maximum;let t=r.count;if(t===o)return;var l=this.reserves;let e=l.count;e:{for(;0<e;){var c=l[--e];if((r[t++]=c).initialize(),--i*--n==0)break e}for(let e=this.capacity;e<o;e++)if(r[t++]=new S.Element(this),this.capacity=e+1,--i*--n==0)break e}r.count=t,l.count=e,void(this.stocks=n)}}}update(t){var i=this.elements,a=i.count;if(0===a)return!1;var n=this.reserves,s=n.count;let r=0;t*=this.emitter.speed;for(let e=0;e<a;e++){var o=i[e];!1!==o.update(t)?0!==r&&(i[e-r]=o):(n[s+r]=o,r++)}return 0!==r&&(i.count=a-r,n.count=s+r),!0}draw(){var e,t,i,a,n,s=We,r=this.data,o=this.texture,l=this.elements,c=l.count;let h=0;switch(r.sort){case"youngest-in-front":for(let e=0;e<c;e++)l[e].draw(h),h+=20;break;case"oldest-in-front":for(let e=c-1;0<=e;e--)l[e].draw(h),h+=20;break;case"by-scale-factor":{var{min:d,abs:u,round:p}=Math,m=Ti.layers,g=Ti.zeros,f=Ti.sharedUint32A,v=Ti.sharedUint32B;let i=0,t=2;for(let e=0;e<c;e++){var b=d(262143,p(26214.3*u(l[e].scaleFactor)));0===g[b]?(g[b]=t,m[i++]=b):v[f[b]+1]=t,f[b]=t,v[t++]=e,v[t++]=0}var y=new Uint32Array(m.buffer,0,i).sort();for(let t=0;t<i;t++){var w=y[t];let e=g[w];for(g[w]=0;l[v[e]].draw(h),h+=20,0!==(e=v[e+1]););}break}}0!==h&&(s.alpha=this.emitter.opacity,s.blend=r.blend,e=s.particleProgram.use(),t=s.arrays[0].float32,n=s.matrix.project(s.flip,s.width,s.height).multiply(S.Element.stage.matrix),s.bindVertexArray(e.vao),s.uniformMatrix3fv(e.u_Matrix,!1,n),"texture"!==r.color.mode?s.uniform1i(e.u_Mode,0):(r=(n=r.color.tint)[0]/255,i=n[1]/255,a=n[2]/255,n=n[3]/255,s.uniform1i(e.u_Mode,1),s.uniform4f(e.u_Tint,r,i,a,n)),s.bufferData(s.ARRAY_BUFFER,t,s.STREAM_DRAW,0,h),s.bindTexture(s.TEXTURE_2D,o.base.glTexture),s.drawElements(s.TRIANGLES,h/20*6,s.UNSIGNED_INT,0),s.alpha=1,s.blend="normal")}setMaximum(e){var{elements:t,reserves:i}=this;this.capacity=Math.min(this.capacity,e),t.length=Math.min(t.length,e),t.count=Math.min(t.count,e),i.length=Math.min(i.length,e),i.count=Math.min(i.count,e-t.count);let a=i.count;for(;void 0!==i[a];)i[a++]=void 0}loadTexture(){var e=this.data.image;const t=this.texture;if(t instanceof $e){if(t.complete&&t.base.guid===e)return void this.calculateElementSize();t.destroy(),this.texture=null,this.unitWidth=0,this.unitHeight=0}if(e){const t=new $e(e);if(t.complete)return this.texture=t,this.calculateElementSize(),void S.Element.stage.requestRendering();(this.texture=t).on("load",()=>{this.texture===t?(this.texture=t,this.calculateElementSize(),S.Element.stage.requestRendering(),delete this.draw):t.destroy()})}this.draw=Function.empty}calculateElementSize(){var{data:e,texture:t}=this;this.textureWidth=t.width,this.textureHeight=t.height,this.unitWidth=Math.floor(t.width/e.hframes),this.unitHeight=Math.floor(t.height/e.vframes)}resizeElementIndices(){var e=this.data,t=e.hframes,i=e.vframes,a=this.elements,n=a.count;for(let e=0;e<n;e++){var s=a[e];s.hindex%=t,s.vindex%=i}}updateCount(){let e=this.data["count"];0===e&&(e=1e16),this.count=e,this.stocks=e}updateEasing(){var e=this.data["color"];"easing"===e.mode&&(this.easing=u.get(e.easingId))}updateElementMethods(){this.clear();var t=this.reserves,i=t.count;for(let e=0;e<i;e++)t[e].updateMethods()}clear(){var t=this.elements,i=this.reserves,a=t.count;let n=i.count;for(let e=0;e<a;e++)i[n++]=t[e];t.count=0,i.count=n,this.elapsed=this.data.interval-this.data.delay,this.stocks=this.count}destroy(){this.texture instanceof $e&&(this.texture.destroy(),this.texture=null)}static layers=new Uint32Array(262144);static zeros=new Uint32Array(262144);static sharedUint32A=new Uint32Array(We.arrays[0].uint32.buffer,23068672,262144);static sharedUint32B=new Uint32Array(We.arrays[0].uint32.buffer,24117248,262144)},S.Element=class Ii{emitter;layer;data;elapsed;lifetime;fadeout;fadeoutTime;x;y;anchorX;anchorY;movementSpeedX;movementSpeedY;movementAccelX;movementAccelY;rotationAngle;rotationSpeed;rotationAccel;scaleFactor;scaleSpeed;scaleAccel;hindex;vindex;opacity;color;setStartPosition;postProcessing;setStartColor;updateColor;constructor(e){this.emitter=e.emitter,this.layer=e,this.data=e.data,this.elapsed=0,this.lifetime=0,this.fadeout=0,this.fadeoutTime=0,this.x=0,this.y=0,this.anchorX=0,this.anchorY=0,this.movementSpeedX=0,this.movementSpeedY=0,this.movementAccelX=0,this.movementAccelY=0,this.rotationAngle=0,this.rotationSpeed=0,this.rotationAccel=0,this.scaleFactor=0,this.scaleSpeed=0,this.scaleAccel=0,this.hindex=0,this.vindex=0,this.opacity=0,this.color=new Uint32Array(5),this.updateMethods(),this.initialize()}initialize(){var e=this["emitter"],{lifetime:t,lifetimeDev:i,fadeout:a,anchor:n,rotation:s,movement:r,scale:o,hframes:l,vframes:c}=this.data,t=(this.elapsed=0,this.lifetime=t+i*(2*Math.random()-1),this.fadeout=a,this.fadeoutTime=this.lifetime-a,this.scaleFactor=Math.randomBetween(o.factor[0],o.factor[1])*e.scale,this.scaleSpeed=Math.randomBetween(o.speed[0],o.speed[1])/1e3*e.scale,this.scaleAccel=Math.randomBetween(o.accel[0],o.accel[1])/1e6*e.scale,this.anchorX=Math.randomBetween(n.x[0],n.x[1]),this.anchorY=Math.randomBetween(n.y[0],n.y[1]),this.rotationAngle=Math.radians(Math.randomBetween(s.angle[0],s.angle[1])),this.rotationSpeed=Math.radians(Math.randomBetween(s.speed[0],s.speed[1]))/1e3,this.rotationAccel=Math.radians(Math.randomBetween(s.accel[0],s.accel[1]))/1e6,Math.radians(Math.randomBetween(r.angle[0],r.angle[1]))+e.angle),i=Math.randomBetween(r.speed[0],r.speed[1])/1e3,a=(this.movementSpeedX=i*Math.cos(t),this.movementSpeedY=i*Math.sin(t),Math.radians(Math.randomBetween(r.accelAngle[0],r.accelAngle[1]))+e.angle),o=Math.randomBetween(r.accel[0],r.accel[1])/1e6,n=(this.movementAccelX=o*Math.cos(a),this.movementAccelY=o*Math.sin(a),Math.floor(Math.random()*l*c));this.hindex=n%l,this.vindex=Math.floor(n/l),this.opacity=1,this.setStartPosition(t),this.setStartColor()}update(e){return this.elapsed+=e,this.scaleSpeed+=this.scaleAccel*e,this.scaleFactor+=this.scaleSpeed*e,this.rotationSpeed+=this.rotationAccel*e,this.rotationAngle+=this.rotationSpeed*e,this.movementSpeedX+=this.movementAccelX*e,this.movementSpeedY+=this.movementAccelY*e,this.x+=this.movementSpeedX*e,this.y+=this.movementSpeedY*e,this.updateColor(),this.postProcessing()}draw(e){var t=this.layer,i=t.unitWidth,a=t.unitHeight,n=t.textureWidth,t=t.textureHeight,s=We.arrays[0].float32,r=We.arrays[0].uint32,o=We.matrix.reset().translate(this.x,this.y).rotate(this.rotationAngle).scale(this.scaleFactor,this.scaleFactor).translate(-this.anchorX*i,-this.anchorY*a),l=i,c=a,h=o[0],d=o[1],u=o[3],p=o[4],m=o[6],o=o[7],g=this.hindex*i,f=this.vindex*a,v=this.getColorInt(),b=g/n,y=f/t,g=(g+i)/n,i=(f+a)/t;s[e]=m,s[e+1]=o,s[e+2]=b,s[e+3]=y,r[e+4]=v,s[e+5]=u*c+m,s[e+6]=p*c+o,s[e+7]=b,s[e+8]=i,r[e+9]=v,s[e+10]=h*l+u*c+m,s[e+11]=d*l+p*c+o,s[e+12]=g,s[e+13]=i,r[e+14]=v,s[e+15]=h*l+m,s[e+16]=d*l+o,s[e+17]=g,s[e+18]=y,r[e+19]=v}getColorInt(){var e,t,i,a,n=this["color"];return n.changed&&(n.changed=!1,e=n[0],t=n[1],i=n[2],a=Math.round(n[3]*this.opacity),n[4]=e+256*(t+256*(i+256*a))),n[4]}updateMethods(){var{area:e,color:t}=this.data;switch(e.type){case"point":this.setStartPosition=this.setStartPositionPoint,this.postProcessing=this.postProcessingCommon;break;case"rectangle":this.setStartPosition=this.setStartPositionRectangle,this.postProcessing=this.postProcessingCommon;break;case"circle":this.setStartPosition=this.setStartPositionCircle,this.postProcessing=this.postProcessingCommon;break;case"edge":this.setStartPosition=this.setStartPositionEdge,this.postProcessing=this.postProcessingEdge}switch(t.mode){case"fixed":this.setStartColor=this.setStartColorFixed,this.updateColor=Function.empty;break;case"random":this.setStartColor=this.setStartColorRandom,this.updateColor=Function.empty;break;case"easing":void 0===this.color.start&&(this.color.start=new Uint8Array(4),this.color.end=new Uint8Array(4)),this.setStartColor=this.setStartColorEasing,this.updateColor=this.updateColorEasing;break;case"texture":this.setStartColor=this.setStartColorTexture,this.updateColor=Function.empty}}transformStartPosition(){var e,t,i,a,n,s,r,o=this.emitter["matrix"];null!==o&&(e=o[0],t=o[1],i=o[3],a=o[4],n=o[6],o=o[7],{x:s,y:r}=this,this.x=e*s+i*r+n,this.y=t*s+a*r+o)}setStartPositionPoint(){var e=this["emitter"],t=this.data["area"];this.x=e.startX+t.x,this.y=e.startY+t.y,this.transformStartPosition()}setStartPositionRectangle(){var e=this["emitter"],t=this.data["area"],i=e.startX+t.x,e=e.startY+t.y,a=t.width/2,t=t.height/2;this.x=Math.randomBetween(i-a,i+a),this.y=Math.randomBetween(e-t,e+t),this.transformStartPosition()}setStartPositionCircle(){var e=this["emitter"],t=this.data["area"],i=e.startX+t.x,e=e.startY+t.y,a=Math.random()*Math.PI*2,t=Math.random()*t.radius;this.x=i+t*Math.cos(a),this.y=e+t*Math.sin(a),this.transformStartPosition()}setStartPositionEdge(e){var t,i=Ii.stage,a=i.scrollLeft,n=i.scrollTop,s=i.scrollRight,i=i.scrollBottom,r=s-a,o=i-n,l=Math.abs(Math.sin(e)*r),l=l/(l+Math.abs(Math.sin(e-Math.PI/2)*o)),e=Math.random();e<l?(t=0<=this.movementSpeedY,this.x=a+e/l*r,this.y=t?n:i,r=this.computeBoundingRectangle(),this.x-=(r[0]+r[2])/2-this.x,this.y-=t?r[3]-this.y:r[1]-this.y):(i=0<=this.movementSpeedX,this.y=n+(e-l)/(1-l)*o,this.x=i?a:s,t=this.computeBoundingRectangle(),this.y-=(t[1]+t[3])/2-this.y,this.x-=i?t[2]-this.x:t[0]-this.x)}postProcessingCommon(){if(this.elapsed>=this.lifetime)return!1;var e;this.elapsed>this.fadeoutTime&&(e=(this.elapsed-this.fadeoutTime)/this.fadeout,this.opacity=Math.max(1-e,0),this.color.changed=!0)}postProcessingEdge(){var e=Ii.stage,t=this.computeBoundingRectangle();if(!(t[0]<e.scrollRight&&t[1]<e.scrollBottom&&t[2]>e.scrollLeft&&t[3]>e.scrollTop&&this.elapsed<this.lifetime))return this.appeared||500<this.elapsed||this.elapsed>=this.lifetime?this.appeared=!1:void 0;this.appeared=!0,this.elapsed>this.fadeoutTime&&(t=(this.elapsed-this.fadeoutTime)/this.fadeout,this.opacity=Math.max(1-t,0),this.color.changed=!0)}computeBoundingRectangle(){var e=this.layer,t=e.unitWidth,e=e.unitHeight,i=We.matrix.reset().translate(this.x,this.y).rotate(this.rotationAngle).scale(this.scaleFactor,this.scaleFactor).translate(-this.anchorX*t,-this.anchorY*e),a=i[0],n=i[1],s=i[3],r=i[4],o=i[6],i=i[7],l=o,c=i,h=s*e+o,d=r*e+i,s=a*t+s*e+o,r=n*t+r*e+i,e=a*t+o,a=n*t+i,o=Ii.sharedFloat64Array;return o[0]=Math.min(l,h,s,e),o[1]=Math.min(c,d,r,a),o[2]=Math.max(l,h,s,e),o[3]=Math.max(c,d,r,a),o}setStartColorFixed(){var e=this.data.color["rgba"],t=this["color"];t.changed=!0,t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]}setStartColorRandom(){var{min:e,max:t}=this.data.color,i=this["color"];i.changed=!0,i[0]=Math.randomBetween(e[0],t[0]),i[1]=Math.randomBetween(e[1],t[1]),i[2]=Math.randomBetween(e[2],t[2]),i[3]=Math.randomBetween(e[3],t[3])}setStartColorEasing(){var{startMin:e,startMax:t,endMin:i,endMax:a}=this.data.color,{start:n,end:s}=this.color;n[0]=Math.randomBetween(e[0],t[0]),n[1]=Math.randomBetween(e[1],t[1]),n[2]=Math.randomBetween(e[2],t[2]),n[3]=Math.randomBetween(e[3],t[3]),s[0]=Math.randomBetween(i[0],a[0]),s[1]=Math.randomBetween(i[1],a[1]),s[2]=Math.randomBetween(i[2],a[2]),s[3]=Math.randomBetween(i[3],a[3])}updateColorEasing(){var e=this.layer["easing"],t=this["color"],{start:i,end:a}=t,n=Ii.sharedClampedArray,e=Math.min(e.map(this.elapsed/this.lifetime),1);t.changed=!0,n[0]=i[0]*(1-e)+a[0]*e,n[1]=i[1]*(1-e)+a[1]*e,n[2]=i[2]*(1-e)+a[2]*e,n[3]=i[3]*(1-e)+a[3]*e,t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]}setStartColorTexture(){var e=this["color"];e.changed=!0,e[3]=255}static stage;static sharedFloat64Array=new Float64Array(4);static sharedClampedArray=new Uint8ClampedArray(4)},{state:"closed",page:_("#fileTileset"),head:_("#palette-head"),body:_("#palette-body"),window:_("#palette-frame").hide(),canvas:_("#palette-canvas"),context:null,screen:_("#palette-screen"),marquee:_("#palette-marquee"),symbol:null,meta:null,tileset:null,images:null,priorities:null,dragging:null,explicit:!1,editing:!1,scrollable:!1,showGrid:!0,activeIndex:null,openIndex:null,gridColor:null,zoom:null,zoomTimer:null,scale:null,scaleX:null,scaleY:null,scaledTileWidth:null,scaledTileHeight:null,outerWidth:null,outerHeight:null,screenWidth:null,screenHeight:null,scrollLeft:null,scrollTop:null,scrollRight:null,scrollBottom:null,centerOffsetX:null,centerOffsetY:null,paddingLeft:null,paddingTop:null,centerX:null,centerY:null,markCanvas:null,tilesetMap:{},initialize:null,open:null,close:null,suspend:null,resume:null,setZoom:null,setImage:null,setSize:null,setTileSize:null,loadImages:null,updateHead:null,resize:null,getTileCoords:null,updateCamera:null,updateTransform:null,updateBackground:null,createMarkCanvas:null,drawTileset:null,drawTiles:null,drawTileGrid:null,drawPriorities:null,editAutoTile:null,copyAutoTile:null,pasteAutoTile:null,deleteAutoTile:null,selectTiles:null,copyTilesFromScene:null,flipTiles:null,openSelection:null,editSelection:null,scrollToSelection:null,requestRendering:null,renderingFunction:null,stopRendering:null,skipScrollEvent:null,switchScroll:null,switchEdit:null,saveToProject:null,loadFromProject:null,windowResize:null,themechange:null,headPointerdown:null,toolbarPointerdown:null,zoomFocus:null,zoomInput:null,screenKeydown:null,screenWheel:null,screenUserscroll:null,screenBlur:null,marqueePointerdown:null,marqueePointermove:null,marqueePointerleave:null,marqueeDoubleclick:null,marqueePopup:null,pointerup:null,pointermove:null}),k=(Ue.initialize=function(){this.screen.addScrollbars(),this.context=this.canvas.getContext("2d",{desynchronized:!0}),this.images={},this.zoomTimer=new f({duration:80,update:e=>{if("open"!==this.state)return this.scale=e.end,!1;var{elapsed:e,duration:t,start:i,end:a}=e,e=e/t;this.scale=i*(1-e)+a*e,this.resize(),this.requestRendering()}});var e=this.marquee;const o=document.createElement("selection"),l=document.createElement("selection"),c={source:o,destination:l};o.id="source-selection",l.id="destination-selection",e.customSelect=function(e,t,i){var e=c[e],a=this.scaleX,n=this.scaleY,s=t*a,r=i*n;if(e.x=t,e.y=i,e===l&&o.x===t&&o.y===i)return e.remove();e.parentNode||this.appendChild(e),e.style.left=s+"px",e.style.top=r+"px",e.style.width=a+"px",e.style.height=n+"px"},e.customUnselect=function(e){c[e].remove()},e.customShiftAutoTile=function(){o.remove(),l.remove();var e,t,i,{x:a,y:n}=o,{x:s,y:r}=l;a===s&&n===r||(e=(i=Ue.tileset).tiles,t=i.priorities,r=s+r*(s=i.width),e[i=a+n*s]&&(e[r]?(a=e[i],n=t[i],e[i]=e[r],t[i]=t[r],e[r]=a,t[r]=n):(e[r]=e[i],t[r]=t[i],e[i]=0,t[i]=0)))},window.on("themechange",this.themechange),this.page.on("resize",this.windowResize),_("#fileTileset-general-detail").on("toggle",this.windowResize),_("#palette-head-start").on("pointerdown",this.toolbarPointerdown),_("#palette-zoom").on("focus",this.zoomFocus),_("#palette-zoom").on("input",this.zoomInput),this.head.on("pointerdown",this.headPointerdown),this.screen.on("keydown",this.screenKeydown),this.screen.on("wheel",this.screenWheel),this.screen.on("userscroll",this.screenUserscroll),this.screen.on("blur",this.screenBlur),this.marquee.on("pointerdown",this.marqueePointerdown),this.marquee.on("doubleclick",this.marqueeDoubleclick),k.initialize(),Lt.initialize(),Rt.initialize(),Ft.initialize()},Ue.open=function(e){var t;e&&e!==this.meta&&(this.close(),(t=He.tilesets[e.guid])?(this.state="loading",this.meta=e,this.tileset=t,this.loadImages()):(j.close("tileset"),O.confirm({message:"Failed to read file: "+e.path},[{label:"Confirm"}])))},Ue.close=function(){"closed"!==this.state&&(this.state="closed",this.symbol=null,this.meta=null,this.tileset=null,this.window.hide(),this.marquee.clear(),this.stopRendering())},Ue.suspend=function(){"open"===this.state&&(this.state="suspended",this.stopRendering())},Ue.resume=function(){"suspended"===this.state&&(this.state="open",this.resize(),this.requestRendering())},Ue.setZoom=function(){const i=_("#palette-zoom");return function(t){if(this.zoom!==t){let e;switch(t){case 0:e=.25;break;case 1:e=.5;break;case 2:e=1;break;case 3:e=2;break;case 4:e=4;break;default:return}this.zoom=t,i.write(t),"open"===this.state?((t=this.zoomTimer).start=this.scale,t.end=e,t.elapsed=0,t.add()):this.scale=e}}}(),Ue.setImage=function(e){this.tileset.image=e,this.loadImages()},Ue.setSize=function(e,t){var i=this.tileset;switch(i.type){case"normal":var a=new Array(e*t).fill(0),n=e,s=i.priorities,r=i.width,o=Math.min(e,i.width),l=Math.min(t,i.height);for(let t=0;t<l;t++)for(let e=0;e<o;e++){var c=e+t*n,h=e+t*r;a[c]=s[h]}i.width=e,i.height=t,i.priorities=a;break;case"auto":var d=new Array(e*t).fill(0),u=new Array(e*t).fill(0),p=e,m=i.tiles,g=i.priorities,f=i.width,v=Math.min(e,i.width),b=Math.min(t,i.height);for(let t=0;t<b;t++)for(let e=0;e<v;e++){var y=e+t*p,w=e+t*f;d[y]=m[w],u[y]=g[w]}i.width=e,i.height=t,i.tiles=d,i.priorities=u}this.resize(),this.updateCamera(),this.requestRendering()},Ue.setTileSize=function(e,t){var i=this.tileset;i.tileWidth=e,i.tileHeight=t,this.resize(),this.updateCamera(),this.requestRendering()},Ue.loadImages=async function(){var t=this.images;const i={"":null};var a=[],e=this.tileset;switch(e.type){case"normal":{const l=e.image;if(void 0===i[l])if(t[l]instanceof Image)i[l]=t[l];else{const o=i[l]=Symbol();a.push(R.get({guid:l,type:"image"}).then(e=>{i[l]===o&&(i[l]=e)}))}break}case"auto":var n=e.tiles,s=n.length;for(let e=0;e<s;e++){var r=n[e];if(0!==r){const c=r.image;if(void 0===i[c])if(t[c]instanceof Image)i[c]=t[c];else{const o=i[c]=Symbol();a.push(R.get({guid:c,type:"image"}).then(e=>{i[c]===o&&(i[c]=e)}))}}}}this.images=i;const o=this.symbol=Symbol();0<a.length&&await Promise.all(a),this.symbol===o&&(this.symbol=null,this.window.show(),0<this.body.clientWidth?(this.state="open",this.resize(),this.requestRendering()):this.state="suspended")},Ue.updateHead=function(){var e,{page:t,head:i}=this;0!==t.clientWidth&&(t=x.getGroupOfElement(i)["nav"],e=t.rect(),t=t.lastChild.rect().right-e.left,i.left!==t)&&(i.left=t,i.style.left=t+"px")},Ue.resize=function(){var e,t,i,a,n,s,r,o,l,c,h,d;"open"===this.state&&(h=this.tileset,t=this.scale,e=Math.round(h.tileWidth*t),t=Math.round(h.tileHeight*t),i=h.width*e,a=h.height*t,n=(s=CSS.getDevicePixelContentBoxSize(this.screen)).width,s=s.height,r=Math.max(n-i>>1,0),o=Math.max(s-a>>1,0),d=Math.max(i,n),l=Math.max(a,s),c=window.devicePixelRatio,this.scaleX=e/h.tileWidth,this.scaleY=t/h.tileHeight,this.scaledTileWidth=e,this.scaledTileHeight=t,this.outerWidth=d,this.outerHeight=l,this.screenWidth=n,this.screenHeight=s,this.centerOffsetX=n<d?n/2:r+i/2,this.centerOffsetY=s<l?s/2:o+a/2,this.paddingLeft=r,this.paddingTop=o,this.marquee.style.left=r/c+"px",this.marquee.style.top=o/c+"px",this.marquee.style.width=i/c+"px",this.marquee.style.height=a/c+"px",this.marquee.scaleX=e/c,this.marquee.scaleY=t/c,this.marquee.visible&&!this.editing&&this.marquee.select(),h=Math.min(i,n),d=Math.min(a,s),this.canvas.style.left=r/c+"px",this.canvas.style.top=o/c+"px",this.canvas.dpr===c&&this.canvas.width===h&&this.canvas.height===d||(this.canvas.dpr=c,this.canvas.width=h,this.canvas.height=d,this.canvas.style.width=h/c+"px",this.canvas.style.height=d/c+"px",this.context.textAlign="center",this.context.textBaseline="middle"),this.context.font=Math.min(e>>1,t>>1)+"px sans-serif",this.updateCamera(),this.updateTransform(),this.skipScrollEvent(),this.screen.updateScrollbars())},Ue.getTileCoords=function(){const l={x:0,y:0};return function(e,t=!1){var e=e.getRelativeCoords(this.marquee),i=this.tileset,a=this.scaledTileWidth,n=this.scaledTileHeight,s=window.devicePixelRatio;let r=Math.floor(e.x*s/a),o=Math.floor(e.y*s/n);return t&&(r=Math.clamp(r,0,i.width-1),o=Math.clamp(o,0,i.height-1)),l.x=r,l.y=o,l}}(),Ue.updateCamera=function(e=this.meta.x,t=this.meta.y){var i=window.devicePixelRatio,a=this.screen,e=e*this.scaledTileWidth+this.paddingLeft,t=t*this.scaledTileHeight+this.paddingTop,n=1e-4*this.scaledTileWidth,s=1e-4*this.scaledTileHeight;a.rawScrollLeft=Math.clamp(e-this.centerOffsetX,0,this.outerWidth-this.screenWidth)/i,a.rawScrollTop=Math.clamp(t-this.centerOffsetY,0,this.outerHeight-this.screenHeight)/i,a.scrollLeft=(e-(this.screenWidth>>1)+n)/i,a.scrollTop=(t-(this.screenHeight>>1)+s)/i},Ue.updateTransform=function(){var e=window.devicePixelRatio,t=this.screen,i=Math.roundTo(t.scrollLeft*e,4),a=Math.roundTo(t.scrollTop*e,4),n=i+this.canvas.width,s=a+this.canvas.height,n=(this.scrollLeft=i,this.scrollTop=a,this.scrollRight=n,this.scrollBottom=s,this.context.setTransform(1,0,0,1,-i,-a),t.rawScrollLeft*e+this.centerOffsetX),s=t.rawScrollTop*e+this.centerOffsetY;this.meta.x=Math.roundTo((n-this.paddingLeft)/this.scaledTileWidth,4),this.meta.y=Math.roundTo((s-this.paddingTop)/this.scaledTileHeight,4),He.manifest.changed=!0},Ue.updateBackground=function(){var e=this.canvas.style,t=-this.screen.scrollLeft,i=-this.screen.scrollTop;e.backgroundX===t&&e.backgroundY===i||(e.backgroundX=t,e.backgroundY=i,e.backgroundPosition=t+`px ${i}px`)},Ue.createMarkCanvas=function(){let e=this.markCanvas;if(null===e){(e=document.createElement("canvas")).width=0,e.height=384,e.fontSize=128;var i=e.positions={},a=e.getContext("2d"),n="128px sans-serif";a.font=n;let t=0;for(let e=0;e<10;e++){var s=0===e?"▪":e.toString(),r=Math.ceil(a.measureText(s).width);i[e]={text:s,start:t,width:r,aspectRatio:r/128},t+=r}var o=Math.ceil(a.measureText("+").width);i.add={text:"+",start:t,width:o,aspectRatio:o/128},t+=o,e.width=t,a.font=n,a.textAlign="center",a.textBaseline="middle",a.shadowColor="#000000",a.shadowBlur=4,a.shadowOffsetY=4;for(const d of Object.values(i)){var{text:l,start:c,width:h}=d,c=c+h/2;a.fillStyle="#ffffff",a.fillText(l,c,64),a.fillStyle="#ffd700",a.fillText(l,c,192),a.fillStyle="#00ff00",a.fillText(l,c,320)}this.markCanvas=e}return e},Ue.drawTileset=function(){var e,t,i,a,n;0<this.body.clientWidth&&0!==this.canvas.width&&0!==this.canvas.height&&(e=this.context,t=this.scrollLeft,i=this.scrollTop,a=this.scrollRight,n=this.scrollBottom,e.clearRect(t,i,a-t,n-i),this.drawTiles(),this.drawTileGrid(),this.drawPriorities())},Ue.drawTiles=function(){var i=this.context,e=this.tileset;const a=this.images;switch(i.imageSmoothingEnabled=this.scale<1,e.type){case"normal":var t=this.scaleX,n=this.scaleY,s=this.scrollLeft,r=this.scrollTop,o=this.scrollRight-s,l=this.scrollBottom-r,c=s/t,h=r/n,t=o/t,n=l/n,d=a[e.image];if(d instanceof Image)i.drawImage(d,c,h,t,n,s,r,o,l);else if(void 0===d){const S=e.image,A=a[S]=Symbol();R.get({guid:S,type:"image"}).then(e=>{a[S]===A&&(a[S]=e,this.requestRendering())})}break;case"auto":var u=He.autotiles.map,p=e.tiles,m=e.width,g=e.tileWidth,f=e.tileHeight,v=this.scaledTileWidth,b=this.scaledTileHeight,c=this.scrollLeft,h=this.scrollTop,t=this.scrollRight,n=this.scrollBottom,y=Math.max(Math.floor(c/v),0),s=Math.max(Math.floor(h/b),0),w=Math.min(Math.ceil(t/v),e.width),x=Math.min(Math.ceil(n/b),e.height);for(let t=s;t<x;t++)for(let e=y;e<w;e++){var k=p[e+t*m];if(0!==k){var T=u[k.template],I=a[k.image];if(void 0!==T&&I instanceof Image){var C,E,M,T=T.nodes[T.cover];void 0!==T&&(T=T.frames[0],C=(k.x+(255&T))*g,T=(k.y+(T>>8))*f,E=e*v,M=t*b,i.drawImage(I,C,T,g,f,E,M,v,b))}else if(void 0===I){const P=k.image,L=a[P]=Symbol();R.get({guid:P,type:"image"}).then(e=>{a[P]===L&&(a[P]=e,this.requestRendering())})}}}}},Ue.drawTileGrid=function(){if(this.showGrid){var t=this.context,i=this.scrollLeft,a=this.scrollTop,n=this.scrollRight,s=this.scrollBottom,r=this.scaledTileWidth,o=this.scaledTileHeight,l=Math.floor(i/r+1)*r,c=Math.floor(a/o+1)*o,h=Math.ceil(n/r)*r,d=Math.ceil(s/o)*o;t.beginPath();for(let e=c;e<d;e+=o)t.moveTo(i,e+.5),t.lineTo(n,e+.5);for(let e=l;e<h;e+=r)t.moveTo(e+.5,a),t.lineTo(e+.5,s);t.lineWidth=1,t.strokeStyle=this.gridColor,t.stroke()}},Ue.drawPriorities=function(e){if(this.editing){var n=this.context,t=this.tileset,s=t.priorities,r=t.width,o=this.scrollLeft,l=this.scrollTop,c=this.scrollRight,h=this.scrollBottom,d=this.scaledTileWidth,u=this.scaledTileHeight,p=Math.min(d,u);if(!(p<16)){var m=Math.max(Math.floor(o/d),0),g=Math.max(Math.floor(l/u),0),f=Math.min(Math.ceil(c/d),t.width),v=Math.min(Math.ceil(h/u),t.height),b=this.dragging,y=this.createMarkCanvas(),w=y.positions,x=y.fontSize,k=p/2,T=k/2;let i,a;switch(b?.mode){case"switch":case"ready-to-shift":case"shift":b.active&&(i=b.startIndex,a=2*x);break;default:i=this.activeIndex,a=x}switch(n.imageSmoothingEnabled=k<x,t.type){case"normal":for(let t=g;t<v;t++)for(let e=m;e<f;e++){var I=e+t*r,{start:C,width:E,aspectRatio:M}=w[s[I]],M=k*M,S=(e+.5)*d-M/2,A=(t+.5)*u-T,I=I===i?a:0;n.drawImage(y,C,I,E,x,S,A,M,k)}break;case"auto":var P=t.tiles;for(let t=g;t<v;t++)for(let e=m;e<f;e++){var L=e+t*r,{start:R,width:F,aspectRatio:z}=w[0===P[L]?"add":s[L]],z=k*z,B=(e+.5)*d-z/2,N=(t+.5)*u-T,L=L===i?a:0;n.drawImage(y,R,L,F,x,B,N,z,k)}}}}},Ue.editAutoTile=function(e){var t;"auto"===this.tileset.type&&e<(t=this.tileset.tiles).length&&(t=t[e],this.openIndex=e,k.open(t||k.create()))},Ue.copyAutoTile=function(e){var t,i;"auto"===this.tileset.type&&(t=(i=this.tileset).tiles,i=i.priorities,t[e])&&Clipboard.write("yami.tile",{tile:t[e],priority:i[e]})},Ue.pasteAutoTile=function(e){var t,i,a;"auto"===this.tileset.type&&(t=(i=this.tileset).tiles,i=i.priorities,a=Clipboard.read("yami.tile"))&&e<t.length&&(t[e]=a.tile,i[e]=a.priority,this.requestRendering(),R.planToSave(this.meta))},Ue.deleteAutoTile=function(e){var t,i;"auto"===this.tileset.type&&(t=(i=this.tileset).tiles,i=i.priorities,t[e])&&(t[e]=0,i[e]=0,this.requestRendering(),R.planToSave(this.meta))},Ue.selectTiles=function(e,t,i,a){"eraser"===A.brush&&A.switchBrush("pencil");var n=this.tileset,s=n.width,r=A.createTiles(i,a),o=r.rowOffset,l=e,c=t,h=e+i,d=t+a;switch(n.type){case"normal":for(let t=c;t<d;t++)for(let e=l;e<h;e++)r[e-l+(t-c)*o]=1<<24|t<<16|e<<8;break;case"auto":var u=n.tiles;for(let t=c;t<d;t++)for(let e=l;e<h;e++)0!==u[e+t*s]&&(r[e-l+(t-c)*o]=1<<24|t<<16|e<<8)}this.explicit&&(this.explicit=!1,this.marquee.removeClass("explicit")),A.marquee.tilesetMap=this.tilesetMap,A.marquee.tilesetMap[1]=this.meta.guid;e="tile"===A.marquee.key?A.marquee:A.marquee.saveData.tile;e.tiles=r,e.width=i,e.height=a,e.offsetX=0,e.offsetY=0,r.standard=r},Ue.copyTilesFromScene=function(e,t,i,a){var n=A.tilemap.tiles,s=n.rowOffset,r=A.createTiles(i,a),o=r.rowOffset,l=e,c=t,h=e+i,d=t+a;this.explicit&&(this.explicit=!1,this.marquee.removeClass("explicit")),A.marquee.tilesetMap=A.tilemap.tilesetMap,("tile"===A.marquee.key?A.marquee:A.marquee.saveData.tile).tiles=r;for(let t=c;t<d;t++)for(let e=l;e<h;e++){var u=e+t*s;r[e-l+(t-c)*o]=n[u]}this.marquee.clear()},Ue.flipTiles=function(){var e=A.marquee;if("open"===A.state&&null===A.dragging&&"tile"===e.key){e.visible&&A.requestRendering();var a,n,s=e.tilesetMap,r=He.tilesets,o=e.tiles,l=o.width,t=o.height,c=o.rowOffset,h=A.createTiles(l,t),d=h.rowOffset,u=l-1;for(let i=0;i<t;i++)for(let t=0;t<l;t++){let e=o[t+i*c];0!==e&&(a=u-t+i*d,void 0!==(n=r[s[e>>24]])&&"normal"===n.type&&(e^=1),h[a]=e)}e.tiles=h,o===o.standard&&(e=e["tiles"],e.standard=e)}},Ue.openSelection=function(){var e,t,i,{tileset:a,marquee:n}=this;"auto"===a.type&&n.visible&&({x:n,y:i,width:e,height:t}=n,n=n+i*a.width,0!==(i=a.tiles[n]))&&(a=He.autotiles.map[i.template],n=this.images[i.image],1===e)&&1===t&&void 0!==a&&n instanceof Image&&Ft.open(a.nodes,n,i.x,i.y)},Ue.editSelection=function(){var e,t,i,{tileset:a,marquee:n}=this;"auto"===a.type&&n.visible&&({x:n,y:e,width:t,height:i}=n,n=n+e*a.width,1===t)&&1===i&&n<a.tiles.length&&Ue.editAutoTile(n)},Ue.scrollToSelection=function(e){var t,i,a,n,s,r,o,l,c,h,d=this.marquee;d.visible&&(o=this.scaledTileWidth,l=this.scaledTileHeight,c=d.x,t=d.y,i=d.width,a=d.height,h=d.originX,d=d.originY,n=c+i-(s=this.screenWidth/o/2)+(o=.5/o),s=c+s-o,r=t+a-(o=this.screenHeight/l/2)+(l=.5/l),o=t+o-l,l=this.meta,c=e&&c===h&&1<i?Math.max(Math.min(l.x,s),n):Math.min(Math.max(l.x,n),s),h=e&&t===d&&1<a?Math.max(Math.min(l.y,o),r):Math.min(Math.max(l.y,r),o),l.x===c&&l.y===h||(this.updateCamera(c,h),this.updateTransform(),this.requestRendering(),this.screen.updateScrollbars()))},Ue.requestRendering=function(){"open"===this.state&&f.appendUpdater("sharedRendering",this.renderingFunction)},Ue.renderingFunction=function(){Ue.drawTileset()},Ue.stopRendering=function(){f.removeUpdater("sharedRendering",this.renderingFunction)},Ue.skipScrollEvent=function(){const e=Ue.screen,t=()=>{Ue.scrollable&&e.on("scroll",Ue.screenUserscroll)},i=()=>{requestAnimationFrame(t)};return()=>{Ue.scrollable&&(e.off("scroll",Ue.screenUserscroll),"resize"===window.event?.type?requestAnimationFrame(i):requestAnimationFrame(t))}}(),Ue.switchScroll=function(){const t=_("#palette-scroll");return function(e=!this.scrollable){e?(t.addClass("selected"),this.screen.addClass("scrollable"),this.screen.on("scroll",this.screenUserscroll),this.screen.off("userscroll",this.screenUserscroll)):(t.removeClass("selected"),this.screen.removeClass("scrollable"),this.screen.off("scroll",this.screenUserscroll),this.screen.on("userscroll",this.screenUserscroll)),this.scrollable=e}}(),Ue.switchEdit=function(){const t=_("#palette-edit");return function(e=!this.editing){e?(t.addClass("selected"),this.marquee.visible&&this.marquee.selection.hide(),this.marquee.off("doubleclick",this.marqueeDoubleclick),this.marquee.on("pointermove",this.marqueePointermove),this.marquee.on("pointerleave",this.marqueePointerleave)):(t.removeClass("selected"),this.marquee.visible&&this.marquee.selection.show(),this.marquee.off("pointermove",this.marqueePointermove),this.marquee.off("pointerleave",this.marqueePointerleave),this.marquee.on("doubleclick",this.marqueeDoubleclick)),this.editing=e,this.requestRendering()}}(),Ue.saveToProject=function(e){var e=e["palette"],t=this.zoom;null!==t&&(e.zoom=t)},Ue.loadFromProject=function(e){e=e.palette;this.setZoom(e.zoom)},Ue.windowResize=function(e){if(0===this.body.clientWidth)return this.suspend();switch(this.updateHead(),this.state){case"open":this.resize(),this.requestRendering();break;case"suspended":this.resume()}}.bind(Ue),Ue.themechange=function(e){switch(e.value){case"light":this.gridColor="rgba(0, 0, 0, 0.5)";break;case"dark":this.gridColor="rgba(255, 255, 255, 0.5)"}this.requestRendering()}.bind(Ue),Ue.headPointerdown=function(e){e.target instanceof HTMLInputElement||(e.preventDefault(),document.activeElement!==Ue.screen&&Ue.screen.focus())},Ue.toolbarPointerdown=function(e){if(0===e.button){e=e.target;if("ITEM"===e.tagName)switch(e.getAttribute("value")){case"scroll":return Ue.switchScroll();case"edit":return Ue.switchEdit();case"flip":return Ue.flipTiles()}}},Ue.zoomFocus=function(e){Ue.screen.focus()},Ue.zoomInput=function(e){Ue.setZoom(this.read())},Ue.screenKeydown=function(r){if("Space"===r.code&&r.preventDefault(),"open"===Ue.state&&null===Ue.dragging)switch(r.code){case"Enter":case"NumpadEnter":r.stopPropagation(),r.cmdOrCtrlKey?Ue.editSelection():Ue.openSelection();break;case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":{r.preventDefault();var o=Ue.marquee;if(!o.visible)return;var l=Ue.tileset,c=l.width,l=l.height;let e=o.x,t=o.y,i=o.width,a=o.height;if(r.shiftKey){var h=o.originX,d=o.originY;switch(r.code){case"ArrowLeft":e===h&&1<i?i--:(e--,i++);break;case"ArrowRight":e===h?i++:(e++,i--);break;case"ArrowUp":t===d&&1<a?a--:(t--,a++);break;case"ArrowDown":t===d?a++:(t++,a--)}return void(0<=e&&e+i<=c&&0<=t&&t+a<=l&&(o.select(e,t,i,a),Ue.selectTiles(e,t,i,a),Ue.scrollToSelection(!0),A.requestRendering()))}let n=0,s=0;switch(r.code){case"ArrowLeft":n=-1;break;case"ArrowUp":s=-1;break;case"ArrowRight":n=1;break;case"ArrowDown":s=1}c=Math.clamp(e+n,0,c-i),l=Math.clamp(t+s,0,l-a);e===c&&t===l||(o.select(c,l,i,a),o.originX+=c-e,o.originY+=l-t,Ue.selectTiles(c,l,i,a),Ue.scrollToSelection(!1),A.requestRendering());break}case"Minus":case"NumpadSubtract":Ue.setZoom(Ue.zoom-1);break;case"Equal":case"NumpadAdd":Ue.setZoom(Ue.zoom+1);break;case"Digit0":case"Numpad0":Ue.setZoom(2)}},Ue.screenWheel=function(){let t=!1;const i=new f({duration:400,callback:e=>{t=!1,Ue.screen.endScrolling()}});return function(e){this.scrollable?(i.elapsed=0,t||(t=!0,i.add(),this.screen.beginScrolling())):(e.preventDefault(),0!==e.deltaY&&null===this.dragging&&this.setZoom(this.zoom+(0<e.deltaY?-1:1)))}.bind(Ue)}(),Ue.screenUserscroll=function(e){"open"===this.state&&(this.screen.rawScrollLeft=this.screen.scrollLeft,this.screen.rawScrollTop=this.screen.scrollTop,this.updateTransform(),this.updateBackground(),this.requestRendering(),this.screen.updateScrollbars())}.bind(Ue),Ue.screenBlur=function(e){this.dragging&&this.pointerup(this.dragging)}.bind(Ue),Ue.marqueePointerdown=function(e){if(!this.dragging)switch(e.button){case 0:if(document.activeElement.blur(),e.dragKey)return(this.dragging=e).mode="scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove);var{x:t,y:i}=this.getTileCoords(e,!0);if(e.cmdOrCtrlKey){var a=this.tileset;if("auto"===a.type)return a=t+i*a.width,(this.dragging=e).mode="edit",e.active=!0,e.startX=t,e.startY=i,e.startIndex=a,this.marqueePointerleave(),this.marquee.customSelect("source",t,i),window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove)}var n,s,r,o,a=this["marquee"];if(this.editing){var l=this.tileset,c=l.priorities,h=t+i*l.width;switch(l.type){case"normal":(this.dragging=e).mode="switch",e.active=!0,e.priorities=c,e.startX=t,e.startY=i,e.startIndex=h,this.requestRendering(),window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove);break;case"auto":var d=l.tiles;0!==d[h]?((this.dragging=e).mode="ready-to-shift",e.active=!0,e.tiles=d,e.priorities=c,e.startX=t,e.startY=i,e.startIndex=h,this.requestRendering(),window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)):(e.preventDefault(),this.editAutoTile(h))}}else e.shiftKey&&a.visible?(r=a.originX,o=a.originY,n=Math.min(t,r),s=Math.min(i,o),r=Math.abs(t-r)+1,o=Math.abs(i-o)+1,a.select(n,s,r,o)):(a.select(t,i,1,1),a.originX=t,a.originY=i),this.explicit&&(this.explicit=!1,a.removeClass("explicit")),(this.dragging=e).mode="select",window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove),this.screen.addScrollListener("both",this.scaleX/4,!1,()=>{this.screen.beginScrolling(),this.updateTransform(),this.requestRendering(),this.screen.updateScrollbars(),this.pointermove(e.latest)}),A.marquee.style.pointerEvents="none";break;case 2:this.editing?((this.dragging=e).mode="ready-to-scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop):((this.dragging=e).mode="scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,pt.open("cursor-grab")),window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}}.bind(Ue),Ue.marqueePointermove=function(e){var t;null===this.dragging&&({x:e,y:t}=this.getTileCoords(e,!0),e=e+t*this.tileset.width,this.activeIndex!==e)&&(this.activeIndex=e,this.requestRendering())}.bind(Ue),Ue.marqueePointerleave=function(e){null!==this.activeIndex&&(this.activeIndex=null,this.requestRendering())}.bind(Ue),Ue.marqueeDoubleclick=function(e){this.openSelection()}.bind(Ue),Ue.marqueePopup=function(e){if(this.editing&&"auto"===this.tileset.type){var{x:t,y:i}=this.getTileCoords(e,!0),a=this.tileset.tiles;const s=t+i*this.tileset.width;var t=!!a[s],i=t,a=Clipboard.has("yami.tile"),n=N.createGetter("menuTileset");ve.popup({x:e.clientX,y:e.clientY,minWidth:0},[{label:n("edit"),enabled:!0,click:()=>{this.editAutoTile(s)}},{label:n("cut"),enabled:i,click:()=>{this.copyAutoTile(s),this.deleteAutoTile(s)}},{label:n("copy"),enabled:i,click:()=>{this.copyAutoTile(s)}},{label:n("paste"),enabled:a,click:()=>{this.pasteAutoTile(s)}},{label:n("delete"),enabled:t,click:()=>{this.deleteAutoTile(s)}}])}},Ue.pointerup=function(e){var t=this["dragging"];if(t.relate(e)){switch(this.dragging=null,t.mode){case"select":var{x:i,y:a,width:n,height:s}=this.marquee;this.selectTiles(i,a,n,s),this.screen.endScrolling(),this.screen.removeScrollListener(),A.marquee.style.pointerEvents="inherit";break;case"ready-to-scroll":e.target===this.marquee&&this.marqueePopup(e);break;case"scroll":this.screen.endScrolling(),pt.close("cursor-grab");break;case"edit":t.active&&(this.marquee.customUnselect("source"),this.editAutoTile(t.startIndex));break;case"switch":case"ready-to-shift":t.active&&(i=t["priorities"],a=t.startIndex,n=e.shiftKey?9:1,i[a]=(i[a]+n)%10,this.requestRendering(),A.requestRendering(),R.planToSave(this.meta));break;case"shift":this.marquee.customShiftAutoTile(),this.screen.endScrolling(),this.screen.removeScrollListener(),this.requestRendering(),A.requestRendering(),A.marquee.style.pointerEvents="inherit",R.planToSave(this.meta)}window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove)}}.bind(Ue),Ue.pointermove=function(e){const t=this["dragging"];if(t.relate(e))switch(t.mode){case"select":t.latest=e;var i=this.marquee,a=this.getTileCoords(e,!0),n=Math.min(a.x,i.originX),s=Math.min(a.y,i.originY),r=Math.abs(a.x-i.originX)+1,a=Math.abs(a.y-i.originY)+1;i.x===n&&i.y===s&&i.width===r&&i.height===a||i.select(n,s,r,a);break;case"ready-to-scroll":i=e.clientX-t.clientX,n=e.clientY-t.clientY;this.screen.setScroll(t.scrollLeft-i,t.scrollTop-n),4<Math.sqrt(i**2+n**2)&&(t.mode="scroll",pt.open("cursor-grab"));break;case"scroll":s=e.clientX-t.clientX,r=e.clientY-t.clientY;this.screen.beginScrolling(),this.screen.setScroll(t.scrollLeft-s,t.scrollTop-r);break;case"edit":var a=t.startX,i=t.startY,{x:n,y:s}=this.getTileCoords(e),r=a===n&&i===s;t.active!==r&&((t.active=r)?this.marquee.customSelect("source"):this.marquee.customUnselect("source"));break;case"switch":var a=t.startX,n=t.startY,{x:i,y:s}=this.getTileCoords(e),r=a===i&&n===s;t.active!==r&&(t.active=r,this.requestRendering());break;case"ready-to-shift":a=e.clientX-t.clientX,i=e.clientY-t.clientY;4<Math.sqrt(a**2+i**2)&&(t.mode="shift",t.active=!1,n=t.startX,s=t.startY,this.requestRendering(),this.marquee.customSelect("source",n,s),this.marquee.customSelect("destination",n,s),this.screen.addScrollListener("both",this.scaleX/4,!1,()=>{this.screen.beginScrolling(),this.updateTransform(),this.requestRendering(),this.screen.updateScrollbars(),this.pointermove(t.latest)}),A.marquee.style.pointerEvents="none");break;case"shift":t.latest=e;var{x:r,y:a}=this.getTileCoords(e,!0);this.marquee.customSelect("destination",r,a)}}.bind(Ue),{canvas:_("#autoTile-canvas"),templateList:_("#autoTile-templates"),nodeList:_("#autoTile-nodes"),frameList:_("#autoTile-frames"),templates:null,template:null,nodes:null,node:null,nodeIndex:null,nodeMaximum:null,frames:null,frameIndex:null,frameMaximum:null,noImage:Symbol(),imageId:null,image:null,offsetX:null,offsetY:null,changed:!1,initialize:null,open:null,create:null,insertTemplate:null,copyTemplate:null,pasteTemplate:null,deleteTemplate:null,shiftTemplateFrames:null,createTemplateId:null,createTemplateData:null,getTemplateById:null,insertNode:null,cutNode:null,copyNode:null,pasteNode:null,deleteNode:null,setNodeQuantity:null,createNodeData:null,createNodeItems:null,editFrame:null,insertFrame:null,cutFrame:null,copyFrame:null,pasteFrame:null,deleteFrame:null,setFrameQuantity:null,generateFrames:null,createFrameData:null,createFrameItems:null,updateFrameItem:null,updateCanvas:null,drawFrame:null,windowClose:null,windowClosed:null,dprchange:null,templatesKeydown:null,templatesSelect:null,templatesChange:null,templatesPopup:null,nodesWrite:null,nodesPopup:null,nodesKeydown:null,ruleNeighborInput:null,framesWrite:null,framesPopup:null,framesKeydown:null,framesDoubleclick:null,canvasClick:null,imageInput:null,offsetXInput:null,offsetYInput:null,confirm:null}),Lt=(k.templateList.updateNodeElement=u.list.updateNodeElement,k.templateList.updateItemName=c.list.updateItemName,k.templateList.addElementClass=u.list.addElementClass,k.templateList.updateTextNode=u.list.updateTextNode,k.initialize=function(){this.nodeMaximum=64,this.frameMaximum=256;var e=this.templateList;e.removable=!0,e.renamable=!0,e.bind(()=>this.templates),e.creators.push(e.addElementClass),e.updaters.push(e.updateTextNode),window.on("dprchange",this.dprchange),_("#autoTile").on("close",this.windowClose),_("#autoTile").on("closed",this.windowClosed),e.on("keydown",this.templatesKeydown),e.on("select",this.templatesSelect),e.on("change",this.templatesChange),e.on("popup",this.templatesPopup),this.nodeList.on("write",this.nodesWrite),this.nodeList.on("popup",this.nodesPopup),this.nodeList.on("keydown",this.nodesKeydown),_(".autoTile-neighbor").on("input",this.ruleNeighborInput),this.frameList.on("write",this.framesWrite),this.frameList.on("popup",this.framesPopup),this.frameList.on("keydown",this.framesKeydown),this.frameList.on("doubleclick",this.framesDoubleclick),_("#autoTile-canvas").on("click",this.canvasClick),_("#autoTile-image").on("input",this.imageInput),_("#autoTile-x").on("input",this.offsetXInput),_("#autoTile-y").on("input",this.offsetYInput),_("#autoTile-confirm").on("click",this.confirm)},k.open=function({template:e,image:t,x:i,y:a}){O.open("autoTile"),_("#autoTile-image").write(t),_("#autoTile-x").write(i),_("#autoTile-y").write(a),this.templates=Object.clone(He.autotiles),this.nodeIndex=0,this.frameIndex=0,this.imageId=t,this.offsetX=i,this.offsetY=a,this.updateCanvas(),this.templateList.update(),this.templateList.select(this.getTemplateById(e)??this.templates[0]),this.templateList.scrollToSelection(),_("#autoTile-image").getFocus()},k.create=function(){return{template:He.autotiles[0].id,image:"",x:0,y:0}},k.insertTemplate=function(e){this.templateList.addNodeTo(this.createTemplateData(),e)},k.copyTemplate=function(e){e&&Clipboard.write("yami.ruletile.template",e)},k.pasteTemplate=function(e){var t=Clipboard.read("yami.ruletile.template");t&&(t.name+=" - Copy",t.id=this.createTemplateId(),this.templateList.addNodeTo(t,e))},k.deleteTemplate=function(i){const a=this.templates;var e;1<a.length&&(e=N.createGetter("confirmation"),O.confirm({message:e("deleteSingleFile").replace("<filename>",i.name)},[{label:e("yes"),click:()=>{var e=a.indexOf(i),t=(this.templateList.deleteNode(i),a.length-1),e=a[Math.min(e,t)];this.templateList.select(e)}},{label:e("no")}]))},k.shiftTemplateFrames=function(e,t,i){var a=this.image;if(a instanceof Image){var n=Ue.tileset.tileWidth,s=Ue.tileset.tileHeight,r=Math.floor(a.naturalWidth/n),o=Math.floor(a.naturalHeight/s),l=(t%r+r)%r,c=(i%o+o)%o;for(const p of e.nodes){var h=p.frames,d=h.length;for(let e=0;e<d;e++){var u=h[e];h[e]=((255&u)+l)%r|((u>>8)+c)%o<<8}}this.createFrameItems(),this.changed=!0}},k.createTemplateId=function(){let e;for(;e=X.generate64bit(),this.getTemplateById(e););return e},k.createTemplateData=function(){return{id:this.createTemplateId(),name:"",cover:0,nodes:[this.createNodeData()]}},k.getTemplateById=function(t){var i=this["templates"],a=i["length"];for(let e=0;e<a;e++)if(i[e].id===t)return i[e]},k.insertNode=function(e=this.nodeIndex){e<=this.nodes.length&&(this.nodes.splice(e,0,this.createNodeData()),this.template.cover>=e&&(this.template.cover+=1),this.createNodeItems(e),this.changed=!0)},k.cutNode=function(e=this.nodeIndex){1<this.nodes.length&&(this.copyNode(e),this.deleteNode(e))},k.copyNode=function(e=this.nodeIndex){e<this.nodes.length&&Clipboard.write("yami.ruletile.node",this.nodes[e])},k.pasteNode=function(e=this.nodes.length){var t=Clipboard.read("yami.ruletile.node");t&&e<=this.nodes.length&&(this.nodes.splice(e,0,t),this.createNodeItems(e),this.changed=!0)},k.deleteNode=function(e=this.nodeIndex){e<this.nodes.length&&1<this.nodes.length&&(this.nodes.splice(e,1),this.template.cover>=e&&(this.template.cover===e?this.template.cover=0:--this.template.cover),this.createNodeItems(),this.changed=!0)},k.setNodeQuantity=function(t){var i=this.nodes,a=i.length;if(a!==t){if(a<(i.length=t))for(let e=a;e<t;e++)i[e]=this.createNodeData();this.template.cover>=t&&(this.template.cover=0),this.createNodeItems(),this.changed=!0}},k.createNodeData=function(){return{rule:0,frames:[this.createFrameData()]}},k.createNodeItems=function(e=this.nodeIndex){var t=this.nodeList.reload(),i=this.template.cover,a=this.nodes.length,n=Number.computeIndexDigits(a);for(let e=0;e<a;e++){var s=document.createElement("common-item"),r=e.toString().padStart(n,"0");s.textContent="#"+r+(e===i?" !":""),s.dataValue=e,t.appendElement(s)}t.update(),t.write(Math.min(e,a-1))},k.editFrame=function(){null!==this.image&&Rt.open()},k.insertFrame=function(e=this.frameIndex){e<=this.frames.length&&(this.frames.splice(e,0,this.createFrameData()),this.createFrameItems(e),this.changed=!0)},k.cutFrame=function(e=this.frameIndex){1<this.frames.length&&(this.copyFrame(e),this.deleteFrame(e))},k.copyFrame=function(e=this.frameIndex){e<this.frames.length&&Clipboard.write("yami.ruletile.frame",{frame:this.frames[e]})},k.pasteFrame=function(e=this.frames.length){var t=Clipboard.read("yami.ruletile.frame");t&&e<=this.frames.length&&(this.frames.splice(e,0,t.frame),this.createFrameItems(e),this.changed=!0)},k.deleteFrame=function(e=this.frameIndex){e<this.frames.length&&1<this.frames.length&&(this.frames.splice(e,1),this.createFrameItems(),this.changed=!0)},k.setFrameQuantity=function(t){var i=this.frames,a=i.length;if(a!==t){if(a<(i.length=t))for(let e=a;e<t;e++)i[e]=this.createFrameData();this.createFrameItems(),this.changed=!0}},k.generateFrames=function(i,a,n,s){var r=this.image;if(r instanceof Image){var o=Ue.tileset.tileWidth,l=Ue.tileset.tileHeight,c=Math.floor(r.naturalWidth/o),h=Math.floor(r.naturalHeight/l),d=(a%c+c)%c,u=(n%h+h)%h,o=this.frameMaximum,p=this.frames,r=p[i];let e=255&r,t=r>>8;for(s=Math.min(s,o-p.length);0<s--;)e=(e+d)%c,t=(t+u)%h,p.splice(++i,0,e|t<<8);this.createFrameItems(),this.changed=!0}},k.createFrameData=function(){return 0},k.createFrameItems=function(e=this.frameIndex){var t=this.frameList.reload(),i=this.frames,a=i.length,n=Number.computeIndexDigits(a);for(let e=0;e<a;e++){var s=i[e],r=255&s,s=s>>8,o=document.createElement("common-item"),l=e.toString().padStart(n,"0");o.textContent=`#${l}: ${r},`+s,o.dataValue=e,t.appendElement(o)}t.update(),t.write(Math.min(e,i.length-1))},k.updateFrameItem=function(){var e=this.frames,t=this.frameIndex,i=e.length,e=e[t],t=Number.padZero(t,i);this.frameList.selection.textContent=`#${t}: ${255&e},`+(e>>8),this.drawFrame()},k.updateCanvas=function(){var e=this.canvas,{width:t,height:i}=CSS.getDevicePixelContentBoxSize(e);e.width!==t&&(e.width=t),e.height!==i&&(e.height=i)},k.drawFrame=function(){var e=this.canvas,t=e.getContext("2d"),i=e.width,e=e.height;if(t.clearRect(0,0,i,e),!(this.image instanceof Image)){if(this.image===this.noImage)return;i=this.imageId;if(!i)return;const r=this.image=Symbol();return R.get({guid:i,type:"image"}).then(e=>{this.image===r&&(e?(this.image=e,this.drawFrame()):this.image=this.noImage)})}var e=this.image,i=this.frames[this.frameIndex],a=Ue.tileset.tileWidth,n=Ue.tileset.tileHeight,s=(this.offsetX+(255&i))*a,i=(this.offsetY+(i>>8))*n;t.drawAndFitImage(e,s,i,a,n)},k.windowClose=function(e){this.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedTiles")},[{label:e("yes"),click:()=>{this.changed=!1,O.close("autoTile")}},{label:e("no")}]))}.bind(k),k.windowClosed=function(e){this.templates=null,this.template=null,this.nodes=null,this.node=null,this.frames=null,this.image=null,this.updateCanvas(),this.templateList.clear(),this.nodeList.clear(),this.frameList.clear()}.bind(k),k.dprchange=function(e){null!==this.nodes&&(this.updateCanvas(),this.drawFrame())}.bind(k),k.templatesKeydown=function(e){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyC":k.copyTemplate(t);break;case"KeyV":k.pasteTemplate()}else if(!e.altKey)switch(e.code){case"Insert":k.insertTemplate(t);break;case"Delete":k.deleteTemplate(t)}},k.templatesSelect=function(e){e=e.value;this.template=e,this.nodes=e.nodes,this.createNodeItems()}.bind(k),k.templatesChange=function(e){this.changed=!0}.bind(k),k.templatesPopup=function(e){const i=e.value;var t=!!i,a=Clipboard.has("yami.ruletile.template"),n=t&&1<k.templates.length,s=N.createGetter("menuAutoTileTemplateList");ve.popup({x:e.clientX,y:e.clientY},[{label:s("insert"),accelerator:"Insert",click:()=>{k.insertTemplate(i)}},{label:s("copy"),accelerator:p("C"),enabled:t,click:()=>{k.copyTemplate(i)}},{label:s("paste"),accelerator:p("V"),enabled:a,click:()=>{k.pasteTemplate(i)}},{label:s("delete"),accelerator:"Delete",enabled:n,click:()=>{k.deleteTemplate(i)}},{label:s("rename"),accelerator:"F2",enabled:t,click:()=>{this.rename(i)}},{type:"separator"},{label:s("shift"),enabled:t,click:()=>{Et.open((e,t)=>{k.shiftTemplateFrames(i,e,t)})}}])},k.nodesWrite=function(e){var e=e.value,e=(this.nodeIndex=e,this.node=this.nodes[e],this.frames=this.node.frames,D("autoTile")),t=this.node.rule;e("rule-0",3&t),e("rule-1",t>>2&3),e("rule-2",t>>4&3),e("rule-3",t>>6&3),e("rule-4",t>>8&3),e("rule-5",t>>10&3),e("rule-6",t>>12&3),e("rule-7",t>>14&3),this.createFrameItems()}.bind(k),k.nodesPopup=function(e){const t=e.value;var i=this.template.cover;const a=this.nodes;var n=null!==t,s=a.length<this.nodeMaximum,r=n,o=s&&Clipboard.has("yami.ruletile.node"),l=n&&1<a.length,n=n&&t!==i,i=N.createGetter("menuAutoTileNodeList");ve.popup({x:e.clientX,y:e.clientY},[{label:i("insert"),accelerator:"Insert",enabled:s,click:()=>{this.insertNode(t??a.length)}},{label:i("cut"),accelerator:p("X"),enabled:l,click:()=>{this.cutNode(t)}},{label:i("copy"),accelerator:p("C"),enabled:r,click:()=>{this.copyNode(t)}},{label:i("paste"),accelerator:p("V"),enabled:o,click:()=>{this.pasteNode(t??a.length)}},{label:i("delete"),accelerator:"Delete",enabled:l,click:()=>{this.deleteNode(t)}},{label:i("setQuantity"),click:()=>{ut.open(a.length,this.nodeMaximum,this.setNodeQuantity.bind(this))}},{type:"separator"},{label:i("setAsCover"),enabled:n,click:()=>{this.template.cover=t,this.changed=!0,this.createNodeItems()}}])}.bind(k),k.nodesKeydown=function(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":k.cutNode();break;case"KeyC":k.copyNode();break;case"KeyV":k.pasteNode()}else if(!e.altKey)switch(e.code){case"Insert":k.insertNode();break;case"Delete":k.deleteNode()}},k.ruleNeighborInput=function(e){var t=g("autoTile-rule"),t=t("0")|t("1")<<2|t("2")<<4|t("3")<<6|t("4")<<8|t("5")<<10|t("6")<<12|t("7")<<14;k.node.rule=t,k.changed=!0},k.framesWrite=function(e){this.frameIndex=e.value,this.drawFrame()}.bind(k),k.framesPopup=function(e){const a=e.value,t=this.frames;var i=null!==a,n=i&&this.image instanceof Image,s=t.length<this.frameMaximum,r=i,o=s&&Clipboard.has("yami.ruletile.frame"),i=i&&1<t.length,l=N.createGetter("menuAutoTileFrameList");ve.popup({x:e.clientX,y:e.clientY},[{label:l("edit"),accelerator:"Enter",enabled:n,click:()=>{this.editFrame()}},{label:l("insert"),accelerator:"Insert",enabled:s,click:()=>{this.insertFrame(a??t.length)}},{label:l("cut"),accelerator:p("X"),enabled:i,click:()=>{this.cutFrame(a)}},{label:l("copy"),accelerator:p("C"),enabled:r,click:()=>{this.copyFrame(a)}},{label:l("paste"),accelerator:p("V"),enabled:o,click:()=>{this.pasteFrame(a??t.length)}},{label:l("delete"),accelerator:"Delete",enabled:i,click:()=>{this.deleteFrame(a)}},{label:l("setQuantity"),click:()=>{ut.open(t.length,this.frameMaximum,this.setFrameQuantity.bind(this))}},{type:"separator"},{label:l("generate"),enabled:n&&s,click:()=>{Lt.open((e,t,i)=>{this.generateFrames(a,e,t,i)})}}])}.bind(k),k.framesKeydown=function(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyX":k.cutFrame();break;case"KeyC":k.copyFrame();break;case"KeyV":k.pasteFrame()}else if(!e.altKey)switch(e.code){case"Enter":case"NumpadEnter":e.stopPropagation(),k.editFrame();break;case"Insert":k.insertFrame();break;case"Delete":k.deleteFrame()}},k.framesDoubleclick=function(e){e=e.target;"COMMON-ITEM"===e.tagName&&e.hasClass("selected")&&this.editFrame()}.bind(k),k.canvasClick=function(e){this.editFrame()}.bind(k),k.imageInput=function(e){k.imageId=this.read(),k.image=null,k.drawFrame()},k.offsetXInput=function(e){var t=this.read();k.offsetX!==t&&(k.offsetX=t,k.drawFrame())},k.offsetYInput=function(e){var t=this.read();k.offsetY!==t&&(k.offsetY=t,k.drawFrame())},k.confirm=function(e){this.changed&&(this.changed=!1,i=this.templates,Ee.deleteCaches(i),He.autotiles=i,He.createGUIDMap(i),R.planToSave(He.manifest.project.autotiles));var t,i=Ue.tileset.tiles,a=Ue.openIndex,n=!i[a];i[a]={template:this.template.id,image:this.imageId,x:this.offsetX,y:this.offsetY},n&&(i=Ue["marquee"],i.visible)&&({x:a,y:n,width:i,height:t}=i,Ue.selectTiles(a,n,i,t)),R.planToSave(Ue.meta),Ue.requestRendering(),A.requestRendering(),O.close("autoTile")}.bind(k),{callback:null,initialize:null,open:null,windowClosed:null,confirm:null}),Rt=(Lt.initialize=function(){_("#autoTile-generateFrames-strideX").write(0),_("#autoTile-generateFrames-strideY").write(0),_("#autoTile-generateFrames-count").write(1),_("#autoTile-generateFrames").on("closed",this.windowClosed),_("#autoTile-generateFrames-confirm").on("click",this.confirm)},Lt.open=function(e){this.callback=e,O.open("autoTile-generateFrames"),_("#autoTile-generateFrames-strideX").getFocus("all")},Lt.windowClosed=function(e){this.callback=null}.bind(Lt),Lt.confirm=function(e){var t=_("#autoTile-generateFrames-strideX").read(),i=_("#autoTile-generateFrames-strideY").read(),a=_("#autoTile-generateFrames-count").read();if(0===t&&0===i)return _("#autoTile-generateFrames-strideX").getFocus();this.callback(t,i,a),O.close("autoTile-generateFrames")}.bind(Lt),{window:_("#autoTile-frameIndex"),screen:_("#autoTile-frameIndex-screen"),clip:_("#autoTile-frameIndex-image-clip"),mask:_("#autoTile-frameIndex-mask"),image:_("#autoTile-frameIndex-image"),marquee:_("#autoTile-frameIndex-marquee"),info:_("#autoTile-frameIndex-info"),dragging:null,hframes:null,vframes:null,initialize:null,open:null,selectTileFrame:null,scrollToSelection:null,getDevicePixelClientBoxSize:null,dprchange:null,windowClosed:null,keydown:null,marqueePointerdown:null,marqueePointermove:null,marqueePointerleave:null,pointerup:null,pointermove:null}),Ft=(Rt.initialize=function(){window.on("dprchange",this.dprchange),this.window.on("closed",this.windowClosed),this.marquee.on("pointerdown",this.marqueePointerdown),this.marquee.on("pointermove",this.marqueePointermove),this.marquee.on("pointerleave",this.marqueePointerleave)},Rt.open=function(){var e=k.image,t=this.window,i=this.screen,a=this.clip,n=this.mask,s=this.image,r=this.marquee,o=Ue.tileset.tileWidth,l=Ue.tileset.tileHeight,c=k.frames,h=k.offsetX,d=k.offsetY,c=c[k.frameIndex],u=h+(255&c),c=d+(c>>8),p=Math.floor(e.naturalWidth/o),m=Math.floor(e.naturalHeight/l),g=window.devicePixelRatio,f=o*Math.clamp(p,1,256),v=l*Math.clamp(m,1,256);let b=f/g,y=v/g;this.hframes=p,this.vframes=m,1180<b?(y+=12,i.style.overflowX="scroll"):i.style.overflowX="hidden",696<y?(b+=12,i.style.overflowY="scroll"):i.style.overflowY="hidden",b=Math.clamp(b,100,1180),y=Math.clamp(y,100,696),t.style.width=b+"px",t.style.height=y+28+"px",window.on("keydown",this.keydown),O.open("autoTile-frameIndex");var p=this.getDevicePixelClientBoxSize(i),m=p.width,t=p.height,p=Math.max((m-f>>1)/g,0),w=Math.max((t-v>>1)/g,0),a=(a.style.left=p+"px",a.style.top=w+"px",a.style.width=f/g+"px",a.style.height=v/g+"px",h*o),h=d*l,d=(n.style.borderLeftWidth=a/g+"px",n.style.borderTopWidth=h/g+"px",s.src=e.src,s.style.width=e.naturalWidth/g+"px",s.style.height=e.naturalHeight/g+"px",r.style.left=p+"px",r.style.top=w+"px",r.style.width=f/g+"px",r.style.height=v/g+"px",r.scaleX=o/g,r.scaleY=l/g,r.select(u,c,1,1),(u+.5)*o),a=(c+.5)*l;i.scrollLeft=Math.round(d-m/2)/g,i.scrollTop=Math.round(a-t/2)/g},Rt.selectTileFrame=function(){var e,t,{x:i,y:a}=this.marquee;i-=k.offsetX,a-=k.offsetY,0<=i&&0<=a&&({frames:e,frameIndex:t}=k,e[t]=Math.min(i|a<<8,65535),k.changed=!0,k.updateFrameItem(),O.close("autoTile-frameIndex"))},Rt.scrollToSelection=function(){var e,t,i,a,n,s,r,o,l=this.marquee;l.visible&&(e=this.screen,r=l.scaleX,i=l.scaleY,t=l.x*r,i=(l=l.y*i)+i,o=e.clientWidth,a=e.clientHeight,n=e.scrollLeft,s=e.scrollTop,r=Math.min(Math.max(n,t+r-o),t),o=Math.min(Math.max(s,i-a),l),n===r&&s===o||e.scroll(r,o))},Rt.getDevicePixelClientBoxSize=function(e){var t=e.rect(),e=e.css(),e=("scroll"===e.overflowX&&Object.defineProperty(t,"bottom",{value:t.bottom-12}),"scroll"===e.overflowY&&Object.defineProperty(t,"right",{value:t.right-12}),window.devicePixelRatio),i=Math.round(t.left*e+1e-5),a=Math.round(t.right*e+1e-5),n=Math.round(t.top*e+1e-5);return{width:a-i,height:Math.round(t.bottom*e+1e-5)-n}},Rt.dprchange=function(e){var t,i,a,n,s;null!==this.hframes&&({x:i,y:a,width:n,height:s}=t=this.marquee,this.open(),t.select(i,a,n,s))}.bind(Rt),Rt.windowClosed=function(e){this.hframes=null,this.vframes=null,this.image.src="",this.dragging&&this.pointerup(this.dragging),window.off("keydown",this.keydown)}.bind(Rt),Rt.keydown=function(i){if(i.preventDefault(),!this.dragging)switch(i.code){case"Enter":case"NumpadEnter":this.selectTileFrame();break;case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":{let e=0,t=0;switch(i.code){case"ArrowLeft":e=-1;break;case"ArrowUp":t=-1;break;case"ArrowRight":e=1;break;case"ArrowDown":t=1}var a=this.marquee,n=Math.clamp(a.x+e,0,this.hframes-1),s=Math.clamp(a.y+t,0,this.vframes-1);a.x===n&&a.y===s||(a.select(n,s,1,1),this.scrollToSelection());break}}}.bind(Rt),Rt.marqueePointerdown=function(e){if(!this.dragging)switch(e.button){case 0:if(e.altKey)return(this.dragging=e).mode="scroll",e.screen=e.target.parentNode,e.scrollLeft=e.screen.scrollLeft,e.scrollTop=e.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove);var t=this.marquee,i=e.getRelativeCoords(t),a=Math.floor(i.x/t.scaleX),i=Math.floor(i.y/t.scaleY);t.select(a,i,1,1),(this.dragging=e).mode="select",window.on("pointerup",this.pointerup);break;case 2:(this.dragging=e).mode="scroll",e.screen=e.target.parentNode,e.scrollLeft=e.screen.scrollLeft,e.scrollTop=e.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}}.bind(Rt),Rt.marqueePointermove=function(e){var t=this.info,i=this.marquee,e=e.getRelativeCoords(i),a=Math.floor(e.x/i.scaleX),e=Math.floor(e.y/i.scaleY);t.x===a&&t.y===e||(t.x=a,t.y=e,t.textContent=a+","+e)}.bind(Rt),Rt.marqueePointerleave=function(e){var t=this.info;t.x=-1,t.y=-1,t.textContent=""}.bind(Rt),Rt.pointerup=function(e){var t=this["dragging"];if(t.relate(e)){switch(t.mode){case"select":var i,a,n=this.marquee;e.target===n&&(a=e.getRelativeCoords(n),i=Math.floor(a.x/n.scaleX),a=Math.floor(a.y/n.scaleY),n.x===i)&&n.y===a&&this.selectTileFrame();break;case"scroll":pt.close("cursor-grab")}this.dragging=null,window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove)}}.bind(Rt),Rt.pointermove=function(e){var t=this["dragging"];t.relate(e)&&"scroll"===t.mode&&(t.screen.scrollLeft=t.scrollLeft+t.clientX-e.clientX,t.screen.scrollTop=t.scrollTop+t.clientY-e.clientY)}.bind(Rt),{canvas:_("#autoTile-selectNode-canvas"),context:null,screen:_("#autoTile-selectNode-screen"),marquee:_("#autoTile-selectNode-marquee"),dragging:null,nodes:null,image:null,offsetX:null,offsetY:null,hframes:null,vframes:null,scrollLeft:null,scrollTop:null,scrollRight:null,scrollBottom:null,initialize:null,open:null,updateTransform:null,updateBackground:null,drawNodes:null,requestRendering:null,renderingFunction:null,stopRendering:null,scrollToSelection:null,getDevicePixelClientBoxSize:null,dprchange:null,windowClosed:null,keydown:null,screenScroll:null,marqueePointerdown:null,pointerup:null,pointermove:null}),y=(Ft.initialize=function(){this.context=this.canvas.getContext("2d"),window.on("dprchange",this.dprchange),_("#autoTile-selectNode").on("closed",this.windowClosed),this.screen.on("scroll",this.screenScroll),this.marquee.on("pointerdown",this.marqueePointerdown)},Ft.open=function(e,t,i,a){var n=_("#autoTile-selectNode"),s=this.screen,r=Ue.tileset.tileWidth,o=Ue.tileset.tileHeight,l=Math.min(e.length,8),c=Math.ceil(e.length/8),h=window.devicePixelRatio,d=r*l,u=o*c;let p=d/h,m=u/h;this.nodes=e,this.image=t,this.offsetX=i,this.offsetY=a,this.hframes=l,this.vframes=c,1180<p?(m+=12,s.style.overflowX="scroll"):s.style.overflowX="hidden",696<m?(p+=12,s.style.overflowY="scroll"):s.style.overflowY="hidden",p=Math.clamp(p,100,1180),m=Math.clamp(m,100,696),n.style.width=p+"px",n.style.height=m+28+"px",window.on("keydown",this.keydown),O.open("autoTile-selectNode");e=this.getDevicePixelClientBoxSize(s),t=e.width,i=e.height,a=Math.max((t-d>>1)/h,0),l=Math.max((i-u>>1)/h,0),this.marquee.style.left=a+"px",this.marquee.style.top=l+"px",this.marquee.style.width=d/h+"px",this.marquee.style.height=u/h+"px",this.marquee.scaleX=r/h,this.marquee.scaleY=o/h,Ue.explicit?this.marquee.select():this.marquee.select(0,0,1,1),c=Math.min(d,t),n=Math.min(u,i);this.canvas.style.left=a+"px",this.canvas.style.top=l+"px",this.canvas.width=c,this.canvas.height=n,this.canvas.style.width=c/h+"px",this.canvas.style.height=n/h+"px",this.scrollToSelection(),this.updateTransform(),this.requestRendering()},Ft.updateTransform=function(){var e=window.devicePixelRatio;this.scrollLeft=this.screen.scrollLeft*e,this.scrollTop=this.screen.scrollTop*e,this.scrollRight=this.scrollLeft+this.canvas.width,this.scrollBottom=this.scrollTop+this.canvas.height,this.context.setTransform(1,0,0,1,-this.scrollLeft,-this.scrollTop)},Ft.updateBackground=Ue.updateBackground,Ft.drawNodes=function(){if(this.nodes){var i=this.context,e=Ue.tileset,a=this.image,n=this.nodes,s=n.length,r=e.tileWidth,o=e.tileHeight,l=this.offsetX,c=this.offsetY,e=this.scrollLeft,t=this.scrollTop,h=this.scrollRight,d=this.scrollBottom,u=Math.max(Math.floor(e/r),0),p=Math.max(Math.floor(t/o),0),m=Math.min(Math.ceil(h/r),this.hframes),g=Math.min(Math.ceil(d/o),this.vframes);i.clearRect(e,t,h-e,d-t);for(let t=p;t<g;t++)for(let e=u;e<m;e++){var f,v,b=e|t<<3;b<s&&(b=n[b].frames[0],f=e*r,v=t*o,i.drawImage(a,(l+(255&b))*r,(c+(b>>8))*o,r,o,f,v,r,o))}}},Ft.requestRendering=function(){null!==this.nodes&&f.appendUpdater("sharedRendering",this.renderingFunction)},Ft.renderingFunction=function(){Ft.drawNodes()},Ft.stopRendering=function(){f.removeUpdater("sharedRendering",this.renderingFunction)},Ft.scrollToSelection=function(){var e,t,i,a,n,s,r,o,l=this.marquee;l.visible&&(e=this.screen,r=l.scaleX,i=l.scaleY,t=l.x*r,i=(l=l.y*i)+i,o=e.clientWidth,a=e.clientHeight,n=e.scrollLeft,s=e.scrollTop,r=Math.min(Math.max(n,t+r-o),t),o=Math.min(Math.max(s,i-a),l),n===r&&s===o||e.scroll(r,o))},Ft.getDevicePixelClientBoxSize=function(e){var t=e.rect(),e=e.css(),e=("scroll"===e.overflowX&&Object.defineProperty(t,"bottom",{value:t.bottom-12}),"scroll"===e.overflowY&&Object.defineProperty(t,"right",{value:t.right-12}),window.devicePixelRatio),i=Math.round(t.left*e+1e-5),a=Math.round(t.right*e+1e-5),n=Math.round(t.top*e+1e-5);return{width:a-i,height:Math.round(t.bottom*e+1e-5)-n}},Ft.dprchange=function(e){var t,i,a,n,s;null!==this.nodes&&({x:i,y:a,width:n,height:s}=t=this.marquee,this.open(this.nodes,this.image),t.select(i,a,n,s))}.bind(Ft),Ft.windowClosed=function(e){this.nodes=null,this.image=null,this.canvas.width=0,this.canvas.height=0,this.stopRendering(),this.dragging&&this.pointerup(this.dragging),window.off("keydown",this.keydown)}.bind(Ft),Ft.keydown=function(i){if(i.preventDefault(),!this.dragging)switch(i.code){case"Enter":case"NumpadEnter":var{x:t,y:a}=this.marquee,n=("tile"===A.marquee.key?A.marquee:A.marquee.saveData.tile).tiles,s=n.length;for(let e=0;e<s;e++)if(0!==n[e]){n[e]&=4294967232,n[e]|=t|a<<3;break}Ue.explicit=!0,Ue.marquee.addClass("explicit"),O.close("autoTile-selectNode");break;case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":{let e=0,t=0;switch(i.code){case"ArrowLeft":e=-1;break;case"ArrowUp":t=-1;break;case"ArrowRight":e=1;break;case"ArrowDown":t=1}var r=this.marquee,o=Math.clamp(r.x+e,0,this.hframes-1),l=Math.clamp(r.y+t,0,this.vframes-1);r.x===o&&r.y===l||(o|l<<3)<this.nodes.length&&(r.select(o,l,1,1),this.scrollToSelection());break}}}.bind(Ft),Ft.screenScroll=function(e){this.updateTransform(),this.updateBackground(),this.requestRendering()}.bind(Ft),Ft.marqueePointerdown=function(e){if(!this.dragging)switch(e.button){case 0:if(e.altKey)return(this.dragging=e).mode="scroll",e.screen=e.target.parentNode,e.scrollLeft=e.screen.scrollLeft,e.scrollTop=e.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove);var t=this.marquee,i=e.getRelativeCoords(t),a=Math.floor(i.x/t.scaleX),i=Math.floor(i.y/t.scaleY);(a|i<<3)<this.nodes.length&&(t.select(a,i,1,1),(this.dragging=e).mode="select",window.on("pointerup",this.pointerup));break;case 2:(this.dragging=e).mode="scroll",e.screen=e.target.parentNode,e.scrollLeft=e.screen.scrollLeft,e.scrollTop=e.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}}.bind(Ft),Ft.pointerup=function(e){var t=this["dragging"];if(t.relate(e)){switch(t.mode){case"select":var i=this.marquee;if(e.target===i){var a=e.getRelativeCoords(i),n=Math.floor(a.x/i.scaleX),s=Math.floor(a.y/i.scaleY);if(i.x===n&&i.y===s){var r=("tile"===A.marquee.key?A.marquee:A.marquee.saveData.tile).tiles,o=r.length;for(let e=0;e<o;e++)if(0!==r[e]){r[e]&=4294967232,r[e]|=n|s<<3;break}Ue.explicit=!0,Ue.marquee.addClass("explicit"),O.close("autoTile-selectNode")}}break;case"scroll":pt.close("cursor-grab")}this.dragging=null,window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove)}}.bind(Ft),Ft.pointermove=function(e){var t=this["dragging"];t.relate(e)&&"scroll"===t.mode&&(t.screen.scrollLeft=t.scrollLeft+t.clientX-e.clientX,t.screen.scrollTop=t.scrollTop+t.clientY-e.clientY)}.bind(Ft),{state:"closed",body:_("#sprite-body"),window:_("#sprite-frame").hide(),canvas:_("#sprite-canvas"),context:null,info:_("#sprite-info"),slider:_("#sprite-zoom"),screen:_("#sprite-screen"),marquee:_("#sprite-marquee"),symbol:null,target:null,hframes:null,vframes:null,image:null,dragging:null,showGrid:!0,gridColor:null,zoom:null,zoomTimer:null,scale:null,scaleX:null,scaleY:null,scaledUnitWidth:null,scaledUnitHeight:null,unitWidth:null,unitHeight:null,outerWidth:null,outerHeight:null,screenWidth:null,screenHeight:null,scrollLeft:null,scrollTop:null,scrollRight:null,scrollBottom:null,centerOffsetX:null,centerOffsetY:null,paddingLeft:null,paddingTop:null,centerX:null,centerY:null,initialize:null,open:null,close:null,suspend:null,resume:null,setZoom:null,loadImage:null,updateTargetInfo:null,resize:null,getUnitCoords:null,updateCamera:null,updateTransform:null,updateBackground:null,drawSprite:null,drawSpriteLayer:null,drawGridLayer:null,selectSprite:null,scrollToSelection:null,requestRendering:null,renderingFunction:null,stopRendering:null,saveToProject:null,loadFromProject:null,windowResize:null,themechange:null,zoomFocus:null,zoomInput:null,screenKeydown:null,screenWheel:null,screenUserscroll:null,marqueePointerdown:null,pointerup:null,pointermove:null}),T=(y.initialize=function(){this.screen.addScrollbars(),this.context=this.canvas.getContext("2d",{desynchronized:!0}),this.zoomTimer=new f({duration:80,update:e=>{if("open"!==this.state)return this.scale=e.end,!1;var{elapsed:e,duration:t,start:i,end:a}=e,e=e/t;this.scale=i*(1-e)+a*e,this.resize(),this.requestRendering()}}),window.on("themechange",this.themechange),_("#animSpriteFrame").on("resize",this.windowResize),_("#animSpriteFrame-properties-detail").on("toggle",this.windowResize),_("#animSpriteFrame-sprite-detail").on("toggle",this.windowResize),this.slider.on("focus",this.zoomFocus),this.slider.on("input",this.zoomInput),this.screen.on("keydown",this.screenKeydown),this.screen.on("wheel",this.screenWheel),this.screen.on("userscroll",this.screenUserscroll),this.marquee.on("pointerdown",this.marqueePointerdown)},y.open=function(e){this.target!==e&&(this.close(),Ke.timelineMarquee.layer.sprite)&&(this.state="loading",this.target=e,this.loadImage())},y.close=function(){"closed"!==this.state&&(this.state="closed",this.symbol=null,this.target=null,this.image=null,this.window.hide(),this.info.clear(),this.marquee.clear(),this.stopRendering())},y.suspend=function(){"open"===this.state&&(this.state="suspended",this.info.hide(),this.slider.hide(),this.stopRendering())},y.resume=function(){"suspended"===this.state&&(this.state="open",this.info.show(),this.slider.show(),this.resize(),this.requestRendering())},y.setZoom=function(){const i=_("#sprite-zoom");return function(t){if(this.zoom!==t){let e;switch(t){case 0:e=.25;break;case 1:e=.5;break;case 2:e=1;break;case 3:e=2;break;case 4:e=4;break;default:return}this.zoom=t,i.write(t),"open"===this.state?((t=this.zoomTimer).start=this.scale,t.end=e,t.elapsed=0,t.add()):this.scale=e}}}(),y.loadImage=async function(){var e=this.symbol=Symbol(),t=Ke.timelineMarquee.layer.sprite;let i=Ke.player.textures[t];if(i instanceof Promise&&(i=await i),this.symbol===e){if(this.symbol=null,!i)return this.close();t=i.base["image"];this.image=t,this.hframes=i.hframes,this.vframes=i.vframes,this.unitWidth=i.width,this.unitHeight=i.height,this.window.show(),0<this.body.clientWidth?(this.state="open",this.resize(),this.requestRendering()):this.state="suspended"}},y.updateTargetInfo=function(){var e,t,i,a=this["target"];a&&(e=a.spriteX,a=a.spriteY,t=this.unitWidth,i=this.unitHeight,this.info.textContent=e+`,${a} [${t}x${i}]`)},y.resize=function(){var e,t,i,a,n,s,r,o,l,c,h;"open"===this.state&&(c=this.scale,l=Math.round(this.unitWidth*c),c=Math.round(this.unitHeight*c),e=this.hframes*l,t=this.vframes*c,i=(a=CSS.getDevicePixelContentBoxSize(this.screen)).width,a=a.height,n=Math.max(i-e>>1,0),s=Math.max(a-t>>1,0),h=Math.max(e,i),o=Math.max(t,a),r=window.devicePixelRatio,this.scaleX=l/this.unitWidth,this.scaleY=c/this.unitHeight,this.scaledUnitWidth=l,this.scaledUnitHeight=c,this.outerWidth=h,this.outerHeight=o,this.screenWidth=i,this.screenHeight=a,this.centerOffsetX=i<h?i/2:n+e/2,this.centerOffsetY=a<o?a/2:s+t/2,this.paddingLeft=n,this.paddingTop=s,this.marquee.style.left=n/r+"px",this.marquee.style.top=s/r+"px",this.marquee.style.width=e/r+"px",this.marquee.style.height=t/r+"px",this.marquee.scaleX=l/r,this.marquee.scaleY=c/r,this.marquee.visible?this.marquee.select():(o=(h=this.target).spriteX,l=h.spriteY,this.centerX=o+.5,this.centerY=l+.5,this.marquee.select(o,l,1,1),this.updateTargetInfo()),c=Math.min(e,i),h=Math.min(t,a),this.canvas.style.left=n/r+"px",this.canvas.style.top=s/r+"px",this.canvas.dpr===r&&this.canvas.width===c&&this.canvas.height===h||(this.canvas.dpr=r,this.canvas.width=c,this.canvas.height=h,this.canvas.style.width=c/r+"px",this.canvas.style.height=h/r+"px",this.context.imageSmoothingEnabled=!1),this.updateCamera(),this.updateTransform(),this.screen.updateScrollbars())},y.getUnitCoords=function(){const n={x:0,y:0};return function(e){var e=e.getRelativeCoords(this.marquee),t=this.scaledUnitWidth,i=this.scaledUnitHeight,a=window.devicePixelRatio;return n.x=Math.clamp(Math.floor(e.x*a/t),0,this.hframes-1),n.y=Math.clamp(Math.floor(e.y*a/i),0,this.vframes-1),n}}(),y.updateCamera=function(e=this.centerX,t=this.centerY){var i=window.devicePixelRatio,a=this.screen,e=e*this.scaledUnitWidth+this.paddingLeft,t=t*this.scaledUnitHeight+this.paddingTop,n=1e-4*this.scaledUnitWidth,s=1e-4*this.scaledUnitHeight;a.rawScrollLeft=Math.clamp(e-this.centerOffsetX,0,this.outerWidth-this.screenWidth)/i,a.rawScrollTop=Math.clamp(t-this.centerOffsetY,0,this.outerHeight-this.screenHeight)/i,a.scrollLeft=(e-(this.screenWidth>>1)+n)/i,a.scrollTop=(t-(this.screenHeight>>1)+s)/i},y.updateTransform=function(){var e=window.devicePixelRatio,t=this.screen,i=Math.roundTo(t.scrollLeft*e,4),a=Math.roundTo(t.scrollTop*e,4),n=i+this.canvas.width,s=a+this.canvas.height,n=(this.scrollLeft=i,this.scrollTop=a,this.scrollRight=n,this.scrollBottom=s,this.context.setTransform(1,0,0,1,-i,-a),t.rawScrollLeft*e+this.centerOffsetX),s=t.rawScrollTop*e+this.centerOffsetY;this.centerX=Math.roundTo((n-this.paddingLeft)/this.scaledUnitWidth,4),this.centerY=Math.roundTo((s-this.paddingTop)/this.scaledUnitHeight,4)},y.updateBackground=Ue.updateBackground,y.drawSprite=function(){var e,t,i,a,n;0<this.body.clientWidth&&0!==this.canvas.width&&0!==this.canvas.height&&(e=this.context,t=this.scrollLeft,i=this.scrollTop,a=this.scrollRight,n=this.scrollBottom,e.clearRect(t,i,a-t,n-i),this.drawSpriteLayer(),this.drawGridLayer())},y.drawSpriteLayer=function(){var e=this.context,t=this.image,i=this.scaleX,a=this.scaleY,n=this.scrollLeft,s=this.scrollTop,r=this.scrollRight-n,o=this.scrollBottom-s;e.drawImage(t,n/i,s/a,r/i,o/a,n,s,r,o)},y.drawGridLayer=function(){if(this.showGrid){var t=this.context,i=this.scrollLeft,a=this.scrollTop,n=this.scrollRight,s=this.scrollBottom,r=this.scaledUnitWidth,o=this.scaledUnitHeight,l=Math.floor(i/r+1)*r,c=Math.floor(a/o+1)*o,h=Math.ceil(n/r)*r,d=Math.ceil(s/o)*o;t.beginPath();for(let e=c;e<d;e+=o)t.moveTo(i,e+.5),t.lineTo(n,e+.5);for(let e=l;e<h;e+=r)t.moveTo(e+.5,a),t.lineTo(e+.5,s);t.lineWidth=1,t.strokeStyle=this.gridColor,t.stroke()}},y.selectSprite=function(e,t){var i,a,n,s,r,o,l=this.target;null!==l&&(this.marquee.select(e,t,1,1),Ke.planToSave(),i=Ke.timelineMarquee.x,n=(a=Ke.history).index,s=a.length,r=a[n],o="animation-target-index",n===s-1&&void 0!==r&&r.type===o&&r.target===l||a.save({type:o,motion:Ke.motion,direction:Ke.direction,target:l,hindex:l.spriteX,vindex:l.spriteY}),l.spriteX=e,l.spriteY=t,this.updateTargetInfo(),Ke.loadFrames(i),Ke.requestRendering())},y.scrollToSelection=function(){var e,t,i,a,n,s,r,o=this.marquee;o.visible&&(i=this.scaledUnitWidth,r=this.scaledUnitHeight,t=o.x,s=o.y,e=o.width+t,o=o.height+s,a=t+(t=this.screenWidth/i/2)-(i=.5/i),n=o-(o=this.screenHeight/r/2)+(r=.5/r),s=s+o-r,o=Math.min(Math.max(this.centerX,e-t+i),a),r=Math.min(Math.max(this.centerY,n),s),this.centerX===o&&this.centerY===r||(this.updateCamera(o,r),this.updateTransform(),this.requestRendering(),this.screen.updateScrollbars()))},y.requestRendering=function(){"open"===this.state&&f.appendUpdater("sharedRendering",this.renderingFunction)},y.renderingFunction=function(){y.drawSprite()},y.stopRendering=function(){f.removeUpdater("sharedRendering",this.renderingFunction)},y.saveToProject=function(e){var e=e["sprite"],t=this.zoom;null!==t&&(e.zoom=t)},y.loadFromProject=function(e){e=e.sprite;this.setZoom(e.zoom)},y.windowResize=function(e){if(0===this.body.clientWidth)return this.suspend();switch(this.state){case"open":this.resize(),this.requestRendering();break;case"suspended":this.resume()}}.bind(y),y.themechange=function(e){switch(e.value){case"light":this.gridColor="rgba(0, 0, 0, 0.5)";break;case"dark":this.gridColor="rgba(255, 255, 255, 0.5)"}this.requestRendering()}.bind(y),y.zoomFocus=function(e){y.screen.focus()},y.zoomInput=function(e){y.setZoom(this.read())},y.screenKeydown=function(i){if("open"===y.state&&null===y.dragging)switch(i.code){case"ArrowLeft":case"ArrowUp":case"ArrowRight":case"ArrowDown":{let e=0,t=0;switch(i.code){case"ArrowLeft":e=-1;break;case"ArrowUp":t=-1;break;case"ArrowRight":e=1;break;case"ArrowDown":t=1}var a=y.marquee,n=Math.clamp(a.x+e,0,y.hframes-1),s=Math.clamp(a.y+t,0,y.vframes-1);a.x===n&&a.y===s||(y.selectSprite(n,s),y.scrollToSelection());break}case"Minus":case"NumpadSubtract":y.setZoom(y.zoom-1);break;case"Equal":case"NumpadAdd":y.setZoom(y.zoom+1);break;case"Digit0":case"Numpad0":y.setZoom(2)}},y.screenWheel=function(e){e.preventDefault(),0!==e.deltaY&&null===this.dragging&&this.setZoom(this.zoom+(0<e.deltaY?-1:1))}.bind(y),y.screenUserscroll=function(e){"open"===this.state&&(this.screen.rawScrollLeft=this.screen.scrollLeft,this.screen.rawScrollTop=this.screen.scrollTop,this.updateTransform(),this.updateBackground(),this.requestRendering(),this.screen.updateScrollbars())}.bind(y),y.marqueePointerdown=function(e){if(j.manager.focusing&&document.activeElement.blur(),!this.dragging)switch(e.button){case 0:if(e.altKey)return(this.dragging=e).mode="scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),void window.on("pointermove",this.pointermove);var{x:t,y:i}=this.getUnitCoords(e),a=this["marquee"];a.visible&&a.x===t&&a.y===i||this.selectSprite(t,i);break;case 2:(this.dragging=e).mode="scroll",e.scrollLeft=this.screen.scrollLeft,e.scrollTop=this.screen.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.pointerup),window.on("pointermove",this.pointermove)}}.bind(y),y.pointerup=function(e){var t=this["dragging"];t.relate(e)&&("scroll"===t.mode&&(this.screen.endScrolling(),pt.close("cursor-grab")),this.dragging=null,window.off("pointerup",this.pointerup),window.off("pointermove",this.pointermove))}.bind(y),y.pointermove=function(e){var t,i=this["dragging"];i.relate(e)&&"scroll"===i.mode&&(t=e.clientX-i.clientX,e=e.clientY-i.clientY,this.screen.beginScrolling(),this.screen.setScroll(i.scrollLeft-t,i.scrollTop-e))}.bind(y),_("#project-browser")),zt=(T.page=_("#project"),T.searcher=null,T.initialize=null,T.unselect=null,T.updateHead=null,T.openScript=null,T.createFile=null,T.updateNavVisibility=null,T.saveToProject=null,T.loadFromProject=null,T.pageResize=null,T.bodyOpen=null,T.bodySelect=null,T.bodyUnselect=null,T.bodyPopup=null,T.initialize=function(){this.searcher=this.links.head.searcher,this.searcher.addKeydownFilter(),this.page.on("resize",this.pageResize),this.body.on("open",this.bodyOpen),this.body.on("select",this.bodySelect),this.body.on("unselect",this.bodyUnselect),this.body.on("popup",this.bodyPopup)},T.unselect=function(e){var t=this.body,i=t.selections;1===i.length&&i[0].meta===e&&t.unselect()},T.updateHead=function(){var e,{page:t,head:i}=this;t.hasClass("visible")&&(t=x.getGroupOfElement(i)["nav"],e=t.rect(),e=(t=t.lastChild.rect()).right-e.left,i.left!==e&&(i.left=e,i.style.left=e+"px"),e=this.body.rect(),e=Math.max(e.left-t.right,0),i.padding!==e)&&(i.padding=e,i.style.paddingLeft=e+"px")},T.openScript=function(e){var t,{mode:i,path:a}=P.config.scriptEditor;switch(i){case"by-file-extension":R.openPath(R.route(e));break;case"specified-application":a&&(t=[R.route(e)],require("child_process").spawn(a,t))}},T.createFile=function(e,t){let i;for(;i=X.generate64bit(),He.manifest.guidMap[i];);const a=this["body"];var[e,n]=e.split("."),e=`${e}.${i}.`+n;const s=a.getDirName(),r=s+"/"+e;n=R.route(r),e=t instanceof Object?JSON.stringify(t,null,2):t;P.protectPromise(z.writeFile(n,e).then(()=>h.update()).then(e=>{e&&((e=h.getFolder(s)).path===s&&this.nav.load(e),(e=h.getFile(r))?.path===r)&&(a.select(e),a.rename(e)),console.log("写入文件:"+r)}).catch(e=>{console.warn(e)}))},T.updateNavVisibility=function(){this.page.hasClass("visible")&&(500<=T.clientWidth?this.removeClass("hide-nav-pane")&&this.nav.update():this.addClass("hide-nav-pane"))},T.saveToProject=function(e){var e=e["browser"],t=this.body["viewIndex"],i=this.nav.getSelections().map(e=>e.path);e.view=t??e.view,0!==i.length&&(e.folders=i)},T.loadFromProject=function(e){var{view:e,folders:t}=e.browser,i=[];for(const a of t)i.append(h.getFolder(a));0===i.length&&i.append(h.assets),this.directory=[h.assets],this.body.setViewIndex(e),this.nav.load(...i)},T.pageResize=function(e){T.updateNavVisibility(),T.updateHead(),T.nav.resize(),T.body.computeGridProperties(),T.body.resize(),T.body.updateContentSize()},T.bodyOpen=function(e){const t=e.value;switch(t.type){case"scene":case"ui":case"animation":case"particle":b.openTab(t);break;case"event":{const i=t.data;if(void 0===i)return;Nt.open("global",i,()=>{R.planToSave(t.meta);var e=Nt.save();i.type!==e.type&&(i.type=e.type,j.fileEvent.target===i)&&j.fileEvent.write({type:i.type}),i.commands=e.commands});break}case"audio":j.fileAudio.play();break;case"video":j.fileVideo.play();break;case"script":T.openScript(t.path);break;case"other":R.openPath(R.route(t.path))}},T.bodySelect=function(e){e=e.value;if(1===e.length&&e[0]instanceof q){var t=e[0],i=t.meta,e=t.type;if(i)switch(e){case"scene":case"ui":case"animation":case"particle":break;case"tileset":j.open("fileTileset",t.data,i);break;case"actor":j.open("fileActor",t.data,i);break;case"skill":j.open("fileSkill",t.data,i);break;case"trigger":j.open("fileTrigger",t.data,i);break;case"item":j.open("fileItem",t.data,i);break;case"equipment":j.open("fileEquipment",t.data,i);break;case"state":j.open("fileState",t.data,i);break;case"event":j.open("fileEvent",t.data,i);break;case"image":j.open("fileImage",t,i);break;case"audio":j.open("fileAudio",t,i);break;case"video":j.open("fileVideo",t,i);break;case"font":j.open("fileFont",t,i);break;case"script":j.open("fileScript",t,i)}}},T.bodyUnselect=function(e){var t;null!==j.meta&&(t=j.meta,1===(e=e.value).length)&&e[0].path===t.path&&j.close()},T.bodyPopup=function(e){var i=[],t=e.raw["target"],a=N.createGetter("menuFileBrowser");let n=!1;if(t.seek("file-body-pane")===this){var{browser:s,nav:r}=this.links;const o=r.selections;"normal"===s.display&&1===o.length&&(n=!0,i.push({label:a("showInExplorer"),click:()=>{R.openPath(R.route(o[0].path))}},{label:a("import"),click:()=>{this.importFiles()}}))}else{r=t.seek("file-body-item",2);if("FILE-BODY-ITEM"===r.tagName&&r.hasClass("selected")){s=this["selections"];const l=r["file"];t=1===s.length;switch(t&&s[0]instanceof B&&(n=!0),i.push({label:a("showInExplorer"),click:()=>{this.showInExplorer()}},{label:a("open"),accelerator:"Enter",enabled:t,click:()=>{this.openFile(l)}},{label:a("delete"),accelerator:"Delete",enabled:!s.includes(h.assets),click:()=>{this.deleteFiles()}},{label:a("rename"),accelerator:"F2",enabled:t&&l!==h.assets,click:()=>{this.rename(l)}},{label:a("export"),click:()=>{this.exportFile()}}),l.type){case"event":i.push({label:a("toggle"),click:()=>{var e=l["data"];e.enabled=!e.enabled,this.updateIcon(l),R.planToSave(l.meta)}});break;case"script":{const c=P.config["scriptEditor"];let{mode:e,path:t}=c;t=t&&E.normalize(t),i.push({label:a("settings"),submenu:[{label:a("openByFileExtension"),checked:"by-file-extension"===e,click:()=>{"by-file-extension"!==e&&(c.mode="by-file-extension",c.path="")}},{label:t||a("specifyTheScriptEditor"),checked:"specified-application"===e,click:()=>{R.showOpenDialog({title:"Browse for application",defaultPath:t||void 0,filters:[{name:"Script Editor",extensions:["exe"]}]}).then(({filePaths:e})=>{1===e.length&&(c.mode="specified-application",c.path=E.slash(e[0]))})}}]});break}}}}0!==i.length&&(n&&i.unshift({label:a("create"),submenu:[{label:a("create.folder"),click:()=>{this.createFolder()}},{label:a("create.actor"),click:()=>{T.createFile("Actor.actor",j.fileActor.create())}},{label:a("create.skill"),click:()=>{T.createFile("Skill.skill",j.fileSkill.create())}},{label:a("create.trigger"),click:()=>{T.createFile("Trigger.trigger",j.fileTrigger.create())}},{label:a("create.item"),click:()=>{T.createFile("Item.item",j.fileItem.create())}},{label:a("create.equipment"),click:()=>{T.createFile("Equipment.equip",j.fileEquipment.create())}},{label:a("create.state"),click:()=>{T.createFile("State.state",j.fileState.create())}},{label:a("create.event"),click:()=>{T.createFile("Event.event",j.fileEvent.create("global"))}},{label:a("create.script"),click:()=>{var e="javascript"===He.config.script.language?"js":"ts";T.createFile("Script."+e,j.fileScript.create())}},{label:a("create.scene"),click:()=>{T.createFile("Scene.scene",j.fileScene.create())}},{label:a("create.ui"),click:()=>{T.createFile("UI.ui",j.fileUI.create())}},{label:a("create.animation"),click:()=>{T.createFile("Animation.anim",j.fileAnimation.create())}},{label:a("create.particle"),click:()=>{T.createFile("Particle.particle",j.fileParticle.create())}},{label:a("create.normalTileset"),click:()=>{T.createFile("Tileset.tile",j.fileTileset.create("normal"))}},{label:a("create.autoTileset"),click:()=>{T.createFile("Tileset.tile",j.fileTileset.create("auto"))}}]}),ve.popup({x:e.clientX,y:e.clientY},i))},_("#selector-browser")),j=(zt.target=null,zt.allowNone=!0,zt.initialize=null,zt.open=null,zt.saveToProject=null,zt.loadFromProject=null,zt.windowClosed=null,zt.windowResize=null,zt.searcherKeydown=null,zt.bodyOpen=null,zt.bodyPopup=null,zt.confirm=null,zt.initialize=function(){this.body.on("open",this.bodyOpen),this.body.on("popup",this.bodyPopup),this.head.searcher.on("keydown",this.searcherKeydown),_("#selector").on("closed",this.windowClosed),_("#selector").on("resize",this.windowResize),_("#selector-confirm").on("click",this.confirm)},zt.open=function(e,t=!0){this.target=e,this.allowNone=t,O.open("selector");var{nav:t,head:i,body:a}=this,n=e.read(),n=He.manifest.guidMap[n],e=e.filter;this.filters=e?e.split("|"):null,a.computeGridProperties(),void 0!==n?(e=n.path,t.load(h.getFolder(e)),a.selectByPath(e)):t.load(h.assets),i.searcher.getFocus()},zt.saveToProject=function(e){var e=e["selector"],t=this.body["viewIndex"];e.view=t??e.view},zt.loadFromProject=function(e){e=e.selector.view;this.directory=[h.assets],this.body.setViewIndex(e)},zt.windowClosed=function(e){zt.target=null,zt.restoreDisplay(),zt.nav.clear(),zt.head.address.clear(),zt.body.clear()},zt.windowResize=function(e){zt.nav.resize(),zt.body.computeGridProperties(),zt.body.resize(),zt.body.updateContentSize()},zt.searcherKeydown=function(e){if(!e.cmdOrCtrlKey&&!e.altKey&&!e.shiftKey)switch(e.code){case"Tab":zt.body.selectDefault();break;case"Enter":case"NumpadEnter":var t,i;this.read()&&(e.stopImmediatePropagation(),t=zt["body"],i=t["elements"],1===i.count)&&(i=i[0]["file"],i instanceof q)&&(t.select(i),zt.confirm(e))}},zt.bodyOpen=function(e){return zt.confirm(e)},zt.bodyPopup=function(e){var t=[],i=e.raw["target"],a=N.createGetter("menuFileBrowser");if(i.seek("file-body-pane")===this){var{browser:n,nav:s}=this.links;const r=s.selections;if("normal"!==n.display||1!==r.length)return;t.push({label:a("showInExplorer"),click:()=>{R.openPath(R.route(r[0].path))}})}else{s=i.seek("file-body-item",2);if("FILE-BODY-ITEM"===s.tagName&&s.hasClass("selected")){n=this["selections"];const o=s["file"];i=1===n.length;t.push({label:a("showInExplorer"),click:()=>{this.showInExplorer()}},{label:a(o instanceof B?"open":"select"),accelerator:"Enter",enabled:i,click:()=>{this.openFile(o)}},{label:a("delete"),accelerator:"Delete",enabled:!n.includes(h.assets),click:()=>{this.deleteFiles()}},{label:a("rename"),accelerator:"F2",enabled:i&&o!==h.assets,click:()=>{this.rename(o)}},{label:a("export"),click:()=>{this.exportFile()}})}}0!==t.length&&ve.popup({x:e.clientX,y:e.clientY},t)},zt.confirm=function(e){if(!zt.dragging){var t,i=zt.body.selections;switch(i.length){case 1:i[0]instanceof q&&void 0!==(t=i[0].meta)&&(zt.target.input(t.guid),O.close("selector"));break;case 0:zt.allowNone&&(zt.target.input(""),O.close("selector"))}}},{manager:null,type:null,meta:null,fileScene:null,fileUI:null,fileAnimation:null,fileParticle:null,fileTileset:null,fileActor:null,fileSkill:null,fileTrigger:null,fileItem:null,fileEquipment:null,fileState:null,fileEvent:null,fileImage:null,fileAudio:null,fileVideo:null,fileFont:null,fileScript:null,sceneActor:null,sceneRegion:null,sceneLight:null,sceneAnimation:null,sceneParticle:null,sceneParallax:null,sceneTilemap:null,uiElement:null,uiImage:null,uiText:null,uiTextBox:null,uiDialogBox:null,uiProgressBar:null,uiVideo:null,uiWindow:null,uiContainer:null,animMotion:null,animJointLayer:null,animJointFrame:null,animSpriteLayer:null,animSpriteFrame:null,animParticleLayer:null,animParticleFrame:null,particleLayer:null,initialize:null,open:null,close:null,getKey:null,inspectorResize:null,managerKeydown:null,scrollPointerdown:null,inputFocus:null,inputBlur:null,sliderFocus:null,sliderBlur:null,ParamHistory:null});j.initialize=function(){this.manager=_("#inspector-page-manager"),this.manager.focusing=null,this.manager.oldValue=null,this.manager.listenDraggingScrollbarEvent(this.scrollPointerdown,{capture:!0}),l.processors["inspector-change"]=(e,t)=>{var{editor:i,target:a,changes:t}=t;for(const r of t){var n=r.input,s="undo"===e?r.oldValue:r.newValue;i.target===a?(n.write(s),n.dispatchEvent(new Event("input"))):(n=j.getKey(n),i.update(a,n,s))}i.owner?.setTarget(a)},l.processors["inspector-layer-change"]=(e,t)=>{var{target:i,motion:a,direction:n}=t;l.processors["inspector-change"](e,t),Ke.setMotion(a),Ke.setDirection(n),Ke.openLayer(i)},l.processors["inspector-frame-change"]=(e,t)=>{var{target:i,motion:a,direction:n}=t;l.processors["inspector-change"](e,t),Ke.setMotion(a),Ke.setDirection(n),Ke.selectFrame(i)},l.processors["inspector-param-insert"]=(e,t)=>{var{history:i,target:a}=t,{owner:i,list:n}=i;Ae.restore(n,t,"insert",e),i.setTarget(a),i.planToSave()},l.processors["inspector-param-replace"]=(e,t)=>{var{history:i,target:a}=t,{owner:i,list:n}=i;Ae.restore(n,t,"replace",e),i.setTarget(a),i.planToSave()},l.processors["inspector-param-delete"]=(e,t)=>{var{history:i,target:a}=t,{owner:i,list:n}=i;Ae.restore(n,t,"delete",e),i.setTarget(a),i.planToSave()},l.processors["inspector-param-toggle"]=(e,t)=>{var{history:i,target:a}=t,{owner:i,list:n}=i;Ae.restore(n,t,"toggle",e),i.setTarget(a),i.planToSave()},l.processors["script-parameter-change"]=(e,t)=>{var{editor:i,target:a,meta:n,list:s,parameters:r,key:o,value:l}=t;t.value=r[o],r[o]=l,i.target===a&&s.rewrite(r,o),i.owner.setTarget(a,n)},_("#inspector").on("resize",this.inspectorResize),this.manager.on("keydown",this.managerKeydown),this.fileScene.initialize(),this.fileUI.initialize(),this.fileAnimation.initialize(),this.fileTileset.initialize(),this.fileActor.initialize(),this.fileSkill.initialize(),this.fileTrigger.initialize(),this.fileItem.initialize(),this.fileEquipment.initialize(),this.fileState.initialize(),this.fileEvent.initialize(),this.fileImage.initialize(),this.fileAudio.initialize(),this.fileVideo.initialize(),this.fileFont.initialize(),this.fileScript.initialize(),this.sceneActor.initialize(),this.sceneRegion.initialize(),this.sceneLight.initialize(),this.sceneAnimation.initialize(),this.sceneParticle.initialize(),this.sceneParallax.initialize(),this.sceneTilemap.initialize(),this.uiElement.initialize(),this.uiImage.initialize(),this.uiText.initialize(),this.uiTextBox.initialize(),this.uiDialogBox.initialize(),this.uiProgressBar.initialize(),this.uiVideo.initialize(),this.uiWindow.initialize(),this.animMotion.initialize(),this.animJointFrame.initialize(),this.animSpriteLayer.initialize(),this.animSpriteFrame.initialize(),this.animParticleLayer.initialize(),this.animParticleFrame.initialize(),this.particleLayer.initialize()},j.open=function(e,t,i){this.manager.contains(document.activeElement)&&document.activeElement.blur(),this.type!==e&&(null!==this.type&&this[this.type].close(),this.type=e,this.manager.switch(e)),t?(this.meta=i||null,this[e].open(t,i)):this.close()},j.close=function(e){this.manager.contains(document.activeElement)&&document.activeElement.blur(),void 0===e&&(e=this.type||void 0),this.type===e&&(this[this.type].close(),this.type=null,this.meta=null,this.manager.switch(null))},j.getKey=function(e){let t=e.key;var i,a;return void 0===t&&(a=(i=e.id).indexOf("-")+1,t=e.key=i.slice(a)),t},j.inspectorResize=function(){const i=new Event("resize");return function(e){var t=j.manager.active;t instanceof HTMLElement&&t.dispatchEvent(i)}}(),j.managerKeydown=function(e){var t=e.target;switch(t.tagName){case"INPUT":case"TEXTAREA":if("range"!==t.type){if(e.cmdOrCtrlKey)"KeyS"!==e.code&&e.stopPropagation();else switch(e.code){case"Escape":case"F1":case"F2":case"F3":case"F4":break;default:e.stopPropagation()}break}default:if(e.cmdOrCtrlKey)switch(e.code){case"KeyZ":case"KeyY":j.manager.focusing&&document.activeElement.blur()}}},j.scrollPointerdown=function(t){if(!this.dragging&&0===t.button)if(t.altKey&&!(t.target instanceof r)){let e=t.target;for(;e!==this;){if(e.scrollPointerup&&e.hasScrollBar())return;e=e.parentNode}t.preventDefault(),t.stopImmediatePropagation(),(this.dragging=t).mode="scroll",t.scrollLeft=this.scrollLeft,t.scrollTop=this.scrollTop,pt.open("cursor-grab"),window.on("pointerup",this.scrollPointerup),window.on("pointermove",this.scrollPointermove)}},j.inputFocus=function(e){if(null===O.activeElement){var t,i,a=j["manager"];if(null!==a.focusing)return t=a.focusing.id,i=this.id,oi.throw(new Error(`Inspector focus error: ${t} -> `+i));a.focusing=this,a.oldValue=this.read()}},j.inputBlur=function(r,o,l=null){return function(e){var t,i,a,n,s;null===O.activeElement&&(t=j["manager"],null!==t.focusing)&&(i=r.target,s=t.oldValue,a=this.read(),null!==i&&(n=[],s!==a&&n.push({input:this,oldValue:s,newValue:a}),this.changes&&n.push(...this.changes),0!==n.length)&&(o.history.save(s={type:"inspector-change",editor:r,target:i,changes:n}),l?.(s)),this.changes&&delete this.changes,t.focusing=null,t.oldValue=null)}},j.sliderFocus=function(){const t=new FocusEvent("focus");return function(e){this.synchronizer.dispatchEvent(t)}}(),j.sliderBlur=function(){const t=new FocusEvent("blur");return function(e){this.synchronizer.dispatchEvent(t)}}(),j.ParamHistory=class{editor;owner;list;constructor(e,t,i){this.editor=e,this.owner=t,this.list=i}reset(){}save(e){var t=this.editor["target"];if(null!==t){switch(e.type){case"insert":e.type="inspector-param-insert";break;case"replace":e.type="inspector-param-replace";break;case"delete":e.type="inspector-param-delete";break;case"toggle":e.type="inspector-param-toggle"}e.history=this,e.target=t,this.owner.history.save(e)}}restore(e){this.owner.history.restore(e)}canUndo(){var e=this.owner.history;return 0===e[e.index]?.type.indexOf("inspector-param")}canRedo(){var e=this.owner.history;return 0===e[e.index+1]?.type.indexOf("inspector-param")}};{const Ci={button:_("#scene-switch-settings"),owner:null,target:null,initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};Ci.initialize=function(){this.owner={setTarget:e=>{this.target!==e&&j.open("fileScene",e)},planToSave:()=>{A.planToSave()},get history(){return A.history}},_("#fileScene-contrast-slider").synchronize(_("#fileScene-contrast")),_("#fileScene-ambient-red-slider").synchronize(_("#fileScene-ambient-red")),_("#fileScene-ambient-green-slider").synchronize(_("#fileScene-ambient-green")),_("#fileScene-ambient-blue-slider").synchronize(_("#fileScene-ambient-blue")),_("#fileScene-events").bind(new ft(this,this.owner)),_("#fileScene-scripts").bind(new vt(this,this.owner)),_("#fileScene-parameter-pane").bind(_("#fileScene-scripts"));var e=_(`#fileScene-tileWidth, #fileScene-tileHeight, #fileScene-contrast,
    #fileScene-ambient-red, #fileScene-ambient-green, #fileScene-ambient-blue`),t=_(`#fileScene-contrast-slider, #fileScene-ambient-red-slider,
    #fileScene-ambient-green-slider, #fileScene-ambient-blue-slider`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,this.owner)),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur),_("#fileScene-width, #fileScene-height").on("change",this.paramInput),_("#fileScene-events, #fileScene-scripts").on("change",A.listChange)},Ci.create=function(){var e=[],t={},i=P.project.scene.defaultFolders;for(const a of Object.values(i))a&&void 0===t[a]&&(t[a]=!0,e.push({class:"folder",name:a,expanded:!0,hidden:!1,locked:!1,children:[]}));return _e.encodeScene(Object.defineProperties({width:20,height:20,tileWidth:32,tileHeight:32,contrast:1,ambient:{red:255,green:255,blue:255},terrains:A.createTerrains(20,20),events:[],scripts:[],objects:e},{terrainsCode:{writable:!0,value:""},terrainsChanged:{writable:!0,value:!0}}))},Ci.open=function(e){this.target!==e&&(this.target=e,this.button.addClass("selected"),(e=D("fileScene",e))("width"),e("height"),e("tileWidth"),e("tileHeight"),e("contrast"),e("ambient-red"),e("ambient-green"),e("ambient-blue"),e("events"),e("scripts"))},Ci.close=function(){this.target&&(this.target=null,this.button.removeClass("selected"),_("#fileScene-events").clear(),_("#fileScene-scripts").clear(),_("#fileScene-parameter-pane").clear())},Ci.write=function(e){void 0!==e.width&&_("#fileScene-width").write(e.width),void 0!==e.height&&_("#fileScene-height").write(e.height)},Ci.update=function(e,t,i){switch(A.planToSave(),t){case"width":e.width!==i&&e.setSize(i,e.height);break;case"height":e.height!==i&&e.setSize(e.width,i);break;case"tileWidth":e.tileWidth!==i&&e.setTileSize(i,e.tileHeight);break;case"tileHeight":e.tileHeight!==i&&e.setTileSize(e.tileWidth,i);break;case"contrast":e.contrast!==i&&(e.contrast=i,e.requestRendering(),We.setContrast(i));break;case"ambient-red":case"ambient-green":case"ambient-blue":var a=t.indexOf("-")+1,a=t.slice(a);e.ambient[a]!==i&&(e.ambient[a]=i,e.requestRendering(),We.setAmbientLight(e.ambient))}},Ci.paramInput=function(e){Ci.update(Ci.target,j.getKey(this),this.read())},j.fileScene=Ci}{const Ei={button:_("#ui-switch-settings"),owner:null,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};Ei.initialize=function(){this.owner={setTarget:e=>{this.target!==e&&j.open("fileUI",e)},planToSave:()=>{Y.planToSave()},get history(){return Y.history}};var e=_("#fileUI-width, #fileUI-height");e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,this.owner))},Ei.create=function(){var e=He.config["resolution"];return{width:e.width,height:e.height,nodes:[]}},Ei.open=function(e){this.target!==e&&(this.target=e,this.button.addClass("selected"),(e=D("fileUI",e))("width"),e("height"))},Ei.close=function(){this.target&&(this.target=null,this.button.removeClass("selected"))},Ei.update=function(e,t,i){switch(Y.planToSave(),t){case"width":e.width!==i&&e.setSize(i,e.height);break;case"height":e.height!==i&&e.setSize(e.width,i)}},Ei.paramInput=function(e){Ei.update(Ei.target,j.getKey(this),this.read())},j.fileUI=Ei}{const Mi={button:_("#animation-switch-settings"),owner:null,target:null,sprites:null,initialize:null,create:null,open:null,close:null};Mi.initialize=function(){this.owner={setTarget:e=>{this.target!==e&&j.open("fileAnimation",e)},planToSave:()=>{Ke.planToSave()},get history(){return Ke.history}},_("#fileAnimation-sprites").bind(this.sprites),_("#fileAnimation-sprites").on("change",Ke.listChange)},Mi.create=function(){return{sprites:[],motions:[]}},Mi.open=function(e){this.target!==e&&(this.target=e,this.button.addClass("selected"),D("fileAnimation",e)("sprites"))},Mi.close=function(){this.target&&(this.target=null,this.button.removeClass("selected"))},Mi.sprites={list:null,spriteId:"",initialize:function(e){_("#fileAnimation-sprite-confirm").on("click",()=>e.save()),this.list=e,this.history=new j.ParamHistory(Mi,Mi.owner,e),e.on("change",e=>{Ke.sprites&&(Ke.sprites.listItems&&(Ke.sprites.listItems=void 0),Ke.loadTextures())})},parse:function({name:e,image:t,hframes:i,vframes:a}){return[e,I.parseFileName(t)+` [${i}x${a}]`]},createSpriteId:function(e=Object.empty){let t;for(;t=X.generate64bit(),this.list.data.find(e=>e.id===t)&&e[t];);return t},open:function({name:e="",id:t=this.createSpriteId(),image:i="",hframes:a=1,vframes:n=1}={}){O.open("fileAnimation-sprite");var s=D("fileAnimation-sprite");s("name",e),s("image",i),s("hframes",a),s("vframes",n),this.spriteId=t,(e?_("#fileAnimation-sprite-image"):_("#fileAnimation-sprite-name")).getFocus()},save:function(){var e,t,i,a=g("fileAnimation-sprite"),n=a("name").trim();return n?(e=a("image"),t=a("hframes"),a=a("vframes"),i=this.spriteId,O.close("fileAnimation-sprite"),{name:n,id:i,image:e,hframes:t,vframes:a}):_("#fileAnimation-sprite-name").getFocus()},onPaste:function(e,t){var i={};for(const n of t){var a=this.createSpriteId(i);i[n.id=a]=!0}}},j.fileAnimation=Mi}Oe={create:null};Oe.create=function(){return{duration:0,layers:[]}},j.fileParticle=Oe;{const Si={target:null,meta:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};Si.initialize=function(){_(`#fileTileset-image, #fileTileset-tileWidth, #fileTileset-tileHeight,
    #fileTileset-globalOffsetX, #fileTileset-globalOffsetY,
    #fileTileset-globalPriority`).on("input",this.paramInput),_("#fileTileset-width, #fileTileset-height").on("change",this.paramInput),Ue.initialize()},Si.create=function(e){switch(e){case"normal":return{type:"normal",image:"",width:1,height:1,tileWidth:32,tileHeight:32,globalOffsetX:0,globalOffsetY:0,globalPriority:0,priorities:[0]};case"auto":return{type:"auto",width:1,height:1,tileWidth:32,tileHeight:32,globalOffsetX:0,globalOffsetY:0,globalPriority:0,tiles:[0],priorities:[0]}}},Si.open=function(e,t){if(this.meta!==t){switch(this.target=e,this.meta=t,Ue.open(t),j.manager.addClass("overflow-visible"),e.type){case"normal":_("#fileTileset-image").enable();break;case"auto":_("#fileTileset-image").disable()}t=D("fileTileset",e);t("image",e.image??""),t("width"),t("height"),t("tileWidth"),t("tileHeight"),t("globalOffsetX"),t("globalOffsetY"),t("globalPriority")}},Si.close=function(){this.target&&(j.manager.removeClass("overflow-visible"),T.unselect(this.meta),Ue.close(),this.target=null,this.meta=null)},Si.update=function(e,t,i){switch(R.planToSave(this.meta),t){case"image":e.image!==i&&Ue.setImage(i);break;case"width":e.width!==i&&Ue.setSize(i,e.height);break;case"height":e.height!==i&&Ue.setSize(e.width,i);break;case"tileWidth":e.tileWidth!==i&&Ue.setTileSize(i,e.tileHeight);break;case"tileHeight":e.tileHeight!==i&&Ue.setTileSize(e.tileWidth,i);break;case"globalOffsetX":case"globalOffsetY":case"globalPriority":e[t]!==i&&(e[t]=i)}A.requestRendering()},Si.paramInput=function(e){Si.update(Si.target,j.getKey(this),this.read())},j.fileTileset=Si}{const Ai={target:null,meta:null,sprites:null,skills:null,equipments:null,initialize:null,create:null,open:null,close:null,update:null,animationIdWrite:null,paramInput:null,listChange:null};Ai.initialize=function(){_("#fileActor-attributes").bind(new mt),_("#fileActor-sprites").bind(this.sprites),_("#fileActor-skills").bind(this.skills),_("#fileActor-equipments").bind(this.equipments),_("#fileActor-events").bind(new ft),_("#fileActor-scripts").bind(new vt),_("#fileActor-parameter-pane").bind(_("#fileActor-scripts")),_("#fileActor-animationId").on("write",this.animationIdWrite),_(`#fileActor-portrait, #fileActor-clip, #fileActor-animationId,
    #fileActor-idleMotion, #fileActor-moveMotion, #fileActor-speed,
    #fileActor-size, #fileActor-weight`).on("input",this.paramInput),_(`#fileActor-sprites, #fileActor-attributes, #fileActor-skills, #fileActor-equipments,
    #fileActor-events, #fileActor-scripts
  `).on("change",this.listChange)},Ai.create=function(){return{portrait:"",clip:[0,0,64,64],animationId:"",idleMotion:"",moveMotion:"",speed:4,size:.8,weight:1,sprites:[],attributes:[],skills:[],equipments:[],events:[],scripts:[]}},Ai.open=function(e,t){this.meta!==t&&(this.target=e,this.meta=t,(t=D("fileActor",e))("portrait"),t("clip"),t("animationId"),t("idleMotion"),t("moveMotion"),t("sprites"),t("speed"),t("size"),t("weight"),t("attributes"),t("skills"),t("equipments"),t("events"),t("scripts"))},Ai.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,_("#fileActor-sprites").clear(),_("#fileActor-attributes").clear(),_("#fileActor-skills").clear(),_("#fileActor-equipments").clear(),_("#fileActor-events").clear(),_("#fileActor-scripts").clear(),_("#fileActor-parameter-pane").clear())},Ai.update=function(e,t,i){switch(R.planToSave(this.meta),t){case"portrait":case"clip":e[t]!==i&&(e[t]=i,T.body.updateIcon(this.meta.file));break;case"animationId":if(e.animationId!==i){var a=e.animationId;if(e.animationId=i,A.actors instanceof Array){var n=He.animations[a];for(const e of A.actors)e.player?.data===n&&(A.destroyObjectContext(e),A.loadActorContext(e));A.requestRendering()}}break;case"idleMotion":if(e[t]!==i&&(e[t]=i,A.actors instanceof Array)){var s,a=e.animationId,r=He.animations[a];for({player:s}of A.actors)s?.data===r&&(s.reset(),s.setMotion(i));A.requestRendering()}break;case"moveMotion":case"speed":case"size":case"weight":e[t]!==i&&(e[t]=i)}},Ai.animationIdWrite=function(e){var t=_("#fileActor-idleMotion"),i=_("#fileActor-moveMotion"),e=Ke.getMotionListItems(e.value);t.loadItems(e),i.loadItems(e),t.write2(t.read()),i.write2(i.read())},Ai.paramInput=function(e){Ai.update(Ai.target,j.getKey(this),this.read())},Ai.listChange=function(e){R.planToSave(Ai.meta)},Ai.sprites={initialize:function(e){_("#fileActor-sprite-confirm").on("click",()=>e.save()),e.on("change",e=>{var t=Ai.meta.guid;if(A.actors instanceof Array)for(const i of A.actors)i.actorId===t&&(A.destroyObjectContext(i),A.loadActorContext(i))})},parse:function({id:e,image:t}){I.invalid=!1;var i=Ai.target.animationId,i=I.parseSpriteName(i,e),e=I.invalid?"invalid":"",t=(I.invalid=!1,I.parseFileName(t));return[{content:i,class:e},{content:t,class:I.invalid?"invalid":""}]},open:function({id:e="",image:t=""}={}){O.open("fileActor-sprite");var i=Ai.target.animationId,i=Ke.getSpriteListItems(i),i=(_("#fileActor-sprite-id").loadItems(i),D("fileActor-sprite"));i("id",e),i("image",t),(e?_("#fileActor-sprite-image"):_("#fileActor-sprite-id")).getFocus()},save:function(){var e=g("fileActor-sprite"),t=e("id");return t?(e=e("image"),O.close("fileActor-sprite"),{id:t,image:e}):_("#fileActor-sprite-id").getFocus()}},Ai.skills={initialize:function(e){_("#fileActor-skill-confirm").on("click",()=>e.save())},parse:function({id:e,key:t}){I.invalid=!1;var e=I.parseFileName(e),i=I.invalid?"invalid":"",t=(I.invalid=!1,t?I.parseGroupEnumString("shortcut-key",t):"");return[{content:e,class:i},{content:t,class:I.invalid?"invalid":"weak"}]},open:function({id:e="",key:t=""}={}){O.open("fileActor-skill");var i=_("#fileActor-skill-id"),a=_("#fileActor-skill-key"),n=M.getStringItems("shortcut-key",!0);a.loadItems(n),i.write(e),a.write(t),i.getFocus()},save:function(){var e=_("#fileActor-skill-id"),t=_("#fileActor-skill-key"),i=e.read();return i?(t=t.read(),O.close("fileActor-skill"),{id:i,key:t}):e.getFocus()}},Ai.equipments={initialize:function(e){_("#fileActor-equipment-confirm").on("click",()=>e.save())},parse:function({id:e,slot:t}){I.invalid=!1;var e=I.parseFileName(e),i=I.invalid?"invalid":"",t=(I.invalid=!1,t?I.parseGroupEnumString("equipment-slot",t):"");return[{content:e,class:i},{content:t,class:I.invalid?"invalid":"weak"}]},open:function({id:e="",slot:t=M.getDefStringId("equipment-slot")}={}){O.open("fileActor-equipment");var i=_("#fileActor-equipment-id"),a=_("#fileActor-equipment-slot"),n=M.getStringItems("equipment-slot");a.loadItems(n),i.write(e),a.write(t),i.getFocus()},save:function(){var e,t=_("#fileActor-equipment-id"),i=_("#fileActor-equipment-slot"),a=t.read();return a?(e=i.read())?(O.close("fileActor-equipment"),{id:a,slot:e}):i.getFocus():t.getFocus()}},j.fileActor=Ai}{const Pi={target:null,meta:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null,listChange:null};Pi.initialize=function(){_("#fileSkill-attributes").bind(new mt),_("#fileSkill-events").bind(new ft),_("#fileSkill-scripts").bind(new vt),_("#fileSkill-parameter-pane").bind(_("#fileSkill-scripts")),_("#fileSkill-icon, #fileSkill-clip").on("input",this.paramInput),_("#fileSkill-attributes, #fileSkill-events, #fileSkill-scripts").on("change",this.listChange)},Pi.create=function(){return{icon:"",clip:[0,0,32,32],attributes:[],events:[],scripts:[]}},Pi.open=function(e,t){this.meta!==t&&(this.target=e,this.meta=t,(t=D("fileSkill",e))("icon"),t("clip"),t("attributes"),t("events"),t("scripts"))},Pi.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,_("#fileSkill-attributes").clear(),_("#fileSkill-events").clear(),_("#fileSkill-scripts").clear(),_("#fileSkill-parameter-pane").clear())},Pi.update=function(e,t,i){switch(R.planToSave(this.meta),t){case"icon":case"clip":e[t]!==i&&(e[t]=i,T.body.updateIcon(this.meta.file))}},Pi.paramInput=function(e){Pi.update(Pi.target,j.getKey(this),this.read())},Pi.listChange=function(e){R.planToSave(Pi.meta)},j.fileSkill=Pi}{const Li={target:null,meta:null,motions:null,initialize:null,create:null,open:null,close:null,update:null,animationIdWrite:null,paramInput:null,listChange:null};Li.initialize=function(){_("#fileTrigger-selector").loadItems([{name:"Enemy",value:"enemy"},{name:"Friend",value:"friend"},{name:"Team Member",value:"team"},{name:"Team Member Except Self",value:"team-except-self"},{name:"Any Except Self",value:"any-except-self"},{name:"Any",value:"any"}]),_("#fileTrigger-onHitWalls").loadItems([{name:"Through",value:"through"},{name:"Destroy",value:"destroy"}]),_("#fileTrigger-onHitActors").loadItems([{name:"Through",value:"through"},{name:"Destroy",value:"destroy"}]),_("#fileTrigger-shape-type").loadItems([{name:"Rectangle",value:"rectangle"},{name:"Circle",value:"circle"},{name:"Sector",value:"sector"}]),_("#fileTrigger-shape-type").enableHiddenMode().relate([{case:"rectangle",targets:[_("#fileTrigger-shape-width"),_("#fileTrigger-shape-height")]},{case:"circle",targets:[_("#fileTrigger-shape-radius")]},{case:"sector",targets:[_("#fileTrigger-shape-radius"),_("#fileTrigger-shape-centralAngle")]}]),_("#fileTrigger-hitMode").loadItems([{name:"Once",value:"once"},{name:"Once On Overlap",value:"once-on-overlap"},{name:"Repeat",value:"repeat"}]),_("#fileTrigger-hitMode").enableHiddenMode().relate([{case:"repeat",targets:[_("#fileTrigger-hitInterval")]}]),_("#fileTrigger-rotatable").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#fileTrigger-events").bind(new ft),_("#fileTrigger-scripts").bind(new vt),_("#fileTrigger-parameter-pane").bind(_("#fileTrigger-scripts")),_("#fileTrigger-animationId").on("write",this.animationIdWrite),_(`#fileTrigger-selector, #fileTrigger-onHitWalls, #fileTrigger-onHitActors,
    #fileTrigger-shape-type, #fileTrigger-shape-width, #fileTrigger-shape-height,
    #fileTrigger-shape-radius, #fileTrigger-shape-centralAngle, #fileTrigger-speed,
    #fileTrigger-hitMode, #fileTrigger-hitInterval,
    #fileTrigger-initialDelay, #fileTrigger-effectiveTime, #fileTrigger-duration,
    #fileTrigger-animationId, #fileTrigger-motion,
    #fileTrigger-priority, #fileTrigger-offsetY, #fileTrigger-rotatable
  `).on("input",this.paramInput),_("#fileTrigger-events, #fileTrigger-scripts").on("change",this.listChange)},Li.create=function(){return{selector:"enemy",onHitWalls:"through",onHitActors:"through",shape:{type:"circle",radius:.25},speed:0,hitMode:"once",hitInterval:0,initialDelay:0,effectiveTime:0,duration:0,animationId:"",motion:"",priority:0,offsetY:0,rotatable:!0,events:[],scripts:[]}},Li.open=function(e,t){this.meta!==t&&(this.target=e,this.meta=t,t=D("fileTrigger",e),e=e.shape,t("selector"),t("onHitWalls"),t("onHitActors"),t("shape-type"),t("shape-width",e.width??1),t("shape-height",e.height??1),t("shape-radius",e.radius??.5),t("shape-centralAngle",e.centralAngle??90),t("speed"),t("hitMode"),t("hitInterval"),t("initialDelay"),t("effectiveTime"),t("duration"),t("animationId"),t("motion"),t("priority"),t("offsetY"),t("rotatable"),t("events"),t("scripts"))},Li.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,this.motions=null,_("#fileTrigger-events").clear(),_("#fileTrigger-scripts").clear(),_("#fileTrigger-parameter-pane").clear())},Li.update=function(e,t,i){switch(R.planToSave(this.meta),t){case"selector":case"onHitWalls":case"onHitActors":case"speed":case"hitMode":case"hitInterval":case"initialDelay":case"effectiveTime":case"duration":e[t]!==i&&(e[t]=i);break;case"shape-type":if(e.shape.type!==i){var a=g("fileTrigger-shape");switch(i){case"rectangle":e.shape={type:"rectangle",width:a("width"),height:a("height")};break;case"circle":e.shape={type:"circle",radius:a("radius")};break;case"sector":e.shape={type:"sector",radius:a("radius"),centralAngle:a("centralAngle")}}}break;case"shape-width":case"shape-height":case"shape-radius":case"shape-centralAngle":var n=t.indexOf("-")+1,n=t.slice(n);e.shape[n]!==i&&(e.shape[n]=i);break;case"animationId":e.animationId!==i&&(e.animationId=i,Li.motions=null);break;case"motion":case"priority":case"offsetY":case"rotatable":e[t]!==i&&(e[t]=i)}},Li.animationIdWrite=function(e){var t=_("#fileTrigger-motion");t.loadItems(Ke.getMotionListItems(e.value)),t.write2(t.read())},Li.paramInput=function(e){Li.update(Li.target,j.getKey(this),this.read())},Li.listChange=function(e){R.planToSave(Li.meta)},j.fileTrigger=Li}{const q={target:null,meta:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null,listChange:null};q.initialize=function(){_("#fileItem-attributes").bind(new mt),_("#fileItem-events").bind(new ft),_("#fileItem-scripts").bind(new vt),_("#fileItem-parameter-pane").bind(_("#fileItem-scripts")),_("#fileItem-icon, #fileItem-clip").on("input",this.paramInput),_("#fileItem-attributes, #fileItem-events, #fileItem-scripts").on("change",this.listChange)},q.create=function(){return{icon:"",clip:[0,0,32,32],attributes:[],events:[],scripts:[]}},q.open=function(e,t){this.meta!==t&&(this.target=e,this.meta=t,(t=D("fileItem",e))("icon"),t("clip"),t("attributes"),t("events"),t("scripts"))},q.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,_("#fileItem-attributes").clear(),_("#fileItem-events").clear(),_("#fileItem-scripts").clear(),_("#fileItem-parameter-pane").clear())},q.update=function(e,t,i){switch(R.planToSave(this.meta),t){case"icon":case"clip":e[t]!==i&&(e[t]=i,T.body.updateIcon(this.meta.file))}},q.paramInput=function(e){q.update(q.target,j.getKey(this),this.read())},q.listChange=function(e){R.planToSave(q.meta)},j.fileItem=q}{const Ri={target:null,meta:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null,listChange:null};Ri.initialize=function(){_("#fileEquipment-attributes").bind(new mt),_("#fileEquipment-events").bind(new ft),_("#fileEquipment-scripts").bind(new vt),_("#fileEquipment-parameter-pane").bind(_("#fileEquipment-scripts")),_("#fileEquipment-icon, #fileEquipment-clip").on("input",this.paramInput),_("#fileEquipment-attributes, #fileEquipment-events, #fileEquipment-scripts").on("change",this.listChange)},Ri.create=function(){return{icon:"",clip:[0,0,32,32],attributes:[],events:[],scripts:[]}},Ri.open=function(e,t){this.meta!==t&&(this.target=e,this.meta=t,(t=D("fileEquipment",e))("icon"),t("clip"),t("attributes"),t("events"),t("scripts"))},Ri.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,_("#fileEquipment-attributes").clear(),_("#fileEquipment-events").clear(),_("#fileEquipment-scripts").clear(),_("#fileEquipment-parameter-pane").clear())},Ri.update=function(e,t,i){switch(R.planToSave(this.meta),t){case"icon":case"clip":e[t]!==i&&(e[t]=i,T.body.updateIcon(this.meta.file))}},Ri.paramInput=function(e){Ri.update(Ri.target,j.getKey(this),this.read())},Ri.listChange=function(e){R.planToSave(Ri.meta)},j.fileEquipment=Ri}{const Fi={target:null,meta:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null,listChange:null};Fi.initialize=function(){_("#fileState-attributes").bind(new mt),_("#fileState-events").bind(new ft),_("#fileState-scripts").bind(new vt),_("#fileState-parameter-pane").bind(_("#fileState-scripts")),_("#fileState-icon, #fileState-clip").on("input",this.paramInput),_("#fileState-attributes, #fileState-events, #fileState-scripts").on("change",this.listChange)},Fi.create=function(){return{icon:"",clip:[0,0,32,32],attributes:[],events:[],scripts:[]}},Fi.open=function(e,t){this.meta!==t&&(this.target=e,this.meta=t,(t=D("fileState",e))("icon"),t("clip"),t("attributes"),t("events"),t("scripts"))},Fi.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,_("#fileState-attributes").clear(),_("#fileState-events").clear(),_("#fileState-scripts").clear(),_("#fileState-parameter-pane").clear())},Fi.update=function(e,t,i){switch(R.planToSave(this.meta),t){case"icon":case"clip":e[t]!==i&&(e[t]=i,T.body.updateIcon(this.meta.file))}},Fi.paramInput=function(e){Fi.update(Fi.target,j.getKey(this),this.read())},Fi.listChange=function(e){R.planToSave(Fi.meta)},j.fileState=Fi}{const zi={target:null,meta:null,initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};zi.initialize=function(){_("#fileEvent-type").loadItems(Nt.types.global),Nt.types.relatedElements.push(_("#fileEvent-type")),_("#fileEvent-type").on("input",this.paramInput)},zi.create=function(e){var t=Nt.types[e][0].value;return"global"!==e?{type:t,commands:[]}:{enabled:!0,type:t,commands:[]}},zi.open=function(e,t){this.meta!==t&&(this.target=e,this.meta=t,_("#fileEvent-type").loadItems(M.getMergedItems(Nt.types.global,"global-event")),D("fileEvent")("type",e.type))},zi.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null)},zi.write=function(e){void 0!==e.type&&_("#fileEvent-type").write(e.type)},zi.update=function(e,t,i){R.planToSave(this.meta),"type"===t&&e.type!==i&&(e.type=i)},zi.paramInput=function(e){zi.update(zi.target,j.getKey(this),this.read())},j.fileEvent=zi}{const Bi={target:null,meta:null,symbol:null,image:null,initialize:null,open:null,close:null,updateImage:null,windowResize:null};Bi.initialize=function(){this.image=_("#fileImage-image"),_("#fileImage").on("resize",this.windowResize),_("#fileImage-image-detail").on("toggle",this.windowResize)},Bi.open=function(e,t){if(this.target!==e){this.target=e,this.meta=t;var t=_("#fileImage-name"),i=_("#fileImage-size");const n=_("#fileImage-resolution");var a=Number(e.stats.size);t.textContent=e.basename+e.extname,i.textContent=R.parseFileSize(a),n.textContent="";const s=this.image.hide();t=R.route(e.path);s.src=t;const r=this.symbol=Symbol();new Promise((e,t)=>{const i=setInterval(()=>{0!==s.naturalWidth?(clearInterval(i),e()):s.complete&&(clearInterval(i),t())})}).then(()=>{var e,t;this.symbol===r&&(this.symbol=null,this.updateImage(),e=s.naturalWidth,t=s.naturalHeight,n.textContent=e+" x "+t)})}},Bi.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,this.symbol=null,this.image.src="")},Bi.updateImage=function(){var i=this.image.hide(),a=i.parentNode,a=CSS.getDevicePixelContentBoxSize(a),n=a.width,a=a.height;if(0<n&&0<a){var s,r,o=i.naturalWidth,l=i.naturalHeight;let e,t;t=o<=n&&l<=a?(e=o,l):(s=n/o)<(r=a/l)?(e=n,Math.round(l*s)):(e=Math.round(o*r),a);l=window.devicePixelRatio;i.style.left=(n-e>>1)/l+"px",i.style.top=(a-t>>1)/l+"px",i.style.width=e/l+"px",i.style.height=t/l+"px",i.show()}},Bi.windowResize=function(e){null!==Bi.target&&null===Bi.symbol&&Bi.updateImage()},j.fileImage=Bi}{const Ni={target:null,meta:null,symbol:null,promise:null,progress:_("#fileAudio-progress"),progressFiller:_("#fileAudio-progress-filler"),pointer:_("#fileAudio-progress-pointer").hide(),currentTimeInfo:_("#fileAudio-currentTime"),pointerTimeInfo:_("#fileAudio-pointerTime"),canvas:_("#fileAudio-frequency-canvas"),context:null,dataArray:null,intervals:null,intensities:null,rotation:null,lineColor:null,initialize:null,open:null,close:null,play:null,writeParams:null,updateParams:null,updateParamInfos:null,updateCanvas:null,formatTime:null,requestAnimation:null,updateAnimation:null,stopAnimation:null,themechange:null,windowResize:null,paramInput:null,progressPointerdown:null,progressPointermove:null,progressPointerleave:null};Ni.initialize=function(){this.context=this.canvas.getContext("2d",{desynchronized:!0});var e=Je.analyser;e.fftSize=512,e.smoothingTimeConstant=0,this.dataArray=new Uint8Array(e.frequencyBinCount),this.intervals=new Float64Array(64),this.intensities=new Float64Array(64),this.intensities.index=0,window.on("themechange",this.themechange),_("#fileAudio").on("resize",this.windowResize),_("#fileAudio-frequency-detail").on("toggle",this.windowResize),_("#fileAudio-volume").on("input",this.paramInput),_("#fileAudio-pan").on("input",this.paramInput),_("#fileAudio-dry").on("input",this.paramInput),_("#fileAudio-wet").on("input",this.paramInput),this.progress.on("pointerdown",this.progressPointerdown),this.progress.on("pointermove",this.progressPointermove),this.progress.on("pointerleave",this.progressPointerleave)},Ni.open=function(e,t){if(this.target!==e){this.target=e,this.meta=t;var i=_("#fileAudio-name"),a=_("#fileAudio-size");const n=_("#fileAudio-duration"),s=_("#fileAudio-bitrate"),r=Number(e.stats.size),o=(i.textContent=e.basename+e.extname,a.textContent=R.parseFileSize(r),n.textContent="",s.textContent="",this.writeParams(Je.player.getParams()),Je.player.audio);i=e.path;if(o.path!==i){o.path=i,o.src=R.route(i),this.progress.removeClass("visible");const c=this.promise=Je.getWaveform(t.guid);c.then(e=>{this.promise===c&&(this.promise=null,this.progress.style.webkitMaskImage=e,this.progress.addClass("visible"))})}this.updateCanvas(),this.requestAnimation();const l=this.symbol=Symbol();new Promise(e=>{isNaN(o.duration)?o.on("loadedmetadata",()=>{e()},{once:!0}):e()}).then(()=>{var e,t;this.symbol===l&&(this.symbol=null,e=o.duration,t=Math.round(r/128/e),n.textContent=this.formatTime(e),s.textContent=t+"Kbps")})}},Ni.close=function(){this.target&&(this.promise&&(this.promise.canceled=!0,this.promise=null),T.unselect(this.meta),this.stopAnimation(),this.target=null,this.meta=null,this.symbol=null)},Ni.play=function(){var e;null!==this.target&&(e=Je.player["audio"],e.paused?e.play():e.currentTime=0)},Ni.writeParams=function(e){_("#fileAudio-volume").write(e.volume),_("#fileAudio-pan").write(e.pan),_("#fileAudio-dry").write(e.dry),_("#fileAudio-wet").write(e.wet),this.updateParamInfos(e)},Ni.updateParams=function(e){Je.player.setVolume(e.volume),Je.player.setPan(e.pan),Je.player.setReverb(e.dry,e.wet)},Ni.updateParamInfos=function(e){_("#fileAudio-volume-info").textContent=100*e.volume+"%",_("#fileAudio-pan-info").textContent=100*e.pan+"%",_("#fileAudio-dry-info").textContent=100*e.dry+"%",_("#fileAudio-wet-info").textContent=100*e.wet+"%"},Ni.updateCanvas=function(){var e,t,i=j.manager,a=this.canvas,n=i.scrollTop;a.hasClass("hidden")?(0!==a.width&&(a.width=0),0!==a.height&&(a.height=0)):(a.style.width="100%",a.style.height="0",e=window.devicePixelRatio,t=CSS.getDevicePixelContentBoxSize(a).width,a.height!==t&&(a.height=t),a.style.height=t/e+"px",t=CSS.getDevicePixelContentBoxSize(a).width,a.width!==t&&(a.width=t),a.style.width=t/e+"px"),i.scrollTop!==n&&(i.scrollTop=n)},Ni.formatTime=function(e){var t=Number.padZero,e=Math.floor(e),i=Math.floor(e/3600),a=Math.floor(e/60)%60,e=e%60;return i?`${i}:${t(a,60)}:`+t(e,60):a+":"+t(e,60)},Ni.requestAnimation=function(){null!==this.target&&f.appendUpdater("sharedAnimation",this.updateAnimation)},Ni.updateAnimation=function(r){var o=Je.player.audio,l=o.currentTime,o=o.duration||1/0,c=j.manager.clientWidth,o=Math.round(c*l/o),o=Math.roundTo(o/c*100,6),{progress:c,progressFiller:h}=Ni,c=(c.percent!==o&&(c.percent=o,h.style.width=o+"%"),Ni.formatTime(l)),h=Ni.currentTimeInfo,o=(h.textContent!==c&&(h.textContent=c),Ni.canvas),d=Ni.context,l=o.width,h=o.height;if(l*h!=0){var c=Je.analyser,u=Ni.dataArray,o=u.length,p=Math.floor(.1*o),m=Math.floor(.85*o),g=2*Math.PI/(m-p),f=Ni.intervals,v=Ni.intensities,b=v.length,y=v.index;let t=0,i=0;c.getByteFrequencyData(u);for(let e=p;e<m;e++){var w=u[e];0!==w&&(t+=w,i++)}0!==t&&(t=t/i/255*2),f[y]=r,v[y]=t,v.index=(y+1)%b;let e=0,a=0,n=0,s=y+b;for(;s>y;){var x=s--%b;if(e+=f[x],a+=v[x],n++,150<=e)break}var k,T,I,C,E,M=h/2,S=h/2,o=h*(.8+.2*(a/=n)),A=.1*h,c=.005*o,P=c/2,L=o/2-.04*h-A,R=Ni.rotation-p*g,F=Math.cos,z=Math.sin;d.clearRect(0,0,l,h),d.lineWidth=c,d.strokeStyle=Ni.lineColor,d.beginPath();for(let e=p;e<m;e++){var B,N,q,D,_=u[e];0!==_&&(q=M+(N=L+(_=A*(_/255)**2.5+P))*(B=F(D=e*g+R)),D=S+N*(N=z(D)),d.moveTo(M+(_=L-_)*B,S+_*N),d.lineTo(q,D))}d.globalAlpha=1,d.stroke(),d.beginPath();for(let e=p;e<m;e++)0===u[e]&&(C=M+(I=L+P)*(k=F(E=e*g+R)),E=S+I*(I=z(E)),d.moveTo(M+(T=L-P)*k,S+T*I),d.lineTo(C,E));d.globalAlpha=.25,d.stroke(),Ni.rotation-=Math.PI*r/15e3}},Ni.stopAnimation=function(){f.removeUpdater("sharedAnimation",this.updateAnimation)},Ni.themechange=function(e){switch(e.value){case"light":this.lineColor="#000000";break;case"dark":this.lineColor="#ffffff"}}.bind(Ni),Ni.windowResize=function(e){null!==Ni.target&&null===Ni.symbol&&Ni.updateCanvas()},Ni.paramInput=function(e){var t=g("fileAudio"),t={volume:t("volume"),pan:t("pan"),dry:t("dry"),wet:t("wet")};this.updateParams(t),this.updateParamInfos(t)}.bind(Ni),Ni.progressPointerdown=function(e){var t;0===e.button&&(e=Je.player["audio"],t=Ni.pointer["time"],-1!==t)&&(e.currentTime=t)},Ni.progressPointermove=function(e){var t,{pointer:i,pointerTimeInfo:a}=Ni,n=Je.player.audio["duration"];isNaN(n)||(e=e.offsetX,t=this.clientWidth,n=e/Math.max(t-1,1)*n,i.time=n,i.style.left=e+"px",i.show(),a.textContent=Ni.formatTime(n),a.show(),i=a.clientWidth+16,n=Math.min(e,t-i),a.style.left=n+"px")},Ni.progressPointerleave=function(e){var{pointer:t,pointerTimeInfo:i}=Ni;-1!==t.time&&(t.time=-1,t.hide(),i.hide())},j.fileAudio=Ni}e={target:null,meta:null,symbol:null,video:null,initialize:null,open:null,close:null,play:null,windowError:null};e.initialize=function(){this.video=_("#fileVideo-video"),window.on("error",this.windowError)},e.open=function(e,t){if(this.target!==e){this.target=e,this.meta=t;var t=_("#fileVideo-name"),i=_("#fileVideo-size");const s=_("#fileVideo-duration"),r=_("#fileVideo-resolution"),o=_("#fileVideo-bitrate"),l=Number(e.stats.size),c=(t.textContent=e.basename+e.extname,i.textContent=R.parseFileSize(l),s.textContent="",r.textContent="",o.textContent="",this.video);t=e.path;c.src=R.route(t);const h=this.symbol=Symbol();new Promise(e=>{c.on("loadedmetadata",()=>{e(c)},{once:!0})}).then(()=>{var e,t,i,a,n;this.symbol===h&&(this.symbol=null,e=c.duration,t=c.videoWidth,i=c.videoHeight,a=Math.round(l/128/e),n=j.fileAudio.formatTime,s.textContent=n(e),r.textContent=t+" x "+i,o.textContent=a+"Kbps")})}},e.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,this.symbol=null,this.video.src="")},e.play=function(){var e;null!==this.target&&(Je.player.stop(),e=this["video"],e.paused?e.play():e.currentTime=0)},e.windowError=function(e){"ResizeObserver loop limit exceeded"===e.message&&e.stopImmediatePropagation()},j.fileVideo=e;{const qi={target:null,meta:null,symbol:null,font:null,input:null,previews:null,initialize:null,open:null,close:null,windowResize:null,textInput:null};qi.initialize=function(){this.previews=_(".fileFont-preview"),this.input=_("#fileFont-content"),this.input.write("Yami RPG Editor"),this.textInput({target:this.input.input}),_("#fileFont").on("resize",this.windowResize),this.input.on("input",this.textInput)},qi.open=function(e,t){if(this.target!==e){this.target=e,this.meta=t;var t=_("#fileFont-name"),i=_("#fileFont-size"),a=Number(e.stats.size);t.textContent=e.basename+e.extname,i.textContent=R.parseFileSize(a);const n=this.previews;t=R.route(e.path),i=CSS.encodeURL(t);const s=new FontFace("preview",i);for(const o of n)o.hide();this.font instanceof FontFace&&document.fonts.delete(this.font);const r=this.symbol=Symbol();s.load().then(()=>{if(this.symbol===r){this.symbol=null,this.font=s,document.fonts.add(s);for(const e of n)e.show()}})}},qi.close=function(){this.target&&(this.font instanceof FontFace&&document.fonts.delete(this.font),T.unselect(this.meta),this.target=null,this.meta=null,this.symbol=null,this.font=null)},qi.windowResize=function(e){var t=qi.previews,i=window.devicePixelRatio;t.dpr!==i&&(t.dpr=i,_("#fileFont-font-grid").style.fontSize=12/i+"px")},qi.textInput=function(e){var t=e.target.value;for(const i of qi.previews)i.textContent=t},j.fileFont=qi}{const Di={target:null,meta:null,overview:null,initialize:null,create:null,open:null,close:null,windowLocalize:null};Di.initialize=function(){this.overview=_("#fileScript-overview"),window.on("localize",this.windowLocalize)},Di.create=function(){return`/*
@plugin
@version
@author
@link
@desc
*/

export default class Plugin {
  onStart() {}
}`},Di.open=async function(e,t){if(this.target!==e){this.target=e,this.meta=t;var i=_("#fileScript-name"),a=_("#fileScript-size"),n=Number(e.stats.size),i=(i.textContent=e.basename+e.extname,a.textContent=R.parseFileSize(n),await He.scripts[t.guid],w.createOverview(t,!0)),s=this.overview.clear();for(const r of i)s.appendChild(r)}},Di.close=function(){this.target&&(T.unselect(this.meta),this.target=null,this.meta=null,this.overview.clear())},Di.windowLocalize=function(e){var t,i;Di.target&&({target:t,meta:i}=Di,Di.target=null,Di.open(t,i))},j.fileScript=Di}{const _i={owner:A,target:null,nameBox:_("#sceneActor-name"),initialize:null,create:null,open:null,close:null,write:null,update:null,datachange:null,paramInput:null};_i.initialize=function(){_("#sceneActor-conditions").bind(new gt(this,A)),_("#sceneActor-events").bind(new ft(this,A)),_("#sceneActor-scripts").bind(new vt(this,A)),_("#sceneActor-parameter-pane").bind(_("#sceneActor-scripts")),window.on("datachange",this.datachange);var e=_(`#sceneActor-name, #sceneActor-actorId,
    #sceneActor-teamId, #sceneActor-x, #sceneActor-y, #sceneActor-angle`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,A)),_("#sceneActor-conditions, #sceneActor-events, #sceneActor-scripts").on("change",A.listChange)},_i.create=function(){return{class:"actor",name:"Actor",hidden:!1,locked:!1,presetId:"",actorId:"",teamId:He.teams.list[0].id,x:0,y:0,angle:0,conditions:[],events:[],scripts:[]}},_i.open=function(e){this.target!==e&&(this.target=e,_("#sceneActor-teamId").loadItems(He.createTeamItems()),(e=D("sceneActor",e))("name"),e("actorId"),e("teamId"),e("x"),e("y"),e("angle"),e("conditions"),e("events"),e("scripts"))},_i.close=function(){this.target&&(A.list.unselect(this.target),A.updateTarget(),this.target=null,_("#sceneActor-conditions").clear(),_("#sceneActor-events").clear(),_("#sceneActor-scripts").clear(),_("#sceneActor-parameter-pane").clear())},_i.write=function(e){void 0!==e.x&&_("#sceneActor-x").write(e.x),void 0!==e.y&&_("#sceneActor-y").write(e.y),void 0!==e.angle&&_("#sceneActor-angle").write(e.angle)},_i.update=function(e,t,i){switch(A.planToSave(),t){case"name":e.name!==i&&(e.name=i,A.updateTargetInfo(),A.list.updateItemName(e));break;case"x":case"y":e[t]!==i&&(e[t]=i);break;case"actorId":e.actorId!==i&&(e.actorId=i,e.player.destroy(),delete e.data,delete e.player,A.loadActorContext(e));break;case"teamId":e.teamId!==i&&(e.teamId=i,A.list.updateIcon(e));break;case"angle":e.angle!==i&&(e.angle=i,e.player)&&e.player.setAngle(Math.radians(i))}A.requestRendering()},_i.datachange=function(e){this.target&&"teams"===e.key&&((e=_("#sceneActor-teamId")).loadItems(He.createTeamItems()),this.target.teamId="",e.update(),e.dispatchEvent(new Event("input")))}.bind(_i),_i.paramInput=function(e){_i.update(_i.target,j.getKey(this),this.read())},j.sceneActor=_i}{const Oi={owner:A,target:null,nameBox:_("#sceneRegion-name"),initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};Oi.initialize=function(){_("#sceneRegion-conditions").bind(new gt(this,A)),_("#sceneRegion-events").bind(new ft(this,A)),_("#sceneRegion-scripts").bind(new vt(this,A)),_("#sceneRegion-parameter-pane").bind(_("#sceneRegion-scripts"));var e=_(`#sceneRegion-name, #sceneRegion-color,
    #sceneRegion-x, #sceneRegion-y, #sceneRegion-width, #sceneRegion-height`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,A)),_("#sceneRegion-conditions, #sceneRegion-events, #sceneRegion-scripts").on("change",A.listChange)},Oi.create=function(){return{class:"region",name:"Region",hidden:!1,locked:!1,presetId:"",color:"00000080",x:0,y:0,width:1,height:1,conditions:[],events:[],scripts:[]}},Oi.open=function(e){this.target!==e&&(this.target=e,(e=D("sceneRegion",e))("name"),e("color"),e("x"),e("y"),e("width"),e("height"),e("conditions"),e("events"),e("scripts"))},Oi.close=function(){this.target&&(A.list.unselect(this.target),A.updateTarget(),this.target=null,_("#sceneRegion-conditions").clear(),_("#sceneRegion-events").clear(),_("#sceneRegion-scripts").clear(),_("#sceneRegion-parameter-pane").clear())},Oi.write=function(e){void 0!==e.x&&_("#sceneRegion-x").write(e.x),void 0!==e.y&&_("#sceneRegion-y").write(e.y)},Oi.update=function(e,t,i){switch(A.planToSave(),t){case"name":e.name!==i&&(e.name=i,A.updateTargetInfo(),A.list.updateItemName(e));break;case"x":case"y":case"width":case"height":e[t]!==i&&(e[t]=i);break;case"color":e.color!==i&&(e.color=i,A.list.updateIcon(e))}A.requestRendering()},Oi.paramInput=function(e){Oi.update(Oi.target,j.getKey(this),this.read())},j.sceneRegion=Oi}{const Yi={owner:A,target:null,nameBox:_("#sceneLight-name"),initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};Yi.initialize=function(){_("#sceneLight-type").loadItems([{name:"Point",value:"point"},{name:"Area",value:"area"}]),_("#sceneLight-blend").loadItems([{name:"Screen",value:"screen"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"},{name:"Max",value:"max"}]),_("#sceneLight-type").enableHiddenMode().relate([{case:"point",targets:[_("#sceneLight-range-box"),_("#sceneLight-intensity-box")]},{case:"area",targets:[_("#sceneLight-mask"),_("#sceneLight-anchorX-box"),_("#sceneLight-anchorY-box"),_("#sceneLight-width-box"),_("#sceneLight-height-box"),_("#sceneLight-angle-box")]}]),_("#sceneLight-conditions").bind(new gt(this,A)),_("#sceneLight-events").bind(new ft(this,A)),_("#sceneLight-scripts").bind(new vt(this,A)),_("#sceneLight-parameter-pane").bind(_("#sceneLight-scripts")),_("#sceneLight-range-slider").synchronize(_("#sceneLight-range")),_("#sceneLight-intensity-slider").synchronize(_("#sceneLight-intensity")),_("#sceneLight-anchorX-slider").synchronize(_("#sceneLight-anchorX")),_("#sceneLight-anchorY-slider").synchronize(_("#sceneLight-anchorY")),_("#sceneLight-width-slider").synchronize(_("#sceneLight-width")),_("#sceneLight-height-slider").synchronize(_("#sceneLight-height")),_("#sceneLight-angle-slider").synchronize(_("#sceneLight-angle")),_("#sceneLight-red-slider").synchronize(_("#sceneLight-red")),_("#sceneLight-green-slider").synchronize(_("#sceneLight-green")),_("#sceneLight-blue-slider").synchronize(_("#sceneLight-blue"));var e=_(`
    #sceneLight-name, #sceneLight-type,
    #sceneLight-blend, #sceneLight-x, #sceneLight-y,
    #sceneLight-range, #sceneLight-intensity,
    #sceneLight-mask, #sceneLight-anchorX, #sceneLight-anchorY,
    #sceneLight-width, #sceneLight-height, #sceneLight-angle,
    #sceneLight-red, #sceneLight-green, #sceneLight-blue`),t=_(`
    #sceneLight-range-slider, #sceneLight-intensity-slider,
    #sceneLight-anchorX-slider, #sceneLight-anchorY-slider,
    #sceneLight-width-slider, #sceneLight-height-slider, #sceneLight-angle-slider,
    #sceneLight-red-slider, #sceneLight-green-slider, #sceneLight-blue-slider`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,A)),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur),_("#sceneLight-conditions, #sceneLight-events, #sceneLight-scripts").on("change",A.listChange)},Yi.create=function(){return{class:"light",name:"Light",hidden:!1,locked:!1,presetId:"",type:"point",blend:"screen",x:0,y:0,range:4,intensity:0,mask:"",anchorX:.5,anchorY:.5,width:1,height:1,angle:0,red:255,green:255,blue:255,conditions:[],events:[],scripts:[]}},Yi.open=function(e){this.target!==e&&(this.target=e,(e=D("sceneLight",e))("name"),e("type"),e("blend"),e("x"),e("y"),e("range"),e("intensity"),e("mask"),e("anchorX"),e("anchorY"),e("width"),e("height"),e("angle"),e("red"),e("green"),e("blue"),e("conditions"),e("events"),e("scripts"))},Yi.close=function(){this.target&&(A.list.unselect(this.target),A.updateTarget(),this.target=null,_("#sceneLight-conditions").clear(),_("#sceneLight-events").clear(),_("#sceneLight-scripts").clear(),_("#sceneLight-parameter-pane").clear())},Yi.write=function(e){void 0!==e.x&&_("#sceneLight-x").write(e.x),void 0!==e.y&&_("#sceneLight-y").write(e.y)},Yi.update=function(e,t,i){switch(A.planToSave(),t){case"name":e.name!==i&&(e.name=i,A.updateTargetInfo(),A.list.updateItemName(e));break;case"type":e.type!==i&&(e.type=i,e.instance.measure());break;case"blend":case"x":case"y":case"range":case"intensity":case"mask":e[t]!==i&&(e[t]=i);break;case"anchorX":case"anchorY":case"width":case"height":case"angle":e[t]!==i&&(e[t]=i,e.instance.measure());break;case"red":case"green":case"blue":e[t]!==i&&(e[t]=i,A.list.updateIcon(e))}A.requestRendering()},Yi.paramInput=function(e){Yi.update(Yi.target,j.getKey(this),this.read())},j.sceneLight=Yi}{const ji={owner:A,target:null,nameBox:_("#sceneAnimation-name"),motions:null,initialize:null,create:null,open:null,close:null,write:null,update:null,animationIdWrite:null,paramInput:null};ji.initialize=function(){_("#sceneAnimation-conditions").bind(new gt(this,A)),_("#sceneAnimation-events").bind(new ft(this,A)),_("#sceneAnimation-scripts").bind(new vt(this,A)),_("#sceneAnimation-parameter-pane").bind(_("#sceneAnimation-scripts")),_("#sceneAnimation-animationId").on("write",this.animationIdWrite);var e=_(`#sceneAnimation-name,
    #sceneAnimation-animationId, #sceneAnimation-motion,
    #sceneAnimation-x, #sceneAnimation-y, #sceneAnimation-angle`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,A)),_("#sceneAnimation-conditions, #sceneAnimation-events, #sceneAnimation-scripts").on("change",A.listChange)},ji.create=function(){return{class:"animation",name:"Animation",hidden:!1,locked:!1,presetId:"",animationId:"",motion:"",x:0,y:0,angle:0,conditions:[],events:[],scripts:[]}},ji.open=function(e){this.target!==e&&(this.target=e,(e=D("sceneAnimation",e))("name"),e("animationId"),e("motion"),e("x"),e("y"),e("angle"),e("conditions"),e("events"),e("scripts"))},ji.close=function(){this.target&&(A.list.unselect(this.target),A.updateTarget(),this.target=null,this.motions=null,_("#sceneAnimation-conditions").clear(),_("#sceneAnimation-events").clear(),_("#sceneAnimation-scripts").clear(),_("#sceneAnimation-parameter-pane").clear())},ji.write=function(e){void 0!==e.x&&_("#sceneAnimation-x").write(e.x),void 0!==e.y&&_("#sceneAnimation-y").write(e.y),void 0!==e.angle&&_("#sceneAnimation-angle").write(e.angle)},ji.update=function(e,t,i){switch(A.planToSave(),t){case"name":e.name!==i&&(e.name=i,A.updateTargetInfo(),A.list.updateItemName(e));break;case"animationId":e.animationId!==i&&(e.animationId=i,ji.motions=null,A.destroyObjectContext(e),A.loadAnimationContext(e));break;case"motion":e.motion!==i&&(e.motion=i,e.player.setMotion(i))&&e.player.restart();break;case"x":case"y":e[t]!==i&&(e[t]=i);break;case"angle":e.angle!==i&&(e.angle=i,e.player?.setAngle(Math.radians(i)))}A.requestRendering()},ji.animationIdWrite=function(e){var t=_("#sceneAnimation-motion"),e=Ke.getMotionListItems(e.value);t.loadItems(e),t.write(t.read()??e[0].value)},ji.paramInput=function(e){ji.update(ji.target,j.getKey(this),this.read())},j.sceneAnimation=ji}{const Xi={owner:A,target:null,nameBox:_("#sceneParticle-name"),initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};Xi.initialize=function(){_("#sceneParticle-conditions").bind(new gt(this,A)),_("#sceneParticle-events").bind(new ft(this,A)),_("#sceneParticle-scripts").bind(new vt(this,A)),_("#sceneParticle-parameter-pane").bind(_("#sceneParticle-scripts"));var e=_(`#sceneParticle-name,
    #sceneParticle-particleId, #sceneParticle-x, #sceneParticle-y,
    #sceneParticle-angle, #sceneParticle-scale, #sceneParticle-speed`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,A)),_("#sceneParticle-conditions, #sceneParticle-events, #sceneParticle-scripts").on("change",A.listChange)},Xi.create=function(){return{class:"particle",name:"Particle",hidden:!1,locked:!1,presetId:"",particleId:"",x:0,y:0,angle:0,scale:1,speed:1,conditions:[],events:[],scripts:[]}},Xi.open=function(e){this.target!==e&&(this.target=e,(e=D("sceneParticle",e))("name"),e("particleId"),e("x"),e("y"),e("angle"),e("scale"),e("speed"),e("conditions"),e("events"),e("scripts"))},Xi.close=function(){this.target&&(A.list.unselect(this.target),A.updateTarget(),this.target=null,_("#sceneParticle-conditions").clear(),_("#sceneParticle-events").clear(),_("#sceneParticle-scripts").clear(),_("#sceneParticle-parameter-pane").clear())},Xi.write=function(e){void 0!==e.x&&_("#sceneParticle-x").write(e.x),void 0!==e.y&&_("#sceneParticle-y").write(e.y)},Xi.update=function(e,t,i){switch(A.planToSave(),t){case"name":e.name!==i&&(e.name=i,A.updateTargetInfo(),A.list.updateItemName(e));break;case"particleId":e.particleId!==i&&(e.particleId=i,A.loadParticleContext(e),A.list.updateIcon(e));break;case"x":case"y":e[t]!==i&&(e[t]=i);break;case"angle":e.angle!==i&&(e.angle=i,e.emitter)&&(e.emitter.angle=Math.radians(i));break;case"scale":e.scale!==i&&(e.scale=i,e.emitter)&&(e.emitter.scale=i);break;case"speed":e.speed!==i&&(e.speed=i,e.emitter)&&(e.emitter.speed=i)}A.requestRendering()},Xi.paramInput=function(e){Xi.update(Xi.target,j.getKey(this),this.read())},j.sceneParticle=Xi}{const Gi={owner:A,target:null,nameBox:_("#sceneParallax-name"),initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};Gi.initialize=function(){_("#sceneParallax-layer").loadItems([{name:"Background",value:"background"},{name:"Foreground",value:"foreground"}]),_("#sceneParallax-light").loadItems([{name:"Raw",value:"raw"},{name:"Global Sampling",value:"global"},{name:"Anchor Sampling",value:"anchor"},{name:"Ambient Light",value:"ambient"}]),_("#sceneParallax-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"}]),_("#sceneParallax-tint-0-slider").synchronize(_("#sceneParallax-tint-0")),_("#sceneParallax-tint-1-slider").synchronize(_("#sceneParallax-tint-1")),_("#sceneParallax-tint-2-slider").synchronize(_("#sceneParallax-tint-2")),_("#sceneParallax-tint-3-slider").synchronize(_("#sceneParallax-tint-3")),_("#sceneParallax-conditions").bind(new gt(this,A)),_("#sceneParallax-events").bind(new ft(this,A)),_("#sceneParallax-scripts").bind(new vt(this,A)),_("#sceneParallax-parameter-pane").bind(_("#sceneParallax-scripts"));var e=_(`#sceneParallax-name,
    #sceneParallax-image, #sceneParallax-layer, #sceneParallax-order,
    #sceneParallax-light, #sceneParallax-blend,
    #sceneParallax-opacity, #sceneParallax-x, #sceneParallax-y,
    #sceneParallax-scaleX, #sceneParallax-scaleY,
    #sceneParallax-repeatX, #sceneParallax-repeatY,
    #sceneParallax-anchorX, #sceneParallax-anchorY,
    #sceneParallax-offsetX, #sceneParallax-offsetY,
    #sceneParallax-parallaxFactorX, #sceneParallax-parallaxFactorY,
    #sceneParallax-shiftSpeedX, #sceneParallax-shiftSpeedY,
    #sceneParallax-tint-0, #sceneParallax-tint-1,
    #sceneParallax-tint-2, #sceneParallax-tint-3`),t=_(`
    #sceneParallax-tint-0-slider, #sceneParallax-tint-1-slider,
    #sceneParallax-tint-2-slider, #sceneParallax-tint-3-slider`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,A)),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur),_("#sceneParallax-conditions, #sceneParallax-events, #sceneParallax-scripts").on("change",A.listChange)},Gi.create=function(){return{class:"parallax",name:"Parallax",hidden:!1,locked:!1,presetId:"",image:"",layer:"foreground",order:0,light:"raw",blend:"normal",opacity:1,x:0,y:0,scaleX:1,scaleY:1,repeatX:1,repeatY:1,anchorX:0,anchorY:0,offsetX:0,offsetY:0,parallaxFactorX:1,parallaxFactorY:1,shiftSpeedX:0,shiftSpeedY:0,tint:[0,0,0,0],conditions:[],events:[],scripts:[]}},Gi.open=function(e){this.target!==e&&(this.target=e,(e=D("sceneParallax",e))("name"),e("image"),e("layer"),e("order"),e("light"),e("blend"),e("opacity"),e("x"),e("y"),e("scaleX"),e("scaleY"),e("repeatX"),e("repeatY"),e("anchorX"),e("anchorY"),e("offsetX"),e("offsetY"),e("parallaxFactorX"),e("parallaxFactorY"),e("shiftSpeedX"),e("shiftSpeedY"),e("tint-0"),e("tint-1"),e("tint-2"),e("tint-3"),e("conditions"),e("events"),e("scripts"))},Gi.close=function(){this.target&&(A.list.unselect(this.target),A.updateTarget(),this.target=null,_("#sceneParallax-conditions").clear(),_("#sceneParallax-events").clear(),_("#sceneParallax-scripts").clear(),_("#sceneParallax-parameter-pane").clear())},Gi.write=function(e){void 0!==e.x&&_("#sceneParallax-x").write(e.x),void 0!==e.y&&_("#sceneParallax-y").write(e.y)},Gi.update=function(e,t,i){switch(A.planToSave(),t){case"name":e.name!==i&&(e.name=i,A.updateTargetInfo(),A.list.updateItemName(e));break;case"image":e.image!==i&&(e.image=i,e.player.destroy(),e.player.loadTexture(),A.list.updateIcon(e));break;case"layer":case"order":e[t]!==i&&(e[t]=i,A.loadObjects());break;case"light":case"blend":case"opacity":case"x":case"y":case"scaleX":case"scaleY":case"repeatX":case"repeatY":case"anchorX":case"anchorY":case"offsetX":case"offsetY":case"parallaxFactorX":case"parallaxFactorY":e[t]!==i&&(e[t]=i);break;case"shiftSpeedX":e.shiftSpeedX!==i&&0===(e.shiftSpeedX=i)&&(e.player.shiftX=0);break;case"shiftSpeedY":e.shiftSpeedY!==i&&0===(e.shiftSpeedY=i)&&(e.player.shiftY=0);break;case"tint-0":case"tint-1":case"tint-2":case"tint-3":var a=t.indexOf("-")+1,a=t.slice(a);e.tint[a]!==i&&(e.tint[a]=i)}A.requestRendering()},Gi.paramInput=function(e){Gi.update(Gi.target,j.getKey(this),this.read())},j.sceneParallax=Gi}{const Vi={owner:A,target:null,nameBox:_("#sceneTilemap-name"),lightBox:_("#sceneTilemap-light"),initialize:null,create:null,open:null,close:null,write:null,update:null,layerWrite:null,layerInput:null,paramInput:null};Vi.initialize=function(){_("#sceneTilemap-layer").loadItems([{name:"Background",value:"background"},{name:"Foreground",value:"foreground"},{name:"Object",value:"object"}]);var e={raw:{name:"Raw",value:"raw"},global:{name:"Global Sampling",value:"global"},ambient:{name:"Ambient Light",value:"ambient"},anchor:{name:"Anchor Sampling",value:"anchor"}},e=(this.lightBox.lightItems={all:Object.values(e),tile:[e.raw,e.global,e.ambient],sprite:[e.raw,e.global,e.anchor]},this.lightBox.setItemNames=function(e){var t=this.dataItems;this.dataItems=this.lightItems.all,pe.prototype.setItemNames.call(this,e),this.dataItems=t,null!==this.dataValue&&this.update()},_("#sceneTilemap-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"}]),_("#sceneTilemap-conditions").bind(new gt(this,A)),_("#sceneTilemap-events").bind(new ft(this,A)),_("#sceneTilemap-scripts").bind(new vt(this,A)),_("#sceneTilemap-parameter-pane").bind(_("#sceneTilemap-scripts")),_(`#sceneTilemap-name, #sceneTilemap-layer, #sceneTilemap-order,
    #sceneTilemap-light, #sceneTilemap-blend, #sceneTilemap-x, #sceneTilemap-y,
    #sceneTilemap-anchorX, #sceneTilemap-anchorY, #sceneTilemap-offsetX, #sceneTilemap-offsetY,
    #sceneTilemap-parallaxFactorX, #sceneTilemap-parallaxFactorY, #sceneTilemap-opacity`));e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,A)),_("#sceneTilemap-layer").on("write",this.layerWrite),_("#sceneTilemap-layer").on("input",this.layerInput),_("#sceneTilemap-width, #sceneTilemap-height").on("change",this.paramInput),_("#sceneTilemap-conditions, #sceneTilemap-events, #sceneTilemap-scripts").on("change",A.listChange)},Vi.create=function(e=4,t=4){var i=A.createTiles(e,t);return _e.decodeTilemap({class:"tilemap",name:"Tilemap",hidden:!1,locked:!1,presetId:"",tilesetMap:{},shortcut:0,layer:"background",order:0,light:"global",blend:"normal",x:0,y:0,width:e,height:t,anchorX:0,anchorY:0,offsetX:0,offsetY:0,parallaxFactorX:1,parallaxFactorY:1,opacity:1,code:_e.encodeTiles(i),conditions:[],events:[],scripts:[]})},Vi.open=function(e){this.target!==e&&(this.target=e,(e=D("sceneTilemap",e))("name"),e("layer"),e("order"),e("light"),e("blend"),e("x"),e("y"),e("width"),e("height"),e("anchorX"),e("anchorY"),e("offsetX"),e("offsetY"),e("parallaxFactorX"),e("parallaxFactorY"),e("opacity"),e("conditions"),e("events"),e("scripts"))},Vi.close=function(){this.target&&(A.list.unselect(this.target),A.updateTarget(),this.target=null,_("#sceneTilemap-conditions").clear(),_("#sceneTilemap-events").clear(),_("#sceneTilemap-scripts").clear(),_("#sceneTilemap-parameter-pane").clear())},Vi.write=function(e){void 0!==e.x&&_("#sceneTilemap-x").write(e.x),void 0!==e.y&&_("#sceneTilemap-y").write(e.y),void 0!==e.width&&_("#sceneTilemap-width").write(e.width),void 0!==e.height&&_("#sceneTilemap-height").write(e.height)},Vi.update=function(e,t,i){switch(A.planToSave(),t){case"name":e.name!==i&&(e.name=i,A.updateTargetInfo(),A.list.updateItemName(e));break;case"layer":case"order":e[t]!==i&&(e[t]=i,A.loadObjects());break;case"light":case"blend":case"x":case"y":case"anchorX":case"anchorY":case"offsetX":case"offsetY":case"parallaxFactorX":case"parallaxFactorY":case"opacity":e[t]!==i&&(e[t]=i);break;case"width":e.width!==i&&A.setTilemapSize(e,i,e.height);break;case"height":e.height!==i&&A.setTilemapSize(e,e.width,i)}A.requestRendering()},Vi.layerWrite=function(e){var t=Vi.lightBox,e="object"===e.value?"sprite":"tile",e=t.lightItems[e];t.dataItems!==e&&t.loadItems(e)},Vi.layerInput=function(e){if(j.manager.focusing===this){var t=Vi.lightBox,i=t.read();for(const a of t.dataItems)if(a.value===i)return;t.write("raw"),this.changes=[{input:t,oldValue:i,newValue:"raw"}]}},Vi.paramInput=function(e){Vi.update(Vi.target,j.getKey(this),this.read())},j.sceneTilemap=Vi}{const Wi={owner:Y,target:null,nameBox:_("#uiElement-name"),generalGroup:_("#uiElement-general-group"),transformGroup:_("#uiElement-transform-group"),eventsGroup:_("#uiElement-events-group"),scriptsGroup:_("#uiElement-scripts-group"),parameterPane:_("#uiElement-parameter-pane"),initialize:null,create:null,open:null,close:null,write:null,update:null,pageSwitch:null,alignmentClick:null,paramInput:null};Wi.initialize=function(){_("#uiElement-events").bind(new ft(this,Y)),_("#uiElement-scripts").bind(new vt(this,Y)),this.parameterPane.bind(_("#uiElement-scripts")),j.manager.on("switch",this.pageSwitch);var e=_(".uiElement-transform-align"),t=_(`#uiElement-name, #uiElement-transform-anchorX, #uiElement-transform-anchorY,
    #uiElement-transform-x, #uiElement-transform-x2, #uiElement-transform-y, #uiElement-transform-y2,
    #uiElement-transform-width, #uiElement-transform-width2, #uiElement-transform-height, #uiElement-transform-height2,
    #uiElement-transform-rotation, #uiElement-transform-scaleX, #uiElement-transform-scaleY,
    #uiElement-transform-skewX, #uiElement-transform-skewY, #uiElement-transform-opacity`);e.on("click",this.alignmentClick),t.on("input",this.paramInput),t.on("focus",j.inputFocus),t.on("blur",j.inputBlur(this,Y)),_("#uiElement-events, #uiElement-scripts").on("change",Y.listChange)},Wi.createTransform=function(){return{anchorX:0,anchorY:0,x:0,x2:0,y:0,y2:0,width:0,width2:0,height:0,height2:0,rotation:0,scaleX:1,scaleY:1,skewX:0,skewY:0,opacity:1}},Wi.open=function(e){this.target!==e&&(this.target=e,(e=D("uiElement",e))("name"),e("transform-anchorX"),e("transform-anchorY"),e("transform-x"),e("transform-x2"),e("transform-y"),e("transform-y2"),e("transform-width"),e("transform-width2"),e("transform-height"),e("transform-height2"),e("transform-rotation"),e("transform-scaleX"),e("transform-scaleY"),e("transform-skewX"),e("transform-skewY"),e("transform-opacity"),e("events"),e("scripts"))},Wi.close=function(){this.target&&(this.target=null,_("#uiElement-events").clear(),_("#uiElement-scripts").clear(),_("#uiElement-parameter-pane").clear())},Wi.write=function(e){void 0!==e.anchorX&&_("#uiElement-transform-anchorX").write(e.anchorX),void 0!==e.anchorY&&_("#uiElement-transform-anchorY").write(e.anchorY),void 0!==e.x&&_("#uiElement-transform-x").write(e.x),void 0!==e.y&&_("#uiElement-transform-y").write(e.y),void 0!==e.width&&_("#uiElement-transform-width").write(e.width),void 0!==e.height&&_("#uiElement-transform-height").write(e.height),void 0!==e.rotation&&_("#uiElement-transform-rotation").write(e.rotation)},Wi.update=function(e,t,i){Y.planToSave();var a=e.instance,n=e.transform;switch(t){case"name":e.name!==i&&(e.name=i,Y.list.updateItemName(e));break;case"transform-anchorX":case"transform-anchorY":case"transform-x":case"transform-x2":case"transform-y":case"transform-y2":case"transform-width":case"transform-width2":case"transform-height":case"transform-height2":case"transform-rotation":case"transform-scaleX":case"transform-scaleY":case"transform-skewX":case"transform-skewY":case"transform-opacity":var s=t.indexOf("-")+1,s=t.slice(s);n[s]!==i&&(n[s]=i,a.resize())}Y.requestRendering()},Wi.pageSwitch=function(e){switch(e.value){case"uiImage":case"uiText":case"uiTextBox":case"uiDialogBox":case"uiProgressBar":case"uiVideo":case"uiWindow":case"uiContainer":var t=j.manager.active;t.insertBefore(this.transformGroup,t.firstChild),t.insertBefore(this.generalGroup,t.firstChild),t.appendChild(this.eventsGroup),t.appendChild(this.scriptsGroup),t.appendChild(this.parameterPane)}}.bind(Wi),Wi.alignmentClick=function(e){let t,i;switch(this.getAttribute("value")){case"left":t=0;break;case"center":t=.5;break;case"right":t=1;break;case"top":i=0;break;case"middle":i=.5;break;case"bottom":i=1}var a,n=Wi.target,s=n.instance,n=n.transform,r=[];void 0!==t&&(n.anchorX!==t&&(a=_("#uiElement-transform-anchorX"),r.push({input:a,oldValue:n.anchorX,newValue:t}),n.anchorX=t,a.write(t)),0!==n.x&&(a=_("#uiElement-transform-x"),r.push({input:a,oldValue:n.x,newValue:0}),n.x=0,a.write(0)),n.x2!==t)&&(a=_("#uiElement-transform-x2"),r.push({input:a,oldValue:n.x2,newValue:t}),n.x2=t,a.write(t)),void 0!==i&&(n.anchorY!==i&&(a=_("#uiElement-transform-anchorY"),r.push({input:a,oldValue:n.anchorY,newValue:i}),n.anchorY=i,a.write(i)),0!==n.y&&(a=_("#uiElement-transform-y"),r.push({input:a,oldValue:n.y,newValue:0}),n.y=0,a.write(0)),n.y2!==i)&&(a=_("#uiElement-transform-y2"),r.push({input:a,oldValue:n.y2,newValue:i}),n.y2=i,a.write(i)),0!==r.length&&(s.resize(),Y.planToSave(),Y.requestRendering(),Y.history.save({type:"inspector-change",editor:Wi,target:Wi.target,changes:r}))},Wi.paramInput=function(e){Wi.update(Wi.target,j.getKey(this),this.read())};{const Hi={owner:Y,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};Hi.initialize=function(){_("#uiImage-display").loadItems([{name:"Stretch",value:"stretch"},{name:"Tile",value:"tile"},{name:"Clip",value:"clip"},{name:"Slice",value:"slice"}]),_("#uiImage-display").enableHiddenMode().relate([{case:["stretch","tile"],targets:[_("#uiImage-flip"),_("#uiImage-shift-box")]},{case:"clip",targets:[_("#uiImage-flip"),_("#uiImage-clip")]},{case:"slice",targets:[_("#uiImage-clip"),_("#uiImage-border")]}]),_("#uiImage-flip").loadItems([{name:"None",value:"none"},{name:"Horizontal",value:"horizontal"},{name:"Vertical",value:"vertical"},{name:"Both",value:"both"}]),_("#uiImage-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"},{name:"Mask",value:"mask"}]),_("#uiImage-tint-0-slider").synchronize(_("#uiImage-tint-0")),_("#uiImage-tint-1-slider").synchronize(_("#uiImage-tint-1")),_("#uiImage-tint-2-slider").synchronize(_("#uiImage-tint-2")),_("#uiImage-tint-3-slider").synchronize(_("#uiImage-tint-3"));var e=_(`#uiImage-image,
    #uiImage-display, #uiImage-flip, #uiImage-blend,
    #uiImage-shiftX, #uiImage-shiftY, #uiImage-clip, #uiImage-border,
    #uiImage-tint-0, #uiImage-tint-1, #uiImage-tint-2, #uiImage-tint-3`),t=_(`
    #uiImage-tint-0-slider, #uiImage-tint-1-slider,
    #uiImage-tint-2-slider, #uiImage-tint-3-slider`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Y)),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur)},Hi.create=function(){var e=Wi.createTransform();return e.width=100,{class:"image",name:"Image",enabled:!0,expanded:!(e.height=100),hidden:!1,locked:!1,presetId:"",image:"",display:"stretch",flip:"none",blend:"normal",shiftX:0,shiftY:0,clip:[0,0,32,32],border:1,tint:[0,0,0,0],transform:e,events:[],scripts:[],children:[]}},Hi.open=function(e){var t;this.target!==e&&(this.target=e,(t=D("uiImage",e))("image"),t("display"),t("flip"),t("blend"),t("shiftX"),t("shiftY"),t("clip"),t("border"),t("tint-0"),t("tint-1"),t("tint-2"),t("tint-3"),Wi.open(e))},Hi.close=function(){this.target&&(Y.list.unselect(this.target),Y.updateTarget(),Wi.close(),this.target=null)},Hi.update=function(e,t,i){Y.planToSave();var a=e.instance;switch(t){case"image":case"display":case"flip":case"blend":case"shiftX":case"shiftY":case"clip":case"border":e[t]!==i&&(e[t]=i,a[t]=i);break;case"tint-0":case"tint-1":case"tint-2":case"tint-3":var n=t.indexOf("-")+1,n=t.slice(n);e.tint[n]!==i&&(e.tint[n]=i,a.tint[n]=i)}Y.requestRendering()},Hi.paramInput=function(e){Hi.update(Hi.target,j.getKey(this),this.read())},j.uiImage=Hi}{const Ki={owner:Y,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};Ki.initialize=function(){_("#uiText-direction").loadItems([{name:"Horizontal - TB",value:"horizontal-tb"},{name:"Vertical - LR",value:"vertical-lr"},{name:"Vertical - RL",value:"vertical-rl"}]),_("#uiText-typeface").loadItems([{name:"Regular",value:"regular"},{name:"Bold",value:"bold"},{name:"Italic",value:"italic"},{name:"Bold Italic",value:"bold-italic"}]),_("#uiText-effect-type").loadItems([{name:"None",value:"none"},{name:"Shadow",value:"shadow"},{name:"Stroke",value:"stroke"},{name:"Outline",value:"outline"}]),_("#uiText-overflow").loadItems([{name:"Visible",value:"visible"},{name:"Wrap",value:"wrap"},{name:"Truncate",value:"truncate"},{name:"Wrap Truncate",value:"wrap-truncate"}]),_("#uiText-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"}]),_("#uiText-size-slider").synchronize(_("#uiText-size")),_("#uiText-lineSpacing-slider").synchronize(_("#uiText-lineSpacing")),_("#uiText-letterSpacing-slider").synchronize(_("#uiText-letterSpacing")),_("#uiText-effect-type").enableHiddenMode().relate([{case:"shadow",targets:[_("#uiText-effect-shadowOffsetX"),_("#uiText-effect-shadowOffsetY"),_("#uiText-effect-color")]},{case:"stroke",targets:[_("#uiText-effect-strokeWidth"),_("#uiText-effect-color")]},{case:"outline",targets:[_("#uiText-effect-color")]}]);var e=_(`#uiText-direction, #uiText-horizontalAlign, #uiText-verticalAlign,
    #uiText-content, #uiText-size, #uiText-lineSpacing, #uiText-letterSpacing, #uiText-color, #uiText-font,
    #uiText-typeface, #uiText-effect-type, #uiText-effect-shadowOffsetX, #uiText-effect-shadowOffsetY,
    #uiText-effect-strokeWidth, #uiText-effect-color, #uiText-overflow, #uiText-blend`),t=_("#uiText-size-slider, #uiText-lineSpacing-slider, #uiText-letterSpacing-slider");e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Y)),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur)},Ki.create=function(){var e=Wi.createTransform();return e.width=100,{class:"text",name:"Text",enabled:!0,expanded:!(e.height=24),hidden:!1,locked:!1,presetId:"",direction:"horizontal-tb",horizontalAlign:"left",verticalAlign:"middle",content:"New Text",size:16,lineSpacing:0,letterSpacing:0,color:"ffffffff",font:"",typeface:"regular",effect:{type:"none"},overflow:"visible",blend:"normal",transform:e,events:[],scripts:[],children:[]}},Ki.open=function(e){var t;this.target!==e&&(this.target=e,(t=D("uiText",e))("direction"),t("horizontalAlign"),t("verticalAlign"),t("content"),t("size"),t("lineSpacing"),t("letterSpacing"),t("color"),t("font"),t("typeface"),t("effect-type"),t("effect-shadowOffsetX",e.effect.shadowOffsetX||1),t("effect-shadowOffsetY",e.effect.shadowOffsetY||1),t("effect-strokeWidth",e.effect.strokeWidth||1),t("effect-color",e.effect.color||"000000ff"),t("overflow"),t("blend"),Wi.open(e))},Ki.close=function(){this.target&&(Y.list.unselect(this.target),Y.updateTarget(),Wi.close(),this.target=null)},Ki.update=function(e,t,i){Y.planToSave();var a=e.instance;switch(t){case"horizontalAlign":e.horizontalAlign!==i&&((n=window.event)&&"input"===n.type&&void 0!==n.value&&Y.history.save({type:"inspector-change",editor:this,target:this.target,changes:[{input:_("#uiText-horizontalAlign"),oldValue:e.horizontalAlign,newValue:i}]}),e.horizontalAlign=i,a.horizontalAlign=i);break;case"verticalAlign":e.verticalAlign!==i&&((n=window.event)&&"input"===n.type&&void 0!==n.value&&Y.history.save({type:"inspector-change",editor:this,target:this.target,changes:[{input:_("#uiText-verticalAlign"),oldValue:e.verticalAlign,newValue:i}]}),e.verticalAlign=i,a.verticalAlign=i);break;case"direction":case"content":case"size":case"lineSpacing":case"letterSpacing":case"color":case"typeface":case"overflow":case"blend":e[t]!==i&&(e[t]=i,a[t]=i);break;case"font":var n=i.trim();e.font!==n&&(e.font=n,a.font=n);break;case"effect-type":if(e.effect.type!==i){var s=g("uiText-effect"),r={type:i};switch(i){case"none":break;case"shadow":r.shadowOffsetX=s("shadowOffsetX"),r.shadowOffsetY=s("shadowOffsetY"),r.color=s("color");break;case"stroke":r.strokeWidth=s("strokeWidth"),r.color=s("color");break;case"outline":r.color=s("color")}e.effect=r,a.effect=r}break;case"effect-shadowOffsetX":case"effect-shadowOffsetY":case"effect-strokeWidth":case"effect-color":n=t.indexOf("-")+1,n=t.slice(n);e.effect[n]!==i&&(e.effect[n]=i,a.effect=e.effect)}Y.requestRendering()},Ki.paramInput=function(e){Ki.update(Ki.target,j.getKey(this),this.read())},j.uiText=Ki}{const Ui={owner:Y,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};Ui.initialize=function(){_("#uiTextBox-type").loadItems([{name:"Text",value:"text"},{name:"Number",value:"number"}]),_("#uiTextBox-align").loadItems([{name:"Left",value:"left"},{name:"Center",value:"center"},{name:"Right",value:"right"}]),_("#uiTextBox-type").enableHiddenMode().relate([{case:"text",targets:[_("#uiTextBox-text"),_("#uiTextBox-maxLength")]},{case:"number",targets:[_("#uiTextBox-number"),_("#uiTextBox-min"),_("#uiTextBox-max"),_("#uiTextBox-decimals")]}]);var e=_(`#uiTextBox-type, #uiTextBox-align, #uiTextBox-text,
    #uiTextBox-maxLength, #uiTextBox-number, #uiTextBox-min, #uiTextBox-max,
    #uiTextBox-decimals, #uiTextBox-padding, #uiTextBox-size, #uiTextBox-font,
    #uiTextBox-color, #uiTextBox-selectionColor, #uiTextBox-selectionBgColor`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Y))},Ui.create=function(){var e=Wi.createTransform();return e.width=100,{class:"textbox",name:"TextBox",enabled:!0,expanded:!(e.height=24),hidden:!1,locked:!1,presetId:"",type:"text",align:"left",text:"Content",maxLength:16,number:0,min:0,max:0,decimals:0,padding:4,size:16,font:"",color:"ffffffff",selectionColor:"ffffffff",selectionBgColor:"0090ccff",transform:e,events:[],scripts:[],children:[]}},Ui.open=function(e){var t,i;this.target!==e&&(this.target=e,t=D("uiTextBox",e),(i=_("#uiTextBox-number")).input.min=e.min,i.input.max=e.max,i.decimals=e.decimals,t("type"),t("align"),t("text"),t("maxLength"),t("number"),t("min"),t("max"),t("decimals"),t("padding"),t("size"),t("font"),t("color"),t("selectionColor"),t("selectionBgColor"),Wi.open(e))},Ui.close=function(){this.target&&(Y.list.unselect(this.target),Y.updateTarget(),Wi.close(),this.target=null)},Ui.update=function(e,t,i){Y.planToSave();var a=e.instance;switch(t){case"type":case"align":case"maxLength":case"padding":case"size":case"font":case"color":case"selectionColor":case"selectionBgColor":e[t]!==i&&(e[t]=i,a[t]=i);break;case"text":case"number":e[t]!==i&&(e[t]=i,a.content=i.toString());break;case"min":case"max":e[t]!==i&&(e[t]=i,a[t]=i,_("#uiTextBox-number").input[t]=i);break;case"decimals":e.decimals!==i&&(e.decimals=i,a.decimals=i,_("#uiTextBox-number").decimals=i)}Y.requestRendering()},Ui.paramInput=function(e){Ui.update(Ui.target,j.getKey(this),this.read())},j.uiTextBox=Ui}{const $i={owner:Y,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};$i.initialize=function(){_("#uiDialogBox-typeface").loadItems([{name:"Regular",value:"regular"},{name:"Bold",value:"bold"},{name:"Italic",value:"italic"},{name:"Bold Italic",value:"bold-italic"}]),_("#uiDialogBox-effect-type").loadItems([{name:"None",value:"none"},{name:"Shadow",value:"shadow"},{name:"Stroke",value:"stroke"},{name:"Outline",value:"outline"}]),_("#uiDialogBox-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"}]),_("#uiDialogBox-size-slider").synchronize(_("#uiDialogBox-size")),_("#uiDialogBox-lineSpacing-slider").synchronize(_("#uiDialogBox-lineSpacing")),_("#uiDialogBox-letterSpacing-slider").synchronize(_("#uiDialogBox-letterSpacing")),_("#uiDialogBox-effect-type").enableHiddenMode().relate([{case:"shadow",targets:[_("#uiDialogBox-effect-shadowOffsetX"),_("#uiDialogBox-effect-shadowOffsetY"),_("#uiDialogBox-effect-color")]},{case:"stroke",targets:[_("#uiDialogBox-effect-strokeWidth"),_("#uiDialogBox-effect-color")]},{case:"outline",targets:[_("#uiDialogBox-effect-color")]}]);var e=_(`#uiDialogBox-content, #uiDialogBox-interval, #uiDialogBox-size,
    #uiDialogBox-lineSpacing, #uiDialogBox-letterSpacing, #uiDialogBox-color, #uiDialogBox-font,
    #uiDialogBox-typeface, #uiDialogBox-effect-type, #uiDialogBox-effect-shadowOffsetX, #uiDialogBox-effect-shadowOffsetY,
    #uiDialogBox-effect-strokeWidth, #uiDialogBox-effect-color, #uiDialogBox-blend`),t=_("#uiDialogBox-size-slider, #uiDialogBox-lineSpacing-slider, #uiDialogBox-letterSpacing-slider");e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Y)),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur)},$i.create=function(){var e=Wi.createTransform();return e.width=100,{class:"dialogbox",name:"DialogBox",enabled:!0,expanded:!(e.height=24),hidden:!1,locked:!1,presetId:"",content:"Content",interval:16.6666,size:16,lineSpacing:0,letterSpacing:0,color:"ffffffff",font:"",typeface:"regular",effect:{type:"none"},blend:"normal",transform:e,events:[],scripts:[],children:[]}},$i.open=function(e){var t;this.target!==e&&(this.target=e,(t=D("uiDialogBox",e))("content"),t("interval"),t("size"),t("lineSpacing"),t("letterSpacing"),t("color"),t("font"),t("typeface"),t("effect-type"),t("effect-shadowOffsetX",e.effect.shadowOffsetX||1),t("effect-shadowOffsetY",e.effect.shadowOffsetY||1),t("effect-strokeWidth",e.effect.strokeWidth||1),t("effect-color",e.effect.color||"000000ff"),t("blend"),Wi.open(e))},$i.close=function(){this.target&&(Y.list.unselect(this.target),Y.updateTarget(),Wi.close(),this.target=null)},$i.update=function(e,t,i){Y.planToSave();var a=e.instance;switch(t){case"content":case"interval":case"size":case"lineSpacing":case"letterSpacing":case"color":case"typeface":case"blend":e[t]!==i&&(e[t]=i,a[t]=i);break;case"font":var n=i.trim();e.font!==n&&(e.font=n,a.font=n);break;case"effect-type":if(e.effect.type!==i){var s=g("uiDialogBox-effect"),r={type:i};switch(i){case"none":break;case"shadow":r.shadowOffsetX=s("shadowOffsetX"),r.shadowOffsetY=s("shadowOffsetY"),r.color=s("color");break;case"stroke":r.strokeWidth=s("strokeWidth"),r.color=s("color");break;case"outline":r.color=s("color")}e.effect=r,a.effect=r}break;case"effect-shadowOffsetX":case"effect-shadowOffsetY":case"effect-strokeWidth":case"effect-color":n=t.indexOf("-")+1,n=t.slice(n);e.effect[n]!==i&&(e.effect[n]=i,a.effect=e.effect)}Y.requestRendering()},$i.paramInput=function(e){$i.update($i.target,j.getKey(this),this.read())},j.uiDialogBox=$i}{const Zi={owner:Y,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};Zi.initialize=function(){_("#uiProgressBar-display").loadItems([{name:"Stretch",value:"stretch"},{name:"Clip",value:"clip"}]),_("#uiProgressBar-display").enableHiddenMode().relate([{case:"clip",targets:[_("#uiProgressBar-clip")]}]),_("#uiProgressBar-type").loadItems([{name:"Horizontal",value:"horizontal"},{name:"Vertical",value:"vertical"},{name:"Round",value:"round"}]),_("#uiProgressBar-type").enableHiddenMode().relate([{case:"round",targets:[_("#uiProgressBar-centerX"),_("#uiProgressBar-centerY"),_("#uiProgressBar-startAngle"),_("#uiProgressBar-centralAngle")]}]),_("#uiProgressBar-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"}]),_("#uiProgressBar-colorMode").loadItems([{name:"Texture Sampling",value:"texture"},{name:"Fixed",value:"fixed"}]),_("#uiProgressBar-colorMode").enableHiddenMode().relate([{case:"fixed",targets:[_("#uiProgressBar-color-0-box"),_("#uiProgressBar-color-1-box"),_("#uiProgressBar-color-2-box"),_("#uiProgressBar-color-3-box")]}]),_("#uiProgressBar-color-0-slider").synchronize(_("#uiProgressBar-color-0")),_("#uiProgressBar-color-1-slider").synchronize(_("#uiProgressBar-color-1")),_("#uiProgressBar-color-2-slider").synchronize(_("#uiProgressBar-color-2")),_("#uiProgressBar-color-3-slider").synchronize(_("#uiProgressBar-color-3"));var e=_(`#uiProgressBar-image,
    #uiProgressBar-display, #uiProgressBar-clip,
    #uiProgressBar-type, #uiProgressBar-centerX, #uiProgressBar-centerY,
    #uiProgressBar-startAngle, #uiProgressBar-centralAngle, #uiProgressBar-step,
    #uiProgressBar-progress, #uiProgressBar-blend, #uiProgressBar-colorMode,
    #uiProgressBar-color-0, #uiProgressBar-color-1,
    #uiProgressBar-color-2, #uiProgressBar-color-3`),t=_(`
    #uiProgressBar-color-0-slider, #uiProgressBar-color-1-slider,
    #uiProgressBar-color-2-slider, #uiProgressBar-color-3-slider`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Y)),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur)},Zi.create=function(){var e=Wi.createTransform();return e.width=100,{class:"progressbar",name:"ProgressBar",enabled:!0,expanded:!(e.height=100),hidden:!1,locked:!1,presetId:"",image:"",display:"stretch",clip:[0,0,32,32],type:"horizontal",centerX:.5,centerY:.5,startAngle:-90,centralAngle:360,step:0,progress:1,blend:"normal",colorMode:"texture",color:[0,0,0,0],transform:e,events:[],scripts:[],children:[]}},Zi.open=function(e){var t;this.target!==e&&(this.target=e,(t=D("uiProgressBar",e))("image"),t("display"),t("clip"),t("type"),t("centerX"),t("centerY"),t("startAngle"),t("centralAngle"),t("step"),t("progress"),t("blend"),t("colorMode"),t("color-0"),t("color-1"),t("color-2"),t("color-3"),Wi.open(e))},Zi.close=function(){this.target&&(Y.list.unselect(this.target),Y.updateTarget(),Wi.close(),this.target=null)},Zi.update=function(e,t,i){Y.planToSave();var a=e.instance;switch(t){case"image":case"display":case"clip":case"type":case"centerX":case"centerY":case"startAngle":case"centralAngle":case"step":case"progress":case"blend":case"colorMode":e[t]!==i&&(e[t]=i,a[t]=i);break;case"color-0":case"color-1":case"color-2":case"color-3":var n=t.indexOf("-")+1,n=t.slice(n);e.color[n]!==i&&(e.color[n]=i,a.color[n]=i)}Y.requestRendering()},Zi.paramInput=function(e){Zi.update(Zi.target,j.getKey(this),this.read())},j.uiProgressBar=Zi}{const Ji={owner:Y,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};Ji.initialize=function(){_("#uiVideo-loop").loadItems([{name:"Once",value:!1},{name:"Loop",value:!0}]),_("#uiVideo-flip").loadItems([{name:"None",value:"none"},{name:"Horizontal",value:"horizontal"},{name:"Vertical",value:"vertical"},{name:"Both",value:"both"}]),_("#uiVideo-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"}]);var e=_("#uiVideo-video, #uiVideo-loop, #uiVideo-flip, #uiVideo-blend");e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Y))},Ji.create=function(){var e=Wi.createTransform();return e.width=100,{class:"video",name:"Video",enabled:!0,expanded:!(e.height=100),hidden:!1,locked:!1,presetId:"",video:"",loop:!1,flip:"none",blend:"normal",transform:e,events:[],scripts:[],children:[]}},Ji.open=function(e){var t;this.target!==e&&(this.target=e,(t=D("uiVideo",e))("video"),t("loop"),t("flip"),t("blend"),Wi.open(e))},Ji.close=function(){this.target&&(Y.list.unselect(this.target),Y.updateTarget(),Wi.close(),this.target=null)},Ji.update=function(e,t,i){switch(Y.planToSave(),t){case"video":case"loop":case"flip":case"blend":e[t]!==i&&(e[t]=i)}Y.requestRendering()},Ji.paramInput=function(e){Ji.update(Ji.target,j.getKey(this),this.read())},j.uiVideo=Ji}{const Qi={owner:Y,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};Qi.initialize=function(){_("#uiWindow-layout").loadItems([{name:"Normal",value:"normal"},{name:"Horizontal Grid",value:"horizontal-grid"},{name:"Vertical Grid",value:"vertical-grid"}]),_("#uiWindow-layout").enableHiddenMode().relate([{case:"normal",targets:[_("#uiWindow-scrollX"),_("#uiWindow-scrollY")]},{case:["horizontal-grid","vertical-grid"],targets:[_("#uiWindow-scrollX"),_("#uiWindow-scrollY"),_("#uiWindow-gridWidth"),_("#uiWindow-gridHeight"),_("#uiWindow-gridGapX"),_("#uiWindow-gridGapY"),_("#uiWindow-paddingX"),_("#uiWindow-paddingY")]}]),_("#uiWindow-overflow").loadItems([{name:"Visible",value:"visible"},{name:"Hidden",value:"hidden"}]);var e=_(`#uiWindow-layout,
    #uiWindow-scrollX, #uiWindow-scrollY, #uiWindow-gridWidth,
    #uiWindow-gridHeight, #uiWindow-gridGapX, #uiWindow-gridGapY,
    #uiWindow-paddingX, #uiWindow-paddingY, #uiWindow-overflow`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Y))},Qi.create=function(){var e=Wi.createTransform();return e.width=100,{class:"window",name:"Window",enabled:!0,expanded:!(e.height=100),hidden:!1,locked:!1,presetId:"",layout:"normal",scrollX:0,scrollY:0,gridWidth:0,gridHeight:0,gridGapX:0,gridGapY:0,paddingX:0,paddingY:0,overflow:"visible",transform:e,events:[],scripts:[],children:[]}},Qi.open=function(e){var t;this.target!==e&&(this.target=e,(t=D("uiWindow",e))("layout"),t("scrollX"),t("scrollY"),t("gridWidth"),t("gridHeight"),t("gridGapX"),t("gridGapY"),t("paddingX"),t("paddingY"),t("overflow"),Wi.open(e))},Qi.close=function(){this.target&&(Y.list.unselect(this.target),Y.updateTarget(),Wi.close(),this.target=null)},Qi.update=function(e,t,i){Y.planToSave();var a=e.instance;switch(t){case"layout":case"overflow":e[t]!==i&&(e[t]=i,a[t]=i);break;case"scrollX":case"scrollY":case"gridWidth":case"gridHeight":case"gridGapX":case"gridGapY":case"paddingX":case"paddingY":e[t]!==i&&(e[t]=i,a[t]=i,a.resize())}Y.requestRendering()},Qi.paramInput=function(e){Qi.update(Qi.target,j.getKey(this),this.read())},j.uiWindow=Qi}Oe={owner:Y,target:null,create:null,open:null,close:null};Oe.create=function(){var e=Wi.createTransform();return e.width=100,{class:"container",name:"Container",enabled:!0,expanded:!(e.height=100),hidden:!1,locked:!1,presetId:"",transform:e,events:[],scripts:[],children:[]}},Oe.open=function(e){this.target!==e&&(this.target=e,Wi.open(e),D("uiContainer",e),Wi.open(e))},Oe.close=function(){this.target&&(Y.list.unselect(this.target),Y.updateTarget(),Wi.close(),this.target=null)},j.uiContainer=Oe,j.uiElement=Wi}{const ea={owner:null,target:null,initialize:null,create:null,createDir:null,open:null,close:null,write:null,update:null,paramInput:null};ea.initialize=function(){this.owner={setTarget:e=>{Ke.setMotion(e),j.open("animMotion",e)}},_("#animMotion-mode").loadItems([{name:"1 Directional",value:"1-dir"},{name:"2 Directional",value:"2-dir"},{name:"4 Directional",value:"4-dir"},{name:"8 Directional",value:"8-dir"},{name:"1 Directional - Mirror",value:"1-dir-mirror"},{name:"3 Directional - Mirror",value:"3-dir-mirror"},{name:"5 Directional - Mirror",value:"5-dir-mirror"}]),_("#animMotion-loop").relate([_("#animMotion-loopStart")]);var e=_("#animMotion-mode"),t=_("#animMotion-loop, #animMotion-loopStart");e.on("input",this.paramInput),t.on("input",this.paramInput),t.on("focus",j.inputFocus),t.on("blur",j.inputBlur(this,Ke))},ea.create=function(e){return{class:"motion",id:e,mode:"1-dir",loop:!1,loopStart:0,dirCases:[this.createDir()]}},ea.createDir=function(){return{layers:[j.animSpriteLayer.create()]}},ea.open=function(e){this.target!==e&&(this.target=e,(e=D("animMotion",e))("mode"),e("loop"),e("loopStart"))},ea.close=function(){this.target&&(this.target=null)},ea.write=function(e){void 0!==e.mode&&_("#animMotion-mode").write(e.mode)},ea.update=function(e,t,i){switch(Ke.planToSave(),t){case"mode":if(e.mode!==i){Ke.setMotionMode(i),Ke.createDirItems();break}case"loop":e.loop!==i&&(e.loop=i,Ke.list.updateLoopIcon(e));break;case"loopStart":e.loopStart!==i&&(e.loopStart=i,Ke.player.computeLength())}},ea.paramInput=function(e){ea.update(ea.target,j.getKey(this),this.read())},j.animMotion=ea}e={create:null};e.create=function(){return{class:"joint",name:"Joint",expanded:!0,hidden:!1,locked:!1,frames:[j.animJointFrame.create()],children:[]}},j.animJointLayer=e;{const ta={motion:null,target:null,initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};ta.initialize=function(){var e=_(`#animJointFrame-x, #animJointFrame-y, #animJointFrame-rotation,
    #animJointFrame-scaleX, #animJointFrame-scaleY, #animJointFrame-opacity`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Ke,e=>{e.type="inspector-frame-change",e.motion=this.motion,e.direction=Ke.direction}))},ta.create=function(){return{start:0,end:1,easingId:"",x:0,y:0,rotation:0,scaleX:1,scaleY:1,opacity:1}},ta.open=function(e){this.target!==e&&(this.target=e,this.motion=Ke.motion,Pt.load(e),(e=D("animJointFrame",e))("x"),e("y"),e("rotation"),e("scaleX"),e("scaleY"),e("opacity"))},ta.close=function(){this.target&&(Ke.unselectMarquee(this.target),Pt.load(null),this.target=null,this.motion=null)},ta.write=function(e){void 0!==e.x&&_("#animJointFrame-x").write(e.x),void 0!==e.y&&_("#animJointFrame-y").write(e.y),void 0!==e.rotation&&_("#animJointFrame-rotation").write(e.rotation),void 0!==e.scaleX&&_("#animJointFrame-scaleX").write(e.scaleX),void 0!==e.scaleY&&_("#animJointFrame-scaleY").write(e.scaleY)},ta.update=function(e,t,i){switch(Ke.planToSave(),t){case"x":case"y":case"rotation":case"scaleX":case"scaleY":case"opacity":e[t]!==i&&(e[t]=i,Ke.updateFrameContexts())}Ke.requestRendering()},ta.paramInput=function(e){ta.update(ta.target,j.getKey(this),this.read())},j.animJointFrame=ta}{const ia={motion:null,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};ia.initialize=function(){_("#animSpriteLayer-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"}]),_("#animSpriteLayer-light").loadItems([{name:"Raw",value:"raw"},{name:"Global Sampling",value:"global"},{name:"Anchor Sampling",value:"anchor"}]);var e=_("#animSpriteLayer-sprite, #animSpriteLayer-blend, #animSpriteLayer-light");e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Ke,e=>{e.type="inspector-layer-change",e.motion=this.motion,e.direction=Ke.direction}))},ia.create=function(){return{class:"sprite",name:"Sprite",hidden:!1,locked:!1,sprite:"",blend:"normal",light:"raw",frames:[j.animSpriteFrame.create()]}},ia.open=function(e){var t;this.target!==e&&(this.target=e,this.motion=Ke.motion,t=Ke.meta.guid,t=Ke.getSpriteListItems(t),_("#animSpriteLayer-sprite").loadItems(t),(t=D("animSpriteLayer",e))("sprite"),t("blend"),t("light"))},ia.close=function(){this.target&&(this.target=null,this.motion=null)},ia.update=function(e,t,i){switch(Ke.planToSave(),t){case"sprite":case"blend":case"light":e[t]!==i&&(e[t]=i)}Ke.requestRendering()},ia.paramInput=function(e){ia.update(ia.target,j.getKey(this),this.read())},j.animSpriteLayer=ia}{const aa={motion:null,target:null,initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};aa.initialize=function(){_("#animSpriteFrame-tint-0-slider").synchronize(_("#animSpriteFrame-tint-0")),_("#animSpriteFrame-tint-1-slider").synchronize(_("#animSpriteFrame-tint-1")),_("#animSpriteFrame-tint-2-slider").synchronize(_("#animSpriteFrame-tint-2")),_("#animSpriteFrame-tint-3-slider").synchronize(_("#animSpriteFrame-tint-3"));var e=_(`#animSpriteFrame-x, #animSpriteFrame-y, #animSpriteFrame-rotation,
    #animSpriteFrame-scaleX, #animSpriteFrame-scaleY, #animSpriteFrame-opacity,
    #animSpriteFrame-tint-0, #animSpriteFrame-tint-1, #animSpriteFrame-tint-2, #animSpriteFrame-tint-3`),t=_(`
    #animSpriteFrame-tint-0-slider, #animSpriteFrame-tint-1-slider,
    #animSpriteFrame-tint-2-slider, #animSpriteFrame-tint-3-slider`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Ke,e=>{e.type="inspector-frame-change",e.motion=this.motion,e.direction=Ke.direction})),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur),y.initialize()},aa.create=function(){return{start:0,end:1,easingId:"",x:0,y:0,rotation:0,scaleX:1,scaleY:1,opacity:1,spriteX:0,spriteY:0,tint:[0,0,0,0]}},aa.open=function(e){this.target!==e&&(this.target=e,this.motion=Ke.motion,y.open(e),Pt.load(e),(e=D("animSpriteFrame",e))("x"),e("y"),e("rotation"),e("scaleX"),e("scaleY"),e("opacity"),e("tint-0"),e("tint-1"),e("tint-2"),e("tint-3"))},aa.close=function(){this.target&&(Ke.unselectMarquee(this.target),y.close(),Pt.load(null),this.target=null,this.motion=null)},aa.write=function(e){void 0!==e.x&&_("#animSpriteFrame-x").write(e.x),void 0!==e.y&&_("#animSpriteFrame-y").write(e.y),void 0!==e.rotation&&_("#animSpriteFrame-rotation").write(e.rotation),void 0!==e.scaleX&&_("#animSpriteFrame-scaleX").write(e.scaleX),void 0!==e.scaleY&&_("#animSpriteFrame-scaleY").write(e.scaleY)},aa.update=function(e,t,i){switch(Ke.planToSave(),t){case"x":case"y":case"rotation":case"scaleX":case"scaleY":case"opacity":e[t]!==i&&(e[t]=i,Ke.updateFrameContexts());break;case"tint-0":case"tint-1":case"tint-2":case"tint-3":var a=t.slice(-1);e.tint[a]!==i&&(e.tint[a]=i,Ke.updateFrameContexts())}Ke.requestRendering()},aa.paramInput=function(e){aa.update(aa.target,j.getKey(this),this.read())},j.animSpriteFrame=aa}{const na={motion:null,target:null,initialize:null,create:null,open:null,close:null,update:null,paramInput:null};na.initialize=function(){_("#animParticleLayer-angle").loadItems([{name:"Default",value:"default"},{name:"Inherit",value:"inherit"}]);var e=_("#animParticleLayer-particleId, #animParticleLayer-angle");e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Ke,e=>{e.type="inspector-layer-change",e.motion=this.motion,e.direction=Ke.direction}))},na.create=function(){return{class:"particle",name:"Particle",hidden:!1,locked:!1,particleId:"",angle:"default",frames:[j.animParticleFrame.create()]}},na.open=function(e){this.target!==e&&(this.target=e,this.motion=Ke.motion,(e=D("animParticleLayer",e))("particleId"),e("angle"))},na.close=function(){this.target&&(this.target=null,this.motion=null)},na.update=function(e,t,i){switch(Ke.planToSave(),t){case"particleId":e.particleId!==i&&(e.particleId=i,Ke.player.destroyContextEmitters(),Ke.updateFrameContexts());break;case"angle":e.angle!==i&&(e.angle=i)}Ke.requestRendering()},na.paramInput=function(e){na.update(na.target,j.getKey(this),this.read())},j.animParticleLayer=na}{const sa={motion:null,target:null,initialize:null,create:null,open:null,close:null,write:null,update:null,paramInput:null};sa.initialize=function(){var e=_(`#animParticleFrame-x, #animParticleFrame-y, #animParticleFrame-rotation,
    #animParticleFrame-scaleX, #animParticleFrame-scaleY, #animParticleFrame-opacity,
    #animParticleFrame-scale, #animParticleFrame-speed`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,Ke,e=>{e.type="inspector-frame-change",e.motion=this.motion,e.direction=Ke.direction}))},sa.create=function(){return{start:0,end:1,easingId:"",x:0,y:0,rotation:0,scaleX:1,scaleY:1,opacity:1,scale:1,speed:1}},sa.open=function(e){this.target!==e&&(this.target=e,this.motion=Ke.motion,Pt.load(e),(e=D("animParticleFrame",e))("x"),e("y"),e("rotation"),e("scaleX"),e("scaleY"),e("opacity"),e("scale"),e("speed"))},sa.close=function(){this.target&&(Ke.unselectMarquee(this.target),Pt.load(null),this.target=null,this.motion=null)},sa.write=function(e){void 0!==e.x&&_("#animParticleFrame-x").write(e.x),void 0!==e.y&&_("#animParticleFrame-y").write(e.y),void 0!==e.rotation&&_("#animParticleFrame-rotation").write(e.rotation),void 0!==e.scaleX&&_("#animParticleFrame-scaleX").write(e.scaleX),void 0!==e.scaleY&&_("#animParticleFrame-scaleY").write(e.scaleY)},sa.update=function(e,t,i){switch(Ke.planToSave(),t){case"x":case"y":case"rotation":case"scaleX":case"scaleY":case"opacity":e[t]!==i&&(e[t]=i,Ke.updateFrameContexts());break;case"scale":case"speed":e[t]!==i&&(e[t]=i)}Ke.requestRendering()},sa.paramInput=function(e){sa.update(sa.target,j.getKey(this),this.read())},j.animParticleFrame=sa}{const ra={owner:S,target:null,nameBox:_("#particleLayer-name"),initialize:null,create:null,open:null,close:null,update:null,paramInput:null};ra.initialize=function(){_("#particleLayer-area-type").loadItems([{name:"Point",value:"point"},{name:"Rectangle",value:"rectangle"},{name:"Circle",value:"circle"},{name:"Screen Edge",value:"edge"}]),_("#particleLayer-blend").loadItems([{name:"Normal",value:"normal"},{name:"Additive",value:"additive"},{name:"Subtract",value:"subtract"}]),_("#particleLayer-sort").loadItems([{name:"Youngest in Front",value:"youngest-in-front"},{name:"Oldest in Front",value:"oldest-in-front"},{name:"By Scale Factor",value:"by-scale-factor"}]),_("#particleLayer-color-mode").loadItems([{name:"Fixed",value:"fixed"},{name:"Random",value:"random"},{name:"Easing",value:"easing"},{name:"Texture Sampling",value:"texture"}]),_("#particleLayer-area-type").enableHiddenMode().relate([{case:"rectangle",targets:[_("#particleLayer-area-width"),_("#particleLayer-area-height")]},{case:"circle",targets:[_("#particleLayer-area-radius")]}]),_("#particleLayer-color-mode").enableHiddenMode().relate([{case:"fixed",targets:[_("#particleLayer-color-rgba-box")]},{case:"random",targets:[_("#particleLayer-color-min-box"),_("#particleLayer-color-max-box")]},{case:"easing",targets:[_("#particleLayer-color-easingId"),_("#particleLayer-color-startMin-box"),_("#particleLayer-color-startMax-box"),_("#particleLayer-color-endMin-box"),_("#particleLayer-color-endMax-box")]},{case:"texture",targets:[_("#particleLayer-color-tint-0-box"),_("#particleLayer-color-tint-1-box"),_("#particleLayer-color-tint-2-box"),_("#particleLayer-color-tint-3-box")]}]),_("#particleLayer-color-tint-0-slider").synchronize(_("#particleLayer-color-tint-0")),_("#particleLayer-color-tint-1-slider").synchronize(_("#particleLayer-color-tint-1")),_("#particleLayer-color-tint-2-slider").synchronize(_("#particleLayer-color-tint-2")),_("#particleLayer-color-tint-3-slider").synchronize(_("#particleLayer-color-tint-3"));var e=_(`#particleLayer-name,
    #particleLayer-area-type, #particleLayer-area-x, #particleLayer-area-y,
    #particleLayer-area-width, #particleLayer-area-height, #particleLayer-area-radius,
    #particleLayer-maximum, #particleLayer-count,
    #particleLayer-delay, #particleLayer-interval, #particleLayer-lifetime,
    #particleLayer-lifetimeDev, #particleLayer-fadeout,
    #particleLayer-anchor-x-0, #particleLayer-anchor-x-1,
    #particleLayer-anchor-y-0, #particleLayer-anchor-y-1,
    #particleLayer-movement-angle-0, #particleLayer-movement-angle-1,
    #particleLayer-movement-speed-0, #particleLayer-movement-speed-1,
    #particleLayer-movement-accelAngle-0, #particleLayer-movement-accelAngle-1,
    #particleLayer-movement-accel-0, #particleLayer-movement-accel-1,
    #particleLayer-rotation-angle-0, #particleLayer-rotation-angle-1,
    #particleLayer-rotation-speed-0, #particleLayer-rotation-speed-1,
    #particleLayer-rotation-accel-0, #particleLayer-rotation-accel-1,
    #particleLayer-scale-factor-0, #particleLayer-scale-factor-1,
    #particleLayer-scale-speed-0, #particleLayer-scale-speed-1,
    #particleLayer-scale-accel-0, #particleLayer-scale-accel-1,
    #particleLayer-image, #particleLayer-blend, #particleLayer-sort,
    #particleLayer-hframes, #particleLayer-vframes,
    #particleLayer-color-mode,
    #particleLayer-color-rgba-0, #particleLayer-color-rgba-1,
    #particleLayer-color-rgba-2, #particleLayer-color-rgba-3,
    #particleLayer-color-min-0, #particleLayer-color-min-1,
    #particleLayer-color-min-2, #particleLayer-color-min-3,
    #particleLayer-color-max-0, #particleLayer-color-max-1,
    #particleLayer-color-max-2, #particleLayer-color-max-3,
    #particleLayer-color-easingId,
    #particleLayer-color-startMin-0, #particleLayer-color-startMin-1,
    #particleLayer-color-startMin-2, #particleLayer-color-startMin-3,
    #particleLayer-color-startMax-0, #particleLayer-color-startMax-1,
    #particleLayer-color-startMax-2, #particleLayer-color-startMax-3,
    #particleLayer-color-endMin-0, #particleLayer-color-endMin-1,
    #particleLayer-color-endMin-2, #particleLayer-color-endMin-3,
    #particleLayer-color-endMax-0, #particleLayer-color-endMax-1,
    #particleLayer-color-endMax-2, #particleLayer-color-endMax-3,
    #particleLayer-color-tint-0, #particleLayer-color-tint-1,
    #particleLayer-color-tint-2, #particleLayer-color-tint-3`),t=_(`
    #particleLayer-color-tint-0-slider, #particleLayer-color-tint-1-slider,
    #particleLayer-color-tint-2-slider, #particleLayer-color-tint-3-slider`);e.on("input",this.paramInput),e.on("focus",j.inputFocus),e.on("blur",j.inputBlur(this,S)),t.on("focus",j.sliderFocus),t.on("blur",j.sliderBlur)},ra.create=function(){return{name:"Layer",hidden:!1,locked:!1,area:{type:"point",x:0,y:0},maximum:20,count:0,delay:0,interval:40,lifetime:1e3,lifetimeDev:0,fadeout:200,anchor:{x:[.5,.5],y:[.5,.5]},movement:{angle:[0,0],speed:[0,0],accelAngle:[0,0],accel:[0,0]},rotation:{angle:[0,0],speed:[0,0],accel:[0,0]},scale:{factor:[1,1],speed:[0,0],accel:[0,0]},image:"",blend:"normal",sort:"youngest-in-front",hframes:1,vframes:1,color:{mode:"texture",tint:[0,0,0,0]}}},ra.open=function(e){var t,i,a,n,s,r,o,l,c,h;this.target!==e&&(this.target=e,_("#particleLayer-color-easingId").loadItems(He.createEasingItems()),{area:t,color:i}=e,{rgba:i,min:a,max:n,easingId:s,startMin:r,startMax:o,endMin:l,endMax:c,tint:h}=i,(e=D("particleLayer",e))("name"),e("area-type"),e("area-x",t.x??0),e("area-y",t.y??0),e("area-width",t.width??64),e("area-height",t.height??64),e("area-radius",t.radius??32),e("maximum"),e("count"),e("delay"),e("interval"),e("lifetime"),e("lifetimeDev"),e("fadeout"),e("anchor-x-0"),e("anchor-x-1"),e("anchor-y-0"),e("anchor-y-1"),e("movement-angle-0"),e("movement-angle-1"),e("movement-speed-0"),e("movement-speed-1"),e("movement-accelAngle-0"),e("movement-accelAngle-1"),e("movement-accel-0"),e("movement-accel-1"),e("rotation-angle-0"),e("rotation-angle-1"),e("rotation-speed-0"),e("rotation-speed-1"),e("rotation-accel-0"),e("rotation-accel-1"),e("scale-factor-0"),e("scale-factor-1"),e("scale-speed-0"),e("scale-speed-1"),e("scale-accel-0"),e("scale-accel-1"),e("image"),e("blend"),e("sort"),e("hframes"),e("vframes"),e("color-mode"),e("color-rgba-0",i?.[0]??255),e("color-rgba-1",i?.[1]??255),e("color-rgba-2",i?.[2]??255),e("color-rgba-3",i?.[3]??255),e("color-min-0",a?.[0]??0),e("color-min-1",a?.[1]??0),e("color-min-2",a?.[2]??0),e("color-min-3",a?.[3]??255),e("color-max-0",n?.[0]??255),e("color-max-1",n?.[1]??255),e("color-max-2",n?.[2]??255),e("color-max-3",n?.[3]??255),e("color-easingId",s??He.easings[0].id),e("color-startMin-0",r?.[0]??0),e("color-startMin-1",r?.[1]??0),e("color-startMin-2",r?.[2]??0),e("color-startMin-3",r?.[3]??255),e("color-startMax-0",o?.[0]??255),e("color-startMax-1",o?.[1]??255),e("color-startMax-2",o?.[2]??255),e("color-startMax-3",o?.[3]??255),e("color-endMin-0",l?.[0]??0),e("color-endMin-1",l?.[1]??0),e("color-endMin-2",l?.[2]??0),e("color-endMin-3",l?.[3]??255),e("color-endMax-0",c?.[0]??255),e("color-endMax-1",c?.[1]??255),e("color-endMax-2",c?.[2]??255),e("color-endMax-3",c?.[3]??255),e("color-tint-0",h?.[0]??0),e("color-tint-1",h?.[1]??0),e("color-tint-2",h?.[2]??0),e("color-tint-3",h?.[3]??0))},ra.close=function(){this.target&&(S.list.unselect(this.target),S.updateTarget(),this.target=null)},ra.update=function(e,i,a){var t=S.emitter.getLayer(e);switch(S.planToSave(),i){case"name":e.name!==a&&(e.name=a,S.updateParticleInfo(),S.list.updateItemName(e));break;case"area-type":var n=e["area"];if(n.type!==a){n.type=a,delete n.x,delete n.y,delete n.width,delete n.height,delete n.radius;var s=g("particleLayer-area");switch(a){case"point":n.x=s("x"),n.y=s("y");break;case"rectangle":n.x=s("x"),n.y=s("y"),n.width=s("width"),n.height=s("height");break;case"circle":n.x=s("x"),n.y=s("y"),n.radius=s("radius")}t.updateElementMethods(),S.computeOuterRect()}break;case"area-x":case"area-y":case"area-width":case"area-height":case"area-radius":var r=e["area"],o=i.indexOf("-")+1,o=i.slice(o);r[o]!==a&&(r[o]=a,S.computeOuterRect());break;case"maximum":e.maximum!==a&&(e.maximum=a,t.setMaximum(a));break;case"count":e.count!==a&&(e.count=a,t.updateCount(),t.clear());break;case"delay":e.delay!==a&&(e.delay=a,t.clear());break;case"interval":e.interval!==a&&(e.interval=a,t.elapsed>=a&&(t.elapsed=0),0===a)&&t.clear();break;case"lifetime":case"lifetimeDev":e[i]!==a&&(e[i]=a,t.clear());break;case"fadeout":e.fadeout!==a&&(e.fadeout=a);break;case"image":e.image!==a&&(e.image=a,t.loadTexture(),S.list.updateIcon(e));break;case"blend":case"sort":e[i]!==a&&(e[i]=a);break;case"hframes":case"vframes":e[i]!==a&&(e[i]=a,t.calculateElementSize(),t.resizeElementIndices(),S.list.updateIcon(e));break;case"color-mode":var l=e["color"];if(l.mode!==a){l.mode=a,delete l.rgba,delete l.min,delete l.max,delete l.easingId,delete l.startMin,delete l.startMax,delete l.endMin,delete l.endMax,delete l.tint;var c=g("particleLayer-color");switch(a){case"fixed":l.rgba=[c("rgba-0"),c("rgba-1"),c("rgba-2"),c("rgba-3")];break;case"random":l.min=[c("min-0"),c("min-1"),c("min-2"),c("min-3")],l.max=[c("max-0"),c("max-1"),c("max-2"),c("max-3")];break;case"easing":l.easingId=c("easingId"),l.startMin=[c("startMin-0"),c("startMin-1"),c("startMin-2"),c("startMin-3")],l.startMax=[c("startMax-0"),c("startMax-1"),c("startMax-2"),c("startMax-3")],l.endMin=[c("endMin-0"),c("endMin-1"),c("endMin-2"),c("endMin-3")],l.endMax=[c("endMax-0"),c("endMax-1"),c("endMax-2"),c("endMax-3")],t.updateEasing();break;case"texture":l.tint=[c("tint-0"),c("tint-1"),c("tint-2"),c("tint-3")]}t.updateElementMethods()}break;case"color-easingId":r=e["color"];r.easingId!==a&&(r.easingId=a,t.updateEasing());break;case"anchor-x-0":case"anchor-x-1":case"anchor-y-0":case"anchor-y-1":case"movement-angle-0":case"movement-angle-1":case"movement-speed-0":case"movement-speed-1":case"movement-accelAngle-0":case"movement-accelAngle-1":case"movement-accel-0":case"movement-accel-1":case"rotation-angle-0":case"rotation-angle-1":case"rotation-speed-0":case"rotation-speed-1":case"rotation-accel-0":case"rotation-accel-1":case"scale-factor-0":case"scale-factor-1":case"scale-speed-0":case"scale-speed-1":case"scale-accel-0":case"scale-accel-1":case"color-rgba-0":case"color-rgba-1":case"color-rgba-2":case"color-rgba-3":case"color-min-0":case"color-min-1":case"color-min-2":case"color-min-3":case"color-max-0":case"color-max-1":case"color-max-2":case"color-max-3":case"color-startMin-0":case"color-startMin-1":case"color-startMin-2":case"color-startMin-3":case"color-startMax-0":case"color-startMax-1":case"color-startMax-2":case"color-startMax-3":case"color-endMin-0":case"color-endMin-1":case"color-endMin-2":case"color-endMin-3":case"color-endMax-0":case"color-endMax-1":case"color-endMax-2":case"color-endMax-3":case"color-tint-0":case"color-tint-1":case"color-tint-2":case"color-tint-3":{var h=i.split("-"),d=h.length-1;let t=e;for(let e=0;e<d;e++)t=t[h[e]];o=h[d];t[o]!==a&&(t[o]=a);break}}S.requestRendering()},ra.paramInput=function(e){ra.update(ra.target,j.getKey(this),this.read())},j.particleLayer=ra}const I={target:null,id:null,words:null,format:!1,invalid:!1,initialize:null,insert:null,edit:null,open:null,save:null,parse:null,parseBlend:null,parseVariable:null,parseGlobalVariable:null,parseAttributeKey:null,parseVariableTag:null,parseVariableNumber:null,parseVariableString:null,parseVariableEnum:null,parseVariableFile:null,parseMultiLineString:null,parseSpriteName:null,parseEventType:null,parseEnumString:null,parseEnumStringTag:null,parseGroupEnumString:null,parseListItem:null,parseParameter:null,parseActor:null,parseSkill:null,parseState:null,parseEquipment:null,parseItem:null,parsePosition:null,parseAngle:null,parseDegrees:null,parseTrigger:null,parseLight:null,parseElement:null,parsePresetObject:null,parsePresetElement:null,parseTeam:null,parseActorSelector:null,parseFileName:null,parseAudioType:null,parseWait:null,parseEasing:null,parseUnlinkedId:null,WordList:null,FormatUpdater:null,cases:{},custom:null},Bt=(I.initialize=function(){this.words=new I.WordList,Bt.initialize(),C.initialize(),Ut.initialize(),$t.initialize(),Zt.initialize(),Jt.initialize(),Qt.initialize(),ei.initialize(),ti.initialize(),ii.initialize(),ai.initialize(),ni.initialize(),si.initialize(),ri.initialize(),I.custom.initialize();for(const e of Object.values(this.cases))e.initialize?.()},I.insert=function(e,t){if(this.target=e,t)return e.scrollAndResize(),this.open(t);Bt.open()},I.edit=function(e,t){var i,{id:t,params:a}=t,n=this.cases[t];n?.load instanceof Function&&(this.target=e,this.id=t,e.scrollAndResize(),i=e.getSelectionPosition())&&(O.setPositionMode("absolute"),O.absolutePos.x=i.x+100,O.absolutePos.y=i.y,O.open(t),O.setPositionMode("overlap"),n.load(a)),n||0<He.scripts[t]?.parameters.length&&this.custom.commandNameMap[t]&&(this.target=e,this.id=t,e.scrollAndResize(),i=e.getSelectionPosition())&&(O.setPositionMode("absolute"),O.absolutePos.x=i.x+100,O.absolutePos.y=i.y,O.open("scriptCommand"),O.setPositionMode("overlap"),this.custom.load(t,a))},I.open=function(e){var t,i=this.cases[e];void 0!==i?(this.id=e,i.load?(t=this.target.getSelectionPosition())&&(O.setPositionMode("absolute"),O.absolutePos.x=t.x+100,O.absolutePos.y=t.y,O.open(e),O.setPositionMode("overlap"),i.load({})):i.save()):void 0!==(t=He.scripts[e])&&this.custom.commandNameMap[e]&&(this.id=e,0!==t.parameters.length?(i=this.target.getSelectionPosition())&&(O.setPositionMode("absolute"),O.absolutePos.x=i.x+100,O.absolutePos.y=i.y,O.open("scriptCommand"),O.setPositionMode("overlap"),this.custom.load(e,{})):this.custom.save())},I.save=function(e){var{id:t,target:i}=this,i=(i.save({id:t,params:e}),this.cases[t]);void 0!==i?i.load&&O.close(t):O.close("scriptCommand")},I.parse=function(e){let t=e.id;"!"===t[0]&&(t=t.slice(1)),this.invalid=!1;var e=e.params,i=this.cases[t];return void 0!==i?i.parse(e):this.custom.parse(t,e)},I.parseBlend=function(e){return N.get("blend."+e)},I.parseVariable=function(e){var t=!e.type.includes("[]"),i="global"===e.type?this.format?`{variable:${e.key}}`:I.parseGlobalVariable(e.key):e.key;switch(e.type){case"local":return t?i:N.get("variable.local")+`[${i}]`;case"global":return t?"@"+i:N.get("variable.global")+`[${i}]`;case"actor":var a=I.parseActor(e.actor),n=I.parseAttributeKey("actor",i);return t?a+"."+n:a+`[${n}]`;case"skill":a=I.parseSkill(e.skill),n=I.parseAttributeKey("skill",i);return t?a+"."+n:a+`[${n}]`;case"state":a=I.parseState(e.state),n=I.parseAttributeKey("state",i);return t?a+"."+n:a+`[${n}]`;case"equipment":a=I.parseEquipment(e.equipment),n=I.parseAttributeKey("equipment",i);return t?a+"."+n:a+`[${n}]`;case"item":a=I.parseItem(e.item),n=I.parseAttributeKey("item",i);return t?a+"."+n:a+`[${n}]`;case"element":a=I.parseElement(e.element),n=I.parseAttributeKey("element",i);return t?a+"."+n:a+`[${n}]`}},I.parseGlobalVariable=function(e){var t;return""===e?N.get("common.none"):(t=He.variables.map[e])?t.name:"#"+e},I.parseAttributeKey=function(e,t){e=v.getGroupAttribute(e,t);return e?e.name:(this.invalid=!0,"#"+t)},I.parseVariableTag=function(){const t=/(?<=<global:)[0-9a-f]{16}(?=>)/g,i=e=>{var t=He.variables.map[e]?.name;return t?"@"+t:e};return e=>e.replace(t,i)}(),I.parseVariableNumber=function(e,t){switch(typeof e){case"number":var i=e.toString();return t?i+t:i;case"object":i=this.parseVariable(e);return t?i+" "+t:i}},I.parseVariableString=function(e){switch(typeof e){case"string":return`"${e}"`;case"object":return this.parseVariable(e)}},I.parseVariableEnum=function(e,t){switch(typeof t){case"string":return I.parseGroupEnumString(e,t);case"object":return this.parseVariable(t)}},I.parseVariableFile=function(e){switch(typeof e){case"string":return this.parseFileName(e);case"object":return this.parseVariable(e)}},I.parseMultiLineString=function(){const t=/\n/g;return function(e){return e.replace(t,"\\n")}}(),I.parseSpriteName=function(e,t){return""===t?N.get("common.none"):(e=He.animations[e]?.sprites.find(e=>e.id===t))?e.name:(this.invalid=!0,I.parseUnlinkedId(t))},I.parseEventType=function(e,t){return N.get("eventTypes."+t)||I.parseGroupEnumString(e,t)},I.parseEnumString=function(e){var t;return""===e?N.get("common.none"):(t=M.getString(e))?t.name:(this.invalid=!0,I.parseUnlinkedId(e))},I.parseEnumStringTag=function(e){return`<${I.parseEnumString(e)}>`},I.parseGroupEnumString=function(e,t){return""===t?N.get("common.none"):(e=M.getGroupString(e,t))?e.name:(this.invalid=!0,I.parseUnlinkedId(t))},I.parseListItem=function(e,t){return I.parseVariable(e)+`[${I.parseVariableNumber(t)}]`},I.parseParameter=function(e){return N.get("parameter.param")+`(${I.parseVariableString(e)})`},I.parseActor=function(e){switch(e.type){case"trigger":return N.get("actor.trigger");case"caster":return N.get("actor.caster");case"latest":return N.get("actor.latest");case"target":return N.get("actor.target");case"player":return N.get("actor.player");case"member":return N.get("actor.member")+"."+(e.memberId+1);case"global":return I.parseFileName(e.actorId);case"by-id":return I.parsePresetObject(e.presetId);case"variable":return N.get("actor.common")+`(${I.parseVariable(e.variable)})`}},I.parseSkill=function(e){switch(e.type){case"trigger":return N.get("skill.trigger");case"latest":return N.get("skill.latest");case"by-key":return I.parseActor(e.actor)+` -> ${N.get("skill.common")}<${I.parseGroupEnumString("shortcut-key",e.key)}>`;case"by-id":return I.parseActor(e.actor)+" -> "+I.parseFileName(e.skillId);case"variable":return N.get("skill.common")+`(${I.parseVariable(e.variable)})`}},I.parseState=function(e){switch(e.type){case"trigger":return N.get("state.trigger");case"latest":return N.get("state.latest");case"by-id":return I.parseActor(e.actor)+" -> "+I.parseFileName(e.stateId);case"variable":return N.get("state.common")+`(${I.parseVariable(e.variable)})`}},I.parseEquipment=function(e){switch(e.type){case"trigger":return N.get("equipment.trigger");case"latest":return N.get("equipment.latest");case"by-slot":return I.parseActor(e.actor)+` -> ${N.get("equipment.common")}<${I.parseGroupEnumString("equipment-slot",e.slot)}>`;case"variable":return N.get("equipment.common")+`(${I.parseVariable(e.variable)})`}},I.parseItem=function(e){switch(e.type){case"trigger":return N.get("item.trigger");case"latest":return N.get("item.latest");case"by-key":return I.parseActor(e.actor)+` -> ${N.get("item.common")}<${I.parseGroupEnumString("shortcut-key",e.key)}>`;case"variable":return N.get("item.common")+`(${I.parseVariable(e.variable)})`}},I.parsePosition=function(e){switch(e.type){case"absolute":var t=this.parseVariableNumber(e.x),i=this.parseVariableNumber(e.y);return N.get("position.common")+`(${t}, ${i})`;case"relative":t=this.parseVariableNumber(e.x),i=this.parseVariableNumber(e.y);return N.get("position.relative")+`(${t}, ${i})`;case"actor":return`${N.get("position.common")}(${this.parseActor(e.actor)})`;case"trigger":return`${N.get("position.common")}(${this.parseTrigger(e.trigger)})`;case"light":return`${N.get("position.common")}(${this.parseLight(e.light)})`;case"object":return`${N.get("position.common")}(${this.parsePresetObject(e.objectId)})`}},I.parseAngle=function(e){var t=e.type,i=N.get("angle."+t);switch(t){case"position":return i+" "+this.parsePosition(e.position);case"absolute":case"relative":return i+" "+this.parseDegrees(this.parseVariableNumber(e.degrees));case"direction":return i+" "+this.parseDegrees(e.degrees);case"random":return i}},I.parseDegrees=function(e){return e+"°"},I.parseTrigger=function(e){switch(e.type){case"trigger":return N.get("trigger.trigger");case"latest":return N.get("trigger.latest");case"variable":return N.get("trigger.common")+`(${I.parseVariable(e.variable)})`}},I.parseLight=function(e){switch(e.type){case"trigger":return N.get("light.trigger");case"latest":return N.get("light.latest");case"by-id":return I.parsePresetObject(e.presetId);case"variable":return N.get("light.common")+`(${I.parseVariable(e.variable)})`}},I.parseElement=function(e){switch(e.type){case"trigger":return N.get("element.trigger");case"latest":return N.get("element.latest");case"by-id":return I.parsePresetElement(e.presetId,!1);case"by-ancestor-and-id":return I.parseElement(e.ancestor)+" -> "+I.parsePresetElement(e.presetId,!1);case"by-index":return I.parseElement(e.parent)+" -> "+(N.get("element.common")+`[${I.parseVariableNumber(e.index)}]`);case"variable":return N.get("element.common")+`(${I.parseVariable(e.variable)})`}},I.parsePresetObject=function(e){return""===e?N.get("common.none"):A.presets?.[e]?.name??I.parseUnlinkedId(e)},I.parsePresetElement=function(){const s=(e,t)=>{for(const a of e){if(a.presetId===t)return a;var i=a["children"];if(0!==i.length){i=s(i,t);if(void 0!==i)return i}}};return function(e,t=!0){if(""===e)return N.get("common.none");var i=He.uiLinks[e]??"",a=I.parseFileName(i);let n;var i=He.ui[i];switch(void 0===(n=void 0!==i&&(i=s(i.nodes,e))?i.name:n)&&(n=I.parseUnlinkedId(e)),t){case!0:return`${a} {${n}}`;case!1:return n}}}(),I.parseTeam=function(e){var t=He.teams.map[e];return t?t.name:"#"+e},I.parseActorSelector=function(e){switch(e){case"enemy":case"friend":case"team":case"team-except-self":case"any-except-self":case"any":return N.get("actorFilter."+e)}},I.parseFileName=function(e){var t;return""===e?N.get("common.none"):(t=He.manifest.guidMap[e])?R.parseMetaName(t):(this.invalid=!0,"#"+e)},I.parseAudioType=function(e){switch(e){case"bgm":return"BGM";case"bgs":return"BGS";case"cv":return"CV";case"se":return"SE";case"all":return"ALL"}},I.parseWait=function(e){switch(e){case!1:return"";case!0:return N.get("transition.wait")}},I.parseEasing=function(e,t,i){var a;return 0===t?"":(a=He.easings.map[e],t=I.parseVariableNumber(t,"ms"),a=`${a?.name??"#"+e}, `+t,i?a+", "+N.get("transition.wait"):a)},I.parseUnlinkedId=function(e){return e?"#"+e:""},I.WordList=class extends Array{count;constructor(){super(),this.count=0}push(e){return e&&(this[this.count++]=e),this}join(t=", "){var i=this.count;if(0===i)return"";this.count=0;let a=this[0];for(let e=1;e<i;e++)a+=t+this[e];return a}},I.FormatUpdater=class oa{format;element;items;constructor(e,t,i){this.format=e,this.element=t,this.items=[];for(const n of i){var a=n.lastIndexOf(":")+1,a={id:n.slice(a,-1),tag:n,key:null,name:null,text:null};this.items.push(a),-1!==n.indexOf("variable")&&(a.key="variable")}}update(){let e=!1;var t=this.items;for(const r of t){var{key:i,id:a}=r;"variable"===i&&(i=He.variables.map[a]?.name,r.name!==i)&&(r.name=i,r.text=I.parseGlobalVariable(a),e=!0)}if(e){let e=this.format;for(var{tag:n,text:s}of t)e=e.replace(n,s);this.element.textContent=e}}static regexp=/\{(?:variable):[\da-f]{16}\}/g;static create(e,t){var i=this.regexp,i=e.match(i);return null===i?null:new oa(e,t,i)}},I.cases.showText={latinCharWidth:0,otherCharWidth:0,initialize:function(){_("#showText-confirm").on("click",this.save)},parse:function({target:e,parameters:t,content:i}){var a=N.get("command.showText.alias"),e=[{color:"element"},{text:a+": "},{color:"gray"},{text:I.words.push(I.parseActor(e)).push(t).join()}];return i=I.parseVariableTag(i),this.appendTextLines(e,a,i),e},load:function({target:e={type:"trigger"},parameters:t="",content:i=""}){_("#showText-target").write(e),_("#showText-parameters").write(t),_("#showText-content").write(i),(""===i?_("#showText-target"):_("#showText-content")).getFocus()},save:function(){var e=_("#showText-target").read(),t=_("#showText-parameters").read(),i=_("#showText-content").read();if(""===i)return _("#showText-content").getFocus();I.save({target:e,parameters:t,content:i})},updateCharWidth:function(){var e;0===this.latinCharWidth&&(e="var(--font-family-mono)",this.latinCharWidth=L("          ",e).width/10,this.otherCharWidth=L("　　　　　　　　　　",e).width/10)},appendTextLines:function(){const u=(e,t,i)=>{0===e.length?e.push({color:"element"},{text:t+": "},{color:"text"},{text:i}):e.push({break:!0},{color:"transparent"},{text:t},{color:"element"},{text:": "},{color:"text"},{text:i})};return function(n,s,r){if(r){this.updateCharWidth();var e,o=r.length,l=this["latinCharWidth"],c=this["otherCharWidth"];let t=0,i=0,a=0;for(let e=0;e<o;e++){var h=r[e];if("\n"===h){var d=r.slice(a,e);if(u(n,s,d),i=0,a=e+1,10==++t)break}else{d=h<"ÿ"?l:c;if(500<(i+=d)){h=r.slice(a,e);if(u(n,s,h),i=d,a=e,10==++t)break}}}10===t?u(n,s,"......"):0!==i&&(e=r.slice(a,o),u(n,s,e))}}}()},I.cases.showChoices={initialize:function(){_("#showChoices-confirm").on("click",this.save),_("#showChoices").on("closed",e=>{this.choices=null})},choices:null,parse:function({choices:e,parameters:t}){var i=[{color:"flow"},{text:N.get("command.showChoices")+": "},{color:"text"}],a=I.words;for(const s of e)a.push(s.content);i.push({text:a.join()}),t&&i.push({color:"gray"},{text:` (${t})`}),i.push({color:"flow"}),i.push({break:!0});var n=N.get("command.showChoices.when");for(const r of e)i.push({color:"flow"},{text:n+" "},{color:"text"},{text:r.content},{children:r.commands});return i.push({text:N.get("command.showChoices.end")}),i},createDefaultChoices:function(){return[{content:N.get("showChoices.yes"),commands:[]},{content:N.get("showChoices.no"),commands:[]}]},load:function({choices:e=this.createDefaultChoices(),parameters:t=""}){var i=D("showChoices");i("choices-0",e[0]?.content??""),i("choices-1",e[1]?.content??""),i("choices-2",e[2]?.content??""),i("choices-3",e[3]?.content??""),i("parameters",t),I.cases.showChoices.choices=e,_("#showChoices-choices-0").getFocus()},save:function(){var t=g("showChoices"),i=[];for(let e=0;e<4;e++){var a=t("choices-"+e);a&&i.push({content:a,commands:I.cases.showChoices.choices[e]?.commands??[]})}if(0===i.length)return _("#showChoices-choices-0").getFocus();var e=t("parameters");I.save({choices:i,parameters:e})}},I.cases.comment={initialize:function(){_("#comment-confirm").on("click",this.save)},parse:function({comment:e}){var t=[];for(const i of e.split("\n"))t.push(0===t.length?{color:"comment"}:{break:!0},{text:i});return t},load:function({comment:e=""}){_("#comment-comment").write(e),_("#comment-comment").getFocus("end")},save:function(){var e=_("#comment-comment").read();if(""===e)return _("#comment-comment").getFocus();I.save({comment:e})}},I.cases.setBoolean={initialize:function(){_("#setBoolean-confirm").on("click",this.save),_("#setBoolean-operation").loadItems([{name:"Set",value:"set"},{name:"Not",value:"not"},{name:"And",value:"and"},{name:"Or",value:"or"},{name:"Xor",value:"xor"}]),_("#setBoolean-operand-type").loadItems([{name:"Constant",value:"constant"},{name:"Variable",value:"variable"},{name:"List",value:"list"},{name:"Parameter",value:"parameter"}]),_("#setBoolean-constant-value").loadItems([{name:"False",value:!1},{name:"True",value:!0}]),_("#setBoolean-operand-type").enableHiddenMode().relate([{case:"constant",targets:[_("#setBoolean-constant-value")]},{case:"variable",targets:[_("#setBoolean-common-variable")]},{case:"list",targets:[_("#setBoolean-common-variable"),_("#setBoolean-list-index")]},{case:"parameter",targets:[_("#setBoolean-parameter-key")]}]),_("#setBoolean-operand-type").on("write",e=>{let t="all";switch(e.value){case"variable":t="boolean";break;case"list":t="object"}_("#setBoolean-common-variable").filter=t})},parseOperation:function(e){switch(e){case"set":return"=";case"not":return"=!";case"and":return"&=";case"or":return"|=";case"xor":return"^="}},parseOperand:function(e){switch(e.type){case"constant":return e.value.toString();case"variable":return I.parseVariable(e.variable);case"list":return I.parseListItem(e.variable,e.index);case"parameter":return I.parseParameter(e.key)}},parse:function({variable:e,operation:t,operand:i}){e=I.parseVariable(e),t=this.parseOperation(t),i=this.parseOperand(i);return[{color:"variable"},{text:N.get("command.setBoolean.alias")+": "},{text:e+` ${t} `+i}]},load:function({variable:e={type:"local",key:""},operation:t="set",operand:i={type:"constant",value:!1}}){var a=D("setBoolean");let n=!1,s={type:"local",key:""},r=0,o="";switch(i.type){case"constant":n=i.value;break;case"variable":s=i.variable;break;case"list":s=i.variable,r=i.index;break;case"parameter":o=i.key}a("variable",e),a("operation",t),a("operand-type",i.type),a("constant-value",n),a("common-variable",s),a("list-index",r),a("parameter-key",o),_("#setBoolean-variable").getFocus()},save:function(){var e=g("setBoolean");const t=e("variable");if(C.isNone(t))return _("#setBoolean-variable").getFocus();var i=e("operation"),a=e("operand-type");let n;switch(a){case"constant":var s=e("constant-value");n={type:a,value:s};break;case"variable":{const t=e("common-variable");if(C.isNone(t))return _("#setBoolean-common-variable").getFocus();n={type:a,variable:t};break}case"list":{const t=e("common-variable");if(C.isNone(t))return _("#setBoolean-common-variable").getFocus();s=e("list-index");n={type:a,variable:t,index:s};break}case"parameter":s=e("parameter-key");if(""===s)return _("#setBoolean-parameter-key").getFocus();n={type:a,key:s}}I.save({variable:t,operation:i,operand:n})}},I.cases.setNumber={initialize:function(){_("#setNumber-confirm").on("click",this.save),_("#setNumber-operands").bind(qt),_("#setNumber").on("closed",e=>{_("#setNumber-operands").clear()})},parseOperation:function(e){switch(e){case"set":return"=";case"add":return"+=";case"sub":return"-=";case"mul":return"*=";case"div":return"/=";case"mod":return"%="}},parseOperands:function(i){let a="";let n=!1;var e=i.length;for(let t=0;t<e;t++){var s=i[t];let e=qt.parseOperand(s);if(0!==t)switch(s.operation.replace("()","")){case"add":a+=" + ";break;case"sub":a+=" - ";break;case"mul":a+=" * ";break;case"div":a+=" / ";break;case"mod":a+=" % "}s=n,n=i[t+1]?.operation.includes("()"),!s&&n&&(e="("+e),s&&!n&&(e+=")"),a+=e}return a},parse:function({variable:e,operation:t,operands:i}){e=I.parseVariable(e),t=this.parseOperation(t),i=this.parseOperands(i);return[{color:"variable"},{text:N.get("command.setNumber.alias")+": "},{text:e+` ${t} `+i}]},load:function({variable:e={type:"local",key:""},operation:t="set",operands:i=[{operation:"add",type:"constant",value:0}]}){var a=D("setNumber");a("variable",e),a("operation",t),a("operands",i.slice()),_("#setNumber-variable").getFocus()},save:function(){var e,t=g("setNumber"),i=t("variable");return C.isNone(i)?_("#setNumber-variable").getFocus():(e=t("operation"),0===(t=t("operands")).length?_("#setNumber-operands").getFocus():(t[0].operation="add",void I.save({variable:i,operation:e,operands:t})))}},I.cases.setString={initialize:function(){_("#setString-confirm").on("click",this.save),_("#setString-operation").loadItems([{name:"Set",value:"set"},{name:"Add",value:"add"}]),_("#setString-operand-type").loadItems([{name:"Constant",value:"constant"},{name:"Variable",value:"variable"},{name:"String",value:"string"},{name:"Enumeration",value:"enum"},{name:"Object",value:"object"},{name:"Element",value:"element"},{name:"List",value:"list"},{name:"Parameter",value:"parameter"},{name:"Other",value:"other"}]),_("#setString-operand-type").enableHiddenMode().relate([{case:"constant",targets:[_("#setString-operand-constant-value")]},{case:"variable",targets:[_("#setString-operand-common-variable")]},{case:"string",targets:[_("#setString-operand-string-method"),_("#setString-operand-common-variable")]},{case:"enum",targets:[_("#setString-operand-enum-stringId")]},{case:"object",targets:[_("#setString-operand-object-property")]},{case:"element",targets:[_("#setString-operand-element-property"),_("#setString-operand-element-element")]},{case:"list",targets:[_("#setString-operand-common-variable"),_("#setString-operand-list-index")]},{case:"parameter",targets:[_("#setString-operand-parameter-key")]},{case:"other",targets:[_("#setString-operand-other-data")]}]),_("#setString-operand-type").on("write",e=>{let t="all";switch(e.value){case"variable":t="all";break;case"string":t="string";break;case"object":case"list":t="object"}_("#setString-operand-common-variable").filter=t}),_("#setString-operand-string-method").loadItems([{name:"Char",value:"char"},{name:"Slice",value:"slice"},{name:"Pad Start",value:"pad-start"},{name:"Replace",value:"replace"},{name:"Replace All",value:"replace-all"}]),_("#setString-operand-string-method").enableHiddenMode().relate([{case:"char",targets:[_("#setString-operand-string-char-index")]},{case:"slice",targets:[_("#setString-operand-string-slice-begin"),_("#setString-operand-string-slice-end")]},{case:"pad-start",targets:[_("#setString-operand-string-pad-start-length"),_("#setString-operand-string-pad-start-pad")]},{case:["replace","replace-all"],targets:[_("#setString-operand-string-replace-pattern"),_("#setString-operand-string-replace-replacement")]}]),_("#setString-operand-object-property").loadItems([{name:"Actor - File ID",value:"actor-file-id"},{name:"Actor - Anim Motion Name",value:"actor-animation-motion-name"},{name:"Skill - File ID",value:"skill-file-id"},{name:"State - File ID",value:"state-file-id"},{name:"Equipment - File ID",value:"equipment-file-id"},{name:"Equipment - Slot",value:"equipment-slot"},{name:"Item - File ID",value:"item-file-id"},{name:"File - ID",value:"file-id"}]),_("#setString-operand-object-property").enableHiddenMode().relate([{case:["actor-file-id","actor-animation-motion-name"],targets:[_("#setString-operand-common-actor")]},{case:"skill-file-id",targets:[_("#setString-operand-common-skill")]},{case:"state-file-id",targets:[_("#setString-operand-common-state")]},{case:["equipment-file-id","equipment-slot"],targets:[_("#setString-operand-common-equipment")]},{case:"item-file-id",targets:[_("#setString-operand-common-item")]},{case:"file-id",targets:[_("#setString-operand-object-fileId")]}]),_("#setString-operand-element-property").loadItems([{name:"Text - Content",value:"text-content"},{name:"Text Box - Text",value:"textBox-text"},{name:"Dialog Box - Content",value:"dialogBox-content"}]),_("#setString-operand-other-data").loadItems([{name:"Event Trigger Key",value:"trigger-key"},{name:"Start Position - Scene ID",value:"start-position-scene-id"},{name:"Show Text - Content",value:"showText-content"},{name:"Show Choices - Content 1",value:"showChoices-content-0"},{name:"Show Choices - Content 2",value:"showChoices-content-1"},{name:"Show Choices - Content 3",value:"showChoices-content-2"},{name:"Show Choices - Content 4",value:"showChoices-content-3"}])},parse:function({variable:e,operation:t,operand:i}){e=I.parseVariable(e),t=this.parseOperation(t),i=this.parseOperand(i);return[{color:"variable"},{text:N.get("command.setString.alias")+": "},{text:e+` ${t} `+i}]},load:function({variable:e={type:"local",key:""},operation:t="set",operand:i={type:"constant",value:""}}){let a="",n="char",s={type:"local",key:""},r=0,o=0,l=0,c=2,h="0",d="",u="",p="",m="actor-file-id",g="text-content",f={type:"trigger"},v={type:"trigger"},b={type:"trigger"},y={type:"trigger"},w={type:"trigger"},x={type:"trigger"},k="",T=0,I="",C="trigger-key";switch(i.type){case"constant":a=i.value;break;case"variable":s=i.variable;break;case"string":n=i.method,s=i.variable,r=i.index??r,o=i.begin??o,l=i.end??l,c=i.length??c,h=i.pad??h,d=i.pattern??d,u=i.replacement??u;break;case"enum":p=i.stringId;break;case"object":m=i.property,v=i.actor??v,b=i.skill??b,y=i.state??y,w=i.equipment??w,x=i.item??x,k=i.fileId??k;break;case"element":g=i.property,f=i.element;break;case"list":s=i.variable,T=i.index;break;case"parameter":I=i.key;break;case"other":C=i.data}var E=D("setString");E("variable",e),E("operation",t),E("operand-type",i.type),E("operand-constant-value",a),E("operand-string-method",n),E("operand-common-variable",s),E("operand-string-char-index",r),E("operand-string-slice-begin",o),E("operand-string-slice-end",l),E("operand-string-pad-start-length",c),E("operand-string-pad-start-pad",h),E("operand-string-replace-pattern",d),E("operand-string-replace-replacement",u),E("operand-enum-stringId",p),E("operand-object-property",m),E("operand-element-property",g),E("operand-element-element",f),E("operand-common-actor",v),E("operand-common-skill",b),E("operand-common-state",y),E("operand-common-equipment",w),E("operand-common-item",x),E("operand-object-fileId",k),E("operand-list-index",T),E("operand-parameter-key",I),E("operand-other-data",C),_("#setString-variable").getFocus()},save:function(){var e=g("setString");const t=e("variable");if(C.isNone(t))return _("#setString-variable").getFocus();var i=e("operation"),a=e("operand-type");let n;switch(a){case"constant":var s=e("operand-constant-value");n={type:a,value:s};break;case"variable":{const t=e("operand-common-variable");if(C.isNone(t))return _("#setString-operand-common-variable").getFocus();n={type:a,variable:t};break}case"string":{var r=e("operand-string-method");const t=e("operand-common-variable");if(C.isNone(t))return _("#setString-operand-common-variable").getFocus();switch(r){case"char":var o=e("operand-string-char-index");n={type:a,method:r,variable:t,index:o};break;case"slice":var o=e("operand-string-slice-begin"),l=e("operand-string-slice-end");n={type:a,method:r,variable:t,begin:o,end:l};break;case"pad-start":o=e("operand-string-pad-start-length"),l=e("operand-string-pad-start-pad");n={type:a,method:r,variable:t,length:o,pad:l};break;case"replace":case"replace-all":o=e("operand-string-replace-pattern");if(""===o)return _("#setString-operand-string-replace-pattern").getFocus();l=e("operand-string-replace-replacement");n={type:a,method:r,variable:t,pattern:o,replacement:l}}break}case"enum":s=e("operand-enum-stringId");if(""===s)return _("#setString-operand-enum-stringId").getFocus();n={type:a,stringId:s};break;case"object":var c=e("operand-object-property");switch(c){case"actor-file-id":case"actor-animation-motion-name":var h=e("operand-common-actor");n={type:a,property:c,actor:h};break;case"skill-file-id":h=e("operand-common-skill");n={type:a,property:c,skill:h};break;case"state-file-id":h=e("operand-common-state");n={type:a,property:c,state:h};break;case"equipment-file-id":case"equipment-slot":h=e("operand-common-equipment");n={type:a,property:c,equipment:h};break;case"item-file-id":h=e("operand-common-item");n={type:a,property:c,item:h};break;case"file-id":h=e("operand-object-fileId");n={type:a,property:c,fileId:h}}break;case"element":var s=e("operand-element-property"),d=e("operand-element-element");n={type:a,property:s,element:d};break;case"list":{const t=e("operand-common-variable");s=e("operand-list-index");if(C.isNone(t))return _("#setString-operand-common-variable").getFocus();n={type:a,variable:t,index:s};break}case"parameter":d=e("operand-parameter-key");if(""===d)return _("#setString-operand-parameter-key").getFocus();n={type:a,key:d};break;case"other":s=e("operand-other-data");n={type:a,data:s}}I.save({variable:t,operation:i,operand:n})},parseOperation:function(e){switch(e){case"set":return"=";case"add":return"+="}},parseStringMethod:function(e){var t=e.method,i=e.variable,a=N.get("command.setString.string."+t),n=I.parseVariable(i);switch(t){case"char":return a+`(${n}, ${I.parseVariableNumber(e.index)})`;case"slice":return a+`(${n}, ${I.parseVariableNumber(e.begin)}, ${I.parseVariableNumber(e.end)})`;case"pad-start":return a+`(${n}, ${e.length}, ${I.parseVariableString(e.pad)})`;case"replace":case"replace-all":return a+`(${n}, ${I.parseVariableString(e.pattern)}, ${I.parseVariableString(e.replacement)})`}},parseObjectProperty:function(e){var t=N.get("command.setString.object."+e.property);switch(e.property){case"actor-file-id":case"actor-animation-motion-name":return I.parseActor(e.actor)+" -> "+t;case"skill-file-id":return I.parseSkill(e.skill)+" -> "+t;case"state-file-id":return I.parseState(e.state)+" -> "+t;case"equipment-file-id":case"equipment-slot":return I.parseEquipment(e.equipment)+" -> "+t;case"item-file-id":return I.parseItem(e.item)+" -> "+t;case"file-id":return I.parseFileName(e.fileId)+" -> "+t}},parseElementProperty:function(e){return I.parseElement(e.element)+" -> "+N.get("command.setString.element."+e.property)},parseOther:function(e){var t=N.get("command.setString.other."+e.data);switch(e.data){case"trigger-key":case"start-position-scene-id":case"showText-content":case"showChoices-content-0":case"showChoices-content-1":case"showChoices-content-2":case"showChoices-content-3":return t}},parseOperand:function(e){switch(e.type){case"constant":return`"${I.parseMultiLineString(e.value)}"`;case"variable":return I.parseVariable(e.variable);case"string":return this.parseStringMethod(e);case"enum":return I.parseEnumStringTag(e.stringId);case"object":return this.parseObjectProperty(e);case"element":return this.parseElementProperty(e);case"list":return I.parseListItem(e.variable,e.index);case"parameter":return I.parseParameter(e.key);case"other":return this.parseOther(e)}}},I.cases.setObject={initialize:function(){_("#setObject-confirm").on("click",this.save),_("#setObject-operand-type").loadItems([{name:"None",value:"none"},{name:"Actor",value:"actor"},{name:"Skill",value:"skill"},{name:"State",value:"state"},{name:"Equipment",value:"equipment"},{name:"Item",value:"item"},{name:"Trigger",value:"trigger"},{name:"Light",value:"light"},{name:"Element",value:"element"},{name:"Variable",value:"variable"},{name:"List",value:"list"}]),_("#setObject-operand-type").enableHiddenMode().relate([{case:"actor",targets:[_("#setObject-operand-actor")]},{case:"skill",targets:[_("#setObject-operand-skill")]},{case:"state",targets:[_("#setObject-operand-state")]},{case:"equipment",targets:[_("#setObject-operand-equipment")]},{case:"item",targets:[_("#setObject-operand-item")]},{case:"trigger",targets:[_("#setObject-operand-trigger")]},{case:"light",targets:[_("#setObject-operand-light")]},{case:"element",targets:[_("#setObject-operand-element")]},{case:"variable",targets:[_("#setObject-operand-variable")]},{case:"list",targets:[_("#setObject-operand-variable"),_("#setObject-operand-list-index")]}])},parseOperand:function(e){switch(e.type){case"none":return N.get("common.none");case"actor":return I.parseActor(e.actor);case"skill":return I.parseSkill(e.skill);case"state":return I.parseState(e.state);case"equipment":return I.parseEquipment(e.equipment);case"item":return I.parseItem(e.item);case"trigger":return I.parseTrigger(e.trigger);case"light":return I.parseLight(e.light);case"element":return I.parseElement(e.element);case"variable":return I.parseVariable(e.variable);case"list":return I.parseListItem(e.variable,e.index)}},parse:function({variable:e,operand:t}){e=I.parseVariable(e),t=this.parseOperand(t);return[{color:"variable"},{text:N.get("command.setObject.alias")+": "},{text:e+" = "+t}]},load:function({variable:e={type:"local",key:""},operand:t={type:"none"}}){var i=D("setObject");let a={type:"trigger"},n={type:"trigger"},s={type:"trigger"},r={type:"trigger"},o={type:"trigger"},l={type:"trigger"},c={type:"trigger"},h={type:"trigger"},d={type:"local",key:""},u=0;switch(t.type){case"actor":a=t.actor;break;case"skill":n=t.skill;break;case"state":s=t.state;break;case"equipment":r=t.equipment;break;case"item":o=t.item;break;case"trigger":l=t.trigger;break;case"light":c=t.light;break;case"element":h=t.element;break;case"variable":d=t.variable;break;case"list":d=t.variable,u=t.index}i("variable",e),i("operand-type",t.type),i("operand-actor",a),i("operand-skill",n),i("operand-state",s),i("operand-equipment",r),i("operand-item",o),i("operand-trigger",l),i("operand-light",c),i("operand-element",h),i("operand-variable",d),i("operand-list-index",u),_("#setObject-variable").getFocus()},save:function(){var e=g("setObject");const t=e("variable");if(C.isNone(t))return _("#setObject-variable").getFocus();var i=e("operand-type");let a;switch(i){case"none":a={type:i};break;case"actor":var n=e("operand-actor");a={type:i,actor:n};break;case"skill":n=e("operand-skill");a={type:i,skill:n};break;case"state":n=e("operand-state");a={type:i,state:n};break;case"equipment":n=e("operand-equipment");a={type:i,equipment:n};break;case"item":n=e("operand-item");a={type:i,item:n};break;case"trigger":n=e("operand-trigger");a={type:i,trigger:n};break;case"light":n=e("operand-light");a={type:i,light:n};break;case"element":n=e("operand-element");a={type:i,element:n};break;case"variable":{const t=e("operand-variable");if(C.isNone(t))return _("#setObject-operand-variable").getFocus();a={type:i,variable:t};break}case"list":{const t=e("operand-variable");if(C.isNone(t))return _("#setObject-operand-variable").getFocus();n=e("operand-list-index");a={type:i,variable:t,index:n};break}}I.save({variable:t,operand:a})}},I.cases.setList={initialize:function(){_("#setList-confirm").on("click",this.save),_("#setList-operation").loadItems([{name:"Set to Empty",value:"set-empty"},{name:"Set Numbers",value:"set-numbers"},{name:"Set Strings",value:"set-strings"},{name:"Set Boolean",value:"set-boolean"},{name:"Set Number",value:"set-number"},{name:"Set String",value:"set-string"},{name:"Set Variable",value:"set-variable"},{name:"Push",value:"push"},{name:"Remove",value:"remove"}]),_("#setList-operation").enableHiddenMode().relate([{case:"set-numbers",targets:[_("#setList-numbers")]},{case:"set-strings",targets:[_("#setList-strings")]},{case:"set-boolean",targets:[_("#setList-index"),_("#setList-boolean")]},{case:"set-number",targets:[_("#setList-index"),_("#setList-number")]},{case:"set-string",targets:[_("#setList-index"),_("#setList-string")]},{case:"set-variable",targets:[_("#setList-index"),_("#setList-operand")]},{case:["push","remove"],targets:[_("#setList-operand")]}]),_("#setList-boolean").loadItems([{name:"False",value:!1},{name:"True",value:!0}])},parse:function({variable:e,operation:t,list:i,index:a,constant:n,operand:s}){let r;var o=I.parseVariable(e);switch(t){case"set-empty":r=o+" = []";break;case"set-numbers":r=`${o} = [${I.parseMultiLineString(i.join(", "))}]`;break;case"set-strings":{let e="";0!==i.length&&(e=`"${I.parseMultiLineString(i.join('", "'))}"`),r=`${o} = [${e}]`;break}case"set-boolean":case"set-number":r=`${o}[${I.parseVariableNumber(a)}] = `+n;break;case"set-string":r=`${o}[${I.parseVariableNumber(a)}] = "${I.parseMultiLineString(n)}"`;break;case"set-variable":r=`${o}[${I.parseVariableNumber(a)}] = `+I.parseVariable(s);break;case"push":r=o+" += "+I.parseVariable(s);break;case"remove":r=o+" -= "+I.parseVariable(s)}return[{color:"variable"},{text:N.get("command.setList.alias")+": "},{text:r}]},load:function({variable:e={type:"local",key:""},operation:t="set-empty",list:i=[],index:a=0,constant:n=0,operand:s={type:"local",key:""}}){let r=[],o=[],l=!1,c=0,h="";switch(t){case"set-numbers":r=i;break;case"set-strings":o=i;break;case"set-boolean":l=n;break;case"set-number":c=n;break;case"set-string":h=n}var d=D("setList");d("variable",e),d("operation",t),d("numbers",r),d("strings",o),d("index",a),d("boolean",l),d("number",c),d("string",h),d("operand",s),_("#setList-variable").getFocus()},save:function(){var e=g("setList"),t=e("variable");if(C.isNone(t))return _("#setList-variable").getFocus();var i=e("operation");switch(i){case"set-empty":I.save({variable:t,operation:i});break;case"set-numbers":var a=e("numbers");if(0===a.length)return _("#setList-numbers").getFocus();I.save({variable:t,operation:i,list:a});break;case"set-strings":a=e("strings");if(0===a.length)return _("#setList-strings").getFocus();I.save({variable:t,operation:i,list:a});break;case"set-boolean":var a=e("index"),n=e("boolean");I.save({variable:t,operation:i,index:a,constant:n});break;case"set-number":a=e("index"),n=e("number");I.save({variable:t,operation:i,index:a,constant:n});break;case"set-string":a=e("index"),n=e("string");I.save({variable:t,operation:i,index:a,constant:n});break;case"set-variable":a=e("index"),n=e("operand");if(C.isNone(n))return _("#setList-operand").getFocus();I.save({variable:t,operation:i,index:a,operand:n});break;case"push":case"remove":a=e("operand");if(C.isNone(a))return _("#setList-operand").getFocus();I.save({variable:t,operation:i,operand:a})}}},I.cases.deleteVariable={initialize:function(){_("#deleteVariable-confirm").on("click",this.save)},parse:function({variable:e}){return[{color:"variable"},{text:N.get("command.deleteVariable")+": "},{text:I.parseVariable(e)}]},load:function({variable:e={type:"local",key:""}}){_("#deleteVariable-variable").write(e),_("#deleteVariable-variable").getFocus()},save:function(){var e=_("#deleteVariable-variable"),t=e.read();if(C.isNone(t))return e.getFocus();I.save({variable:t})}},I.cases.if={elseCommands:null,initialize:function(){_("#if-confirm").on("click",this.save),_("#if-branches").bind(Dt),_("#if-branch-conditions").bind(_t),_("#if").on("closed",e=>{this.elseCommands=null,_("#if-branches").clear()})},parse:function({branches:e,elseCommands:t}){var i=[{color:"flow"}],a=N.get("command.if.alias");for(const n of e)i.push({text:a+" "+Dt.parse(n)},{children:n.commands});return t&&i.push({text:N.get("command.if.else")},{children:t}),i.push({text:N.get("command.if.end")}),i},load:function({branches:e=[],elseCommands:t=null}){var i=D("if");i("branches",e.slice()),i("else",!!t),I.cases.if.elseCommands=t,_("#if-branches").getFocus()},save:function(){var e=g("if"),t=e("branches");if(0===t.length)return _("#if-branches").getFocus();switch(e("else")){case!0:var i=I.cases.if.elseCommands??[];I.save({branches:t,elseCommands:i});break;case!1:I.save({branches:t})}}},I.cases.switch={defaultCommands:null,initialize:function(){_("#switch-confirm").on("click",this.save),_("#switch-branches").bind(Ot),_("#switch-branch-conditions").bind(Yt),_("#switch").on("closed",e=>{this.defaultCommands=null,_("#switch-branches").clear()})},parse:function({variable:e,branches:t,defaultCommands:i}){var a=[{color:"flow"},{text:N.get("command.switch")+" "},{text:I.parseVariable(e)},{break:!0}],n=N.get("command.switch.case");for(const s of t)a.push({text:n+" "+Ot.parse(s)},{children:s.commands});return i&&a.push({text:N.get("command.switch.default")},{children:i}),a.push({text:N.get("command.switch.end")}),a},load:function({variable:e={type:"local",key:""},branches:t=[],defaultCommands:i=null}){var a=D("switch");a("variable",e),a("branches",t.slice()),a("default",!!i),I.cases.switch.defaultCommands=i,_("#switch-variable").getFocus()},save:function(){var e=g("switch"),t=e("variable");if(C.isNone(t))return _("#switch-variable").getFocus();var i=e("branches");if(0===i.length)return _("#switch-branches").getFocus();switch(e("default")){case!0:var a=I.cases.switch.defaultCommands??[];I.save({variable:t,branches:i,defaultCommands:a});break;case!1:I.save({variable:t,branches:i})}}},I.cases.loop={commands:null,initialize:function(){_("#loop-confirm").on("click",this.save),_("#loop-conditions").bind(_t),_("#loop-mode").loadItems([{name:"Meet All",value:"all"},{name:"Meet Any",value:"any"}]),_("#loop").on("closed",e=>{this.commands=null,_("#loop-conditions").clear()})},parse:function({mode:e,conditions:t,commands:i}){let a;return[{color:"flow"},{text:a=0!==t.length?(e=Dt.parse({mode:e,conditions:t}),N.get("command.loop.while")+" "+e):N.get("command.loop")},{children:i},{text:N.get("command.loop.end")}]},load:function({mode:e="all",conditions:t=[],commands:i=[]}){var a=D("loop");a("mode",e),a("conditions",t.slice()),I.cases.loop.commands=i,_("#loop-conditions").getFocus()},save:function(){var e=g("loop"),t=e("mode"),e=e("conditions"),i=I.cases.loop.commands;I.save({mode:t,conditions:e,commands:i})}},I.cases.forEach={commands:null,initialize:function(){_("#forEach-confirm").on("click",this.save),_("#forEach-data").loadItems([{name:"List",value:"list"},{name:"Skill",value:"skill"},{name:"State",value:"state"},{name:"Equipment",value:"equipment"},{name:"Inventory",value:"inventory"},{name:"Element",value:"element"},{name:"Party Member",value:"member"}]),_("#forEach-data").enableHiddenMode().relate([{case:"list",targets:[_("#forEach-list")]},{case:["skill","state","equipment","inventory"],targets:[_("#forEach-actor")]},{case:"element",targets:[_("#forEach-element")]}]),_("#forEach").on("closed",e=>{this.commands=null})},parse:function({data:e,list:t,actor:i,element:a,variable:n,commands:s}){var r=I.parseVariable(n),o=N.get("command.forEach."+e),l=I.words;switch(e){case"list":var c=I.parseVariable(t);l.push(r+` = ${c} -> `+o);break;case"skill":case"state":case"equipment":case"inventory":c=I.parseActor(i);l.push(r+` = ${c} -> `+o);break;case"element":c=I.parseElement(a);l.push(r+` = ${c} -> `+o);break;case"member":l.push(r+" = "+o)}return[{color:"flow"},{text:N.get("command.forEach")+": "},{text:l.join()},{children:s},{text:N.get("command.forEach.end")}]},load:function({data:e="list",list:t={type:"local",key:""},actor:i={type:"trigger"},element:a={type:"trigger"},variable:n={type:"local",key:""},commands:s=[]}){var r=D("forEach");r("data",e),r("list",t),r("actor",i),r("element",a),r("variable",n),I.cases.forEach.commands=s,_("#forEach-data").getFocus()},save:function(){var e=g("forEach"),t=e("data"),i=I.cases.forEach.commands,a=e("variable");if(C.isNone(a))return _("#forEach-variable").getFocus();switch(t){case"list":var n=e("list");if(C.isNone(n))return _("#forEach-list").getFocus();I.save({data:t,list:n,variable:a,commands:i});break;case"skill":case"state":case"equipment":case"inventory":n=e("actor");I.save({data:t,actor:n,variable:a,commands:i});break;case"element":n=e("element");I.save({data:t,element:n,variable:a,commands:i});break;case"member":I.save({data:t,variable:a,commands:i})}}},I.cases.break={parse:function(){return[{color:"flow"},{text:N.get("command.break")}]},save:function(){I.save({})}},I.cases.continue={parse:function(){return[{color:"flow"},{text:N.get("command.continue")}]},save:function(){I.save({})}},I.cases.independent={parse:function({commands:e}){return[{color:"flow"},{text:N.get("command.independent")},{children:e},{text:N.get("command.independent.end")}]},save:function(){I.save({commands:[]})}},I.cases.callEvent={initialize:function(){_("#callEvent-confirm").on("click",this.save),_("#callEvent-type").loadItems([{name:"Global",value:"global"},{name:"Scene",value:"scene"},{name:"Actor",value:"actor"},{name:"Skill",value:"skill"},{name:"State",value:"state"},{name:"Equipment",value:"equipment"},{name:"Item",value:"item"},{name:"Light",value:"light"},{name:"Element",value:"element"}]),_("#callEvent-type").enableHiddenMode().relate([{case:"global",targets:[_("#callEvent-eventId")]},{case:"scene",targets:[_("#callEvent-eventType")]},{case:"actor",targets:[_("#callEvent-actor"),_("#callEvent-eventType")]},{case:"skill",targets:[_("#callEvent-skill"),_("#callEvent-eventType")]},{case:"state",targets:[_("#callEvent-state"),_("#callEvent-eventType")]},{case:"equipment",targets:[_("#callEvent-equipment"),_("#callEvent-eventType")]},{case:"item",targets:[_("#callEvent-item"),_("#callEvent-eventType")]},{case:"light",targets:[_("#callEvent-light"),_("#callEvent-eventType")]},{case:"element",targets:[_("#callEvent-element"),_("#callEvent-eventType")]}]),_("#callEvent-type").on("write",e=>{var e=e.value,t=_("#callEvent-eventType"),e=M.getMergedItems(Nt.types[e],e+"-event");t.loadItems(e),t.write(e[0].value)})},parse:function({type:e,actor:t,skill:i,state:a,equipment:n,item:s,light:r,element:o,eventId:l,eventType:c}){var h=I.words;switch(e){case"global":h.push(I.parseFileName(l));break;case"scene":h.push(N.get("command.callEvent.scene"));break;case"actor":h.push(I.parseActor(t));break;case"skill":h.push(I.parseSkill(i));break;case"state":h.push(I.parseState(a));break;case"equipment":h.push(I.parseEquipment(n));break;case"item":h.push(I.parseItem(s));break;case"light":h.push(I.parseLight(r));break;case"element":h.push(I.parseElement(o))}return c&&h.push(I.parseEventType(e+"-event",c)),[{color:"flow"},{text:N.get("command.callEvent.alias")+": "},{text:h.join()}]},load:function({type:e="global",actor:t={type:"trigger"},skill:i={type:"trigger"},state:a={type:"trigger"},equipment:n={type:"trigger"},item:s={type:"trigger"},light:r={type:"trigger"},element:o={type:"trigger"},eventId:l="",eventType:c=""}){var h=D("callEvent");h("type",e),h("actor",t),h("skill",i),h("state",a),h("equipment",n),h("item",s),h("light",r),h("element",o),h("eventId",l),h("eventType",c),_("#callEvent-type").getFocus()},save:function(){var e=g("callEvent"),t=e("type");switch(t){case"global":var i=e("eventId");if(""===i)return _("#callEvent-eventId").getFocus();I.save({type:t,eventId:i});break;case"scene":i=e("eventType");if(""===i)return _("#callEvent-eventType").getFocus();I.save({type:t,eventType:i});break;default:var i=e(t),a=e("eventType");if(""===a)return _("#callEvent-eventType").getFocus();I.save({type:t,[t]:i,eventType:a})}}},I.cases.stopEvent={parse:function(){return[{color:"flow"},{text:N.get("command.stopEvent")}]},save:function(){I.save({})}},I.cases.setEvent={initialize:function(){_("#setEvent-confirm").on("click",this.save),_("#setEvent-operation").loadItems([{name:"Stop Propagation",value:"stop-propagation"},{name:"Pause and Save to Variable",value:"pause"},{name:"Continue and Reset Variable",value:"continue"},{name:"Enable Global Event",value:"enable"},{name:"Disable Global Event",value:"disable"},{name:"Prevent Scene Input Events",value:"prevent-scene-input-events"},{name:"Restore Scene Input Events",value:"restore-scene-input-events"},{name:"Set to Highest Priority",value:"highest-priority"},{name:"Go to Choice Branch",value:"goto-choice-branch"}]),_("#setEvent-choiceIndex").loadItems([{name:"Choice #1",value:0},{name:"Choice #2",value:1},{name:"Choice #3",value:2},{name:"Choice #4",value:3}]),_("#setEvent-operation").enableHiddenMode().relate([{case:["pause","continue"],targets:[_("#setEvent-variable")]},{case:["enable","disable","highest-priority"],targets:[_("#setEvent-eventId")]},{case:"goto-choice-branch",targets:[_("#setEvent-choiceIndex")]}])},parse:function({operation:e,variable:t,eventId:i,choiceIndex:a}){var n=I.words.push(N.get("command.setEvent."+e));switch(e){case"pause":case"continue":n.push(I.parseVariable(t));break;case"enable":case"disable":case"highest-priority":n.push(I.parseFileName(i));break;case"goto-choice-branch":n.push("#"+(a+1))}return[{color:"flow"},{text:N.get("command.setEvent.alias")+": "},{text:n.join()}]},load:function({operation:e="stop-propagation",variable:t={type:"global",key:""},eventId:i="",choiceIndex:a=0}){var n=D("setEvent");n("operation",e),n("variable",t),n("eventId",i),n("choiceIndex",a),_("#setEvent-operation").getFocus()},save:function(){var e=g("setEvent"),t=e("operation");switch(t){case"stop-propagation":case"prevent-scene-input-events":case"restore-scene-input-events":I.save({operation:t});break;case"pause":case"continue":var i=e("variable");if(C.isNone(i))return _("#setEvent-variable").getFocus();I.save({operation:t,variable:i});break;case"enable":case"disable":case"highest-priority":i=e("eventId");if(""===i)return _("#setEvent-eventId").getFocus();I.save({operation:t,eventId:i});break;case"goto-choice-branch":i=e("choiceIndex");I.save({operation:t,choiceIndex:i})}}},I.cases.label={initialize:function(){_("#label-confirm").on("click",this.save)},parse:function({name:e}){return[{color:"flow"},{text:N.get("command.label")+": "},{text:e}]},load:function({name:e=""}){_("#label-name").write(e),_("#label-name").getFocus("all")},save:function(){var e=_("#label-name").read().trim();if(""===e)return _("#label-name").getFocus();I.save({name:e})}},I.cases.jumpTo={initialize:function(){_("#jumpTo-confirm").on("click",this.save),_("#jumpTo-operation").loadItems([{name:"Jump to Label",value:"jump"},{name:"Save and Jump to Label",value:"save-jump"},{name:"Jump to the Saved Location",value:"return"}]),_("#jumpTo-operation").enableHiddenMode().relate([{case:["jump","save-jump"],targets:[_("#jumpTo-label")]}])},parse:function({operation:e,label:t}){var i=I.words;switch(e){case"jump":i.push(t);break;case"save-jump":i.push(t).push(N.get("command.jumpTo.save"));break;case"return":i.push(N.get("command.jumpTo.savedLocation"))}return[{color:"flow"},{text:N.get("command.jumpTo.alias")+": "},{text:i.join()}]},load:function({operation:e="jump",label:t=""}){_("#jumpTo-operation").write(e),_("#jumpTo-label").write(t),_("#jumpTo-operation").getFocus()},save:function(){var e=_("#jumpTo-operation").read();switch(e){case"jump":case"save-jump":var t=_("#jumpTo-label").read().trim();if(""===t)return _("#jumpTo-label").getFocus();I.save({operation:e,label:t});break;case"return":I.save({operation:e})}}},I.cases.wait={initialize:function(){_("#wait-confirm").on("click",this.save)},parse:function({duration:e}){return[{color:"wait"},{text:N.get("command.wait")+": "},{text:I.parseVariableNumber(e,"ms")}]},load:function({duration:e=1}){_("#wait-duration").write(e),_("#wait-duration").getFocus("all")},save:function(){var e=_("#wait-duration").read();I.save({duration:e})}},I.cases.createElement={initialize:function(){_("#createElement-confirm").on("click",this.save),_("#createElement-operation").loadItems([{name:"Append All to Root",value:"append-all-to-root"},{name:"Append One to Root",value:"append-one-to-root"},{name:"Append All to Element",value:"append-all-to-element"},{name:"Append One to Element",value:"append-one-to-element"}]),_("#createElement-operation").enableHiddenMode().relate([{case:"append-all-to-root",targets:[_("#createElement-uiId")]},{case:"append-one-to-root",targets:[_("#createElement-presetId")]},{case:"append-all-to-element",targets:[_("#createElement-parent"),_("#createElement-uiId")]},{case:"append-one-to-element",targets:[_("#createElement-parent"),_("#createElement-presetId")]}])},parseUIAndNodeNames:function(e){var t=I.parseFileName(e),e=He.ui[e];if(void 0===e)return t;var i,a=I.words,e=e.nodes;for({name:i}of e)if(""!==i&&a.push(i),5===a.count)break;return a.count<e.length&&a.push("..."),`${t} {${a.join()}}`},parse:function({operation:e,parent:t,uiId:i,presetId:a}){let n;switch(e){case"append-all-to-root":n=this.parseUIAndNodeNames(i);break;case"append-one-to-root":n=I.parsePresetElement(a);break;case"append-all-to-element":n=I.parseElement(t)+" -> "+this.parseUIAndNodeNames(i);break;case"append-one-to-element":n=I.parseElement(t)+" -> "+I.parsePresetElement(a)}return[{color:"element"},{text:N.get("command.createElement")+": "},{text:n}]},load:function({operation:e="append-all-to-root",parent:t={type:"trigger"},uiId:i="",presetId:a=yt.getDefaultPresetId()}){var n=D("createElement");n("operation",e),n("parent",t),n("uiId",i),n("presetId",a),_("#createElement-operation").getFocus("all")},save:function(){var e=g("createElement"),t=e("operation");switch(t){case"append-all-to-root":var i=e("uiId");if(""===i)return _("#createElement-uiId").getFocus();I.save({operation:t,uiId:i});break;case"append-one-to-root":i=e("presetId");if(""===i)return _("#createElement-presetId").getFocus();I.save({operation:t,presetId:i});break;case"append-all-to-element":var i=e("parent"),a=e("uiId");if(""===a)return _("#createElement-uiId").getFocus();I.save({operation:t,parent:i,uiId:a});break;case"append-one-to-element":i=e("parent"),a=e("presetId");if(""===a)return _("#createElement-presetId").getFocus();I.save({operation:t,parent:i,presetId:a})}}},I.cases.setImage={initialize:function(){_("#setImage-confirm").on("click",this.save),_("#setImage-properties").bind(jt),_("#setImage").on("closed",e=>{_("#setImage-properties").clear()})},parse:function({element:e,properties:t}){var i=I.words.push(I.parseElement(e));for(const a of t)i.push(jt.parse(a));return[{color:"element"},{text:N.get("command.setImage")+": "},{text:i.join()}]},load:function({element:e={type:"trigger"},properties:t=[]}){var i=D("setImage");i("element",e),i("properties",t.slice()),_("#setImage-element").getFocus()},save:function(){var e=g("setImage"),t=e("element"),e=e("properties");if(0===e.length)return _("#setImage-properties").getFocus();I.save({element:t,properties:e})}},I.cases.loadImage={initialize:function(){_("#loadImage-confirm").on("click",this.save),_("#loadImage-type").loadItems([{name:"Actor Portrait",value:"actor-portrait"},{name:"Skill Icon",value:"skill-icon"},{name:"State Icon",value:"state-icon"},{name:"Equipment Icon",value:"equipment-icon"},{name:"Item Icon",value:"item-icon"}]),_("#loadImage-type").enableHiddenMode().relate([{case:"actor-portrait",targets:[_("#loadImage-actor")]},{case:"skill-icon",targets:[_("#loadImage-skill")]},{case:"state-icon",targets:[_("#loadImage-state")]},{case:"equipment-icon",targets:[_("#loadImage-equipment")]},{case:"item-icon",targets:[_("#loadImage-item")]}])},parse:function({element:e,type:t,actor:i,skill:a,state:n,equipment:s,item:r}){var e=I.words.push(I.parseElement(e)),o=N.get("command.loadImage."+t);let l;switch(t){case"actor-portrait":l=I.parseActor(i);break;case"skill-icon":l=I.parseSkill(a);break;case"state-icon":l=I.parseState(n);break;case"equipment-icon":l=I.parseEquipment(s);break;case"item-icon":l=I.parseItem(r)}return e.push(`${o}(${l})`),[{color:"element"},{text:N.get("command.loadImage")+": "},{text:e.join()}]},load:function({element:e={type:"trigger"},type:t="actor-portrait",actor:i={type:"trigger"},skill:a={type:"trigger"},state:n={type:"trigger"},equipment:s={type:"trigger"},item:r={type:"trigger"}}){var o=D("loadImage");o("element",e),o("type",t),o("actor",i),o("skill",a),o("state",n),o("equipment",s),o("item",r),_("#loadImage-element").getFocus()},save:function(){var e=g("loadImage"),t=e("element"),i=e("type");switch(i){case"actor-portrait":var a=e("actor");I.save({element:t,type:i,actor:a});break;case"skill-icon":a=e("skill");I.save({element:t,type:i,skill:a});break;case"state-icon":a=e("state");I.save({element:t,type:i,state:a});break;case"equipment-icon":a=e("equipment");I.save({element:t,type:i,equipment:a});break;case"item-icon":a=e("item");I.save({element:t,type:i,item:a})}}},I.cases.tintImage={initialize:function(){_("#tintImage-confirm").on("click",this.save),_("#tintImage-mode").loadItems([{name:"Full",value:"full"},{name:"RGB",value:"rgb"},{name:"Gray",value:"gray"}]),_("#tintImage-mode").enableHiddenMode().relate([{case:"full",targets:[_("#tintImage-tint-0"),_("#tintImage-tint-1"),_("#tintImage-tint-2"),_("#tintImage-tint-3")]},{case:"rgb",targets:[_("#tintImage-tint-0"),_("#tintImage-tint-1"),_("#tintImage-tint-2")]},{case:"gray",targets:[_("#tintImage-tint-3")]}]),_("#tintImage-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#tintImage").on("open",function(e){_("#tintImage-easingId").loadItems(He.createEasingItems())}),_("#tintImage").on("closed",function(e){_("#tintImage-easingId").clear(),_("#tintImage-filter").clear()}),_("#tintImage-mode, #tintImage-tint-0, #tintImage-tint-1, #tintImage-tint-2, #tintImage-tint-3").on("input",function(e){var t=[0,0,0,0],i=g("tintImage");switch(i("mode")){case"full":t[0]=i("tint-0"),t[1]=i("tint-1"),t[2]=i("tint-2"),t[3]=i("tint-3");break;case"rgb":t[0]=i("tint-0"),t[1]=i("tint-1"),t[2]=i("tint-2");break;case"gray":t[3]=i("tint-3")}_("#tintImage-filter").write(t)})},parseTint:function(e,[t,i,a,n]){var s=N.get("command.tintImage.tint");switch(e){case"full":return s+`(${t}, ${i}, ${a}, ${n})`;case"rgb":return s+`(${t}, ${i}, ${a})`;case"gray":return s+`(${n})`}},parse:function({element:e,mode:t,tint:i,easingId:a,duration:n,wait:s}){e=I.words.push(I.parseElement(e)).push(this.parseTint(t,i)).push(I.parseEasing(a,n,s));return[{color:"element"},{text:N.get("command.tintImage")+": "},{text:e.join()}]},load:function({element:e={type:"trigger"},mode:t="full",tint:i=[0,0,0,0],easingId:a=He.easings[0].id,duration:n=0,wait:s=!1}){var r=D("tintImage");r("element",e),r("mode",t),r("tint-0",i[0]),r("tint-1",i[1]),r("tint-2",i[2]),r("tint-3",i[3]),r("filter",i),r("easingId",a),r("duration",n),r("wait",s),_("#tintImage-element").getFocus()},save:function(){var e=g("tintImage"),t=e("element"),i=e("mode");let a=e("tint-0"),n=e("tint-1"),s=e("tint-2"),r=e("tint-3");switch(i){case"full":break;case"rgb":r=0;break;case"gray":a=0,n=0,s=0}var o=e("easingId"),l=e("duration"),e=e("wait"),c=[a,n,s,r];I.save({element:t,mode:i,tint:c,easingId:o,duration:l,wait:e})}},I.cases.setText={initialize:function(){_("#setText-confirm").on("click",this.save),_("#setText-properties").bind(Xt),_("#setText").on("closed",e=>{_("#setText-properties").clear()})},parse:function({element:e,properties:t}){var i=I.words.push(I.parseElement(e));for(const a of t)i.push(Xt.parse(a));return[{color:"element"},{text:N.get("command.setText")+": "},{text:i.join()}]},load:function({element:e={type:"trigger"},properties:t=[]}){var i=D("setText");i("element",e),i("properties",t.slice()),_("#setText-element").getFocus()},save:function(){var e=g("setText"),t=e("element"),e=e("properties");if(0===e.length)return _("#setText-properties").getFocus();I.save({element:t,properties:e})}},I.cases.setTextBox={initialize:function(){_("#setTextBox-confirm").on("click",this.save),_("#setTextBox-properties").bind(Gt),_("#setTextBox").on("closed",e=>{_("#setTextBox-properties").clear()})},parse:function({element:e,properties:t}){var i=I.words.push(I.parseElement(e));for(const a of t)i.push(Gt.parse(a));return[{color:"element"},{text:N.get("command.setTextBox")+": "},{text:i.join()}]},load:function({element:e={type:"trigger"},properties:t=[]}){var i=D("setTextBox");i("element",e),i("properties",t.slice()),_("#setTextBox-element").getFocus()},save:function(){var e=g("setTextBox"),t=e("element"),e=e("properties");if(0===e.length)return _("#setTextBox-properties").getFocus();I.save({element:t,properties:e})}},I.cases.setDialogBox={initialize:function(){_("#setDialogBox-confirm").on("click",this.save),_("#setDialogBox-properties").bind(Vt),_("#setDialogBox").on("closed",e=>{_("#setDialogBox-properties").clear()})},parse:function({element:e,properties:t}){var i=I.words.push(I.parseElement(e));for(const a of t)i.push(Vt.parse(a));return[{color:"element"},{text:N.get("command.setDialogBox")+": "},{text:i.join()}]},load:function({element:e={type:"trigger"},properties:t=[]}){var i=D("setDialogBox");i("element",e),i("properties",t.slice()),_("#setDialogBox-element").getFocus()},save:function(){var e=g("setDialogBox"),t=e("element"),e=e("properties");if(0===e.length)return _("#setDialogBox-properties").getFocus();I.save({element:t,properties:e})}},I.cases.controlDialog={initialize:function(){_("#controlDialog-confirm").on("click",this.save),_("#controlDialog-operation").loadItems([{name:"Pause Printing",value:"pause"},{name:"Continue Printing",value:"continue"},{name:"Print Immediately",value:"print-immediately"},{name:"Print Next Page",value:"print-next-page"}])},parse:function({element:e,operation:t}){e=I.words.push(I.parseElement(e)).push(N.get("command.controlDialog."+t));return[{color:"element"},{text:N.get("command.controlDialog")+": "},{text:e.join()}]},load:function({element:e={type:"trigger"},operation:t="pause"}){var i=D("controlDialog");i("element",e),i("operation",t),_("#controlDialog-element").getFocus()},save:function(){var e=g("controlDialog"),t=e("element"),e=e("operation");I.save({element:t,operation:e})}},I.cases.setProgressBar={initialize:function(){_("#setProgressBar-confirm").on("click",this.save),_("#setProgressBar-properties").bind(Wt),_("#setProgressBar").on("closed",e=>{_("#setProgressBar-properties").clear()})},parse:function({element:e,properties:t}){var i=I.words.push(I.parseElement(e));for(const a of t)i.push(Wt.parse(a));return[{color:"element"},{text:N.get("command.setProgressBar")+": "},{text:i.join()}]},load:function({element:e={type:"trigger"},properties:t=[]}){var i=D("setProgressBar");i("element",e),i("properties",t.slice()),_("#setProgressBar-element").getFocus()},save:function(){var e=g("setProgressBar"),t=e("element"),e=e("properties");if(0===e.length)return _("#setProgressBar-properties").getFocus();I.save({element:t,properties:e})}},I.cases.waitForVideo={initialize:function(){_("#waitForVideo-confirm").on("click",this.save)},parse:function({element:e}){return[{color:"element"},{text:N.get("command.waitForVideo")+": "},{text:I.parseElement(e)}]},load:function({element:e={type:"trigger"}}){_("#waitForVideo-element").write(e),_("#waitForVideo-element").getFocus()},save:function(){var e=_("#waitForVideo-element").read();I.save({element:e})}},I.cases.setElement={initialize:function(){_("#setElement-confirm").on("click",this.save),_("#setElement-operation").loadItems([{name:"Hide",value:"hide"},{name:"Show",value:"show"},{name:"Disable Pointer Events",value:"disable-pointer-events"},{name:"Enable Pointer Events",value:"enable-pointer-events"},{name:"Skip Pointer Events",value:"skip-pointer-events"},{name:"Move to First",value:"move-to-first"},{name:"Move to Last",value:"move-to-last"}])},parse:function({element:e,operation:t}){e=I.words.push(I.parseElement(e)).push(N.get("command.setElement."+t));return[{color:"element"},{text:N.get("command.setElement.alias")+": "},{text:e.join()}]},load:function({element:e={type:"trigger"},operation:t="hide"}){var i=D("setElement");i("element",e),i("operation",t),_("#setElement-element").getFocus()},save:function(){var e=g("setElement"),t=e("element"),e=e("operation");I.save({element:t,operation:e})}},I.cases.nestElement={initialize:function(){_("#nestElement-confirm").on("click",this.save)},parse:function({parent:e,child:t}){e=I.parseElement(e),t=I.parseElement(t);return[{color:"element"},{text:N.get("command.nestElement")+": "},{text:e+" -> "+t}]},load:function({parent:e={type:"trigger"},child:t={type:"latest"}}){_("#nestElement-parent").write(e),_("#nestElement-child").write(t),_("#nestElement-parent").getFocus()},save:function(){var e=_("#nestElement-parent").read(),t=_("#nestElement-child").read();I.save({parent:e,child:t})}},I.cases.moveElement={initialize:function(){_("#moveElement-confirm").on("click",this.save),_("#moveElement-properties").bind(Ht),_("#moveElement-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#moveElement").on("open",function(e){_("#moveElement-easingId").loadItems(He.createEasingItems())}),_("#moveElement").on("closed",function(e){_("#moveElement-properties").clear(),_("#moveElement-easingId").clear()})},parse:function({element:e,properties:t,easingId:i,duration:a,wait:n}){var s=I.words.push(I.parseElement(e));for(const r of t)s.push(Ht.parse(r));return s.push(I.parseEasing(i,a,n)),[{color:"element"},{text:N.get("command.moveElement")+": "},{text:s.join()}]},load:function({element:e={type:"trigger"},properties:t=[],easingId:i=He.easings[0].id,duration:a=0,wait:n=!1}){var s=D("moveElement");s("element",e),s("properties",t.slice()),s("easingId",i),s("duration",a),s("wait",n),_("#moveElement-element").getFocus()},save:function(){var e=g("moveElement"),t=e("element"),i=e("properties");if(0===i.length)return _("#moveElement-properties").getFocus();var a=e("easingId"),n=e("duration"),e=e("wait");I.save({element:t,properties:i,easingId:a,duration:n,wait:e})}},I.cases.deleteElement={initialize:function(){_("#deleteElement-confirm").on("click",this.save),_("#deleteElement-operation").loadItems([{name:"Delete Element",value:"delete-element"},{name:"Delete Children",value:"delete-children"},{name:"Delete All",value:"delete-all"}]),_("#deleteElement-operation").enableHiddenMode().relate([{case:["delete-element","delete-children"],targets:[_("#deleteElement-element")]}])},parse:function({operation:e,element:t}){let i;switch(e){case"delete-element":i=I.parseElement(t);break;case"delete-children":i=I.parseElement(t)+" -> "+N.get("command.deleteElement.children");break;case"delete-all":i=N.get("command.deleteElement.all-elements")}return[{color:"element"},{text:N.get("command.deleteElement")+": "},{text:i}]},load:function({operation:e="delete-element",element:t={type:"trigger"}}){_("#deleteElement-operation").write(e),_("#deleteElement-element").write(t),_("#deleteElement-operation").getFocus()},save:function(){var e=_("#deleteElement-operation").read();switch(e){case"delete-element":case"delete-children":var t=_("#deleteElement-element").read();I.save({operation:e,element:t});break;case"delete-all":I.save({operation:e})}}},I.cases.createLight={initialize:function(){_("#createLight-confirm").on("click",this.save)},parse:function({presetId:e,position:t}){e=I.words.push(I.parsePresetObject(e)).push(I.parsePosition(t));return[{color:"object"},{text:N.get("command.createLight")+": "},{text:e.join()}]},load:function({presetId:e="",position:t={type:"actor",actor:{type:"trigger"}}}){var i=D("createLight");i("presetId",e),i("position",t),_("#createLight-presetId").getFocus()},save:function(){var e=g("createLight"),t=e("presetId");if(""===t)return _("#createLight-presetId").getFocus();e=e("position");I.save({presetId:t,position:e})}},I.cases.moveLight={initialize:function(){_("#moveLight-confirm").on("click",this.save),_("#moveLight-properties").bind(Kt),_("#moveLight-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#moveLight").on("open",function(e){_("#moveLight-easingId").loadItems(He.createEasingItems())}),_("#moveLight").on("closed",function(e){_("#moveLight-properties").clear(),_("#moveLight-easingId").clear()})},parse:function({light:e,properties:t,easingId:i,duration:a,wait:n}){var s=I.words.push(I.parseLight(e));for(const r of t)s.push(Kt.parse(r));return s.push(I.parseEasing(i,a,n)),[{color:"object"},{text:N.get("command.moveLight")+": "},{text:s.join()}]},load:function({light:e={type:"trigger"},properties:t=[],easingId:i=He.easings[0].id,duration:a=0,wait:n=!1}){var s=D("moveLight");s("light",e),s("properties",t.slice()),s("easingId",i),s("duration",a),s("wait",n),_("#moveLight-light").getFocus()},save:function(){var e=g("moveLight"),t=e("light"),i=e("properties");if(0===i.length)return _("#moveLight-properties").getFocus();var a=e("easingId"),n=e("duration"),e=e("wait");I.save({light:t,properties:i,easingId:a,duration:n,wait:e})}},I.cases.deleteLight={initialize:function(){_("#deleteLight-confirm").on("click",this.save)},parse:function({light:e}){return[{color:"object"},{text:N.get("command.deleteLight")+": "},{text:I.parseLight(e)}]},load:function({light:e={type:"trigger"}}){_("#deleteLight-light").write(e),_("#deleteLight-light").getFocus()},save:function(){var e=_("#deleteLight-light").read();I.save({light:e})}},I.cases.setState={initialize:function(){_("#setState-confirm").on("click",this.save),_("#setState-operation").loadItems([{name:"Set Time",value:"set-time"},{name:"Increase Time",value:"increase-time"},{name:"Decrease Time",value:"decrease-time"}])},parseOperation:function(e){return N.get("command.setState."+e)},parse:function({state:e,operation:t,time:i}){e=I.words.push(I.parseState(e)).push(this.parseOperation(t)).push(I.parseVariableNumber(i,"ms"));return[{color:"object"},{text:N.get("command.setState")+": "},{text:e.join()}]},load:function({state:e={type:"trigger"},operation:t="set-time",time:i=0}){var a=D("setState");a("state",e),a("operation",t),a("time",i),_("#setState-state").getFocus()},save:function(){var e=g("setState"),t=e("state"),i=e("operation"),e=e("time");I.save({state:t,operation:i,time:e})}},I.cases.playAnimation={initialize:function(){_("#playAnimation-confirm").on("click",this.save),_("#playAnimation-mode").loadItems([{name:"Position",value:"position"},{name:"Actor",value:"actor"}]),_("#playAnimation-mode").enableHiddenMode().relate([{case:"position",targets:[_("#playAnimation-position")]},{case:"actor",targets:[_("#playAnimation-actor")]}]),_("#playAnimation-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#playAnimation-animationId").on("write",e=>{var t=_("#playAnimation-motion");t.loadItems(Ke.getMotionListItems(e.value)),t.write2(t.read())})},parsePriority:function(e){return 0===e?"":0<e?"+"+e:e.toString()},parse:function({mode:e,position:t,actor:i,animationId:a,motion:n,priority:s,offsetY:r,rotation:o,wait:l}){var c=I.words;switch(e){case"position":c.push(I.parsePosition(t));break;case"actor":var h=N.get("command.playAnimation.bind");c.push(`${h}(${I.parseActor(i)})`)}return c.push(I.parseFileName(a)).push(I.parseEnumString(n)).push(this.parsePriority(s)).push(r+"px").push(I.parseDegrees(I.parseVariableNumber(o))).push(I.parseWait(l)),[{color:"object"},{text:N.get("command.playAnimation")+": "},{text:c.join()}]},load:function({mode:e="position",position:t={type:"actor",actor:{type:"trigger"}},actor:i={type:"trigger"},animationId:a="",motion:n="",priority:s=0,offsetY:r=0,rotation:o=0,wait:l=!1}){var c=D("playAnimation");c("mode",e),c("position",t),c("actor",i),c("animationId",a),c("motion",n),c("priority",s),c("offsetY",r),c("rotation",o),c("wait",l),_("#playAnimation-mode").getFocus()},save:function(){var e=g("playAnimation"),t=e("mode"),i=e("animationId"),a=e("motion"),n=e("priority"),s=e("offsetY"),r=e("rotation"),o=e("wait");if(""===i)return _("#playAnimation-animationId").getFocus();if(""===a)return _("#playAnimation-motion").getFocus();switch(t){case"position":var l=e("position");I.save({mode:t,position:l,animationId:i,motion:a,priority:n,offsetY:s,rotation:r,wait:o});break;case"actor":l=e("actor");I.save({mode:t,actor:l,animationId:i,motion:a,priority:n,offsetY:s,rotation:r,wait:o})}}},I.cases.playAudio={initialize:function(){_("#playAudio-confirm").on("click",this.save),_("#playAudio-type").loadItems([{name:"BGM",value:"bgm"},{name:"BGS",value:"bgs"},{name:"CV",value:"cv"},{name:"SE",value:"se"}])},parse:function({type:e,audio:t,volume:i}){e=I.words.push(I.parseAudioType(e)).push(I.parseFileName(t)).push(i);return[{color:"audio"},{text:N.get("command.playAudio")+": "},{text:e.join()}]},load:function({type:e="bgm",audio:t="",volume:i=1}){var a=D("playAudio");a("type",e),a("audio",t),a("volume",i),_("#playAudio-type").getFocus()},save:function(){var e=g("playAudio"),t=e("type"),i=e("audio"),e=e("volume");I.save({type:t,audio:i,volume:e})}},I.cases.stopAudio={initialize:function(){_("#stopAudio-confirm").on("click",this.save),_("#stopAudio-type").loadItems([{name:"BGM",value:"bgm"},{name:"BGS",value:"bgs"},{name:"CV",value:"cv"},{name:"SE",value:"se"},{name:"ALL",value:"all"}])},parse:function({type:e}){e=I.words.push(I.parseAudioType(e));return[{color:"audio"},{text:N.get("command.stopAudio")+": "},{text:e.join()}]},load:function({type:e="bgm"}){D("stopAudio")("type",e),_("#stopAudio-type").getFocus()},save:function(){var e=g("stopAudio")("type");I.save({type:e})}},I.cases.setVolume={initialize:function(){_("#setVolume-confirm").on("click",this.save),_("#setVolume-type").loadItems([{name:"BGM",value:"bgm"},{name:"BGS",value:"bgs"},{name:"CV",value:"cv"},{name:"SE",value:"se"}]),_("#setVolume-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#setVolume").on("open",function(e){_("#setVolume-easingId").loadItems(He.createEasingItems())}),_("#setVolume").on("closed",function(e){_("#setVolume-easingId").clear()})},parse:function({type:e,volume:t,easingId:i,duration:a,wait:n}){e=I.words.push(I.parseAudioType(e)).push(I.parseVariableNumber(t)).push(I.parseEasing(i,a,n));return[{color:"audio"},{text:N.get("command.setVolume")+": "},{text:e.join()}]},load:function({type:e="bgm",volume:t=1,easingId:i=He.easings[0].id,duration:a=0,wait:n=!1}){var s=D("setVolume");s("type",e),s("volume",t),s("easingId",i),s("duration",a),s("wait",n),_("#setVolume-type").getFocus()},save:function(){var e=g("setVolume"),t=e("type"),i=e("volume"),a=e("easingId"),n=e("duration"),e=e("wait");I.save({type:t,volume:i,easingId:a,duration:n,wait:e})}},I.cases.setPan={initialize:function(){_("#setPan-confirm").on("click",this.save),_("#setPan-type").loadItems([{name:"BGM",value:"bgm"},{name:"BGS",value:"bgs"},{name:"CV",value:"cv"},{name:"SE",value:"se"}]),_("#setPan-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#setPan").on("open",function(e){_("#setPan-easingId").loadItems(He.createEasingItems())}),_("#setPan").on("closed",function(e){_("#setPan-easingId").clear()})},parse:function({type:e,pan:t,easingId:i,duration:a,wait:n}){e=I.words.push(I.parseAudioType(e)).push(I.parseVariableNumber(t)).push(I.parseEasing(i,a,n));return[{color:"audio"},{text:N.get("command.setPan")+": "},{text:e.join()}]},load:function({type:e="bgm",pan:t=0,easingId:i=He.easings[0].id,duration:a=0,wait:n=!1}){var s=D("setPan");s("type",e),s("pan",t),s("easingId",i),s("duration",a),s("wait",n),_("#setPan-type").getFocus()},save:function(){var e=g("setPan"),t=e("type"),i=e("pan"),a=e("easingId"),n=e("duration"),e=e("wait");I.save({type:t,pan:i,easingId:a,duration:n,wait:e})}},I.cases.setReverb={initialize:function(){_("#setReverb-confirm").on("click",this.save),_("#setReverb-type").loadItems([{name:"BGM",value:"bgm"},{name:"BGS",value:"bgs"},{name:"CV",value:"cv"},{name:"SE",value:"se"}]),_("#setReverb-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#setReverb").on("open",function(e){_("#setReverb-easingId").loadItems(He.createEasingItems())}),_("#setReverb").on("closed",function(e){_("#setReverb-easingId").clear()})},parse:function({type:e,dry:t,wet:i,easingId:a,duration:n,wait:s}){e=I.words.push(I.parseAudioType(e)).push(I.parseVariableNumber(t)).push(I.parseVariableNumber(i)).push(I.parseEasing(a,n,s));return[{color:"audio"},{text:N.get("command.setReverb")+": "},{text:e.join()}]},load:function({type:e="bgm",dry:t=1,wet:i=0,easingId:a=He.easings[0].id,duration:n=0,wait:s=!1}){var r=D("setReverb");r("type",e),r("dry",t),r("wet",i),r("easingId",a),r("duration",n),r("wait",s),_("#setReverb-type").getFocus()},save:function(){var e=g("setReverb"),t=e("type"),i=e("dry"),a=e("wet"),n=e("easingId"),s=e("duration"),e=e("wait");I.save({type:t,dry:i,wet:a,easingId:n,duration:s,wait:e})}},I.cases.setLoop={initialize:function(){_("#setLoop-confirm").on("click",this.save),_("#setLoop-type").loadItems([{name:"BGM",value:"bgm"},{name:"BGS",value:"bgs"},{name:"CV",value:"cv"}]),_("#setLoop-loop").loadItems([{name:"Once",value:!1},{name:"Loop",value:!0}])},parseLoop:function(e){switch(e){case!1:return N.get("command.setLoop.once");case!0:return N.get("command.setLoop.loop")}},parse:function({type:e,loop:t}){e=I.words.push(I.parseAudioType(e)).push(this.parseLoop(t));return[{color:"audio"},{text:N.get("command.setLoop")+": "},{text:e.join()}]},load:function({type:e="bgm",loop:t=!1}){var i=D("setLoop");i("type",e),i("loop",t),_("#setLoop-type").getFocus()},save:function(){var e=g("setLoop"),t=e("type"),e=e("loop");I.save({type:t,loop:e})}},I.cases.saveAudio={initialize:function(){_("#saveAudio-confirm").on("click",this.save),_("#saveAudio-type").loadItems([{name:"BGM",value:"bgm"},{name:"BGS",value:"bgs"},{name:"CV",value:"cv"}])},parse:function({type:e}){return[{color:"audio"},{text:N.get("command.saveAudio")+": "},{text:I.parseAudioType(e)}]},load:function({type:e="bgm"}){D("saveAudio")("type",e),_("#saveAudio-type").getFocus()},save:function(){var e=g("saveAudio")("type");I.save({type:e})}},I.cases.restoreAudio={initialize:function(){_("#restoreAudio-confirm").on("click",this.save),_("#restoreAudio-type").loadItems([{name:"BGM",value:"bgm"},{name:"BGS",value:"bgs"},{name:"CV",value:"cv"}])},parse:function({type:e}){return[{color:"audio"},{text:N.get("command.restoreAudio")+": "},{text:I.parseAudioType(e)}]},load:function({type:e="bgm"}){D("restoreAudio")("type",e),_("#restoreAudio-type").getFocus()},save:function(){var e=g("restoreAudio")("type");I.save({type:e})}},I.cases.createActor={initialize:function(){_("#createActor-confirm").on("click",this.save),_("#createActor").on("open",function(e){_("#createActor-teamId").loadItems(He.createTeamItems())}),_("#createActor").on("closed",function(e){_("#createActor-teamId").clear()})},parse:function({actorId:e,teamId:t,position:i,angle:a}){e=I.words.push(I.parseFileName(e)).push(I.parseTeam(t)).push(I.parsePosition(i)).push(I.parseDegrees(I.parseVariableNumber(a)));return[{color:"actor"},{text:N.get("command.createActor")+": "},{text:e.join()}]},load:function({actorId:e="",teamId:t=He.teams.list[0].id,position:i={type:"absolute",x:0,y:0},angle:a=0}){var n=D("createActor");n("actorId",e),n("teamId",t),n("position",i),n("angle",a),_("#createActor-actorId").getFocus("all")},save:function(){var e=g("createActor"),t=e("actorId"),i=e("teamId"),a=e("position"),e=e("angle");if(""===t)return _("#createActor-actorId").getFocus();I.save({actorId:t,teamId:i,position:a,angle:e})}},I.cases.moveActor={initialize:function(){_("#moveActor-confirm").on("click",this.save),_("#moveActor-mode").loadItems([{name:"Stop",value:"stop"},{name:"Keep",value:"keep"},{name:"Straight",value:"straight"},{name:"Navigate",value:"navigate"},{name:"Teleport",value:"teleport"}]),_("#moveActor-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#moveActor-mode").enableHiddenMode().relate([{case:"keep",targets:[_("#moveActor-angle")]},{case:["straight","navigate"],targets:[_("#moveActor-destination"),_("#moveActor-wait")]},{case:"teleport",targets:[_("#moveActor-destination")]}])},parseMode:function(e){return N.get("command.moveActor.mode."+e)},parse:function({actor:e,mode:t,angle:i,destination:a,wait:n}){var s=I.words.push(I.parseActor(e)).push(this.parseMode(t));switch(t){case"stop":break;case"keep":s.push(I.parseDegrees(I.parseVariableNumber(i)));break;case"straight":case"navigate":s.push(I.parsePosition(a)),s.push(I.parseWait(n));break;case"teleport":s.push(I.parsePosition(a))}return[{color:"actor"},{text:N.get("command.moveActor")+": "},{text:s.join()}]},load:function({actor:e={type:"trigger"},mode:t="straight",angle:i=0,destination:a={type:"absolute",x:0,y:0},wait:n=!1}){var s=D("moveActor");s("actor",e),s("mode",t),s("angle",i),s("destination",a),s("wait",n),_("#moveActor-actor").getFocus()},save:function(){var e=g("moveActor"),t=e("actor"),i=e("mode");switch(i){case"stop":I.save({actor:t,mode:i});break;case"keep":var a=e("angle");I.save({actor:t,mode:i,angle:a});break;case"straight":case"navigate":var a=e("destination"),n=e("wait");I.save({actor:t,mode:i,destination:a,wait:n});break;case"teleport":a=e("destination");I.save({actor:t,mode:i,destination:a})}}},I.cases.followActor={initialize:function(){_("#followActor-confirm").on("click",this.save),_("#followActor-mode").loadItems([{name:"Circle",value:"circle"},{name:"Rectangle",value:"rectangle"}]),_("#followActor-mode").enableHiddenMode().relate([{case:"circle",targets:[_("#followActor-offset")]},{case:"rectangle",targets:[_("#followActor-vertDist")]}]),_("#followActor-navigate").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#followActor-once").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#followActor-once").enableHiddenMode().relate([{case:!0,targets:[_("#followActor-wait")]}]),_("#followActor-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}])},parseActors:function(e,t){return I.parseActor(e)+" -> "+I.parseActor(t)},parse:function({actor:e,target:t,mode:i,minDist:a,maxDist:n,offset:s,vertDist:r,navigate:o,once:l,wait:c}){var h=I.words.push(this.parseActors(e,t)).push(N.get("command.followActor.mode."+i)).push(a+" ~ "+n);switch(i){case"circle":h.push(s.toString());break;case"rectangle":h.push(r.toString())}return o&&h.push(N.get("command.followActor.navigate")),l&&(h.push(N.get("command.followActor.once")),h.push(I.parseWait(c))),[{color:"actor"},{text:N.get("command.followActor")+": "},{text:h.join()}]},load:function({actor:e={type:"trigger"},target:t={type:"trigger"},mode:i="circle",minDist:a=1,maxDist:n=2,offset:s=0,vertDist:r=0,navigate:o=!1,once:l=!1,wait:c=!1}){var h=D("followActor");h("actor",e),h("target",t),h("mode",i),h("minDist",a),h("maxDist",n),h("offset",s),h("vertDist",r),h("navigate",o),h("once",l),h("wait",c),_("#followActor-actor").getFocus()},save:function(){var e=g("followActor"),t=e("actor"),i=e("target"),a=e("mode"),n=e("minDist"),s=Math.max(e("maxDist"),Math.roundTo(n+.1,4)),r=e("navigate"),o=e("once"),l=!!o&&e("wait");switch(a){case"circle":var c=e("offset");I.save({actor:t,target:i,mode:a,minDist:n,maxDist:s,offset:c,navigate:r,once:o,wait:l});break;case"rectangle":c=e("vertDist");I.save({actor:t,target:i,mode:a,minDist:n,maxDist:s,vertDist:c,navigate:r,once:o,wait:l})}}},I.cases.translateActor={initialize:function(){_("#translateActor-confirm").on("click",this.save),_("#translateActor-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#translateActor").on("open",function(e){_("#translateActor-easingId").loadItems(He.createEasingItems())}),_("#translateActor").on("closed",function(e){_("#translateActor-easingId").clear()})},parse:function({actor:e,angle:t,distance:i,easingId:a,duration:n,wait:s}){e=I.words.push(I.parseActor(e)).push(I.parseAngle(t)).push(I.parseVariableNumber(i,"t")).push(I.parseEasing(a,n,s));return[{color:"actor"},{text:N.get("command.translateActor")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},angle:t={type:"absolute",degrees:0},distance:i=0,easingId:a=He.easings[0].id,duration:n=0,wait:s=!1}){var r=D("translateActor");r("actor",e),r("angle",t),r("distance",i),r("easingId",a),r("duration",n),r("wait",s),_("#translateActor-actor").getFocus()},save:function(){var e=g("translateActor"),t=e("actor"),i=e("angle"),a=e("distance"),n=e("easingId"),s=e("duration"),e=e("wait");if(0===a)return _("#translateActor-distance").getFocus("all");I.save({actor:t,angle:i,distance:a,easingId:n,duration:s,wait:e})}},I.cases.changeThreat={initialize:function(){_("#changeThreat-confirm").on("click",this.save),_("#changeThreat-operation").loadItems([{name:"Increase",value:"increase"},{name:"Decrease",value:"decrease"}])},parseActors:function(e,t){return I.parseActor(e)+" -> "+I.parseActor(t)},parseOperation:function(e){return N.get("command.changeThreat."+e)},parse:function({actor:e,target:t,operation:i,threat:a}){e=I.words.push(this.parseActors(e,t)).push(this.parseOperation(i)).push(I.parseVariableNumber(a));return[{color:"actor"},{text:N.get("command.changeThreat")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},target:t={type:"trigger"},operation:i="increase",threat:a=0}){var n=D("changeThreat");n("actor",e),n("target",t),n("operation",i),n("threat",a),_("#changeThreat-actor").getFocus()},save:function(){var e=g("changeThreat"),t=e("actor"),i=e("target"),a=e("operation"),e=e("threat");I.save({actor:t,target:i,operation:a,threat:e})}},I.cases.setWeight={initialize:function(){_("#setWeight-confirm").on("click",this.save)},parse:function({actor:e,weight:t}){e=I.words.push(I.parseActor(e)).push(I.parseVariableNumber(t));return[{color:"actor"},{text:N.get("command.setWeight")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},weight:t=0}){var i=D("setWeight");i("actor",e),i("weight",t),_("#setWeight-actor").getFocus()},save:function(){var e=g("setWeight"),t=e("actor"),e=e("weight");I.save({actor:t,weight:e})}},I.cases.setMovementSpeed={initialize:function(){_("#setMovementSpeed-confirm").on("click",this.save),_("#setMovementSpeed-property").loadItems([{name:"Base Speed",value:"base"},{name:"Speed Factor",value:"factor"},{name:"Speed Factor (Temp)",value:"factor-temp"}]),_("#setMovementSpeed-property").enableHiddenMode().relate([{case:"base",targets:[_("#setMovementSpeed-base")]},{case:["factor","factor-temp"],targets:[_("#setMovementSpeed-factor")]}])},parse:function({actor:e,property:t,base:i,factor:a}){var n=I.words.push(I.parseActor(e)).push(N.get("command.setMovementSpeed."+t));switch(t){case"base":n.push(I.parseVariableNumber(i,"t/s"));break;case"factor":case"factor-temp":n.push(I.parseVariableNumber(a))}return[{color:"actor"},{text:N.get("command.setMovementSpeed")+": "},{text:n.join()}]},load:function({actor:e={type:"trigger"},property:t="base",base:i=0,factor:a=0}){var n=D("setMovementSpeed");n("actor",e),n("property",t),n("base",i),n("factor",a),_("#setMovementSpeed-actor").getFocus()},save:function(){var e=g("setMovementSpeed"),t=e("actor"),i=e("property");switch(i){case"base":var a=e("base");I.save({actor:t,property:i,base:a});break;case"factor":case"factor-temp":a=e("factor");I.save({actor:t,property:i,factor:a})}}},I.cases.setAngle={initialize:function(){_("#setAngle-confirm").on("click",this.save),_("#setAngle-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#setAngle").on("open",function(e){_("#setAngle-easingId").loadItems(He.createEasingItems())}),_("#setAngle").on("closed",function(e){_("#setAngle-easingId").clear()})},parse:function({actor:e,angle:t,easingId:i,duration:a,wait:n}){e=I.words.push(I.parseActor(e)).push(I.parseAngle(t)).push(I.parseEasing(i,a,n));return[{color:"actor"},{text:N.get("command.setAngle")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},angle:t={type:"absolute",degrees:0},easingId:i=He.easings[0].id,duration:a=0,wait:n=!1}){var s=D("setAngle");s("actor",e),s("angle",t),s("easingId",i),s("duration",a),s("wait",n),_("#setAngle-actor").getFocus()},save:function(){var e=g("setAngle"),t=e("actor"),i=e("angle"),a=e("easingId"),n=e("duration"),e=e("wait");I.save({actor:t,angle:i,easingId:a,duration:n,wait:e})}},I.cases.fixAngle={initialize:function(){_("#fixAngle-confirm").on("click",this.save),_("#fixAngle-fixed").loadItems([{name:"Fixed",value:!0},{name:"Unfixed",value:!1}])},parse:function({actor:e,fixed:t}){e=I.words.push(I.parseActor(e)).push(N.get("command.fixAngle.fixed."+t));return[{color:"actor"},{text:N.get("command.fixAngle")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},fixed:t=!0}){var i=D("fixAngle");i("actor",e),i("fixed",t),_("#fixAngle-actor").getFocus()},save:function(){var e=g("fixAngle"),t=e("actor"),e=e("fixed");I.save({actor:t,fixed:e})}},I.cases.setActive={initialize:function(){_("#setActive-confirm").on("click",this.save),_("#setActive-active").loadItems([{name:"Active",value:!0},{name:"Inactive",value:!1}])},parse:function({actor:e,active:t}){e=I.words.push(I.parseActor(e)).push(N.get("command.setActive.active."+t));return[{color:"actor"},{text:N.get("command.setActive")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},active:t=!1}){var i=D("setActive");i("actor",e),i("active",t),_("#setActive-actor").getFocus()},save:function(){var e=g("setActive"),t=e("actor"),e=e("active");I.save({actor:t,active:e})}},I.cases.deleteActor={initialize:function(){_("#deleteActor-confirm").on("click",this.save)},parse:function({actor:e}){return[{color:"actor"},{text:N.get("command.deleteActor")+": "},{text:I.parseActor(e)}]},load:function({actor:e={type:"trigger"}}){D("deleteActor")("actor",e),_("#deleteActor-actor").getFocus()},save:function(){var e=g("deleteActor")("actor");I.save({actor:e})}},I.cases.setPlayerActor={initialize:function(){_("#setPlayerActor-confirm").on("click",this.save)},parse:function({actor:e}){return[{color:"actor"},{text:N.get("command.setPlayerActor")+": "},{text:I.parseActor(e)}]},load:function({actor:e={type:"trigger"}}){D("setPlayerActor")("actor",e),_("#setPlayerActor-actor").getFocus()},save:function(){var e=g("setPlayerActor")("actor");I.save({actor:e})}},I.cases.setPartyMember={initialize:function(){_("#setPartyMember-confirm").on("click",this.save),_("#setPartyMember-operation").loadItems([{name:"Add",value:"add"},{name:"Remove",value:"remove"}])},parse:function({operation:e,actor:t}){e=I.words.push(N.get("command.setPartyMember."+e)).push(I.parseActor(t));return[{color:"actor"},{text:N.get("command.setPartyMember")+": "},{text:e.join()}]},load:function({operation:e="add",actor:t={type:"trigger"}}){var i=D("setPartyMember");i("operation",e),i("actor",t),_("#setPartyMember-operation").getFocus()},save:function(){var e=g("setPartyMember"),t=e("operation"),e=e("actor");I.save({operation:t,actor:e})}},I.cases.changeActorTeam={initialize:function(){_("#changeActorTeam-confirm").on("click",this.save),_("#changeActorTeam").on("open",function(e){_("#changeActorTeam-teamId").loadItems(He.createTeamItems())}),_("#changeActorTeam").on("closed",function(e){_("#changeActorTeam-teamId").clear()})},parse:function({actor:e,teamId:t}){e=I.words.push(I.parseActor(e)).push(I.parseTeam(t));return[{color:"actor"},{text:N.get("command.changeActorTeam")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},teamId:t=He.teams.list[0].id}){var i=D("changeActorTeam");i("actor",e),i("teamId",t),_("#changeActorTeam-actor").getFocus()},save:function(){var e=g("changeActorTeam"),t=e("actor"),e=e("teamId");I.save({actor:t,teamId:e})}},I.cases.changeActorState={initialize:function(){_("#changeActorState-confirm").on("click",this.save),_("#changeActorState-operation").loadItems([{name:"Add",value:"add"},{name:"Remove",value:"remove"},{name:"Remove Instance",value:"remove-instance"}]),_("#changeActorState-operation").enableHiddenMode().relate([{case:["add","remove"],targets:[_("#changeActorState-stateId")]},{case:"remove-instance",targets:[_("#changeActorState-state")]}])},parseOperation:function(e){return N.get("command.changeActorState."+e)},parse:function({actor:e,operation:t,stateId:i,state:a}){var n=I.words.push(I.parseActor(e)).push(this.parseOperation(t));switch(t){case"add":case"remove":n.push(I.parseFileName(i));break;case"remove-instance":n.push(I.parseState(a))}return[{color:"actor"},{text:N.get("command.changeActorState")+": "},{text:n.join()}]},load:function({actor:e={type:"trigger"},operation:t="add",stateId:i="",state:a={type:"trigger"}}){var n=D("changeActorState");n("actor",e),n("operation",t),n("stateId",i),n("state",a),_("#changeActorState-actor").getFocus()},save:function(){var e=g("changeActorState"),t=e("actor"),i=e("operation");switch(i){case"add":case"remove":var a=e("stateId");if(""===a)return _("#changeActorState-stateId").getFocus();I.save({actor:t,operation:i,stateId:a});break;case"remove-instance":a=e("state");I.save({actor:t,operation:i,state:a})}}},I.cases.changeActorEquipment={initialize:function(){_("#changeActorEquipment-confirm").on("click",this.save),_("#changeActorEquipment-operation").loadItems([{name:"Add",value:"add"},{name:"Remove",value:"remove"},{name:"Add Instance",value:"add-instance"},{name:"Remove Instance",value:"remove-instance"},{name:"Remove Slot",value:"remove-slot"}]),_("#changeActorEquipment-operation").enableHiddenMode().relate([{case:"add",targets:[_("#changeActorEquipment-slot"),_("#changeActorEquipment-equipmentId")]},{case:"remove",targets:[_("#changeActorEquipment-equipmentId")]},{case:"add-instance",targets:[_("#changeActorEquipment-slot"),_("#changeActorEquipment-equipment")]},{case:"remove-instance",targets:[_("#changeActorEquipment-equipment")]},{case:"remove-slot",targets:[_("#changeActorEquipment-slot")]}])},parse:function({actor:e,operation:t,slot:i,equipmentId:a,equipment:n}){var s=I.words.push(I.parseActor(e)).push(N.get("command.changeActorEquipment."+t));switch(t){case"add":var r=I.parseGroupEnumString("equipment-slot",i),o=I.parseFileName(a);s.push(r+" = "+o);break;case"remove":s.push(I.parseFileName(a));break;case"add-instance":r=I.parseGroupEnumString("equipment-slot",i),o=I.parseEquipment(n);s.push(r+" = "+o);break;case"remove-instance":s.push(I.parseEquipment(n));break;case"remove-slot":s.push(I.parseGroupEnumString("equipment-slot",i))}return[{color:"actor"},{text:N.get("command.changeActorEquipment")+": "},{text:s.join()}]},load:function({actor:e={type:"trigger"},operation:t="add",slot:i="",equipmentId:a="",equipment:n={type:"trigger"}}){_("#changeActorEquipment-slot").loadItems(M.getStringItems("equipment-slot"));var s=D("changeActorEquipment");s("actor",e),s("operation",t),s("equipmentId",a),s("equipment",n),_("#changeActorEquipment-slot").write2(i),_("#changeActorEquipment-actor").getFocus()},save:function(){var e=g("changeActorEquipment"),t=e("actor"),i=e("operation");switch(i){case"add":var a=e("slot");if(""===a)return _("#changeActorEquipment-slot").getFocus();var n=e("equipmentId");if(""===n)return _("#changeActorEquipment-equipmentId").getFocus();I.save({actor:t,operation:i,slot:a,equipmentId:n});break;case"remove":a=e("equipmentId");if(""===a)return _("#changeActorEquipment-equipmentId").getFocus();I.save({actor:t,operation:i,equipmentId:a});break;case"add-instance":n=e("slot");if(""===n)return _("#changeActorEquipment-slot").getFocus();a=e("equipment");I.save({actor:t,operation:i,slot:n,equipment:a});break;case"remove-instance":n=e("equipment");I.save({actor:t,operation:i,equipment:n});break;case"remove-slot":a=e("slot");if(""===a)return _("#changeActorEquipment-slot").getFocus();I.save({actor:t,operation:i,slot:a})}}},I.cases.changeActorSkill={initialize:function(){_("#changeActorSkill-confirm").on("click",this.save),_("#changeActorSkill-operation").loadItems([{name:"Add",value:"add"},{name:"Remove",value:"remove"},{name:"Remove Instance",value:"remove-instance"},{name:"Sort by Filename",value:"sort-by-filename"}]),_("#changeActorSkill-operation").enableHiddenMode().relate([{case:["add","remove"],targets:[_("#changeActorSkill-skillId")]},{case:"remove-instance",targets:[_("#changeActorSkill-skill")]}])},parseOperation:function(e){return N.get("command.changeActorSkill."+e)},parse:function({actor:e,operation:t,skill:i,skillId:a}){var n=I.words.push(I.parseActor(e)).push(this.parseOperation(t));switch(t){case"add":case"remove":n.push(I.parseFileName(a));break;case"remove-instance":n.push(I.parseSkill(i))}return[{color:"actor"},{text:N.get("command.changeActorSkill")+": "},{text:n.join()}]},load:function({actor:e={type:"trigger"},operation:t="add",skillId:i="",skill:a={type:"trigger"}}){var n=D("changeActorSkill");n("actor",e),n("operation",t),n("skillId",i),n("skill",a),_("#changeActorSkill-actor").getFocus()},save:function(){var e=g("changeActorSkill"),t=e("actor"),i=e("operation");switch(i){case"add":case"remove":var a=e("skillId");if(""===a)return _("#changeActorSkill-skillId").getFocus();I.save({actor:t,operation:i,skillId:a});break;case"remove-instance":a=e("skill");I.save({actor:t,operation:i,skill:a});break;case"sort-by-filename":I.save({actor:t,operation:i})}}},I.cases.changeActorAnimation={initialize:function(){_("#changeActorAnimation-confirm").on("click",this.save)},parse:function({actor:e,animationId:t}){e=I.words.push(I.parseActor(e)).push(I.parseFileName(t));return[{color:"actor"},{text:N.get("command.changeActorAnimation")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},animationId:t=""}){var i=D("changeActorAnimation");i("actor",e),i("animationId",t),_("#changeActorAnimation-actor").getFocus()},save:function(){var e=g("changeActorAnimation"),t=e("actor"),e=e("animationId");if(""===e)return _("#changeActorAnimation-animationId").getFocus();I.save({actor:t,animationId:e})}},I.cases.changeActorSprite={initialize:function(){_("#changeActorSprite-confirm").on("click",this.save),_("#changeActorSprite-animationId").on("write",e=>{var e=Ke.getSpriteListItems(e.value),t=_("#changeActorSprite-spriteId");t.loadItems(e),t.write(t.read())})},parse:function({actor:e,animationId:t,spriteId:i,image:a}){e=I.words.push(I.parseActor(e)).push(I.parseFileName(t)).push(I.parseSpriteName(t,i)).push(I.parseFileName(a));return[{color:"actor"},{text:N.get("command.changeActorSprite")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},animationId:t="",spriteId:i="",image:a=""}){var n=D("changeActorSprite");n("actor",e),n("animationId",t),n("spriteId",i),n("image",a),_("#changeActorSprite-actor").getFocus()},save:function(){var e,t=g("changeActorSprite"),i=t("actor"),a=t("animationId");return""===a?_("#changeActorSprite-animationId").getFocus():""===(e=t("spriteId"))?_("#changeActorSprite-spriteId").getFocus():(t=t("image"),void I.save({actor:i,animationId:a,spriteId:e,image:t}))}},I.cases.remapActorMotion={initialize:function(){_("#remapActorMotion-confirm").on("click",this.save),_("#remapActorMotion-type").loadItems([{name:"Idle",value:"idle"},{name:"Move",value:"move"}])},parseMapping:function(e,t){return N.get("command.remapActorMotion.type."+e)+" -> "+I.parseEnumString(t)},parse:function({actor:e,type:t,motion:i}){e=I.words.push(I.parseActor(e)).push(this.parseMapping(t,i));return[{color:"actor"},{text:N.get("command.remapActorMotion")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},type:t="move",motion:i=""}){var a=D("remapActorMotion");a("actor",e),a("type",t),a("motion",i),_("#remapActorMotion-actor").getFocus()},save:function(){var e=g("remapActorMotion"),t=e("actor"),i=e("type"),e=e("motion");if(""===e)return _("#remapActorMotion-motion").getFocus();I.save({actor:t,type:i,motion:e})}},I.cases.playActorAnimation={initialize:function(){_("#playActorAnimation-confirm").on("click",this.save),_("#playActorAnimation-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}])},parseSpeed:function(e){if(1===e)return"";switch(typeof e){case"number":return"x"+e;case"object":return I.parseVariableNumber(e)}},parse:function({actor:e,motion:t,speed:i,wait:a}){e=I.words.push(I.parseActor(e)).push(I.parseEnumString(t)).push(this.parseSpeed(i)).push(I.parseWait(a));return[{color:"actor"},{text:N.get("command.playActorAnimation")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},motion:t="",speed:i=1,wait:a=!1}){var n=D("playActorAnimation");n("actor",e),n("motion",t),n("speed",i),n("wait",a),_("#playActorAnimation-actor").getFocus()},save:function(){var e=g("playActorAnimation"),t=e("actor"),i=e("motion").trim(),a=e("speed"),e=e("wait");if(!i)return _("#playActorAnimation-motion").getFocus();I.save({actor:t,motion:i,speed:a,wait:e})}},I.cases.stopActorAnimation={initialize:function(){_("#stopActorAnimation-confirm").on("click",this.save)},parse:function({actor:e}){return[{color:"actor"},{text:N.get("command.stopActorAnimation")+": "},{text:I.parseActor(e)}]},load:function({actor:e={type:"trigger"}}){D("stopActorAnimation")("actor",e),_("#stopActorAnimation-actor").getFocus()},save:function(){var e=g("stopActorAnimation")("actor");I.save({actor:e})}},I.cases.createGlobalActor={initialize:function(){_("#createGlobalActor-confirm").on("click",this.save),_("#createGlobalActor").on("open",function(e){_("#createGlobalActor-teamId").loadItems(He.createTeamItems())}),_("#createGlobalActor").on("closed",function(e){_("#createGlobalActor-teamId").clear()})},parse:function({actorId:e,teamId:t}){e=I.words.push(I.parseFileName(e)).push(I.parseTeam(t));return[{color:"actor"},{text:N.get("command.createGlobalActor")+": "},{text:e.join()}]},load:function({actorId:e="",teamId:t=He.teams.list[0].id}){var i=D("createGlobalActor");i("actorId",e),i("teamId",t),_("#createGlobalActor-actorId").getFocus()},save:function(){var e=g("createGlobalActor"),t=e("actorId");if(""===t)return _("#createGlobalActor-actorId").getFocus();e=e("teamId");I.save({actorId:t,teamId:e})}},I.cases.placeGlobalActor={initialize:function(){_("#placeGlobalActor-confirm").on("click",this.save)},parse:function({actor:e,position:t}){e=I.words.push(I.parseActor(e)).push(I.parsePosition(t));return[{color:"actor"},{text:N.get("command.placeGlobalActor")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},position:t={type:"absolute",x:0,y:0}}){var i=D("placeGlobalActor");i("actor",e),i("position",t),_("#placeGlobalActor-actor").getFocus("all")},save:function(){var e=g("placeGlobalActor"),t=e("actor"),e=e("position");I.save({actor:t,position:e})}},I.cases.deleteGlobalActor={initialize:function(){_("#deleteGlobalActor-confirm").on("click",this.save)},parse:function({actorId:e}){e=I.words.push(I.parseFileName(e));return[{color:"actor"},{text:N.get("command.deleteGlobalActor")+": "},{text:e.join()}]},load:function({actorId:e=""}){D("deleteGlobalActor")("actorId",e),_("#deleteGlobalActor-actorId").getFocus()},save:function(){var e=g("deleteGlobalActor")("actorId");if(""===e)return _("#deleteGlobalActor-actorId").getFocus();I.save({actorId:e})}},I.cases.getTarget={initialize:function(){_("#getTarget-confirm").on("click",this.save),_("#getTarget-selector").loadItems([{name:"Enemy",value:"enemy"},{name:"Friend",value:"friend"},{name:"Team Member",value:"team"},{name:"Team Member Except Self",value:"team-except-self"},{name:"Any Except Self",value:"any-except-self"},{name:"Any",value:"any"}]),_("#getTarget-condition").loadItems([{name:"Max Threat",value:"max-threat"},{name:"Nearest",value:"nearest"},{name:"Farthest",value:"farthest"},{name:"Min Attribute Value",value:"min-attribute-value"},{name:"Max Attribute Value",value:"max-attribute-value"},{name:"Min Attribute Ratio",value:"min-attribute-ratio"},{name:"Max Attribute Ratio",value:"max-attribute-ratio"},{name:"Random",value:"random"}]),_("#getTarget-condition").enableHiddenMode().relate([{case:["min-attribute-value","max-attribute-value"],targets:[_("#getTarget-attribute")]},{case:["min-attribute-ratio","max-attribute-ratio"],targets:[_("#getTarget-attribute"),_("#getTarget-divisor")]}])},parseCondition:function(e,t,i){var a=N.get("command.getTarget.condition."+e);switch(e){case"max-threat":case"nearest":case"farthest":case"random":return a;case"min-attribute-value":case"max-attribute-value":return`${a}(${I.parseAttributeKey("actor",t)})`;case"min-attribute-ratio":case"max-attribute-ratio":return`${a}(${I.parseAttributeKey("actor",t)} / ${I.parseAttributeKey("actor",i)})`}},parse:function({actor:e,selector:t,condition:i,attribute:a,divisor:n}){e=I.words.push(I.parseActor(e)).push(I.parseActorSelector(t)).push(this.parseCondition(i,a,n));return[{color:"actor"},{text:N.get("command.getTarget")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},selector:t="enemy",condition:i="max-threat",attribute:a=v.getDefAttributeId("actor","number"),divisor:n=v.getDefAttributeId("actor","number")}){var s=v.getAttributeItems("actor","number"),s=(_("#getTarget-attribute").loadItems(s),_("#getTarget-divisor").loadItems(s),D("getTarget"));s("actor",e),s("selector",t),s("condition",i),s("attribute",a),s("divisor",n),_("#getTarget-actor").getFocus()},save:function(){var e=g("getTarget"),t=e("actor"),i=e("selector"),a=e("condition");switch(a){case"max-threat":case"nearest":case"farthest":case"random":I.save({actor:t,selector:i,condition:a});break;case"min-attribute-value":case"max-attribute-value":var n=e("attribute");if(""===n)return _("#getTarget-attribute").getFocus();I.save({actor:t,selector:i,condition:a,attribute:n});break;case"min-attribute-ratio":case"max-attribute-ratio":var n=e("attribute"),s=e("divisor");if(""===n)return _("#getTarget-attribute").getFocus();if(""===s)return _("#getTarget-divisor").getFocus();I.save({actor:t,selector:i,condition:a,attribute:n,divisor:s})}}},I.cases.detectTargets={initialize:function(){_("#detectTargets-confirm").on("click",this.save),_("#detectTargets-selector").loadItems([{name:"Enemy",value:"enemy"},{name:"Friend",value:"friend"},{name:"Team Member",value:"team"},{name:"Team Member Except Self",value:"team-except-self"},{name:"Any Except Self",value:"any-except-self"},{name:"Any",value:"any"}]),_("#detectTargets-inSight").loadItems([{name:"Enabled",value:!0},{name:"Disabled",value:!1}])},parseInSight:function(e){switch(e){case!0:return N.get("command.detectTargets.inSight");case!1:return""}},parse:function({actor:e,distance:t,selector:i,inSight:a}){e=I.words.push(I.parseActor(e)).push("≤"+t+"t").push(I.parseActorSelector(i)).push(this.parseInSight(a));return[{color:"actor"},{text:N.get("command.detectTargets")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},distance:t=0,selector:i="enemy",inSight:a=!1}){var n=D("detectTargets");n("actor",e),n("distance",t),n("selector",i),n("inSight",a),_("#detectTargets-actor").getFocus()},save:function(){var e=g("detectTargets"),t=e("actor"),i=e("distance"),a=e("selector"),e=e("inSight");if(0===i)return _("#detectTargets-distance").getFocus("all");I.save({actor:t,distance:i,selector:a,inSight:e})}},I.cases.discardTargets={initialize:function(){_("#discardTargets-confirm").on("click",this.save),_("#discardTargets-selector").loadItems([{name:"Enemy",value:"enemy"},{name:"Friend",value:"friend"},{name:"Team Member",value:"team"},{name:"Team Member Except Self",value:"team-except-self"},{name:"Any Except Self",value:"any-except-self"},{name:"Any",value:"any"}])},parse:function({actor:e,selector:t,distance:i}){e=I.words.push(I.parseActor(e)).push(I.parseActorSelector(t));return 0!==i&&e.push(`>= ${i}t`),[{color:"actor"},{text:N.get("command.discardTargets")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},selector:t="any",distance:i=0}){var a=D("discardTargets");a("actor",e),a("selector",t),a("distance",i),_("#discardTargets-actor").getFocus()},save:function(){var e=g("discardTargets"),t=e("actor"),i=e("selector"),e=e("distance");I.save({actor:t,selector:i,distance:e})}},I.cases.resetTargets={initialize:function(){_("#resetTargets-confirm").on("click",this.save)},parse:function({actor:e}){return[{color:"actor"},{text:N.get("command.resetTargets")+": "},{text:I.parseActor(e)}]},load:function({actor:e={type:"trigger"}}){D("resetTargets")("actor",e),_("#resetTargets-actor").getFocus()},save:function(){var e=g("resetTargets")("actor");I.save({actor:e})}},I.cases.castSkill={initialize:function(){_("#castSkill-confirm").on("click",this.save),_("#castSkill-mode").loadItems([{name:"By Shortcut Key",value:"by-key"},{name:"By Skill Id",value:"by-id"},{name:"By Skill Instance",value:"by-skill"}]),_("#castSkill-mode").enableHiddenMode().relate([{case:"by-key",targets:[_("#castSkill-key")]},{case:"by-id",targets:[_("#castSkill-skillId")]},{case:"by-skill",targets:[_("#castSkill-skill")]}]),_("#castSkill-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}])},parse:function({actor:e,mode:t,key:i,skillId:a,skill:n,wait:s}){var r=I.words.push(I.parseActor(e));switch(t){case"by-key":r.push(I.parseGroupEnumString("shortcut-key",i));break;case"by-id":r.push(I.parseFileName(a));break;case"by-skill":r.push(I.parseSkill(n))}return r.push(I.parseWait(s)),[{color:"skill"},{text:N.get("command.castSkill")+": "},{text:r.join()}]},load:function({actor:e={type:"trigger"},mode:t="by-key",key:i=M.getDefStringId("shortcut-key"),skillId:a="",skill:n={type:"trigger"},wait:s=!1}){_("#castSkill-key").loadItems(M.getStringItems("shortcut-key"));var r=D("castSkill");r("actor",e),r("mode",t),r("key",i),r("skillId",a),r("skill",n),r("wait",s),_("#castSkill-actor").getFocus()},save:function(){var e=g("castSkill"),t=e("actor"),i=e("mode"),a=e("wait");switch(i){case"by-key":var n=e("key");if(""===n)return _("#castSkill-key").getFocus();I.save({actor:t,mode:i,key:n,wait:a});break;case"by-id":n=e("skillId");if(""===n)return _("#castSkill-skillId").getFocus();I.save({actor:t,mode:i,skillId:n,wait:a});break;case"by-skill":n=e("skill");I.save({actor:t,mode:i,skill:n,wait:a})}}},I.cases.setSkill={initialize:function(){_("#setSkill-confirm").on("click",this.save),_("#setSkill-operation").loadItems([{name:"Set Cooldown Time",value:"set-cooldown"},{name:"Increase Cooldown Time",value:"increase-cooldown"},{name:"Decrease Cooldown Time",value:"decrease-cooldown"}])},parse:function({skill:e,operation:t,cooldown:i}){var a=I.words.push(I.parseSkill(e)).push(N.get("command.setSkill."+t));switch(t){case"set-cooldown":case"increase-cooldown":case"decrease-cooldown":a.push(I.parseVariableNumber(i,"ms"))}return[{color:"skill"},{text:N.get("command.setSkill")+": "},{text:a.join()}]},load:function({skill:e={type:"trigger"},operation:t="set-cooldown",cooldown:i=0}){var a=D("setSkill");a("skill",e),a("operation",t),a("cooldown",i),_("#setSkill-skill").getFocus()},save:function(){var e=g("setSkill"),t=e("skill"),i=e("operation");switch(i){case"set-cooldown":case"increase-cooldown":case"decrease-cooldown":var a=e("cooldown");I.save({skill:t,operation:i,cooldown:a})}}},I.cases.createTrigger={initialize:function(){_("#createTrigger-confirm").on("click",this.save)},parseTimeScale:function(e){if(1===e)return"";switch(typeof e){case"number":return"x"+e;case"object":return I.parseVariableNumber(e)}},parse:function({triggerId:e,caster:t,origin:i,angle:a,distance:n,timeScale:s}){t=I.parseActor(t),i=I.parsePosition(i),e=I.words.push(I.parseFileName(e)).push(t).push(-1===i.indexOf(t)?i:"").push(I.parseAngle(a)).push(I.parseVariableNumber(n,"t")).push(this.parseTimeScale(s));return[{color:"skill"},{text:N.get("command.createTrigger")+": "},{text:e.join()}]},load:function({triggerId:e="",caster:t={type:"trigger"},origin:i={type:"actor",actor:{type:"trigger"}},angle:a={type:"direction",degrees:0},distance:n=0,timeScale:s=1}){var r=D("createTrigger");r("triggerId",e),r("caster",t),r("origin",i),r("angle",a),r("distance",n),r("timeScale",s),_("#createTrigger-triggerId").getFocus()},save:function(){var e=g("createTrigger"),t=e("triggerId");if(""===t)return _("#createTrigger-triggerId").getFocus();var i=e("caster"),a=e("origin"),n=e("angle"),s=e("distance"),e=e("timeScale");I.save({triggerId:t,caster:i,origin:a,angle:n,distance:s,timeScale:e})}},I.cases.setTriggerSpeed={initialize:function(){_("#setTriggerSpeed-confirm").on("click",this.save)},parse:function({trigger:e,speed:t}){e=I.words.push(I.parseTrigger(e)).push(I.parseVariableNumber(t,"t/s"));return[{color:"skill"},{text:N.get("command.setTriggerSpeed")+": "},{text:e.join()}]},load:function({trigger:e={type:"trigger"},speed:t=0}){var i=D("setTriggerSpeed");i("trigger",e),i("speed",t),_("#setTriggerSpeed-trigger").getFocus()},save:function(){var e=g("setTriggerSpeed"),t=e("trigger"),e=e("speed");I.save({trigger:t,speed:e})}},I.cases.setTriggerAngle={initialize:function(){_("#setTriggerAngle-confirm").on("click",this.save)},parse:function({trigger:e,angle:t}){e=I.words.push(I.parseTrigger(e)).push(I.parseAngle(t));return[{color:"skill"},{text:N.get("command.setTriggerAngle")+": "},{text:e.join()}]},load:function({trigger:e={type:"trigger"},angle:t={type:"absolute",degrees:0}}){var i=D("setTriggerAngle");i("trigger",e),i("angle",t),_("#setTriggerAngle-trigger").getFocus()},save:function(){var e=g("setTriggerAngle"),t=e("trigger"),e=e("angle");I.save({trigger:t,angle:e})}},I.cases.setInventory={initialize:function(){_("#setInventory-confirm").on("click",this.save),_("#setInventory-operation").loadItems([{name:"Increase Money",value:"increase-money"},{name:"Decrease Money",value:"decrease-money"},{name:"Increase Items",value:"increase-items"},{name:"Decrease Items",value:"decrease-items"},{name:"Gain Equipment",value:"gain-equipment"},{name:"Lose Equipment",value:"lose-equipment"},{name:"Gain Equipment",value:"gain-equipment-instance"},{name:"Lose Equipment",value:"lose-equipment-instance"},{name:"Sort Simply",value:"sort"},{name:"Sort by Filename",value:"sort-by-filename"},{name:"Use Global Actor's Inventory",value:"reference"},{name:"Reset",value:"reset"}]),_("#setInventory-operation").enableHiddenMode().relate([{case:["increase-money","decrease-money"],targets:[_("#setInventory-money")]},{case:["increase-items","decrease-items"],targets:[_("#setInventory-itemId"),_("#setInventory-quantity")]},{case:["gain-equipment","lose-equipment"],targets:[_("#setInventory-equipmentId")]},{case:["gain-equipment-instance","lose-equipment-instance"],targets:[_("#setInventory-equipment")]},{case:"reference",targets:[_("#setInventory-refActor")]}])},parse:function({actor:e,operation:t,money:i,itemId:a,quantity:n,equipmentId:s,equipment:r,refActor:o}){var l=I.words.push(I.parseActor(e)).push(N.get("command.setInventory."+t));switch(t){case"increase-money":case"decrease-money":l.push(I.parseVariableNumber(i));break;case"increase-items":case"decrease-items":l.push(I.parseVariableFile(a)),l.push(I.parseVariableNumber(n));break;case"gain-equipment":case"lose-equipment":l.push(I.parseVariableFile(s));break;case"gain-equipment-instance":case"lose-equipment-instance":l.push(I.parseEquipment(r));break;case"reference":l.push(I.parseActor(o))}return[{color:"inventory"},{text:N.get("command.setInventory")+": "},{text:l.join()}]},load:function({actor:e={type:"trigger"},operation:t="increase-money",money:i=1,itemId:a="",quantity:n=1,equipmentId:s="",equipment:r={type:"trigger"},refActor:o={type:"player"}}){var l=D("setInventory");l("actor",e),l("operation",t),l("money",i),l("itemId",a),l("quantity",n),l("equipmentId",s),l("equipment",r),l("refActor",o),_("#setInventory-actor").getFocus()},save:function(){var e=g("setInventory"),t=e("actor"),i=e("operation");switch(i){case"increase-money":case"decrease-money":var a=e("money");I.save({actor:t,operation:i,money:a});break;case"increase-items":case"decrease-items":var a=e("itemId"),n=e("quantity");if(""===a)return _("#setInventory-itemId").getFocus();I.save({actor:t,operation:i,itemId:a,quantity:n});break;case"gain-equipment":case"lose-equipment":a=e("equipmentId");if(""===a)return _("#setInventory-equipmentId").getFocus();I.save({actor:t,operation:i,equipmentId:a});break;case"gain-equipment-instance":case"lose-equipment-instance":n=e("equipment");I.save({actor:t,operation:i,equipment:n});break;case"sort":case"sort-by-filename":case"reset":I.save({actor:t,operation:i});break;case"reference":a=e("refActor");I.save({actor:t,operation:i,refActor:a})}}},I.cases.useItem={initialize:function(){_("#useItem-confirm").on("click",this.save),_("#useItem-mode").loadItems([{name:"By Shortcut Key",value:"by-key"},{name:"By Item Id",value:"by-id"},{name:"By Item Instance",value:"by-item"}]),_("#useItem-mode").enableHiddenMode().relate([{case:"by-key",targets:[_("#useItem-key")]},{case:"by-id",targets:[_("#useItem-itemId")]},{case:"by-item",targets:[_("#useItem-item")]}]),_("#useItem-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}])},parse:function({actor:e,mode:t,key:i,itemId:a,item:n,wait:s}){var r=I.words.push(I.parseActor(e));switch(t){case"by-key":r.push(I.parseGroupEnumString("shortcut-key",i));break;case"by-id":r.push(I.parseFileName(a));break;case"by-item":r.push(I.parseItem(n))}return r.push(I.parseWait(s)),[{color:"inventory"},{text:N.get("command.useItem")+": "},{text:r.join()}]},load:function({actor:e={type:"trigger"},mode:t="by-key",key:i=M.getDefStringId("shortcut-key"),itemId:a="",item:n={type:"trigger"},wait:s=!1}){_("#useItem-key").loadItems(M.getStringItems("shortcut-key"));var r=D("useItem");r("actor",e),r("mode",t),r("key",i),r("itemId",a),r("item",n),r("wait",s),_("#useItem-actor").getFocus()},save:function(){var e=g("useItem"),t=e("actor"),i=e("mode"),a=e("wait");switch(i){case"by-key":var n=e("key");if(""===n)return _("#useItem-key").getFocus();I.save({actor:t,mode:i,key:n,wait:a});break;case"by-id":n=e("itemId");if(""===n)return _("#useItem-itemId").getFocus();I.save({actor:t,mode:i,itemId:n,wait:a});break;case"by-item":n=e("item");I.save({actor:t,mode:i,item:n,wait:a})}}},I.cases.setItem={initialize:function(){_("#setItem-confirm").on("click",this.save),_("#setItem-operation").loadItems([{name:"Increase",value:"increase"},{name:"Decrease",value:"decrease"}])},parse:function({item:e,operation:t,quantity:i}){var a=I.words.push(I.parseItem(e)).push(N.get("command.setItem."+t));switch(t){case"increase":case"decrease":a.push(I.parseVariableNumber(i))}return[{color:"inventory"},{text:N.get("command.setItem")+": "},{text:a.join()}]},load:function({item:e={type:"trigger"},operation:t="increase",quantity:i=1}){var a=D("setItem");a("item",e),a("operation",t),a("quantity",i),_("#setItem-item").getFocus()},save:function(){var e=g("setItem"),t=e("item"),i=e("operation");switch(i){case"increase":case"decrease":var a=e("quantity");I.save({item:t,operation:i,quantity:a})}}},I.cases.setCooldown={initialize:function(){_("#setCooldown-confirm").on("click",this.save),_("#setCooldown-operation").loadItems([{name:"Set",value:"set"},{name:"Increase",value:"increase"},{name:"Decrease",value:"decrease"}])},parse:function({actor:e,operation:t,key:i,cooldown:a}){e=I.words.push(I.parseActor(e)).push(N.get("command.setCooldown."+t)).push(I.parseVariableEnum("cooldown-key",i)).push(I.parseVariableNumber(a,"ms"));return[{color:"inventory"},{text:N.get("command.setCooldown")+": "},{text:e.join()}]},load:function({actor:e={type:"trigger"},operation:t="set",key:i=M.getDefStringId("cooldown-key"),cooldown:a=0}){_("#setCooldown-key").loadItems(M.getStringItems("cooldown-key"));var n=D("setCooldown");n("actor",e),n("operation",t),n("key",i),n("cooldown",a),_("#setCooldown-actor").getFocus()},save:function(){var e=g("setCooldown"),t=e("actor"),i=e("operation"),a=e("key");if(""===a)return _("#setCooldown-key").getFocus();e=e("cooldown");I.save({actor:t,operation:i,key:a,cooldown:e})}},I.cases.setShortcut={initialize:function(){_("#setShortcut-confirm").on("click",this.save),_("#setShortcut-operation").loadItems([{name:"Set Item Shortcut",value:"set-item-shortcut"},{name:"Set Skill Shortcut",value:"set-skill-shortcut"},{name:"Delete Shortcut",value:"delete-shortcut"}]),_("#setShortcut-operation").enableHiddenMode().relate([{case:"set-item-shortcut",targets:[_("#setShortcut-itemId")]},{case:"set-skill-shortcut",targets:[_("#setShortcut-skillId")]}])},parse:function({actor:e,operation:t,itemId:i,skillId:a,key:n}){var s=I.words.push(I.parseActor(e)).push(N.get("command.setShortcut."+t)),r=I.parseGroupEnumString("shortcut-key",n);switch(t){case"set-item-shortcut":s.push(r+" = "+I.parseFileName(i));break;case"set-skill-shortcut":s.push(r+" = "+I.parseFileName(a));break;case"delete-shortcut":s.push(r)}return[{color:"inventory"},{text:N.get("command.setShortcut")+": "},{text:s.join()}]},load:function({actor:e={type:"trigger"},operation:t="set-item-shortcut",itemId:i="",skillId:a="",key:n=M.getDefStringId("shortcut-key")}){_("#setShortcut-key").loadItems(M.getStringItems("shortcut-key"));var s=D("setShortcut");s("actor",e),s("operation",t),s("key",n),s("itemId",i),s("skillId",a),_("#setShortcut-operation").getFocus()},save:function(){var e=g("setShortcut"),t=e("actor"),i=e("operation"),a=e("key");if(""===a)return _("#setShortcut-key").getFocus();switch(i){case"set-item-shortcut":var n=e("itemId");if(""===n)return _("#setShortcut-itemId").getFocus();I.save({actor:t,operation:i,key:a,itemId:n});break;case"set-skill-shortcut":n=e("skillId");if(""===n)return _("#setShortcut-skillId").getFocus();I.save({actor:t,operation:i,key:a,skillId:n});break;case"delete-shortcut":I.save({actor:t,operation:i,key:a})}}},I.cases.activateScene={initialize:function(){_("#activateScene-confirm").on("click",this.save),_("#activateScene-pointer").loadItems([{name:"Scene A",value:0},{name:"Scene B",value:1}])},parsePointer:function(e){switch(e){case 0:return"A";case 1:return"B"}},parse:function({pointer:e}){return[{color:"scene"},{text:N.get("command.activateScene")+": "},{text:this.parsePointer(e)}]},load:function({pointer:e=0}){D("activateScene")("pointer",e),_("#activateScene-pointer").getFocus()},save:function(){var e=g("activateScene")("pointer");I.save({pointer:e})}},I.cases.loadScene={initialize:function(){_("#loadScene-confirm").on("click",this.save),_("#loadScene-transfer").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#loadScene-transfer").enableHiddenMode().relate([{case:!0,targets:[_("#loadScene-x"),_("#loadScene-y")]}])},parse:function({sceneId:e,transfer:t,x:i,y:a}){e=I.words.push(I.parseVariableFile(e));return t&&e.push(I.parseVariableNumber(i)).push(I.parseVariableNumber(a)),[{color:"scene"},{text:N.get("command.loadScene")+": "},{text:e.join()}]},load:function({sceneId:e="",transfer:t=!0,x:i=0,y:a=0}){var n=D("loadScene");n("sceneId",e),n("transfer",t),n("x",i),n("y",a),_("#loadScene-sceneId").getFocus()},save:function(){var e=g("loadScene"),t=e("sceneId");if(""===t)return _("#loadScene-sceneId").getFocus();var i=e("transfer");switch(i){case!0:var a=e("x"),n=e("y");I.save({sceneId:t,transfer:i,x:a,y:n});break;case!1:I.save({sceneId:t,transfer:i})}}},I.cases.deleteScene={parse:function(){return[{color:"scene"},{text:N.get("command.deleteScene")}]},save:function(){I.save({})}},I.cases.moveCamera={initialize:function(){_("#moveCamera-confirm").on("click",this.save),_("#moveCamera-mode").loadItems([{name:"Move to Position",value:"position"},{name:"Follow Actor",value:"actor"}]),_("#moveCamera-mode").enableHiddenMode().relate([{case:"position",targets:[_("#moveCamera-position")]},{case:"actor",targets:[_("#moveCamera-actor")]}]),_("#moveCamera-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#moveCamera").on("open",function(e){_("#moveCamera-easingId").loadItems(He.createEasingItems())}),_("#moveCamera").on("closed",function(e){_("#moveCamera-easingId").clear()})},parse:function({mode:e,position:t,actor:i,easingId:a,duration:n,wait:s}){var r=I.words.push(N.get("command.moveCamera."+e));switch(e){case"position":r.push(I.parsePosition(t));break;case"actor":r.push(I.parseActor(i))}return r.push(I.parseEasing(a,n,s)),[{color:"scene"},{text:N.get("command.moveCamera")+": "},{text:r.join()}]},load:function({mode:e="position",position:t={type:"absolute",x:0,y:0},actor:i={type:"trigger"},easingId:a=He.easings[0].id,duration:n=0,wait:s=!1}){var r=D("moveCamera");r("mode",e),r("position",t),r("actor",i),r("easingId",a),r("duration",n),r("wait",s),_("#moveCamera-mode").getFocus()},save:function(){var e=g("moveCamera"),t=e("mode"),i=e("easingId"),a=e("duration"),n=e("wait");switch(t){case"position":var s=e("position");I.save({mode:t,position:s,easingId:i,duration:a,wait:n});break;case"actor":s=e("actor");I.save({mode:t,actor:s,easingId:i,duration:a,wait:n})}}},I.cases.setZoomFactor={initialize:function(){_("#setZoomFactor-confirm").on("click",this.save),_("#setZoomFactor-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#setZoomFactor").on("open",function(e){_("#setZoomFactor-easingId").loadItems(He.createEasingItems())}),_("#setZoomFactor").on("closed",function(e){_("#setZoomFactor-easingId").clear()})},parse:function({zoom:e,easingId:t,duration:i,wait:a}){e=I.words.push(I.parseVariableNumber(e)).push(I.parseEasing(t,i,a));return[{color:"scene"},{text:N.get("command.setZoomFactor")+": "},{text:e.join()}]},load:function({zoom:e=1,easingId:t=He.easings[0].id,duration:i=0,wait:a=!1}){var n=D("setZoomFactor");n("zoom",e),n("easingId",t),n("duration",i),n("wait",a),_("#setZoomFactor-zoom").getFocus("all")},save:function(){var e=g("setZoomFactor"),t=e("zoom"),i=e("easingId"),a=e("duration"),e=e("wait");I.save({zoom:t,easingId:i,duration:a,wait:e})}},I.cases.setAmbientLight={initialize:function(){_("#setAmbientLight-confirm").on("click",this.save),_("#setAmbientLight-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#setAmbientLight").on("open",function(e){_("#setAmbientLight-easingId").loadItems(He.createEasingItems())}),_("#setAmbientLight").on("closed",function(e){_("#setAmbientLight-easingId").clear()})},parseColor:function(e,t,i){return`RGB(${I.parseVariableNumber(e)}, ${I.parseVariableNumber(t)}, ${I.parseVariableNumber(i)})`},parse:function({red:e,green:t,blue:i,easingId:a,duration:n,wait:s}){e=I.words.push(this.parseColor(e,t,i)).push(I.parseEasing(a,n,s));return[{color:"scene"},{text:N.get("command.setAmbientLight")+": "},{text:e.join()}]},load:function({red:e=0,green:t=0,blue:i=0,easingId:a=He.easings[0].id,duration:n=0,wait:s=!1}){var r=D("setAmbientLight");r("red",e),r("green",t),r("blue",i),r("easingId",a),r("duration",n),r("wait",s),_("#setAmbientLight-red").getFocus("all")},save:function(){var e=g("setAmbientLight"),t=e("red"),i=e("green"),a=e("blue"),n=e("easingId"),s=e("duration"),e=e("wait");I.save({red:t,green:i,blue:a,easingId:n,duration:s,wait:e})}},I.cases.tintScreen={initialize:function(){_("#tintScreen-confirm").on("click",this.save),_("#tintScreen-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#tintScreen").on("open",function(e){_("#tintScreen-easingId").loadItems(He.createEasingItems())}),_("#tintScreen").on("closed",function(e){_("#tintScreen-easingId").clear(),_("#tintScreen-filter").clear()}),_("#tintScreen-tint-0, #tintScreen-tint-1, #tintScreen-tint-2, #tintScreen-tint-3").on("input",function(e){_("#tintScreen-filter").write([_("#tintScreen-tint-0").read(),_("#tintScreen-tint-1").read(),_("#tintScreen-tint-2").read(),_("#tintScreen-tint-3").read()])})},parseTint:function([e,t,i,a]){return`(${e}, ${t}, ${i}, ${a})`},parse:function({tint:e,easingId:t,duration:i,wait:a}){e=I.words.push(this.parseTint(e)).push(I.parseEasing(t,i,a));return[{color:"scene"},{text:N.get("command.tintScreen")+": "},{text:e.join()}]},load:function({tint:e=[0,0,0,0],easingId:t=He.easings[0].id,duration:i=0,wait:a=!1}){var n=D("tintScreen");n("tint-0",e[0]),n("tint-1",e[1]),n("tint-2",e[2]),n("tint-3",e[3]),n("filter",e),n("easingId",t),n("duration",i),n("wait",a),_("#tintScreen-tint-0").getFocus("all")},save:function(){var e=g("tintScreen"),t=e("tint-0"),i=e("tint-1"),a=e("tint-2"),n=e("tint-3"),s=e("easingId"),r=e("duration"),e=e("wait"),t=[t,i,a,n];I.save({tint:t,easingId:s,duration:r,wait:e})}},I.cases.setGameSpeed={initialize:function(){_("#setGameSpeed-confirm").on("click",this.save),_("#setGameSpeed-wait").loadItems([{name:"Yes",value:!0},{name:"No",value:!1}]),_("#setGameSpeed").on("open",function(e){_("#setGameSpeed-easingId").loadItems(He.createEasingItems())}),_("#setGameSpeed").on("closed",function(e){_("#setGameSpeed-easingId").clear()})},parse:function({speed:e,easingId:t,duration:i,wait:a}){e=I.words.push(I.parseVariableNumber(e)).push(I.parseEasing(t,i,a));return[{color:"system"},{text:N.get("command.setGameSpeed")+": "},{text:e.join()}]},load:function({speed:e=1,easingId:t=He.easings[0].id,duration:i=0,wait:a=!1}){var n=D("setGameSpeed");n("speed",e),n("easingId",t),n("duration",i),n("wait",a),_("#setGameSpeed-speed").getFocus("all")},save:function(){var e=g("setGameSpeed"),t=e("speed"),i=e("easingId"),a=e("duration"),e=e("wait");I.save({speed:t,easingId:i,duration:a,wait:e})}},I.cases.setCursor={initialize:function(){_("#setCursor-confirm").on("click",this.save)},parse:function({image:e}){return[{color:"system"},{text:N.get("command.setCursor")+": "},{text:I.parseFileName(e)}]},load:function({image:e=""}){D("setCursor")("image",e),_("#setCursor-image").getFocus()},save:function(){var e=g("setCursor")("image");I.save({image:e})}},I.cases.setTeamRelation={initialize:function(){_("#setTeamRelation-confirm").on("click",this.save),_("#setTeamRelation-relation").loadItems([{name:"Enemy",value:0},{name:"Friend",value:1}]),_("#setTeamRelation").on("open",function(e){var t=He.createTeamItems();_("#setTeamRelation-teamId1").loadItems(t),_("#setTeamRelation-teamId2").loadItems(t)}),_("#setTeamRelation").on("closed",function(e){_("#setTeamRelation-teamId1").clear(),_("#setTeamRelation-teamId2").clear()})},parseRelation:function(e){return N.get("command.setTeamRelation.relation."+e)},parse:function({teamId1:e,teamId2:t,relation:i}){e=I.words.push(I.parseTeam(e)).push(I.parseTeam(t)).push(this.parseRelation(i));return[{color:"system"},{text:N.get("command.setTeamRelation")+": "},{text:e.join()}]},load:function({teamId1:e=He.teams.list[0].id,teamId2:t=He.teams.list[0].id,relation:i=0}){var a=D("setTeamRelation");a("teamId1",e),a("teamId2",t),a("relation",i),_("#setTeamRelation-teamId1").getFocus()},save:function(){var e=g("setTeamRelation"),t=e("teamId1"),i=e("teamId2"),e=e("relation");if(t===i)return _("#setTeamRelation-teamId2").getFocus();I.save({teamId1:t,teamId2:i,relation:e})}},I.cases.switchCollisionSystem={initialize:function(){_("#switchCollisionSystem-confirm").on("click",this.save),_("#switchCollisionSystem-operation").loadItems([{name:"Enable Actor Collision",value:"enable-actor-collision"},{name:"Disable Actor Collision",value:"disable-actor-collision"},{name:"Enable Scene Collision",value:"enable-scene-collision"},{name:"Disable Scene Collision",value:"disable-scene-collision"}])},parse:function({operation:e}){return[{color:"system"},{text:N.get("command.switchCollisionSystem")+": "},{text:N.get("command.switchCollisionSystem."+e)}]},load:function({operation:e="enable-actor-collision"}){_("#switchCollisionSystem-operation").write(e),_("#switchCollisionSystem-operation").getFocus()},save:function(){var e=_("#switchCollisionSystem-operation").read();I.save({operation:e})}},I.cases.reset={parse:function(){return[{color:"system"},{text:N.get("command.reset")}]},save:function(){I.save({})}},I.cases.script={initialize:function(){_("#script-confirm").on("click",this.save)},parse:function({script:e}){var t=[],i=e.split("\n");let a=i.length;10<a&&(a=11,i[10]="......");for(let e=0;e<a;e++)0===e?t.push({color:"text"},{text:i[e]}):t.push({break:!0},{text:i[e]});return t},load:function({script:e=""}){_("#script-script").write(e),_("#script-script").getFocus("end")},save:function(){const i=_("#script-script").read();if(""===i)return _("#script-script").getFocus();try{new Function(i)}catch(e){var a=N.createGetter("confirmation");let t=!1;return O.confirm({message:e.message+`
`+a("compileError"),close:()=>{t||_("#script-script").getFocus()}},[{label:a("yes"),click:()=>{t=!0,I.save({script:i})}},{label:a("no")}])}I.save({script:i})}},I.custom={customFolder:null,commandNameMap:null,windowX:null,windowY:null,script:{id:"",parameters:null},windowFrame:_("#scriptCommand"),parameterPane:_("#scriptCommand-parameter-pane"),parameterGrid:_("#scriptCommand-parameter-grid"),initialize:function(){window.on("localize",this.windowLocalize),_("#scriptCommand-confirm").on("click",this.save);const e=[this.script];this.parameterPane.getData=()=>e,this.parameterPane.onResize=()=>{var e=i.clientHeight;this.windowFrame.style.height=e+78+"px",this.windowFrame.absolute(this.windowX,this.windowY)};var t=_("#scriptCommand-parameter-detail");const i=this.parameterGrid,a={box:t,grid:i,children:[]};t.wrap=a,this.parameterPane.createDetailBox=function(){return a},this.parameterPane.clear=function(){this.metas=[];var t=this["wraps"];if(0!==t.length){var{children:i,box:a}=t[0];let e=i.length;for(;0<=--e;)this.recycle(i[e]);a.meta=null,a.data=null,i.length=0,t.length=0}window.off("script-change",this.scriptChange)},this.windowFrame.on("closed",e=>{this.script.parameters=null,this.parameterPane.clear()})},parse:function(e,t){var i=He.scripts[e];const a=this.commandNameMap[e];if(void 0===i||void 0===a)return[{color:"invalid"},{text:N.get("command.invalidCommand")+": "+I.parseUnlinkedId(e)}];var n=this.script,e=(n.id=e,n.parameters=t,w.reconstruct(n),t=n.parameters,n.parameters=null,i.parameters);if(0===e.length)return[{color:"custom"},{text:a}];var s=I.words,r=i.manager.states;for(const u of e){var{type:o,key:l}=u,c=t[l];if(!1!==r[l])switch(o){case"boolean":case"number":s.push(c.toString());continue;case"string":s.push(`"${c}"`);continue;case"option":var h=u.options.indexOf(c);if(-1!==h){const a=u.dataItems[h]["name"];s.push(i.langMap.update().get(a))}continue;case"easing":s.push(He.easings.map[c].name);continue;case"team":s.push(He.teams.map[c].name);continue;case"variable":s.push(c?`{variable:${c}}`:N.get("common.none"));continue;case"file":case"image":case"audio":s.push(I.parseFileName(c));continue;case"number[]":c.length<=5?s.push(`[${c.join(", ")}]`):s.push(`[${c.slice(0,5).join(", ")}, ...]`);continue;case"string[]":var d=c.slice(0,5);for(let e=0;e<d.length;e++)d[e]=`"${I.parseMultiLineString(d[e])}"`;c.length<=5?s.push(`[${d.join(", ")}]`):s.push(`[${d.join(", ")}, ...]`);continue;case"keycode":s.push(c||N.get("common.none"));continue;case"color":s.push("#"+c);continue}}return[{color:"custom"},{text:a+": "},{text:s.join()}]},load:function(e,t){this.script.id=e,this.script.parameters=Object.clone(t),this.windowX=O.absolutePos.x,this.windowY=O.absolutePos.y,this.parameterPane.update();t=x.focusableSelector;this.parameterPane.querySelector(t)?.getFocus(),this.windowFrame.setTitle(this.commandNameMap[e])},save:function(){I.save(I.custom.script.parameters??{})},loadCommandList:async function(){if(He.commands){var e=Bt["list"],t=(this.customFolder||(e.data instanceof Promise&&await e.data,e.data.push(this.customFolder={class:"folder",value:"custom",expanded:!0,children:null})),[]),i={};for(const s of He.commands){var a,n=s.id;let e=He.scripts[n];!(e=e instanceof Promise?await e:e)||n in i||(a=s.alias||e.langMap.update().get(e.overview.plugin)||I.parseFileName(n),t.push({class:"custom",value:n,name:i[n]=a,keywords:s.keywords,unspacedName:String.compress(a)}))}this.customFolder.children=t,this.commandNameMap=i,Bt.windowLocalize(),Ee.createParents(t,this.customFolder)}},windowLocalize:function(e){I.custom.commandNameMap&&I.custom.loadCommandList()}},{widget:_("#command-widget"),searcher:_("#command-searcher"),list:_("#command-suggestions"),data:null,initialize:null,open:null,select:null,windowLocalize:null,windowClose:null,pointerdown:null,searcherKeydown:null,searcherInput:null,listKeydown:null,listPointerdown:null,listUpdate:null,listOpen:null}),Nt=(Bt.list.createIcon=null,Bt.list.searchNodesAlgorithm=null,Bt.list.updateCommandNames=null,Bt.list.createCommandTip=null,Bt.list.selectDefaultCommand=null,Bt.initialize=function(){this.widget.enableAmbient=!1,this.searcher.addCloseButton();var e=document.createElement("text"),t=this.searcher.input,e=(t.id="command-searcher-input",e.id="command-searcher-mark",e.textContent=">",this.searcher.insertBefore(e,t),this)["list"];e.bind(()=>this.data),e.creators.push(e.createCommandTip),this.data=R.get({local:"commands.json",type:"json"}).then(e=>{this.data=e}),window.on("localize",this.windowLocalize),this.widget.on("close",this.windowClose),this.searcher.on("keydown",this.searcherKeydown),this.searcher.on("input",this.searcherInput),this.searcher.on("compositionend",this.searcherInput),e.on("keydown",this.listKeydown),e.on("pointerdown",this.listPointerdown),e.on("update",this.listUpdate),e.on("open",this.listOpen)},Bt.open=function(){const e=I.target;e.scrollAndResize();var t=e.getSelectionPosition();if(t){O.open("command-widget");const{widget:a,list:e,searcher:n}=this;var i=t.x-5,t=t.y;a.x=i,a.y=t,a.style.left=i+"px",a.style.top=t+"px",e.initialized?(e.dispatchUpdateEvent(),e.resize()):(e.initialized=!0,e.updateCommandNames(),e.update(),e.selectDefaultCommand()),n.getFocus(),window.on("pointerdown",this.pointerdown,{capture:!0})}},Bt.select=function(e){O.close("command-widget"),I.open(e.value)},Bt.windowLocalize=function(e){var{list:t,data:i}=Bt;t.initialized&&(t.initialized=!1,t.textContent="",t.deleteNodeElements(i))},Bt.windowClose=function(e){Bt.searcher.deleteInputContent(),Bt.list.hide(),window.off("pointerdown",Bt.pointerdown,{capture:!0})},Bt.pointerdown=function(e){var{widget:t,list:i}=Bt;t.contains(e.target)||i.contains(e.target)||(e.preventDefault(),O.close("command-widget"))},Bt.searcherKeydown=function(e){switch(e.code){case"ArrowUp":case"ArrowDown":e.preventDefault(),Bt.list.selectRelative(e.code.slice(5).toLowerCase());break;case"PageUp":Bt.list.pageUp(!0);break;case"PageDown":Bt.list.pageDown(!0);break;case"Enter":case"NumpadEnter":var t=Bt.list.read();t&&!Bt.list.hasClass("hidden")&&(e.stopPropagation(),Bt.list.open(t))}},Bt.searcherInput=function(e){"insertCompositionText"!==e.inputType&&(e=String.compress(this.read()),Bt.list.searchNodes(e),Bt.list.selectDefaultCommand())},Bt.listKeydown=function(e){switch(e.code){case"Tab":e.preventDefault(),Bt.searcher.input.focus();break;case"Home":e.preventDefault(),this.scrollToHome();break;case"End":e.preventDefault(),this.scrollToEnd();break;case"PageUp":e.preventDefault(),this.pageUp(!0);break;case"PageDown":e.preventDefault(),this.pageDown(!0)}},Bt.listPointerdown=function(e){const t=e.target;if("NODE-ITEM"===t.tagName&&"folder"!==t.item.class){const i=e=>{this.pressing===i&&(this.pressing=null,t.contains(e.target))&&Bt.select(t.item)};this.pressing=i,window.on("pointerup",i,{once:!0})}},Bt.listUpdate=function(e){var{x:t,y:i}=Bt.widget,a=window.innerHeight-i-20,n=200<=a,a=n?Math.floor(a/20):Math.floor(i/20),a=Math.min(this.elements.count,a,30),n=n?i+20:i-20*a;0!==a?(this.style.left=t+"px",this.style.top=n+"px",this.style.height=20*a+"px",this.style.zIndex=O.frames.length-1,this.show()):this.hide()},Bt.listOpen=function(e){e=e.value;"folder"!==e.class&&e.element.parentNode&&Bt.select(e)},Bt.list.createIcon=function(e){var t=document.createElement("node-icon");return"folder"===e.class?t.addClass("icon-folder"):(t.addClass("icon-command"),t.addClass(e.class)),t},Bt.list.searchNodesAlgorithm=function(t,i,a){var n=t.length;for(let e=0;e<n;e++){var s=t[e];"custom"===s.class?(i.test(s.unspacedName)||i.test(s.class)||i.test(s.keywords))&&a.push(s):((i.test(s.unspacedName)||i.test(s.class)||i.test(s.value)||i.test(s.keywords))&&a.push(s),(s=s.children)instanceof Array&&this.searchNodesAlgorithm(s,i,a))}},Bt.list.updateCommandNames=function(){const o=(t,i)=>{var a=t.length;for(let e=0;e<a;e++){var n=t[e],s=n.value,r=i(s),r=(n.name=r,n.unspacedName=String.compress(r),n.children);r instanceof Array&&"custom"!==s&&o(r,i)}};return function(){o(this.data,N.createGetter("command"))}}(),Bt.list.createCommandTip=function(){const n=/\s*,\s*/;return function(e){var t=e.element,i=I.words.push(e.class);if("custom"!==e.class&&i.push(e.value),e.keywords)for(const a of e.keywords.split(n))i.push(a);t.addClass("command-suggestion-item"),t.setTooltip("Keywords: "+i.join())}}(),Bt.list.selectDefaultCommand=function(){var{selection:t,elements:i}=this,a=i["count"];if(t&&"folder"!==t.class)for(let e=0;e<a;e++)if(i[e].item===t)return void this.scrollToSelection("middle");for(let e=0;e<a;e++){var n=i[e].item;if("folder"!==n.class)return this.select(n),void this.scrollToSelection("middle")}},{list:_("#event-commands"),outerGutter:_("#event-commands-gutter-outer"),innerGutter:_("#event-commands-gutter-inner"),caches:[],types:null,inserting:!1,changed:!1,callback:null,initialize:null,open:null,save:null,resizeGutter:null,updateGutter:null,appendCommandsToCaches:null,clearCommandBuffers:null,windowLocalize:null,windowClose:null,windowClosed:null,windowResize:null,dataChange:null,listUpdate:null,listScroll:null,confirm:null,apply:null}),qt=(Nt.initialize=function(){var e={common:{name:"Common",value:"common"},initialize:{name:"Initialize",value:"initialize"},autorun:{name:"Autorun",value:"autorun"},collision:{name:"Collision",value:"collision"},hittrigger:{name:"HitTrigger",value:"hittrigger"},hitactor:{name:"HitActor",value:"hitactor"},destroy:{name:"Destroy",value:"destroy"},playerenter:{name:"PlayerEnter",value:"playerenter"},playerleave:{name:"PlayerLeave",value:"playerleave"},actorenter:{name:"ActorEnter",value:"actorenter"},actorleave:{name:"ActorLeave",value:"actorleave"},skillcast:{name:"SkillCast",value:"skillcast"},skilladd:{name:"SkillAdd",value:"skilladd"},skillremove:{name:"SkillRemove",value:"skillremove"},stateadd:{name:"StateAdd",value:"stateadd"},stateremove:{name:"StateRemove",value:"stateremove"},equipmentadd:{name:"EquipmentAdd",value:"equipmentadd"},equipmentremove:{name:"EquipmentRemove",value:"equipmentremove"},itemuse:{name:"ItemUse",value:"itemuse"},keydown:{name:"KeyDown",value:"keydown"},keyup:{name:"KeyUp",value:"keyup"},mousedown:{name:"MouseDown",value:"mousedown"},mousedownLB:{name:"MouseDown LB",value:"mousedownLB"},mousedownRB:{name:"MouseDown RB",value:"mousedownRB"},mouseup:{name:"MouseUp",value:"mouseup"},mouseupLB:{name:"MouseUp LB",value:"mouseupLB"},mouseupRB:{name:"MouseUp RB",value:"mouseupRB"},mousemove:{name:"MouseMove",value:"mousemove"},mouseenter:{name:"MouseEnter",value:"mouseenter"},mouseleave:{name:"MouseLeave",value:"mouseleave"},click:{name:"Click",value:"click"},doubleclick:{name:"DoubleClick",value:"doubleclick"},wheel:{name:"Wheel",value:"wheel"},input:{name:"Input",value:"input"},focus:{name:"Focus",value:"focus"},blur:{name:"Blur",value:"blur"}};this.types={all:Object.values(e),global:[e.common,e.keydown,e.keyup,e.mousedown,e.mouseup,e.mousemove,e.doubleclick,e.wheel],scene:[e.autorun],actor:[e.initialize,e.autorun,e.collision,e.hittrigger],skill:[e.skillcast,e.skilladd,e.skillremove],state:[e.stateadd,e.stateremove],equipment:[e.initialize,e.equipmentadd,e.equipmentremove],trigger:[e.hitactor,e.destroy],item:[e.itemuse],region:[e.autorun,e.playerenter,e.playerleave,e.actorenter,e.actorleave],light:[e.autorun],animation:[e.autorun],particle:[e.autorun],parallax:[e.autorun],tilemap:[e.autorun],element:[e.autorun,e.mousedown,e.mousedownLB,e.mousedownRB,e.mouseup,e.mouseupLB,e.mouseupRB,e.mousemove,e.mouseenter,e.mouseleave,e.click,e.doubleclick,e.wheel,e.input,e.focus,e.blur,e.destroy],relatedElements:[]},Object.defineProperty(this.list,"innerHeight",{configurable:!0,value:600});this.list.style.paddingBottom="590px",this.innerGutter.style.paddingBottom="580px",window.on("localize",this.windowLocalize),_("#event").on("close",this.windowClose),_("#event").on("closed",this.windowClosed),_("#event").on("resize",this.windowResize),_("#event").on("change",this.dataChange),this.list.on("update",this.listUpdate),this.list.on("scroll",this.listScroll),_("#event-confirm").on("click",this.confirm),_("#event-apply").on("click",this.apply)},Nt.open=function(e,t,i){this.callback=i??Function.empty,O.open("event"),_("#event-type").loadItems(M.getMergedItems(this.types[e],e+"-event"));i=t.commands;i.symbol||Object.defineProperty(i,"symbol",{configurable:!0,value:Symbol()});const a=i.symbol;let n=this.caches.find(e=>e.symbol===a);n||(n=Object.clone(i),Object.defineProperty(n,"symbol",{configurable:!0,value:a}));e=D("event");e("commands",n),e("type",t.type)},Nt.save=function(){var e=g("event"),t=e("commands"),i=Object.clone(t);return Object.defineProperty(i,"symbol",{configurable:!0,value:t.symbol}),{type:e("type"),commands:i}},Nt.resizeGutter=function(){var{outerGutter:t,innerGutter:i}=this,t=t.clientHeight;if(0!==t){var a=Math.ceil(t/20)+1,n=i.childNodes;let e=n.length;if(e!==a)if(e<a)for(;e<a;){var s=document.createElement("box");s.addClass("event-commands-line-number"),s.number=-1,i.appendChild(s),e++}else for(;--e>=a;)n[e].remove()}},Nt.updateGutter=function(e){var t=this["list"],i=t["scrollTop"],{outerGutter:a,innerGutter:n}=Nt,s=Math.floor(i/20)+1,r=t.elements.count+1;if(n.start!==s||e){n.start=s;var o=n.childNodes,l=o.length;for(let e=0;e<l;e++){var c=o[e],h=s+e;if(h<r)c.number!==h&&(c.number=h,c.textContent=h.toString());else{if(-1===c.number)break;c.number=-1,c.textContent=""}}}a.scrollTop=(i+1e-4)%20},Nt.appendCommandsToCaches=function(e){var t=this["caches"];t.append(e)&&10<t.length&&t.shift()},Nt.clearCommandBuffers=function(){var t=this["list"];for(const e of this.caches){t.deleteCommandBuffers(e);var i=e.history["stack"],a=i["length"];for(let e=0;e<a;e++){var n=i[e]["commands"];t.deleteCommandBuffers(n)}}},Nt.windowLocalize=function(e){var t=Nt.types,i=N.createGetter("eventTypes");for(const n of t.all){var a=i(n.value);""!==a&&(n.name=a)}for(const s of t.relatedElements)s.read()&&s.update()},Nt.windowClose=function(e){this.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedEvent")},[{label:e("yes"),click:()=>{var e=this.list.read();e.history.restoreState()?this.appendCommandsToCaches(e):this.caches.remove(e),this.changed=!1,O.close("event")}},{label:e("no")}]))}.bind(Nt),Nt.windowClosed=function(e){this.inserting=!1,this.callback=null,this.list.clear(),this.clearCommandBuffers()}.bind(Nt),Nt.windowResize=function(e){var t=Nt["list"],i=t.parentNode.clientHeight,i=Math.max(i-20,0),a=(Object.defineProperty(t,"innerHeight",{configurable:!0,value:i}),Nt)["innerGutter"],i=i-20,a=(t.style.paddingBottom=10+i+"px",a.style.paddingBottom=i+"px",t.resize(),t.scrollTop);t.scrollTop=0,t.scrollTop=a,Nt.resizeGutter(),Nt.updateGutter(!0)},Nt.dataChange=function(e){Nt.changed=!0},Nt.listUpdate=function(e){Nt.resizeGutter(),Nt.updateGutter(!0)},Nt.listScroll=function(e){Nt.updateGutter(!1)},Nt.confirm=function(e){this.apply(),O.close("event")}.bind(Nt),Nt.apply=function(e){var t;this.changed&&((t=this.list.read()).history.saveState(),this.appendCommandsToCaches(t)),(this.changed||this.inserting)&&(this.changed=!1,this.inserting=!1,this.callback())}.bind(Nt),{target:null,initialize:null,parseMathMethod:null,parseStringMethod:null,parseObjectProperty:null,parseElementProperty:null,parseOther:null,parseOperand:null,parse:null,open:null,save:null,windowClosed:null,confirm:null}),Dt=(qt.initialize=function(){_("#setNumber-operation").loadItems([{name:"Set",value:"set"},{name:"Add",value:"add"},{name:"Sub",value:"sub"},{name:"Mul",value:"mul"},{name:"Div",value:"div"},{name:"Mod",value:"mod"}]),_("#setNumber-operand-operation").loadItems([{name:"Add",value:"add"},{name:"Sub",value:"sub"},{name:"Mul",value:"mul"},{name:"Div",value:"div"},{name:"Mod",value:"mod"},{name:"(Add)",value:"add()"},{name:"(Sub)",value:"sub()"},{name:"(Mul)",value:"mul()"},{name:"(Div)",value:"div()"},{name:"(Mod)",value:"mod()"}]),_("#setNumber-operand-type").loadItems([{name:"Constant",value:"constant"},{name:"Variable",value:"variable"},{name:"Math",value:"math"},{name:"String",value:"string"},{name:"Object",value:"object"},{name:"Element",value:"element"},{name:"List",value:"list"},{name:"Parameter",value:"parameter"},{name:"Other",value:"other"}]),_("#setNumber-operand-type").enableHiddenMode().relate([{case:"constant",targets:[_("#setNumber-operand-constant-value")]},{case:"variable",targets:[_("#setNumber-operand-common-variable")]},{case:"math",targets:[_("#setNumber-operand-math-method")]},{case:"string",targets:[_("#setNumber-operand-string-method"),_("#setNumber-operand-common-variable")]},{case:"object",targets:[_("#setNumber-operand-object-property")]},{case:"element",targets:[_("#setNumber-operand-element-property"),_("#setNumber-operand-element-element")]},{case:"list",targets:[_("#setNumber-operand-common-variable"),_("#setNumber-operand-list-index")]},{case:"parameter",targets:[_("#setNumber-operand-parameter-key")]},{case:"other",targets:[_("#setNumber-operand-other-data")]}]),_("#setNumber-operand-type").on("write",e=>{let t="all";switch(e.value){case"variable":case"math":t="number";break;case"string":t="string";break;case"object":case"list":t="object"}_("#setNumber-operand-common-variable").filter=t}),_("#setNumber-operand-math-method").loadItems([{name:"Round",value:"round"},{name:"Floor",value:"floor"},{name:"Ceil",value:"ceil"},{name:"Sqrt",value:"sqrt"},{name:"Abs",value:"abs"},{name:"Random[0,1)",value:"random"},{name:"Random Int",value:"random-int"},{name:"Distance",value:"distance"},{name:"Horizontal Distance",value:"distance-x"},{name:"Vertical Distance",value:"distance-y"},{name:"Relative Angle",value:"relative-angle"}]),_("#setNumber-operand-math-method").enableHiddenMode().relate([{case:"round",targets:[_("#setNumber-operand-common-variable"),_("#setNumber-operand-math-decimals")]},{case:["floor","ceil","sqrt","abs"],targets:[_("#setNumber-operand-common-variable")]},{case:"random-int",targets:[_("#setNumber-operand-math-min"),_("#setNumber-operand-math-max")]},{case:["distance","distance-x","distance-y","relative-angle"],targets:[_("#setNumber-operand-math-startPosition"),_("#setNumber-operand-math-endPosition")]}]),_("#setNumber-operand-string-method").loadItems([{name:"Get Length",value:"length"},{name:"Parse Number",value:"parse"},{name:"Get Index of Substring",value:"search"}]),_("#setNumber-operand-string-method").enableHiddenMode().relate([{case:["length","parse"],targets:[_("#setNumber-operand-common-variable")]},{case:"search",targets:[_("#setNumber-operand-common-variable"),_("#setNumber-operand-string-search")]}]),_("#setNumber-operand-object-property").loadItems([{name:"Actor - X",value:"actor-x"},{name:"Actor - Y",value:"actor-y"},{name:"Actor - Screen X",value:"actor-screen-x"},{name:"Actor - Screen Y",value:"actor-screen-y"},{name:"Actor - Angle",value:"actor-angle"},{name:"Actor - Direction Angle",value:"actor-direction"},{name:"Actor - Movement Speed",value:"actor-movement-speed"},{name:"Actor - Collision Size",value:"actor-collision-size"},{name:"Actor - Collision Weight",value:"actor-collision-weight"},{name:"Actor - Item Quantity",value:"actor-inventory-item-quantity"},{name:"Actor - Equipment Quantity",value:"actor-inventory-equipment-quantity"},{name:"Actor - Inventory Money",value:"actor-inventory-money"},{name:"Actor - Inventory Used Space",value:"actor-inventory-used-space"},{name:"Actor - Inventory Version",value:"actor-inventory-version"},{name:"Actor - Skill Version",value:"actor-skill-version"},{name:"Actor - State Version",value:"actor-state-version"},{name:"Actor - Equipment Version",value:"actor-equipment-version"},{name:"Actor - Anim Current Time",value:"actor-animation-current-time"},{name:"Actor - Anim Duration",value:"actor-animation-duration"},{name:"Actor - Anim Progress",value:"actor-animation-progress"},{name:"Actor - Cooldown Time",value:"actor-cooldown-time"},{name:"Actor - Cooldown Duration",value:"actor-cooldown-duration"},{name:"Actor - Cooldown Progress",value:"actor-cooldown-progress"},{name:"Skill - Cooldown Time",value:"skill-cooldown-time"},{name:"Skill - Cooldown Duration",value:"skill-cooldown-duration"},{name:"Skill - Cooldown Progress",value:"skill-cooldown-progress"},{name:"State - Current Time",value:"state-current-time"},{name:"State - Duration",value:"state-duration"},{name:"State - Progress",value:"state-progress"},{name:"Equipment - Order in Inventory",value:"equipment-order"},{name:"Item - Order in Inventory",value:"item-order"},{name:"Item - Quantity",value:"item-quantity"},{name:"Trigger - Speed",value:"trigger-speed"},{name:"Trigger - Angle",value:"trigger-angle"},{name:"List - Length",value:"list-length"}]),_("#setNumber-operand-object-property").enableHiddenMode().relate([{case:["actor-x","actor-y","actor-screen-x","actor-screen-y","actor-angle","actor-direction","actor-movement-speed","actor-collision-size","actor-collision-weight","actor-inventory-money","actor-inventory-used-space","actor-inventory-version","actor-skill-version","actor-state-version","actor-equipment-version","actor-animation-current-time","actor-animation-duration","actor-animation-progress"],targets:[_("#setNumber-operand-common-actor")]},{case:"actor-inventory-item-quantity",targets:[_("#setNumber-operand-common-actor"),_("#setNumber-operand-object-itemId")]},{case:"actor-inventory-equipment-quantity",targets:[_("#setNumber-operand-common-actor"),_("#setNumber-operand-object-equipmentId")]},{case:["actor-cooldown-time","actor-cooldown-duration","actor-cooldown-progress"],targets:[_("#setNumber-operand-common-actor"),_("#setNumber-operand-cooldown-key")]},{case:["skill-cooldown-time","skill-cooldown-duration","skill-cooldown-progress"],targets:[_("#setNumber-operand-common-skill")]},{case:["state-current-time","state-duration","state-progress"],targets:[_("#setNumber-operand-common-state")]},{case:"equipment-order",targets:[_("#setNumber-operand-common-equipment")]},{case:["item-order","item-quantity"],targets:[_("#setNumber-operand-common-item")]},{case:["trigger-speed","trigger-angle"],targets:[_("#setNumber-operand-common-trigger")]},{case:"list-length",targets:[_("#setNumber-operand-common-variable")]}]),_("#setNumber-operand-element-property").loadItems([{name:"Element - Number of Children",value:"element-children-count"},{name:"Transform - Anchor X",value:"transform-anchorX"},{name:"Transform - Anchor Y",value:"transform-anchorY"},{name:"Transform - X",value:"transform-x"},{name:"Transform - X2",value:"transform-x2"},{name:"Transform - Y",value:"transform-y"},{name:"Transform - Y2",value:"transform-y2"},{name:"Transform - Width",value:"transform-width"},{name:"Transform - Width2",value:"transform-width2"},{name:"Transform - Height",value:"transform-height"},{name:"Transform - Height2",value:"transform-height2"},{name:"Transform - Rotation",value:"transform-rotation"},{name:"Transform - Scale X",value:"transform-scaleX"},{name:"Transform - Scale Y",value:"transform-scaleY"},{name:"Transform - Skew X",value:"transform-skewX"},{name:"Transform - Skew Y",value:"transform-skewY"},{name:"Transform - Opacity",value:"transform-opacity"},{name:"Text - Text Width",value:"text-textWidth"},{name:"Text - Text Height",value:"text-textHeight"},{name:"Text Box - Number",value:"textBox-number"},{name:"Dialog Box - Print End X",value:"dialogBox-printEndX"},{name:"Dialog Box - Print End Y",value:"dialogBox-printEndY"}]),_("#setNumber-operand-other-data").loadItems([{name:"Event Trigger Button",value:"trigger-button"},{name:"Event Trigger Wheel Delta Y",value:"trigger-wheel-y"},{name:"Mouse Screen X",value:"mouse-screen-x"},{name:"Mouse Screen Y",value:"mouse-screen-y"},{name:"Mouse Scene X",value:"mouse-scene-x"},{name:"Mouse Scene Y",value:"mouse-scene-y"},{name:"Start Position X",value:"start-position-x"},{name:"Start Position Y",value:"start-position-y"},{name:"Camera X",value:"camera-x"},{name:"Camera Y",value:"camera-y"},{name:"Camera Zoom",value:"camera-zoom"},{name:"Screen Width",value:"screen-width"},{name:"Screen Height",value:"screen-height"},{name:"Scene Width",value:"scene-width"},{name:"Scene Height",value:"scene-height"},{name:"Play Time",value:"play-time"},{name:"Elapsed Time",value:"elapsed-time"},{name:"Delta Time",value:"delta-time"},{name:"Raw Delta Time",value:"raw-delta-time"},{name:"Number of Party Members",value:"party-member-count"}]),_("#setNumber-operand").on("closed",this.windowClosed),_("#setNumber-operand-confirm").on("click",this.confirm)},qt.parseMathMethod=function(e){var t=e.method,i=N.get("command.setNumber.math."+t);switch(t){case"round":var a=I.parseVariable(e.variable),n=e.decimals;return i+`(${a}${n?", "+n:""})`;case"floor":case"ceil":case"sqrt":case"abs":return i+`(${I.parseVariable(e.variable)})`;case"random":return i+"[0,1)";case"random-int":return i+`[${I.parseVariableNumber(e.min)},${I.parseVariableNumber(e.max)}]`;case"distance":case"distance-x":case"distance-y":case"relative-angle":return i+`(${I.parsePosition(e.start)}, ${I.parsePosition(e.end)})`}},qt.parseStringMethod=function(e){var t=e.method,i=N.get("command.setNumber.string."+t);switch(t){case"length":case"parse":var a=e.variable;return i+`(${I.parseVariable(a)})`;case"search":var{variable:a,search:n}=e;return i+`(${I.parseVariable(a)}, ${I.parseVariableString(n)})`}},qt.parseObjectProperty=function(e){var t=N.get("command.setNumber.object."+e.property);switch(e.property){case"actor-x":case"actor-y":case"actor-screen-x":case"actor-screen-y":case"actor-angle":case"actor-direction":case"actor-movement-speed":case"actor-collision-size":case"actor-collision-weight":case"actor-inventory-money":case"actor-inventory-used-space":case"actor-inventory-version":case"actor-skill-version":case"actor-state-version":case"actor-equipment-version":case"actor-animation-current-time":case"actor-animation-duration":case"actor-animation-progress":return I.parseActor(e.actor)+" -> "+t;case"actor-inventory-item-quantity":return`${I.parseActor(e.actor)} -> ${I.parseFileName(e.itemId)}.`+t;case"actor-inventory-equipment-quantity":return`${I.parseActor(e.actor)} -> ${I.parseFileName(e.equipmentId)}.`+t;case"actor-cooldown-time":case"actor-cooldown-duration":case"actor-cooldown-progress":var i=I.parseVariableEnum("cooldown-key",e.key);return I.parseActor(e.actor)+` -> ${t}(${i})`;case"skill-cooldown-time":case"skill-cooldown-duration":case"skill-cooldown-progress":return I.parseSkill(e.skill)+" -> "+t;case"state-current-time":case"state-duration":case"state-progress":return I.parseState(e.state)+" -> "+t;case"equipment-order":return I.parseEquipment(e.equipment)+" -> "+t;case"item-order":case"item-quantity":return I.parseItem(e.item)+" -> "+t;case"trigger-speed":case"trigger-angle":return I.parseTrigger(e.trigger)+" -> "+t;case"list-length":return I.parseVariable(e.variable)+" -> "+t}},qt.parseElementProperty=function(e){return I.parseElement(e.element)+" -> "+N.get("command.setNumber.element."+e.property)},qt.parseOther=function(e){return N.get("command.setNumber.other."+e.data)},qt.parseOperand=function(e){switch(e.type){case"constant":return e.value.toString();case"variable":return I.parseVariable(e.variable);case"math":return this.parseMathMethod(e);case"string":return this.parseStringMethod(e);case"object":return this.parseObjectProperty(e);case"element":return this.parseElementProperty(e);case"list":return I.parseListItem(e.variable,e.index);case"parameter":return I.parseParameter(e.key);case"other":return this.parseOther(e)}},qt.parse=function(e,t,i){let a,n;if(0===i)switch(a=_("#setNumber-operation").read()){case"set":n="= ";break;case"add":n="+= ";break;case"sub":n="-= ";break;case"mul":n="*= ";break;case"div":n="/= ";break;case"mod":n="%= "}else switch((a=e.operation).replace("()","")){case"add":n="+ ";break;case"sub":n="- ";break;case"mul":n="* ";break;case"div":n="/ ";break;case"mod":n="% "}let s=this.parseOperand(e,!1);e=a.includes("()"),t=t[i+1]?.operation.includes("()");return!e&&t&&(s="("+s),e&&!t&&(s+=")"),n+s},qt.open=function(e={operation:"add",type:"constant",value:0}){O.open("setNumber-operand"),0===this.target.start?(_("#setNumber-operation").save(),_("#setNumber-operation").show(),_("#setNumber-operation").getFocus(),_("#setNumber-operand-operation").hide()):(_("#setNumber-operation").hide(),_("#setNumber-operand-operation").show(),_("#setNumber-operand-operation").getFocus()),_("#setNumber-operand-cooldown-key").loadItems(M.getStringItems("cooldown-key"));var t=D("setNumber-operand");let i=0,a="round",n=0,s=0,r=1,o={type:"actor",actor:{type:"trigger"}},l={type:"actor",actor:{type:"trigger"}},c="length",h="",d={type:"local",key:""},u="actor-x",p="",m="",g="element-children-count",f={type:"trigger"},v={type:"trigger"},b={type:"trigger"},y={type:"trigger"},w={type:"trigger"},x={type:"trigger"},k={type:"trigger"},T=M.getDefStringId("cooldown-key"),I=0,C="",E="trigger-button";switch(e.type){case"constant":i=e.value;break;case"variable":d=e.variable;break;case"math":a=e.method,d=e.variable??d,n=e.decimals??n,s=e.min??s,r=e.max??r,o=e.start??o,l=e.end??l;break;case"string":c=e.method,d=e.variable,h=e.search??h;break;case"object":u=e.property,p=e.itemId??p,m=e.equipmentId??m,v=e.actor??v,b=e.skill??b,y=e.state??y,w=e.equipment??w,x=e.item??x,k=e.trigger??k,T=e.key??T,d=e.variable??d;break;case"element":g=e.property,f=e.element;break;case"list":d=e.variable,I=e.index;break;case"parameter":C=e.key;break;case"other":E=e.data}t("operation",e.operation),t("type",e.type),t("constant-value",i),t("math-method",a),t("string-method",c),t("object-property",u),t("object-itemId",p),t("object-equipmentId",m),t("element-property",g),t("element-element",f),t("common-variable",d),t("common-actor",v),t("common-skill",b),t("common-state",y),t("common-equipment",w),t("common-item",x),t("common-trigger",k),t("string-search",h),t("math-decimals",n),t("math-min",s),t("math-max",r),t("math-startPosition",o),t("math-endPosition",l),t("cooldown-key",T),t("list-index",I),t("parameter-key",C),t("other-data",E)},qt.save=function(){var e=g("setNumber-operand"),t=e("operation"),i=e("type");let a;switch(i){case"constant":var n=e("constant-value");a={operation:t,type:i,value:n};break;case"variable":n=e("common-variable");if(C.isNone(n))return _("#setNumber-operand-common-variable").getFocus();a={operation:t,type:i,variable:n};break;case"math":var s=e("math-method");switch(s){case"round":var r=e("common-variable");if(C.isNone(r))return _("#setNumber-operand-common-variable").getFocus();var o=e("math-decimals");a={operation:t,type:i,method:s,variable:r,decimals:o};break;case"floor":case"ceil":case"sqrt":case"abs":r=e("common-variable");if(C.isNone(r))return _("#setNumber-operand-common-variable").getFocus();a={operation:t,type:i,method:s,variable:r};break;case"random":a={operation:t,type:i,method:s};break;case"random-int":o=e("math-min"),r=e("math-max");a={operation:t,type:i,method:s,min:o,max:r};break;case"distance":case"distance-x":case"distance-y":case"relative-angle":o=e("math-startPosition"),r=e("math-endPosition");a={operation:t,type:i,method:s,start:o,end:r}}break;case"string":var l=e("string-method"),c=e("common-variable");if(C.isNone(c))return _("#setNumber-operand-common-variable").getFocus();switch(l){case"length":case"parse":a={operation:t,type:i,method:l,variable:c};break;case"search":var h=e("string-search");if(""===h)return _("#setNumber-operand-string-search").getFocus();a={operation:t,type:i,method:l,variable:c,search:h}}break;case"object":var d=e("object-property");switch(d){case"actor-x":case"actor-y":case"actor-screen-x":case"actor-screen-y":case"actor-angle":case"actor-direction":case"actor-movement-speed":case"actor-collision-size":case"actor-collision-weight":case"actor-inventory-money":case"actor-inventory-used-space":case"actor-inventory-version":case"actor-skill-version":case"actor-state-version":case"actor-equipment-version":case"actor-animation-current-time":case"actor-animation-duration":case"actor-animation-progress":var u=e("common-actor");a={operation:t,type:i,property:d,actor:u};break;case"actor-inventory-item-quantity":var u=e("common-actor"),p=e("object-itemId");if(""===p)return _("#setNumber-operand-object-itemId").getFocus();a={operation:t,type:i,property:d,actor:u,itemId:p};break;case"actor-inventory-equipment-quantity":u=e("common-actor"),p=e("object-equipmentId");if(""===p)return _("#setNumber-operand-object-equipmentId").getFocus();a={operation:t,type:i,property:d,actor:u,equipmentId:p};break;case"actor-cooldown-time":case"actor-cooldown-duration":case"actor-cooldown-progress":u=e("common-actor"),p=e("cooldown-key");if(""===p)return _("#setNumber-operand-cooldown-key").getFocus();a={operation:t,type:i,property:d,actor:u,key:p};break;case"skill-cooldown-time":case"skill-cooldown-duration":case"skill-cooldown-progress":u=e("common-skill");a={operation:t,type:i,property:d,skill:u};break;case"state-current-time":case"state-duration":case"state-progress":p=e("common-state");a={operation:t,type:i,property:d,state:p};break;case"equipment-order":u=e("common-equipment");a={operation:t,type:i,property:d,equipment:u};break;case"item-order":case"item-quantity":p=e("common-item");a={operation:t,type:i,property:d,item:p};break;case"trigger-speed":case"trigger-angle":u=e("common-trigger");a={operation:t,type:i,property:d,trigger:u};break;case"list-length":p=e("common-variable");if(C.isNone(p))return _("#setNumber-operand-common-variable").getFocus();a={operation:t,type:i,property:d,variable:p}}break;case"element":var n=e("element-property"),m=e("element-element");a={operation:t,type:i,property:n,element:m};break;case"list":n=e("common-variable"),m=e("list-index");if(C.isNone(n))return _("#setNumber-operand-common-variable").getFocus();a={operation:t,type:i,variable:n,index:m};break;case"parameter":n=e("parameter-key");if(""===n)return _("#setNumber-operand-parameter-key").getFocus();a={operation:t,type:i,key:n};break;case"other":m=e("other-data");a={operation:t,type:i,data:m}}return _("#setNumber-operation").save(),O.close("setNumber-operand"),a},qt.windowClosed=function(e){_("#setNumber-operation").restore()},qt.confirm=function(e){return qt.target.save()},{target:null,commands:null,initialize:null,parse:null,open:null,save:null,windowClosed:null,confirm:null}),_t=(Dt.initialize=function(){_("#if-branch-mode").loadItems([{name:"Meet All",value:"all"},{name:"Meet Any",value:"any"}]),_("#if-branch").on("closed",this.windowClosed),_("#if-branch-confirm").on("click",this.confirm)},Dt.parse=function(e){var t=I.words;let i;switch(e.mode){case"all":i=" && ";break;case"any":i=" || "}for(const a of e.conditions)t.push(_t.parse(a));return t.join(i)},Dt.open=function(e){this.target.inserting?(_t.target=this.target,_t.open()):(O.open("if-branch"),_("#if-branch-mode").write(e.mode),_("#if-branch-conditions").write(e.conditions.slice()),_("#if-branch-conditions").getFocus(),this.commands=e.commands)},Dt.save=function(){var e,t,i;return this.target.inserting?void 0!==(i=_t.save())?{mode:"all",conditions:[i],commands:[]}:void 0:(i=_("#if-branch-mode").read(),0===(e=(t=_("#if-branch-conditions")).read()).length?t.getFocus():(t=this.commands,O.close("if-branch"),{mode:i,conditions:e,commands:t}))},Dt.windowClosed=function(e){Dt.commands=null,_("#if-branch-conditions").clear()},Dt.confirm=function(e){return Dt.target.save()},{type:"condition",target:null,initialize:null,parseBooleanOperation:null,parseBooleanOperand:null,parseNumberOperation:null,parseNumberOperand:null,parseStringOperation:null,parseStringOperand:null,parseObjectOperation:null,parseObjectOperand:null,parseActorOperation:null,parseElementOperation:null,parseKeyboardState:null,parseMouseButton:null,parseMouseState:null,parseListOperation:null,parseOther:null,parse:null,open:null,save:null,confirm:null}),Ot=(_t.initialize=function(){_("#if-condition-type").loadItems([{name:"Boolean",value:"boolean"},{name:"Number",value:"number"},{name:"String",value:"string"},{name:"Object",value:"object"},{name:"Actor",value:"actor"},{name:"Element",value:"element"},{name:"Keyboard",value:"keyboard"},{name:"Mouse",value:"mouse"},{name:"List",value:"list"},{name:"Other",value:"other"}]),_("#if-condition-type").enableHiddenMode().relate([{case:"boolean",targets:[_("#if-condition-common-variable"),_("#if-condition-boolean-operation"),_("#if-condition-boolean-operand-type")]},{case:"number",targets:[_("#if-condition-common-variable"),_("#if-condition-number-operation"),_("#if-condition-number-operand-type")]},{case:"string",targets:[_("#if-condition-common-variable"),_("#if-condition-string-operation"),_("#if-condition-string-operand-type")]},{case:"object",targets:[_("#if-condition-common-variable"),_("#if-condition-object-operation")]},{case:"actor",targets:[_("#if-condition-common-actor"),_("#if-condition-actor-operation")]},{case:"element",targets:[_("#if-condition-common-element"),_("#if-condition-element-operation")]},{case:"keyboard",targets:[_("#if-condition-keyboard-keycode"),_("#if-condition-keyboard-state")]},{case:"mouse",targets:[_("#if-condition-mouse-button"),_("#if-condition-mouse-state")]},{case:"list",targets:[_("#if-condition-common-variable"),_("#if-condition-list-operation"),_("#if-condition-operand-variable")]},{case:"other",targets:[_("#if-condition-other-key")]}]),_("#if-condition-type").on("write",e=>{let t="all",i="all";switch(e.value){case"boolean":t=i="boolean";break;case"number":t=i="number";break;case"string":t=i="string";break;case"object":t=i="object";break;case"list":t="object",i="all"}_("#if-condition-common-variable").filter=t,_("#if-condition-operand-variable").filter=i}),_("#if-condition-boolean-operation").loadItems([{name:"==",value:"equal"},{name:"!=",value:"unequal"}]),_("#if-condition-boolean-operand-type").loadItems([{name:"None",value:"none"},{name:"Constant",value:"constant"},{name:"Variable",value:"variable"}]),_("#if-condition-boolean-operand-type").enableHiddenMode().relate([{case:"constant",targets:[_("#if-condition-boolean-constant-value")]},{case:"variable",targets:[_("#if-condition-operand-variable")]}]),_("#if-condition-boolean-constant-value").loadItems([{name:"False",value:!1},{name:"True",value:!0}]),_("#if-condition-number-operation").loadItems([{name:"==",value:"equal"},{name:"!=",value:"unequal"},{name:">=",value:"greater-or-equal"},{name:"<=",value:"less-or-equal"},{name:">",value:"greater"},{name:"<",value:"less"}]),_("#if-condition-number-operand-type").loadItems([{name:"None",value:"none"},{name:"Constant",value:"constant"},{name:"Variable",value:"variable"}]),_("#if-condition-number-operand-type").enableHiddenMode().relate([{case:"constant",targets:[_("#if-condition-number-constant-value")]},{case:"variable",targets:[_("#if-condition-operand-variable")]}]),_("#if-condition-string-operation").loadItems([{name:"==",value:"equal"},{name:"!=",value:"unequal"},{name:"Include",value:"include"},{name:"Exclude",value:"exclude"}]),_("#if-condition-string-operand-type").loadItems([{name:"None",value:"none"},{name:"Constant",value:"constant"},{name:"Variable",value:"variable"},{name:"Enumeration",value:"enum"}]),_("#if-condition-string-operand-type").enableHiddenMode().relate([{case:"constant",targets:[_("#if-condition-string-constant-value")]},{case:"variable",targets:[_("#if-condition-operand-variable")]},{case:"enum",targets:[_("#if-condition-string-enum-stringId")]}]),_("#if-condition-object-operation").loadItems([{name:"==",value:"equal"},{name:"!=",value:"unequal"},{name:"Is Actor",value:"is-actor"},{name:"Is Skill",value:"is-skill"},{name:"Is State",value:"is-state"},{name:"Is Equipment",value:"is-equipment"},{name:"Is Item",value:"is-item"},{name:"Is Trigger",value:"is-trigger"},{name:"Is Light",value:"is-light"},{name:"Is Element",value:"is-element"}]),_("#if-condition-object-operation").enableHiddenMode().relate([{case:["equal","unequal"],targets:[_("#if-condition-object-operand-type")]}]),_("#if-condition-object-operand-type").loadItems([{name:"None",value:"none"},{name:"Actor",value:"actor"},{name:"Skill",value:"skill"},{name:"State",value:"state"},{name:"Equipment",value:"equipment"},{name:"Item",value:"item"},{name:"Trigger",value:"trigger"},{name:"Light",value:"light"},{name:"Element",value:"element"},{name:"Variable",value:"variable"}]),_("#if-condition-object-operand-type").enableHiddenMode().relate([{case:"actor",targets:[_("#if-condition-common-actor")]},{case:"skill",targets:[_("#if-condition-common-skill")]},{case:"state",targets:[_("#if-condition-common-state")]},{case:"equipment",targets:[_("#if-condition-common-equipment")]},{case:"item",targets:[_("#if-condition-common-item")]},{case:"trigger",targets:[_("#if-condition-common-trigger")]},{case:"light",targets:[_("#if-condition-common-light")]},{case:"element",targets:[_("#if-condition-common-element")]},{case:"variable",targets:[_("#if-condition-operand-variable")]}]),_("#if-condition-actor-operation").loadItems([{name:"Present and Active",value:"present-active"},{name:"Present",value:"present"},{name:"Absent",value:"absent"},{name:"active",value:"active"},{name:"inactive",value:"inactive"},{name:"Has Targets",value:"has-targets"},{name:"Has No Targets",value:"has-no-targets"},{name:"In Screen",value:"in-screen"},{name:"Is Player Actor",value:"is-player"},{name:"Is Party Member",value:"is-member"},{name:"Has Skill",value:"has-skill"},{name:"Has State",value:"has-state"},{name:"Has Items",value:"has-items"},{name:"Has Equipments",value:"has-equipments"},{name:"Equipped",value:"equipped"}]),_("#if-condition-actor-operation").enableHiddenMode().relate([{case:"has-skill",targets:[_("#if-condition-actor-skillId")]},{case:"has-state",targets:[_("#if-condition-actor-stateId")]},{case:"has-items",targets:[_("#if-condition-actor-itemId"),_("#if-condition-actor-quantity")]},{case:"has-equipments",targets:[_("#if-condition-actor-equipmentId"),_("#if-condition-actor-quantity")]},{case:"equipped",targets:[_("#if-condition-actor-equipmentId")]}]),_("#if-condition-element-operation").loadItems([{name:"Present",value:"present"},{name:"Absent",value:"absent"},{name:"Visible",value:"visible"},{name:"Invisible",value:"invisible"},{name:"Dialog Box - is Paused",value:"dialogbox-is-paused"},{name:"Dialog Box - is Updating",value:"dialogbox-is-updating"},{name:"Dialog Box - is Waiting",value:"dialogbox-is-waiting"},{name:"Dialog Box - is Complete",value:"dialogbox-is-complete"}]),_("#if-condition-keyboard-state").loadItems([{name:"Pressed",value:"pressed"},{name:"Released",value:"released"}]),_("#if-condition-mouse-button").loadItems([{name:"Left Button",value:0},{name:"Middle Button",value:1},{name:"Right Button",value:2},{name:"Back Button",value:3},{name:"Forward Button",value:4}]),_("#if-condition-mouse-state").loadItems([{name:"Pressed",value:"pressed"},{name:"Released",value:"released"}]),_("#if-condition-list-operation").loadItems([{name:"Include",value:"include"},{name:"Exclude",value:"exclude"}]),_("#if-condition-other-key").loadItems([{name:"Mouse has entered the window",value:"mouse-entered"},{name:"Mouse has left the window",value:"mouse-left"}]),_("#if-condition-confirm").on("click",this.confirm)},_t.parseBooleanOperation=function({operation:e}){switch(e){case"equal":return"==";case"unequal":return"!="}},_t.parseBooleanOperand=function({operand:e}){switch(e.type){case"none":return N.get("common.none");case"constant":return e.value.toString();case"variable":return I.parseVariable(e.variable)}},_t.parseNumberOperation=function({operation:e}){switch(e){case"equal":return"==";case"unequal":return"!=";case"greater-or-equal":return">=";case"less-or-equal":return"<=";case"greater":return">";case"less":return"<"}},_t.parseNumberOperand=function({operand:e}){switch(e.type){case"none":return N.get("common.none");case"constant":return e.value.toString();case"variable":return I.parseVariable(e.variable)}},_t.parseStringOperation=function({operation:e}){switch(e){case"equal":return"==";case"unequal":return"!=";default:return N.get("command.if.string."+e)}},_t.parseStringOperand=function({operand:e}){switch(e.type){case"none":return N.get("common.none");case"constant":return`"${I.parseMultiLineString(e.value)}"`;case"variable":return I.parseVariable(e.variable);case"enum":return I.parseEnumStringTag(e.stringId)}},_t.parseObjectOperation=function({operation:e}){switch(e){case"equal":return"==";case"unequal":return"!=";default:return N.get("command.if.object."+e)}},_t.parseObjectOperand=function({operand:e}){if(!e)return"";switch(e.type){case"none":return N.get("common.none");case"actor":return I.parseActor(e.actor);case"skill":return I.parseSkill(e.skill);case"state":return I.parseState(e.state);case"equipment":return I.parseEquipment(e.equipment);case"item":return I.parseItem(e.item);case"trigger":return I.parseTrigger(e.trigger);case"light":return I.parseLight(e.light);case"element":return I.parseElement(e.element);case"variable":return I.parseVariable(e.variable)}},_t.parseActorOperation=function({operation:e,itemId:t,equipmentId:i,skillId:a,stateId:n,quantity:s}){var r=N.get("command.if.actor."+e);switch(e){case"has-skill":return r+" "+I.parseFileName(a);case"has-state":return r+" "+I.parseFileName(n);case"has-items":var o=r+" "+I.parseFileName(t);return 1===s?o:o+" x "+s;case"has-equipments":o=r+" "+I.parseFileName(i);return 1===s?o:o+" x "+s;case"equipped":return r+" "+I.parseFileName(i);default:return r}},_t.parseElementOperation=function({operation:e}){return N.get("command.if.element."+e)},_t.parseKeyboardState=function(e){return N.get("command.if.keyboard."+e)},_t.parseMouseButton=function(e){return N.get("command.if.mouse.button."+e)},_t.parseMouseState=function(e){return N.get("command.if.mouse."+e)},_t.parseListOperation=function({operation:e}){return N.get("command.if.list."+e)},_t.parseOther=function({key:e}){return N.get("command.if.other."+e)},_t.parse=function(e){switch(e.type){case"boolean":return I.parseVariable(e.variable)+` ${this.parseBooleanOperation(e)} `+this.parseBooleanOperand(e);case"number":return I.parseVariable(e.variable)+` ${this.parseNumberOperation(e)} `+this.parseNumberOperand(e);case"string":return I.parseVariable(e.variable)+` ${this.parseStringOperation(e)} `+this.parseStringOperand(e);case"object":return I.parseVariable(e.variable)+` ${this.parseObjectOperation(e)} `+this.parseObjectOperand(e);case"actor":return I.parseActor(e.actor)+" "+this.parseActorOperation(e);case"element":return I.parseElement(e.element)+" "+this.parseElementOperation(e);case"keyboard":var t=e.keycode;return N.get("command.if.keyboard")+`["${t}"] `+this.parseKeyboardState(e.state);case"mouse":t=this.parseMouseButton(e.button);return N.get("command.if.mouse")+`[${t}] `+this.parseMouseState(e.state);case"list":return I.parseVariable(e.list)+` ${this.parseListOperation(e)} `+I.parseVariable(e.target);case"other":return this.parseOther(e)}},_t.open=function(e={type:"number",variable:{type:"local",key:""},operation:"equal",operand:{type:"constant",value:0}}){O.open("if-condition");var t=D("if-condition"),i={type:"local",key:""};let a=i,n="equal",s="constant",r=!0,o="equal",l="constant",c=0,h="equal",d="constant",u="",p="",m="equal",g="none",f=i,v={type:"trigger"},b={type:"trigger"},y={type:"trigger"},w={type:"trigger"},x={type:"trigger"},k={type:"trigger"},T={type:"trigger"},I={type:"trigger"},C="present-active",E="",M="",S="",A="",P=1,L="present",R="",F="pressed",z=0,B="pressed",N="include",q="mouse-entered";switch(e.type){case"boolean":a=e.variable,n=e.operation,s=e.operand.type,r=e.operand.value??r,f=e.operand.variable??f;break;case"number":a=e.variable,o=e.operation,l=e.operand.type,c=e.operand.value??c,f=e.operand.variable??f;break;case"string":a=e.variable,h=e.operation,d=e.operand.type,u=e.operand.value??u,p=e.operand.stringId??p,f=e.operand.variable??f;break;case"object":a=e.variable,m=e.operation,g=e.operand?.type??g,f=e.operand?.variable??f,v=e.operand?.actor??v,b=e.operand?.skill??b,y=e.operand?.state??y,w=e.operand?.equipment??w,x=e.operand?.item??x,k=e.operand?.trigger??k,T=e.operand?.light??T,I=e.operand?.element??I;break;case"actor":v=e.actor,C=e.operation,E=e.skillId??E,M=e.stateId??M,S=e.itemId??S,A=e.equipmentId??A,P=e.quantity??P;break;case"element":I=e.element,L=e.operation;break;case"keyboard":R=e.keycode,F=e.state;break;case"mouse":z=e.button,B=e.state;break;case"list":a=e.list,N=e.operation,f=e.target;break;case"other":q=e.key}t("type",e.type),t("common-variable",a),t("boolean-operation",n),t("boolean-operand-type",s),t("boolean-constant-value",r),t("number-operation",o),t("number-operand-type",l),t("number-constant-value",c),t("string-operation",h),t("string-operand-type",d),t("string-constant-value",u),t("string-enum-stringId",p),t("object-operation",m),t("object-operand-type",g),t("list-operation",N),t("operand-variable",f),t("common-actor",v),t("common-skill",b),t("common-state",y),t("common-equipment",w),t("common-item",x),t("common-trigger",k),t("common-light",T),t("common-element",I),t("actor-operation",C),t("actor-skillId",E),t("actor-stateId",M),t("actor-itemId",S),t("actor-equipmentId",A),t("actor-quantity",P),t("element-operation",L),t("keyboard-keycode",R),t("keyboard-state",F),t("mouse-button",z),t("mouse-state",B),t("other-key",q),_("#if-condition-type").getFocus()},_t.save=function(){var t=g("if-condition"),i=t("type");let a;switch(i){case"boolean":{var n=t("common-variable");if(C.isNone(n))return _("#if-condition-common-variable").getFocus();var s=t("boolean-operation");let e;switch(t("boolean-operand-type")){case"none":e={type:"none"};break;case"constant":e={type:"constant",value:t("boolean-constant-value")};break;case"variable":if(e={type:"variable",variable:t("operand-variable")},C.isNone(e.variable))return _("#if-condition-operand-variable").getFocus()}a={type:i,variable:n,operation:s,operand:e};break}case"number":{n=t("common-variable");if(C.isNone(n))return _("#if-condition-common-variable").getFocus();s=t("number-operation");let e;switch(t("number-operand-type")){case"none":e={type:"none"};break;case"constant":e={type:"constant",value:t("number-constant-value")};break;case"variable":if(e={type:"variable",variable:t("operand-variable")},C.isNone(e.variable))return _("#if-condition-operand-variable").getFocus()}a={type:i,variable:n,operation:s,operand:e};break}case"string":{n=t("common-variable");if(C.isNone(n))return _("#if-condition-common-variable").getFocus();s=t("string-operation");let e;switch(t("string-operand-type")){case"none":e={type:"none"};break;case"constant":e={type:"constant",value:t("string-constant-value")};break;case"variable":if(e={type:"variable",variable:t("operand-variable")},C.isNone(e.variable))return _("#if-condition-operand-variable").getFocus();break;case"enum":if(""===(e={type:"enum",stringId:t("string-enum-stringId")}).stringId)return _("#if-condition-string-enum-stringId").getFocus()}a={type:i,variable:n,operation:s,operand:e};break}case"object":var r=t("common-variable");if(C.isNone(r))return _("#if-condition-common-variable").getFocus();var o=t("object-operation");switch(o){case"equal":case"unequal":{let e;switch(t("object-operand-type")){case"none":e={type:"none"};break;case"actor":e={type:"actor",actor:t("common-actor")};break;case"skill":e={type:"skill",skill:t("common-skill")};break;case"state":e={type:"state",state:t("common-state")};break;case"equipment":e={type:"equipment",equipment:t("common-equipment")};break;case"item":e={type:"item",item:t("common-item")};break;case"trigger":e={type:"trigger",trigger:t("common-trigger")};break;case"light":e={type:"light",light:t("common-light")};break;case"element":e={type:"element",element:t("common-element")};break;case"variable":if(e={type:"variable",variable:t("operand-variable")},C.isNone(e.variable))return _("#if-condition-operand-variable").getFocus()}a={type:i,variable:r,operation:o,operand:e};break}default:a={type:i,variable:r,operation:o}}break;case"actor":var e=t("common-actor"),l=t("actor-operation");switch(l){case"has-skill":var c=t("actor-skillId");if(""===c)return _("#if-condition-actor-skillId").getFocus();a={type:i,actor:e,operation:l,skillId:c};break;case"has-state":c=t("actor-stateId");if(""===c)return _("#if-condition-actor-stateId").getFocus();a={type:i,actor:e,operation:l,stateId:c};break;case"has-items":c=t("actor-itemId");if(""===c)return _("#if-condition-actor-itemId").getFocus();var h=t("actor-quantity");a={type:i,actor:e,operation:l,itemId:c,quantity:h};break;case"has-equipments":c=t("actor-equipmentId");if(""===c)return _("#if-condition-actor-equipmentId").getFocus();h=t("actor-quantity");a={type:i,actor:e,operation:l,equipmentId:c,quantity:h};break;case"equipped":c=t("actor-equipmentId");if(""===c)return _("#if-condition-actor-equipmentId").getFocus();a={type:i,actor:e,operation:l,equipmentId:c};break;default:a={type:i,actor:e,operation:l}}break;case"element":n=t("common-element"),s=t("element-operation");a={type:i,element:n,operation:s};break;case"keyboard":n=t("keyboard-keycode"),s=t("keyboard-state");if(""===n)return _("#if-condition-keyboard-keycode").getFocus();a={type:i,keycode:n,state:s};break;case"mouse":n=t("mouse-button"),s=t("mouse-state");a={type:i,button:n,state:s};break;case"list":n=t("common-variable");if(C.isNone(n))return _("#if-condition-common-variable").getFocus();var s=t("list-operation"),d=t("operand-variable");if(C.isNone(d))return _("#if-condition-operand-variable").getFocus();a={type:i,list:n,operation:s,target:d};break;case"other":n=t("other-key");a={type:i,key:n}}return O.close("if-condition"),a},_t.confirm=function(e){return _t.target.save()},{target:null,commands:null,initialize:null,parse:null,open:null,save:null,windowClosed:null,confirm:null}),Yt=(Ot.initialize=function(){_("#switch-branch").on("closed",this.windowClosed),_("#switch-branch-confirm").on("click",this.confirm)},Ot.parse=function(e){var t=I.words;for(const i of e.conditions)t.push(Yt.parse(i));return t.join()},Ot.open=function(e){this.target.inserting?(Yt.target=this.target,Yt.open()):(O.open("switch-branch"),_("#switch-branch-conditions").write(e.conditions.slice()),_("#switch-branch-conditions").getFocus(),this.commands=e.commands)},Ot.save=function(){var e,t;return this.target.inserting?void 0!==(t=Yt.save())?{conditions:[t],commands:[]}:void 0:0===(e=(t=_("#switch-branch-conditions")).read()).length?t.getFocus():(t=this.commands,O.close("switch-branch"),{conditions:e,commands:t})},Ot.windowClosed=function(e){Ot.commands=null,_("#switch-branch-conditions").clear()},Ot.confirm=function(e){return Ot.target.save()},{target:null,initialize:null,parse:null,open:null,save:null,confirm:null}),jt=(Yt.initialize=function(){_("#switch-condition-type").loadItems([{name:"None",value:"none"},{name:"Boolean",value:"boolean"},{name:"Number",value:"number"},{name:"String",value:"string"},{name:"Enum String",value:"enum"},{name:"Keyboard",value:"keyboard"},{name:"Mouse",value:"mouse"},{name:"Variable",value:"variable"}]),_("#switch-condition-type").enableHiddenMode().relate([{case:"boolean",targets:[_("#switch-condition-boolean-value")]},{case:"number",targets:[_("#switch-condition-number-value")]},{case:"string",targets:[_("#switch-condition-string-value")]},{case:"enum",targets:[_("#switch-condition-enum-stringId")]},{case:"keyboard",targets:[_("#switch-condition-keyboard-keycode")]},{case:"mouse",targets:[_("#switch-condition-mouse-button")]},{case:"variable",targets:[_("#switch-condition-variable-variable")]}]),_("#switch-condition-boolean-value").loadItems([{name:"False",value:!1},{name:"True",value:!0}]),_("#switch-condition-mouse-button").loadItems([{name:"Left Button",value:0},{name:"Middle Button",value:1},{name:"Right Button",value:2},{name:"Back Button",value:3},{name:"Forward Button",value:4}]),_("#switch-condition-confirm").on("click",this.confirm)},Yt.parse=function(e){switch(e.type){case"none":return N.get("common.none");case"boolean":case"number":return e.value.toString();case"string":return`"${I.parseMultiLineString(e.value)}"`;case"enum":return I.parseEnumStringTag(e.stringId);case"keyboard":var t=e.keycode;return N.get("command.switch.keyboard")+`["${t}"]`;case"mouse":t=_t.parseMouseButton(e.button);return N.get("command.switch.mouse")+`[${t}]`;case"variable":return I.parseVariable(e.variable)}},Yt.open=function(e={type:"number",value:0}){O.open("switch-condition");let t=!1,i=0,a="",n="",s="",r=0,o={type:"local",key:""};var l=D("switch-condition");switch(e.type){case"none":break;case"boolean":t=e.value;break;case"number":i=e.value;break;case"string":a=e.value;break;case"enum":n=e.stringId;break;case"keyboard":s=e.keycode;break;case"mouse":r=e.button;break;case"variable":o=e.variable}l("type",e.type),l("boolean-value",t),l("number-value",i),l("string-value",a),l("enum-stringId",n),l("keyboard-keycode",s),l("mouse-button",r),l("variable-variable",o),_("#switch-condition-type").getFocus()},Yt.save=function(){var e=g("switch-condition"),t=e("type");let i;switch(t){case"none":i={type:t};break;case"boolean":var a=e("boolean-value");i={type:t,value:a};break;case"number":a=e("number-value");i={type:t,value:a};break;case"string":a=e("string-value");i={type:t,value:a};break;case"enum":a=e("enum-stringId");if(""===a)return _("#switch-condition-enum-stringId").getFocus();i={type:t,stringId:a};break;case"keyboard":a=e("keyboard-keycode");if(""===a)return _("#switch-condition-keyboard-keycode").getFocus();i={type:t,keycode:a};break;case"mouse":a=e("mouse-button");i={type:t,button:a};break;case"variable":a=e("variable-variable");if(C.isNone(a))return _("#switch-condition-variable-variable").getFocus();i={type:t,variable:a}}return O.close("switch-condition"),i},Yt.confirm=function(e){return Yt.target.save()},{target:null,initialize:null,parse:null,open:null,save:null,confirm:null}),Xt=(jt.initialize=function(){_("#setImage-property-key").loadItems([{name:"Image",value:"image"},{name:"Display",value:"display"},{name:"Flip",value:"flip"},{name:"Blend",value:"blend"},{name:"Shift X",value:"shiftX"},{name:"Shift Y",value:"shiftY"},{name:"Clip X",value:"clip-0"},{name:"Clip Y",value:"clip-1"},{name:"Clip Width",value:"clip-2"},{name:"Clip Height",value:"clip-3"}]),_("#setImage-property-key").enableHiddenMode().relate([{case:"image",targets:[_("#setImage-property-image")]},{case:"display",targets:[_("#setImage-property-display")]},{case:"flip",targets:[_("#setImage-property-flip")]},{case:"blend",targets:[_("#setImage-property-blend")]},{case:"shiftX",targets:[_("#setImage-property-shiftX")]},{case:"shiftY",targets:[_("#setImage-property-shiftY")]},{case:"clip-0",targets:[_("#setImage-property-clip-0")]},{case:"clip-1",targets:[_("#setImage-property-clip-1")]},{case:"clip-2",targets:[_("#setImage-property-clip-2")]},{case:"clip-3",targets:[_("#setImage-property-clip-3")]}]),_("#setImage-property-display").loadItems(_("#uiImage-display").dataItems),_("#setImage-property-flip").loadItems(_("#uiImage-flip").dataItems),_("#setImage-property-blend").loadItems(_("#uiImage-blend").dataItems),_("#setImage-property-confirm").on("click",this.confirm)},jt.parse=function({key:e,value:t}){var i=N.createGetter("command.setImage"),a=i(e);switch(e){case"image":return`${a}(${I.parseFileName(t)})`;case"display":return`${a}(${i("display."+t)})`;case"flip":return`${a}(${i("flip."+t)})`;case"blend":return`${a}(${I.parseBlend(t)})`;case"shiftX":case"shiftY":case"clip-0":case"clip-1":case"clip-2":case"clip-3":return`${a}(${I.parseVariableNumber(t)})`}},jt.open=function({key:e="image",value:t=""}={}){O.open("setImage-property");var i=D("setImage-property");let a="",n="stretch",s="none",r="normal",o=0,l=0,c=0,h=0,d=0,u=0;switch(e){case"image":a=t;break;case"display":n=t;break;case"flip":s=t;break;case"blend":r=t;break;case"shiftX":o=t;break;case"shiftY":l=t;break;case"clip-0":c=t;break;case"clip-1":h=t;break;case"clip-2":d=t;break;case"clip-3":u=t}i("key",e),i("image",a),i("display",n),i("flip",s),i("blend",r),i("shiftX",o),i("shiftY",l),i("clip-0",c),i("clip-1",h),i("clip-2",d),i("clip-3",u),_("#setImage-property-key").getFocus()},jt.save=function(){var e=g("setImage-property"),t=e("key");let i;switch(t){case"image":i=e("image");break;case"display":i=e("display");break;case"flip":i=e("flip");break;case"blend":i=e("blend");break;case"shiftX":i=e("shiftX");break;case"shiftY":i=e("shiftY");break;case"clip-0":i=e("clip-0");break;case"clip-1":i=e("clip-1");break;case"clip-2":i=e("clip-2");break;case"clip-3":i=e("clip-3")}return O.close("setImage-property"),{key:t,value:i}},jt.confirm=function(e){return jt.target.save()},{target:null,initialize:null,parse:null,open:null,save:null,confirm:null}),Gt=(Xt.initialize=function(){_("#setText-property-key").loadItems([{name:"Content",value:"content"},{name:"Size",value:"size"},{name:"Line Spacing",value:"lineSpacing"},{name:"Letter Spacing",value:"letterSpacing"},{name:"Color",value:"color"},{name:"Font",value:"font"},{name:"Effect",value:"effect"},{name:"Blend",value:"blend"}]),_("#setText-property-key").enableHiddenMode().relate([{case:"content",targets:[_("#setText-property-content")]},{case:"size",targets:[_("#setText-property-size")]},{case:"lineSpacing",targets:[_("#setText-property-lineSpacing")]},{case:"letterSpacing",targets:[_("#setText-property-letterSpacing")]},{case:"color",targets:[_("#setText-property-color")]},{case:"font",targets:[_("#setText-property-font")]},{case:"effect",targets:[_("#setText-property-effect-type")]},{case:"blend",targets:[_("#setText-property-blend")]}]),_("#setText-property-effect-type").enableHiddenMode().relate([{case:"shadow",targets:[_("#setText-property-effect-shadowOffsetX"),_("#setText-property-effect-shadowOffsetY"),_("#setText-property-effect-color")]},{case:"stroke",targets:[_("#setText-property-effect-strokeWidth"),_("#setText-property-effect-color")]},{case:"outline",targets:[_("#setText-property-effect-color")]}]),_("#setText-property-effect-type").loadItems(_("#uiText-effect-type").dataItems),_("#setText-property-blend").loadItems(_("#uiText-blend").dataItems),_("#setText-property-confirm").on("click",this.confirm)},Xt.parse=function({key:e,value:t}){var i=N.createGetter("command.setText"),a=i(e);switch(e){case"content":{let e=I.parseMultiLineString(I.parseVariableTag(t));return`${a}("${e=40<e.length?e.slice(0,40)+"...":e}")`}case"size":case"lineSpacing":case"letterSpacing":return a+`(${t})`;case"color":return`${a}(#${m.simplifyHexColor(t)})`;case"font":return`${a}(${t||i("font.default")})`;case"effect":switch(t.type){case"none":return`${a}(${i("effect.none")})`;case"shadow":var n=t.shadowOffsetX,s=t.shadowOffsetY,r=m.simplifyHexColor(t.color);return`${a}(${i("effect.shadow")}, ${n}, ${s}, #${r})`;case"stroke":n=t.strokeWidth,s=m.simplifyHexColor(t.color);return`${a}(${i("effect.stroke")}, ${n}, #${s})`;case"outline":r=m.simplifyHexColor(t.color);return`${a}(${i("effect.outline")}, #${r})`}case"blend":return`${a}(${I.parseBlend(t)})`}},Xt.open=function({key:e="content",value:t=""}={}){O.open("setText-property");var i=D("setText-property");let a="",n=16,s=0,r=0,o="ffffffff",l="",c="none",h=1,d=1,u=1,p="000000ff",m="normal";switch(e){case"content":a=t;break;case"size":n=t;break;case"lineSpacing":s=t;break;case"letterSpacing":r=t;break;case"color":o=t;break;case"font":l=t;break;case"effect":c=t.type,h=t.shadowOffsetX??h,d=t.shadowOffsetY??d,u=t.strokeWidth??u,p=t.color??p;break;case"blend":m=t}i("key",e),i("content",a),i("size",n),i("lineSpacing",s),i("letterSpacing",r),i("color",o),i("font",l),i("effect-type",c),i("effect-shadowOffsetX",h),i("effect-shadowOffsetY",d),i("effect-strokeWidth",u),i("effect-color",p),i("blend",m),_("#setText-property-key").getFocus()},Xt.save=function(){var e=g("setText-property"),t=e("key");let i;switch(t){case"content":i=e("content");break;case"size":i=e("size");break;case"lineSpacing":i=e("lineSpacing");break;case"letterSpacing":i=e("letterSpacing");break;case"color":i=e("color");break;case"font":i=e("font");break;case"effect":switch(e("effect-type")){case"none":i={type:"none"};break;case"shadow":i={type:"shadow",shadowOffsetX:e("effect-shadowOffsetX"),shadowOffsetY:e("effect-shadowOffsetY"),color:e("effect-color")};break;case"stroke":i={type:"stroke",strokeWidth:e("effect-strokeWidth"),color:e("effect-color")};break;case"outline":i={type:"outline",color:e("effect-color")}}break;case"blend":i=e("blend")}return O.close("setText-property"),{key:t,value:i}},Xt.confirm=function(e){return Xt.target.save()},{target:null,initialize:null,parse:null,open:null,save:null,confirm:null}),Vt=(Gt.initialize=function(){_("#setTextBox-property-key").loadItems([{name:"Type",value:"type"},{name:"Text",value:"text"},{name:"Number",value:"number"},{name:"Min",value:"min"},{name:"Max",value:"max"},{name:"Decimal Places",value:"decimals"},{name:"Color",value:"color"}]),_("#setTextBox-property-key").enableHiddenMode().relate([{case:"type",targets:[_("#setTextBox-property-type")]},{case:"text",targets:[_("#setTextBox-property-text")]},{case:"number",targets:[_("#setTextBox-property-number")]},{case:"min",targets:[_("#setTextBox-property-min")]},{case:"max",targets:[_("#setTextBox-property-max")]},{case:"decimals",targets:[_("#setTextBox-property-decimals")]},{case:"color",targets:[_("#setTextBox-property-color")]}]),_("#setTextBox-property-type").loadItems(_("#uiTextBox-type").dataItems),_("#setTextBox-property-confirm").on("click",this.confirm)},Gt.parse=function({key:e,value:t}){var i=N.createGetter("command.setTextBox"),a=i(e);switch(e){case"type":return`${a}(${i("type."+t)})`;case"text":{let e=I.parseVariableString(t);return`${a}(${e=40<e.length?e.slice(0,40)+"...":e})`}case"number":case"min":case"max":return`${a}(${I.parseVariableNumber(t)})`;case"decimals":return a+`(${t})`;case"color":return`${a}(#${m.simplifyHexColor(t)})`}},Gt.open=function({key:e="type",value:t="text"}={}){O.open("setTextBox-property");var i=D("setTextBox-property");let a="text",n="",s=0,r=0,o=0,l=0,c="ffffffff";switch(e){case"type":a=t;break;case"text":n=t;break;case"number":s=t;break;case"min":r=t;break;case"max":o=t;break;case"decimals":l=t;break;case"color":c=t}i("key",e),i("type",a),i("text",n),i("number",s),i("min",r),i("max",o),i("decimals",l),i("color",c),_("#setTextBox-property-key").getFocus()},Gt.save=function(){var e=g("setTextBox-property"),t=e("key");let i;switch(t){case"type":i=e("type");break;case"text":i=e("text");break;case"number":i=e("number");break;case"min":i=e("min");break;case"max":i=e("max");break;case"decimals":i=e("decimals");break;case"color":i=e("color")}return O.close("setTextBox-property"),{key:t,value:i}},Gt.confirm=function(e){return Gt.target.save()},{target:null,initialize:null,parse:null,open:null,save:null,confirm:null}),Wt=(Vt.initialize=function(){_("#setDialogBox-property-key").loadItems([{name:"Content",value:"content"},{name:"Print Interval",value:"interval"},{name:"Size",value:"size"},{name:"Line Spacing",value:"lineSpacing"},{name:"Letter Spacing",value:"letterSpacing"},{name:"Color",value:"color"},{name:"Font",value:"font"},{name:"Effect",value:"effect"},{name:"Blend",value:"blend"}]),_("#setDialogBox-property-key").enableHiddenMode().relate([{case:"content",targets:[_("#setDialogBox-property-content")]},{case:"interval",targets:[_("#setDialogBox-property-interval")]},{case:"size",targets:[_("#setDialogBox-property-size")]},{case:"lineSpacing",targets:[_("#setDialogBox-property-lineSpacing")]},{case:"letterSpacing",targets:[_("#setDialogBox-property-letterSpacing")]},{case:"color",targets:[_("#setDialogBox-property-color")]},{case:"font",targets:[_("#setDialogBox-property-font")]},{case:"effect",targets:[_("#setDialogBox-property-effect-type")]},{case:"blend",targets:[_("#setDialogBox-property-blend")]}]),_("#setDialogBox-property-effect-type").enableHiddenMode().relate([{case:"shadow",targets:[_("#setDialogBox-property-effect-shadowOffsetX"),_("#setDialogBox-property-effect-shadowOffsetY"),_("#setDialogBox-property-effect-color")]},{case:"stroke",targets:[_("#setDialogBox-property-effect-strokeWidth"),_("#setDialogBox-property-effect-color")]},{case:"outline",targets:[_("#setDialogBox-property-effect-color")]}]),_("#setDialogBox-property-effect-type").loadItems(_("#uiDialogBox-effect-type").dataItems),_("#setDialogBox-property-blend").loadItems(_("#uiDialogBox-blend").dataItems),_("#setDialogBox-property-confirm").on("click",this.confirm)},Vt.parse=function({key:e,value:t}){var i=N.createGetter("command.setDialogBox"),a=i(e);switch(e){case"content":{let e=I.parseMultiLineString(I.parseVariableTag(t));return`${a}("${e=40<e.length?e.slice(0,40)+"...":e}")`}case"interval":case"size":case"lineSpacing":case"letterSpacing":return a+`(${t})`;case"color":return`${a}(#${m.simplifyHexColor(t)})`;case"font":return`${a}(${t||i("font.default")})`;case"effect":switch(t.type){case"none":return`${a}(${i("effect.none")})`;case"shadow":var n=t.shadowOffsetX,s=t.shadowOffsetY,r=m.simplifyHexColor(t.color);return`${a}(${i("effect.shadow")}, ${n}, ${s}, #${r})`;case"stroke":n=t.strokeWidth,s=m.simplifyHexColor(t.color);return`${a}(${i("effect.stroke")}, ${n}, #${s})`;case"outline":r=m.simplifyHexColor(t.color);return`${a}(${i("effect.outline")}, #${r})`}case"blend":return`${a}(${I.parseBlend(t)})`}},Vt.open=function({key:e="content",value:t=""}={}){O.open("setDialogBox-property");var i=D("setDialogBox-property");let a="",n=0,s=16,r=0,o=0,l="ffffffff",c="",h="none",d=1,u=1,p=1,m="000000ff",g="normal";switch(e){case"content":a=t;break;case"interval":n=t;break;case"size":s=t;break;case"lineSpacing":r=t;break;case"letterSpacing":o=t;break;case"color":l=t;break;case"font":c=t;break;case"effect":h=t.type,d=t.shadowOffsetX??d,u=t.shadowOffsetY??u,p=t.strokeWidth??p,m=t.color??m;break;case"blend":g=t}i("key",e),i("content",a),i("interval",n),i("size",s),i("lineSpacing",r),i("letterSpacing",o),i("color",l),i("font",c),i("effect-type",h),i("effect-shadowOffsetX",d),i("effect-shadowOffsetY",u),i("effect-strokeWidth",p),i("effect-color",m),i("blend",g),_("#setDialogBox-property-key").getFocus()},Vt.save=function(){var e=g("setDialogBox-property"),t=e("key");let i;switch(t){case"content":i=e("content");break;case"interval":i=e("interval");break;case"size":i=e("size");break;case"lineSpacing":i=e("lineSpacing");break;case"letterSpacing":i=e("letterSpacing");break;case"color":i=e("color");break;case"font":i=e("font");break;case"effect":switch(e("effect-type")){case"none":i={type:"none"};break;case"shadow":i={type:"shadow",shadowOffsetX:e("effect-shadowOffsetX"),shadowOffsetY:e("effect-shadowOffsetY"),color:e("effect-color")};break;case"stroke":i={type:"stroke",strokeWidth:e("effect-strokeWidth"),color:e("effect-color")};break;case"outline":i={type:"outline",color:e("effect-color")}}break;case"blend":i=e("blend")}return O.close("setDialogBox-property"),{key:t,value:i}},Vt.confirm=function(e){return Vt.target.save()},{target:null,initialize:null,parse:null,open:null,save:null,confirm:null}),Ht=(Wt.initialize=function(){_("#setProgressBar-property-key").loadItems([{name:"Image",value:"image"},{name:"Display",value:"display"},{name:"Blend",value:"blend"},{name:"Progress",value:"progress"},{name:"Clip X",value:"clip-0"},{name:"Clip Y",value:"clip-1"},{name:"Clip Width",value:"clip-2"},{name:"Clip Height",value:"clip-3"},{name:"Color Red",value:"color-0"},{name:"Color Green",value:"color-1"},{name:"Color Blue",value:"color-2"},{name:"Color Alpha",value:"color-3"}]),_("#setProgressBar-property-key").enableHiddenMode().relate([{case:"image",targets:[_("#setProgressBar-property-image")]},{case:"display",targets:[_("#setProgressBar-property-display")]},{case:"blend",targets:[_("#setProgressBar-property-blend")]},{case:"progress",targets:[_("#setProgressBar-property-progress")]},{case:"clip-0",targets:[_("#setProgressBar-property-clip-0")]},{case:"clip-1",targets:[_("#setProgressBar-property-clip-1")]},{case:"clip-2",targets:[_("#setProgressBar-property-clip-2")]},{case:"clip-3",targets:[_("#setProgressBar-property-clip-3")]},{case:"color-0",targets:[_("#setProgressBar-property-color-0")]},{case:"color-1",targets:[_("#setProgressBar-property-color-1")]},{case:"color-2",targets:[_("#setProgressBar-property-color-2")]},{case:"color-3",targets:[_("#setProgressBar-property-color-3")]}]),_("#setProgressBar-property-display").loadItems(_("#uiProgressBar-display").dataItems),_("#setProgressBar-property-blend").loadItems(_("#uiProgressBar-blend").dataItems),_("#setProgressBar-property-confirm").on("click",this.confirm)},Wt.parse=function({key:e,value:t}){var i=N.createGetter("command.setProgressBar"),a=i(e);switch(e){case"image":return`${a}(${I.parseFileName(t)})`;case"display":return`${a}(${i("display."+t)})`;case"blend":return`${a}(${I.parseBlend(t)})`;case"progress":case"clip-0":case"clip-1":case"clip-2":case"clip-3":case"color-0":case"color-1":case"color-2":case"color-3":return`${a}(${I.parseVariableNumber(t)})`}},Wt.open=function({key:e="image",value:t=""}={}){O.open("setProgressBar-property");var i=D("setProgressBar-property");let a="",n="stretch",s="normal",r=0,o=0,l=0,c=0,h=0,d=0,u=0,p=0,m=0;switch(e){case"image":a=t;break;case"display":n=t;break;case"blend":s=t;break;case"progress":r=t;break;case"clip-0":o=t;break;case"clip-1":l=t;break;case"clip-2":c=t;break;case"clip-3":h=t;break;case"color-0":d=t;break;case"color-1":u=t;break;case"color-2":p=t;break;case"color-3":m=t}i("key",e),i("image",a),i("display",n),i("blend",s),i("progress",r),i("clip-0",o),i("clip-1",l),i("clip-2",c),i("clip-3",h),i("color-0",d),i("color-1",u),i("color-2",p),i("color-3",m),_("#setProgressBar-property-key").getFocus()},Wt.save=function(){var e=g("setProgressBar-property"),t=e("key");let i;switch(t){case"image":i=e("image");break;case"display":i=e("display");break;case"blend":i=e("blend");break;case"progress":i=e("progress");break;case"clip-0":i=e("clip-0");break;case"clip-1":i=e("clip-1");break;case"clip-2":i=e("clip-2");break;case"clip-3":i=e("clip-3");break;case"color-0":i=e("color-0");break;case"color-1":i=e("color-1");break;case"color-2":i=e("color-2");break;case"color-3":i=e("color-3")}return O.close("setProgressBar-property"),{key:t,value:i}},Wt.confirm=function(e){return Wt.target.save()},{target:null,initialize:null,parse:null,open:null,save:null,confirm:null}),Kt=(Ht.initialize=function(){_("#moveElement-property-key").loadItems([{name:"Anchor X",value:"anchorX"},{name:"Anchor Y",value:"anchorY"},{name:"X",value:"x"},{name:"X2",value:"x2"},{name:"Y",value:"y"},{name:"Y2",value:"y2"},{name:"Width",value:"width"},{name:"Width2",value:"width2"},{name:"Height",value:"height"},{name:"Height2",value:"height2"},{name:"Rotation",value:"rotation"},{name:"Scale X",value:"scaleX"},{name:"Scale Y",value:"scaleY"},{name:"Skew X",value:"skewX"},{name:"Skew Y",value:"skewY"},{name:"Opacity",value:"opacity"}]),_("#moveElement-property-key").enableHiddenMode().relate([{case:"anchorX",targets:[_("#moveElement-property-anchorX")]},{case:"anchorY",targets:[_("#moveElement-property-anchorY")]},{case:"x",targets:[_("#moveElement-property-x")]},{case:"x2",targets:[_("#moveElement-property-x2")]},{case:"y",targets:[_("#moveElement-property-y")]},{case:"y2",targets:[_("#moveElement-property-y2")]},{case:"width",targets:[_("#moveElement-property-width")]},{case:"width2",targets:[_("#moveElement-property-width2")]},{case:"height",targets:[_("#moveElement-property-height")]},{case:"height2",targets:[_("#moveElement-property-height2")]},{case:"rotation",targets:[_("#moveElement-property-rotation")]},{case:"scaleX",targets:[_("#moveElement-property-scaleX")]},{case:"scaleY",targets:[_("#moveElement-property-scaleY")]},{case:"skewX",targets:[_("#moveElement-property-skewX")]},{case:"skewY",targets:[_("#moveElement-property-skewY")]},{case:"opacity",targets:[_("#moveElement-property-opacity")]}]),_("#moveElement-property-confirm").on("click",this.confirm)},Ht.parse=function({key:e,value:t}){return`${N.get("command.moveElement."+e)}(${I.parseVariableNumber(t)})`},Ht.open=function({key:e="anchorX",value:t=0}={}){O.open("moveElement-property");var i={anchorX:0,anchorY:0,x:0,x2:0,y:0,y2:0,width:0,width2:0,height:0,height2:0,rotation:0,scaleX:1,scaleY:1,skewX:0,skewY:0,opacity:1},t=(e in i&&(i[e]=t),D("moveElement-property",i));t("key",e),t("anchorX"),t("anchorY"),t("x"),t("x2"),t("y"),t("y2"),t("width"),t("width2"),t("height"),t("height2"),t("rotation"),t("scaleX"),t("scaleY"),t("skewX"),t("skewY"),t("opacity"),_("#moveElement-property-key").getFocus()},Ht.save=function(){var e=g("moveElement-property"),t=e("key"),e=e(t);return O.close("moveElement-property"),{key:t,value:e}},Ht.confirm=function(e){return Ht.target.save()},{target:null,initialize:null,parse:null,open:null,save:null,confirm:null}),C=(Kt.initialize=function(){_("#moveLight-property-key").loadItems([{name:"X",value:"x"},{name:"Y",value:"y"},{name:"Range",value:"range"},{name:"intensity",value:"intensity"},{name:"Anchor X",value:"anchorX"},{name:"Anchor Y",value:"anchorY"},{name:"Width",value:"width"},{name:"Height",value:"height"},{name:"Angle",value:"angle"},{name:"Red",value:"red"},{name:"Green",value:"green"},{name:"Blue",value:"blue"}]),_("#moveLight-property-key").enableHiddenMode().relate([{case:"x",targets:[_("#moveLight-property-x")]},{case:"y",targets:[_("#moveLight-property-y")]},{case:"range",targets:[_("#moveLight-property-range")]},{case:"intensity",targets:[_("#moveLight-property-intensity")]},{case:"anchorX",targets:[_("#moveLight-property-anchorX")]},{case:"anchorY",targets:[_("#moveLight-property-anchorY")]},{case:"width",targets:[_("#moveLight-property-width")]},{case:"height",targets:[_("#moveLight-property-height")]},{case:"angle",targets:[_("#moveLight-property-angle")]},{case:"red",targets:[_("#moveLight-property-red")]},{case:"green",targets:[_("#moveLight-property-green")]},{case:"blue",targets:[_("#moveLight-property-blue")]}]),_("#moveLight-property-confirm").on("click",this.confirm)},Kt.parse=function({key:e,value:t}){switch(e){case"x":case"y":case"range":case"intensity":case"anchorX":case"anchorY":case"width":case"height":case"angle":case"red":case"green":case"blue":var i=I.parseVariableNumber(t);return N.get("command.moveLight."+e)+`(${i})`}},Kt.open=function({key:e="x",value:t=0}={}){O.open("moveLight-property");var i=D("moveLight-property");let a=0,n=0,s=1,r=.5,o=.5,l=.5,c=1,h=1,d=0,u=0,p=0,m=0;switch(e){case"x":a=t;break;case"y":n=t;break;case"range":s=t;break;case"intensity":r=t;break;case"anchorX":o=t;break;case"anchorY":l=t;break;case"width":c=t;break;case"height":h=t;break;case"angle":d=t;break;case"red":u=t;break;case"green":p=t;break;case"blue":m=t}i("key",e),i("x",a),i("y",n),i("range",s),i("intensity",r),i("anchorX",o),i("anchorY",l),i("width",c),i("height",h),i("angle",d),i("red",u),i("green",p),i("blue",m),_("#moveLight-property-key").getFocus()},Kt.save=function(){var e=g("moveLight-property"),t=e("key");let i;switch(t){case"x":i=e("x");break;case"y":i=e("y");break;case"range":i=e("range");break;case"intensity":i=e("intensity");break;case"anchorX":i=e("anchorX");break;case"anchorY":i=e("anchorY");break;case"width":i=e("width");break;case"height":i=e("height");break;case"angle":i=e("angle");break;case"red":i=e("red");break;case"green":i=e("green");break;case"blue":i=e("blue")}return O.close("moveLight-property"),{key:t,value:i}},Kt.confirm=function(e){return Kt.target.save()},{keyBox:_("#variableGetter-preset-key"),target:null,filter:null,types:null,initialize:null,open:null,isNone:null,loadPresetKeys:null,typeWrite:null,typeInput:null,confirm:null}),Ut=(C.initialize=function(){var e={local:{name:"Local",value:"local"},global:{name:"Global",value:"global"},actor:{name:"Actor Attribute",value:"actor"},skill:{name:"Skill Attribute",value:"skill"},state:{name:"State Attribute",value:"state"},equipment:{name:"Equipment Attribute",value:"equipment"},item:{name:"Item Attribute",value:"item"},element:{name:"Element Attribute",value:"element"}};const i=Object.values(e);var t=i.filter(e=>"item"!==e.value),a=t.filter(e=>"global"!==e.value),e=(this.types={all:i,object:[e.local,e.global,e.element],object2:[e.local,e.global],writable:t,deletable:a},_("#variableGetter-actor")),t=_("#variableGetter-skill"),a=_("#variableGetter-state"),n=_("#variableGetter-equipment"),s=_("#variableGetter-item"),r=_("#variableGetter-element"),o=_("#variableGetter-common-key"),l=_("#variableGetter-preset-key"),c=_("#variableGetter-global-key");_("#variableGetter-type").enableHiddenMode().relate([{case:"local",targets:[o]},{case:"global",targets:[c]},{case:"actor",targets:[e,l]},{case:"skill",targets:[t,l]},{case:"state",targets:[a,l]},{case:"equipment",targets:[n,l]},{case:"item",targets:[s,l]},{case:"element",targets:[r,l]}]),_("#variableGetter-type").setItemNames=function(e){var t=this.dataItems;this.dataItems=i,pe.prototype.setItemNames.call(this,e),this.dataItems=t},_("#variableGetter-type").on("write",this.typeWrite),_("#variableGetter-type").on("input",this.typeInput),_("#variableGetter-confirm").on("click",this.confirm)},C.open=function(e){var t=this.types,i=e.filter;switch(this.filter=i){case"all":case"boolean":case"number":case"string":_("#variableGetter-type").loadItems(t.all),_("#variableGetter-global-key").filter=i;break;case"object":if(O.isWindowOpen("variableGetter"))return Ut.open(e);_("#variableGetter-type").loadItems(O.isWindowOpen("elementGetter")?t.object2:t.object),_("#variableGetter-global-key").filter=i;break;case"writable-boolean":case"writable-number":case"writable-string":_("#variableGetter-type").loadItems(t.writable),_("#variableGetter-global-key").filter=i.slice(9);break;case"deletable":_("#variableGetter-type").loadItems(t.deletable)}this.target=e,O.open("variableGetter");var a=e.dataValue,n=a.type,s=a.key;let r="",o="",l="",c={type:"trigger"},h={type:"trigger"},d={type:"trigger"},u={type:"trigger"},p={type:"trigger"},m={type:"trigger"};switch(n){case"local":r=s;break;case"global":l=s;break;case"actor":this.loadPresetKeys(n),c=a.actor,o=s;break;case"skill":this.loadPresetKeys(n),h=a.skill,o=s;break;case"state":this.loadPresetKeys(n),d=a.state,o=s;break;case"equipment":this.loadPresetKeys(n),u=a.equipment,o=s;break;case"item":this.loadPresetKeys(n),p=a.item,o=s;break;case"element":this.loadPresetKeys(n),m=a.element,o=s}var g=D("variableGetter");this.keyBox.loadItems(v.getAttributeItems("none")),g("type",n),g("actor",c),g("skill",h),g("state",d),g("equipment",u),g("item",p),g("element",m),g("common-key",r),g("preset-key",o),g("global-key",l),_("#variableGetter-type").getFocus()},C.isNone=function(e){return""===e.key},C.loadPresetKeys=function(e){let t=void 0;switch(this.filter){case"boolean":case"number":case"string":case"object":t=this.filter;break;case"writable-boolean":case"writable-number":case"writable-string":t=this.filter.split("-")[1]}this.keyBox.loadItems(v.getAttributeItems(e,t))},C.typeWrite=function(e){var t=e.value;switch(t){case"actor":case"skill":case"state":case"item":case"equipment":case"element":C.loadPresetKeys(t)}},C.typeInput=function(e){switch(e.value){case"actor":case"skill":case"state":case"item":case"equipment":case"element":var t=C["keyBox"],i=t.textContent;if(t.write(t.read()),t.invalid){let e=t.dataItems[0]?.value;for(const a of t.dataItems)if(a.name===i){e=a.value;break}void 0!==e&&t.write(e)}}},C.confirm=function(e){var t=g("variableGetter"),i=t("type");let a,n;switch(i){case"local":if(""===(n=t("common-key").trim()))return _("#variableGetter-common-key").getFocus();break;case"global":n=t("global-key");var s=He.variables.map[n],r=this.target.filter;switch(r){case"boolean":case"number":case"string":if(typeof s?.value!==r)return _("#variableGetter-global-key").getFocus()}break;case"actor":case"skill":case"state":case"item":case"equipment":case"element":if(""===(n=t("preset-key")))return _("#variableGetter-preset-key").getFocus()}switch(i){case"local":case"global":a={type:i,key:n};break;case"actor":var o=t("actor");a={type:i,actor:o,key:n};break;case"skill":o=t("skill");a={type:i,skill:o,key:n};break;case"state":o=t("state");a={type:i,state:o,key:n};break;case"equipment":o=t("equipment");a={type:i,equipment:o,key:n};break;case"item":o=t("item");a={type:i,item:o,key:n};break;case"element":o=t("element");a={type:i,element:o,key:n}}this.target.input(a),O.close("variableGetter")}.bind(C),{target:null,types:null,initialize:null,open:null,confirm:null}),$t=(Ut.initialize=function(){_("#objectGetter-type").enableHiddenMode().relate([{case:"local",targets:[_("#objectGetter-common-key")]},{case:"global",targets:[_("#objectGetter-global-key")]}]),_("#objectGetter-confirm").on("click",this.confirm)},Ut.open=function(e){this.target=e,O.open("objectGetter"),_("#objectGetter-type").loadItems(O.isWindowOpen("elementGetter")?C.types.object2:C.types.object);var t=e.dataValue,e=t.type;let i="",a="";switch(e){case"local":i=t.key;break;case"global":a=t.key}var n=D("objectGetter");n("type",e),n("common-key",i),n("global-key",a),_("#objectGetter-type").getFocus()},Ut.confirm=function(e){var t=g("objectGetter"),i=t("type");let a;switch(i){case"local":var n=t("common-key").trim();if(!n)return _("#objectGetter-common-key").getFocus();a={type:i,key:n};break;case"global":n=t("global-key");if("object"!=typeof He.variables.map[n]?.value)return _("#objectGetter-global-key").getFocus();a={type:i,key:n}}this.target.input(a),O.close("objectGetter")}.bind(Ut),{target:null,initialize:null,open:null,confirm:null}),Zt=($t.initialize=function(){_("#actorGetter-type").loadItems([{name:"Event Trigger Actor",value:"trigger"},{name:"Skill Caster",value:"caster"},{name:"Latest Actor",value:"latest"},{name:"Target Actor",value:"target"},{name:"Player Actor",value:"player"},{name:"Party Member",value:"member"},{name:"Global Actor",value:"global"},{name:"By Actor ID",value:"by-id"},{name:"Variable",value:"variable"}]),_("#actorGetter-type").enableHiddenMode().relate([{case:"member",targets:[_("#actorGetter-memberId")]},{case:"global",targets:[_("#actorGetter-actorId")]},{case:"by-id",targets:[_("#actorGetter-presetId")]},{case:"variable",targets:[_("#actorGetter-variable")]}]),_("#actorGetter-memberId").loadItems([{name:"Member #1",value:0},{name:"Member #2",value:1},{name:"Member #3",value:2},{name:"Member #4",value:3}]),_("#actorGetter-confirm").on("click",this.confirm)},$t.open=function(e){this.target=e,O.open("actorGetter");let t=0,i="",a=bt.getDefaultPresetId("actor"),n={type:"local",key:""};var s=e.dataValue;switch(s.type){case"trigger":case"caster":case"latest":case"target":case"player":break;case"member":t=s.memberId;break;case"global":i=s.actorId;break;case"by-id":a=s.presetId;break;case"variable":n=s.variable}_("#actorGetter-type").write(s.type),_("#actorGetter-memberId").write(t),_("#actorGetter-actorId").write(i),_("#actorGetter-presetId").write(a),_("#actorGetter-variable").write(n),_("#actorGetter-type").getFocus()},$t.confirm=function(e){var t=g("actorGetter"),i=t("type");let a;switch(i){case"trigger":case"caster":case"latest":case"target":case"player":a={type:i};break;case"member":var n=t("memberId");a={type:i,memberId:n};break;case"global":n=t("actorId");if(""===n)return _("#actorGetter-actorId").getFocus();a={type:i,actorId:n};break;case"by-id":n=t("presetId");if(""===n)return _("#actorGetter-presetId").getFocus();a={type:i,presetId:n};break;case"variable":n=t("variable");if(C.isNone(n))return _("#actorGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("actorGetter")}.bind($t),{target:null,initialize:null,open:null,confirm:null}),Jt=(Zt.initialize=function(){_("#skillGetter-type").loadItems([{name:"Event Trigger Skill",value:"trigger"},{name:"Latest Skill",value:"latest"},{name:"By Shortcut Key",value:"by-key"},{name:"By Skill Id",value:"by-id"},{name:"Variable",value:"variable"}]),_("#skillGetter-type").enableHiddenMode().relate([{case:"by-key",targets:[_("#skillGetter-actor"),_("#skillGetter-key")]},{case:"by-id",targets:[_("#skillGetter-actor"),_("#skillGetter-skillId")]},{case:"variable",targets:[_("#skillGetter-variable")]}]),_("#skillGetter-confirm").on("click",this.confirm)},Zt.open=function(e){this.target=e,O.open("skillGetter"),_("#skillGetter-key").loadItems(M.getStringItems("shortcut-key"));let t={type:"trigger"},i=M.getDefStringId("shortcut-key"),a="",n={type:"local",key:""};var s=e.dataValue;switch(s.type){case"trigger":case"latest":break;case"by-key":t=s.actor,i=s.key;break;case"by-id":t=s.actor,a=s.skillId;break;case"variable":n=s.variable}_("#skillGetter-type").write(s.type),_("#skillGetter-actor").write(t),_("#skillGetter-key").write(i),_("#skillGetter-skillId").write(a),_("#skillGetter-variable").write(n),_("#skillGetter-type").getFocus()},Zt.confirm=function(e){var t=g("skillGetter"),i=t("type");let a;switch(i){case"trigger":case"latest":a={type:i};break;case"by-key":var n=t("actor"),s=t("key");if(""===s)return _("#skillGetter-key").getFocus();a={type:i,actor:n,key:s};break;case"by-id":n=t("actor"),s=t("skillId");if(""===s)return _("#skillGetter-skillId").getFocus();a={type:i,actor:n,skillId:s};break;case"variable":n=t("variable");if(C.isNone(n))return _("#skillGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("skillGetter")}.bind(Zt),{target:null,initialize:null,open:null,confirm:null}),Qt=(Jt.initialize=function(){_("#stateGetter-type").loadItems([{name:"Event Trigger State",value:"trigger"},{name:"Latest State",value:"latest"},{name:"By State Id",value:"by-id"},{name:"Variable",value:"variable"}]),_("#stateGetter-type").enableHiddenMode().relate([{case:"by-id",targets:[_("#stateGetter-actor"),_("#stateGetter-stateId")]},{case:"variable",targets:[_("#stateGetter-variable")]}]),_("#stateGetter-confirm").on("click",this.confirm)},Jt.open=function(e){this.target=e,O.open("stateGetter");let t={type:"trigger"},i="",a={type:"local",key:""};var n=e.dataValue;switch(n.type){case"trigger":case"latest":break;case"by-id":t=n.actor,i=n.stateId;break;case"variable":a=n.variable}_("#stateGetter-type").write(n.type),_("#stateGetter-actor").write(t),_("#stateGetter-stateId").write(i),_("#stateGetter-variable").write(a),_("#stateGetter-type").getFocus()},Jt.confirm=function(e){var t=g("stateGetter"),i=t("type");let a;switch(i){case"trigger":case"latest":a={type:i};break;case"by-id":var n=t("actor"),s=t("stateId");if(""===s)return _("#stateGetter-stateId").getFocus();a={type:i,actor:n,stateId:s};break;case"variable":n=t("variable");if(C.isNone(n))return _("#stateGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("stateGetter")}.bind(Jt),{target:null,initialize:null,open:null,confirm:null}),ei=(Qt.initialize=function(){_("#equipmentGetter-type").loadItems([{name:"Event Trigger Equipment",value:"trigger"},{name:"Latest Equipment",value:"latest"},{name:"By Equipment Slot",value:"by-slot"},{name:"Variable",value:"variable"}]),_("#equipmentGetter-type").enableHiddenMode().relate([{case:"by-slot",targets:[_("#equipmentGetter-actor"),_("#equipmentGetter-slot")]},{case:"variable",targets:[_("#equipmentGetter-variable")]}]),_("#equipmentGetter-confirm").on("click",this.confirm)},Qt.open=function(e){this.target=e,O.open("equipmentGetter"),_("#equipmentGetter-slot").loadItems(M.getStringItems("equipment-slot"));let t={type:"trigger"},i=M.getDefStringId("equipment-slot"),a={type:"local",key:""};var n=e.dataValue;switch(n.type){case"trigger":case"latest":break;case"by-slot":t=n.actor,i=n.slot;break;case"variable":a=n.variable}_("#equipmentGetter-type").write(n.type),_("#equipmentGetter-actor").write(t),_("#equipmentGetter-slot").write(i),_("#equipmentGetter-variable").write(a),_("#equipmentGetter-type").getFocus()},Qt.confirm=function(e){var t=g("equipmentGetter"),i=t("type");let a;switch(i){case"trigger":case"latest":a={type:i};break;case"by-slot":var n=t("actor"),s=t("slot");if(""===s)return _("#equipmentGetter-slot").getFocus();a={type:i,actor:n,slot:s};break;case"variable":n=t("variable");if(C.isNone(n))return _("#equipmentGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("equipmentGetter")}.bind(Qt),{target:null,initialize:null,open:null,confirm:null}),ti=(ei.initialize=function(){_("#itemGetter-type").loadItems([{name:"Event Trigger Item",value:"trigger"},{name:"Latest Item",value:"latest"},{name:"By Shortcut Key",value:"by-key"},{name:"Variable",value:"variable"}]),_("#itemGetter-type").enableHiddenMode().relate([{case:"by-key",targets:[_("#itemGetter-actor"),_("#itemGetter-key")]},{case:"variable",targets:[_("#itemGetter-variable")]}]),_("#itemGetter-confirm").on("click",this.confirm)},ei.open=function(e){this.target=e,O.open("itemGetter"),_("#itemGetter-key").loadItems(M.getStringItems("shortcut-key"));let t={type:"trigger"},i=M.getDefStringId("shortcut-key"),a={type:"local",key:""};var n=e.dataValue;switch(n.type){case"trigger":case"latest":break;case"by-key":t=n.actor,i=n.key;break;case"variable":a=n.variable}_("#itemGetter-type").write(n.type),_("#itemGetter-actor").write(t),_("#itemGetter-key").write(i),_("#itemGetter-variable").write(a),_("#itemGetter-type").getFocus()},ei.confirm=function(e){var t=g("itemGetter"),i=t("type");let a;switch(i){case"trigger":case"latest":a={type:i};break;case"by-key":var n=t("actor"),s=t("key");if(""===s)return _("#itemGetter-key").getFocus();a={type:i,actor:n,key:s};break;case"variable":n=t("variable");if(C.isNone(n))return _("#itemGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("itemGetter")}.bind(ei),{target:null,initialize:null,open:null,confirm:null}),ii=(ti.initialize=function(){_("#positionGetter-type").loadItems([{name:"Absolute Coordinates",value:"absolute"},{name:"Relative Coordinates",value:"relative"},{name:"Position of Actor",value:"actor"},{name:"Position of Trigger",value:"trigger"},{name:"Position of Light",value:"light"},{name:"Position of Object",value:"object"}]),_("#positionGetter-type").enableHiddenMode().relate([{case:"absolute",targets:[_("#positionGetter-common-x"),_("#positionGetter-common-y")]},{case:"relative",targets:[_("#positionGetter-common-x"),_("#positionGetter-common-y")]},{case:"actor",targets:[_("#positionGetter-actor")]},{case:"trigger",targets:[_("#positionGetter-trigger")]},{case:"light",targets:[_("#positionGetter-light")]},{case:"object",targets:[_("#positionGetter-objectId")]}]),_("#positionGetter-confirm").on("click",this.confirm)},ti.open=function(e){this.target=e,O.open("positionGetter");let t=0,i=0,a={type:"trigger"},n={type:"trigger"},s={type:"trigger"},r=bt.getDefaultPresetId("any");var o=e.dataValue;switch(o.type){case"absolute":case"relative":t=o.x,i=o.y;break;case"actor":a=o.actor;break;case"trigger":n=o.trigger;break;case"light":s=o.light;break;case"object":r=o.objectId}_("#positionGetter-type").write(o.type),_("#positionGetter-common-x").write(t),_("#positionGetter-common-y").write(i),_("#positionGetter-actor").write(a),_("#positionGetter-trigger").write(n),_("#positionGetter-light").write(s),_("#positionGetter-objectId").write(r),_("#positionGetter-type").getFocus()},ti.confirm=function(e){var t=g("positionGetter"),i=t("type");let a;switch(i){case"absolute":var n=t("common-x"),s=t("common-y");a={type:i,x:n,y:s};break;case"relative":n=t("common-x"),s=t("common-y");a={type:i,x:n,y:s};break;case"actor":n=t("actor");a={type:i,actor:n};break;case"trigger":s=t("trigger");a={type:i,trigger:s};break;case"light":n=t("light");a={type:i,light:n};break;case"object":s=t("objectId");if(""===s)return _("#positionGetter-objectId").getFocus();a={type:i,objectId:s}}this.target.input(a),O.close("positionGetter")}.bind(ti),{target:null,initialize:null,open:null,confirm:null}),ai=(ii.initialize=function(){_("#angleGetter-type").loadItems([{name:"Towards Position",value:"position"},{name:"Absolute Angle",value:"absolute"},{name:"Relative Angle",value:"relative"},{name:"Direction Angle",value:"direction"},{name:"Random Angle",value:"random"}]),_("#angleGetter-type").enableHiddenMode().relate([{case:"position",targets:[_("#angleGetter-position-position")]},{case:["absolute","relative","direction"],targets:[_("#angleGetter-common-degrees")]}]),_("#angleGetter-confirm").on("click",this.confirm)},ii.open=function(e){this.target=e,O.open("angleGetter");let t={type:"actor",actor:{type:"trigger"}},i=0;var a=e.dataValue;switch(a.type){case"position":t=a.position;break;case"absolute":case"relative":case"direction":i=a.degrees}_("#angleGetter-type").write(a.type),_("#angleGetter-position-position").write(t),_("#angleGetter-common-degrees").write(i),_("#angleGetter-type").getFocus()},ii.confirm=function(e){var t=g("angleGetter"),i=t("type");let a;switch(i){case"position":var n=t("position-position");a={type:i,position:n};break;case"absolute":case"relative":case"direction":n=t("common-degrees");a={type:i,degrees:n};break;case"random":a={type:i}}this.target.input(a),O.close("angleGetter")}.bind(ii),{target:null,initialize:null,open:null,confirm:null}),ni=(ai.initialize=function(){_("#triggerGetter-type").loadItems([{name:"Event Trigger",value:"trigger"},{name:"Latest Trigger",value:"latest"},{name:"Variable",value:"variable"}]),_("#triggerGetter-type").enableHiddenMode().relate([{case:"variable",targets:[_("#triggerGetter-variable")]}]),_("#triggerGetter-confirm").on("click",this.confirm)},ai.open=function(e){this.target=e,O.open("triggerGetter");let t={type:"local",key:""};var i=e.dataValue;switch(i.type){case"trigger":case"latest":break;case"variable":t=i.variable}_("#triggerGetter-type").write(i.type),_("#triggerGetter-variable").write(t),_("#triggerGetter-type").getFocus()},ai.confirm=function(e){var t=g("triggerGetter"),i=t("type");let a;switch(i){case"trigger":case"latest":a={type:i};break;case"variable":var n=t("variable");if(C.isNone(n))return _("#triggerGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("triggerGetter")}.bind(ai),{target:null,initialize:null,open:null,confirm:null}),si=(ni.initialize=function(){_("#lightGetter-type").loadItems([{name:"Event Trigger Light",value:"trigger"},{name:"Latest Light",value:"latest"},{name:"By Light ID",value:"by-id"},{name:"Variable",value:"variable"}]),_("#lightGetter-type").enableHiddenMode().relate([{case:"by-id",targets:[_("#lightGetter-presetId")]},{case:"variable",targets:[_("#lightGetter-variable")]}]),_("#lightGetter-confirm").on("click",this.confirm)},ni.open=function(e){this.target=e,O.open("lightGetter");let t=bt.getDefaultPresetId("light"),i={type:"local",key:""};var a=e.dataValue;switch(a.type){case"trigger":case"latest":break;case"by-id":t=a.presetId;break;case"variable":i=a.variable}_("#lightGetter-type").write(a.type),_("#lightGetter-presetId").write(t),_("#lightGetter-variable").write(i),_("#lightGetter-type").getFocus()},ni.confirm=function(e){var t=g("lightGetter"),i=t("type");let a;switch(i){case"trigger":case"latest":a={type:i};break;case"by-id":var n=t("presetId");if(""===n)return _("#lightGetter-presetId").getFocus();a={type:i,presetId:n};break;case"variable":n=t("variable");if(C.isNone(n))return _("#lightGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("lightGetter")}.bind(ni),{target:null,initialize:null,open:null,confirm:null}),ri=(si.initialize=function(){_("#elementGetter-type").loadItems([{name:"Event Trigger Element",value:"trigger"},{name:"Latest Element",value:"latest"},{name:"By Element ID",value:"by-id"},{name:"By Ancestor And ID",value:"by-ancestor-and-id"},{name:"By Parent And Index",value:"by-index"},{name:"Variable",value:"variable"}]),_("#elementGetter-type").enableHiddenMode().relate([{case:"by-id",targets:[_("#elementGetter-presetId")]},{case:"by-ancestor-and-id",targets:[_("#elementGetter-ancestor"),_("#elementGetter-presetId")]},{case:"by-index",targets:[_("#elementGetter-ancestor"),_("#elementGetter-index")]},{case:"variable",targets:[_("#elementGetter-variable")]}]),_("#elementGetter-confirm").on("click",this.confirm)},si.open=function(e){this.target=e,O.open("elementGetter");let t=0,i=yt.getDefaultPresetId(),a={type:"trigger"},n={type:"local",key:""};var s=e.dataValue;switch(s.type){case"trigger":case"latest":break;case"by-id":i=s.presetId;break;case"by-ancestor-and-id":a=s.ancestor,i=s.presetId;break;case"by-index":a=s.parent,t=s.index;break;case"variable":n=s.variable}_("#elementGetter-type").write(s.type),_("#elementGetter-ancestor").write(a),_("#elementGetter-presetId").write(i),_("#elementGetter-index").write(t),_("#elementGetter-variable").write(n),_("#elementGetter-type").getFocus()},si.confirm=function(e){var t=g("elementGetter"),i=t("type");let a;switch(i){case"trigger":case"latest":a={type:i};break;case"by-id":var n=t("presetId");if(""===n)return _("#elementGetter-presetId").getFocus();a={type:i,presetId:n};break;case"by-ancestor-and-id":var n=t("ancestor"),s=t("presetId");if(""===s)return _("#elementGetter-presetId").getFocus();a={type:i,ancestor:n,presetId:s};break;case"by-index":n=t("ancestor"),s=t("index");a={type:i,parent:n,index:s};break;case"variable":n=t("variable");if(C.isNone(n))return _("#elementGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("elementGetter")}.bind(si),{target:null,initialize:null,open:null,confirm:null}),n=(ri.initialize=function(){const t=["trigger","latest","by-id","variable"];_("#ancestorGetter-type").loadItems(_("#elementGetter-type").dataItems.filter(e=>t.includes(e.value))),_("#ancestorGetter-type").enableHiddenMode().relate([{case:"variable",targets:[_("#ancestorGetter-variable")]}]),_("#ancestorGetter-confirm").on("click",this.confirm)},ri.open=function(e){this.target=e,O.open("ancestorGetter");let t=yt.getDefaultPresetId(),i={type:"local",key:""};var a=e.dataValue;switch(a.type){case"trigger":case"latest":break;case"by-id":t=a.presetId;break;case"variable":i=a.variable}_("#ancestorGetter-type").write(a.type),_("#ancestorGetter-presetId").write(t),_("#ancestorGetter-variable").write(i),_("#ancestorGetter-type").getFocus()},ri.confirm=function(e){var t=g("ancestorGetter"),i=t("type");let a;switch(i){case"trigger":case"latest":a={type:i};break;case"by-id":var n=t("presetId");if(""===n)return _("#ancestorGetter-presetId").getFocus();a={type:i,presetId:n};break;case"variable":n=t("variable");if(C.isNone(n))return _("#ancestorGetter-variable").getFocus();a={type:i,variable:n}}this.target.input(a),O.close("ancestorGetter")}.bind(ri),{list:_("#command-list"),overviewPane:_("#command-overview-detail").hide(),overview:_("#command-overview"),settingsPane:_("#command-settings-detail").hide(),data:null,meta:null,symbol:null,changed:!1,initialize:null,open:null,load:null,unload:null,loadOverview:null,createData:null,getItemById:null,windowClose:null,windowClosed:null,pointerdown:null,scriptChange:null,listKeydown:null,listSelect:null,listUnselect:null,listChange:null,listPopup:null,listOpen:null,paramInput:null,confirm:null,apply:null}),oi=(n.list.insert=null,n.list.toggle=null,n.list.copy=null,n.list.paste=null,n.list.delete=w.list.delete,n.list.saveSelection=null,n.list.restoreSelection=null,n.list.updateNodeElement=u.list.updateNodeElement,n.list.addElementClass=w.list.addElementClass,n.list.updateTextNode=w.list.updateTextNode,n.list.updateToggleStyle=w.list.updateToggleStyle,n.list.createEditIcon=w.list.createEditIcon,n.initialize=function(){var e=this["list"];e.removable=!0,e.bind(()=>this.data),e.creators.push(e.addElementClass),e.creators.push(e.updateToggleStyle),e.updaters.push(e.updateTextNode),e.creators.push(e.createEditIcon),_("#command").on("close",this.windowClose),_("#command").on("closed",this.windowClosed),e.on("keydown",this.listKeydown),e.on("select",this.listSelect),e.on("unselect",this.listUnselect),e.on("change",this.listChange),e.on("popup",this.listPopup),e.on("open",this.listOpen),e.on("pointerdown",vt.listPointerdown),_("#command-alias, #command-keywords").on("input",this.paramInput),_("#command-confirm").on("click",this.confirm),_("#command-apply").on("click",this.apply)},n.open=function(){O.open("command"),this.data=Object.clone(He.commands),this.list.restoreSelection(),this.list.getFocus(),window.on("pointerdown",this.pointerdown),window.on("script-change",this.scriptChange)},n.load=async function(e){var t=this.symbol=Symbol(),e=await He.scripts[e.id];this.symbol===t&&(this.symbol=null,this.meta=e,this.loadOverview(),t=this.list.read())&&((e=D("command",t))("alias"),e("keywords"),this.settingsPane.show())},n.unload=function(){this.meta=null,this.symbol=null,this.overview.clear(),this.overviewPane.hide(),this.settingsPane.hide()},n.loadOverview=function(){var e=this["meta"];if(e){var e=w.createOverview(e,!0),t=this.overview.clear();for(const i of e)t.appendChild(i);this.overviewPane.show()}},n.createData=function(e){return{id:e,enabled:!0,alias:"",keywords:""}},n.getItemById=u.getItemById,n.windowClose=function(e){this.changed&&(e.preventDefault(),e=N.createGetter("confirmation"),O.confirm({message:e("closeUnsavedCommands")},[{label:e("yes"),click:()=>{this.changed=!1,O.close("command")}},{label:e("no")}]))}.bind(n),n.windowClosed=function(e){this.list.saveSelection(),this.data=null,this.list.clear(),window.off("pointerdown",this.pointerdown),window.off("script-change",this.scriptChange)}.bind(n),n.pointerdown=w.pointerdown,n.scriptChange=function(e){n.meta===e.changedMeta&&n.loadOverview()},n.listKeydown=function(e){var t=this.read();if(e.cmdOrCtrlKey)switch(e.code){case"KeyC":this.copy(t);break;case"KeyV":this.paste()}else if(!e.altKey)switch(e.code){case"Insert":this.insert(t);break;case"Slash":this.toggle(t);break;case"Delete":this.delete(t)}},n.listSelect=function(e){n.load(e.value)},n.listUnselect=function(e){n.unload()},n.listChange=function(e){n.changed=!0},n.listPopup=function(e){const t=e.value;var i=!!t,a=Clipboard.has("yami.data.customCommand"),n=i,s=N.createGetter("menuCustomCommandList");ve.popup({x:e.clientX,y:e.clientY},[{label:s("edit"),accelerator:"Enter",enabled:i,click:()=>{this.edit(t)}},{label:s("insert"),accelerator:"Insert",click:()=>{this.insert(t)}},{label:s("toggle"),accelerator:"/",enabled:i,click:()=>{this.toggle(t)}},{label:s("copy"),accelerator:p("C"),enabled:i,click:()=>{this.copy(t)}},{label:s("paste"),accelerator:p("V"),enabled:a,click:()=>{this.paste(t)}},{label:s("delete"),accelerator:"Delete",enabled:n,click:()=>{this.delete(t)}}])},n.listOpen=function(e){this.edit(e.value)},n.paramInput=function(e){n.changed=!0;var t=n.list.read();switch(this.id){case"command-alias":t.alias=this.read();break;case"command-keywords":t.keywords=this.read()}},n.confirm=function(e){this.apply(),O.close("command")}.bind(n),n.apply=function(t){if(this.changed){this.changed=!1;let e=this.data;t instanceof Event?e=Object.clone(e):Ee.deleteCaches(e),He.commands=e,R.planToSave(He.manifest.project.commands),I.custom.loadCommandList()}}.bind(n),n.list.edit=function(t){zt.open({filter:"script",read:()=>t.id,input:e=>{t.id!==e&&(t.id=e,t.parameters={},n.changed=!0),this.update()}},!1)},n.list.insert=function(t){zt.open({filter:"script",read:()=>"",input:e=>{this.addNodeTo(n.createData(e),t)}},!1)},n.list.toggle=function(e){e&&(e.enabled=!e.enabled,this.updateToggleStyle(e),n.changed=!0)},n.list.copy=function(e){e&&Clipboard.write("yami.data.customCommand",e)},n.list.paste=function(e){var t=Clipboard.read("yami.data.customCommand");t&&this.addNodeTo(t,e)},n.list.saveSelection=function(){var e=He["commands"],t=(void 0===e.selection&&Object.defineProperty(e,"selection",{writable:!0,value:""}),this.read());t&&(e.selection=t.id)},{data:[],devmode:!(n.list.restoreSelection=function(){var e=He.commands.selection,e=n.getItemById(e)??this.data[0];this.select(e),this.update(),this.scrollToSelection()}),beep:!1,beepdate:0,initialize:null,throw:null,error:null,update:null,message:null,windowOpen:null,windowClosed:null,catchError:null}),P=(oi.initialize=function(){_("#log-list").listenDraggingScrollbarEvent(),window.on("error",this.catchError),_("#log").on("open",this.windowOpen),_("#log").on("closed",this.windowClosed)},oi.throw=function(e){if(this.devmode)throw e},oi.error=function(e){var t=this.data,i=t[t.length-1],a=Date.now();i?.text===e?(i.date=a,i.count+=1):t.push({type:"error",date:a,text:e,count:1}),_("#log").hasClass("open")?this.update():this.message(e),this.beep&&1e3<a-this.beepdate&&(this.beepdate=a,require("electron").shell.beep())},oi.update=function(){var t=_("#log-list").reload(),i=this.data,a=i.length;for(let e=0;e<a;e++){var n=i[e],s=Math.min(n.count,99),r=new Date(n.date),o=r.getHours(),l=r.getMinutes(),r=r.getSeconds(),l=l.toString().padStart(2,"0"),r=r.toString().padStart(2,"0"),c=document.createElement("common-item");c.addClass(n.type),c.dataValue=e,c.textContent=`[${o}:${l}:${r}] `+n.text,1!==s&&((o=document.createElement("error-counter")).textContent=s.toString(),c.appendChild(o)),t.appendElement(c)}t.update()},oi.message=function(){const t=_("#error-message"),i=new f({duration:6e3,callback:e=>{t.textContent="",t.removeClass("visible")}});return function(e){t.textContent=e,t.addClass("visible"),t.removeClass("fadeout"),t.css().display,t.addClass("fadeout"),i.elapsed=0,i.add()}}(),oi.windowOpen=function(e){oi.update()},oi.windowClosed=function(e){_("#log-list").clear()},oi.catchError=function(){const t=/^Uncaught /;return function(e){"open"===P.state&&oi.error(e.message.replace(t,""))}}(),{state:"closed",config:null,project:null,promises:[],initialize:null,open:null,close:null,quit:null,updatePath:null,switchHotkey:null,protectPromise:null,saveConfig:null,loadConfig:null,saveProject:null,loadProject:null,saveManifest:null});function li(e){if(e.cmdOrCtrlKey)switch(e.code){case"KeyN":case"KeyO":case"KeyZ":case"KeyY":return}else if("Escape"===e.code)return;e.stopPropagation()}P.initialize=async function(){this.switchHotkey(!1);try{b.initialize();var e=await window.config,t=JSON.stringify(e);this.config=e,Object.defineProperty(this.config,"code",{value:t}),delete window.config,N.initialize(),Je.initialize(),Tt.initialize(),It.initialize(),x.initialize(),f.initialize(),A.initialize(),Y.initialize(),Ke.initialize(),S.initialize(),O.initialize(),Nt.initialize(),j.initialize(),I.initialize(),nt.initialize(),u.initialize(),c.initialize(),w.initialize(),n.initialize(),oi.initialize(),h.initialize(),T.initialize(),zt.initialize(),tt.initialize(),m.initialize(),d.initialize(),v.initialize(),M.initialize(),ot.initialize(),lt.initialize(),ct.initialize(),ht.initialize(),dt.initialize(),ut.initialize(),bt.initialize(),yt.initialize(),wt.initialize(),mt.initialize(),gt.initialize(),this.loadConfig(),this.open()}catch(e){oi.throw(e),O.confirm({message:`Failed to initialize
`+e.message,close:()=>{this.config=null,this.quit()}},[{label:"Confirm"}])}},P.open=async function(t){if(t=E.slash(t??this.config.project)){try{if(!F.statSync(t).isFile())throw new Error("Invalid project path")}catch(e){return oi.throw(e),void x.manager.switch("home")}await this.close(),R.updateRoot(t);var e=z.readFile(t,"utf8");try{var i=He.loadAll(),a=h.read();await i,await a,He.inheritMetaData(),tt.loadDefault(),I.custom.loadCommandList(),Ke.Player.updateStep()}catch(e){oi.throw(e);i=e instanceof URIError?"Failed to read file":e instanceof SyntaxError?"Syntax error":"Error";return h.close(),He.close(),void O.confirm({message:i+": "+e.message,close:()=>{x.manager.switch("home")}},[{label:"Confirm"}])}try{var n=await e;this.project=JSON.parse(n),Object.defineProperty(this.project,"code",{value:n}),this.loadProject()}catch(e){oi.throw(e);a=t.lastIndexOf("/")+1,i=t.slice(a);return h.close(),He.close(),void O.confirm({message:"Failed to read file: "+i,close:()=>{x.manager.switch("home")}},[{label:"Confirm"}])}this.state="open",this.updatePath(t),this.switchHotkey(!0),b.updateTitleName()}else x.manager.switch("home")},P.close=function(e=!0){return x.manager.switch(null),"open"===this.state?(this.state="closed",e&&(this.saveProject(),this.saveManifest()),this.switchHotkey(!1),this.config.project="",this.project=null,O.closeAll(),A.close(),Y.close(),h.close(),j.close(),T.close(),zt.close(),He.close(),Je.close(),tt.clearFonts(),b.updateTitleName(),We.textureManager.clear(),Promise.all(this.promises).catch(e=>oi.throw(e))):Promise.resolve()},P.quit=function(){this.saveConfig(),this.saveProject(),this.saveManifest(),Promise.all(this.promises).catch(e=>oi.throw(e)).then(()=>{require("electron").ipcRenderer.send("close-window-force")})},P.updatePath=function(t){var e=this["config"],i=(e.project=t,e.dialogs.open=E.dirname(t),e.recent),e=Date.now(),a=i.find(e=>e.path===t);if(a)a.date=e,i.remove(a),i.unshift(a);else for(i.unshift({path:t,date:e});3<i.length;)i.pop()},P.switchHotkey=function(e){switch(e){case!0:window.off("keydown",li,{capture:!0});break;case!1:window.on("keydown",li,{capture:!0})}},P.protectPromise=function(e){const t=this["promises"];return t.push(e),e.finally(()=>{t.remove(e)}),e},P.saveConfig=function(){var e=this["config"];if(e)try{b.saveToConfig(e),x.saveToConfig(e),A.saveToConfig(e),Y.saveToConfig(e),Ke.saveToConfig(e),S.saveToConfig(e);const i=JSON.stringify(e,null,2),a=e.code;if(i!==a){const n=E.resolve(__dirname,"config.json");this.protectPromise(z.writeFile(n,i).catch(e=>{var t=n+".cache";z.writeFile(t,i),z.writeFile(n,a),oi.throw(e)}))}}catch(e){return oi.throw(e),console.error(e)}},P.loadConfig=function(){var e=this["config"];b.loadFromConfig(e),x.loadFromConfig(e),A.loadFromConfig(e),Y.loadFromConfig(e),Ke.loadFromConfig(e),S.loadFromConfig(e)},P.saveProject=function(){var e=this["project"];if(e)try{A.saveToProject(e),Y.saveToProject(e),Ke.saveToProject(e),S.saveToProject(e),Ue.saveToProject(e),y.saveToProject(e),T.saveToProject(e),zt.saveToProject(e),w.saveToProject(e),b.saveToProject(e);const i=JSON.stringify(e,null,2),a=e.code;if(i!==a){const n=this.config.project;this.protectPromise(z.writeFile(n,i).catch(e=>{var t=n+".cache";z.writeFile(t,i),z.writeFile(n,a),oi.throw(e)}))}}catch(e){return oi.throw(e),console.error(e)}},P.loadProject=function(){var e=this["project"];A.loadFromProject(e),Y.loadFromProject(e),Ke.loadFromProject(e),S.loadFromProject(e),Ue.loadFromProject(e),y.loadFromProject(e),T.loadFromProject(e),zt.loadFromProject(e),w.loadFromProject(e),b.loadFromProject(e)},P.saveManifest=function(){return He.saveManifest()},P.initialize();